const { execSync } = require('child_process');
const fs = require('fs');

console.log('üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º...');
console.log('========================================');

const logFile = `fix-log-${Date.now()}.txt`;
let errors = [];

function runCommand(command, description) {
    console.log(`\nüîß ${description}...`);
    try {
        const output = execSync(command, { encoding: 'utf8', stdio: 'pipe' });
        console.log(`‚úÖ ${description} - —É—Å–ø–µ—à–Ω–æ`);
        fs.appendFileSync(logFile, `\n=== ${description} ===\n${output}\n`);
        return true;
    } catch (error) {
        console.log(`‚ùå ${description} - –æ—à–∏–±–∫–∞`);
        console.log(error.message);
        errors.push(`${description}: ${error.message}`);
        fs.appendFileSync(logFile, `\n=== –û–®–ò–ë–ö–ê: ${description} ===\n${error.message}\n`);
        return false;
    }
}

function runScript(scriptPath, description) {
    console.log(`\nüîß ${description}...`);
    try {
        const output = execSync(`node ${scriptPath}`, { encoding: 'utf8', stdio: 'pipe' });
        console.log(`‚úÖ ${description} - —É—Å–ø–µ—à–Ω–æ`);
        console.log(output);
        fs.appendFileSync(logFile, `\n=== ${description} ===\n${output}\n`);
        return true;
    } catch (error) {
        console.log(`‚ùå ${description} - –æ—à–∏–±–∫–∞`);
        console.log(error.message);
        errors.push(`${description}: ${error.message}`);
        fs.appendFileSync(logFile, `\n=== –û–®–ò–ë–ö–ê: ${description} ===\n${error.message}\n`);
        return false;
    }
}

// –°–æ–∑–¥–∞–µ–º –ª–æ–≥ —Ñ–∞–π–ª
fs.writeFileSync(logFile, `–õ–æ–≥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º - ${new Date().toLocaleString()}\n`);

console.log('üìä –≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TypeScript –æ—à–∏–±–æ–∫');
runScript('fix-typescript-errors.js', '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TypeScript –æ—à–∏–±–æ–∫ –≤ bot-generator.ts');

console.log('\nüìä –≠—Ç–∞–ø 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
runScript('fix-schema-problems.js', '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å–æ —Å—Ö–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');

console.log('\nüìä –≠—Ç–∞–ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ TypeScript –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π');
runCommand('npx tsc --noEmit --skipLibCheck', '–ü—Ä–æ–≤–µ—Ä–∫–∞ TypeScript');

console.log('\nüìä –≠—Ç–∞–ø 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–æ–º');
runCommand('npm run lint --if-present', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ª–∏–Ω—Ç–µ—Ä–æ–º');

console.log('\nüìä –≠—Ç–∞–ø 5: –ü–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞');
runCommand('npm run build --if-present', '–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞');

console.log('\nüìä –≠—Ç–∞–ø 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π');
runCommand('npm audit --audit-level moderate', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π');

// –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
console.log('\n========================================');
console.log('üìã –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢');
console.log('========================================');

if (errors.length === 0) {
    console.log('üéâ –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!');
    console.log('‚úÖ TypeScript –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã');
    console.log('‚úÖ –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
    console.log('‚úÖ –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
} else {
    console.log(`‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${errors.length} –ø—Ä–æ–±–ª–µ–º:`);
    errors.forEach((error, index) => {
        console.log(`${index + 1}. ${error}`);
    });
    console.log('\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:');
    console.log('   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –≤ —Ñ–∞–π–ª–µ:', logFile);
    console.log('   - –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã –≤—Ä—É—á–Ω—É—é');
    console.log('   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π');
}

console.log(`\nüìÑ –ü–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: ${logFile}`);
console.log('\nüöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç:');
console.log('   npm run dev     - –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏');
console.log('   npm run build   - –¥–ª—è —Å–±–æ—Ä–∫–∏');
console.log('   npm start       - –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞');

// –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç
const reportContent = `
–û–¢–ß–ï–¢ –û–ë –ò–°–ü–†–ê–í–õ–ï–ù–ò–ò –ü–†–û–ë–õ–ï–ú
============================
–î–∞—Ç–∞: ${new Date().toLocaleString()}
–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: ${errors.length}

${errors.length === 0 ? '‚úÖ –í–°–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´!' : '‚ö†Ô∏è –û–°–¢–ê–õ–ò–°–¨ –ü–†–û–ë–õ–ï–ú–´:'}

${errors.map((error, index) => `${index + 1}. ${error}`).join('\n')}

–ü–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥: ${logFile}
`;

fs.writeFileSync('–û–¢–ß–ï–¢_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ô.txt', reportContent);
console.log('\nüìä –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: –û–¢–ß–ï–¢_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ô.txt');