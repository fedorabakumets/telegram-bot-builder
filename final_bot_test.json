{"code":"\"\"\"\nTestBot - Telegram Bot\n–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é TelegramBot Builder\n\n–ö–æ–º–∞–Ω–¥—ã –¥–ª—è @BotFather:\nstart - –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞\"\"\"\n\nimport asyncio\nimport logging\nimport os\nimport sys\nimport locale\nfrom aiogram import Bot, Dispatcher, types, F\nfrom aiogram.filters import CommandStart, Command\nfrom aiogram.exceptions import TelegramBadRequest\nfrom aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, BotCommand, ReplyKeyboardRemove, URLInputFile, FSInputFile\nfrom aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder\nfrom aiogram.enums import ParseMode\nfrom typing import Optional\nimport asyncpg\nfrom datetime import datetime, timezone, timedelta\nimport json\nimport aiohttp\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤ Windows\nif sys.platform.startswith(\"win\"):\n    import codecs\n    sys.stdout = codecs.getwriter(\"utf-8\")(sys.stdout.detach())\n    sys.stderr = codecs.getwriter(\"utf-8\")(sys.stderr.detach())\n\n# Safe helper for editing messages with fallback to new message\nasync def safe_edit_or_send(cbq, text, node_id=None, is_auto_transition=False, **kwargs):\n    \"\"\"\n    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å fallback –Ω–∞ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n    –ü—Ä–∏ –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n    \"\"\"\n    result = None\n    user_id = None\n    \n    # –ü–æ–ª—É—á–∞–µ–º user_id –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\n    if hasattr(cbq, \"from_user\") and cbq.from_user:\n        user_id = str(cbq.from_user.id)\n    elif hasattr(cbq, \"message\") and cbq.message and hasattr(cbq.message, \"chat\"):\n        user_id = str(cbq.message.chat.id)\n    \n    try:\n        # –ü—Ä–∏ –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n        if is_auto_transition:\n            logging.info(f\"‚ö° –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\")\n            if hasattr(cbq, \"message\") and cbq.message:\n                result = await cbq.message.answer(text, **kwargs)\n            else:\n                raise Exception(\"Cannot send message in auto-transition\")\n        else:\n            # –ü—Ä–æ–±—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ\n            if hasattr(cbq, \"edit_text\") and callable(getattr(cbq, \"edit_text\")):\n                result = await cbq.edit_text(text, **kwargs)\n            elif (hasattr(cbq, \"message\") and cbq.message):\n                result = await cbq.message.edit_text(text, **kwargs)\n            else:\n                raise Exception(\"No valid edit method found\")\n    except Exception as e:\n        # –ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n        if is_auto_transition:\n            logging.info(f\"‚ö° –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥: {e}, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\")\n        else:\n            logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\")\n        if hasattr(cbq, \"message\") and cbq.message:\n            result = await cbq.message.answer(text, **kwargs)\n        else:\n            logging.error(\"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\")\n            raise\n    \n    return result\n\n# –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç–µ —É @BotFather)\nBOT_TOKEN = \"YOUR_BOT_TOKEN_HERE\"\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\nlogging.basicConfig(level=logging.INFO)\n\n# –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞\nbot = Bot(token=BOT_TOKEN)\ndp = Dispatcher()\n\n# –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π Telegram ID)\nADMIN_IDS = [123456789]  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n\n# API configuration –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π\nAPI_BASE_URL = os.getenv(\"REPLIT_DEV_DOMAIN\", \"http://localhost:5000\")\nPROJECT_ID = int(os.getenv(\"PROJECT_ID\", \"0\"))  # ID –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ\n\n# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API\nasync def save_message_to_api(user_id: str, message_type: str, message_text: str = None, node_id: str = None, message_data: dict = None):\n    \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API\"\"\"\n    try:\n        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL –¥–ª—è API\n        if API_BASE_URL.startswith(\"http\"):\n            api_url = f\"{API_BASE_URL}/api/projects/{PROJECT_ID}/messages\"\n        else:\n            api_url = f\"https://{API_BASE_URL}/api/projects/{PROJECT_ID}/messages\"\n        \n        payload = {\n            \"userId\": str(user_id),\n            \"messageType\": message_type,\n            \"messageText\": message_text,\n            \"nodeId\": node_id,\n            \"messageData\": message_data or {}\n        }\n        \n        logging.debug(f\"üíæ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ API: {payload}\")\n        async with aiohttp.ClientSession() as session:\n            async with session.post(api_url, json=payload, timeout=aiohttp.ClientTimeout(total=5)) as response:\n                if response.status == 200:\n                    logging.info(f\"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {message_type} –æ—Ç {user_id}\")\n                    response_data = await response.json()\n                    return response_data.get(\"data\")  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å id\n                else:\n                    error_text = await response.text()\n                    logging.error(f\"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {response.status} - {error_text}\")\n                    logging.error(f\"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π payload: {payload}\")\n                    return None\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}\")\n        return None\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–∑–ª–æ–≤\n\n\n@dp.message(CommandStart())\nasync def start_handler(message: types.Message):\n    user_id = message.from_user.id\n    logging.info(f\"üöÄ –ö–æ–º–∞–Ω–¥–∞ /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}\")\n\n    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ\n    username = message.from_user.username\n    first_name = message.from_user.first_name\n    last_name = message.from_user.last_name\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    saved_to_db = await save_user_to_db(user_id, username, first_name, last_name)\n    \n    # –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\n    if not saved_to_db:\n        user_data[user_id] = {\n            \"username\": username,\n            \"first_name\": first_name,\n            \"last_name\": last_name,\n            \"registered_at\": message.date\n        }\n        logging.info(f\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\")\n    else:\n        logging.info(f\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\")\n\n    text = \"–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –±–æ—Ç.\"\n    # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    builder = InlineKeyboardBuilder()\n    builder.add(InlineKeyboardButton(text=\"–ù–∞–∂–º–∏ –º–µ–Ω—è\", callback_data=\"message-1\"))\n    builder.adjust(1)\n    keyboard = builder.as_markup()\n    await message.answer(text, reply_markup=keyboard)\n\nasync def handle_message_message_1(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:\n    \"\"\"–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É–∑–ª–∞ message-1\"\"\"\n    user_id = update.effective_user.id\n    \n    message_text = \"–û—Ç–ª–∏—á–Ω–æ! –¢—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É.\"\n    \n    await update.message.reply_text(message_text)\n\n\n\n# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞\nasync def main():\n    try:\n        \n        print(\"–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!\")\n        await dp.start_polling(bot)\n    except KeyboardInterrupt:\n        print(\"üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...\")\n    except Exception as e:\n        logging.error(f\"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}\")\n    finally:\n        # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\n        \n        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –±–æ—Ç–∞\n        await bot.session.close()\n        print(\"–°–µ—Å—Å–∏—è –±–æ—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∞\")\n        print(\"–ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É\")\n\n\n\n# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞\nasync def main():\n    global db_pool\n    try:\n        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        await init_database()\n        await set_bot_commands()\n        \n        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è middleware –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π\n        dp.message.middleware(message_logging_middleware)\n        dp.callback_query.middleware(callback_query_logging_middleware)\n        \n        print(\"–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!\")\n        await dp.start_polling(bot)\n    except KeyboardInterrupt:\n        print(\"üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...\")\n    except Exception as e:\n        logging.error(f\"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}\")\n    finally:\n        # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\n        if db_pool:\n            await db_pool.close()\n            print(\"–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–æ\")\n        \n        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –±–æ—Ç–∞\n        await bot.session.close()\n        print(\"–°–µ—Å—Å–∏—è –±–æ—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∞\")\n        print(\"–ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É\")\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n"}