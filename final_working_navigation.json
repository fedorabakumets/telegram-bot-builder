{"code":"\"\"\"\n–ú–æ–π –ø–µ—Ä–≤—ã–π –±–æ—Ç - Telegram Bot\n–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é TelegramBot Builder\n\"\"\"\n\nimport asyncio\nimport logging\nimport os\nfrom aiogram import Bot, Dispatcher, types, F\nfrom aiogram.filters import CommandStart, Command\nfrom aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, BotCommand, ReplyKeyboardRemove, URLInputFile, FSInputFile\nfrom aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder\nfrom aiogram.enums import ParseMode\nfrom typing import Optional\nimport asyncpg\nfrom datetime import datetime, timezone, timedelta\nimport json\n\n# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏\ndef get_moscow_time():\n    \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ\"\"\"\n    moscow_tz = timezone(timedelta(hours=3))  # UTC+3 –¥–ª—è –ú–æ—Å–∫–≤—ã\n    return datetime.now(moscow_tz).isoformat()\n\n# –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç–µ —É @BotFather)\nBOT_TOKEN = \"YOUR_BOT_TOKEN_HERE\"\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\nlogging.basicConfig(level=logging.INFO)\n\n# –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞\nbot = Bot(token=BOT_TOKEN)\ndp = Dispatcher()\n\n# –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π Telegram ID)\nADMIN_IDS = [123456789]  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\nDATABASE_URL = os.getenv(\"DATABASE_URL\")\n\n# –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö\ndb_pool = None\n\n# –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –¥–ª—è —Å–ª—É—á–∞–µ–≤ –±–µ–∑ –ë–î)\nuser_data = {}\n\n\n# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö\nasync def init_database():\n    \"\"\"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü\"\"\"\n    global db_pool\n    try:\n        db_pool = await asyncpg.create_pool(DATABASE_URL, min_size=1, max_size=10)\n        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç\n        async with db_pool.acquire() as conn:\n            await conn.execute(\"\"\"\n                CREATE TABLE IF NOT EXISTS bot_users (\n                    user_id BIGINT PRIMARY KEY,\n                    username TEXT,\n                    first_name TEXT,\n                    last_name TEXT,\n                    registered_at TIMESTAMP DEFAULT NOW(),\n                    last_interaction TIMESTAMP DEFAULT NOW(),\n                    interaction_count INTEGER DEFAULT 0,\n                    user_data JSONB DEFAULT '{}',\n                    is_active BOOLEAN DEFAULT TRUE\n                );\n            \"\"\")\n        logging.info(\"‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞\")\n    except Exception as e:\n        logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î: {e}. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.\")\n        db_pool = None\n\nasync def save_user_to_db(user_id: int, username: Optional[str] = None, first_name: Optional[str] = None, last_name: Optional[str] = None):\n    \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return False\n    try:\n        async with db_pool.acquire() as conn:\n            await conn.execute(\"\"\"\n                INSERT INTO bot_users (user_id, username, first_name, last_name)\n                VALUES ($1, $2, $3, $4)\n                ON CONFLICT (user_id) DO UPDATE SET\n                    username = EXCLUDED.username,\n                    first_name = EXCLUDED.first_name,\n                    last_name = EXCLUDED.last_name,\n                    last_interaction = NOW(),\n                    interaction_count = bot_users.interaction_count + 1\n            \"\"\", user_id, username, first_name, last_name)\n        return True\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î: {e}\")\n        return False\n\nasync def get_user_from_db(user_id: int):\n    \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return None\n    try:\n        async with db_pool.acquire() as conn:\n            row = await conn.fetchrow(\"SELECT * FROM bot_users WHERE user_id = $1\", user_id)\n            if row:\n                return dict(row)\n        return None\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î: {e}\")\n        return None\n\nasync def update_user_data_in_db(user_id: int, data_key: str, data_value):\n    \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return False\n    try:\n        import json\n        async with db_pool.acquire() as conn:\n            # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å\n            await conn.execute(\"\"\"\n                INSERT INTO bot_users (user_id) \n                VALUES ($1) \n                ON CONFLICT (user_id) DO NOTHING\n            \"\"\", user_id)\n            \n            # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            update_data = {data_key: data_value}\n            await conn.execute(\"\"\"\n                UPDATE bot_users \n                SET user_data = COALESCE(user_data, '{}'::jsonb) || $2::jsonb,\n                    last_interaction = NOW()\n                WHERE user_id = $1\n            \"\"\", user_id, json.dumps(update_data))\n        return True\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}\")\n        return False\n\nasync def update_user_variable_in_db(user_id: int, variable_name: str, variable_value: str):\n    \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return False\n    try:\n        import json\n        async with db_pool.acquire() as conn:\n            # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å\n            await conn.execute(\"\"\"\n                INSERT INTO bot_users (user_id) \n                VALUES ($1) \n                ON CONFLICT (user_id) DO NOTHING\n            \"\"\", user_id)\n            \n            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            update_data = {variable_name: variable_value}\n            await conn.execute(\"\"\"\n                UPDATE bot_users \n                SET user_data = COALESCE(user_data, '{}'::jsonb) || $2::jsonb,\n                    last_interaction = NOW()\n                WHERE user_id = $1\n            \"\"\", user_id, json.dumps(update_data))\n        return True\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}\")\n        return False\n\n\n# –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\nasync def is_admin(user_id: int) -> bool:\n    return user_id in ADMIN_IDS\n\nasync def is_private_chat(message: types.Message) -> bool:\n    return message.chat.type == \"private\"\n\nasync def check_auth(user_id: int) -> bool:\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\n    if db_pool:\n        user = await get_user_from_db(user_id)\n        return user is not None\n    return user_id in user_data\n\ndef is_local_file(url: str) -> bool:\n    \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL –ª–æ–∫–∞–ª—å–Ω—ã–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–æ–º\"\"\"\n    return url.startswith(\"/uploads/\") or url.startswith(\"uploads/\")\n\ndef get_local_file_path(url: str) -> str:\n    \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–∑ URL\"\"\"\n    if url.startswith(\"/\"):\n        return url[1:]  # –£–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–π —Å–ª–µ—à\n    return url\n\ndef extract_coordinates_from_yandex(url: str) -> tuple:\n    \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç\"\"\"\n    import re\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ ll=longitude,latitude\n    match = re.search(r\"ll=([\\d.-]+),([\\d.-]+)\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ /longitude,latitude/\n    match = re.search(r\"/([\\d.-]+),([\\d.-]+)/\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    return None, None\n\ndef extract_coordinates_from_google(url: str) -> tuple:\n    \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏ Google Maps\"\"\"\n    import re\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ @latitude,longitude\n    match = re.search(r\"@([\\d.-]+),([\\d.-]+)\", url)\n    if match:\n        return float(match.group(1)), float(match.group(2))  # lat, lon\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ /latitude,longitude/\n    match = re.search(r\"/([\\d.-]+),([\\d.-]+)/\", url)\n    if match:\n        return float(match.group(1)), float(match.group(2))  # lat, lon\n    return None, None\n\ndef extract_coordinates_from_2gis(url: str) -> tuple:\n    \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏ 2–ì–ò–°\"\"\"\n    import re\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö 2–ì–ò–°\n    # –§–æ—Ä–º–∞—Ç: center/longitude,latitude\n    match = re.search(r\"center/([\\d.-]+),([\\d.-]+)\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    # –§–æ—Ä–º–∞—Ç: /longitude,latitude/\n    match = re.search(r\"/([\\d.-]+),([\\d.-]+)/\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    return None, None\n\ndef generate_map_urls(latitude: float, longitude: float, title: str = \"\") -> dict:\n    \"\"\"–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã\"\"\"\n    import urllib.parse\n    \n    encoded_title = urllib.parse.quote(title) if title else \"\"\n    \n    return {\n        \"yandex\": f\"https://yandex.ru/maps/?ll={longitude},{latitude}&z=15&l=map&pt={longitude},{latitude}\",\n        \"google\": f\"https://maps.google.com/?q={latitude},{longitude}\",\n        \"2gis\": f\"https://2gis.ru/geo/{longitude},{latitude}\",\n        \"openstreetmap\": f\"https://www.openstreetmap.org/?mlat={latitude}&mlon={longitude}&zoom=15\"\n    }\n\n\n@dp.message(CommandStart())\nasync def start_handler(message: types.Message):\n\n    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ\n    user_id = message.from_user.id\n    username = message.from_user.username\n    first_name = message.from_user.first_name\n    last_name = message.from_user.last_name\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    saved_to_db = await save_user_to_db(user_id, username, first_name, last_name)\n    \n    # –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\n    if not saved_to_db:\n        user_data[user_id] = {\n            \"username\": username,\n            \"first_name\": first_name,\n            \"last_name\": last_name,\n            \"registered_at\": message.date\n        }\n        logging.info(f\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\")\n    else:\n        logging.info(f\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\")\n\n    text = \"\"\"–ü—Ä–∏–≤–µ—Ç! üåü\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –±–æ—Ç!\n–û—Ç–∫—É–¥–∞ –≤—ã —É–∑–Ω–∞–ª–∏ –æ –Ω–∞—Å?\"\"\"\n    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)\n    if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n        current_parse_mode = conditional_parse_mode\n    else:\n        current_parse_mode = None\n    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã\n    use_conditional_keyboard = False\n    conditional_keyboard = None\n    await message.answer(text, parse_mode=current_parse_mode if current_parse_mode else None)\n    \n    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n    user_data[message.from_user.id] = user_data.get(message.from_user.id, {})\n    user_data[message.from_user.id][\"waiting_for_input\"] = \"start_node\"\n\n@dp.message(Command(\"profile\"))\nasync def profile_handler(message: types.Message):\n    logging.info(f\"–ö–æ–º–∞–Ω–¥–∞ /profile –≤—ã–∑–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.from_user.id}\")\n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥\n    user_id = message.from_user.id\n    username = message.from_user.username\n    first_name = message.from_user.first_name\n    last_name = message.from_user.last_name\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    saved_to_db = await save_user_to_db(user_id, username, first_name, last_name)\n    \n    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–∞–Ω–¥ –≤ –ë–î\n    if saved_to_db:\n        await update_user_data_in_db(user_id, \"command_profile\", datetime.now().isoformat())\n    \n    # –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    if \"commands_used\" not in user_data[user_id]:\n        user_data[user_id][\"commands_used\"] = {}\n    user_data[user_id][\"commands_used\"][\"/profile\"] = user_data[user_id][\"commands_used\"].get(\"/profile\", 0) + 1\n\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n    text = None\n    \n    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record and isinstance(user_record[\"user_data\"], dict):\n            user_data_dict = user_record[\"user_data\"]\n        else:\n            user_data_dict = user_record\n    else:\n        user_data_dict = {}\n    \n    conditional_parse_mode = None\n    conditional_keyboard = None\n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    def check_user_variable(var_name, user_data_dict):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n        if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n            try:\n                import json\n                parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                if var_name in parsed_data:\n                    raw_value = parsed_data[var_name]\n                    if isinstance(raw_value, dict) and \"value\" in raw_value:\n                        var_value = raw_value[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    else:\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if raw_value is not None and str(raw_value).strip() != \"\":\n                            return True, str(raw_value)\n            except (json.JSONDecodeError, TypeError):\n                pass\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n        if var_name in user_data_dict:\n            variable_data = user_data_dict.get(var_name)\n            if isinstance(variable_data, dict) and \"value\" in variable_data:\n                var_value = variable_data[\"value\"]\n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                if var_value is not None and str(var_value).strip() != \"\":\n                    return True, str(var_value)\n            elif variable_data is not None and str(variable_data).strip() != \"\":\n                return True, str(variable_data)\n        \n        return False, None\n    \n    # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏—Å—Ç–æ—á–Ω–∏–∫, –∂–µ–ª–∞–Ω–∏–µ, –ø–æ–ª, –∏–º—è\n    if (\n        check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)[0] and\n        check_user_variable(\"–∂–µ–ª–∞–Ω–∏–µ\", user_data_dict)[0] and\n        check_user_variable(\"–ø–æ–ª\", user_data_dict)[0] and\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] = check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)\n        _, variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"] = check_user_variable(\"–∂–µ–ª–∞–Ω–∏–µ\", user_data_dict)\n        _, variable_values[\"–ø–æ–ª\"] = check_user_variable(\"–ø–æ–ª\", user_data_dict)\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"\"\"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\nüîç –ò—Å—Ç–æ—á–Ω–∏–∫: {–∏—Å—Ç–æ—á–Ω–∏–∫}\nüí≠ –ñ–µ–ª–∞–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å: {–∂–µ–ª–∞–Ω–∏–µ}\n‚ößÔ∏è –ü–æ–ª: {–ø–æ–ª}\nüëã –ò–º—è: {–∏–º—è}\n\n–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω! ‚úÖ\"\"\"\n        conditional_parse_mode = None\n        if \"{–∏—Å—Ç–æ—á–Ω–∏–∫}\" in text and variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] is not None:\n            text = text.replace(\"{–∏—Å—Ç–æ—á–Ω–∏–∫}\", variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"])\n        if \"{–∂–µ–ª–∞–Ω–∏–µ}\" in text and variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"] is not None:\n            text = text.replace(\"{–∂–µ–ª–∞–Ω–∏–µ}\", variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"])\n        if \"{–ø–æ–ª}\" in text and variable_values[\"–ø–æ–ª\"] is not None:\n            text = text.replace(\"{–ø–æ–ª}\", variable_values[\"–ø–æ–ª\"])\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"profile_with_all_data\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    # –£—Å–ª–æ–≤–∏–µ 2: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n    elif (\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"\"\"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\nüëã –ò–º—è: {–∏–º—è}\n\n–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏ –ø–æ–ª–Ω—ã–π –æ–ø—Ä–æ—Å?\"\"\"\n        conditional_parse_mode = None\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"profile_basic_info\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    # –£—Å–ª–æ–≤–∏–µ 3: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏—Å—Ç–æ—á–Ω–∏–∫\n    elif (\n        check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] = check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)\n        text = \"\"\"üë§ –ß–∞—Å—Ç–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å:\n\nüîç –ò—Å—Ç–æ—á–Ω–∏–∫: {–∏—Å—Ç–æ—á–Ω–∏–∫}\n\n–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω —á–∞—Å—Ç–∏—á–Ω–æ. –ü—Ä–æ–π–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\"\"\"\n        conditional_parse_mode = None\n        if \"{–∏—Å—Ç–æ—á–Ω–∏–∫}\" in text and variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] is not None:\n            text = text.replace(\"{–∏—Å—Ç–æ—á–Ω–∏–∫}\", variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"profile_partial\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (OR)\")\n    # –£—Å–ª–æ–≤–∏–µ 4: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏—Å—Ç–æ—á–Ω–∏–∫, –∂–µ–ª–∞–Ω–∏–µ, –ø–æ–ª, –∏–º—è\n    elif (\n        check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)[0] or\n        check_user_variable(\"–∂–µ–ª–∞–Ω–∏–µ\", user_data_dict)[0] or\n        check_user_variable(\"–ø–æ–ª\", user_data_dict)[0] or\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] = check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)\n        _, variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"] = check_user_variable(\"–∂–µ–ª–∞–Ω–∏–µ\", user_data_dict)\n        _, variable_values[\"–ø–æ–ª\"] = check_user_variable(\"–ø–æ–ª\", user_data_dict)\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"\"\"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\n–£ –Ω–∞—Å –µ—Å—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—Å. –ü—Ä–æ–π–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –æ–ø—Ä–æ—Å —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é.\n\n–ò–º–µ—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ:\nüîç –ò—Å—Ç–æ—á–Ω–∏–∫: {–∏—Å—Ç–æ—á–Ω–∏–∫}\nüí≠ –ñ–µ–ª–∞–Ω–∏–µ: {–∂–µ–ª–∞–Ω–∏–µ}\n‚ößÔ∏è –ü–æ–ª: {–ø–æ–ª}\nüëã –ò–º—è: {–∏–º—è}\"\"\"\n        conditional_parse_mode = None\n        if \"{–∏—Å—Ç–æ—á–Ω–∏–∫}\" in text and variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] is not None:\n            text = text.replace(\"{–∏—Å—Ç–æ—á–Ω–∏–∫}\", variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"])\n        if \"{–∂–µ–ª–∞–Ω–∏–µ}\" in text and variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"] is not None:\n            text = text.replace(\"{–∂–µ–ª–∞–Ω–∏–µ}\", variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"])\n        if \"{–ø–æ–ª}\" in text and variable_values[\"–ø–æ–ª\"] is not None:\n            text = text.replace(\"{–ø–æ–ª}\", variable_values[\"–ø–æ–ª\"])\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"profile_any_data\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (OR)\")\n    else:\n        text = \"\"\"üë§ –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\n\n–ü–æ—Ö–æ–∂–µ, –≤—ã –µ—â–µ –Ω–µ –ø—Ä–æ—à–ª–∏ –æ–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ /start —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.\"\"\"\n        logging.info(\"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–ø–∞—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\")\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã\n    user_data_dict = user_record if user_record else user_data.get(user_id, {})\n    conditional_parse_mode = None\n    conditional_keyboard = None\n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    def check_user_variable(var_name, user_data_dict):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n        if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n            try:\n                import json\n                parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                if var_name in parsed_data:\n                    raw_value = parsed_data[var_name]\n                    if isinstance(raw_value, dict) and \"value\" in raw_value:\n                        var_value = raw_value[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    else:\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if raw_value is not None and str(raw_value).strip() != \"\":\n                            return True, str(raw_value)\n            except (json.JSONDecodeError, TypeError):\n                pass\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n        if var_name in user_data_dict:\n            variable_data = user_data_dict.get(var_name)\n            if isinstance(variable_data, dict) and \"value\" in variable_data:\n                var_value = variable_data[\"value\"]\n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                if var_value is not None and str(var_value).strip() != \"\":\n                    return True, str(var_value)\n            elif variable_data is not None and str(variable_data).strip() != \"\":\n                return True, str(variable_data)\n        \n        return False, None\n    \n    # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏—Å—Ç–æ—á–Ω–∏–∫, –∂–µ–ª–∞–Ω–∏–µ, –ø–æ–ª, –∏–º—è\n    if (\n        check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)[0] and\n        check_user_variable(\"–∂–µ–ª–∞–Ω–∏–µ\", user_data_dict)[0] and\n        check_user_variable(\"–ø–æ–ª\", user_data_dict)[0] and\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] = check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)\n        _, variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"] = check_user_variable(\"–∂–µ–ª–∞–Ω–∏–µ\", user_data_dict)\n        _, variable_values[\"–ø–æ–ª\"] = check_user_variable(\"–ø–æ–ª\", user_data_dict)\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"\"\"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\nüîç –ò—Å—Ç–æ—á–Ω–∏–∫: {–∏—Å—Ç–æ—á–Ω–∏–∫}\nüí≠ –ñ–µ–ª–∞–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å: {–∂–µ–ª–∞–Ω–∏–µ}\n‚ößÔ∏è –ü–æ–ª: {–ø–æ–ª}\nüëã –ò–º—è: {–∏–º—è}\n\n–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω! ‚úÖ\"\"\"\n        conditional_parse_mode = None\n        if \"{–∏—Å—Ç–æ—á–Ω–∏–∫}\" in text and variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] is not None:\n            text = text.replace(\"{–∏—Å—Ç–æ—á–Ω–∏–∫}\", variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"])\n        if \"{–∂–µ–ª–∞–Ω–∏–µ}\" in text and variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"] is not None:\n            text = text.replace(\"{–∂–µ–ª–∞–Ω–∏–µ}\", variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"])\n        if \"{–ø–æ–ª}\" in text and variable_values[\"–ø–æ–ª\"] is not None:\n            text = text.replace(\"{–ø–æ–ª}\", variable_values[\"–ø–æ–ª\"])\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"profile_with_all_data\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    # –£—Å–ª–æ–≤–∏–µ 2: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n    elif (\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"\"\"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\nüëã –ò–º—è: {–∏–º—è}\n\n–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏ –ø–æ–ª–Ω—ã–π –æ–ø—Ä–æ—Å?\"\"\"\n        conditional_parse_mode = None\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"profile_basic_info\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    # –£—Å–ª–æ–≤–∏–µ 3: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏—Å—Ç–æ—á–Ω–∏–∫\n    elif (\n        check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] = check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)\n        text = \"\"\"üë§ –ß–∞—Å—Ç–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å:\n\nüîç –ò—Å—Ç–æ—á–Ω–∏–∫: {–∏—Å—Ç–æ—á–Ω–∏–∫}\n\n–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω —á–∞—Å—Ç–∏—á–Ω–æ. –ü—Ä–æ–π–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\"\"\"\n        conditional_parse_mode = None\n        if \"{–∏—Å—Ç–æ—á–Ω–∏–∫}\" in text and variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] is not None:\n            text = text.replace(\"{–∏—Å—Ç–æ—á–Ω–∏–∫}\", variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"profile_partial\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (OR)\")\n    # –£—Å–ª–æ–≤–∏–µ 4: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏—Å—Ç–æ—á–Ω–∏–∫, –∂–µ–ª–∞–Ω–∏–µ, –ø–æ–ª, –∏–º—è\n    elif (\n        check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)[0] or\n        check_user_variable(\"–∂–µ–ª–∞–Ω–∏–µ\", user_data_dict)[0] or\n        check_user_variable(\"–ø–æ–ª\", user_data_dict)[0] or\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] = check_user_variable(\"–∏—Å—Ç–æ—á–Ω–∏–∫\", user_data_dict)\n        _, variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"] = check_user_variable(\"–∂–µ–ª–∞–Ω–∏–µ\", user_data_dict)\n        _, variable_values[\"–ø–æ–ª\"] = check_user_variable(\"–ø–æ–ª\", user_data_dict)\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"\"\"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\n–£ –Ω–∞—Å –µ—Å—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—Å. –ü—Ä–æ–π–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –æ–ø—Ä–æ—Å —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é.\n\n–ò–º–µ—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ:\nüîç –ò—Å—Ç–æ—á–Ω–∏–∫: {–∏—Å—Ç–æ—á–Ω–∏–∫}\nüí≠ –ñ–µ–ª–∞–Ω–∏–µ: {–∂–µ–ª–∞–Ω–∏–µ}\n‚ößÔ∏è –ü–æ–ª: {–ø–æ–ª}\nüëã –ò–º—è: {–∏–º—è}\"\"\"\n        conditional_parse_mode = None\n        if \"{–∏—Å—Ç–æ—á–Ω–∏–∫}\" in text and variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] is not None:\n            text = text.replace(\"{–∏—Å—Ç–æ—á–Ω–∏–∫}\", variable_values[\"–∏—Å—Ç–æ—á–Ω–∏–∫\"])\n        if \"{–∂–µ–ª–∞–Ω–∏–µ}\" in text and variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"] is not None:\n            text = text.replace(\"{–∂–µ–ª–∞–Ω–∏–µ}\", variable_values[\"–∂–µ–ª–∞–Ω–∏–µ\"])\n        if \"{–ø–æ–ª}\" in text and variable_values[\"–ø–æ–ª\"] is not None:\n            text = text.replace(\"{–ø–æ–ª}\", variable_values[\"–ø–æ–ª\"])\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"profile_any_data\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (OR)\")\n    \n    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —É—Å–ª–æ–≤–∏–µ\n    if \"text\" not in locals():\n        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ\n        pass  # text —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—ã—à–µ\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    use_conditional_keyboard = conditional_keyboard is not None\n    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)\n    if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n        current_parse_mode = conditional_parse_mode\n    else:\n        current_parse_mode = None\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    if use_conditional_keyboard:\n        await message.answer(text, reply_markup=conditional_keyboard, parse_mode=current_parse_mode if current_parse_mode else None)\n    else:\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"üìù –ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å\", callback_data=\"cmd_start\"))\n        builder.add(InlineKeyboardButton(text=\"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è\", callback_data=\"XDSrTrNly5EtDtr85nN4P\"))\n        keyboard = builder.as_markup()\n        await message.answer(text, reply_markup=keyboard, parse_mode=current_parse_mode if current_parse_mode else None)\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ inline –∫–Ω–æ–ø–æ–∫\n\n@dp.callback_query(lambda c: c.data == \"nr3wIiTfBYYmpkkXMNH7n\" or c.data.startswith(\"nr3wIiTfBYYmpkkXMNH7n_btn_\"))\nasync def handle_callback_nr3wIiTfBYYmpkkXMNH7n(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    button_text = \"–î–∞\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    await update_user_data_in_db(user_id, \"–∂–µ–ª–∞–Ω–∏–µ\", button_text)\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∂–µ–ª–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(button_text) + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–∑–µ–ª —Ç–∏–ø–∞ keyboard: nr3wIiTfBYYmpkkXMNH7n\n    text = \"–ö–∞–∫–æ–π —Ç–≤–æ–π –ø–æ–ª?\"\n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è keyboard —É–∑–ª–∞\n    user_data_dict = user_record if user_record else user_data.get(callback_query.from_user.id, {})\n    conditional_parse_mode = None\n    conditional_keyboard = None\n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    def check_user_variable(var_name, user_data_dict):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n        if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n            try:\n                import json\n                parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                if var_name in parsed_data:\n                    raw_value = parsed_data[var_name]\n                    if isinstance(raw_value, dict) and \"value\" in raw_value:\n                        var_value = raw_value[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    else:\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if raw_value is not None and str(raw_value).strip() != \"\":\n                            return True, str(raw_value)\n            except (json.JSONDecodeError, TypeError):\n                pass\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n        if var_name in user_data_dict:\n            variable_data = user_data_dict.get(var_name)\n            if isinstance(variable_data, dict) and \"value\" in variable_data:\n                var_value = variable_data[\"value\"]\n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                if var_value is not None and str(var_value).strip() != \"\":\n                    return True, str(var_value)\n            elif variable_data is not None and str(variable_data).strip() != \"\":\n                return True, str(variable_data)\n        \n        return False, None\n    \n    # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –ø–æ–ª\n    if (\n        check_user_variable(\"–ø–æ–ª\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–ø–æ–ª\"] = check_user_variable(\"–ø–æ–ª\", user_data_dict)\n        text = \"\"\"–í–∞—à –ø–æ–ª: {–ø–æ–ª}\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:\"\"\"\n        conditional_parse_mode = None\n        if \"{–ø–æ–ª}\" in text and variable_values[\"–ø–æ–ª\"] is not None:\n            text = text.replace(\"{–ø–æ–ª}\", variable_values[\"–ø–æ–ª\"])\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"–ñ–µ–Ω—â–∏–Ω–∞\", callback_data=\"conditional_–ø–æ–ª_–ñ–µ–Ω—â–∏–Ω–∞\"))\n        builder.add(InlineKeyboardButton(text=\"–ú—É–∂—á–∏–Ω–∞\", callback_data=\"conditional_–ø–æ–ª_–ú—É–∂—á–∏–Ω–∞\"))\n        keyboard = builder.as_markup()\n        conditional_keyboard = keyboard\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"gender_already_set\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    \n    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —É—Å–ª–æ–≤–∏–µ\n    if \"text\" not in locals():\n        text = \"–ö–∞–∫–æ–π —Ç–≤–æ–π –ø–æ–ª?\"\n    \n    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –µ—Å–ª–∏ –µ—Å—Ç—å\n    if conditional_keyboard is not None:\n        keyboard = conditional_keyboard\n    else:\n        keyboard = None\n    \n    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª)\n    if callback_query.from_user.id not in user_data:\n        user_data[callback_query.from_user.id] = {}\n    \n    user_data[callback_query.from_user.id][\"waiting_for_input\"] = \"nr3wIiTfBYYmpkkXMNH7n\"\n    user_data[callback_query.from_user.id][\"input_type\"] = \"text\"\n    user_data[callback_query.from_user.id][\"input_variable\"] = \"–ø–æ–ª\"\n    user_data[callback_query.from_user.id][\"save_to_database\"] = True\n    user_data[callback_query.from_user.id][\"input_target_node_id\"] = \"\"\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—è –¥–ª—è —ç—Ç–æ–≥–æ —É–∑–ª–∞\n    if \"keyboard\" not in locals() or keyboard is None:\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ (+ —Å–±–æ—Ä –≤–≤–æ–¥–∞ –≤–∫–ª—é—á–µ–Ω)\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"–ñ–µ–Ω—â–∏–Ω–∞\", callback_data=\"XDSrTrNly5EtDtr85nN4P_btn_0_btn_0\"))\n        builder.add(InlineKeyboardButton(text=\"–ú—É–∂—á–∏–Ω–∞\", callback_data=\"XDSrTrNly5EtDtr85nN4P_btn_1_btn_1\"))\n        keyboard = builder.as_markup()\n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text, reply_markup=keyboard)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text, reply_markup=keyboard)\n    \n\n@dp.callback_query(lambda c: c.data == \"1BHSLWPMao9qQvSAzuzRl\" or c.data.startswith(\"1BHSLWPMao9qQvSAzuzRl_btn_\"))\nasync def handle_callback_1BHSLWPMao9qQvSAzuzRl(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    button_text = \"–ù–µ—Ç\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    await update_user_data_in_db(user_id, \"–∂–µ–ª–∞–Ω–∏–µ\", button_text)\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∂–µ–ª–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(button_text) + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    \n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–∑–ª–∞ 1BHSLWPMao9qQvSAzuzRl\n    text = \"–ü–µ—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ –Ω–∞–ø–∏—à–∏ /start –∏–ª–∏ /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è\"\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ë–µ–∑ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    keyboard = None\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞\n    if keyboard is None:\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"cmd_start\"))\n        builder.add(InlineKeyboardButton(text=\"üë§ –ü—Ä–æ—Ñ–∏–ª—å\", callback_data=\"cmd_profile\"))\n        keyboard = builder.as_markup()\n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n    try:\n        if keyboard is not None:\n            await callback_query.message.edit_text(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.edit_text(text)\n    except Exception:\n        if keyboard is not None:\n            await callback_query.message.answer(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.answer(text)\n\n@dp.callback_query(lambda c: c.data == \"XDSrTrNly5EtDtr85nN4P\" or c.data.startswith(\"XDSrTrNly5EtDtr85nN4P_btn_\"))\nasync def handle_callback_XDSrTrNly5EtDtr85nN4P(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    button_text = \"–ñ–µ–Ω—â–∏–Ω–∞\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    await update_user_data_in_db(user_id, \"–ø–æ–ª\", button_text)\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(button_text) + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–∑–µ–ª —Ç–∏–ø–∞ keyboard: XDSrTrNly5EtDtr85nN4P\n    text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è keyboard —É–∑–ª–∞\n    user_data_dict = user_record if user_record else user_data.get(callback_query.from_user.id, {})\n    conditional_parse_mode = None\n    conditional_keyboard = None\n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    def check_user_variable(var_name, user_data_dict):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n        if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n            try:\n                import json\n                parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                if var_name in parsed_data:\n                    raw_value = parsed_data[var_name]\n                    if isinstance(raw_value, dict) and \"value\" in raw_value:\n                        var_value = raw_value[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    else:\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if raw_value is not None and str(raw_value).strip() != \"\":\n                            return True, str(raw_value)\n            except (json.JSONDecodeError, TypeError):\n                pass\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n        if var_name in user_data_dict:\n            variable_data = user_data_dict.get(var_name)\n            if isinstance(variable_data, dict) and \"value\" in variable_data:\n                var_value = variable_data[\"value\"]\n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                if var_value is not None and str(var_value).strip() != \"\":\n                    return True, str(var_value)\n            elif variable_data is not None and str(variable_data).strip() != \"\":\n                return True, str(variable_data)\n        \n        return False, None\n    \n    # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n    if (\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º—è: {–∏–º—è}. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:\"\n        conditional_parse_mode = None\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"name_already_exists\",\n            \"wait_for_input\": True,\n            \"input_variable\": \"–∏–º—è\",\n            \"next_node_id\": \"profile_command\",\n            \"source_type\": \"conditional_message\"\n        }\n        \n        # –ï—Å–ª–∏ –µ—Å—Ç—å —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –≤–≤–æ–¥–∞\n        if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\n            user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\n            logging.info(f\"–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –æ–∂–∏–¥–∞–Ω–∏–µ —É—Å–ª–æ–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞: {conditional_message_config}\")\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    \n    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —É—Å–ª–æ–≤–∏–µ\n    if \"text\" not in locals():\n        text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n    \n    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –µ—Å–ª–∏ –µ—Å—Ç—å\n    if conditional_keyboard is not None:\n        keyboard = conditional_keyboard\n    else:\n        keyboard = None\n    \n    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª)\n    if callback_query.from_user.id not in user_data:\n        user_data[callback_query.from_user.id] = {}\n    \n    user_data[callback_query.from_user.id][\"waiting_for_input\"] = \"XDSrTrNly5EtDtr85nN4P\"\n    user_data[callback_query.from_user.id][\"input_type\"] = \"text\"\n    user_data[callback_query.from_user.id][\"input_variable\"] = \"–∏–º—è\"\n    user_data[callback_query.from_user.id][\"save_to_database\"] = True\n    user_data[callback_query.from_user.id][\"input_target_node_id\"] = \"final-message-node\"\n    \n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text)\n    \n\n@dp.callback_query(lambda c: c.data == \"XDSrTrNly5EtDtr85nN4P\" or c.data.startswith(\"XDSrTrNly5EtDtr85nN4P_btn_\"))\nasync def handle_callback_XDSrTrNly5EtDtr85nN4P(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    button_text = \"–ú—É–∂—á–∏–Ω–∞\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    await update_user_data_in_db(user_id, \"–ø–æ–ª\", button_text)\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(button_text) + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–∑–µ–ª —Ç–∏–ø–∞ keyboard: XDSrTrNly5EtDtr85nN4P\n    text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è keyboard —É–∑–ª–∞\n    user_data_dict = user_record if user_record else user_data.get(callback_query.from_user.id, {})\n    conditional_parse_mode = None\n    conditional_keyboard = None\n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    def check_user_variable(var_name, user_data_dict):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n        if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n            try:\n                import json\n                parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                if var_name in parsed_data:\n                    raw_value = parsed_data[var_name]\n                    if isinstance(raw_value, dict) and \"value\" in raw_value:\n                        var_value = raw_value[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    else:\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if raw_value is not None and str(raw_value).strip() != \"\":\n                            return True, str(raw_value)\n            except (json.JSONDecodeError, TypeError):\n                pass\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n        if var_name in user_data_dict:\n            variable_data = user_data_dict.get(var_name)\n            if isinstance(variable_data, dict) and \"value\" in variable_data:\n                var_value = variable_data[\"value\"]\n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                if var_value is not None and str(var_value).strip() != \"\":\n                    return True, str(var_value)\n            elif variable_data is not None and str(variable_data).strip() != \"\":\n                return True, str(variable_data)\n        \n        return False, None\n    \n    # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n    if (\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º—è: {–∏–º—è}. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:\"\n        conditional_parse_mode = None\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"name_already_exists\",\n            \"wait_for_input\": True,\n            \"input_variable\": \"–∏–º—è\",\n            \"next_node_id\": \"profile_command\",\n            \"source_type\": \"conditional_message\"\n        }\n        \n        # –ï—Å–ª–∏ –µ—Å—Ç—å —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –≤–≤–æ–¥–∞\n        if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\n            user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\n            logging.info(f\"–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –æ–∂–∏–¥–∞–Ω–∏–µ —É—Å–ª–æ–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞: {conditional_message_config}\")\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    \n    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —É—Å–ª–æ–≤–∏–µ\n    if \"text\" not in locals():\n        text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n    \n    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –µ—Å–ª–∏ –µ—Å—Ç—å\n    if conditional_keyboard is not None:\n        keyboard = conditional_keyboard\n    else:\n        keyboard = None\n    \n    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª)\n    if callback_query.from_user.id not in user_data:\n        user_data[callback_query.from_user.id] = {}\n    \n    user_data[callback_query.from_user.id][\"waiting_for_input\"] = \"XDSrTrNly5EtDtr85nN4P\"\n    user_data[callback_query.from_user.id][\"input_type\"] = \"text\"\n    user_data[callback_query.from_user.id][\"input_variable\"] = \"–∏–º—è\"\n    user_data[callback_query.from_user.id][\"save_to_database\"] = True\n    user_data[callback_query.from_user.id][\"input_target_node_id\"] = \"final-message-node\"\n    \n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text)\n    \n\n@dp.callback_query(lambda c: c.data == \"XDSrTrNly5EtDtr85nN4P\" or c.data.startswith(\"XDSrTrNly5EtDtr85nN4P_btn_\"))\nasync def handle_callback_XDSrTrNly5EtDtr85nN4P(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    button_text = \"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    response_data = button_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    await update_user_data_in_db(user_id, button_text, response_data)\n    logging.info(f\"–ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {button_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–∑–µ–ª —Ç–∏–ø–∞ keyboard: XDSrTrNly5EtDtr85nN4P\n    text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è keyboard —É–∑–ª–∞\n    user_data_dict = user_record if user_record else user_data.get(callback_query.from_user.id, {})\n    conditional_parse_mode = None\n    conditional_keyboard = None\n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    def check_user_variable(var_name, user_data_dict):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n        if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n            try:\n                import json\n                parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                if var_name in parsed_data:\n                    raw_value = parsed_data[var_name]\n                    if isinstance(raw_value, dict) and \"value\" in raw_value:\n                        var_value = raw_value[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    else:\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if raw_value is not None and str(raw_value).strip() != \"\":\n                            return True, str(raw_value)\n            except (json.JSONDecodeError, TypeError):\n                pass\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n        if var_name in user_data_dict:\n            variable_data = user_data_dict.get(var_name)\n            if isinstance(variable_data, dict) and \"value\" in variable_data:\n                var_value = variable_data[\"value\"]\n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                if var_value is not None and str(var_value).strip() != \"\":\n                    return True, str(var_value)\n            elif variable_data is not None and str(variable_data).strip() != \"\":\n                return True, str(variable_data)\n        \n        return False, None\n    \n    # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n    if (\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º—è: {–∏–º—è}. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:\"\n        conditional_parse_mode = None\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"name_already_exists\",\n            \"wait_for_input\": True,\n            \"input_variable\": \"–∏–º—è\",\n            \"next_node_id\": \"profile_command\",\n            \"source_type\": \"conditional_message\"\n        }\n        \n        # –ï—Å–ª–∏ –µ—Å—Ç—å —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –≤–≤–æ–¥–∞\n        if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\n            user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\n            logging.info(f\"–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –æ–∂–∏–¥–∞–Ω–∏–µ —É—Å–ª–æ–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞: {conditional_message_config}\")\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    \n    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —É—Å–ª–æ–≤–∏–µ\n    if \"text\" not in locals():\n        text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n    \n    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –µ—Å–ª–∏ –µ—Å—Ç—å\n    if conditional_keyboard is not None:\n        keyboard = conditional_keyboard\n    else:\n        keyboard = None\n    \n    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª)\n    if callback_query.from_user.id not in user_data:\n        user_data[callback_query.from_user.id] = {}\n    \n    user_data[callback_query.from_user.id][\"waiting_for_input\"] = \"XDSrTrNly5EtDtr85nN4P\"\n    user_data[callback_query.from_user.id][\"input_type\"] = \"text\"\n    user_data[callback_query.from_user.id][\"input_variable\"] = \"–∏–º—è\"\n    user_data[callback_query.from_user.id][\"save_to_database\"] = True\n    user_data[callback_query.from_user.id][\"input_target_node_id\"] = \"final-message-node\"\n    \n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text)\n    \n\n@dp.callback_query(lambda c: c.data == \"nr3wIiTfBYYmpkkXMNH7n\" or c.data.startswith(\"nr3wIiTfBYYmpkkXMNH7n_btn_\"))\nasync def handle_callback_nr3wIiTfBYYmpkkXMNH7n(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    user_id = callback_query.from_user.id\n    \n    # –ò—â–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ callback_data\n    button_display_text = \"–î–∞\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    \n    response_data = button_display_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    user_data[user_id][\"button_click\"] = button_display_text\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π\n    await update_user_data_in_db(user_id, \"–∂–µ–ª–∞–Ω–∏–µ\", button_display_text)\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∂–µ–ª–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(button_display_text) + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ\n    await callback_query.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...\")\n    \n    # –ü–ï–†–ï–ê–î–†–ï–°–ê–¶–ò–Ø: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n    next_node_id = \"nr3wIiTfBYYmpkkXMNH7n\"\n    try:\n        logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–Ω–æ–ø–∫–∏: {next_node_id}\")\n        if next_node_id == \"start_node\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start_node\")\n        elif next_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É --2N9FeeykMHVVlsVnSQW\")\n        elif next_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É nr3wIiTfBYYmpkkXMNH7n\")\n        elif next_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n            nav_text = \"–ü–µ—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ –Ω–∞–ø–∏—à–∏ /start –∏–ª–∏ /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n            await callback_query.message.delete()\n            # –£–∑–µ–ª —Å —É—Å–ª–æ–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è\n            user_id = callback_query.from_user.id\n            user_data_dict = await get_user_from_db(user_id) or {}\n            user_data_dict.update(user_data.get(user_id, {}))\n\n            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            def check_user_variable(var_name, user_data_dict):\n                \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n                # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n                if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n                    try:\n                        import json\n                        parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                        if var_name in parsed_data:\n                            raw_value = parsed_data[var_name]\n                            if isinstance(raw_value, dict) and \"value\" in raw_value:\n                                var_value = raw_value[\"value\"]\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if var_value is not None and str(var_value).strip() != \"\":\n                                    return True, str(var_value)\n                            else:\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if raw_value is not None and str(raw_value).strip() != \"\":\n                                    return True, str(raw_value)\n                    except (json.JSONDecodeError, TypeError):\n                        pass\n                \n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n                if var_name in user_data_dict:\n                    variable_data = user_data_dict.get(var_name)\n                    if isinstance(variable_data, dict) and \"value\" in variable_data:\n                        var_value = variable_data[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    elif variable_data is not None and str(variable_data).strip() != \"\":\n                        return True, str(variable_data)\n                \n                return False, None\n\n            # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n            if (\n                check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n            ):\n                # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n                variable_values = {}\n                _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n                text = \"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º—è: {–∏–º—è}. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:\"\n                if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n                    text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n                await bot.send_message(user_id, text)\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"profile_command\"\n                }\n            else:\n                # Fallback —Å–æ–æ–±—â–µ–Ω–∏–µ\n                nav_text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"final-message-node\"\n                }\n                await bot.send_message(user_id, nav_text)\n        elif next_node_id == \"final-message-node\":\n            nav_text = \"\"\"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üéâ\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /profile —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\"\"\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"profile_command\":\n            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É /profile\n            from types import SimpleNamespace\n            fake_message = SimpleNamespace()\n            fake_message.from_user = callback_query.from_user\n            fake_message.chat = callback_query.message.chat\n            fake_message.date = callback_query.message.date\n            fake_message.answer = callback_query.message.answer\n            await profile_handler(fake_message)\n        else:\n            logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n    \n    return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n    text = None\n    \n    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_data_dict = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_data_dict = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_data_dict = user_record[\"user_data\"]\n            else:\n                user_data_dict = {}\n        else:\n            user_data_dict = user_record\n    else:\n        user_data_dict = {}\n    \n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–º–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    conditional_parse_mode = None\n    conditional_keyboard = None\n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    def check_user_variable(var_name, user_data_dict):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n        if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n            try:\n                import json\n                parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                if var_name in parsed_data:\n                    raw_value = parsed_data[var_name]\n                    if isinstance(raw_value, dict) and \"value\" in raw_value:\n                        var_value = raw_value[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    else:\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if raw_value is not None and str(raw_value).strip() != \"\":\n                            return True, str(raw_value)\n            except (json.JSONDecodeError, TypeError):\n                pass\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n        if var_name in user_data_dict:\n            variable_data = user_data_dict.get(var_name)\n            if isinstance(variable_data, dict) and \"value\" in variable_data:\n                var_value = variable_data[\"value\"]\n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                if var_value is not None and str(var_value).strip() != \"\":\n                    return True, str(var_value)\n            elif variable_data is not None and str(variable_data).strip() != \"\":\n                return True, str(variable_data)\n        \n        return False, None\n    \n    # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –ø–æ–ª\n    if (\n        check_user_variable(\"–ø–æ–ª\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–ø–æ–ª\"] = check_user_variable(\"–ø–æ–ª\", user_data_dict)\n        text = \"\"\"–í–∞—à –ø–æ–ª: {–ø–æ–ª}\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:\"\"\"\n        conditional_parse_mode = None\n        if \"{–ø–æ–ª}\" in text and variable_values[\"–ø–æ–ª\"] is not None:\n            text = text.replace(\"{–ø–æ–ª}\", variable_values[\"–ø–æ–ª\"])\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"–ñ–µ–Ω—â–∏–Ω–∞\", callback_data=\"conditional_–ø–æ–ª_–ñ–µ–Ω—â–∏–Ω–∞\"))\n        builder.add(InlineKeyboardButton(text=\"–ú—É–∂—á–∏–Ω–∞\", callback_data=\"conditional_–ø–æ–ª_–ú—É–∂—á–∏–Ω–∞\"))\n        keyboard = builder.as_markup()\n        conditional_keyboard = keyboard\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"gender_already_set\",\n            \"wait_for_input\": False,\n            \"input_variable\": \"\",\n            \"next_node_id\": \"\",\n            \"source_type\": \"conditional_message\"\n        }\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    else:\n        text = \"–ö–∞–∫–æ–π —Ç–≤–æ–π –ø–æ–ª?\"\n        text = replace_variables_in_text(text, user_data_dict)\n        logging.info(\"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–ø–∞—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\")\n    \n    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞\n    if callback_query.from_user.id not in user_data:\n        user_data[callback_query.from_user.id] = {}\n    \n    user_data[callback_query.from_user.id][\"waiting_for_input\"] = \"nr3wIiTfBYYmpkkXMNH7n\"\n    user_data[callback_query.from_user.id][\"input_type\"] = \"text\"\n    user_data[callback_query.from_user.id][\"input_variable\"] = \"–ø–æ–ª\"\n    user_data[callback_query.from_user.id][\"save_to_database\"] = True\n    user_data[callback_query.from_user.id][\"input_target_node_id\"] = \"\"\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞\n    if \"keyboard\" not in locals() or keyboard is None:\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ (+ —Å–±–æ—Ä –≤–≤–æ–¥–∞ –≤–∫–ª—é—á–µ–Ω)\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"–ñ–µ–Ω—â–∏–Ω–∞\", callback_data=\"btn-female\"))\n        builder.add(InlineKeyboardButton(text=\"–ú—É–∂—á–∏–Ω–∞\", callback_data=\"btn-male\"))\n        keyboard = builder.as_markup()\n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text, reply_markup=keyboard)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text, reply_markup=keyboard)\n    \n\n@dp.callback_query(lambda c: c.data == \"1BHSLWPMao9qQvSAzuzRl\" or c.data.startswith(\"1BHSLWPMao9qQvSAzuzRl_btn_\"))\nasync def handle_callback_1BHSLWPMao9qQvSAzuzRl(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    user_id = callback_query.from_user.id\n    \n    # –ò—â–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ callback_data\n    button_display_text = \"–ù–µ—Ç\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    \n    response_data = button_display_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    user_data[user_id][\"button_click\"] = button_display_text\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π\n    await update_user_data_in_db(user_id, \"–∂–µ–ª–∞–Ω–∏–µ\", button_display_text)\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∂–µ–ª–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(button_display_text) + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ\n    await callback_query.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...\")\n    \n    # –ü–ï–†–ï–ê–î–†–ï–°–ê–¶–ò–Ø: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n    next_node_id = \"1BHSLWPMao9qQvSAzuzRl\"\n    try:\n        logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–Ω–æ–ø–∫–∏: {next_node_id}\")\n        if next_node_id == \"start_node\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start_node\")\n        elif next_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É --2N9FeeykMHVVlsVnSQW\")\n        elif next_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É nr3wIiTfBYYmpkkXMNH7n\")\n        elif next_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n            nav_text = \"–ü–µ—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ –Ω–∞–ø–∏—à–∏ /start –∏–ª–∏ /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n            await callback_query.message.delete()\n            # –£–∑–µ–ª —Å —É—Å–ª–æ–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è\n            user_id = callback_query.from_user.id\n            user_data_dict = await get_user_from_db(user_id) or {}\n            user_data_dict.update(user_data.get(user_id, {}))\n\n            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            def check_user_variable(var_name, user_data_dict):\n                \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n                # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n                if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n                    try:\n                        import json\n                        parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                        if var_name in parsed_data:\n                            raw_value = parsed_data[var_name]\n                            if isinstance(raw_value, dict) and \"value\" in raw_value:\n                                var_value = raw_value[\"value\"]\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if var_value is not None and str(var_value).strip() != \"\":\n                                    return True, str(var_value)\n                            else:\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if raw_value is not None and str(raw_value).strip() != \"\":\n                                    return True, str(raw_value)\n                    except (json.JSONDecodeError, TypeError):\n                        pass\n                \n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n                if var_name in user_data_dict:\n                    variable_data = user_data_dict.get(var_name)\n                    if isinstance(variable_data, dict) and \"value\" in variable_data:\n                        var_value = variable_data[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    elif variable_data is not None and str(variable_data).strip() != \"\":\n                        return True, str(variable_data)\n                \n                return False, None\n\n            # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n            if (\n                check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n            ):\n                # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n                variable_values = {}\n                _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n                text = \"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º—è: {–∏–º—è}. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:\"\n                if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n                    text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n                await bot.send_message(user_id, text)\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"profile_command\"\n                }\n            else:\n                # Fallback —Å–æ–æ–±—â–µ–Ω–∏–µ\n                nav_text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"final-message-node\"\n                }\n                await bot.send_message(user_id, nav_text)\n        elif next_node_id == \"final-message-node\":\n            nav_text = \"\"\"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üéâ\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /profile —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\"\"\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"profile_command\":\n            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É /profile\n            from types import SimpleNamespace\n            fake_message = SimpleNamespace()\n            fake_message.from_user = callback_query.from_user\n            fake_message.chat = callback_query.message.chat\n            fake_message.date = callback_query.message.date\n            fake_message.answer = callback_query.message.answer\n            await profile_handler(fake_message)\n        else:\n            logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n    \n    return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏\n    \n    text = \"–ü–µ—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ –Ω–∞–ø–∏—à–∏ /start –∏–ª–∏ /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è\"\n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    builder = InlineKeyboardBuilder()\n    builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"cmd_start\"))\n    builder.add(InlineKeyboardButton(text=\"üë§ –ü—Ä–æ—Ñ–∏–ª—å\", callback_data=\"cmd_profile\"))\n    keyboard = builder.as_markup()\n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text, reply_markup=keyboard)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text, reply_markup=keyboard)\n\n@dp.callback_query(lambda c: c.data == \"XDSrTrNly5EtDtr85nN4P\" or c.data.startswith(\"XDSrTrNly5EtDtr85nN4P_btn_\"))\nasync def handle_callback_XDSrTrNly5EtDtr85nN4P(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    user_id = callback_query.from_user.id\n    \n    # –ò—â–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ callback_data\n    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ callback_data\n    button_display_text = \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞\"\n    if callback_query.data.endswith(\"_btn_0\"):\n        button_display_text = \"–ñ–µ–Ω—â–∏–Ω–∞\"\n    if callback_query.data.endswith(\"_btn_1\"):\n        button_display_text = \"–ú—É–∂—á–∏–Ω–∞\"\n    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é callback_data\n    if callback_query.data == \"XDSrTrNly5EtDtr85nN4P\":\n        button_display_text = \"–ñ–µ–Ω—â–∏–Ω–∞\"\n    if callback_query.data == \"XDSrTrNly5EtDtr85nN4P\":\n        button_display_text = \"–ú—É–∂—á–∏–Ω–∞\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    \n    response_data = button_display_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    user_data[user_id][\"button_click\"] = button_display_text\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π\n    await update_user_data_in_db(user_id, \"–ø–æ–ª\", \"–ñ–µ–Ω—â–∏–Ω–∞\")\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(\"–ñ–µ–Ω—â–∏–Ω–∞\") + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ\n    await callback_query.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...\")\n    \n    # –ü–ï–†–ï–ê–î–†–ï–°–ê–¶–ò–Ø: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n    next_node_id = \"XDSrTrNly5EtDtr85nN4P\"\n    try:\n        logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–Ω–æ–ø–∫–∏: {next_node_id}\")\n        if next_node_id == \"start_node\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start_node\")\n        elif next_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É --2N9FeeykMHVVlsVnSQW\")\n        elif next_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É nr3wIiTfBYYmpkkXMNH7n\")\n        elif next_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n            nav_text = \"–ü–µ—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ –Ω–∞–ø–∏—à–∏ /start –∏–ª–∏ /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n            await callback_query.message.delete()\n            # –£–∑–µ–ª —Å —É—Å–ª–æ–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è\n            user_id = callback_query.from_user.id\n            user_data_dict = await get_user_from_db(user_id) or {}\n            user_data_dict.update(user_data.get(user_id, {}))\n\n            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            def check_user_variable(var_name, user_data_dict):\n                \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n                # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n                if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n                    try:\n                        import json\n                        parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                        if var_name in parsed_data:\n                            raw_value = parsed_data[var_name]\n                            if isinstance(raw_value, dict) and \"value\" in raw_value:\n                                var_value = raw_value[\"value\"]\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if var_value is not None and str(var_value).strip() != \"\":\n                                    return True, str(var_value)\n                            else:\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if raw_value is not None and str(raw_value).strip() != \"\":\n                                    return True, str(raw_value)\n                    except (json.JSONDecodeError, TypeError):\n                        pass\n                \n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n                if var_name in user_data_dict:\n                    variable_data = user_data_dict.get(var_name)\n                    if isinstance(variable_data, dict) and \"value\" in variable_data:\n                        var_value = variable_data[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    elif variable_data is not None and str(variable_data).strip() != \"\":\n                        return True, str(variable_data)\n                \n                return False, None\n\n            # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n            if (\n                check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n            ):\n                # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n                variable_values = {}\n                _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n                text = \"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º—è: {–∏–º—è}. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:\"\n                if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n                    text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n                await bot.send_message(user_id, text)\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"profile_command\"\n                }\n            else:\n                # Fallback —Å–æ–æ–±—â–µ–Ω–∏–µ\n                nav_text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"final-message-node\"\n                }\n                await bot.send_message(user_id, nav_text)\n        elif next_node_id == \"final-message-node\":\n            nav_text = \"\"\"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üéâ\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /profile —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\"\"\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"profile_command\":\n            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É /profile\n            from types import SimpleNamespace\n            fake_message = SimpleNamespace()\n            fake_message.from_user = callback_query.from_user\n            fake_message.chat = callback_query.message.chat\n            fake_message.date = callback_query.message.date\n            fake_message.answer = callback_query.message.answer\n            await profile_handler(fake_message)\n        else:\n            logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n    \n    return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n    text = None\n    \n    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_data_dict = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_data_dict = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_data_dict = user_record[\"user_data\"]\n            else:\n                user_data_dict = {}\n        else:\n            user_data_dict = user_record\n    else:\n        user_data_dict = {}\n    \n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–º–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    conditional_parse_mode = None\n    conditional_keyboard = None\n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    def check_user_variable(var_name, user_data_dict):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n        if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n            try:\n                import json\n                parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                if var_name in parsed_data:\n                    raw_value = parsed_data[var_name]\n                    if isinstance(raw_value, dict) and \"value\" in raw_value:\n                        var_value = raw_value[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    else:\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if raw_value is not None and str(raw_value).strip() != \"\":\n                            return True, str(raw_value)\n            except (json.JSONDecodeError, TypeError):\n                pass\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n        if var_name in user_data_dict:\n            variable_data = user_data_dict.get(var_name)\n            if isinstance(variable_data, dict) and \"value\" in variable_data:\n                var_value = variable_data[\"value\"]\n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                if var_value is not None and str(var_value).strip() != \"\":\n                    return True, str(var_value)\n            elif variable_data is not None and str(variable_data).strip() != \"\":\n                return True, str(variable_data)\n        \n        return False, None\n    \n    # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n    if (\n        check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n    ):\n        # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n        variable_values = {}\n        _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n        text = \"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º—è: {–∏–º—è}. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:\"\n        conditional_parse_mode = None\n        if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n            text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        conditional_message_config = {\n            \"condition_id\": \"name_already_exists\",\n            \"wait_for_input\": True,\n            \"input_variable\": \"–∏–º—è\",\n            \"next_node_id\": \"profile_command\",\n            \"source_type\": \"conditional_message\"\n        }\n        \n        # –ï—Å–ª–∏ –µ—Å—Ç—å —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –≤–≤–æ–¥–∞\n        if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\n            user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\n            logging.info(f\"–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –æ–∂–∏–¥–∞–Ω–∏–µ —É—Å–ª–æ–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞: {conditional_message_config}\")\n        logging.info(f\"–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {variable_values} (AND)\")\n    else:\n        text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n        text = replace_variables_in_text(text, user_data_dict)\n        logging.info(\"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∑–ª–∞\")\n    \n    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞\n    if callback_query.from_user.id not in user_data:\n        user_data[callback_query.from_user.id] = {}\n    \n    user_data[callback_query.from_user.id][\"waiting_for_input\"] = \"XDSrTrNly5EtDtr85nN4P\"\n    user_data[callback_query.from_user.id][\"input_type\"] = \"text\"\n    user_data[callback_query.from_user.id][\"input_variable\"] = \"–∏–º—è\"\n    user_data[callback_query.from_user.id][\"save_to_database\"] = True\n    user_data[callback_query.from_user.id][\"input_target_node_id\"] = \"final-message-node\"\n    \n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text)\n    \n\n@dp.callback_query(lambda c: c.data == \"--2N9FeeykMHVVlsVnSQW\" or c.data.startswith(\"--2N9FeeykMHVVlsVnSQW_btn_\"))\nasync def handle_callback___2N9FeeykMHVVlsVnSQW(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    user_id = callback_query.from_user.id\n    \n    # –ò—â–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ callback_data\n    button_display_text = \"–ö–Ω–æ–ø–∫–∞ --2N9FeeykMHVVlsVnSQW\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    \n    response_data = button_display_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    user_data[user_id][\"button_click\"] = button_display_text\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π\n    await update_user_data_in_db(user_id, \"button_click\", button_display_text)\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è button_click —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(button_display_text) + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ\n    await callback_query.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...\")\n    \n    # –ü–ï–†–ï–ê–î–†–ï–°–ê–¶–ò–Ø: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n    next_node_id = \"--2N9FeeykMHVVlsVnSQW\"\n    try:\n        logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–Ω–æ–ø–∫–∏: {next_node_id}\")\n        if next_node_id == \"start_node\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start_node\")\n        elif next_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É --2N9FeeykMHVVlsVnSQW\")\n        elif next_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É nr3wIiTfBYYmpkkXMNH7n\")\n        elif next_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n            nav_text = \"–ü–µ—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ –Ω–∞–ø–∏—à–∏ /start –∏–ª–∏ /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n            await callback_query.message.delete()\n            # –£–∑–µ–ª —Å —É—Å–ª–æ–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è\n            user_id = callback_query.from_user.id\n            user_data_dict = await get_user_from_db(user_id) or {}\n            user_data_dict.update(user_data.get(user_id, {}))\n\n            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            def check_user_variable(var_name, user_data_dict):\n                \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n                # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n                if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n                    try:\n                        import json\n                        parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                        if var_name in parsed_data:\n                            raw_value = parsed_data[var_name]\n                            if isinstance(raw_value, dict) and \"value\" in raw_value:\n                                var_value = raw_value[\"value\"]\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if var_value is not None and str(var_value).strip() != \"\":\n                                    return True, str(var_value)\n                            else:\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if raw_value is not None and str(raw_value).strip() != \"\":\n                                    return True, str(raw_value)\n                    except (json.JSONDecodeError, TypeError):\n                        pass\n                \n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n                if var_name in user_data_dict:\n                    variable_data = user_data_dict.get(var_name)\n                    if isinstance(variable_data, dict) and \"value\" in variable_data:\n                        var_value = variable_data[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    elif variable_data is not None and str(variable_data).strip() != \"\":\n                        return True, str(variable_data)\n                \n                return False, None\n\n            # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n            if (\n                check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n            ):\n                # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n                variable_values = {}\n                _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n                text = \"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º—è: {–∏–º—è}. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:\"\n                if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n                    text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n                await bot.send_message(user_id, text)\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"profile_command\"\n                }\n            else:\n                # Fallback —Å–æ–æ–±—â–µ–Ω–∏–µ\n                nav_text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"final-message-node\"\n                }\n                await bot.send_message(user_id, nav_text)\n        elif next_node_id == \"final-message-node\":\n            nav_text = \"\"\"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üéâ\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /profile —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\"\"\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"profile_command\":\n            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É /profile\n            from types import SimpleNamespace\n            fake_message = SimpleNamespace()\n            fake_message.from_user = callback_query.from_user\n            fake_message.chat = callback_query.message.chat\n            fake_message.date = callback_query.message.date\n            fake_message.answer = callback_query.message.answer\n            await profile_handler(fake_message)\n        else:\n            logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n    \n    return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏\n    \n    text = \"–¢—ã —Ö–æ—á–µ—à—å—Å—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–≤–æ—é –∂–∏–∑–Ω—å —Å —á–∞—Ç–æ–º?\"\n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞\n    if callback_query.from_user.id not in user_data:\n        user_data[callback_query.from_user.id] = {}\n    \n    user_data[callback_query.from_user.id][\"waiting_for_input\"] = \"--2N9FeeykMHVVlsVnSQW\"\n    user_data[callback_query.from_user.id][\"input_type\"] = \"text\"\n    user_data[callback_query.from_user.id][\"input_variable\"] = \"–∂–µ–ª–∞–Ω–∏–µ\"\n    user_data[callback_query.from_user.id][\"save_to_database\"] = True\n    user_data[callback_query.from_user.id][\"input_target_node_id\"] = \"\"\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞\n    if \"keyboard\" not in locals() or keyboard is None:\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ (+ —Å–±–æ—Ä –≤–≤–æ–¥–∞ –≤–∫–ª—é—á–µ–Ω)\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"–î–∞\", callback_data=\"btn-1\"))\n        builder.add(InlineKeyboardButton(text=\"–ù–µ—Ç\", callback_data=\"btn-2\"))\n        keyboard = builder.as_markup()\n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text, reply_markup=keyboard)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text, reply_markup=keyboard)\n    \n\n@dp.callback_query(lambda c: c.data == \"final-message-node\" or c.data.startswith(\"final-message-node_btn_\"))\nasync def handle_callback_final_message_node(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    user_id = callback_query.from_user.id\n    \n    # –ò—â–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ callback_data\n    button_display_text = \"–ö–Ω–æ–ø–∫–∞ final-message-node\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    \n    response_data = button_display_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    user_data[user_id][\"button_click\"] = button_display_text\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π\n    await update_user_data_in_db(user_id, \"button_click\", button_display_text)\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è button_click —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(button_display_text) + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ\n    await callback_query.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...\")\n    \n    # –ü–ï–†–ï–ê–î–†–ï–°–ê–¶–ò–Ø: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n    next_node_id = \"final-message-node\"\n    try:\n        logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–Ω–æ–ø–∫–∏: {next_node_id}\")\n        if next_node_id == \"start_node\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start_node\")\n        elif next_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É --2N9FeeykMHVVlsVnSQW\")\n        elif next_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É nr3wIiTfBYYmpkkXMNH7n\")\n        elif next_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n            nav_text = \"–ü–µ—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ –Ω–∞–ø–∏—à–∏ /start –∏–ª–∏ /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n            await callback_query.message.delete()\n            # –£–∑–µ–ª —Å —É—Å–ª–æ–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è\n            user_id = callback_query.from_user.id\n            user_data_dict = await get_user_from_db(user_id) or {}\n            user_data_dict.update(user_data.get(user_id, {}))\n\n            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            def check_user_variable(var_name, user_data_dict):\n                \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n                # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª–µ user_data (–∏–∑ –ë–î)\n                if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\n                    try:\n                        import json\n                        parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\n                        if var_name in parsed_data:\n                            raw_value = parsed_data[var_name]\n                            if isinstance(raw_value, dict) and \"value\" in raw_value:\n                                var_value = raw_value[\"value\"]\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if var_value is not None and str(var_value).strip() != \"\":\n                                    return True, str(var_value)\n                            else:\n                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                                if raw_value is not None and str(raw_value).strip() != \"\":\n                                    return True, str(raw_value)\n                    except (json.JSONDecodeError, TypeError):\n                        pass\n                \n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ user_data)\n                if var_name in user_data_dict:\n                    variable_data = user_data_dict.get(var_name)\n                    if isinstance(variable_data, dict) and \"value\" in variable_data:\n                        var_value = variable_data[\"value\"]\n                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–µ\n                        if var_value is not None and str(var_value).strip() != \"\":\n                            return True, str(var_value)\n                    elif variable_data is not None and str(variable_data).strip() != \"\":\n                        return True, str(variable_data)\n                \n                return False, None\n\n            # –£—Å–ª–æ–≤–∏–µ 1: user_data_exists –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è\n            if (\n                check_user_variable(\"–∏–º—è\", user_data_dict)[0]\n            ):\n                # –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n                variable_values = {}\n                _, variable_values[\"–∏–º—è\"] = check_user_variable(\"–∏–º—è\", user_data_dict)\n                text = \"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º—è: {–∏–º—è}. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:\"\n                if \"{–∏–º—è}\" in text and variable_values[\"–∏–º—è\"] is not None:\n                    text = text.replace(\"{–∏–º—è}\", variable_values[\"–∏–º—è\"])\n                await bot.send_message(user_id, text)\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"profile_command\"\n                }\n            else:\n                # Fallback —Å–æ–æ–±—â–µ–Ω–∏–µ\n                nav_text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"final-message-node\"\n                }\n                await bot.send_message(user_id, nav_text)\n        elif next_node_id == \"final-message-node\":\n            nav_text = \"\"\"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üéâ\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /profile —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\"\"\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"profile_command\":\n            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É /profile\n            from types import SimpleNamespace\n            fake_message = SimpleNamespace()\n            fake_message.from_user = callback_query.from_user\n            fake_message.chat = callback_query.message.chat\n            fake_message.date = callback_query.message.date\n            fake_message.answer = callback_query.message.answer\n            await profile_handler(fake_message)\n        else:\n            logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n    \n    return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏\n    \n    text = \"\"\"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üéâ\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /profile —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\"\"\"\n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    builder = InlineKeyboardBuilder()\n    builder.add(InlineKeyboardButton(text=\"üë§ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å\", callback_data=\"cmd_profile\"))\n    builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"cmd_start\"))\n    keyboard = builder.as_markup()\n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text, reply_markup=keyboard)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text, reply_markup=keyboard)\n\n\n# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞\n@dp.message(F.text)\nasync def handle_user_input(message: types.Message):\n    user_id = message.from_user.id\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –≤–≤–æ–¥ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n    if user_id in user_data and \"waiting_for_conditional_input\" in user_data[user_id]:\n        config = user_data[user_id][\"waiting_for_conditional_input\"]\n        user_text = message.text\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        condition_id = config.get(\"condition_id\", \"unknown\")\n        next_node_id = config.get(\"next_node_id\")\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        timestamp = get_moscow_time()\n        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é\n        input_variable = config.get(\"input_variable\", \"\")\n        if input_variable:\n            variable_name = input_variable\n        else:\n            variable_name = f\"conditional_response_{condition_id}\"\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n        user_data[user_id][variable_name] = user_text\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        saved_to_db = await update_user_data_in_db(user_id, variable_name, user_text)\n        if saved_to_db:\n            logging.info(f\"‚úÖ –£—Å–ª–æ–≤–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î: {variable_name} = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        else:\n            logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n        \n        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ\n        await message.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...\")\n        \n        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è\n        del user_data[user_id][\"waiting_for_conditional_input\"]\n        \n        logging.info(f\"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {variable_name} = {user_text}\")\n        \n        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω\n        if next_node_id:\n            try:\n                logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {next_node_id}\")\n                \n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π\n                if next_node_id == \"profile_command\":\n                    logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ–º–∞–Ω–¥–µ /profile\")\n                    await profile_handler(message)\n                else:\n                    # –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π callback –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫ –æ–±—ã—á–Ω–æ–º—É —É–∑–ª—É\n                    import types as aiogram_types\n                    fake_callback = aiogram_types.SimpleNamespace(\n                        id=\"conditional_nav\",\n                        from_user=message.from_user,\n                        chat_instance=\"\",\n                        data=next_node_id,\n                        message=message,\n                        answer=lambda text=\"\", show_alert=False: asyncio.sleep(0)\n                    )\n                    \n                    if next_node_id == \"start_node\":\n                        await handle_callback_start_node(fake_callback)\n                    elif next_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n                        await handle_callback___2N9FeeykMHVVlsVnSQW(fake_callback)\n                    elif next_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n                        await handle_callback_nr3wIiTfBYYmpkkXMNH7n(fake_callback)\n                    elif next_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n                        await handle_callback_1BHSLWPMao9qQvSAzuzRl(fake_callback)\n                    elif next_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n                        await handle_callback_XDSrTrNly5EtDtr85nN4P(fake_callback)\n                    elif next_node_id == \"final-message-node\":\n                        await handle_callback_final_message_node(fake_callback)\n                    elif next_node_id == \"profile_command\":\n                        await handle_callback_profile_command(fake_callback)\n                    else:\n                        logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n            except Exception as e:\n                logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n        \n        return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –∫–Ω–æ–ø–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    if user_id in user_data and \"button_response_config\" in user_data[user_id]:\n        config = user_data[user_id][\"button_response_config\"]\n        user_text = message.text\n        \n        # –ò—â–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å—Ä–µ–¥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø—Ü–∏–π\n        selected_option = None\n        for option in config.get(\"options\", []):\n            if option[\"text\"] == user_text:\n                selected_option = option\n                break\n        \n        if selected_option:\n            selected_value = selected_option[\"value\"]\n            selected_text = selected_option[\"text\"]\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            variable_name = config.get(\"variable\", \"button_response\")\n            timestamp = get_moscow_time()\n            node_id = config.get(\"node_id\", \"unknown\")\n            \n            # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç\n            response_data = {\n                \"value\": selected_value,\n                \"text\": selected_text,\n                \"type\": \"button_choice\",\n                \"timestamp\": timestamp,\n                \"nodeId\": node_id,\n                \"variable\": variable_name\n            }\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][variable_name] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n            if config.get(\"save_to_database\"):\n                saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\n                if saved_to_db:\n                    logging.info(f\"‚úÖ –ö–Ω–æ–ø–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î: {variable_name} = {selected_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n                else:\n                    logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ\n            success_message = config.get(\"success_message\", \"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤—ã–±–æ—Ä!\")\n            await message.answer(f\"{success_message}\\n\\n‚úÖ –í–∞—à –≤—ã–±–æ—Ä: {selected_text}\", reply_markup=ReplyKeyboardRemove())\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n            del user_data[user_id][\"button_response_config\"]\n            \n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –∫–Ω–æ–ø–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É: {variable_name} = {selected_text}\")\n            \n            # –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ–π—Å—Ç–≤–∏—è –∫–Ω–æ–ø–∫–∏\n            option_action = selected_option.get(\"action\", \"goto\")\n            option_target = selected_option.get(\"target\", \"\")\n            option_url = selected_option.get(\"url\", \"\")\n            \n            if option_action == \"url\" and option_url:\n                # –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Å—ã–ª–∫–∏\n                url = option_url\n                keyboard = InlineKeyboardMarkup(inline_keyboard=[\n                    [InlineKeyboardButton(text=\"üîó –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É\", url=url)]\n                ])\n                await message.answer(\"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É:\", reply_markup=keyboard)\n            elif option_action == \"command\" and option_target:\n                # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã\n                command = option_target\n                # –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã\n                import types as aiogram_types\n                fake_message = aiogram_types.SimpleNamespace(\n                    from_user=message.from_user,\n                    chat=message.chat,\n                    text=command,\n                    message_id=message.message_id\n                )\n                \n                if command == \"/start\":\n                    try:\n                        await start_handler(fake_message)\n                    except Exception as e:\n                        logging.error(f\"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã /start: {e}\")\n                elif command == \"/profile\":\n                    try:\n                        await _profile_handler(fake_message)\n                    except Exception as e:\n                        logging.error(f\"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã /profile: {e}\")\n                else:\n                    logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {command}\")\n            elif option_action == \"goto\" and option_target:\n                # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É\n                target_node_id = option_target\n                try:\n                    # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞\n                    if target_node_id == \"start_node\":\n                        await handle_callback_start_node(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n                        await handle_callback___2N9FeeykMHVVlsVnSQW(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n                        await handle_callback_nr3wIiTfBYYmpkkXMNH7n(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n                        await handle_callback_1BHSLWPMao9qQvSAzuzRl(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n                        await handle_callback_XDSrTrNly5EtDtr85nN4P(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"final-message-node\":\n                        await handle_callback_final_message_node(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"profile_command\":\n                        await handle_callback_profile_command(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    else:\n                        logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ü–µ–ª–µ–≤–æ–π —É–∑–µ–ª: {target_node_id}\")\n                except Exception as e:\n                    logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —É–∑–ª—É {target_node_id}: {e}\")\n            else:\n                # Fallback –∫ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–µ next_node_id –µ—Å–ª–∏ –Ω–µ—Ç action\n                next_node_id = config.get(\"next_node_id\")\n                if next_node_id:\n                    try:\n                        # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É–∑–ª–∞\n                        if next_node_id == \"start_node\":\n                            await handle_callback_start_node(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n                            await handle_callback___2N9FeeykMHVVlsVnSQW(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n                            await handle_callback_nr3wIiTfBYYmpkkXMNH7n(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n                            await handle_callback_1BHSLWPMao9qQvSAzuzRl(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n                            await handle_callback_XDSrTrNly5EtDtr85nN4P(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"final-message-node\":\n                            await handle_callback_final_message_node(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"profile_command\":\n                            await handle_callback_profile_command(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        else:\n                            logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n                    except Exception as e:\n                        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n            return\n        else:\n            # –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã\n            available_options = [option[\"text\"] for option in config.get(\"options\", [])]\n            options_text = \"\\n\".join([f\"‚Ä¢ {opt}\" for opt in available_options])\n            await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:\\n\\n{options_text}\")\n            return\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)\n    if user_id in user_data and \"waiting_for_input\" in user_data[user_id]:\n        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥ —á–µ—Ä–µ–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É\n        waiting_config = user_data[user_id][\"waiting_for_input\"]\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ - –Ω–æ–≤—ã–π (—Å–ª–æ–≤–∞—Ä—å) –∏–ª–∏ —Å—Ç–∞—Ä—ã–π (—Å—Ç—Ä–æ–∫–∞)\n        if isinstance(waiting_config, dict):\n            # –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç - –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è\n            waiting_node_id = waiting_config.get(\"node_id\")\n            input_type = waiting_config.get(\"type\", \"text\")\n            variable_name = waiting_config.get(\"variable\", \"user_response\")\n            save_to_database = waiting_config.get(\"save_to_database\", False)\n            min_length = waiting_config.get(\"min_length\", 0)\n            max_length = waiting_config.get(\"max_length\", 0)\n            next_node_id = waiting_config.get(\"next_node_id\")\n        else:\n            # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - waiting_config —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å node_id\n            waiting_node_id = waiting_config\n            input_type = user_data[user_id].get(\"input_type\", \"text\")\n            variable_name = user_data[user_id].get(\"input_variable\", \"user_response\")\n            save_to_database = user_data[user_id].get(\"save_to_database\", False)\n            min_length = 0\n            max_length = 0\n            next_node_id = user_data[user_id].get(\"input_target_node_id\")\n        \n        user_text = message.text\n        \n        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n        if isinstance(waiting_config, dict):\n            # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã\n            if min_length > 0 and len(user_text) < min_length:\n                retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (–º–∏–Ω–∏–º—É–º {min_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n                return\n            \n            if max_length > 0 and len(user_text) > max_length:\n                retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º {max_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n                return\n            \n            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –≤–≤–æ–¥–∞\n            if input_type == \"email\":\n                import re\n                email_pattern = r\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$\"\n                if not re.match(email_pattern, user_text):\n                    retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                    await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. {retry_message}\")\n                    return\n            elif input_type == \"number\":\n                try:\n                    float(user_text)\n                except ValueError:\n                    retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                    await message.answer(f\"‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ. {retry_message}\")\n                    return\n            elif input_type == \"phone\":\n                import re\n                phone_pattern = r\"^[+]?[0-9\\s\\-\\(\\)]{10,}$\"\n                if not re.match(phone_pattern, user_text):\n                    retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                    await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. {retry_message}\")\n                    return\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n            timestamp = get_moscow_time()\n            response_data = user_text\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][variable_name] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n            if save_to_database:\n                saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\n                if saved_to_db:\n                    logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: {variable_name} = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n                else:\n                    logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ\n            success_message = waiting_config.get(\"success_message\", \"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n            await message.answer(success_message)\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n            del user_data[user_id][\"waiting_for_input\"]\n            \n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: {variable_name} = {user_text}\")\n            \n            # –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n            if next_node_id:\n                try:\n                    logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {next_node_id}\")\n                    if next_node_id == \"start_node\":\n                        logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start_node —Ç–∏–ø–∞ start\")\n                    elif next_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n                        logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É --2N9FeeykMHVVlsVnSQW —Ç–∏–ø–∞ keyboard\")\n                    elif next_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n                        logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É nr3wIiTfBYYmpkkXMNH7n —Ç–∏–ø–∞ keyboard\")\n                    elif next_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n                        text = \"–ü–µ—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ –Ω–∞–ø–∏—à–∏ /start –∏–ª–∏ /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è\"\n                        await message.answer(text)\n                    elif next_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n                        logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É XDSrTrNly5EtDtr85nN4P —Ç–∏–ø–∞ keyboard\")\n                    elif next_node_id == \"final-message-node\":\n                        text = \"\"\"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üéâ\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /profile —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\"\"\"\n                        await message.answer(text)\n                    elif next_node_id == \"profile_command\":\n                        # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É /profile\n                        from types import SimpleNamespace\n                        fake_message = SimpleNamespace()\n                        fake_message.from_user = message.from_user\n                        fake_message.chat = message.chat\n                        fake_message.date = message.date\n                        fake_message.answer = message.answer\n                        await profile_handler(fake_message)\n                    else:\n                        logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n                except Exception as e:\n                    logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n            \n            return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n        \n        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)\n        # –ù–∞—Ö–æ–¥–∏–º —É–∑–µ–ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫\n        if waiting_node_id == \"start_node\":\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            import datetime\n            timestamp = get_moscow_time()\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ª–æ–≥–∏–∫–æ–π –ø—Ä–æ—Ñ–∏–ª—è\n            response_data = user_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][\"–∏—Å—Ç–æ—á–Ω–∏–∫\"] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n            saved_to_db = await update_user_data_in_db(user_id, \"–∏—Å—Ç–æ—á–Ω–∏–∫\", response_data)\n            if saved_to_db:\n                logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: –∏—Å—Ç–æ—á–Ω–∏–∫ = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n            else:\n                logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            await message.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n            del user_data[user_id][\"waiting_for_input\"]\n            \n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: –∏—Å—Ç–æ—á–Ω–∏–∫ = {user_text}\")\n            \n            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É\n            try:\n                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π\n                text = \"–¢—ã —Ö–æ—á–µ—à—å—Å—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–≤–æ—é –∂–∏–∑–Ω—å —Å —á–∞—Ç–æ–º?\"\n                builder = InlineKeyboardBuilder()\n                builder.add(InlineKeyboardButton(text=\"–î–∞\", callback_data=\"nr3wIiTfBYYmpkkXMNH7n\"))\n                builder.add(InlineKeyboardButton(text=\"–ù–µ—Ç\", callback_data=\"1BHSLWPMao9qQvSAzuzRl\"))\n                keyboard = builder.as_markup()\n                await message.answer(text, reply_markup=keyboard)\n                logging.info(\"‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ\")\n            except Exception as e:\n                logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {e}\")\n            return\n        elif waiting_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            import datetime\n            timestamp = get_moscow_time()\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ª–æ–≥–∏–∫–æ–π –ø—Ä–æ—Ñ–∏–ª—è\n            response_data = user_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][\"–∂–µ–ª–∞–Ω–∏–µ\"] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n            saved_to_db = await update_user_data_in_db(user_id, \"–∂–µ–ª–∞–Ω–∏–µ\", response_data)\n            if saved_to_db:\n                logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: –∂–µ–ª–∞–Ω–∏–µ = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n            else:\n                logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            await message.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n            del user_data[user_id][\"waiting_for_input\"]\n            \n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: –∂–µ–ª–∞–Ω–∏–µ = {user_text}\")\n            \n            return\n        elif waiting_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            import datetime\n            timestamp = get_moscow_time()\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ª–æ–≥–∏–∫–æ–π –ø—Ä–æ—Ñ–∏–ª—è\n            response_data = user_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][\"–ø–æ–ª\"] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n            saved_to_db = await update_user_data_in_db(user_id, \"–ø–æ–ª\", response_data)\n            if saved_to_db:\n                logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: –ø–æ–ª = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n            else:\n                logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            await message.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n            del user_data[user_id][\"waiting_for_input\"]\n            \n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: –ø–æ–ª = {user_text}\")\n            \n            return\n        elif waiting_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            import datetime\n            timestamp = get_moscow_time()\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ª–æ–≥–∏–∫–æ–π –ø—Ä–æ—Ñ–∏–ª—è\n            response_data = user_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][\"–∏–º—è\"] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n            saved_to_db = await update_user_data_in_db(user_id, \"–∏–º—è\", response_data)\n            if saved_to_db:\n                logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: –∏–º—è = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n            else:\n                logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            await message.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n            del user_data[user_id][\"waiting_for_input\"]\n            \n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: –∏–º—è = {user_text}\")\n            \n            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É\n            try:\n                # –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π callback_query –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏\n                import types as aiogram_types\n                import asyncio\n                fake_callback = aiogram_types.SimpleNamespace(\n                    id=\"input_nav\",\n                    from_user=message.from_user,\n                    chat_instance=\"\",\n                    data=\"final-message-node\",\n                    message=message,\n                    answer=lambda text=\"\", show_alert=False: asyncio.sleep(0)\n                )\n                await handle_callback_final_message_node(fake_callback)\n            except Exception as e:\n                logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {e}\")\n            return\n        \n        # –ï—Å–ª–∏ —É–∑–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω\n        logging.warning(f\"–£–∑–µ–ª –¥–ª—è —Å–±–æ—Ä–∞ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: {waiting_node_id}\")\n        del user_data[user_id][\"waiting_for_input\"]\n        return\n    \n    # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫\n    if user_id in user_data and user_data[user_id].get(\"input_collection_enabled\"):\n        input_node_id = user_data[user_id].get(\"input_node_id\")\n        input_variable = user_data[user_id].get(\"input_variable\", \"button_response\")\n        user_text = message.text\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—é–±–æ–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç\n        timestamp = get_moscow_time()\n        \n        response_data = user_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n        user_data[user_id][f\"{input_variable}_additional\"] = response_data\n        \n        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        await message.answer(\"‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω!\")\n        \n        logging.info(f\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥: {input_variable}_additional = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        return\n    \n    # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n    return\n    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞\n    min_length = input_config.get(\"min_length\", 0)\n    max_length = input_config.get(\"max_length\", 0)\n    \n    if min_length > 0 and len(user_text) < min_length:\n        retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n        await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (–º–∏–Ω–∏–º—É–º {min_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n        return\n    \n    if max_length > 0 and len(user_text) > max_length:\n        retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n        await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º {max_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n        return\n    \n    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –≤–≤–æ–¥–∞\n    input_type = input_config.get(\"type\", \"text\")\n    \n    if input_type == \"email\":\n        import re\n        email_pattern = r\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$\"\n        if not re.match(email_pattern, user_text):\n            retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n            await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. {retry_message}\")\n            return\n    \n    elif input_type == \"number\":\n        try:\n            float(user_text)\n        except ValueError:\n            retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n            await message.answer(f\"‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ. {retry_message}\")\n            return\n    \n    elif input_type == \"phone\":\n        import re\n        phone_pattern = r\"^[+]?[0-9\\s\\-\\(\\)]{10,}$\"\n        if not re.match(phone_pattern, user_text):\n            retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n            await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. {retry_message}\")\n            return\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Å—Ç—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º\n    variable_name = input_config.get(\"variable\", \"user_response\")\n    timestamp = get_moscow_time()\n    node_id = input_config.get(\"node_id\", \"unknown\")\n    \n    # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞\n    response_data = user_text\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    user_data[user_id][variable_name] = response_data\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n    if input_config.get(\"save_to_database\"):\n        saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\n        if saved_to_db:\n            logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: {variable_name} = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        else:\n            logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n    \n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ\n    success_message = input_config.get(\"success_message\", \"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n    await message.answer(success_message)\n    \n    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n    del user_data[user_id][\"waiting_for_input\"]\n    \n    logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: {variable_name} = {user_text}\")\n    \n    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–≤–æ–¥–∞\n    next_node_id = input_config.get(\"next_node_id\")\n    logging.info(f\"üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é: next_node_id = {next_node_id}\")\n    if next_node_id:\n        try:\n            logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {next_node_id}\")\n            \n            # –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏\n            fake_message = type(\"FakeMessage\", (), {})()\n            fake_message.from_user = message.from_user\n            fake_message.answer = message.answer\n            fake_message.delete = lambda: None\n            \n            # –ù–∞—Ö–æ–¥–∏–º —É–∑–µ–ª –ø–æ ID –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ\n            if next_node_id == \"start_node\":\n                logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start_node —Ç–∏–ø–∞ start\")\n            elif next_node_id == \"--2N9FeeykMHVVlsVnSQW\":\n                text = \"–¢—ã —Ö–æ—á–µ—à—å—Å—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–≤–æ—é –∂–∏–∑–Ω—å —Å —á–∞—Ç–æ–º?\"\n                builder = InlineKeyboardBuilder()\n                builder.add(InlineKeyboardButton(text=\"–î–∞\", callback_data=\"nr3wIiTfBYYmpkkXMNH7n\"))\n                builder.add(InlineKeyboardButton(text=\"–ù–µ—Ç\", callback_data=\"1BHSLWPMao9qQvSAzuzRl\"))\n                keyboard = builder.as_markup()\n                await fake_message.answer(text, reply_markup=keyboard)\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ (collectUserInput)\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∂–µ–ª–∞–Ω–∏–µ\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"--2N9FeeykMHVVlsVnSQW\",\n                    \"next_node_id\": \"nr3wIiTfBYYmpkkXMNH7n\"\n                }\n            elif next_node_id == \"nr3wIiTfBYYmpkkXMNH7n\":\n                text = \"–ö–∞–∫–æ–π —Ç–≤–æ–π –ø–æ–ª?\"\n                builder = InlineKeyboardBuilder()\n                builder.add(InlineKeyboardButton(text=\"–ñ–µ–Ω—â–∏–Ω–∞\", callback_data=\"XDSrTrNly5EtDtr85nN4P\"))\n                builder.add(InlineKeyboardButton(text=\"–ú—É–∂—á–∏–Ω–∞\", callback_data=\"XDSrTrNly5EtDtr85nN4P\"))\n                keyboard = builder.as_markup()\n                await fake_message.answer(text, reply_markup=keyboard)\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ (collectUserInput)\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–ø–æ–ª\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"nr3wIiTfBYYmpkkXMNH7n\",\n                    \"next_node_id\": \"XDSrTrNly5EtDtr85nN4P\"\n                }\n            elif next_node_id == \"1BHSLWPMao9qQvSAzuzRl\":\n                text = \"–ü–µ—á–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —á—Ç–æ –Ω–∞–ø–∏—à–∏ /start –∏–ª–∏ /profile –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è\"\n                # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n                if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n                    parse_mode = conditional_parse_mode\n                else:\n                    parse_mode = None\n                builder = InlineKeyboardBuilder()\n                builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"cmd_start\"))\n                builder.add(InlineKeyboardButton(text=\"üë§ –ü—Ä–æ—Ñ–∏–ª—å\", callback_data=\"cmd_profile\"))\n                keyboard = builder.as_markup()\n                await message.answer(text, reply_markup=keyboard, parse_mode=parse_mode)\n            elif next_node_id == \"XDSrTrNly5EtDtr85nN4P\":\n                text = \"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\"\n                await fake_message.answer(text)\n                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞\n                user_data[user_id][\"waiting_for_input\"] = {\n                    \"type\": \"text\",\n                    \"variable\": \"–∏–º—è\",\n                    \"save_to_database\": True,\n                    \"node_id\": \"XDSrTrNly5EtDtr85nN4P\",\n                    \"next_node_id\": \"final-message-node\"\n                }\n            elif next_node_id == \"final-message-node\":\n                text = \"\"\"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! üéâ\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /profile —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\"\"\"\n                # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n                if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n                    parse_mode = conditional_parse_mode\n                else:\n                    parse_mode = None\n                builder = InlineKeyboardBuilder()\n                builder.add(InlineKeyboardButton(text=\"üë§ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å\", callback_data=\"cmd_profile\"))\n                builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"cmd_start\"))\n                keyboard = builder.as_markup()\n                await message.answer(text, reply_markup=keyboard, parse_mode=parse_mode)\n            elif next_node_id == \"profile_command\":\n                logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É profile_command —Ç–∏–ø–∞ command\")\n            else:\n                logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n        except Exception as e:\n            logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É—Å–ª–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫\n@dp.callback_query(lambda c: c.data.startswith(\"conditional_\"))\nasync def handle_conditional_button(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    \n    # –ü–∞—Ä—Å–∏–º callback_data: conditional_variableName_value\n    callback_parts = callback_query.data.split(\"_\", 2)\n    if len(callback_parts) >= 3:\n        variable_name = callback_parts[1]\n        variable_value = callback_parts[2]\n        \n        user_id = callback_query.from_user.id\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        await update_user_data_in_db(user_id, variable_name, variable_value)\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n        if user_id not in user_data:\n            user_data[user_id] = {}\n        user_data[user_id][variable_name] = variable_value\n        \n        logging.info(f\"–£—Å–ª–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞: {variable_name} = {variable_value} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        \n        # –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å\n        await callback_query.answer(f\"‚úÖ {variable_name} –æ–±–Ω–æ–≤–ª–µ–Ω–æ\")\n        \n        # –°–æ–∑–¥–∞–µ–º –∏–º–∏—Ç–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Ñ–∏–ª—å\n        class FakeMessage:\n            def __init__(self, callback_query):\n                self.from_user = callback_query.from_user\n                self.chat = callback_query.message.chat\n                self.date = callback_query.message.date\n                self.message_id = callback_query.message.message_id\n            \n            async def answer(self, text, parse_mode=None, reply_markup=None):\n                if reply_markup:\n                    await bot.send_message(self.chat.id, text, parse_mode=parse_mode, reply_markup=reply_markup)\n                else:\n                    await bot.send_message(self.chat.id, text, parse_mode=parse_mode)\n            \n            async def edit_text(self, text, parse_mode=None, reply_markup=None):\n                try:\n                    await bot.edit_message_text(text, self.chat.id, self.message_id, parse_mode=parse_mode, reply_markup=reply_markup)\n                except Exception:\n                    await self.answer(text, parse_mode, reply_markup)\n        \n        fake_message = FakeMessage(callback_query)\n        \n        # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Ñ–∏–ª—è\n        try:\n            await profile_handler(fake_message)\n        except Exception as e:\n            logging.error(f\"–û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ profile_handler: {e}\")\n            await callback_query.message.answer(f\"‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ {variable_name} –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞: {variable_value}\")\n    else:\n        logging.warning(f\"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —É—Å–ª–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏: {callback_query.data}\")\n        await callback_query.answer(\"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏\", show_alert=True)\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–æ–º–∞–Ω–¥\n\n@dp.callback_query(lambda c: c.data == \"cmd_start\")\nasync def handle_cmd_start(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    # –°–∏–º—É–ª–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /start\n    \n    # –°–æ–∑–¥–∞–µ–º fake message object –¥–ª—è –∫–æ–º–∞–Ω–¥—ã\n    from types import SimpleNamespace\n    fake_message = SimpleNamespace()\n    fake_message.from_user = callback_query.from_user\n    fake_message.chat = callback_query.message.chat\n    fake_message.date = callback_query.message.date\n    fake_message.answer = callback_query.message.answer\n    fake_message.edit_text = callback_query.message.edit_text\n    \n    # –í—ã–∑—ã–≤–∞–µ–º start handler\n    await start_handler(fake_message)\n    logging.info(f\"–ö–æ–º–∞–Ω–¥–∞ /start –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ callback –∫–Ω–æ–ø–∫—É (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback_query.from_user.id})\")\n\n@dp.callback_query(lambda c: c.data == \"cmd_profile\")\nasync def handle_cmd_profile(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    # –°–∏–º—É–ª–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /profile\n    \n    # –°–æ–∑–¥–∞–µ–º fake message object –¥–ª—è –∫–æ–º–∞–Ω–¥—ã\n    from types import SimpleNamespace\n    fake_message = SimpleNamespace()\n    fake_message.from_user = callback_query.from_user\n    fake_message.chat = callback_query.message.chat\n    fake_message.date = callback_query.message.date\n    fake_message.answer = callback_query.message.answer\n    fake_message.edit_text = callback_query.message.edit_text\n    \n    # –í—ã–∑—ã–≤–∞–µ–º profile handler\n    await profile_handler(fake_message)\n    logging.info(f\"–ö–æ–º–∞–Ω–¥–∞ /profile –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ callback –∫–Ω–æ–ø–∫—É (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback_query.from_user.id})\")\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Ñ–∏–ª—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π variableLabel\n@dp.message(Command(\"profile\"))\nasync def profile_handler(message: types.Message):\n    user_id = message.from_user.id\n    \n    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    if not user_vars:\n        await message.answer(\"üë§ –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\\n\\n–ü–æ—Ö–æ–∂–µ, –≤—ã –µ—â–µ –Ω–µ –ø—Ä–æ—à–ª–∏ –æ–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ /start —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.\")\n        return\n    \n    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π variableLabel\n    profile_text = \"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\\n\\n\"\n    \n    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\n    for var_name, var_data in user_vars.items():\n        if isinstance(var_data, dict) and \"value\" in var_data:\n            value = var_data[\"value\"]\n        else:\n            value = var_data\n        profile_text += f\"{var_name}: {value}\\n\"\n    \n    await message.answer(profile_text)\n    logging.info(f\"–ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}\")\n\n\n\n# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞\nasync def main():\n    global db_pool\n    try:\n        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        await init_database()\n        print(\"ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!\")\n        await dp.start_polling(bot)\n    except KeyboardInterrupt:\n        print(\"üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...\")\n    except Exception as e:\n        logging.error(f\"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}\")\n    finally:\n        # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\n        if db_pool:\n            await db_pool.close()\n            print(\"üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–æ\")\n        \n        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –±–æ—Ç–∞\n        await bot.session.close()\n        print(\"üîå –°–µ—Å—Å–∏—è –±–æ—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∞\")\n        print(\"‚úÖ –ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É\")\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n"}