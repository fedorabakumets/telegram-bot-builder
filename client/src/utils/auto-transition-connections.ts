import { Node, Connection } from '@shared/schema';

/**
 * Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑƒÐ·Ð»Ð¾Ð² Ñ autoTransitionTo
 * @param nodes - ÐœÐ°ÑÑÐ¸Ð² Ð²ÑÐµÑ… ÑƒÐ·Ð»Ð¾Ð²
 * @param existingConnections - Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
 * @returns ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ð¼Ð°ÑÑÐ¸Ð²: Ñ€ÑƒÑ‡Ð½Ñ‹Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ + Ð°Ð²Ñ‚Ð¾Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ (Ð¿ÐµÑ€ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð»Ð¸ Ð½Ð¾Ð²Ñ‹Ðµ)
 */
export function generateAutoTransitionConnections(
  nodes: Node[],
  existingConnections: Connection[]
): Connection[] {
  const manualConnections = existingConnections.filter(c => !c.isAutoGenerated);
  const existingAutoConnections = existingConnections.filter(c => c.isAutoGenerated);
  
  const autoConnections: Connection[] = [];

  console.log('ðŸ” Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¾Ð² Ð´Ð»Ñ', nodes.length, 'ÑƒÐ·Ð»Ð¾Ð²');

  for (const node of nodes) {
    // 1. ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹ (autoTransitionTo)
    if (node.data.autoTransitionTo) {
      console.log(`ðŸ“ Ð£Ð·ÐµÐ» ${node.id} Ð¸Ð¼ÐµÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ðº ${node.data.autoTransitionTo}`);
      
      const targetNode = nodes.find(n => n.id === node.data.autoTransitionTo);
      
      if (targetNode) {
        const autoConnectionId = `auto-${node.id}-${node.data.autoTransitionTo}`;
        
        const existingAuto = existingAutoConnections.find(c => c.id === autoConnectionId);
        
        if (existingAuto) {
          console.log(`â™»ï¸ ÐŸÐµÑ€ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ ${autoConnectionId}`);
          autoConnections.push(existingAuto);
        } else {
          const hasManualConnection = manualConnections.some(
            c => c.source === node.id && c.target === node.data.autoTransitionTo
          );
          
          if (!hasManualConnection) {
            console.log(`âœ¨ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ ${autoConnectionId}`);
            autoConnections.push({
              id: autoConnectionId,
              source: node.id,
              target: node.data.autoTransitionTo,
              isAutoGenerated: true,
              isInterSheet: false,
            });
          } else {
            console.log(`âš ï¸ ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ ${autoConnectionId} - ÐµÑÑ‚ÑŒ Ñ€ÑƒÑ‡Ð½Ð¾Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ`);
          }
        }
      } else {
        console.log(`âŒ Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ ÑƒÐ·ÐµÐ» ${node.data.autoTransitionTo} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½`);
      }
    }
    
    // 2. ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹ Ð¿Ð¾ÑÐ»Ðµ Ð²Ð²Ð¾Ð´Ð° (inputTargetNodeId)
    if (node.data.inputTargetNodeId) {
      console.log(`ðŸ“ Ð£Ð·ÐµÐ» ${node.id} Ð¸Ð¼ÐµÐµÑ‚ inputTargetNodeId: ${node.data.inputTargetNodeId}`);
      const targetId = node.data.inputTargetNodeId;
      const targetNode = nodes.find(n => n.id === targetId);
      
      if (targetNode) {
        const autoConnectionId = `input-${node.id}-${targetId}`;
        const existingAuto = existingAutoConnections.find(c => c.id === autoConnectionId);
        
        if (existingAuto) {
          console.log(`â™»ï¸ ÐŸÐµÑ€ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð¿Ð¾ÑÐ»Ðµ Ð²Ð²Ð¾Ð´Ð° ${autoConnectionId}`);
          autoConnections.push(existingAuto);
        } else {
          const hasManualConnection = manualConnections.some(
            c => c.source === node.id && c.target === targetId
          );
          
          if (!hasManualConnection) {
            console.log(`âœ¨ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð¿Ð¾ÑÐ»Ðµ Ð²Ð²Ð¾Ð´Ð° ${autoConnectionId}`);
            autoConnections.push({
              id: autoConnectionId,
              source: node.id,
              target: targetId,
              isAutoGenerated: true,
              isInterSheet: false,
            });
          } else {
            console.log(`âš ï¸ ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð¿Ð¾ÑÐ»Ðµ Ð²Ð²Ð¾Ð´Ð° ${autoConnectionId} - ÐµÑÑ‚ÑŒ Ñ€ÑƒÑ‡Ð½Ð¾Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ`);
          }
        }
      } else {
        console.log(`âŒ Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ ÑƒÐ·ÐµÐ» ${targetId} Ð´Ð»Ñ inputTargetNodeId Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½`);
      }
    }
    
    // 3. ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ½Ð¾Ð¿ÐºÐ¸ (buttons[].target)
    if (node.data.buttons && Array.isArray(node.data.buttons)) {
      node.data.buttons.forEach((button: any) => {
        if (button.target) {
          const targetId = button.target;
          const targetNode = nodes.find(n => n.id === targetId);
          
          if (targetNode) {
            const autoConnectionId = `button-${node.id}-${button.id}-${targetId}`;
            const existingAuto = existingAutoConnections.find(c => c.id === autoConnectionId);
            
            if (existingAuto) {
              autoConnections.push(existingAuto);
            } else {
              const hasManualConnection = manualConnections.some(
                c => c.source === node.id && c.target === targetId
              );
              
              if (!hasManualConnection) {
                autoConnections.push({
                  id: autoConnectionId,
                  source: node.id,
                  target: targetId,
                  isAutoGenerated: true,
                  isInterSheet: false,
                });
              }
            }
          }
        }
      });
    }
  }

  console.log(`ðŸ“Š Ð˜Ñ‚Ð¾Ð³Ð¾ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹: ${manualConnections.length} Ñ€ÑƒÑ‡Ð½Ñ‹Ñ… + ${autoConnections.length} Ð°Ð²Ñ‚Ð¾Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ…`);
  return [...manualConnections, ...autoConnections];
}

/**
 * Ð£Ð´Ð°Ð»ÑÐµÑ‚ Ð²ÑÐµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
 * @param connections - ÐœÐ°ÑÑÐ¸Ð² ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹
 * @returns Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ€ÑƒÑ‡Ð½Ñ‹Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
 */
export function removeAutoGeneratedConnections(connections: Connection[]): Connection[] {
  return connections.filter(c => !c.isAutoGenerated);
}

/**
 * ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñƒ ÑƒÐ·Ð»Ð° Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð¸ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½ Ð»Ð¸ Ð¾Ð½
 * @param node - Ð£Ð·ÐµÐ» Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
 * @param allNodes - Ð’ÑÐµ ÑƒÐ·Ð»Ñ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ†ÐµÐ»ÐµÐ²Ð¾Ð³Ð¾ ÑƒÐ·Ð»Ð°
 * @returns true, ÐµÑÐ»Ð¸ Ð°Ð²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½
 */
export function hasValidAutoTransition(node: Node, allNodes: Node[]): boolean {
  if (!node.data.autoTransitionTo) {
    return false;
  }
  
  const targetNode = allNodes.find(n => n.id === node.data.autoTransitionTo);
  return !!targetNode;
}
