import { Node, Connection } from '@shared/schema';

// –ö–µ—à –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
let lastGenerationTime = 0;
let lastGenerationHash = '';

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è —É–∑–ª–æ–≤ —Å autoTransitionTo
 * @param nodes - –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö —É–∑–ª–æ–≤
 * @param existingConnections - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
 * @returns –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤: —Ä—É—á–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è + –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–ª–∏ –Ω–æ–≤—ã–µ)
 */
export function generateAutoTransitionConnections(
  nodes: Node[],
  existingConnections: Connection[]
): Connection[] {
  // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —É–∑–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏
  const validNodes = nodes.filter(node => node && node.id && node.data);

  // –°–æ–∑–¥–∞–µ–º —Ö–µ—à –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const currentHash = JSON.stringify(validNodes.map(n => ({ id: n.id, type: n.type, inputTargetNodeId: n.data.inputTargetNodeId, autoTransitionTo: n.data.autoTransitionTo })));
  const now = Date.now();

  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã–∑–æ–≤, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 100–º—Å
  if (currentHash === lastGenerationHash && now - lastGenerationTime < 100) {
    return existingConnections;
  }

  lastGenerationHash = currentHash;
  lastGenerationTime = now;

  console.log('üîç –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –¥–ª—è', validNodes.length, '—É–∑–ª–æ–≤');

  const manualConnections = existingConnections.filter(c => !c.isAutoGenerated);
  const existingAutoConnections = existingConnections.filter(c => c.isAutoGenerated);

  const autoConnections: Connection[] = [];

  // –°–æ–∑–¥–∞–µ–º Set —Å ID –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
  const nodesWithManualConnections = new Set(
    manualConnections.map(c => c.source)
  );

  // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —É–∑–ª–∞–º
  for (const node of validNodes) {
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∑–ª—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö —É–∂–µ –µ—Å—Ç—å —Ä—É—á–Ω—ã–µ –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    if (nodesWithManualConnections.has(node.id)) {
      continue;
    }

    // 1. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥—ã (autoTransitionTo)
    if (node.data.autoTransitionTo) {
      console.log(`üìç –£–∑–µ–ª ${node.id} –∏–º–µ–µ—Ç –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫ ${node.data.autoTransitionTo}`);

      const targetNode = validNodes.find(n => n.id === node.data.autoTransitionTo);

      if (targetNode) {
        const autoConnectionId = `auto-${node.id}-${node.data.autoTransitionTo}`;

        const existingAuto = existingAutoConnections.find(c => c.id === autoConnectionId);

        if (existingAuto) {
          console.log(`‚ôªÔ∏è –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ ${autoConnectionId}`);
          autoConnections.push(existingAuto);
        } else {
          const hasManualConnection = manualConnections.some(
            c => c.source === node.id && c.target === node.data.autoTransitionTo
          );

          if (!hasManualConnection) {
            console.log(`‚ú® –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ ${autoConnectionId}`);
            autoConnections.push({
              id: autoConnectionId,
              source: node.id,
              target: node.data.autoTransitionTo,
              isAutoGenerated: true,
              isInterSheet: false,
            });
          } else {
            console.log(`‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ ${autoConnectionId} - –µ—Å—Ç—å —Ä—É—á–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ`);
          }
        }
      } else {
        console.log(`‚ùå –¶–µ–ª–µ–≤–æ–π —É–∑–µ–ª ${node.data.autoTransitionTo} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
      }
    }

    // 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ (inputTargetNodeId)
    if (node.data.inputTargetNodeId) {
      console.log(`üìç –£–∑–µ–ª ${node.id} –∏–º–µ–µ—Ç inputTargetNodeId: ${node.data.inputTargetNodeId}`);
      const targetId = node.data.inputTargetNodeId;
      const targetNode = validNodes.find(n => n.id === targetId);

      if (targetNode) {
        const autoConnectionId = `input-${node.id}-${targetId}`;
        const existingAuto = existingAutoConnections.find(c => c.id === autoConnectionId);

        if (existingAuto) {
          console.log(`‚ôªÔ∏è –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ ${autoConnectionId}`);
          autoConnections.push(existingAuto);
        } else {
          const hasManualConnection = manualConnections.some(
            c => c.source === node.id && c.target === targetId
          );

          if (!hasManualConnection) {
            console.log(`‚ú® –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ ${autoConnectionId}`);
            autoConnections.push({
              id: autoConnectionId,
              source: node.id,
              target: targetId,
              isAutoGenerated: true,
              isInterSheet: false,
            });
          } else {
            console.log(`‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ ${autoConnectionId} - –µ—Å—Ç—å —Ä—É—á–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ`);
          }
        }
      } else {
        console.log(`‚ùå –¶–µ–ª–µ–≤–æ–π —É–∑–µ–ª ${targetId} –¥–ª—è inputTargetNodeId –Ω–µ –Ω–∞–π–¥–µ–Ω`);
      }
    }

    // 3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ (buttons[].target)
    if (node.data.buttons && Array.isArray(node.data.buttons)) {
      node.data.buttons.forEach((button: any) => {
        if (button.target) {
          const targetId = button.target;
          const targetNode = validNodes.find(n => n.id === targetId);

          if (targetNode) {
            const autoConnectionId = `button-${node.id}-${button.id}-${targetId}`;
            const existingAuto = existingAutoConnections.find(c => c.id === autoConnectionId);

            if (existingAuto) {
              autoConnections.push(existingAuto);
            } else {
              const hasManualConnection = manualConnections.some(
                c => c.source === node.id && c.target === targetId
              );

              if (!hasManualConnection) {
                autoConnections.push({
                  id: autoConnectionId,
                  source: node.id,
                  target: targetId,
                  isAutoGenerated: true,
                  isInterSheet: false,
                });
              }
            }
          }
        }
      });
    }
  }

  console.log(`üìä –ò—Ç–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${manualConnections.length} —Ä—É—á–Ω—ã—Ö + ${autoConnections.length} –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö`);
  return [...manualConnections, ...autoConnections];
}

/**
 * –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
 * @param connections - –ú–∞—Å—Å–∏–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
 * @returns –¢–æ–ª—å–∫–æ —Ä—É—á–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
 */
export function removeAutoGeneratedConnections(connections: Connection[]): Connection[] {
  return connections.filter(c => !c.isAutoGenerated);
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É —É–∑–ª–∞ –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏ –≤–∞–ª–∏–¥–µ–Ω –ª–∏ –æ–Ω
 * @param node - –£–∑–µ–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
 * @param allNodes - –í—Å–µ —É–∑–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞
 * @returns true, –µ—Å–ª–∏ –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –≤–∞–ª–∏–¥–µ–Ω
 */
export function hasValidAutoTransition(node: Node, allNodes: Node[]): boolean {
  if (!node.data.autoTransitionTo) {
    return false;
  }

  const targetNode = allNodes.find(n => n.id === node.data.autoTransitionTo);
  return !!targetNode;
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ (inputTargetNodeId)
 * @param nodes - –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö —É–∑–ª–æ–≤
 * @param existingConnections - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
 * @returns –ú–∞—Å—Å–∏–≤ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è inputTargetNodeId
 */
export function generateInputNodeConnections(
  nodes: Node[],
  existingConnections: Connection[]
): Connection[] {
  // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —É–∑–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏
  const validNodes = nodes.filter(node => node && node.id && node.data);

  const inputConnections: Connection[] = [];
  const manualConnections = existingConnections.filter(c => !c.isAutoGenerated);

  // –°–æ–∑–¥–∞–µ–º Set —Å ID –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  const nodesWithManualConnections = new Set(
    manualConnections.map(c => c.source)
  );

  for (const node of validNodes) {
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∑–ª—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö —É–∂–µ –µ—Å—Ç—å —Ä—É—á–Ω—ã–µ –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    if (nodesWithManualConnections.has(node.id)) {
      continue;
    }

    if (node.data.inputTargetNodeId) {
      const targetId = node.data.inputTargetNodeId;
      const targetNode = validNodes.find(n => n.id === targetId);

      if (targetNode) {
        const autoConnectionId = `input-${node.id}-${targetId}`;
        const existingAuto = existingConnections.find(c => c.id === autoConnectionId);

        if (existingAuto) {
          inputConnections.push(existingAuto);
        } else {
          const hasManualConnection = manualConnections.some(
            c => c.source === node.id && c.target === targetId
          );

          if (!hasManualConnection) {
            inputConnections.push({
              id: autoConnectionId,
              source: node.id,
              target: targetId,
              isAutoGenerated: true,
              isInterSheet: false,
            });
          }
        }
      }
    }
  }
  return inputConnections;
}