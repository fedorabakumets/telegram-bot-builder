# Папка `client/src/lib/database`

Папка `client/src/lib/database` является важной частью архитектуры генератора Telegram-ботов и отвечает за генерацию Python-кода, связанного с работой с базой данных.

## Назначение

Эта папка содержит модули, которые генерируют Python-код для:
- Инициализации подключения к базе данных
- Создания таблиц базы данных
- Сохранения, обновления и получения данных пользователей
- Работы с пользовательскими переменными
- Логирования сообщений
- Замены переменных в тексте

## Архитектурная роль

В контексте всего проекта папка `database` выполняет следующие функции:

1. **Генерация кода базы данных** - основная функция `generateDatabaseCode` объединяет все остальные модули и создает полный Python-код для работы с базой данных

2. **Интеграция с генератором ботов** - модули из этой папки импортируются и используются в главном генераторе (`bot-generator.ts`) и других компонентах системы

3. **Поддержка пользовательских переменных** - предоставляет функции для инициализации и управления пользовательскими переменными, которые используются в сообщениях бота

4. **Обработка данных пользователей** - обеспечивает функции для сохранения, получения и обновления данных пользователей в базе данных

## Основные компоненты

- `generateDatabaseCode.ts` - основной модуль, который объединяет все остальные
- `generateUniversalVariableReplacement.ts` - генерирует код для замены переменных в тексте
- `init_user_variables.ts` - инициализирует пользовательские переменные из Telegram API
- `get_user_from_db.ts` и `get_user_data_from_db.ts` - функции получения данных пользователей
- `save_user_to_db.ts`, `update_user_data_in_db.ts` - функции сохранения и обновления данных
- `log_message.ts` - функция логирования сообщений в базу данных

## Интеграция с другими частями проекта

Модули из папки `database` активно используются в:
- Генераторе ботов (`bot-generator.ts`)
- Обработчиках сообщений и команд
- Системе навигации между узлами
- Обработчиках условных сообщений
- Системе ввода пользовательских данных

## Структура и организация

Все модули следуют единому шаблону:
- Имеют JSDoc комментарии с описанием
- Используют автоматическое добавление комментариев
- Следуют единообразной структуре генерации кода

Таким образом, папка `client/src/lib/database` является центральным компонентом системы генерации кода для работы с базой данных в проекте Telegram-бота, обеспечивая согласованную и надежную инфраструктуру для хранения и обработки данных пользователей.

## Файлы

### `AliasNodes.ts`
Генерирует Python-код для алиасов функций, используемых в callback обработчиках. Создает алиасы для команд, начинающихся с `/`, и позволяет использовать их в обработчиках.

### `generateDatabaseCode.ts`
Основной модуль, который генерирует код, связанный с базой данных. Он объединяет все остальные модули и создает полный Python-код для работы с базой данных, включая инициализацию, сохранение, обновление и получение данных пользователей, а также вспомогательные функции для работы с переменными и логирования.

### `generateUniversalVariableReplacement.1.ts`
Функция для замены переменных в тексте на их значения. Поддерживает форматы `{{variable}}` и `{variable}`. Если переменная не найдена, возвращает оригинальное совпадение.

### `generateUniversalVariableReplacement.ts`
Генерирует Python-код для универсальной замены переменных в тексте. Использует функцию из `replace_variables_in_text.ts` для замены переменных в тексте.

### `generateVariableReplacement.ts`
Генерирует строку замены для переменной. Просто преобразует значение переменной в строку.

### `get_moscow_time.ts`
Генерирует Python-код для функции получения текущего времени в московском часовом поясе. Возвращает время в формате ISO 8601.

### `get_user_data_from_db.ts`
Генерирует Python-код для функции получения конкретного значения из поля `user_data` пользователя. Использует оператор `->>` для получения значения поля JSONB как текста.

### `get_user_from_db.ts`
Генерирует Python-код для функции получения данных пользователя из базы данных. Возвращает словарь с данными пользователя, включая `user_data`, если он существует.

### `init_database.ts`
Генерирует Python-код для инициализации подключения к базе данных и создания таблиц, если они не существуют. Создает таблицы `bot_users` и `bot_messages`.

### `init_user_variables.ts`
Генерирует Python-код для функции инициализации пользовательских переменных. Инициализирует базовые переменные пользователя из Telegram API, такие как `user_name`, `first_name`, `last_name`, и `username`.

### `log_message.ts`
Генерирует Python-код для функции логирования сообщений в базу данных. Логирует сообщения в таблицу `bot_messages`.

### `replace_variables_in_text.ts`
Генерирует Python-код для функции замены переменных в тексте. Заменяет переменные формата `{variable_name}` в тексте на их значения из словаря переменных пользователя.

### `save_user_data_to_db.ts`
Генерирует Python-код для функции сохранения пользовательских данных в базу данных. Это алиас для `update_user_data_in_db` для обратной совместимости.

### `save_user_to_db.ts`
Генерирует Python-код для функции сохранения пользователя в базу данных. Сохраняет пользователя в таблицу `bot_users`, обновляя его данные, если пользователь уже существует.

### `update_user_data_in_db.ts`
Генерирует Python-код для функции обновления пользовательских данных в базе данных. Обновляет поле `user_data` пользователя, добавляя или изменяя значения в JSONB поле.

### `update_user_variable_in_db.ts`
Генерирует Python-код для функции обновления переменной пользователя в базе данных. Сохраняет переменную пользователя в поле `user_data` в формате JSONB.