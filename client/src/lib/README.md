# Bot Generator Library

Эта библиотека содержит утилиты для генерации Telegram ботов.

## Архитектура

### Основные файлы:

- **`bot-generator.ts`** - Основной генератор кода ботов
- **`commands.ts`** - Генерация команд для BotFather
- **`index.ts`** - Главный экспорт всех модулей
- **`queryClient.ts`** - Управление клиентом запросов
- **`generateButtonResponseHandlers.ts`** - Генерация обработчиков для кнопочных ответов
- **`generateMediaFileFunctions.ts`** - Генерация функций для работы с медиафайлами
- **`message-logging.ts`** - Логирование сообщений
- **`extractNodeData.ts`** - Извлечение данных узлов
- **`collectConditionalMessageButtons.ts`** - Сбор условных кнопок сообщений
- **`filterInlineNodes.ts`** - Фильтрация инлайн-узлов
- **`addAutoTransitionNodes.ts`** - Добавление узлов с автопереходами
- **`generate-node-handlers.ts`** - Генерация обработчиков узлов
- **`generate-synonym-handlers.ts`** - Генерация обработчиков синонимов
- **`generateUniversalVariableReplacement.ts`** - Генерация универсальной замены переменных
- **`bot-commands-setup.ts`** - Настройка команд бота

### Структура модулей

Библиотека разделена на модули по функциональному назначению:

#### add
Утилиты для добавления элементов в бота
- Добавление узлов с автопереходами
- Добавление целевых узлов для ввода

#### analyzers
Анализаторы для проверки и валидации бота
- Проверка структуры узлов
- Анализ логики переходов
- Валидация конфигурации

#### collect
Утилиты для сбора информации из различных источников
- Сбор условных кнопок сообщений
- Сбор целевых узлов для ввода

#### CommandHandler
Обработка команд бота
- `start` команды
- Пользовательские команды
- Синонимы команд

#### Conditional
Условная логика сообщений
- Условные переходы
- Логические выражения
- Ветвления

#### format
Форматирование и обработка текста
- Форматирование для Python
- Экранирование символов
- Подсчет оптимальных колонок клавиатуры

#### formatters
Форматтеры для различных типов данных
- Форматирование текста
- Обработка специальных символов
- Преобразование данных

#### generate
Утилиты для генерации различных частей кода бота
- Генерация кода базы данных
- Генерация навигации между узлами
- Генерация кода с UTF-8 кодировкой
- Генерация безопасного кода для редактирования/отправки
- Генерация базовой настройки бота
- Генерация конфигурации групп
- Генерация кода логирования сообщений
- Генерация вспомогательных функций

#### has
Проверка возможностей бота
- Наличие медиаузлов
- Наличие условных кнопок
- Наличие ввода данных
- Наличие автопереходов

#### helpers
Вспомогательные утилиты
- Вспомогательные функции общего назначения
- Утилиты для работы с данными
- Вспомогательные классы

#### Keyboard
Генерация клавиатур
- Инлайн клавиатуры
- Реплай клавиатуры
- Динамические кнопки

#### map-utils
Утилиты для работы с картами кода
- Генерация карт кода
- Обработка диапазонов кода
- Сопоставление узлов и кода

#### MediaHandler
Обработка медиафайлов
- Стикеры
- Голосовые сообщения
- Анимации
- Локации
- Контакты

#### MessageHandler
Обработка сообщений
- Закрепление/открепление сообщений
- Удаление сообщений
- Редактирование сообщений

#### process
Утилиты для обработки различных элементов бота
- Обработка целей соединений
- Обработка узлов инлайн-кнопок

#### scaffolding
Генерация файлов проекта
- requirements.txt
- Dockerfile
- README.md
- config.yaml

#### storage
Утилиты хранения
- Локальное хранилище
- Работа с кэшем
- Управление сессиями

#### Synonyms
Обработка синонимов
- Синонимы команд
- Синонимы сообщений
- Генерация обработчиков синонимов

#### types
Типы данных
- Типы узлов бота

#### UserHandler
Управление пользователями
- Блокировка/разблокировка
- Выгон пользователей
- Повышение до администратора
- Управление правами

#### utils
Общие утилиты
- Работа с пользовательскими переменными
- Форматирование данных
- Вспомогательные функции

#### validate
Валидация данных
- Проверка узлов
- Валидация соединений
- Проверка конфигурации

#### variable
Работа с переменными
- Сбор медиапеременных
- Замена переменных в тексте
- Универсальная замена переменных

## Пользовательские переменные

### Системные переменные

Боты автоматически получают доступ к следующим системным переменным:

| Переменная | Описание | Пример | Источник |
|------------|----------|--------|----------|
| `{user_name}` | Имя для отображения (приоритет: first_name > username > "Пользователь") | "Алексей" | Telegram API |
| `{first_name}` | Имя из профиля Telegram | "Алексей" | Telegram API |
| `{last_name}` | Фамилия из профиля Telegram | "Иванов" | Telegram API |
| `{username}` | Никнейм без @ | "alex123" | Telegram API |
| `{user_id}` | Уникальный ID пользователя в Telegram | "123456789" | Telegram API |

### Использование переменных

Переменные можно использовать в любом тексте сообщения или кнопки:

```
Привет, {user_name}!
Добро пожаловать, {first_name} {last_name}
```

### Функции для работы с переменными

#### `generateInitUserVariablesFunction(indentLevel?: string)`

Генерирует Python код функции `init_user_variables()`, которая:
- Извлекает данные пользователя из Telegram API
- Инициализирует системные переменные
- Сохраняет данные в `user_data`

#### `generateReplaceVariablesFunction(indentLevel?: string)`

Генерирует Python код функции `replace_variables_in_text()`, которая:
- Находит все переменные формата `{variable_name}` в тексте
- Заменяет их на соответствующие значения
- Обрабатывает случаи отсутствующих переменных

#### `generateUniversalVariableReplacement(indentLevel: string)`

Генерирует полный код для:
- Инициализации переменных пользователя
- Получения данных из базы данных
- Замены переменных в тексте

## Примеры использования

### Добавление новой системной переменной

1. Обновите `SYSTEM_VARIABLES` в `utils/user-utils.ts`:

```typescript
export const SYSTEM_VARIABLES = {
  // ... существующие переменные
  user_id: {
    description: 'Уникальный ID пользователя в Telegram',
    example: '123456789',
    source: 'Telegram API'
  }
} as const;
```

2. Обновите `generateInitUserVariablesFunction()` для инициализации новой переменной:

```typescript
code += `${indentLevel}    user_data[user_id]["user_id"] = user_id\n`;
```

### Тестирование

Запустите тесты для проверки функциональности:

```bash
npm test
```

## Совместимость

Библиотека полностью обратно совместима. Все существующие боты продолжат работать без изменений.