# Bot Generator Library

Эта библиотека содержит утилиты для генерации Telegram ботов.

## Архитектура

### Основные файлы:

- **`bot-generator.ts`** - Основной генератор кода ботов
- **`user-utils.ts`** - Утилиты для работы с пользовательскими данными и переменными
- **`commands.ts`** - Генерация команд для BotFather

## Пользовательские переменные

### Системные переменные

Боты автоматически получают доступ к следующим системным переменным:

| Переменная | Описание | Пример | Источник |
|------------|----------|--------|----------|
| `{user_name}` | Имя для отображения (приоритет: first_name > username > "Пользователь") | "Алексей" | Telegram API |
| `{first_name}` | Имя из профиля Telegram | "Алексей" | Telegram API |
| `{last_name}` | Фамилия из профиля Telegram | "Иванов" | Telegram API |
| `{username}` | Никнейм без @ | "alex123" | Telegram API |

### Использование переменных

Переменные можно использовать в любом тексте сообщения или кнопки:

```
Привет, {user_name}!
Добро пожаловать, {first_name} {last_name}
```

### Функции для работы с переменными

#### `generateInitUserVariablesFunction(indentLevel?: string)`

Генерирует Python код функции `init_user_variables()`, которая:
- Извлекает данные пользователя из Telegram API
- Инициализирует системные переменные
- Сохраняет данные в `user_data`

#### `generateReplaceVariablesFunction(indentLevel?: string)`

Генерирует Python код функции `replace_variables_in_text()`, которая:
- Находит все переменные формата `{variable_name}` в тексте
- Заменяет их на соответствующие значения
- Обрабатывает случаи отсутствующих переменных

#### `generateUniversalVariableReplacement(indentLevel: string)`

Генерирует полный код для:
- Инициализации переменных пользователя
- Получения данных из базы данных
- Замены переменных в тексте

## Рефакторинг

### Что было изменено:

1. **Вынесены утилиты** - Функции работы с пользователями перенесены в `user-utils.ts`
2. **Улучшена документация** - Добавлены подробные комментарии и JSDoc
3. **Добавлено логирование** - Улучшена отладка процесса замены переменных
4. **Создана константа SYSTEM_VARIABLES** - Централизованное описание всех системных переменных

### Преимущества рефакторинга:

- **Модульность** - Логика работы с пользователями выделена в отдельный модуль
- **Переиспользование** - Функции можно использовать в других частях приложения
- **Тестируемость** - Утилиты легко покрыть unit-тестами
- **Документированность** - Четкое описание всех переменных и функций
- **Расширяемость** - Легко добавлять новые системные переменные

## Примеры использования

### Добавление новой системной переменной

1. Обновите `SYSTEM_VARIABLES` в `user-utils.ts`:

```typescript
export const SYSTEM_VARIABLES = {
  // ... существующие переменные
  user_id: {
    description: 'Уникальный ID пользователя в Telegram',
    example: '123456789',
    source: 'Telegram API'
  }
} as const;
```

2. Обновите `generateInitUserVariablesFunction()` для инициализации новой переменной:

```typescript
code += `${indentLevel}    user_data[user_id]["user_id"] = user_id\n`;
```

### Тестирование

Запустите тесты для проверки функциональности:

```bash
npm test user-utils
```

## Совместимость

Рефакторинг полностью обратно совместим. Все существующие боты продолжат работать без изменений.