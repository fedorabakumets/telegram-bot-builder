/**
 * Генерирует уникальный короткий идентификатор для узла графа на основе его полного идентификатора
 *
 * Функция использует различные стратегии генерации в зависимости от типа узла:
 * - Для узлов интересов (_interests) - возвращает первые 5-6 символов префикса
 * - Для остальных узлов - использует последние 10 символов с проверкой на уникальность
 * - При конфликтах - использует последние 8 алфавитно-цифровых символов
 *
 * @param nodeId - Полный идентификатор узла (например, "node_12345" или "metro_station_67890_interests")
 * @param allNodeIds - Массив всех идентификаторов узлов в графе для проверки уникальности
 *
 * @returns Уникальный короткий идентификатор для отображения в интерфейсе
 *
 * @example
 * // Для узла интересов
 * generateUniqueShortId("user_profile_interests", []);
 * // Возвращает: "user_p"
 *
 * @example
 * // Для обычного узла без конфликтов
 * generateUniqueShortId("node_1234567890", []);
 * // Возвращает: "1234567890"
 *
 * @example
 * // Для узла с конфликтами
 * generateUniqueShortId("node_abc123!@#", ["node_def123!@#"]);
 * // Возвращает: "abc123" (только алфавитно-цифровые символы)
 */
export function generateUniqueShortId(nodeId: string, allNodeIds: string[]): string {
  // Если nodeId пустой, возвращаем значение по умолчанию
  if (!nodeId) return 'node';

  // Особая обработка для узлов интересов (например, "user_profile_interests")
  if (nodeId.endsWith('_interests')) {
    const prefix = nodeId.replace('_interests', '');
    // Возвращаем первые 5-6 символов префикса для уникальности
    return prefix.substring(0, Math.min(6, prefix.length));
  }

  // Для метро и других узлов используем старую логику
  // Берем последние 10 символов и удаляем ведущие подчеркивания
  const baseShortId = nodeId.slice(-10).replace(/^_+/, '');

  // Проверяем уникальность среди всех узлов
  const conflicts = allNodeIds.filter(id => {
    // Применяем ту же логику к другим узлам для сравнения
    const otherShortId = id.slice(-10).replace(/^_+/, '');
    // Проверяем совпадение коротких ID и что это не тот же самый узел
    return otherShortId === baseShortId && id !== nodeId;
  });

  // Если конфликтов нет, возвращаем базовый ID
  if (conflicts.length === 0) {
    return baseShortId;
  }

  // Если есть конфликты, берем более уникальную часть
  // Удаляем все не алфавитно-цифровые символы и берем последние 8 символов
  return nodeId.replace(/[^a-zA-Z0-9]/g, '').slice(-8);
}
