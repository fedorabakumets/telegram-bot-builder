import { Node } from '@shared/schema';
import { hasInlineButtons } from '../has';

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –ë–î
 * @param userDatabaseEnabled - –í–∫–ª—é—á–µ–Ω–∞ –ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
 * @param projectId - ID –ø—Ä–æ–µ–∫—Ç–∞
 * @param nodes - –£–∑–ª—ã –±–æ—Ç–∞
 * @returns –°—Ç—Ä–æ–∫–∞ —Å –∫–æ–¥–æ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –ë–î –≤–∫–ª—é—á–µ–Ω–∞, –∏–Ω–∞—á–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
 */
export function generateMessageLoggingCode(userDatabaseEnabled: boolean, projectId: number | null, nodes: Node[]): string {
  if (!userDatabaseEnabled) {
    return '';
  }

  let code = '';
  code += '# API configuration –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π\n';
  code += '# –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL —Å–µ—Ä–≤–µ—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n';
  code += 'def get_api_base_url():\n';
  code += '    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\n';
  code += '    env_url = os.getenv("API_BASE_URL", os.getenv("REPLIT_DEV_DOMAIN"))\n';
  code += '    if env_url:\n';
  code += '        # –ï—Å–ª–∏ URL –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å http/https, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å\n';
  code += '        if env_url.startswith(("http://", "https://")):\n';
  code += '            return env_url\n';
  code += '        # –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª\n';
  code += '        elif ":" in env_url:  # —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—Ä—Ç\n';
  code += '            return f"http://{env_url}"\n';
  code += '        else:  # –¥–æ–º–µ–Ω –±–µ–∑ –ø–æ—Ä—Ç–∞\n';
  code += '            return f"https://{env_url}"\n';
  code += '    \n';
  code += '    # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å URL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n';
  code += '    try:\n';
  code += '        import socket\n';
  code += '        # –ü–æ–ª—É—á–∞–µ–º IP-–∞–¥—Ä–µ—Å –º–∞—à–∏–Ω—ã\n';
  code += '        hostname = socket.gethostname()\n';
  code += '        local_ip = socket.gethostbyname(hostname)\n';
  code += '        \n';
  code += '        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä—Ç –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º 5000 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\n';
  code += '        port = os.getenv("API_PORT", "5000")\n';
  code += '        \n';
  code += '        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ IP –ª–æ–∫–∞–ª—å–Ω—ã–º\n';
  code += '        if local_ip.startswith(("127.", "192.168.", "10.", "172.")) or local_ip == "::1":\n';
  code += '            # –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö IP –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost\n';
  code += '            return f"http://localhost:{port}"\n';
  code += '        else:\n';
  code += '            # –î–ª—è –≤–Ω–µ—à–Ω–∏—Ö IP –∏—Å–ø–æ–ª—å–∑—É–µ–º IP-–∞–¥—Ä–µ—Å\n';
  code += '            return f"http://{local_ip}:{port}"\n';
  code += '    except:\n';
  code += '        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost —Å –ø–æ—Ä—Ç–æ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è\n';
  code += '        port = os.getenv("API_PORT", "5000")\n';
  code += '        return f"http://localhost:{port}"\n';
  code += '\n';
  code += 'API_BASE_URL = get_api_base_url()\n';
  code += 'logging.info(f"üì° API Base URL –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫: {API_BASE_URL}")\n';
  code += `PROJECT_ID = int(os.getenv("PROJECT_ID", "${projectId || 0}"))  # ID –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ\n\n`;

  code += '# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API\n';
  code += 'async def save_message_to_api(user_id: str, message_type: str, message_text: str = None, node_id: str = None, message_data: dict = None):\n';
  code += '    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API"""\n';
  code += '    try:\n';
  code += '        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL –¥–ª—è API\n';
  code += '        if API_BASE_URL.startswith("http"):\n';
  code += '            api_url = f"{API_BASE_URL}/api/projects/{PROJECT_ID}/messages"\n';
  code += '        else:\n';
  code += '            api_url = f"https://{API_BASE_URL}/api/projects/{PROJECT_ID}/messages"\n';
  code += '        \n';
  code += '        payload = {\n';
  code += '            "userId": str(user_id),\n';
  code += '            "messageType": message_type,\n';
  code += '            "messageText": message_text,\n';
  code += '            "nodeId": node_id,\n';
  code += '            "messageData": message_data or {}\n';
  code += '        }\n';
  code += '        \n';
  code += '        logging.debug(f"üíæ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ API: {payload}")\n';
  code += '        \n';
  code += '        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ SSL\n';
  code += '        use_ssl = not (api_url.startswith("http://") or "localhost" in api_url or "127.0.0.1" in api_url or "0.0.0.0" in api_url)\n';
  code += '        \n';
  code += '        if use_ssl:\n';
  code += '            # –î–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º SSL-–∫–æ–Ω—Ç–µ–∫—Å—Ç\n';
  code += '            connector = aiohttp.TCPConnector(ssl=True)\n';
  code += '            session_params = {"connector": connector}\n';
  code += '        else:\n';
  code += '            # –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º SSL-–∫–æ–Ω—Ç–µ–∫—Å—Ç\n';
  code += '            session_params = {}\n';
  code += '        \n';
  code += '        async with aiohttp.ClientSession(**session_params) as session:\n';
  code += '            async with session.post(api_url, json=payload, timeout=aiohttp.ClientTimeout(total=5)) as response:\n';
  code += '                if response.status == 200:\n';
  code += '                    logging.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {message_type} –æ—Ç {user_id}")\n';
  code += '                    response_data = await response.json()\n';
  code += '                    return response_data.get("data")  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å id\n';
  code += '                else:\n';
  code += '                    error_text = await response.text()\n';
  code += '                    logging.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {response.status} - {error_text}")\n';
  code += '                    logging.error(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π payload: {payload}")\n';
  code += '                    return None\n';
  code += '    except Exception as e:\n';
  code += '        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")\n';
  code += '        return None\n\n';

  code += '# Middleware –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π\n';
  code += 'async def message_logging_middleware(handler, event: types.Message, data: dict):\n';
  code += '    """Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""\n';
  code += '    try:\n';
  code += '        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n';
  code += '        user_id = str(event.from_user.id)\n';
  code += '        message_text = event.text or event.caption or "[–º–µ–¥–∏–∞]"\n';
  code += '        message_data = {"message_id": event.message_id}\n';
  code += '        \n';
  code += '        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ\n';
  code += '        photo_file_id = None\n';
  code += '        if event.photo:\n';
  code += '            # –ë–µ—Ä–µ–º —Ñ–æ—Ç–æ –Ω–∞–∏–±–æ–ª—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤ —Å–ø–∏—Å–∫–µ)\n';
  code += '            largest_photo = event.photo[-1]\n';
  code += '            photo_file_id = largest_photo.file_id\n';
  code += '            message_data["photo"] = {\n';
  code += '                "file_id": largest_photo.file_id,\n';
  code += '                "file_unique_id": largest_photo.file_unique_id,\n';
  code += '                "width": largest_photo.width,\n';
  code += '                "height": largest_photo.height,\n';
  code += '                "file_size": largest_photo.file_size if hasattr(largest_photo, "file_size") else None\n';
  code += '            }\n';
  code += '            if not message_text or message_text == "[–º–µ–¥–∏–∞]":\n';
  code += '                message_text = "[–§–æ—Ç–æ]"\n';
  code += '        \n';
  code += '        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n';
  code += '        saved_message = await save_message_to_api(\n';
  code += '            user_id=user_id,\n';
  code += '            message_type="user",\n';
  code += '            message_text=message_text,\n';
  code += '            message_data=message_data\n';
  code += '        )\n';
  code += '        \n';
  code += '        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –º–µ–¥–∏–∞\n';
  code += '        if photo_file_id and saved_message and "id" in saved_message:\n';
  code += '            try:\n';
  code += '                if API_BASE_URL.startswith("http://") or API_BASE_URL.startswith("https://"):\n';
  code += '                    media_api_url = f"{API_BASE_URL}/api/projects/{PROJECT_ID}/media/register-telegram-photo"\n';
  code += '                else:\n';
  code += '                    media_api_url = f"https://{API_BASE_URL}/api/projects/{PROJECT_ID}/media/register-telegram-photo"\n';
  code += '                \n';
  code += '                media_payload = {\n';
  code += '                    "messageId": saved_message["id"],\n';
  code += '                    "fileId": photo_file_id,\n';
  code += '                    "botToken": BOT_TOKEN,\n';
  code += '                    "mediaType": "photo"\n';
  code += '                }\n';
  code += '                \n';
  code += '                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ SSL –¥–ª—è –º–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å–æ–≤\n';
  code += '                use_ssl_media = not (media_api_url.startswith("http://") or "localhost" in media_api_url or "127.0.0.1" in media_api_url or "0.0.0.0" in media_api_url)\n';
  code += '                \n';
  code += '                if use_ssl_media:\n';
  code += '                    # –î–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º SSL-–∫–æ–Ω—Ç–µ–∫—Å—Ç\n';
  code += '                    connector = aiohttp.TCPConnector(ssl=True)\n';
  code += '                    session_params = {"connector": connector}\n';
  code += '                else:\n';
  code += '                    # –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º SSL-–∫–æ–Ω—Ç–µ–∫—Å—Ç\n';
  code += '                    session_params = {}\n';
  code += '                \n';
  code += '                async with aiohttp.ClientSession(**session_params) as session:\n';
  code += '                    async with session.post(media_api_url, json=media_payload, timeout=aiohttp.ClientTimeout(total=10)) as response:\n';
  code += '                        if response.status == 200:\n';
  code += '                            message_id = saved_message.get("id")\n';
  code += '                            logging.info(f"‚úÖ –ú–µ–¥–∏–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è {message_id}")\n';
  code += '                        else:\n';
  code += '                            error_text = await response.text()\n';
  code += '                            logging.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–∏–∞: {response.status} - {error_text}")\n';
  code += '            except Exception as media_error:\n';
  code += '                logging.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–µ–¥–∏–∞: {media_error}")\n';
  code += '    except Exception as e:\n';
  code += '        logging.error(f"–û—à–∏–±–∫–∞ –≤ middleware —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")\n';
  code += '    \n';
  code += '    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è\n';
  code += '    return await handler(event, data)\n\n';

  // –î–æ–±–∞–≤–ª—è–µ–º callback_query middleware —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –±–æ—Ç–µ –µ—Å—Ç—å inline –∫–Ω–æ–ø–∫–∏
  if (hasInlineButtons(nodes || [])) {
    code += '# Middleware –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏\n';
    code += 'async def callback_query_logging_middleware(handler, event: types.CallbackQuery, data: dict):\n';
    code += '    """Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""\n';
    code += '    try:\n';
    code += '        user_id = str(event.from_user.id)\n';
    code += '        callback_data = event.data or ""\n';
    code += '        \n';
    code += '        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è\n';
    code += '        button_text = None\n';
    code += '        if event.message and hasattr(event.message, "reply_markup"):\n';
    code += '            reply_markup = event.message.reply_markup\n';
    code += '            if hasattr(reply_markup, "inline_keyboard"):\n';
    code += '                for row in reply_markup.inline_keyboard:\n';
    code += '                    for btn in row:\n';
    code += '                        if hasattr(btn, "callback_data") and btn.callback_data == callback_data:\n';
    code += '                            button_text = btn.text\n';
    code += '                            break\n';
    code += '                    if button_text:\n';
    code += '                        break\n';
    code += '        \n';
    code += '        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏\n';
    code += '        message_text_to_save = f"[–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞: {button_text}]" if button_text else "[–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞]"\n';
    code += '        await save_message_to_api(\n';
    code += '            user_id=user_id,\n';
    code += '            message_type="user",\n';
    code += '            message_text=message_text_to_save,\n';
    code += '            message_data={\n';
    code += '                "button_clicked": True,\n';
    code += '                "button_text": button_text,\n';
    code += '                "callback_data": callback_data\n';
    code += '            }\n';
    code += '        )\n';
    code += '    except Exception as e:\n';
    code += '        logging.error(f"–û—à–∏–±–∫–∞ –≤ middleware —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫: {e}")\n';
    code += '    \n';
    code += '    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É callback query\n';
    code += '    return await handler(event, data)\n\n';
  }

  return code;
}
