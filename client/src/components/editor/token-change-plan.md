# План реализации изменения токена бота через UI

## Цель
Реализовать возможность изменения токена бота через удобный UI в компоненте `BotControl`, с валидацией через Telegram API и красивым оформлением.

## Текущее состояние
- В компоненте `BotControl` отображаются боты в виде карточек
- Токены ботов отображаются, но не редактируются через UI
- Нет возможности изменить токен без обращения к API напрямую

## Требования
1. Возможность изменения токена через двойной клик по нему
2. Валидация токена через Telegram API (getMe)
3. Отображение ошибки при невалидном токене
4. Остановка бота с предыдущим токеном при изменении
5. Красивое и интуитивное оформление интерфейса
6. Все новые файлы и изменения в существующих файлах должны сопровождаться JSDoc комментариями на русском языке, включая @fileoverview в начале каждого файла

## Технические детали

### Требования к документированию
Все новые файлы и изменения в существующих файлах должны соответствовать следующим требованиям к документации:

1. Каждый файл должен начинаться с блока @fileoverview на русском языке, описывающего назначение файла
2. Все функции и методы должны иметь JSDoc комментарии на русском языке с описанием параметров, возвращаемого значения и возможных исключений
3. Все интерфейсы и типы данных должны быть задокументированы с описанием каждого свойства
4. Компоненты React должны иметь описание их назначения, свойств и особенностей использования

Пример структуры JSDoc для нового файла:
```typescript
/**
 * @fileoverview Компонент для изменения токена бота через UI
 *
 * Этот компонент предоставляет интерфейс для:
 * - Редактирования токена бота через двойной клик
 * - Валидации токена через Telegram API
 * - Отображения ошибок валидации
 * - Обновления токена в системе
 */

/**
 * Функция для валидации токена бота через Telegram API
 * @param {string} token - Токен бота для валидации
 * @returns {Promise<boolean>} - Возвращает true, если токен действителен
 */
async function validateBotToken(token: string): Promise<boolean> {
  // реализация
}
```

Пример структуры JSDoc для компонента React:
```typescript
/**
 * Компонент для изменения токена бота
 * @component
 * @param {Object} props - Свойства компонента
 * @param {number} props.tokenId - Идентификатор токена для редактирования
 * @param {string} props.currentToken - Текущий токен
 * @param {Function} props.onTokenUpdate - Колбэк при успешном обновлении токена
 * @param {Function} props.onCancel - Колбэк при отмене редактирования
 * @returns {JSX.Element} - Возвращает JSX компонента
 */
function TokenEditField({ tokenId, currentToken, onTokenUpdate, onCancel }: TokenEditFieldProps): JSX.Element {
  // реализация
}
```

### 1. Inline-редактирование
- При двойном клике на токен в карточке бота:
  - Токен становится редактируемым полем
  - Показывается маскированный токен (например, `****...abcd`)
  
### 2. Валидация
- При вводе нового токена:
  - Выполнять проверку через Telegram API (getMe)
  - Показывать индикатор загрузки во время проверки
  - Отображать ошибку, если токен невалиден
  - Разрешить сохранение только валидного токена

### 3. Обновление токена
- Оставлять старый токен активным до подтверждения нового
- При успешной валидации нового токена:
  - Обновить токен в системе
  - Остановить бота с предыдущим токеном
  - Показать уведомление об успешном изменении

### 4. UI/UX
- Красивое оформление поля ввода
- Анимации при переходе между режимами просмотра и редактирования
- Понятные сообщения об ошибках
- Индикация процесса валидации

## Реализация

### Шаг 1: Добавить состояние для редактирования токена
```typescript
const [editingTokenId, setEditingTokenId] = useState<number | null>(null);
const [newTokenValue, setNewTokenValue] = useState('');
const [validationError, setValidationError] = useState<string | null>(null);
const [isValidating, setIsValidating] = useState(false);
```

### Шаг 2: Добавить обработчик двойного клика
```typescript
const handleTokenDoubleClick = (tokenId: number, currentToken: string) => {
  setEditingTokenId(tokenId);
  setNewTokenValue(currentToken);
  setValidationError(null);
};
```

### Шаг 3: Реализовать валидацию токена
```typescript
const validateToken = async (token: string): Promise<boolean> => {
  try {
    const response = await fetch(`https://api.telegram.org/bot${token}/getMe`);
    const data = await response.json();
    return data.ok;
  } catch (error) {
    return false;
  }
};
```

### Шаг 4: Обновить токен в системе
```typescript
const updateToken = async (tokenId: number, newToken: string) => {
  try {
    // Вызвать API для обновления токена
    await apiRequest('PUT', `/api/projects/${projectId}/tokens/${tokenId}`, {
      token: newToken
    });
    
    // Остановить бота с предыдущим токеном
    await apiRequest('POST', `/api/projects/${projectId}/bot/stop`);
    
    // Обновить состояние
    setEditingTokenId(null);
    setValidationError(null);
    
    toast({
      title: "Токен обновлен",
      description: "Токен бота успешно изменен"
    });
  } catch (error) {
    setValidationError(error.message || "Ошибка при обновлении токена");
  }
};
```

### Шаг 5: Добавить UI элементы
- Поле ввода для токена с маскировкой
- Индикатор валидации
- Сообщения об ошибках
- Обработка событий (Enter, Escape)

## Тестирование
- Проверить валидацию с правильным токеном
- Проверить валидацию с неправильным токеном
- Проверить отмену редактирования
- Проверить обновление токена
- Проверить остановку бота при изменении токена
- Проверить отображение ошибок валидации
- Проверить корректное поведение при сетевых ошибках

## Безопасность
- Убедиться, что токен не отображается полностью в UI
- Проверить права доступа к изменению токена
- Обеспечить безопасное хранение токена в системе
- Реализовать защиту от XSS и CSRF атак при работе с токенами
- Обеспечить шифрование токенов при передаче и хранении

## Ожидаемые результаты
После реализации функционала пользователи смогут:
1. Удобно изменять токены ботов через UI с помощью двойного клика
2. Получать мгновенную обратную связь о валидности токена
3. Видеть ошибки при попытке ввести неверный токен
4. Уверенно обновлять токены с гарантией остановки предыдущего экземпляра бота
5. Пользоваться безопасным и защищенным интерфейсом
6. Видеть качественную документацию кода в соответствии с принятыми стандартами

## Требования к разработке
- После каждого изменения необходимо запускать `npm run check` для проверки кода
- Все ошибки, связанные с изменениями файлов, должны быть исправлены
- Необходимо следить за тем, чтобы изменения не вызывали новых ошибок в других частях клиентской части
- После завершения цикла изменений необходимо сохранить изменения в Git с комментарием на русском языке
- Все новые файлы и большие изменения в существующих файлах (более 100-200 строк) должны быть вынесены в отдельные файлы