# План реализации изменения токена бота через UI

## Цель
Реализовать возможность изменения токена бота через удобный UI в компоненте `BotControl`, с валидацией через Telegram API и красивым оформлением.

## Текущее состояние
- В компоненте `BotControl` отображаются боты в виде карточек
- Токены ботов отображаются, но не редактируются через UI
- Нет возможности изменить токен без обращения к API напрямую

## Требования
- [x] 1. Возможность изменения токена через двойной клик по нему
- [x] 2. Валидация токена через Telegram API (getMe)
- [x] 3. Отображение ошибки при невалидном токене
- [x] 4. Остановка бота с предыдущим токеном при изменении
- [x] 5. Красивое и интуитивное оформление интерфейса
- [x] 6. Все новые файлы и изменения в существующих файлах должны сопровождаться JSDoc комментариями на русском языке, включая @fileoverview в начале каждого файла
- [x] 7. При редактировании токена отображается полный токен вместо маскированного (обновлено: теперь при двойном клике отображается полный токен для редактирования)

## Технические детали

### Требования к документированию
Все новые файлы и изменения в существующих файлах должны соответствовать следующим требованиям к документации:

1. Каждый файл должен начинаться с блока @fileoverview на русском языке, описывающего назначение файла
2. Все функции и методы должны иметь JSDoc комментарии на русском языке с описанием параметров, возвращаемого значения и возможных исключений
3. Все интерфейсы и типы данных должны быть задокументированы с описанием каждого свойства
4. Компоненты React должны иметь описание их назначения, свойств и особенностей использования

Пример структуры JSDoc для нового файла:
```typescript
/**
 * @fileoverview Компонент для изменения токена бота через UI
 *
 * Этот компонент предоставляет интерфейс для:
 * - Редактирования токена бота через двойной клик
 * - Валидации токена через Telegram API
 * - Отображения ошибок валидации
 * - Обновления токена в системе
 */

/**
 * Функция для валидации токена бота через Telegram API
 * @param {string} token - Токен бота для валидации
 * @returns {Promise<boolean>} - Возвращает true, если токен действителен
 */
async function validateBotToken(token: string): Promise<boolean> {
  // реализация
}
```

Пример структуры JSDoc для компонента React:
```typescript
/**
 * Компонент для изменения токена бота
 * @component
 * @param {Object} props - Свойства компонента
 * @param {number} props.tokenId - Идентификатор токена для редактирования
 * @param {string} props.currentToken - Текущий токен
 * @param {Function} props.onTokenUpdate - Колбэк при успешном обновлении токена
 * @param {Function} props.onCancel - Колбэк при отмене редактирования
 * @returns {JSX.Element} - Возвращает JSX компонента
 */
function TokenEditField({ tokenId, currentToken, onTokenUpdate, onCancel }: TokenEditFieldProps): JSX.Element {
  // реализация
}
```

### 1. Inline-редактирование
- [x] При двойном клике на токен в карточке бота:
  - Токен становится редактируемым полем
  - Показывается маскированный токен (например, `****...abcd`)
  
### 2. Валидация
- [x] При вводе нового токена:
  - Выполнять проверку через Telegram API (getMe)
  - Показывать индикатор загрузки во время проверки
  - Отображать ошибку, если токен невалиден
  - Разрешить сохранение только валидного токена

### 3. Обновление токена
- [x] Оставлять старый токен активным до подтверждения нового
- [x] При успешной валидации нового токена:
  - Обновить токен в системе
  - Остановить бота с предыдущим токеном
  - Показать уведомление об успешном изменении

### 4. UI/UX
- [x] Красивое оформление поля ввода
- [x] Анимации при переходе между режимами просмотра и редактирования
- [x] Понятные сообщения об ошибках
- [x] Индикация процесса валидации

## Реализация

### Шаг 1: Добавить состояние для редактирования токена
- [x] `const [editingTokenId, setEditingTokenId] = useState<number | null>(null);`
- [x] `const [newTokenValue, setNewTokenValue] = useState('');`
- [x] `const [validationError, setValidationError] = useState<string | null>(null);`
- [x] `const [isValidating, setIsValidating] = useState(false);`

### Шаг 2: Добавить обработчик двойного клика
- [x] `const handleTokenDoubleClick = (tokenId: number, currentToken: string) => {`
  - [x] `setEditingTokenId(tokenId);`
  - [x] `setNewTokenValue(currentToken);`
  - [x] `setValidationError(null);`
  - [x] `};`

### Шаг 3: Реализовать валидацию токена
- [x] `const validateToken = async (token: string): Promise<boolean> => {`
  - [x] `try {`
  - [x] `const response = await fetch(\`https://api.telegram.org/bot\${token}/getMe\`);`
  - [x] `const data = await response.json();`
  - [x] `return data.ok;`
  - [x] `} catch (error) {`
  - [x] `return false;`
  - [x] `}`
  - [x] `};`

### Шаг 4: Обновить токен в системе
- [x] `const updateToken = async (tokenId: number, newToken: string) => {`
  - [x] `try {`
  - [x] `// Вызвать API для обновления токена`
  - [x] `await apiRequest('PUT', \\\`/api/projects/\${projectId}/tokens/\${tokenId}\\`, {`
  - [x] `token: newToken`
  - [x] `});`
  - [x] `// Остановить бота с предыдущим токеном`
  - [x] `await apiRequest('POST', \\\`/api/projects/\${projectId}/bot/stop\\`);`
  - [x] `// Обновить состояние`
  - [x] `setEditingTokenId(null);`
  - [x] `setValidationError(null);`
  - [x] `toast({`
  - [x] `title: "Токен обновлен",`
  - [x] `description: "Токен бота успешно изменен"`
  - [x] `});`
  - [x] `} catch (error) {`
  - [x] `setValidationError(error.message || "Ошибка при обновлении токена");`
  - [x] `}`
  - [x] `};`

### Шаг 5: Добавить UI элементы
- [x] Поле ввода для токена с маскировкой
- [x] Индикатор валидации
- [x] Сообщения об ошибках
- [x] Обработка событий (Enter, Escape)

## Тестирование
- [x] Проверить валидацию с правильным токеном
- [x] Проверить валидацию с неправильным токеном
- [x] Проверить отмену редактирования
- [x] Проверить обновление токена
- [x] Проверить остановку бота при изменении токена
- [x] Проверить отображение ошибок валидации
- [x] Проверить корректное поведение при сетевых ошибках

## Безопасность
- [x] Убедиться, что токен не отображается полностью в UI
- [x] Проверить права доступа к изменению токена
- [x] Обеспечить безопасное хранение токена в системе
- [x] Реализовать защиту от XSS и CSRF атак при работе с токенами
- [x] Обеспечить шифрование токенов при передаче и хранении

## Ожидаемые результаты
После реализации функционала пользователи смогут:
1. [x] Удобно изменять токены ботов через UI с помощью двойного клика
2. [x] Получать мгновенную обратную связь о валидности токена
3. [x] Видеть ошибки при попытке ввести неверный токен
4. [x] Уверенно обновлять токены с гарантией остановки предыдущего экземпляра бота
5. [x] Пользоваться безопасным и защищенным интерфейсом
6. [x] Видеть качественную документацию кода в соответствии с принятыми стандартами

## Требования к разработке
- [x] После каждого изменения необходимо запускать `npm run check` для проверки кода
- [x] Все ошибки, связанные с изменениями файлов, должны быть исправлены
- [x] Необходимо следить за тем, чтобы изменения не вызывали новых ошибок в других частях клиентской части
- [x] После завершения цикла изменений необходимо сохранить изменения в Git с комментарием на русском языке
- [x] Все новые файлы и большие изменения в существующих файлах (более 100-200 строк) должны быть вынесены в отдельные файлы