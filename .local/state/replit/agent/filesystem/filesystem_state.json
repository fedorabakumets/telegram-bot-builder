{"file_contents":{"client/src/pages/templates-wrapper.tsx":{"content":"import React, { useState, useMemo } from 'react';\nimport { Link, useLocation } from 'wouter';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Badge } from '@/components/ui/badge';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Loader2, Search, Download, Eye, ArrowLeft, Star } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { format } from 'date-fns';\nimport { ru } from 'date-fns/locale';\nimport type { BotTemplate } from '@shared/schema';\n\n// Простая версия страницы шаблонов без сложной системы макетов\nexport default function TemplatesPageWrapper() {\n  const [, setLocation] = useLocation();\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedCategory, setSelectedCategory] = useState<string>('all');\n  const [currentTab, setCurrentTab] = useState('all');\n  const [sortBy, setSortBy] = useState<'popular' | 'rating' | 'recent' | 'name'>('popular');\n  const { toast } = useToast();\n\n  const { data: templates = [], isLoading } = useQuery<BotTemplate[]>({\n    queryKey: ['/api/templates'],\n  });\n\n  const { data: featuredTemplates = [], isLoading: isLoadingFeatured } = useQuery<BotTemplate[]>({\n    queryKey: ['/api/templates/featured'],\n    enabled: currentTab === 'featured',\n  });\n\n  const { data: myTemplates = [], isLoading: isLoadingMy } = useQuery<BotTemplate[]>({\n    queryKey: ['/api/templates/category/custom'],\n  });\n\n  const categories = [\n    { value: 'all', label: 'Все категории' },\n    { value: 'official', label: 'Официальные' },\n    { value: 'community', label: 'Сообщество' },\n    { value: 'business', label: 'Бизнес' },\n    { value: 'entertainment', label: 'Развлечения' },\n    { value: 'education', label: 'Образование' },\n    { value: 'utility', label: 'Утилиты' },\n    { value: 'games', label: 'Игры' }\n  ];\n\n  const filteredAndSortedTemplates = useMemo(() => {\n    let currentTemplates = templates;\n    \n    if (currentTab === 'featured') {\n      currentTemplates = featuredTemplates;\n    } else if (currentTab === 'popular') {\n      currentTemplates = templates.filter(t => (t.useCount || 0) > 5);\n    } else if (currentTab === 'my') {\n      currentTemplates = myTemplates;\n    }\n\n    if (searchTerm) {\n      currentTemplates = currentTemplates.filter(template =>\n        template.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        template.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        template.tags?.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))\n      );\n    }\n\n    if (selectedCategory !== 'all') {\n      currentTemplates = currentTemplates.filter(template => template.category === selectedCategory);\n    }\n\n    const sorted = [...currentTemplates].sort((a, b) => {\n      switch (sortBy) {\n        case 'popular':\n          return (b.useCount || 0) - (a.useCount || 0);\n        case 'rating':\n          return (b.rating || 0) - (a.rating || 0);\n        case 'recent':\n          return new Date(b.createdAt || 0).getTime() - new Date(a.createdAt || 0).getTime();\n        case 'name':\n          return a.name.localeCompare(b.name, 'ru');\n        default:\n          return 0;\n      }\n    });\n\n    return sorted;\n  }, [templates, featuredTemplates, myTemplates, currentTab, searchTerm, selectedCategory, sortBy]);\n\n  const useTemplateMutation = useMutation({\n    mutationFn: async (templateId: number) => {\n      const response = await fetch(`/api/templates/${templateId}/use`, {\n        method: 'POST',\n      });\n      if (!response.ok) throw new Error('Failed to increment use count');\n      return response.json();\n    },\n    onSuccess: () => {\n      // Инвалидируем кеш проектов, чтобы данные обновились на странице \"Проекты\"\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n    }\n  });\n\n  const handleUseTemplate = (template: BotTemplate) => {\n    useTemplateMutation.mutate(template.id);\n    localStorage.setItem('selectedTemplate', JSON.stringify(template));\n    setLocation('/');\n    \n    toast({\n      title: 'Шаблон загружен!',\n      description: `Шаблон \"${template.name}\" будет применен к вашему проекту`,\n    });\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Шапка */}\n      <div className=\"border-b bg-background\">\n        <div className=\"container mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <Link to=\"/\">\n                <Button variant=\"ghost\" size=\"sm\">\n                  <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                  Назад к редактору\n                </Button>\n              </Link>\n              <h1 className=\"text-2xl font-bold\">Шаблоны ботов</h1>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Содержимое */}\n      <div className=\"container mx-auto px-4 py-6\">\n        <div className=\"flex flex-col lg:flex-row gap-6\">\n          {/* Основной контент */}\n          <div className=\"flex-1\">\n            <div className=\"space-y-4\">\n              {/* Поиск и фильтры */}\n              <div className=\"flex flex-col sm:flex-row gap-4\">\n                <div className=\"relative flex-1\">\n                  <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4\" />\n                  <Input\n                    placeholder=\"Поиск шаблонов...\"\n                    value={searchTerm}\n                    onChange={(e) => setSearchTerm(e.target.value)}\n                    className=\"pl-10\"\n                  />\n                </div>\n                <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                  <SelectTrigger className=\"w-full sm:w-48\">\n                    <SelectValue placeholder=\"Категория\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {categories.map((category) => (\n                      <SelectItem key={category.value} value={category.value}>\n                        {category.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <Select value={sortBy} onValueChange={(value: any) => setSortBy(value)}>\n                  <SelectTrigger className=\"w-full sm:w-40\">\n                    <SelectValue placeholder=\"Сортировка\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"popular\">Популярные</SelectItem>\n                    <SelectItem value=\"rating\">Рейтинг</SelectItem>\n                    <SelectItem value=\"recent\">Новые</SelectItem>\n                    <SelectItem value=\"name\">По алфавиту</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {/* Вкладки */}\n              <Tabs value={currentTab} onValueChange={setCurrentTab}>\n                <TabsList>\n                  <TabsTrigger value=\"all\">Все</TabsTrigger>\n                  <TabsTrigger value=\"featured\">Рекомендуемые</TabsTrigger>\n                  <TabsTrigger value=\"popular\">Популярные</TabsTrigger>\n                  <TabsTrigger value=\"my\">Мои</TabsTrigger>\n                </TabsList>\n\n                {/* Контент вкладок */}\n                <TabsContent value=\"all\" className=\"mt-4\">\n                  <TemplateGrid templates={filteredAndSortedTemplates} isLoading={isLoading} onUse={handleUseTemplate} />\n                </TabsContent>\n                \n                <TabsContent value=\"featured\" className=\"mt-4\">\n                  <TemplateGrid templates={filteredAndSortedTemplates} isLoading={isLoadingFeatured} onUse={handleUseTemplate} />\n                </TabsContent>\n                \n                <TabsContent value=\"popular\" className=\"mt-4\">\n                  <TemplateGrid templates={filteredAndSortedTemplates} isLoading={isLoading} onUse={handleUseTemplate} />\n                </TabsContent>\n                \n                <TabsContent value=\"my\" className=\"mt-4\">\n                  <TemplateGrid templates={filteredAndSortedTemplates} isLoading={isLoadingMy} onUse={handleUseTemplate} />\n                </TabsContent>\n              </Tabs>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// Компонент для сетки шаблонов\nfunction TemplateGrid({ templates, isLoading, onUse }: { \n  templates: BotTemplate[], \n  isLoading: boolean, \n  onUse: (template: BotTemplate) => void \n}) {\n  if (isLoading) {\n    return (\n      <div className=\"flex justify-center py-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin\" />\n      </div>\n    );\n  }\n\n  if (templates.length === 0) {\n    return (\n      <div className=\"text-center py-12\">\n        <p className=\"text-muted-foreground\">Шаблоны не найдены</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n      {templates.map((template) => (\n        <Card key={template.id} className=\"hover:shadow-lg transition-shadow\">\n          <CardHeader>\n            <div className=\"flex items-start justify-between\">\n              <div>\n                <CardTitle className=\"text-lg\">{template.name}</CardTitle>\n                {template.description && (\n                  <CardDescription className=\"mt-1\">{template.description}</CardDescription>\n                )}\n              </div>\n              {template.rating && template.rating > 0 && (\n                <div className=\"flex items-center gap-1\">\n                  <Star className=\"h-4 w-4 fill-yellow-500 text-yellow-500\" />\n                  <span className=\"text-sm font-medium\">{template.rating.toFixed(1)}</span>\n                </div>\n              )}\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Eye className=\"h-4 w-4\" />\n                <span>{template.viewCount || 0}</span>\n                <Download className=\"h-4 w-4 ml-2\" />\n                <span>{template.downloadCount || 0}</span>\n              </div>\n              <Button size=\"sm\" onClick={() => onUse(template)}>\n                Использовать\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n}","size_bytes":11187},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar-background)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":2627},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { spawn, ChildProcess } from \"child_process\";\nimport { writeFileSync, existsSync, mkdirSync, unlinkSync, createWriteStream } from \"fs\";\nimport { join } from \"path\";\nimport multer from \"multer\";\nimport { storage } from \"./storage\";\nimport { insertBotProjectSchema, insertBotInstanceSchema, insertBotTemplateSchema, insertBotTokenSchema, insertMediaFileSchema, insertUserBotDataSchema, insertBotGroupSchema, insertBotMessageSchema, insertBotMessageMediaSchema, nodeSchema, connectionSchema, botDataSchema, sendMessageSchema } from \"@shared/schema\";\nimport { seedDefaultTemplates } from \"./seed-templates\";\nimport { z } from \"zod\";\nimport https from \"https\";\nimport http from \"http\";\nimport { pipeline } from \"stream/promises\";\nimport { URL } from \"url\";\nimport dbRoutes from \"./db-routes\";\nimport { Pool } from \"pg\";\nimport { downloadTelegramPhoto, downloadTelegramVideo, downloadTelegramAudio, downloadTelegramDocument } from \"./telegram-media\";\n// import { generatePythonCode } from \"../client/src/lib/bot-generator\"; // Убрано - используем динамический импорт с очисткой кеша\n\n// Функция нормализации данных узлов для добавления недостающих полей\nfunction normalizeNodeData(node: any) {\n  // Определяем значения по умолчанию для разных типов узлов\n  const nodeDefaults = {\n    start: { \n      command: '/start', \n      description: 'Запустить бота', \n      showInMenu: true, \n      isPrivateOnly: false, \n      requiresAuth: false, \n      adminOnly: false \n    },\n    command: { \n      command: '/custom', \n      description: 'Новая команда', \n      showInMenu: true, \n      isPrivateOnly: false, \n      requiresAuth: false, \n      adminOnly: false \n    }\n  };\n\n  // Получаем значения по умолчанию для типа узла\n  const defaults = nodeDefaults[node.type as keyof typeof nodeDefaults];\n  if (!defaults) return node;\n\n  // Объединяем существующие данные с недостающими значениями по умолчанию\n  const normalizedData = { ...node.data };\n  \n  for (const [key, value] of Object.entries(defaults)) {\n    if (normalizedData[key] === undefined) {\n      normalizedData[key] = value;\n    }\n  }\n\n  return {\n    ...node,\n    data: normalizedData\n  };\n}\n\n// Функция нормализации данных проекта\nfunction normalizeProjectData(projectData: any) {\n  if (!projectData?.data?.sheets) return projectData;\n\n  const normalizedSheets = projectData.data.sheets.map((sheet: any) => ({\n    ...sheet,\n    nodes: sheet.nodes ? sheet.nodes.map(normalizeNodeData) : []\n  }));\n\n  return {\n    ...projectData,\n    data: {\n      ...projectData.data,\n      sheets: normalizedSheets\n    }\n  };\n}\nimport { initializeDatabaseTables } from \"./init-db\";\nimport { telegramClientManager, initializeTelegramManager } from \"./telegram-client\";\nimport { serverCache, getCachedOrExecute } from \"./cache\";\n\n// Глобальное хранилище активных процессов ботов (ключ: `${projectId}_${tokenId}`)\nconst botProcesses = new Map<string, ChildProcess>();\n\n// Расширенная настройка multer для загрузки файлов\nconst storage_multer = multer.diskStorage({\n  destination: (req, file, cb) => {\n    const projectId = req.params.projectId;\n    const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n    const uploadDir = join(process.cwd(), 'uploads', projectId, date);\n    \n    if (!existsSync(uploadDir)) {\n      mkdirSync(uploadDir, { recursive: true });\n    }\n    cb(null, uploadDir);\n  },\n  filename: (req, file, cb) => {\n    // Генерируем уникальное имя файла с временной меткой и безопасным именем\n    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n    const extension = file.originalname.split('.').pop()?.toLowerCase() || '';\n    const baseName = file.originalname\n      .split('.')[0] // Убираем расширение\n      .replace(/[^a-zA-Z0-9._-]/g, '_') // Заменяем небезопасные символы\n      .substring(0, 50); // Ограничиваем длину\n    \n    cb(null, `${uniqueSuffix}-${baseName}.${extension}`);\n  }\n});\n\n// Получение расширения файла\nconst getFileExtension = (filename: string): string => {\n  return '.' + filename.split('.').pop()?.toLowerCase() || '';\n};\n\n// Расширенная валидация файлов с детальными ограничениями\nconst validateFileDetailed = (file: Express.Multer.File) => {\n  const fileValidation = new Map([\n    // Изображения\n    ['image/jpeg', { maxSize: 25 * 1024 * 1024, category: 'photo', description: 'JPEG изображение' }],\n    ['image/jpg', { maxSize: 25 * 1024 * 1024, category: 'photo', description: 'JPG изображение' }],\n    ['image/png', { maxSize: 25 * 1024 * 1024, category: 'photo', description: 'PNG изображение' }],\n    ['image/gif', { maxSize: 15 * 1024 * 1024, category: 'photo', description: 'GIF анимация' }],\n    ['image/webp', { maxSize: 20 * 1024 * 1024, category: 'photo', description: 'WebP изображение' }],\n    ['image/svg+xml', { maxSize: 5 * 1024 * 1024, category: 'photo', description: 'SVG векторное изображение' }],\n    ['image/bmp', { maxSize: 30 * 1024 * 1024, category: 'photo', description: 'BMP изображение' }],\n    \n    // Видео\n    ['video/mp4', { maxSize: 200 * 1024 * 1024, category: 'video', description: 'MP4 видео' }],\n    ['video/webm', { maxSize: 200 * 1024 * 1024, category: 'video', description: 'WebM видео' }],\n    ['video/avi', { maxSize: 200 * 1024 * 1024, category: 'video', description: 'AVI видео' }],\n    ['video/mov', { maxSize: 200 * 1024 * 1024, category: 'video', description: 'QuickTime видео' }],\n    ['video/mkv', { maxSize: 200 * 1024 * 1024, category: 'video', description: 'MKV видео' }],\n    ['video/quicktime', { maxSize: 200 * 1024 * 1024, category: 'video', description: 'QuickTime видео' }],\n    \n    // Аудио\n    ['audio/mp3', { maxSize: 50 * 1024 * 1024, category: 'audio', description: 'MP3 аудио' }],\n    ['audio/mpeg', { maxSize: 50 * 1024 * 1024, category: 'audio', description: 'MPEG аудио' }],\n    ['audio/wav', { maxSize: 100 * 1024 * 1024, category: 'audio', description: 'WAV аудио' }],\n    ['audio/ogg', { maxSize: 50 * 1024 * 1024, category: 'audio', description: 'OGG аудио' }],\n    ['audio/aac', { maxSize: 50 * 1024 * 1024, category: 'audio', description: 'AAC аудио' }],\n    ['audio/flac', { maxSize: 100 * 1024 * 1024, category: 'audio', description: 'FLAC аудио' }],\n    ['audio/m4a', { maxSize: 50 * 1024 * 1024, category: 'audio', description: 'M4A аудио' }],\n    ['audio/webm', { maxSize: 50 * 1024 * 1024, category: 'audio', description: 'WebM аудио' }],\n    \n    // Документы\n    ['application/pdf', { maxSize: 50 * 1024 * 1024, category: 'document', description: 'PDF документ' }],\n    ['application/msword', { maxSize: 25 * 1024 * 1024, category: 'document', description: 'Word документ' }],\n    ['application/vnd.openxmlformats-officedocument.wordprocessingml.document', { maxSize: 25 * 1024 * 1024, category: 'document', description: 'Word документ (DOCX)' }],\n    ['application/vnd.ms-excel', { maxSize: 25 * 1024 * 1024, category: 'document', description: 'Excel таблица' }],\n    ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', { maxSize: 25 * 1024 * 1024, category: 'document', description: 'Excel таблица (XLSX)' }],\n    ['text/plain', { maxSize: 10 * 1024 * 1024, category: 'document', description: 'Текстовый файл' }],\n    ['text/csv', { maxSize: 25 * 1024 * 1024, category: 'document', description: 'CSV файл' }],\n    \n    // Дополнительные форматы документов по расширению файла\n    ['.pdf', { maxSize: 50 * 1024 * 1024, category: 'document', description: 'PDF документ' }],\n    ['.doc', { maxSize: 25 * 1024 * 1024, category: 'document', description: 'Word документ' }],\n    ['.docx', { maxSize: 25 * 1024 * 1024, category: 'document', description: 'Word документ (DOCX)' }],\n    ['.txt', { maxSize: 10 * 1024 * 1024, category: 'document', description: 'Текстовый файл' }],\n    ['.xls', { maxSize: 25 * 1024 * 1024, category: 'document', description: 'Excel таблица' }],\n    ['.xlsx', { maxSize: 25 * 1024 * 1024, category: 'document', description: 'Excel таблица (XLSX)' }],\n    \n    // Архивы\n    ['application/zip', { maxSize: 100 * 1024 * 1024, category: 'document', description: 'ZIP архив' }],\n    ['application/x-rar-compressed', { maxSize: 100 * 1024 * 1024, category: 'document', description: 'RAR архив' }],\n  ]);\n  \n  // Сначала проверяем по MIME типу\n  let validation = fileValidation.get(file.mimetype);\n  \n  // Если не найдено по MIME типу, проверяем по расширению файла\n  if (!validation) {\n    const extension = getFileExtension(file.originalname);\n    validation = fileValidation.get(extension);\n  }\n  \n  if (!validation) {\n    const extension = getFileExtension(file.originalname);\n    return { \n      valid: false, \n      error: `Неподдерживаемый тип файла: ${file.mimetype} (${extension}). Поддерживаются изображения (jpg, png, gif), видео (mp4, webm), аудио (mp3, wav, ogg), документы (pdf, doc, txt).` \n    };\n  }\n  \n  if (file.size > validation.maxSize) {\n    const maxSizeMB = Math.round(validation.maxSize / (1024 * 1024));\n    return { \n      valid: false, \n      error: `Файл \"${file.originalname}\" слишком большой. Максимальный размер для ${validation.description}: ${maxSizeMB}МБ` \n    };\n  }\n  \n  // Проверка имени файла\n  if (file.originalname.length > 255) {\n    return { \n      valid: false, \n      error: 'Имя файла слишком длинное (максимум 255 символов)' \n    };\n  }\n  \n  // Проверка на безопасность имени файла\n  const dangerousPatterns = [/\\.\\./g, /[<>:\"|?*]/g, /^(CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])$/i];\n  if (dangerousPatterns.some(pattern => pattern.test(file.originalname))) {\n    return { \n      valid: false, \n      error: 'Небезопасное имя файла' \n    };\n  }\n  \n  return { valid: true, category: validation.category };\n};\n\n// Упрощенный фильтр для multer\nconst fileFilter = (req: any, file: any, cb: any) => {\n  const validation = validateFileDetailed(file);\n  if (validation.valid) {\n    cb(null, true);\n  } else {\n    cb(new Error(validation.error), false);\n  }\n};\n\nconst upload = multer({ \n  storage: storage_multer,\n  fileFilter: fileFilter,\n  limits: {\n    fileSize: 200 * 1024 * 1024, // 200MB максимальный размер файла (для больших видео)\n    files: 20, // Максимум 20 файлов за раз\n    fieldSize: 10 * 1024 * 1024, // 10MB для полей формы\n    fieldNameSize: 300, // Максимальная длина имени поля\n    fields: 50 // Максимальное количество полей формы\n  }\n});\n\n// Определение типа файла по MIME типу\nfunction getFileType(mimeType: string): 'photo' | 'video' | 'audio' | 'document' {\n  if (mimeType.startsWith('image/')) return 'photo';\n  if (mimeType.startsWith('video/')) return 'video';\n  if (mimeType.startsWith('audio/')) return 'audio';\n  return 'document';\n}\n\n// Функция для загрузки файла по URL с улучшенной обработкой ошибок\nasync function downloadFileFromUrl(url: string, destination: string): Promise<{\n  success: boolean;\n  filePath?: string;\n  size?: number;\n  mimeType?: string;\n  fileName?: string;\n  error?: string;\n}> {\n  return new Promise((resolve) => {\n    try {\n      // Проверяем корректность URL\n      const parsedUrl = new URL(url);\n      if (!['http:', 'https:'].includes(parsedUrl.protocol)) {\n        return resolve({ success: false, error: 'Поддерживаются только HTTP и HTTPS ссылки' });\n      }\n\n      // Выбираем модуль для загрузки в зависимости от протокола\n      const client = parsedUrl.protocol === 'https:' ? https : http;\n      \n      // Создаем запрос с заголовками для эмуляции браузера\n      const request = client.get(url, {\n        headers: {\n          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',\n          'Accept': '*/*',\n          'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8',\n          'Accept-Encoding': 'gzip, deflate, br',\n          'Connection': 'keep-alive',\n          'Sec-Fetch-Dest': 'empty',\n          'Sec-Fetch-Mode': 'cors',\n          'Sec-Fetch-Site': 'cross-site'\n        },\n        timeout: 30000 // 30 секунд таймаут\n      }, (response) => {\n        // Обрабатываем редиректы\n        if (response.statusCode && response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {\n          const redirectUrl = response.headers.location;\n          console.log(`Редирект с ${url} на ${redirectUrl}`);\n          return downloadFileFromUrl(redirectUrl, destination).then(resolve);\n        }\n\n        // Проверяем статус код\n        if (!response.statusCode || response.statusCode < 200 || response.statusCode >= 400) {\n          return resolve({ \n            success: false, \n            error: `Ошибка сервера: ${response.statusCode} ${response.statusMessage}` \n          });\n        }\n\n        // Получаем информацию о файле из заголовков\n        const contentLength = response.headers['content-length'];\n        const contentType = response.headers['content-type'] || 'application/octet-stream';\n        const contentDisposition = response.headers['content-disposition'];\n        \n        // Извлекаем имя файла из заголовков или URL\n        let fileName = '';\n        if (contentDisposition && contentDisposition.includes('filename=')) {\n          const match = contentDisposition.match(/filename[^;=\\n]*=((['\"]).*?\\2|[^;\\n]*)/);\n          if (match && match[1]) {\n            fileName = match[1].replace(/['\"]/g, '');\n          }\n        }\n        \n        if (!fileName) {\n          fileName = parsedUrl.pathname.split('/').pop() || 'downloaded-file';\n          if (!fileName.includes('.')) {\n            // Добавляем расширение на основе MIME типа\n            const extensions = {\n              'image/jpeg': '.jpg',\n              'image/png': '.png',\n              'image/gif': '.gif',\n              'image/webp': '.webp',\n              'video/mp4': '.mp4',\n              'video/webm': '.webm',\n              'audio/mpeg': '.mp3',\n              'audio/wav': '.wav',\n              'application/pdf': '.pdf',\n              'text/plain': '.txt'\n            };\n            fileName += extensions[contentType as keyof typeof extensions] || '.bin';\n          }\n        }\n\n        // Проверяем размер файла\n        if (contentLength) {\n          const fileSizeBytes = parseInt(contentLength);\n          const maxSize = contentType.startsWith('video/') ? 200 * 1024 * 1024 : 50 * 1024 * 1024;\n          if (fileSizeBytes > maxSize) {\n            return resolve({ \n              success: false, \n              error: `Файл слишком большой: ${Math.round(fileSizeBytes / (1024 * 1024))}МБ. Максимальный размер: ${Math.round(maxSize / (1024 * 1024))}МБ` \n            });\n          }\n        }\n\n        // Создаем поток для записи файла\n        const fileStream = createWriteStream(destination);\n        let downloadedBytes = 0;\n\n        response.on('data', (chunk) => {\n          downloadedBytes += chunk.length;\n          // Проверяем размер во время загрузки\n          const maxSize = contentType.startsWith('video/') ? 200 * 1024 * 1024 : 50 * 1024 * 1024;\n          if (downloadedBytes > maxSize) {\n            response.destroy();\n            fileStream.destroy();\n            if (existsSync(destination)) {\n              unlinkSync(destination);\n            }\n            return resolve({ \n              success: false, \n              error: `Файл слишком большой: превышен лимит ${Math.round(maxSize / (1024 * 1024))}МБ` \n            });\n          }\n        });\n\n        response.pipe(fileStream);\n\n        fileStream.on('finish', () => {\n          resolve({\n            success: true,\n            filePath: destination,\n            size: downloadedBytes,\n            mimeType: contentType,\n            fileName: fileName\n          });\n        });\n\n        fileStream.on('error', (error) => {\n          if (existsSync(destination)) {\n            unlinkSync(destination);\n          }\n          resolve({ success: false, error: `Ошибка записи файла: ${error.message}` });\n        });\n      });\n\n      request.on('error', (error) => {\n        resolve({ success: false, error: `Ошибка сети: ${error.message}` });\n      });\n\n      request.on('timeout', () => {\n        request.destroy();\n        resolve({ success: false, error: 'Превышено время ожидания (30 секунд)' });\n      });\n\n    } catch (error) {\n      resolve({ \n        success: false, \n        error: error instanceof Error ? error.message : 'Неизвестная ошибка' \n      });\n    }\n  });\n}\n\n// Функция для проверки доступности URL\nasync function checkUrlAccessibility(url: string): Promise<{\n  accessible: boolean;\n  mimeType?: string;\n  size?: number;\n  fileName?: string;\n  error?: string;\n}> {\n  return new Promise((resolve) => {\n    try {\n      const parsedUrl = new URL(url);\n      if (!['http:', 'https:'].includes(parsedUrl.protocol)) {\n        return resolve({ accessible: false, error: 'Поддерживаются только HTTP и HTTPS ссылки' });\n      }\n\n      const client = parsedUrl.protocol === 'https:' ? https : http;\n      \n      const request = client.request(url, { method: 'HEAD', timeout: 10000 }, (response) => {\n        if (response.statusCode && response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {\n          return checkUrlAccessibility(response.headers.location).then(resolve);\n        }\n\n        if (!response.statusCode || response.statusCode < 200 || response.statusCode >= 400) {\n          return resolve({ \n            accessible: false, \n            error: `Ошибка сервера: ${response.statusCode} ${response.statusMessage}` \n          });\n        }\n\n        const contentLength = response.headers['content-length'];\n        const contentType = response.headers['content-type'] || 'application/octet-stream';\n        const contentDisposition = response.headers['content-disposition'];\n        \n        let fileName = '';\n        if (contentDisposition && contentDisposition.includes('filename=')) {\n          const match = contentDisposition.match(/filename[^;=\\n]*=((['\"]).*?\\2|[^;\\n]*)/);\n          if (match && match[1]) {\n            fileName = match[1].replace(/['\"]/g, '');\n          }\n        }\n        \n        if (!fileName) {\n          fileName = parsedUrl.pathname.split('/').pop() || 'file';\n        }\n\n        resolve({\n          accessible: true,\n          mimeType: contentType,\n          size: contentLength ? parseInt(contentLength) : undefined,\n          fileName: fileName\n        });\n      });\n\n      request.on('error', (error) => {\n        resolve({ accessible: false, error: `Ошибка сети: ${error.message}` });\n      });\n\n      request.on('timeout', () => {\n        request.destroy();\n        resolve({ accessible: false, error: 'Превышено время ожидания' });\n      });\n\n      request.end();\n\n    } catch (error) {\n      resolve({ \n        accessible: false, \n        error: error instanceof Error ? error.message : 'Неверный URL' \n      });\n    }\n  });\n}\n\n// Функция для создания Python файла бота\nfunction createBotFile(botCode: string, projectId: number, tokenId?: number): string {\n  const botsDir = join(process.cwd(), 'bots');\n  if (!existsSync(botsDir)) {\n    mkdirSync(botsDir, { recursive: true });\n  }\n  \n  const fileName = tokenId ? `bot_${projectId}_${tokenId}.py` : `bot_${projectId}.py`;\n  const filePath = join(botsDir, fileName);\n  writeFileSync(filePath, botCode);\n  return filePath;\n}\n\n// Функция для запуска бота\nasync function startBot(projectId: number, token: string, tokenId: number): Promise<{ success: boolean; error?: string; processId?: string }> {\n  try {\n    const processKey = `${projectId}_${tokenId}`;\n    \n    // Проверяем, не запущен ли уже этот конкретный бот\n    if (botProcesses.has(processKey)) {\n      console.log(`Бот с токеном ${tokenId} для проекта ${projectId} уже запущен`);\n      return { success: false, error: \"Этот бот уже запущен\" };\n    }\n\n    const project = await storage.getBotProject(projectId);\n    if (!project) {\n      return { success: false, error: \"Проект не найден\" };\n    }\n\n    // Преобразуем многолистовую структуру в простую для генератора\n    const convertSheetsToSimpleBotData = (data: any) => {\n      // Если уже простая структура - возвращаем как есть\n      if (data.nodes && data.connections) {\n        return data;\n      }\n      \n      // Если многолистовая структура - собираем все узлы и связи\n      if (data.sheets && Array.isArray(data.sheets)) {\n        let allNodes: any[] = [];\n        let allConnections: any[] = [];\n        \n        data.sheets.forEach((sheet: any) => {\n          if (sheet.nodes) allNodes.push(...sheet.nodes);\n          if (sheet.connections) allConnections.push(...sheet.connections);\n        });\n        \n        // Добавляем межлистовые связи\n        if (data.interSheetConnections) {\n          allConnections.push(...data.interSheetConnections);\n        }\n        \n        return {\n          nodes: allNodes,\n          connections: allConnections\n        };\n      }\n      \n      // Если нет узлов вообще - возвращаем пустую структуру\n      return {\n        nodes: [],\n        connections: []\n      };\n    }\n\n    // Генерируем код бота через клиентский генератор (с cache busting)\n    const modUrl = new URL(\"../client/src/lib/bot-generator.js\", import.meta.url);\n    modUrl.searchParams.set(\"t\", Date.now().toString());\n    const { generatePythonCode } = await import(modUrl.href);\n    const simpleBotData = convertSheetsToSimpleBotData(project.data);\n    const userDatabaseEnabled = project.userDatabaseEnabled === 1;\n    const botCode = generatePythonCode(simpleBotData as any, project.name, [], userDatabaseEnabled).replace('YOUR_BOT_TOKEN_HERE', token);\n    \n    // Создаем файл бота (уникальный для каждого токена)\n    const filePath = createBotFile(botCode, projectId, tokenId);\n    \n    // Запускаем бота\n    const process = spawn('python', [filePath], {\n      stdio: ['pipe', 'pipe', 'pipe'],\n      detached: false\n    });\n\n    // Логируем вывод процесса\n    process.stdout?.on('data', (data) => {\n      console.log(`Бот ${projectId} stdout:`, data.toString());\n    });\n\n    process.stderr?.on('data', (data) => {\n      console.error(`Бот ${projectId} stderr:`, data.toString());\n    });\n\n    const processId = process.pid?.toString();\n    \n    // Сохраняем процесс\n    botProcesses.set(processKey, process);\n    \n    // Создаем или обновляем запись в базе данных\n    const existingBotInstance = await storage.getBotInstance(projectId);\n    if (existingBotInstance) {\n      await storage.updateBotInstance(existingBotInstance.id, {\n        status: 'running',\n        token,\n        processId,\n        errorMessage: null\n      });\n    } else {\n      await storage.createBotInstance({\n        projectId,\n        tokenId,\n        status: 'running',\n        token,\n        processId,\n      });\n    }\n\n    // Обрабатываем события процесса\n    process.on('error', async (error) => {\n      console.error(`Ошибка запуска бота ${projectId} (токен ${tokenId}):`, error);\n      const instance = await storage.getBotInstance(projectId);\n      if (instance) {\n        await storage.updateBotInstance(instance.id, { \n          status: 'error', \n          errorMessage: error.message \n        });\n      }\n      botProcesses.delete(processKey);\n    });\n\n    process.on('exit', async (code) => {\n      console.log(`Бот ${projectId} (токен ${tokenId}) завершен с кодом ${code}`);\n      const instance = await storage.getBotInstance(projectId);\n      if (instance) {\n        await storage.updateBotInstance(instance.id, { \n          status: 'stopped',\n          errorMessage: code !== 0 ? `Процесс завершен с кодом ${code}` : null\n        });\n      }\n      botProcesses.delete(processKey);\n    });\n\n    return { success: true, processId };\n  } catch (error) {\n    console.error('Ошибка запуска бота:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Неизвестная ошибка' };\n  }\n}\n\n// Функция для остановки бота по токену\nasync function stopBot(projectId: number, tokenId: number): Promise<{ success: boolean; error?: string }> {\n  try {\n    const processKey = `${projectId}_${tokenId}`;\n    const process = botProcesses.get(processKey);\n    \n    // Если процесс не найден в памяти, но в базе есть запись - исправляем несоответствие\n    if (!process) {\n      const instance = await storage.getBotInstance(projectId);\n      if (instance && instance.status === 'running' && instance.tokenId === tokenId) {\n        console.log(`Процесс бота ${projectId} (токен ${tokenId}) не найден в памяти, но помечен как запущенный в базе. Исправляем состояние.`);\n        await storage.stopBotInstance(projectId);\n        return { success: true };\n      }\n      return { success: false, error: \"Процесс бота не найден\" };\n    }\n\n    process.kill('SIGTERM');\n    botProcesses.delete(processKey);\n    \n    await storage.stopBotInstance(projectId);\n    \n    return { success: true };\n  } catch (error) {\n    console.error('Ошибка остановки бота:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Неизвестная ошибка' };\n  }\n}\n\n// Функция для поиска активного процесса для проекта\nfunction findActiveProcessForProject(projectId: number): { processKey: string; process: ChildProcess } | null {\n  for (const [key, process] of botProcesses.entries()) {\n    if (key.startsWith(`${projectId}_`) && process && !process.killed && process.exitCode === null) {\n      return { processKey: key, process };\n    }\n  }\n  return null;\n}\n\n// Функция для очистки несоответствий состояний ботов при запуске сервера\nasync function cleanupBotStates(): Promise<void> {\n  try {\n    console.log('Проверяем состояние ботов при запуске сервера...');\n    const allInstances = await storage.getAllBotInstances();\n    \n    for (const instance of allInstances) {\n      if (instance.status === 'running') {\n        // Если в базе бот помечен как запущенный, но процесса нет в памяти\n        const activeProcessInfo = findActiveProcessForProject(instance.projectId);\n        if (!activeProcessInfo) {\n          console.log(`Найден бот ${instance.projectId} в статусе \"running\" без активного процесса. Исправляем состояние.`);\n          await storage.updateBotInstance(instance.id, { status: 'stopped' });\n        }\n      }\n    }\n    console.log('Проверка состояния ботов завершена.');\n  } catch (error) {\n    console.error('Ошибка при проверке состояния ботов:', error);\n  }\n}\n\n// Функция для перезапуска бота (если он запущен)\nasync function restartBotIfRunning(projectId: number): Promise<{ success: boolean; error?: string }> {\n  try {\n    const instance = await storage.getBotInstance(projectId);\n    if (!instance || instance.status !== 'running') {\n      return { success: true }; // Бот не запущен, ничего не делаем\n    }\n\n    console.log(`Перезапускаем бота ${projectId} из-за обновления кода...`);\n    \n    // Останавливаем текущий бот\n    const stopResult = await stopBot(projectId, instance.tokenId);\n    if (!stopResult.success) {\n      console.error(`Ошибка перезапуска бота ${projectId}:`, stopResult.error);\n      return { success: true }; // Возвращаем true, чтобы не блокировать сохранение проекта\n    }\n\n    // Ждем дольше для полного завершения процесса и избежания конфликтов\n    await new Promise(resolve => setTimeout(resolve, 5000));\n\n    // Проверяем, что процесс действительно завершен\n    const activeProcessInfo = findActiveProcessForProject(projectId);\n    if (activeProcessInfo) {\n      console.log(`Процесс бота ${projectId} еще не завершен, принудительно удаляем из памяти`);\n      botProcesses.delete(activeProcessInfo.processKey);\n    }\n\n    // Запускаем заново с тем же токеном\n    const startResult = await startBot(projectId, instance.token, instance.tokenId);\n    return startResult;\n  } catch (error) {\n    console.error('Ошибка перезапуска бота:', error);\n    return { success: false, error: error instanceof Error ? error.message : 'Неизвестная ошибка' };\n  }\n}\n\nasync function generatePythonCodeOld(botData: any): Promise<string> {\n  const { nodes } = botData;\n  \n  let code = `import asyncio\nimport logging\nfrom aiogram import Bot, Dispatcher, types\nfrom aiogram.filters import CommandStart, Command\nfrom aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardRemove\nfrom aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder\n\n# Токен вашего бота (получите у @BotFather)\nBOT_TOKEN = \"YOUR_BOT_TOKEN_HERE\"\n\n# Настройка логирования\nlogging.basicConfig(level=logging.INFO)\n\n# Создание бота и диспетчера\nbot = Bot(token=BOT_TOKEN)\ndp = Dispatcher()\n\n`;\n\n  // Generate handlers for each node\n  nodes.forEach((node: any) => {\n    if (node.type === \"start\") {\n      const messageText = node.data.messageText || \"Привет! Добро пожаловать!\";\n      const textAssignment = messageText.includes('\\n') \n        ? `text = \"\"\"${messageText}\"\"\"`\n        : `text = \"${messageText.replace(/\"/g, '\\\\\"')}\"`;\n      \n      code += `\n@dp.message(CommandStart())\nasync def start_handler(message: types.Message):\n    ${textAssignment}\n`;\n      \n      if (node.data.keyboardType === \"reply\" && node.data.buttons.length > 0) {\n        code += `    \n    builder = ReplyKeyboardBuilder()\n`;\n        node.data.buttons.forEach((button: any) => {\n          code += `    builder.add(KeyboardButton(text=\"${button.text}\"))\n`;\n        });\n        \n        code += `    keyboard = builder.as_markup(resize_keyboard=${node.data.resizeKeyboard ? 'True' : 'False'}, one_time_keyboard=${node.data.oneTimeKeyboard ? 'True' : 'False'})\n    await message.answer(text, reply_markup=keyboard)\n`;\n      } else if (node.data.keyboardType === \"inline\" && node.data.buttons.length > 0) {\n        code += `    \n    builder = InlineKeyboardBuilder()\n`;\n        node.data.buttons.forEach((button: any) => {\n          if (button.action === \"url\") {\n            code += `    builder.add(InlineKeyboardButton(text=\"${button.text}\", url=\"${button.url || '#'}\"))\n`;\n          } else {\n            code += `    builder.add(InlineKeyboardButton(text=\"${button.text}\", callback_data=\"${button.target || button.text}\"))\n`;\n          }\n        });\n        \n        code += `    keyboard = builder.as_markup()\n    # Удаляем предыдущие reply клавиатуры перед показом inline кнопок\n    await message.answer(text, reply_markup=ReplyKeyboardRemove())\n    await message.answer(\"Выберите действие:\", reply_markup=keyboard)\n`;\n      } else {\n        code += `    # Удаляем предыдущие reply клавиатуры если они были\n    await message.answer(text, reply_markup=ReplyKeyboardRemove())\n`;\n      }\n    } else if (node.type === \"command\") {\n      const command = node.data.command || \"/help\";\n      const functionName = command.replace('/', '').replace(/[^a-zA-Z0-9_]/g, '_');\n      const messageText = node.data.messageText || \"Команда выполнена\";\n      const textAssignment = messageText.includes('\\n') \n        ? `text = \"\"\"${messageText}\"\"\"`\n        : `text = \"${messageText.replace(/\"/g, '\\\\\"')}\"`;\n      \n      code += `\n@dp.message(Command(\"${command.replace('/', '')}\"))\nasync def ${functionName}_handler(message: types.Message):\n    ${textAssignment}\n`;\n      \n      if (node.data.keyboardType === \"reply\" && node.data.buttons.length > 0) {\n        code += `    \n    builder = ReplyKeyboardBuilder()\n`;\n        node.data.buttons.forEach((button: any) => {\n          code += `    builder.add(KeyboardButton(text=\"${button.text}\"))\n`;\n        });\n        \n        code += `    keyboard = builder.as_markup(resize_keyboard=${node.data.resizeKeyboard ? 'True' : 'False'}, one_time_keyboard=${node.data.oneTimeKeyboard ? 'True' : 'False'})\n    await message.answer(text, reply_markup=keyboard)\n`;\n      } else if (node.data.keyboardType === \"inline\" && node.data.buttons.length > 0) {\n        code += `    \n    builder = InlineKeyboardBuilder()\n`;\n        node.data.buttons.forEach((button: any) => {\n          if (button.action === \"url\") {\n            code += `    builder.add(InlineKeyboardButton(text=\"${button.text}\", url=\"${button.url || '#'}\"))\n`;\n          } else {\n            code += `    builder.add(InlineKeyboardButton(text=\"${button.text}\", callback_data=\"${button.target || button.text}\"))\n`;\n          }\n        });\n        \n        code += `    keyboard = builder.as_markup()\n    # Удаляем предыдущие reply клавиатуры перед показом inline кнопок\n    await message.answer(text, reply_markup=ReplyKeyboardRemove())\n    await message.answer(\"Выберите действие:\", reply_markup=keyboard)\n`;\n      } else {\n        code += `    # Удаляем предыдущие reply клавиатуры если они были\n    await message.answer(text, reply_markup=ReplyKeyboardRemove())\n`;\n      }\n    } else if (node.type === \"message\") {\n      const functionName = `message_${node.id.replace(/[^a-zA-Z0-9_]/g, '_')}`;\n      const messageText = node.data.messageText || \"Сообщение получено\";\n      const textAssignment = messageText.includes('\\n') \n        ? `text = \"\"\"${messageText}\"\"\"`\n        : `text = \"${messageText.replace(/\"/g, '\\\\\"')}\"`;\n      \n      code += `\n@dp.message()\nasync def ${functionName}_handler(message: types.Message):\n    ${textAssignment}\n`;\n      \n      if (node.data.keyboardType === \"reply\" && node.data.buttons.length > 0) {\n        code += `    \n    builder = ReplyKeyboardBuilder()\n`;\n        node.data.buttons.forEach((button: any) => {\n          code += `    builder.add(KeyboardButton(text=\"${button.text}\"))\n`;\n        });\n        \n        code += `    keyboard = builder.as_markup(resize_keyboard=${node.data.resizeKeyboard ? 'True' : 'False'}, one_time_keyboard=${node.data.oneTimeKeyboard ? 'True' : 'False'})\n    await message.answer(text, reply_markup=keyboard)\n`;\n      } else if (node.data.keyboardType === \"inline\" && node.data.buttons.length > 0) {\n        code += `    \n    builder = InlineKeyboardBuilder()\n`;\n        node.data.buttons.forEach((button: any) => {\n          if (button.action === \"url\") {\n            code += `    builder.add(InlineKeyboardButton(text=\"${button.text}\", url=\"${button.url || '#'}\"))\n`;\n          } else {\n            code += `    builder.add(InlineKeyboardButton(text=\"${button.text}\", callback_data=\"${button.target || button.text}\"))\n`;\n          }\n        });\n        \n        code += `    keyboard = builder.as_markup()\n    # Удаляем предыдущие reply клавиатуры перед показом inline кнопок\n    await message.answer(text, reply_markup=ReplyKeyboardRemove())\n    await message.answer(\"Выберите действие:\", reply_markup=keyboard)\n`;\n      } else {\n        code += `    # Удаляем предыдущие reply клавиатуры если они были\n    await message.answer(text, reply_markup=ReplyKeyboardRemove())\n`;\n      }\n    }\n  });\n\n  // Generate synonym handlers for commands\n  const nodesWithSynonyms = nodes.filter((node: any) => \n    (node.type === 'start' || node.type === 'command') && \n    node.data.synonyms && \n    node.data.synonyms.length > 0\n  );\n\n  if (nodesWithSynonyms.length > 0) {\n    code += `\n\n# Обработчики синонимов команд`;\n    nodesWithSynonyms.forEach((node: any) => {\n      if (node.data.synonyms) {\n        node.data.synonyms.forEach((synonym: string) => {\n          const sanitizedSynonym = synonym.replace(/[^a-zA-Zа-яА-Я0-9_]/g, '_');\n          const originalCommand = node.data.command || (node.type === 'start' ? '/start' : '/help');\n          const functionName = originalCommand.replace('/', '').replace(/[^a-zA-Z0-9_]/g, '_');\n          \n          code += `\n@dp.message(lambda message: message.text and message.text.lower() == \"${synonym.toLowerCase()}\")\nasync def ${functionName}_synonym_${sanitizedSynonym}_handler(message: types.Message):\n    # Синоним для команды ${originalCommand}\n`;\n          \n          if (node.type === 'start') {\n            code += '    await start_handler(message)';\n          } else {\n            code += `    await ${functionName}_handler(message)`;\n          }\n        });\n      }\n    });\n  }\n\n  code += `\n\n# Запуск бота\nasync def main():\n    try:\n        print(\"Запускаем бота...\")\n        await dp.start_polling(bot)\n    except Exception as e:\n        print(f\"Ошибка запуска бота: {e}\")\n        raise\n\nif __name__ == '__main__':\n    try:\n        asyncio.run(main())\n    except KeyboardInterrupt:\n        print(\"Бот остановлен\")\n    except Exception as e:\n        print(f\"Критическая ошибка: {e}\")\n        exit(1)\n`;\n\n  return code;\n}\n\n// Function to ensure at least one default project exists\nasync function ensureDefaultProject() {\n  try {\n    const projects = await storage.getAllBotProjects();\n    if (projects.length === 0) {\n      // Create a default project if none exists\n      const defaultProject = {\n        name: \"Мой первый бот\",\n        description: \"Базовый бот с приветствием\",\n        data: {\n          nodes: [\n            {\n              id: \"start\",\n              type: \"start\",\n              position: { x: 100, y: 100 },\n              data: {\n                messageText: \"Привет! Я ваш новый бот. Нажмите /help для получения помощи.\",\n                keyboardType: \"none\",\n                buttons: [],\n                resizeKeyboard: true,\n                oneTimeKeyboard: false\n              }\n            }\n          ],\n          connections: []\n        }\n      };\n      await storage.createBotProject(defaultProject);\n      console.log(\"✅ Создан проект по умолчанию\");\n    }\n  } catch (error) {\n    console.error(\"❌ Ошибка создания проекта по умолчанию:\", error);\n  }\n}\n\n// Глобальные флаги готовности компонентов\nlet isDbReady = false;\nlet areTemplatesReady = false;\nlet isTelegramReady = false;\n\n// Асинхронная инициализация компонентов в фоне\nasync function initializeComponents() {\n  try {\n    // Инициализация базы данных\n    console.log('🔧 Initializing database...');\n    const dbInitSuccess = await initializeDatabaseTables();\n    if (dbInitSuccess) {\n      isDbReady = true;\n      console.log('✅ Database ready');\n      \n      // После готовности БД запускаем остальные компоненты\n      Promise.all([\n        // Загрузка шаблонов\n        seedDefaultTemplates(true).then(() => {\n          areTemplatesReady = true;\n          console.log('✅ Templates ready');\n        }).catch(err => console.error('❌ Templates failed:', err)),\n        \n        // Создание проекта по умолчанию\n        ensureDefaultProject().then(() => {\n          console.log('✅ Default project ready');\n        }).catch(err => console.error('❌ Default project failed:', err)),\n        \n        // Очистка состояний ботов\n        cleanupBotStates().then(() => {\n          console.log('✅ Bot states cleaned');\n        }).catch(err => console.error('❌ Bot cleanup failed:', err)),\n        \n        // Инициализация Telegram клиентов\n        initializeTelegramManager().then(() => {\n          isTelegramReady = true;\n          console.log('✅ Telegram clients ready');\n        }).catch(err => console.error('❌ Telegram initialization failed:', err))\n      ]).catch(err => console.error('❌ Component initialization failed:', err));\n    } else {\n      console.error('❌ Database initialization failed');\n    }\n  } catch (error) {\n    console.error('❌ Critical initialization error:', error);\n  }\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Запускаем инициализацию в фоне без блокировки сервера\n  initializeComponents();\n\n  // Simple API root endpoint for health checks\n  app.get(\"/api\", (req, res) => {\n    res.json({ status: \"ok\", ready: isDbReady && areTemplatesReady });\n  });\n\n  app.head(\"/api\", (req, res) => {\n    res.sendStatus(204);\n  });\n\n  // API для проверки готовности компонентов\n  app.get(\"/api/health\", (req, res) => {\n    res.json({\n      database: isDbReady,\n      templates: areTemplatesReady,\n      telegram: isTelegramReady,\n      ready: isDbReady && areTemplatesReady\n    });\n  });\n\n  app.head(\"/api/health\", (req, res) => {\n    res.sendStatus(204);\n  });\n\n  // Middleware для проверки готовности БД для критически важных операций\n  const requireDbReady = (req: any, res: any, next: any) => {\n    if (!isDbReady) {\n      return res.status(503).json({ \n        message: \"Сервер еще загружается, попробуйте через несколько секунд\",\n        database: isDbReady,\n        ready: false\n      });\n    }\n    next();\n  };\n  \n  // Register database management routes\n  app.use(\"/api/database\", dbRoutes);\n  \n  // Get all bot projects\n  app.get(\"/api/projects\", requireDbReady, async (req, res) => {\n    try {\n      const projects = await getCachedOrExecute(\n        'all-projects',\n        () => storage.getAllBotProjects(),\n        30000 // Кешируем на 30 секунд\n      );\n      res.json(projects);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch projects\" });\n    }\n  });\n\n  // Get single bot project\n  app.get(\"/api/projects/:id\", requireDbReady, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const project = await storage.getBotProject(id);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      // Нормализуем данные проекта для добавления недостающих полей в узлы\n      const normalizedProject = normalizeProjectData(project);\n      \n      res.json(normalizedProject);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch project\" });\n    }\n  });\n\n  // Create new bot project\n  app.post(\"/api/projects\", requireDbReady, async (req, res) => {\n    try {\n      const validatedData = insertBotProjectSchema.parse(req.body);\n      const project = await storage.createBotProject(validatedData);\n      res.status(201).json(project);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create project\" });\n    }\n  });\n\n  // Update bot project\n  app.put(\"/api/projects/:id\", requireDbReady, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const validatedData = insertBotProjectSchema.partial().parse(req.body);\n      const project = await storage.updateBotProject(id, validatedData);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      // Если обновляется data (структура бота), перезапускаем бота если он запущен\n      if (validatedData.data) {\n        console.log(`Проект ${id} обновлен, проверяем необходимость перезапуска бота...`);\n        const restartResult = await restartBotIfRunning(id);\n        if (!restartResult.success) {\n          console.error(`Ошибка перезапуска бота ${id}:`, restartResult.error);\n        }\n      }\n      \n      res.json(project);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update project\" });\n    }\n  });\n\n  // Delete bot project\n  app.delete(\"/api/projects/:id\", requireDbReady, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      console.log(`🗑️ Начинаем удаление проекта ${id}`);\n      \n      // Сначала проверяем, существует ли проект\n      const project = await storage.getBotProject(id);\n      if (!project) {\n        console.log(`❌ Проект ${id} не найден`);\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      console.log(`✅ Проект ${id} найден: ${project.name}`);\n\n      // Останавливаем бота, если он запущен\n      try {\n        const botInstance = await storage.getBotInstance(id);\n        console.log(`🤖 Экземпляр бота для проекта ${id}:`, botInstance ? `ID: ${botInstance.id}, статус: ${botInstance.status}` : 'не найден');\n        \n        if (botInstance && botInstance.status === 'running') {\n          console.log(`🛑 Останавливаем бота ${id} перед удалением проекта...`);\n          await stopBot(id);\n          console.log(`✅ Бот ${id} остановлен`);\n        }\n      } catch (stopError) {\n        console.error(`❌ Ошибка остановки бота ${id}:`, stopError);\n        // Продолжаем удаление даже если остановка не удалась\n      }\n\n      // Удаляем связанные данные в правильном порядке\n      try {\n        // 1. Удаляем экземпляр бота из базы (если он существует)\n        const botInstance = await storage.getBotInstance(id);\n        if (botInstance) {\n          console.log(`🗑️ Удаляем экземпляр бота ${botInstance.id} для проекта ${id}`);\n          const instanceDeleted = await storage.deleteBotInstance(botInstance.id);\n          console.log(`${instanceDeleted ? '✅' : '❌'} Экземпляр бота ${instanceDeleted ? 'удален' : 'не удален'}`);\n        }\n\n        // 2. Удаляем все токены проекта (CASCADE должен сработать автоматически)\n        try {\n          console.log(`🗑️ Удаляем токены проекта ${id}`);\n          const tokens = await storage.getBotTokensByProject(id);\n          for (const token of tokens) {\n            await storage.deleteBotToken(token.id);\n          }\n          console.log(`✅ Токены проекта ${id} удалены`);\n        } catch (tokenError) {\n          console.error(`❌ Ошибка удаления токенов:`, tokenError);\n        }\n\n        // 3. Удаляем медиафайлы\n        try {\n          console.log(`🗑️ Удаляем медиафайлы проекта ${id}`);\n          const mediaFiles = await storage.getMediaFilesByProject(id);\n          for (const mediaFile of mediaFiles) {\n            await storage.deleteMediaFile(mediaFile.id);\n          }\n          console.log(`✅ Медиафайлы проекта ${id} удалены`);\n        } catch (mediaError) {\n          console.error(`❌ Ошибка удаления медиафайлов:`, mediaError);\n        }\n\n        // 4. Удаляем пользовательские данные\n        try {\n          console.log(`🗑️ Удаляем пользовательские данные проекта ${id}`);\n          const userData = await storage.getUserBotDataByProject(id);\n          for (const data of userData) {\n            await storage.deleteUserBotData(data.id);\n          }\n          console.log(`✅ Пользовательские данные проекта ${id} удалены`);\n        } catch (userDataError) {\n          console.error(`❌ Ошибка удаления пользовательских данных:`, userDataError);\n        }\n        \n        // 5. Удаляем файл бота\n        const filePath = join(process.cwd(), 'bots', `bot_${id}.py`);\n        if (existsSync(filePath)) {\n          unlinkSync(filePath);\n          console.log(`✅ Файл бота ${id} удален`);\n        } else {\n          console.log(`📄 Файл бота ${id} не существует`);\n        }\n      } catch (cleanupError) {\n        console.error(`❌ Ошибка очистки данных бота ${id}:`, cleanupError);\n        // Продолжаем удаление проекта\n      }\n\n      // Удаляем проект\n      console.log(`🗑️ Удаляем проект ${id} из базы данных`);\n      const deleted = await storage.deleteBotProject(id);\n      console.log(`${deleted ? '✅' : '❌'} Проект ${deleted ? 'удален' : 'не удален'} из базы данных`);\n      \n      if (!deleted) {\n        return res.status(500).json({ message: \"Failed to delete project from database\" });\n      }\n      \n      console.log(`🎉 Проект ${id} успешно удален`);\n      res.json({ message: \"Project deleted successfully\" });\n    } catch (error) {\n      console.error(\"❌ Критическая ошибка удаления проекта:\", error);\n      console.error(\"❌ Стек ошибки:\", error instanceof Error ? error.stack : 'Unknown error');\n      res.status(500).json({ message: \"Failed to delete project\", error: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  // Generate Python code\n  app.post(\"/api/projects/:id/export\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const project = await storage.getBotProject(id);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n\n      // Преобразуем многолистовую структуру в простую для генератора\n      const convertSheetsToSimpleBotData = (data: any) => {\n        // Если уже простая структура - возвращаем как есть\n        if (data.nodes && data.connections) {\n          return data;\n        }\n        \n        // Если многолистовая структура - собираем все узлы и связи\n        if (data.sheets && Array.isArray(data.sheets)) {\n          let allNodes: any[] = [];\n          let allConnections: any[] = [];\n          \n          data.sheets.forEach((sheet: any) => {\n            if (sheet.nodes) allNodes.push(...sheet.nodes);\n            if (sheet.connections) allConnections.push(...sheet.connections);\n          });\n          \n          // Добавляем межлистовые связи\n          if (data.interSheetConnections) {\n            allConnections.push(...data.interSheetConnections);\n          }\n          \n          return {\n            nodes: allNodes,\n            connections: allConnections\n          };\n        }\n        \n        // Если нет узлов вообще - возвращаем пустую структуру\n        return {\n          nodes: [],\n          connections: []\n        };\n      }\n\n      // Generate Python code using dynamic import with cache busting\n      const modUrl = new URL(\"../client/src/lib/bot-generator.js\", import.meta.url);\n      modUrl.searchParams.set(\"t\", Date.now().toString());\n      const { generatePythonCode } = await import(modUrl.href);\n      const simpleBotData = convertSheetsToSimpleBotData(project.data);\n      const userDatabaseEnabled = project.userDatabaseEnabled === 1;\n      const pythonCode = generatePythonCode(simpleBotData as any, project.name, [], userDatabaseEnabled);\n      res.json({ code: pythonCode });\n    } catch (error) {\n      console.error(\"❌ Ошибка генерации кода:\", error);\n      res.status(500).json({ message: \"Failed to generate code\", error: String(error) });\n    }\n  });\n\n  // Bot management endpoints\n  \n  // Get bot instance status\n  app.get(\"/api/projects/:id/bot\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const instance = await storage.getBotInstance(projectId);\n      if (!instance) {\n        return res.json({ status: 'stopped', instance: null });\n      }\n      \n      // Проверяем соответствие состояния в базе и в памяти\n      const activeProcessInfo = findActiveProcessForProject(projectId);\n      let actualStatus = 'stopped';\n      \n      // Если есть активный процесс в памяти\n      if (activeProcessInfo) {\n        actualStatus = 'running';\n      } else {\n        // Процесса нет в памяти, проверяем PID независимо от статуса в базе\n        console.log(`Бот ${projectId} в базе показан как ${instance.status}, проверяем процесс по PID ${instance.processId}`);\n      }\n      \n      // Проверяем существует ли процесс по PID (независимо от статуса в базе)\n      if (!activeProcessInfo && instance.processId) {\n        try {\n          // Проверяем существование процесса (не убиваем, только проверяем)\n          process.kill(parseInt(instance.processId), 0);\n          console.log(`Процесс ${instance.processId} для бота ${projectId} найден в системе, восстанавливаем отслеживание`);\n          \n          // Создаем фиктивный объект процесса для отслеживания\n          const mockProcess = {\n            pid: parseInt(instance.processId),\n            killed: false,\n            exitCode: null,\n            kill: (signal: any) => {\n              try {\n                process.kill(parseInt(instance.processId!), signal);\n                return true;\n              } catch {\n                return false;\n              }\n            }\n          } as any;\n          \n          // Восстанавливаем отслеживание процесса (используем tokenId из экземпляра)\n          if (instance.tokenId) {\n            const processKey = `${projectId}_${instance.tokenId}`;\n            botProcesses.set(processKey, mockProcess);\n          }\n          actualStatus = 'running';\n        } catch (error) {\n          console.log(`Процесс ${instance.processId} для бота ${projectId} не найден в системе`);\n          actualStatus = 'stopped';\n        }\n      }\n      \n      // Дополнительная проверка через ps для более точного определения\n      if (!activeProcessInfo && instance.processId && actualStatus === 'stopped') {\n        try {\n          const { execSync } = require('child_process');\n          const psOutput = execSync(`ps -p ${instance.processId} -o pid,ppid,cmd --no-headers`, { encoding: 'utf8' }).trim();\n          \n          if (psOutput && psOutput.includes('python')) {\n            console.log(`Процесс ${instance.processId} для бота ${projectId} найден через ps, восстанавливаем отслеживание`);\n            \n            // Создаем фиктивный объект процесса для отслеживания\n            const mockProcess = {\n              pid: parseInt(instance.processId),\n              killed: false,\n              exitCode: null,\n              kill: (signal: any) => {\n                try {\n                  process.kill(parseInt(instance.processId!), signal);\n                  return true;\n                } catch {\n                  return false;\n                }\n              }\n            } as any;\n            \n            // Восстанавливаем отслеживание процесса\n            botProcesses.set(projectId, mockProcess);\n            actualStatus = 'running';\n          }\n        } catch (error) {\n          // ps команда не сработала, процесс точно не существует\n          console.log(`Процесс ${instance.processId} для бота ${projectId} не найден через ps`);\n        }\n      }\n      \n      // Дополнительная проверка через поиск процесса с нужным файлом бота\n      if (!activeProcessInfo && actualStatus === 'stopped') {\n        try {\n          const { execSync } = require('child_process');\n          // Ищем процесс который запускает файл этого бота\n          const botFileName = `bot_${projectId}.py`;\n          const allPythonProcesses = execSync(`ps aux | grep python | grep -v grep`, { encoding: 'utf8' }).trim();\n          \n          // Проверяем есть ли процесс с файлом этого бота\n          if (allPythonProcesses.includes(botFileName)) {\n            console.log(`Найден активный процесс для бота ${projectId} (файл: ${botFileName}), восстанавливаем отслеживание`);\n            \n            // Извлекаем PID из вывода ps\n            const lines = allPythonProcesses.split('\\n');\n            for (const line of lines) {\n              if (line.includes(botFileName)) {\n                const parts = line.trim().split(/\\s+/);\n                const realPid = parseInt(parts[1]);\n                \n                console.log(`Обнаружен реальный PID ${realPid} для бота ${projectId}, обновляем в базе`);\n                \n                // Обновляем PID в базе данных\n                await storage.updateBotInstance(instance.id, { processId: realPid.toString() });\n                \n                // Создаем фиктивный объект процесса для отслеживания\n                const mockProcess = {\n                  pid: realPid,\n                  killed: false,\n                  exitCode: null,\n                  kill: (signal: any) => {\n                    try {\n                      process.kill(realPid, signal);\n                      return true;\n                    } catch {\n                      return false;\n                    }\n                  }\n                } as any;\n                \n                // Восстанавливаем отслеживание процесса\n                botProcesses.set(projectId, mockProcess);\n                actualStatus = 'running';\n                break;\n              }\n            }\n          }\n        } catch (error) {\n          // Команда не сработала, процесс не найден\n          console.log(`Процесс для бота ${projectId} не найден среди Python процессов`);\n        }\n      }\n      \n      // Если статус в базе не соответствует реальному состоянию - исправляем\n      if (instance.status !== actualStatus) {\n        console.log(`Обнаружено несоответствие состояния для бота ${projectId}. База: ${instance.status}, Реальность: ${actualStatus}. Исправляем.`);\n        await storage.updateBotInstance(instance.id, { \n          status: actualStatus,\n          errorMessage: actualStatus === 'stopped' ? 'Процесс завершен' : null\n        });\n        const updatedInstance = { ...instance, status: actualStatus };\n        return res.json({ status: actualStatus, instance: updatedInstance });\n      }\n      \n      res.json({ status: instance.status, instance });\n    } catch (error) {\n      console.error('Ошибка получения статуса бота:', error);\n      res.status(500).json({ message: \"Failed to get bot status\" });\n    }\n  });\n\n  // Start bot\n  app.post(\"/api/projects/:id/bot/start\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const { token, tokenId } = req.body;\n      \n      // Проверяем проект\n      const project = await storage.getBotProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n\n      let botToken = token;\n      let actualTokenId = tokenId;\n\n      // Если не передан токен напрямую, используем токен по ID или по умолчанию\n      if (!botToken) {\n        if (tokenId) {\n          const selectedToken = await storage.getBotToken(tokenId);\n          if (selectedToken && selectedToken.projectId === projectId) {\n            botToken = selectedToken.token;\n            actualTokenId = selectedToken.id;\n          }\n        } else {\n          // Используем токен по умолчанию\n          const defaultToken = await storage.getDefaultBotToken(projectId);\n          if (defaultToken) {\n            botToken = defaultToken.token;\n            actualTokenId = defaultToken.id;\n          }\n        }\n      }\n\n      if (!botToken || !actualTokenId) {\n        return res.status(400).json({ message: \"Bot token is required\" });\n      }\n\n      // Проверяем, не запущен ли уже этот конкретный бот (токен)\n      const existingInstance = await storage.getBotInstanceByToken(actualTokenId);\n      if (existingInstance && existingInstance.status === 'running') {\n        return res.status(400).json({ message: \"Bot is already running\" });\n      }\n\n      const result = await startBot(projectId, botToken, actualTokenId);\n      if (result.success) {\n        // Отмечаем токен как использованный\n        await storage.markTokenAsUsed(actualTokenId);\n        \n        res.json({ \n          message: \"Bot started successfully\", \n          processId: result.processId,\n          tokenUsed: true\n        });\n      } else {\n        res.status(500).json({ message: result.error || \"Failed to start bot\" });\n      }\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to start bot\" });\n    }\n  });\n\n  // Stop bot\n  app.post(\"/api/projects/:id/bot/stop\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const { tokenId } = req.body;\n      \n      if (!tokenId) {\n        return res.status(400).json({ message: \"Token ID is required\" });\n      }\n      \n      const result = await stopBot(projectId, tokenId);\n      if (result.success) {\n        res.json({ message: \"Bot stopped successfully\" });\n      } else {\n        res.status(500).json({ message: result.error || \"Failed to stop bot\" });\n      }\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to stop bot\" });\n    }\n  });\n\n  // Restart bot\n  app.post(\"/api/projects/:id/bot/restart\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      \n      // Сначала останавливаем бота\n      const stopResult = await stopBot(projectId);\n      if (!stopResult.success) {\n        return res.status(500).json({ message: stopResult.error || \"Failed to stop bot\" });\n      }\n      \n      // Ждем немного, чтобы процесс полностью остановился\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      \n      // Получаем токен для запуска\n      const project = await storage.getBotProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      let botToken = null;\n      \n      // Используем токен по умолчанию\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      let botTokenId = null;\n      if (defaultToken) {\n        botToken = defaultToken.token;\n        botTokenId = defaultToken.id;\n      } else {\n        return res.status(400).json({ message: \"Default bot token not found\" });\n      }\n      \n      if (!botToken || !botTokenId) {\n        return res.status(400).json({ message: \"Bot token is required\" });\n      }\n      \n      // Запускаем бота заново\n      const startResult = await startBot(projectId, botToken, botTokenId);\n      if (startResult.success) {\n        res.json({ \n          message: \"Bot restarted successfully\", \n          processId: startResult.processId\n        });\n      } else {\n        res.status(500).json({ message: startResult.error || \"Failed to start bot after restart\" });\n      }\n    } catch (error) {\n      console.error('Ошибка перезапуска бота:', error);\n      res.status(500).json({ message: \"Failed to restart bot\" });\n    }\n  });\n\n  // Get saved bot token\n  app.get(\"/api/projects/:id/token\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const project = await storage.getBotProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      res.json({ \n        hasToken: !!project.botToken, \n        tokenPreview: project.botToken ? `${project.botToken.substring(0, 10)}...` : null \n      });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get token info\" });\n    }\n  });\n\n  // Clear saved bot token\n  app.delete(\"/api/projects/:id/token\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const project = await storage.updateBotProject(projectId, { botToken: null });\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      res.json({ message: \"Token cleared successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to clear token\" });\n    }\n  });\n\n  // Get all bot instances\n  app.get(\"/api/bots\", async (req, res) => {\n    try {\n      const instances = await storage.getAllBotInstances();\n      res.json(instances);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch bot instances\" });\n    }\n  });\n\n  // Template management endpoints\n  \n  // Force update templates\n  app.post(\"/api/templates/refresh\", async (req, res) => {\n    try {\n      console.log('🔄 Принудительное обновление шаблонов по API запросу');\n      await seedDefaultTemplates(true);\n      res.json({ message: \"Templates refreshed successfully\" });\n    } catch (error) {\n      console.error('❌ Ошибка обновления шаблонов:', error);\n      res.status(500).json({ message: \"Failed to refresh templates\" });\n    }\n  });\n\n  // Recreate templates with hierarchy\n  app.post(\"/api/templates/recreate\", async (req, res) => {\n    try {\n      console.log('🔄 Пересоздание шаблонов с иерархией по API запросу');\n      await seedDefaultTemplates(true);\n      res.json({ message: \"Templates recreated with hierarchy successfully\" });\n    } catch (error) {\n      console.error('❌ Ошибка пересоздания шаблонов:', error);\n      res.status(500).json({ message: \"Failed to recreate templates\" });\n    }\n  });\n  \n  // Get all templates\n  app.get(\"/api/templates\", requireDbReady, async (req, res) => {\n    try {\n      const templates = await storage.getAllBotTemplates();\n      // Маппинг data -> flow_data для совместимости с фронтендом\n      const mappedTemplates = templates.map(template => ({\n        ...template,\n        flow_data: template.data\n      }));\n      res.json(mappedTemplates);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch templates\" });\n    }\n  });\n\n  // Get featured templates (must be before /api/templates/:id)\n  app.get(\"/api/templates/featured\", async (req, res) => {\n    try {\n      const templates = await storage.getFeaturedTemplates();\n      res.json(templates);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch featured templates\" });\n    }\n  });\n\n  // Get templates by category (must be before /api/templates/:id)\n  app.get(\"/api/templates/category/:category\", async (req, res) => {\n    try {\n      const { category } = req.params;\n      const templates = await storage.getTemplatesByCategory(category);\n      res.json(templates);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch templates by category\" });\n    }\n  });\n\n  // Search templates (must be before /api/templates/:id)\n  app.get(\"/api/templates/search\", async (req, res) => {\n    try {\n      const { q } = req.query;\n      if (!q || typeof q !== 'string') {\n        return res.status(400).json({ message: \"Search query is required\" });\n      }\n      const templates = await storage.searchTemplates(q);\n      res.json(templates);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to search templates\" });\n    }\n  });\n\n  // Get single template\n  app.get(\"/api/templates/:id\", requireDbReady, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const template = await storage.getBotTemplate(id);\n      if (!template) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch template\" });\n    }\n  });\n\n  // Create new template\n  app.post(\"/api/templates\", requireDbReady, async (req, res) => {\n    try {\n      const validatedData = insertBotTemplateSchema.parse(req.body);\n      const template = await storage.createBotTemplate(validatedData);\n      res.status(201).json(template);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create template\" });\n    }\n  });\n\n  // Update template\n  app.put(\"/api/templates/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const validatedData = insertBotTemplateSchema.partial().parse(req.body);\n      const template = await storage.updateBotTemplate(id, validatedData);\n      if (!template) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update template\" });\n    }\n  });\n\n  // Delete template\n  app.delete(\"/api/templates/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.deleteBotTemplate(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      res.json({ message: \"Template deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete template\" });\n    }\n  });\n\n  // Use template (increment use count)\n  app.post(\"/api/templates/:id/use\", requireDbReady, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.incrementTemplateUseCount(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      res.json({ message: \"Template use count incremented\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to increment use count\" });\n    }\n  });\n\n  // Rate template\n  app.post(\"/api/templates/:id/rate\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { rating } = req.body;\n      \n      if (!rating || rating < 1 || rating > 5) {\n        return res.status(400).json({ message: \"Rating must be between 1 and 5\" });\n      }\n\n      const success = await storage.rateTemplate(id, rating);\n      if (!success) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      res.json({ message: \"Template rated successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to rate template\" });\n    }\n  });\n\n  // Increment template view count\n  app.post(\"/api/templates/:id/view\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.incrementTemplateViewCount(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      res.json({ message: \"View count incremented\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to increment view count\" });\n    }\n  });\n\n  // Increment template download count\n  app.post(\"/api/templates/:id/download\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.incrementTemplateDownloadCount(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      res.json({ message: \"Download count incremented\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to increment download count\" });\n    }\n  });\n\n  // Toggle template like\n  app.post(\"/api/templates/:id/like\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { liked } = req.body;\n      \n      if (typeof liked !== 'boolean') {\n        return res.status(400).json({ message: \"liked must be a boolean\" });\n      }\n      \n      const success = await storage.toggleTemplateLike(id, liked);\n      if (!success) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      \n      res.json({ message: liked ? \"Template liked\" : \"Template unliked\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to toggle like\" });\n    }\n  });\n\n  // Toggle template bookmark\n  app.post(\"/api/templates/:id/bookmark\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { bookmarked } = req.body;\n      \n      if (typeof bookmarked !== 'boolean') {\n        return res.status(400).json({ message: \"bookmarked must be a boolean\" });\n      }\n      \n      const success = await storage.toggleTemplateBookmark(id, bookmarked);\n      if (!success) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      \n      res.json({ message: bookmarked ? \"Template bookmarked\" : \"Template unbookmarked\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to toggle bookmark\" });\n    }\n  });\n\n  // Token management endpoints\n  \n  // Get all tokens for a project\n  app.get(\"/api/projects/:id/tokens\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const tokens = await storage.getBotTokensByProject(projectId);\n      \n      // Hide actual token values for security\n      const safeTokens = tokens.map(token => ({\n        ...token,\n        token: `${token.token.substring(0, 10)}...`\n      }));\n      \n      res.json(safeTokens);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch tokens\" });\n    }\n  });\n\n  // Parse bot information from Telegram API\n  app.post(\"/api/projects/:id/tokens/parse\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const { token } = req.body;\n      \n      if (!token) {\n        return res.status(400).json({ message: \"Token is required\" });\n      }\n      \n      // Get bot information via Telegram Bot API\n      const telegramApiUrl = `https://api.telegram.org/bot${token}/getMe`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n        }\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Invalid bot token or failed to get bot info\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      const botInfo = result.result;\n      \n      // Get bot description and short description\n      let botDescription = null;\n      let botShortDescription = null;\n      \n      try {\n        // Get full description\n        const descResponse = await fetch(`https://api.telegram.org/bot${token}/getMyDescription`);\n        if (descResponse.ok) {\n          const descResult = await descResponse.json();\n          if (descResult.ok && descResult.result && descResult.result.description) {\n            botDescription = descResult.result.description;\n          }\n        }\n        \n        // Get short description  \n        const shortDescResponse = await fetch(`https://api.telegram.org/bot${token}/getMyShortDescription`);\n        if (shortDescResponse.ok) {\n          const shortDescResult = await shortDescResponse.json();\n          if (shortDescResult.ok && shortDescResult.result && shortDescResult.result.short_description) {\n            botShortDescription = shortDescResult.result.short_description;\n          }\n        }\n      } catch (descError) {\n        console.warn(\"Failed to get bot descriptions:\", descError);\n      }\n      \n      // Get bot photo URL if exists\n      let photoUrl = null;\n      if (botInfo.photo && botInfo.photo.big_file_id) {\n        try {\n          const fileResponse = await fetch(`https://api.telegram.org/bot${token}/getFile`, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify({\n              file_id: botInfo.photo.big_file_id\n            })\n          });\n          \n          const fileResult = await fileResponse.json();\n          \n          if (fileResponse.ok && fileResult.result && fileResult.result.file_path) {\n            photoUrl = `https://api.telegram.org/file/bot${token}/${fileResult.result.file_path}`;\n          }\n        } catch (photoError) {\n          console.warn(\"Failed to get bot photo URL:\", photoError);\n        }\n      }\n\n      // Return parsed bot information\n      const parsedBotInfo = {\n        botFirstName: botInfo.first_name,\n        botUsername: botInfo.username,\n        botDescription: botDescription,\n        botShortDescription: botShortDescription,\n        botPhotoUrl: photoUrl,\n        botCanJoinGroups: botInfo.can_join_groups ? 1 : 0,\n        botCanReadAllGroupMessages: botInfo.can_read_all_group_messages ? 1 : 0,\n        botSupportsInlineQueries: botInfo.supports_inline_queries ? 1 : 0,\n        botHasMainWebApp: botInfo.has_main_web_app ? 1 : 0,\n      };\n\n      res.json(parsedBotInfo);\n    } catch (error) {\n      console.error(\"Failed to parse bot info:\", error);\n      res.status(500).json({ message: \"Failed to parse bot info\" });\n    }\n  });\n\n  // Update bot information via Telegram API\n  app.put(\"/api/projects/:id/tokens/:tokenId/bot-info\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const tokenId = parseInt(req.params.tokenId);\n      const { field, value } = req.body;\n      \n      if (!field || value === undefined) {\n        return res.status(400).json({ message: \"Field and value are required\" });\n      }\n      \n      // Get bot token\n      const token = await storage.getBotToken(tokenId);\n      if (!token || token.projectId !== projectId) {\n        return res.status(404).json({ message: \"Token not found\" });\n      }\n      \n      // Update bot information via Telegram API\n      let telegramApiMethod;\n      let requestBody: any = {};\n      \n      switch (field) {\n        case 'name':\n          telegramApiMethod = 'setMyName';\n          requestBody = { name: value };\n          break;\n        case 'description':\n          telegramApiMethod = 'setMyDescription';\n          requestBody = { description: value };\n          break;\n        case 'shortDescription':\n          telegramApiMethod = 'setMyShortDescription';\n          requestBody = { short_description: value };\n          break;\n        default:\n          return res.status(400).json({ message: \"Invalid field\" });\n      }\n      \n      // Call Telegram API\n      const telegramApiUrl = `https://api.telegram.org/bot${token.token}/${telegramApiMethod}`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(requestBody)\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: `Failed to update ${field}`, \n          error: result.description || \"Unknown error\"\n        });\n      }\n      \n      // Update local database with new information\n      let updateData: Partial<any> = {};\n      switch (field) {\n        case 'name':\n          updateData.botFirstName = value;\n          break;\n        case 'description':\n          updateData.botDescription = value;\n          break;\n        case 'shortDescription':\n          updateData.botShortDescription = value;\n          break;\n      }\n      \n      await storage.updateBotToken(tokenId, updateData);\n      \n      res.json({ success: true, field, value });\n    } catch (error) {\n      console.error(`Failed to update bot ${req.body.field}:`, error);\n      res.status(500).json({ message: `Failed to update bot ${req.body.field}` });\n    }\n  });\n\n  // Create a new token\n  app.post(\"/api/projects/:id/tokens\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const tokenData = insertBotTokenSchema.parse({\n        ...req.body,\n        projectId\n      });\n      \n      const token = await storage.createBotToken(tokenData);\n      \n      // Hide actual token value for security\n      const safeToken = {\n        ...token,\n        token: `${token.token.substring(0, 10)}...`\n      };\n      \n      res.status(201).json(safeToken);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create token\" });\n    }\n  });\n\n  // Update a token\n  app.put(\"/api/tokens/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updateData = insertBotTokenSchema.partial().parse(req.body);\n      \n      const token = await storage.updateBotToken(id, updateData);\n      if (!token) {\n        return res.status(404).json({ message: \"Token not found\" });\n      }\n      \n      // Hide actual token value for security\n      const safeToken = {\n        ...token,\n        token: `${token.token.substring(0, 10)}...`\n      };\n      \n      res.json(safeToken);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update token\" });\n    }\n  });\n\n  // Delete a token\n  app.delete(\"/api/tokens/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.deleteBotToken(id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Token not found\" });\n      }\n      \n      res.json({ message: \"Token deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete token\" });\n    }\n  });\n\n  // Delete a token for a specific project\n  app.delete(\"/api/projects/:projectId/tokens/:tokenId\", async (req, res) => {\n    try {\n      const tokenId = parseInt(req.params.tokenId);\n      const success = await storage.deleteBotToken(tokenId);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Token not found\" });\n      }\n      \n      res.json({ message: \"Token deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete token\" });\n    }\n  });\n\n  // Set default token\n  app.post(\"/api/projects/:projectId/tokens/:tokenId/set-default\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const tokenId = parseInt(req.params.tokenId);\n      \n      const success = await storage.setDefaultBotToken(projectId, tokenId);\n      if (!success) {\n        return res.status(404).json({ message: \"Token not found\" });\n      }\n      \n      res.json({ message: \"Default token set successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to set default token\" });\n    }\n  });\n\n  // Get default token for a project\n  app.get(\"/api/projects/:id/tokens/default\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const token = await storage.getDefaultBotToken(projectId);\n      \n      if (!token) {\n        return res.json({ hasDefault: false, token: null });\n      }\n      \n      // Hide actual token value for security\n      const safeToken = {\n        ...token,\n        token: `${token.token.substring(0, 10)}...`\n      };\n      \n      res.json({ hasDefault: true, token: safeToken });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch default token\" });\n    }\n  });\n\n  // === МЕДИАФАЙЛЫ ===\n  \n  // Загрузка медиафайла (одиночная) с улучшенной обработкой\n  app.post(\"/api/media/upload/:projectId\", upload.single('file'), async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const file = req.file;\n      const { description, tags, isPublic } = req.body;\n      \n      if (!file) {\n        return res.status(400).json({ \n          message: \"Файл не выбран\",\n          code: \"NO_FILE\"\n        });\n      }\n      \n      // Проверяем, что проект существует\n      const project = await storage.getBotProject(projectId);\n      if (!project) {\n        // Удаляем загруженный файл если проект не найден\n        if (existsSync(file.path)) {\n          unlinkSync(file.path);\n        }\n        return res.status(404).json({ \n          message: \"Проект не найден\",\n          code: \"PROJECT_NOT_FOUND\"\n        });\n      }\n      \n      // Дополнительная валидация файла\n      const validation = validateFileDetailed(file);\n      if (!validation.valid) {\n        // Удаляем файл при ошибке валидации\n        if (existsSync(file.path)) {\n          unlinkSync(file.path);\n        }\n        return res.status(400).json({ \n          message: validation.error,\n          code: \"VALIDATION_ERROR\"\n        });\n      }\n      \n      // Создаем URL для доступа к файлу относительно проекта\n      const relativePath = file.path.replace(process.cwd(), '').replace(/\\\\/g, '/');\n      const fileUrl = relativePath.startsWith('/') ? relativePath : `/${relativePath}`;\n      \n      // Обрабатываем теги\n      const processedTags = tags ? \n        (Array.isArray(tags) ? tags : tags.split(','))\n          .map((tag: string) => tag.trim().toLowerCase())\n          .filter((tag: string) => tag.length > 0 && tag.length <= 50)\n          .slice(0, 10) // Максимум 10 тегов\n        : [];\n      \n      // Автоматически добавляем теги на основе типа файла\n      const autoTags = [];\n      if (validation.category) {\n        autoTags.push(validation.category);\n      }\n      if (file.mimetype.includes('gif')) {\n        autoTags.push('анимация');\n      }\n      if (file.size > 10 * 1024 * 1024) {\n        autoTags.push('большой_файл');\n      }\n      \n      const finalTags = Array.from(new Set([...processedTags, ...autoTags]));\n      \n      // Сохраняем информацию о файле в базе данных\n      const mediaFile = await storage.createMediaFile({\n        projectId,\n        fileName: file.originalname,\n        fileType: getFileType(file.mimetype),\n        filePath: file.path,\n        fileSize: file.size,\n        mimeType: file.mimetype,\n        url: fileUrl,\n        description: description || `${validation.category || 'Файл'} - ${file.originalname}`,\n        tags: finalTags,\n        isPublic: isPublic === 'true' || isPublic === true ? 1 : 0\n      });\n      \n      // Возвращаем подробную информацию о загруженном файле\n      res.json({\n        ...mediaFile,\n        uploadInfo: {\n          category: validation.category,\n          sizeMB: Math.round(file.size / (1024 * 1024) * 100) / 100,\n          autoTagsAdded: autoTags.length,\n          uploadDate: new Date().toISOString()\n        }\n      });\n    } catch (error) {\n      console.error(\"Ошибка при загрузке файла:\", error);\n      \n      // Удаляем файл в случае ошибки\n      if (req.file && existsSync(req.file.path)) {\n        try {\n          unlinkSync(req.file.path);\n        } catch (unlinkError) {\n          console.error(\"Ошибка при удалении файла:\", unlinkError);\n        }\n      }\n      \n      const errorMessage = error instanceof Error ? error.message : \"Неизвестная ошибка\";\n      res.status(500).json({ \n        message: \"Ошибка при загрузке файла\",\n        error: errorMessage,\n        code: \"UPLOAD_ERROR\"\n      });\n    }\n  });\n\n  // Загрузка множественных медиафайлов с улучшенной обработкой\n  app.post(\"/api/media/upload-multiple/:projectId\", upload.array('files', 20), async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const files = req.files as Express.Multer.File[];\n      \n      const { isPublic, defaultDescription } = req.body;\n      \n      if (!files || files.length === 0) {\n        return res.status(400).json({ \n          message: \"Файлы не выбраны\",\n          code: \"NO_FILES\"\n        });\n      }\n      \n      // Проверяем, что проект существует\n      const project = await storage.getBotProject(projectId);\n      if (!project) {\n        // Удаляем все файлы если проект не найден\n        files.forEach(file => {\n          if (existsSync(file.path)) {\n            unlinkSync(file.path);\n          }\n        });\n        return res.status(404).json({ \n          message: \"Проект не найден\",\n          code: \"PROJECT_NOT_FOUND\"\n        });\n      }\n      \n      const uploadedFiles = [];\n      const errors = [];\n      const warnings: string[] = [];\n      \n      // Группируем файлы по типам для статистики\n      const fileStats = {\n        photo: 0,\n        video: 0,\n        audio: 0,\n        document: 0\n      };\n      \n      for (const file of files) {\n        try {\n          // Проверяем размер файла в зависимости от типа\n          const maxSize = file.mimetype.startsWith('video/') ? 100 * 1024 * 1024 : 50 * 1024 * 1024;\n          if (file.size > maxSize) {\n            // Удаляем файл, если он превышает лимит\n            unlinkSync(file.path);\n            errors.push({\n              fileName: file.originalname,\n              error: `Файл слишком большой. Максимальный размер: ${file.mimetype.startsWith('video/') ? '100' : '50'}МБ`\n            });\n            continue;\n          }\n          \n          // Создаем URL для доступа к файлу\n          const fileUrl = `/uploads/${file.filename}`;\n          \n          // Сохраняем информацию о файле в базе данных\n          const mediaFile = await storage.createMediaFile({\n            projectId,\n            fileName: file.originalname,\n            fileType: getFileType(file.mimetype),\n            filePath: file.path,\n            fileSize: file.size,\n            mimeType: file.mimetype,\n            url: fileUrl,\n            description: defaultDescription || '',\n            tags: [],\n            isPublic: isPublic ? 1 : 0\n          });\n          \n          // Обновляем статистику по типам файлов\n          const fileType = getFileType(file.mimetype);\n          fileStats[fileType]++;\n          \n          uploadedFiles.push(mediaFile);\n        } catch (fileError) {\n          console.error(`Ошибка при обработке файла ${file.originalname}:`, fileError);\n          \n          // Удаляем файл в случае ошибки\n          if (existsSync(file.path)) {\n            try {\n              unlinkSync(file.path);\n            } catch (unlinkError) {\n              console.error(\"Ошибка при удалении файла:\", unlinkError);\n            }\n          }\n          \n          errors.push({\n            fileName: file.originalname,\n            error: \"Ошибка при сохранении файла\"\n          });\n        }\n      }\n      \n      // Собираем дополнительную статистику\n      const totalSize = uploadedFiles.reduce((sum, file) => sum + file.fileSize, 0);\n      \n      res.json({\n        success: uploadedFiles.length,\n        errors: errors.length,\n        uploadedFiles,\n        errorDetails: errors,\n        statistics: {\n          totalFiles: files.length,\n          totalSize,\n          fileTypes: fileStats,\n          averageSize: uploadedFiles.length > 0 ? Math.round(totalSize / uploadedFiles.length) : 0\n        },\n        warnings: warnings.length > 0 ? warnings : undefined\n      });\n    } catch (error) {\n      console.error(\"Ошибка при загрузке файлов:\", error);\n      \n      // Удаляем все файлы в случае ошибки\n      if (req.files) {\n        (req.files as Express.Multer.File[]).forEach(file => {\n          if (existsSync(file.path)) {\n            try {\n              unlinkSync(file.path);\n            } catch (unlinkError) {\n              console.error(\"Ошибка при удалении файла:\", unlinkError);\n            }\n          }\n        });\n      }\n      \n      res.status(500).json({ message: \"Ошибка при загрузке файлов\" });\n    }\n  });\n\n  // Проверка доступности URL перед загрузкой\n  app.post(\"/api/media/check-url\", async (req, res) => {\n    try {\n      const { url } = req.body;\n      \n      if (!url || typeof url !== 'string') {\n        return res.status(400).json({ \n          message: \"URL не указан\",\n          code: \"MISSING_URL\"\n        });\n      }\n\n      const result = await checkUrlAccessibility(url);\n      \n      if (!result.accessible) {\n        return res.status(400).json({\n          accessible: false,\n          error: result.error,\n          code: \"URL_NOT_ACCESSIBLE\"\n        });\n      }\n\n      // Проверяем тип файла\n      const validation = validateFileDetailed({\n        mimetype: result.mimeType || 'application/octet-stream',\n        size: result.size || 0,\n        originalname: result.fileName || 'file'\n      } as any);\n\n      if (!validation.valid) {\n        return res.status(400).json({\n          accessible: false,\n          error: validation.error,\n          code: \"UNSUPPORTED_FILE_TYPE\"\n        });\n      }\n\n      res.json({\n        accessible: true,\n        fileInfo: {\n          mimeType: result.mimeType,\n          size: result.size,\n          fileName: result.fileName,\n          fileType: result.mimeType ? getFileType(result.mimeType) : 'document',\n          category: validation.category,\n          sizeMB: result.size ? Math.round(result.size / (1024 * 1024) * 100) / 100 : 0\n        }\n      });\n\n    } catch (error) {\n      console.error('Ошибка проверки URL:', error);\n      res.status(500).json({ \n        accessible: false,\n        error: \"Ошибка при проверке URL\",\n        code: \"CHECK_ERROR\"\n      });\n    }\n  });\n\n  // Загрузка файла по URL с расширенными возможностями\n  app.post(\"/api/media/download-url/:projectId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { url, description, tags, isPublic, customFileName } = req.body;\n      \n      if (!url || typeof url !== 'string') {\n        return res.status(400).json({ \n          message: \"URL не указан\",\n          code: \"MISSING_URL\"\n        });\n      }\n\n      // Проверяем, что проект существует\n      const project = await storage.getBotProject(projectId);\n      if (!project) {\n        return res.status(404).json({ \n          message: \"Проект не найден\",\n          code: \"PROJECT_NOT_FOUND\"\n        });\n      }\n\n      // Сначала проверяем доступность файла\n      const urlCheck = await checkUrlAccessibility(url);\n      if (!urlCheck.accessible) {\n        return res.status(400).json({\n          message: \"Файл недоступен по указанной ссылке\",\n          error: urlCheck.error,\n          code: \"URL_NOT_ACCESSIBLE\"\n        });\n      }\n\n      // Создаем путь для сохранения\n      const date = new Date().toISOString().split('T')[0];\n      const uploadDir = join(process.cwd(), 'uploads', projectId.toString(), date);\n      \n      if (!existsSync(uploadDir)) {\n        mkdirSync(uploadDir, { recursive: true });\n      }\n\n      // Генерируем уникальное имя файла\n      const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n      const originalFileName = customFileName || urlCheck.fileName || 'downloaded-file';\n      const extension = originalFileName.split('.').pop()?.toLowerCase() || 'bin';\n      const baseName = originalFileName\n        .split('.')[0]\n        .replace(/[^a-zA-Z0-9._-]/g, '_')\n        .substring(0, 50);\n      \n      const fileName = `${uniqueSuffix}-${baseName}.${extension}`;\n      const filePath = join(uploadDir, fileName);\n\n      // Загружаем файл\n      const downloadResult = await downloadFileFromUrl(url, filePath);\n      \n      if (!downloadResult.success) {\n        return res.status(400).json({\n          message: \"Ошибка загрузки файла\",\n          error: downloadResult.error,\n          code: \"DOWNLOAD_FAILED\"\n        });\n      }\n\n      // Проверяем загруженный файл\n      const validation = validateFileDetailed({\n        mimetype: downloadResult.mimeType || 'application/octet-stream',\n        size: downloadResult.size || 0,\n        originalname: originalFileName,\n        path: filePath\n      } as any);\n\n      if (!validation.valid) {\n        // Удаляем файл если он не прошел валидацию\n        if (existsSync(filePath)) {\n          unlinkSync(filePath);\n        }\n        return res.status(400).json({\n          message: validation.error,\n          code: \"VALIDATION_FAILED\"\n        });\n      }\n\n      // Создаем URL для доступа к файлу\n      const fileUrl = `/uploads/${projectId}/${date}/${fileName}`;\n\n      // Обрабатываем теги\n      const processedTags = tags \n        ? tags\n            .split(',')\n            .map((tag: string) => tag.trim().toLowerCase())\n            .filter((tag: string) => tag.length > 0 && tag.length <= 50)\n            .slice(0, 10)\n        : [];\n\n      // Автоматически добавляем теги\n      const autoTags = ['загружено_по_url'];\n      if (validation.category) {\n        autoTags.push(validation.category);\n      }\n      if (downloadResult.mimeType?.includes('gif')) {\n        autoTags.push('анимация');\n      }\n      if (downloadResult.size && downloadResult.size > 10 * 1024 * 1024) {\n        autoTags.push('большой_файл');\n      }\n\n      const finalTags = Array.from(new Set([...processedTags, ...autoTags]));\n\n      // Сохраняем информацию о файле в базе данных\n      const mediaFile = await storage.createMediaFile({\n        projectId,\n        fileName: originalFileName,\n        fileType: getFileType(downloadResult.mimeType || 'application/octet-stream'),\n        filePath: filePath,\n        fileSize: downloadResult.size || 0,\n        mimeType: downloadResult.mimeType || 'application/octet-stream',\n        url: fileUrl,\n        description: description || `Файл загружен по ссылке: ${originalFileName}`,\n        tags: finalTags,\n        isPublic: isPublic === 'true' || isPublic === true ? 1 : 0\n      });\n\n      // Возвращаем подробную информацию о загруженном файле\n      res.json({\n        ...mediaFile,\n        downloadInfo: {\n          sourceUrl: url,\n          category: validation.category,\n          sizeMB: Math.round((downloadResult.size || 0) / (1024 * 1024) * 100) / 100,\n          autoTagsAdded: autoTags.length,\n          downloadDate: new Date().toISOString(),\n          method: 'url_download'\n        }\n      });\n\n    } catch (error) {\n      console.error('Ошибка при загрузке файла по URL:', error);\n      \n      const errorMessage = error instanceof Error ? error.message : \"Неизвестная ошибка\";\n      res.status(500).json({ \n        message: \"Ошибка при загрузке файла по URL\",\n        error: errorMessage,\n        code: \"DOWNLOAD_ERROR\"\n      });\n    }\n  });\n\n  // Пакетная загрузка файлов по URL (множественная загрузка)\n  app.post(\"/api/media/download-urls/:projectId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { urls, isPublic, defaultDescription } = req.body;\n      \n      if (!urls || !Array.isArray(urls) || urls.length === 0) {\n        return res.status(400).json({ \n          message: \"URLs не указаны\",\n          code: \"MISSING_URLS\"\n        });\n      }\n\n      if (urls.length > 10) {\n        return res.status(400).json({ \n          message: \"Максимум 10 URL за раз\",\n          code: \"TOO_MANY_URLS\"\n        });\n      }\n\n      // Проверяем, что проект существует\n      const project = await storage.getBotProject(projectId);\n      if (!project) {\n        return res.status(404).json({ \n          message: \"Проект не найден\",\n          code: \"PROJECT_NOT_FOUND\"\n        });\n      }\n\n      const downloadedFiles = [];\n      const errors = [];\n      \n      // Создаем путь для сохранения\n      const date = new Date().toISOString().split('T')[0];\n      const uploadDir = join(process.cwd(), 'uploads', projectId.toString(), date);\n      \n      if (!existsSync(uploadDir)) {\n        mkdirSync(uploadDir, { recursive: true });\n      }\n\n      // Обрабатываем каждый URL\n      for (let i = 0; i < urls.length; i++) {\n        const urlData = urls[i];\n        const url = typeof urlData === 'string' ? urlData : urlData.url;\n        const customFileName = typeof urlData === 'object' ? urlData.fileName : undefined;\n        const customDescription = typeof urlData === 'object' ? urlData.description : undefined;\n        \n        try {\n          // Проверяем доступность\n          const urlCheck = await checkUrlAccessibility(url);\n          if (!urlCheck.accessible) {\n            errors.push({\n              url: url,\n              error: `Файл недоступен: ${urlCheck.error}`\n            });\n            continue;\n          }\n\n          // Генерируем путь для файла\n          const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n          const originalFileName = customFileName || urlCheck.fileName || `file-${i + 1}`;\n          const extension = originalFileName.split('.').pop()?.toLowerCase() || 'bin';\n          const baseName = originalFileName\n            .split('.')[0]\n            .replace(/[^a-zA-Z0-9._-]/g, '_')\n            .substring(0, 50);\n          \n          const fileName = `${uniqueSuffix}-${baseName}.${extension}`;\n          const filePath = join(uploadDir, fileName);\n\n          // Загружаем файл\n          const downloadResult = await downloadFileFromUrl(url, filePath);\n          \n          if (!downloadResult.success) {\n            errors.push({\n              url: url,\n              error: `Ошибка загрузки: ${downloadResult.error}`\n            });\n            continue;\n          }\n\n          // Валидация\n          const validation = validateFileDetailed({\n            mimetype: downloadResult.mimeType || 'application/octet-stream',\n            size: downloadResult.size || 0,\n            originalname: originalFileName,\n            path: filePath\n          } as any);\n\n          if (!validation.valid) {\n            if (existsSync(filePath)) {\n              unlinkSync(filePath);\n            }\n            errors.push({\n              url: url,\n              error: `Валидация не пройдена: ${validation.error}`\n            });\n            continue;\n          }\n\n          // Создаем URL для доступа\n          const fileUrl = `/uploads/${projectId}/${date}/${fileName}`;\n\n          // Сохраняем в базе данных\n          const mediaFile = await storage.createMediaFile({\n            projectId,\n            fileName: originalFileName,\n            fileType: getFileType(downloadResult.mimeType || 'application/octet-stream'),\n            filePath: filePath,\n            fileSize: downloadResult.size || 0,\n            mimeType: downloadResult.mimeType || 'application/octet-stream',\n            url: fileUrl,\n            description: customDescription || defaultDescription || `Файл загружен по ссылке: ${originalFileName}`,\n            tags: ['загружено_по_url', validation.category || 'файл'],\n            isPublic: isPublic ? 1 : 0\n          });\n\n          downloadedFiles.push({\n            ...mediaFile,\n            sourceUrl: url\n          });\n\n        } catch (error) {\n          console.error(`Ошибка обработки URL ${url}:`, error);\n          errors.push({\n            url: url,\n            error: error instanceof Error ? error.message : 'Неизвестная ошибка'\n          });\n        }\n      }\n\n      res.json({\n        success: downloadedFiles.length,\n        errors: errors.length,\n        downloadedFiles,\n        errorDetails: errors,\n        summary: {\n          total: urls.length,\n          successful: downloadedFiles.length,\n          failed: errors.length,\n          totalSize: downloadedFiles.reduce((sum, file) => sum + file.fileSize, 0)\n        }\n      });\n\n    } catch (error) {\n      console.error('Ошибка пакетной загрузки по URL:', error);\n      res.status(500).json({ \n        message: \"Ошибка при пакетной загрузке файлов по URL\",\n        code: \"BATCH_DOWNLOAD_ERROR\"\n      });\n    }\n  });\n  \n  // Получение всех медиафайлов проекта\n  app.get(\"/api/media/project/:projectId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const fileType = req.query.type as string;\n      \n      let mediaFiles;\n      if (fileType && ['photo', 'video', 'audio', 'document'].includes(fileType)) {\n        mediaFiles = await storage.getMediaFilesByType(projectId, fileType);\n      } else {\n        mediaFiles = await storage.getMediaFilesByProject(projectId);\n      }\n      \n      res.json(mediaFiles);\n    } catch (error) {\n      console.error(\"Ошибка при получении медиафайлов:\", error);\n      res.status(500).json({ message: \"Ошибка при получении медиафайлов\" });\n    }\n  });\n  \n  // Получение конкретного медиафайла\n  app.get(\"/api/media/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const mediaFile = await storage.getMediaFile(id);\n      \n      if (!mediaFile) {\n        return res.status(404).json({ message: \"Файл не найден\" });\n      }\n      \n      res.json(mediaFile);\n    } catch (error) {\n      console.error(\"Ошибка при получении файла:\", error);\n      res.status(500).json({ message: \"Ошибка при получении файла\" });\n    }\n  });\n  \n  // Обновление медиафайла\n  app.put(\"/api/media/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updates = req.body;\n      \n      const mediaFile = await storage.updateMediaFile(id, updates);\n      \n      if (!mediaFile) {\n        return res.status(404).json({ message: \"Файл не найден\" });\n      }\n      \n      res.json(mediaFile);\n    } catch (error) {\n      console.error(\"Ошибка при обновлении файла:\", error);\n      res.status(500).json({ message: \"Ошибка при обновлении файла\" });\n    }\n  });\n  \n  // Удаление медиафайла\n  app.delete(\"/api/media/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      \n      // Получаем информацию о файле перед удалением\n      const mediaFile = await storage.getMediaFile(id);\n      if (!mediaFile) {\n        return res.status(404).json({ message: \"Файл не найден\" });\n      }\n      \n      // Удаляем файл с диска\n      try {\n        unlinkSync(mediaFile.filePath);\n      } catch (error) {\n        console.warn(\"Не удалось удалить файл с диска:\", error);\n      }\n      \n      // Удаляем запись из базы данных\n      const success = await storage.deleteMediaFile(id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Файл не найден в базе данных\" });\n      }\n      \n      res.json({ message: \"Файл успешно удален\" });\n    } catch (error) {\n      console.error(\"Ошибка при удалении файла:\", error);\n      res.status(500).json({ message: \"Ошибка при удалении файла\" });\n    }\n  });\n  \n  // Поиск медиафайлов\n  app.get(\"/api/media/search/:projectId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const query = req.query.q as string;\n      \n      if (!query) {\n        return res.status(400).json({ message: \"Поисковый запрос не может быть пустым\" });\n      }\n      \n      const mediaFiles = await storage.searchMediaFiles(projectId, query);\n      res.json(mediaFiles);\n    } catch (error) {\n      console.error(\"Ошибка при поиске файлов:\", error);\n      res.status(500).json({ message: \"Ошибка при поиске файлов\" });\n    }\n  });\n  \n  // Увеличение счетчика использования файла\n  app.post(\"/api/media/:id/use\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.incrementMediaFileUsage(id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Файл не найден\" });\n      }\n      \n      res.json({ message: \"Использование файла отмечено\" });\n    } catch (error) {\n      console.error(\"Ошибка при обновлении использования файла:\", error);\n      res.status(500).json({ message: \"Ошибка при обновлении использования файла\" });\n    }\n  });\n\n  // User Bot Data Management endpoints\n  \n  // Get all user data for a project\n  app.get(\"/api/projects/:id/users\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      console.log(`Fetching users for project ${projectId}`);\n      \n      // Connect directly to PostgreSQL to get data from bot_users table\n      const { Pool } = await import('pg');\n      const pool = new Pool({\n        connectionString: process.env.DATABASE_URL\n      });\n      \n      const result = await pool.query(`\n        SELECT \n          bu.user_id AS id,\n          bu.user_id AS \"userId\",\n          bu.username AS \"userName\",\n          bu.first_name AS \"firstName\",\n          bu.last_name AS \"lastName\",\n          bu.registered_at AS \"registeredAt\",\n          bu.registered_at AS \"createdAt\",\n          bu.last_interaction AS \"lastInteraction\",\n          COALESCE(COUNT(bm.id), 0)::integer AS \"interactionCount\",\n          bu.user_data AS \"userData\",\n          CASE WHEN bu.is_active = 1 THEN TRUE ELSE FALSE END AS \"isActive\",\n          FALSE AS \"isPremium\",\n          FALSE AS \"isBlocked\",\n          FALSE AS \"isBot\"\n        FROM bot_users bu\n        LEFT JOIN bot_messages bm ON bm.user_id = bu.user_id::text AND bm.project_id = $1\n        GROUP BY bu.user_id, bu.username, bu.first_name, bu.last_name, bu.registered_at, bu.last_interaction, bu.user_data, bu.is_active\n        ORDER BY bu.last_interaction DESC\n      `, [projectId]);\n      \n      await pool.end();\n      \n      console.log(`Found ${result.rows.length} users for project ${projectId}`);\n      res.json(result.rows);\n    } catch (error) {\n      console.error(\"Error fetching user data:\", error);\n      // Fallback to storage interface if bot_users table doesn't exist\n      try {\n        const users = await storage.getUserBotDataByProject(parseInt(req.params.id));\n        const projectId = parseInt(req.params.id);\n        console.log(`Found ${users.length} users for project ${projectId} from fallback`);\n        res.json(users);\n      } catch (fallbackError) {\n        res.status(500).json({ message: \"Failed to fetch user data\" });\n      }\n    }\n  });\n\n  // Get user data stats for a project\n  app.get(\"/api/projects/:id/users/stats\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      console.log(`Fetching user stats for project ${projectId}`);\n      \n      // Use direct PostgreSQL query on bot_users table\n      const { Pool } = await import('pg');\n      const pool = new Pool({\n        connectionString: process.env.DATABASE_URL\n      });\n      \n      const result = await pool.query(`\n        SELECT \n          COUNT(DISTINCT bu.user_id) as \"totalUsers\",\n          COUNT(DISTINCT bu.user_id) FILTER (WHERE bu.is_active = 1) as \"activeUsers\",\n          COUNT(DISTINCT bu.user_id) FILTER (WHERE bu.is_active = 0) as \"blockedUsers\",\n          0 as \"premiumUsers\",\n          COUNT(DISTINCT bu.user_id) FILTER (WHERE bu.user_data IS NOT NULL AND bu.user_data != '{}' AND (bu.user_data::text LIKE '%response_%' OR bu.user_data::text LIKE '%feedback%' OR bu.user_data::text LIKE '%answer%' OR bu.user_data::text LIKE '%input%' OR bu.user_data::text LIKE '%user_%')) as \"usersWithResponses\",\n          COALESCE(COUNT(bm.id), 0) as \"totalInteractions\",\n          CASE WHEN COUNT(DISTINCT bu.user_id) > 0 THEN COALESCE(COUNT(bm.id)::float / COUNT(DISTINCT bu.user_id), 0) ELSE 0 END as \"avgInteractionsPerUser\"\n        FROM bot_users bu\n        LEFT JOIN bot_messages bm ON bm.user_id = bu.user_id::text AND bm.project_id = $1\n      `, [projectId]);\n      \n      await pool.end();\n      \n      const stats = result.rows[0];\n      // Convert strings to numbers\n      Object.keys(stats).forEach(key => {\n        if (typeof stats[key] === 'string' && !isNaN(stats[key] as any)) {\n          stats[key] = parseInt(stats[key] as any);\n        }\n      });\n      \n      console.log(`User stats for project ${projectId}:`, stats);\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching user stats:\", error);\n      // Fallback to user_bot_data table if bot_users doesn't exist\n      try {\n        const { Pool } = await import('pg');\n        const pool = new Pool({\n          connectionString: process.env.DATABASE_URL\n        });\n        \n        const result = await pool.query(`\n          SELECT \n            COUNT(*) as \"totalUsers\",\n            COUNT(*) FILTER (WHERE is_active = 1) as \"activeUsers\",\n            COUNT(*) FILTER (WHERE is_active = 0) as \"blockedUsers\",\n            COUNT(*) FILTER (WHERE is_premium = 1) as \"premiumUsers\",\n            COUNT(*) FILTER (WHERE user_data IS NOT NULL AND user_data != '{}' AND (user_data::text LIKE '%response_%' OR user_data::text LIKE '%feedback%' OR user_data::text LIKE '%answer%' OR user_data::text LIKE '%input%' OR user_data::text LIKE '%user_%')) as \"usersWithResponses\",\n            COALESCE(SUM(interaction_count), 0) as \"totalInteractions\",\n            COALESCE(AVG(interaction_count), 0) as \"avgInteractionsPerUser\"\n          FROM user_bot_data\n          WHERE project_id = $1\n        `, [req.params.id]);\n        \n        await pool.end();\n        \n        const stats = result.rows[0];\n        Object.keys(stats).forEach(key => {\n          if (typeof stats[key] === 'string' && !isNaN(stats[key] as any)) {\n            stats[key] = parseInt(stats[key] as any);\n          }\n        });\n        \n        res.json(stats);\n      } catch (fallbackError) {\n        res.status(500).json({ message: \"Failed to fetch user stats\" });\n      }\n    }\n  });\n\n  // Get detailed user responses for a project\n  app.get(\"/api/projects/:id/responses\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      \n      // Подключаемся напрямую к PostgreSQL для получения ответов пользователей из bot_users\n      const { Pool } = await import('pg');\n      const pool = new Pool({\n        connectionString: process.env.DATABASE_URL\n      });\n      \n      const result = await pool.query(`\n        SELECT \n          user_id,\n          username,\n          first_name,\n          last_name,\n          user_data,\n          registered_at,\n          last_interaction\n        FROM bot_users \n        WHERE user_data IS NOT NULL \n          AND user_data != '{}'\n        ORDER BY last_interaction DESC\n      `);\n      \n      await pool.end();\n      \n      // Обрабатываем и структурируем ответы\n      const processedResponses = result.rows.map(user => {\n        const responses: any[] = [];\n        \n        if (user.user_data && typeof user.user_data === 'object') {\n          Object.entries(user.user_data).forEach(([key, value]) => {\n            // Принимаем все переменные кроме служебных и generic button clicks\n            if (!key.startsWith('input_') && !key.startsWith('waiting_') && key !== 'button_click' && key !== 'last_button_click') {\n              let responseData;\n              let responseType = 'text';\n              let timestamp = null;\n              let nodeId = null;\n              let responseValue = value;\n              \n              try {\n                // Если value является объектом, извлекаем данные\n                if (typeof value === 'object' && value !== null) {\n                  responseData = value as any;\n                  responseValue = responseData.value || value;\n                  responseType = responseData.type || 'text';\n                  timestamp = responseData.timestamp;\n                  nodeId = responseData.nodeId;\n                } else {\n                  // Простое значение\n                  responseValue = value;\n                  responseType = 'text';\n                }\n                \n                // Определяем тип ответа по контексту\n                if (key === 'button_click') {\n                  responseType = 'button';\n                  // Если это callback data (выглядит как node ID), заменяем на понятное название\n                  if (typeof responseValue === 'string' && \n                      (responseValue.match(/^[a-zA-Z0-9_-]{15,25}$/) || \n                       responseValue.match(/^--[a-zA-Z0-9_-]{10,}$/) ||\n                       responseValue.includes('-') && responseValue.length > 10)) {\n                    responseValue = 'Переход к следующему шагу';\n                  }\n                } else if (key.includes('желание') || key.includes('пол') || key.includes('choice')) {\n                  responseType = 'button';\n                } else if (typeof responseValue === 'string' && \n                          (responseValue === 'Да' || responseValue === 'Нет' || \n                           responseValue === 'Женщина' || responseValue === 'Мужчина')) {\n                  responseType = 'button';\n                }\n                \n                // Дополнительная проверка для замены node IDs на понятные названия\n                if (typeof responseValue === 'string') {\n                  // Проверяем различные форматы node ID\n                  if (responseValue.match(/^--[a-zA-Z0-9_-]{10,}$/) ||\n                      responseValue.match(/^[a-zA-Z0-9_-]{15,}$/) ||\n                      responseValue.match(/^[a-zA-Z0-9-]{20,}$/)) {\n                    responseValue = 'Переход к следующему шагу';\n                    responseType = 'button';\n                  }\n                }\n                \n                // Если нет временной метки, используем последнее взаимодействие\n                if (!timestamp) {\n                  timestamp = user.last_interaction;\n                }\n                \n              } catch (error) {\n                // Если не удается обработать, создаем простую структуру\n                responseValue = value;\n                responseType = 'text';\n                timestamp = user.last_interaction;\n              }\n              \n              responses.push({\n                key,\n                value: responseValue,\n                type: responseType,\n                timestamp: timestamp,\n                nodeId: nodeId,\n                variable: key\n              });\n            }\n          });\n        }\n        \n        return {\n          user_id: user.user_id,\n          username: user.username,\n          first_name: user.first_name,\n          last_name: user.last_name,\n          registered_at: user.registered_at,\n          last_interaction: user.last_interaction,\n          responses: responses.sort((a, b) => \n            new Date(b.timestamp || 0).getTime() - new Date(a.timestamp || 0).getTime()\n          ),\n          responseCount: responses.length\n        };\n      }).filter(user => user.responses.length > 0); // Показываем только пользователей с ответами\n      \n      res.json(processedResponses);\n    } catch (error) {\n      console.error(\"Ошибка получения ответов пользователей:\", error);\n      res.status(500).json({ message: \"Failed to fetch user responses\" });\n    }\n  });\n\n  // Get specific user data by ID\n  app.get(\"/api/users/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const userData = await storage.getUserBotData(id);\n      if (!userData) {\n        return res.status(404).json({ message: \"User data not found\" });\n      }\n      res.json(userData);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch user data\" });\n    }\n  });\n\n  // Get user data by project and telegram user ID\n  app.get(\"/api/projects/:projectId/users/:userId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const userId = req.params.userId;\n      const userData = await storage.getUserBotDataByProjectAndUser(projectId, userId);\n      if (!userData) {\n        return res.status(404).json({ message: \"User data not found\" });\n      }\n      res.json(userData);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch user data\" });\n    }\n  });\n\n  // Create new user data\n  app.post(\"/api/projects/:id/users\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const validatedData = insertUserBotDataSchema.parse({\n        ...req.body,\n        projectId\n      });\n      const userData = await storage.createUserBotData(validatedData);\n      res.status(201).json(userData);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: \"Invalid data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to create user data\" });\n    }\n  });\n\n  // Update user data in bot_users table\n  app.put(\"/api/users/:id\", async (req, res) => {\n    try {\n      const userId = req.params.id; // This is telegram user_id as string\n      \n      // Подключаемся напрямую к PostgreSQL для обновления данных в bot_users\n      const { Pool } = await import('pg');\n      const pool = new Pool({\n        connectionString: process.env.DATABASE_URL\n      });\n      \n      // Проверяем какие поля можно обновить\n      const updateFields = [];\n      const values = [];\n      let paramIndex = 1;\n      \n      if (req.body.isActive !== undefined) {\n        updateFields.push(`is_active = $${paramIndex++}`);\n        values.push(Boolean(req.body.isActive === 1 || req.body.isActive === true));\n      }\n      \n      // Note: is_blocked and is_premium columns don't exist in bot_users table\n      // These fields are handled through user_data JSON field if needed\n      \n      if (updateFields.length === 0) {\n        await pool.end();\n        return res.status(400).json({ message: \"No valid fields to update\" });\n      }\n      \n      const query = `\n        UPDATE bot_users \n        SET ${updateFields.join(', ')}, last_interaction = NOW()\n        WHERE user_id = $${paramIndex}\n        RETURNING *\n      `;\n      values.push(userId);\n      \n      console.log('Updating user:', userId, 'with query:', query, 'values:', values);\n      \n      const result = await pool.query(query, values);\n      await pool.end();\n      \n      console.log('Update result:', result.rows.length, 'rows affected');\n      \n      if (result.rows.length === 0) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      res.json(result.rows[0]);\n    } catch (error) {\n      console.error(\"Ошибка обновления пользователя в bot_users:\", error);\n      // Fallback to regular update if bot_users table doesn't exist\n      try {\n        const id = parseInt(req.params.id);\n        const validatedData = insertUserBotDataSchema.partial().parse(req.body);\n        const userData = await storage.updateUserBotData(id, validatedData);\n        if (!userData) {\n          return res.status(404).json({ message: \"User data not found\" });\n        }\n        res.json(userData);\n      } catch (fallbackError) {\n        res.status(500).json({ message: \"Failed to update user data\" });\n      }\n    }\n  });\n\n  // Delete user data\n  app.delete(\"/api/users/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      \n      // Подключение к PostgreSQL для прямого удаления\n      const pool = new Pool({\n        connectionString: process.env.DATABASE_URL,\n      });\n\n      try {\n        // Пытаемся удалить из bot_users если пользователь передал user_id\n        const deleteResult = await pool.query(\n          `DELETE FROM bot_users WHERE user_id = $1`,\n          [id]\n        );\n        \n        await pool.end();\n        \n        if (deleteResult.rowCount && deleteResult.rowCount > 0) {\n          console.log(`Deleted user ${id} from bot_users table`);\n          return res.json({ message: \"User data deleted successfully\" });\n        }\n      } catch (dbError) {\n        await pool.end();\n        console.log(\"bot_users table not found, falling back to user_bot_data\");\n      }\n\n      // Fallback: удаляем из user_bot_data таблицы\n      const success = await storage.deleteUserBotData(id);\n      if (!success) {\n        return res.status(404).json({ message: \"User data not found\" });\n      }\n      res.json({ message: \"User data deleted successfully\" });\n    } catch (error) {\n      console.error(\"Failed to delete user data:\", error);\n      res.status(500).json({ message: \"Failed to delete user data\" });\n    }\n  });\n\n  // Delete all user data for a project\n  app.delete(\"/api/projects/:id/users\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      let totalDeleted = 0;\n      \n      // Подключение к PostgreSQL\n      const pool = new Pool({\n        connectionString: process.env.DATABASE_URL,\n      });\n\n      try {\n        // Удаляем всех пользователей из таблицы bot_users для данного проекта\n        const deleteResult = await pool.query(\n          `DELETE FROM bot_users WHERE project_id = $1`,\n          [projectId]\n        );\n        \n        totalDeleted += deleteResult.rowCount || 0;\n        console.log(`Deleted ${deleteResult.rowCount || 0} users from bot_users for project ${projectId}`);\n      } catch (dbError) {\n        console.log(\"bot_users table not found or error:\", (dbError as any).message);\n      }\n\n      await pool.end();\n      \n      // Подсчитываем количество записей в user_bot_data перед удалением\n      const existingUserData = await storage.getUserBotDataByProject(projectId);\n      const userBotDataCount = existingUserData.length;\n      \n      // Удаляем из user_bot_data таблицы\n      const fallbackSuccess = await storage.deleteUserBotDataByProject(projectId);\n      if (fallbackSuccess) {\n        totalDeleted += userBotDataCount;\n        console.log(`Deleted ${userBotDataCount} users from user_bot_data for project ${projectId}`);\n      }\n      \n      res.json({ \n        message: \"All user data deleted successfully\", \n        deleted: true,\n        deletedCount: totalDeleted\n      });\n    } catch (error) {\n      console.error(\"Failed to delete user data:\", error);\n      res.status(500).json({ message: \"Failed to delete user data\" });\n    }\n  });\n\n  // Search user data\n  app.get(\"/api/projects/:id/users/search\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const query = req.query.q as string;\n      \n      if (!query || query.trim().length === 0) {\n        return res.status(400).json({ message: \"Search query is required\" });\n      }\n      \n      const users = await storage.searchUserBotData(projectId, query.trim());\n      res.json(users);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to search user data\" });\n    }\n  });\n\n  // Increment user interaction count\n  app.post(\"/api/users/:id/interaction\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const success = await storage.incrementUserInteraction(id);\n      if (!success) {\n        return res.status(404).json({ message: \"User data not found\" });\n      }\n      res.json({ message: \"Interaction count incremented\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to increment interaction\" });\n    }\n  });\n\n  // Update user state\n  app.put(\"/api/users/:id/state\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { state } = req.body;\n      \n      if (!state || typeof state !== 'string') {\n        return res.status(400).json({ message: \"State is required and must be a string\" });\n      }\n      \n      const success = await storage.updateUserState(id, state);\n      if (!success) {\n        return res.status(404).json({ message: \"User data not found\" });\n      }\n      res.json({ message: \"User state updated successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to update user state\" });\n    }\n  });\n\n  // Bot Messages endpoints\n  \n  // Get message history for a user with media\n  app.get(\"/api/projects/:projectId/users/:userId/messages\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const userId = req.params.userId;\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 100;\n      \n      if (isNaN(projectId)) {\n        return res.status(400).json({ message: \"Invalid project ID\" });\n      }\n      \n      const messages = await storage.getBotMessagesWithMedia(projectId, userId, limit);\n      res.json(messages);\n    } catch (error) {\n      console.error(\"Failed to get messages:\", error);\n      res.status(500).json({ message: \"Failed to get messages\" });\n    }\n  });\n\n  // Send message to user from admin panel\n  app.post(\"/api/projects/:projectId/users/:userId/send-message\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const userId = req.params.userId;\n      \n      if (isNaN(projectId)) {\n        return res.status(400).json({ message: \"Invalid project ID\" });\n      }\n      \n      // Validate request body with Zod\n      const validationResult = sendMessageSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Invalid request body\", \n          errors: validationResult.error.errors \n        });\n      }\n      \n      const { messageText } = validationResult.data;\n      \n      // Get the default bot token\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n      \n      // Send message via Telegram Bot API\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/sendMessage`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: userId,\n          text: messageText.trim()\n        })\n      });\n      \n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to send message\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n      \n      // Save message to database\n      await storage.createBotMessage({\n        projectId,\n        userId,\n        messageType: \"bot\",\n        messageText: messageText.trim(),\n        messageData: { sentFromAdmin: true }\n      });\n      \n      res.json({ message: \"Message sent successfully\", result });\n    } catch (error) {\n      console.error(\"Failed to send message:\", error);\n      res.status(500).json({ message: \"Failed to send message\" });\n    }\n  });\n\n  // Save message from bot (called by Python bot)\n  app.post(\"/api/projects/:projectId/messages\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      \n      if (isNaN(projectId)) {\n        return res.status(400).json({ message: \"Invalid project ID\" });\n      }\n      \n      // Validate request body with Zod\n      const validationResult = insertBotMessageSchema.safeParse({ ...req.body, projectId });\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: \"Invalid message data\", \n          errors: validationResult.error.errors \n        });\n      }\n      \n      const message = await storage.createBotMessage(validationResult.data);\n      res.json({ message: \"Message saved successfully\", data: message });\n    } catch (error) {\n      console.error(\"Failed to save message:\", error);\n      res.status(500).json({ message: \"Failed to save message\" });\n    }\n  });\n\n  // Delete message history for a user\n  app.delete(\"/api/projects/:projectId/users/:userId/messages\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const userId = req.params.userId;\n      \n      if (isNaN(projectId)) {\n        return res.status(400).json({ message: \"Invalid project ID\" });\n      }\n      \n      const success = await storage.deleteBotMessages(projectId, userId);\n      res.json({ message: \"Messages deleted successfully\", deleted: success });\n    } catch (error) {\n      console.error(\"Failed to delete messages:\", error);\n      res.status(500).json({ message: \"Failed to delete messages\" });\n    }\n  });\n\n  // Register Telegram media (photo/video/audio/document) and link to message\n  app.post(\"/api/projects/:projectId/media/register-telegram-photo\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      \n      if (isNaN(projectId)) {\n        return res.status(400).json({ message: \"Invalid project ID\" });\n      }\n      \n      const { messageId, fileId, botToken, mediaType = 'photo', originalFileName } = req.body;\n      \n      if (!messageId || !fileId || !botToken) {\n        return res.status(400).json({ \n          message: \"Missing required fields: messageId, fileId, botToken\" \n        });\n      }\n\n      // Download media from Telegram based on type\n      let downloadedFile;\n      switch (mediaType) {\n        case 'video':\n          downloadedFile = await downloadTelegramVideo(botToken, fileId, projectId);\n          break;\n        case 'audio':\n          downloadedFile = await downloadTelegramAudio(botToken, fileId, projectId);\n          break;\n        case 'document':\n          downloadedFile = await downloadTelegramDocument(botToken, fileId, projectId, originalFileName);\n          break;\n        case 'photo':\n        default:\n          downloadedFile = await downloadTelegramPhoto(botToken, fileId, projectId);\n          break;\n      }\n\n      // Generate URL for the file (relative from public root)\n      const fileUrl = `/${downloadedFile.filePath}`;\n\n      // Determine file type based on media type\n      let fileType: 'photo' | 'video' | 'audio' | 'document';\n      if (mediaType === 'video') {\n        fileType = 'video';\n      } else if (mediaType === 'audio') {\n        fileType = 'audio';\n      } else if (mediaType === 'document') {\n        fileType = 'document';\n      } else {\n        fileType = 'photo';\n      }\n\n      // Create media file record in database\n      const mediaFile = await storage.createMediaFile({\n        projectId,\n        fileName: downloadedFile.fileName,\n        fileType,\n        filePath: downloadedFile.filePath,\n        fileSize: downloadedFile.fileSize,\n        mimeType: downloadedFile.mimeType,\n        url: fileUrl,\n        description: `Telegram ${mediaType} from user`,\n        tags: [],\n        isPublic: 0,\n      });\n\n      // Link media file to message\n      await storage.createBotMessageMedia({\n        messageId: parseInt(messageId),\n        mediaFileId: mediaFile.id,\n        mediaKind: fileType,\n        orderIndex: 0,\n      });\n\n      res.json({ \n        message: \"Media registered successfully\", \n        mediaFile,\n        url: fileUrl\n      });\n    } catch (error) {\n      console.error(\"Failed to register Telegram media:\", error);\n      res.status(500).json({ \n        message: \"Failed to register media\",\n        error: error instanceof Error ? error.message : 'Unknown error'\n      });\n    }\n  });\n\n  // Bot Groups API\n  // Get groups for a project\n  app.get(\"/api/projects/:id/groups\", async (req, res) => {\n    console.log(\"=== GROUPS API CALLED ===\");\n    try {\n      const projectId = parseInt(req.params.id);\n      if (isNaN(projectId)) {\n        return res.status(400).json({ message: \"Invalid project ID\" });\n      }\n      \n      console.log(\"Getting groups for project\", projectId);\n      console.log(\"Storage methods available:\", Object.getOwnPropertyNames(storage).includes('getBotGroupsByProject'));\n      console.log(\"Storage prototype methods:\", Object.getOwnPropertyNames(Object.getPrototypeOf(storage)));\n      \n      const groups = await storage.getBotGroupsByProject(projectId);\n      console.log(\"Groups found:\", groups);\n      res.json(groups);\n    } catch (error) {\n      console.error(\"Failed to get groups:\", error);\n      res.status(500).json({ message: \"Failed to get groups\" });\n    }\n  });\n\n  // Create a new group\n  app.post(\"/api/projects/:id/groups\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      if (isNaN(projectId)) {\n        return res.status(400).json({ message: \"Invalid project ID\" });\n      }\n      \n      console.log(\"=== CREATE GROUP DEBUG ===\");\n      console.log(\"Request body:\", JSON.stringify(req.body, null, 2));\n      console.log(\"Project ID:\", projectId);\n      console.log(\"Data to validate:\", JSON.stringify({ ...req.body, projectId }, null, 2));\n      \n      const result = insertBotGroupSchema.safeParse({ ...req.body, projectId });\n      if (!result.success) {\n        console.log(\"Validation errors:\", JSON.stringify(result.error.errors, null, 2));\n        return res.status(400).json({ message: \"Invalid group data\", errors: result.error.errors });\n      }\n      \n      console.log(\"Validation successful, data:\", JSON.stringify(result.data, null, 2));\n      \n      const group = await storage.createBotGroup(result.data);\n      res.json(group);\n    } catch (error) {\n      console.error(\"Failed to create group:\", error);\n      res.status(500).json({ message: \"Failed to create group\" });\n    }\n  });\n\n  // Update a group\n  app.put(\"/api/projects/:projectId/groups/:groupId\", async (req, res) => {\n    try {\n      const groupId = parseInt(req.params.groupId);\n      if (isNaN(groupId)) {\n        return res.status(400).json({ message: \"Invalid group ID\" });\n      }\n      \n      const group = await storage.updateBotGroup(groupId, req.body);\n      if (!group) {\n        return res.status(404).json({ message: \"Group not found\" });\n      }\n      \n      res.json(group);\n    } catch (error) {\n      console.error(\"Failed to update group:\", error);\n      res.status(500).json({ message: \"Failed to update group\" });\n    }\n  });\n\n  // Delete a group\n  app.delete(\"/api/projects/:projectId/groups/:groupId\", async (req, res) => {\n    try {\n      const groupId = parseInt(req.params.groupId);\n      if (isNaN(groupId)) {\n        return res.status(400).json({ message: \"Invalid group ID\" });\n      }\n      \n      const success = await storage.deleteBotGroup(groupId);\n      if (!success) {\n        return res.status(404).json({ message: \"Group not found\" });\n      }\n      \n      res.json({ message: \"Group deleted successfully\" });\n    } catch (error) {\n      console.error(\"Failed to delete group:\", error);\n      res.status(500).json({ message: \"Failed to delete group\" });\n    }\n  });\n\n  // Get bot information (getMe)\n  app.get(\"/api/projects/:id/bot/info\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      \n      // Добавляем заголовки для отключения кэширования при обновлении\n      res.set({\n        'Cache-Control': 'no-cache, no-store, must-revalidate',\n        'Pragma': 'no-cache',\n        'Expires': '0'\n      });\n      \n      // Get bot token for this project\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found. Please add a token first.\" });\n      }\n\n      // Get bot information via Telegram Bot API with cache busting\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/getMe?_t=${Date.now()}`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n          'Cache-Control': 'no-cache',\n          'Pragma': 'no-cache'\n        }\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to get bot info\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      const botInfo = result.result;\n      \n      // Логируем ответ от Telegram API для отладки\n      console.log('Telegram API response:', JSON.stringify({\n        first_name: botInfo.first_name,\n        username: botInfo.username,\n        description: botInfo.description,\n        short_description: botInfo.short_description\n      }, null, 2));\n      \n      // If bot has photo, get the file URL\n      let photoUrl = null;\n      if (botInfo.photo && botInfo.photo.big_file_id) {\n        try {\n          // Get file info\n          const fileResponse = await fetch(`https://api.telegram.org/bot${defaultToken.token}/getFile`, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify({\n              file_id: botInfo.photo.big_file_id\n            })\n          });\n          \n          const fileResult = await fileResponse.json();\n          \n          if (fileResponse.ok && fileResult.result && fileResult.result.file_path) {\n            // Construct full photo URL\n            photoUrl = `https://api.telegram.org/file/bot${defaultToken.token}/${fileResult.result.file_path}`;\n          }\n        } catch (photoError) {\n          console.warn(\"Failed to get bot photo URL:\", photoError);\n          // Continue without photo - not a critical error\n        }\n      }\n\n      // Add photo URL to response\n      const responseData = {\n        ...botInfo,\n        photoUrl: photoUrl\n      };\n\n      res.json(responseData);\n    } catch (error) {\n      console.error(\"Failed to get bot info:\", error);\n      res.status(500).json({ message: \"Failed to get bot info\" });\n    }\n  });\n\n  // Update bot name\n  app.put(\"/api/projects/:id/bot/name\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const { name, language_code = 'ru' } = req.body;\n\n      console.log('🔧 Обновление имени бота:', { projectId, name, language_code });\n\n      // Get bot token for this project\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        console.error('❌ Токен бота не найден для проекта', projectId);\n        return res.status(400).json({ message: \"Bot token not found. Please add a token first.\" });\n      }\n\n      console.log('✅ Токен найден, отправляем запрос к Telegram API...');\n\n      // Update bot name via Telegram Bot API\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/setMyName`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ name, language_code })\n      });\n\n      const result = await response.json();\n      \n      console.log('📡 Ответ от Telegram API setMyName:', { status: response.status, result });\n      \n      if (!response.ok) {\n        console.error('❌ Ошибка от Telegram API:', result);\n        return res.status(400).json({ \n          message: \"Failed to update bot name\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      console.log('✅ Имя бота успешно обновлено через Telegram API');\n      res.json({ message: \"Bot name updated successfully\" });\n    } catch (error) {\n      console.error(\"Failed to update bot name:\", error);\n      res.status(500).json({ message: \"Failed to update bot name\" });\n    }\n  });\n\n  // Update bot description\n  app.put(\"/api/projects/:id/bot/description\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const { description, language_code = 'ru' } = req.body;\n\n      console.log('🔧 Обновление описания бота:', { projectId, description, language_code });\n\n      // Get bot token for this project\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        console.error('❌ Токен бота не найден для проекта', projectId);\n        return res.status(400).json({ message: \"Bot token not found. Please add a token first.\" });\n      }\n\n      console.log('✅ Токен найден, отправляем запрос к Telegram API...');\n\n      // Update bot description via Telegram Bot API\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/setMyDescription`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ description, language_code })\n      });\n\n      const result = await response.json();\n      \n      console.log('📡 Ответ от Telegram API setMyDescription:', { status: response.status, result });\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to update bot description\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ message: \"Bot description updated successfully\" });\n    } catch (error) {\n      console.error(\"Failed to update bot description:\", error);\n      res.status(500).json({ message: \"Failed to update bot description\" });\n    }\n  });\n\n  // Update bot short description\n  app.put(\"/api/projects/:id/bot/short-description\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.id);\n      const { short_description, language_code = 'ru' } = req.body;\n\n      // Get bot token for this project\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found. Please add a token first.\" });\n      }\n\n      // Update bot short description via Telegram Bot API\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/setMyShortDescription`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ short_description, language_code })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to update bot short description\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ message: \"Bot short description updated successfully\" });\n    } catch (error) {\n      console.error(\"Failed to update bot short description:\", error);\n      res.status(500).json({ message: \"Failed to update bot short description\" });\n    }\n  });\n\n  // Telegram Bot API integration for groups\n  // Send message to group\n  app.post(\"/api/projects/:projectId/bot/send-group-message\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, message } = req.body;\n      \n      if (!groupId || !message) {\n        return res.status(400).json({ message: \"Group ID and message are required\" });\n      }\n\n      // Get bot token for this project\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found. Please add a token first.\" });\n      }\n\n      // Send message via Telegram Bot API\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/sendMessage`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          text: message,\n          parse_mode: 'HTML'\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to send message\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ \n        message: \"Message sent successfully\", \n        messageId: result.result.message_id \n      });\n    } catch (error) {\n      console.error(\"Failed to send group message:\", error);\n      res.status(500).json({ message: \"Failed to send message\" });\n    }\n  });\n\n  // Get group chat information\n  app.get(\"/api/projects/:projectId/bot/group-info/:groupId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId } = req.params;\n      \n      // Check if groupId is null, undefined, or \"null\" string\n      if (!groupId || groupId === 'null' || groupId === 'undefined') {\n        return res.status(400).json({ \n          message: \"Не указан ID группы\", \n          error: \"Для приватных групп нужно указать chat_id. Отправьте любое сообщение в группу, затем переслайте его в @userinfobot чтобы получить chat_id группы.\"\n        });\n      }\n      \n      // Get bot token for this project\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found. Please add a token first.\" });\n      }\n\n      // Get chat information via Telegram Bot API\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/getChat`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to get group info\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      const chatInfo = result.result;\n      \n      // If chat has photo, get the file URL\n      let avatarUrl = null;\n      if (chatInfo.photo && chatInfo.photo.big_file_id) {\n        try {\n          // Get file info\n          const fileResponse = await fetch(`https://api.telegram.org/bot${defaultToken.token}/getFile`, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify({\n              file_id: chatInfo.photo.big_file_id\n            })\n          });\n          \n          const fileResult = await fileResponse.json();\n          \n          if (fileResponse.ok && fileResult.result && fileResult.result.file_path) {\n            // Construct full photo URL\n            avatarUrl = `https://api.telegram.org/file/bot${defaultToken.token}/${fileResult.result.file_path}`;\n          }\n        } catch (photoError) {\n          console.warn(\"Failed to get group photo URL:\", photoError);\n          // Continue without photo - not a critical error\n        }\n      }\n\n      // Add avatar URL to response\n      const responseData = {\n        ...chatInfo,\n        avatarUrl: avatarUrl\n      };\n\n      res.json(responseData);\n    } catch (error) {\n      console.error(\"Failed to get group info:\", error);\n      res.status(500).json({ message: \"Failed to get group info\" });\n    }\n  });\n\n  // Get group members count\n  app.get(\"/api/projects/:projectId/bot/group-members-count/:groupId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId } = req.params;\n      \n      // Check if groupId is null, undefined, or \"null\" string\n      if (!groupId || groupId === 'null' || groupId === 'undefined') {\n        return res.status(400).json({ \n          message: \"Не указан ID группы\", \n          error: \"Для приватных групп нужно указать chat_id. Отправьте любое сообщение в группу, затем переслайте его в @userinfobot чтобы получить chat_id группы.\"\n        });\n      }\n      \n      // Get bot token for this project\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found. Please add a token first.\" });\n      }\n\n      // Get members count via Telegram Bot API\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/getChatMemberCount`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to get members count\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ count: result.result });\n    } catch (error) {\n      console.error(\"Failed to get members count:\", error);\n      res.status(500).json({ message: \"Failed to get members count\" });\n    }\n  });\n\n  // Get bot admin status in group\n  app.get(\"/api/projects/:projectId/bot/admin-status/:groupId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId } = req.params;\n      \n      // Check if groupId is null, undefined, or \"null\" string\n      if (!groupId || groupId === 'null' || groupId === 'undefined') {\n        return res.status(400).json({ \n          message: \"Не указан ID группы\", \n          error: \"Для приватных групп нужно указать chat_id. Отправьте любое сообщение в группу, затем переслайте его в @userinfobot чтобы получить chat_id группы.\"\n        });\n      }\n      \n      // Get bot token for this project\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found. Please add a token first.\" });\n      }\n\n      // Get bot information first\n      const botInfoResponse = await fetch(`https://api.telegram.org/bot${defaultToken.token}/getMe`);\n      const botInfo = await botInfoResponse.json();\n      \n      if (!botInfoResponse.ok) {\n        return res.status(400).json({ message: \"Failed to get bot info\" });\n      }\n\n      const botId = botInfo.result.id;\n\n      // Check bot admin status\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/getChatMember`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          user_id: botId\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to get admin status\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      const isAdmin = ['administrator', 'creator'].includes(result.result.status);\n      \n      res.json({ \n        isAdmin,\n        status: result.result.status,\n        permissions: result.result\n      });\n    } catch (error) {\n      console.error(\"Failed to get admin status:\", error);\n      res.status(500).json({ message: \"Failed to get admin status\" });\n    }\n  });\n\n  // Get group administrators\n  app.get(\"/api/projects/:projectId/bot/group-admins/:groupId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId } = req.params;\n      \n      if (!groupId || groupId === \"null\") {\n        return res.status(400).json({ message: \"Group ID is required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/getChatAdministrators`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to get administrators\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      // Найти бота среди администраторов и извлечь его права\n      let botAdminRights = null;\n      const botUser = await fetch(`https://api.telegram.org/bot${defaultToken.token}/getMe`);\n      const botInfo = await botUser.json();\n      \n      if (botUser.ok && result.result) {\n        const botAdmin = result.result.find((admin: any) => \n          admin.user && admin.user.id === botInfo.result.id\n        );\n        \n        if (botAdmin && botAdmin.status === 'administrator') {\n          // Извлекаем права администратора бота\n          botAdminRights = {\n            can_manage_chat: botAdmin.can_manage_chat || false,\n            can_change_info: botAdmin.can_change_info || false,\n            can_delete_messages: botAdmin.can_delete_messages || false,\n            can_invite_users: botAdmin.can_invite_users || false,\n            can_restrict_members: botAdmin.can_restrict_members || false,\n            can_pin_messages: botAdmin.can_pin_messages || false,\n            can_promote_members: botAdmin.can_promote_members || false,\n            can_manage_video_chats: botAdmin.can_manage_video_chats || false\n          };\n        }\n      }\n\n      res.json({ \n        administrators: result.result,\n        botAdminRights: botAdminRights\n      });\n    } catch (error) {\n      console.error(\"Failed to get administrators:\", error);\n      res.status(500).json({ message: \"Failed to get administrators\" });\n    }\n  });\n\n  // Get all group members (works only for small groups <200 members)\n  app.get(\"/api/projects/:projectId/bot/group-members/:groupId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId } = req.params;\n      \n      if (!groupId || groupId === \"null\") {\n        return res.status(400).json({ message: \"Group ID is required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      // First check if this is a small group by getting chat info\n      const chatInfoResponse = await fetch(`https://api.telegram.org/bot${defaultToken.token}/getChat`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId\n        })\n      });\n\n      const chatInfo = await chatInfoResponse.json();\n      \n      if (!chatInfoResponse.ok) {\n        return res.status(400).json({ \n          message: \"Failed to get chat info\", \n          error: chatInfo.description || \"Unknown error\"\n        });\n      }\n\n      // For large groups, we can only provide administrators\n      // Check only member count, not group type - small supergroups should work\n      if (chatInfo.result.members_count && chatInfo.result.members_count > 200) {\n        return res.status(400).json({ \n          message: \"Cannot get member list for large groups\", \n          error: \"Telegram API allows getting full member list only for small groups (<200 members). For large groups, only administrators are available.\",\n          membersCount: chatInfo.result.members_count\n        });\n      }\n\n      // Telegram Bot API has limitations for getting chat members\n      // For privacy reasons, even small groups only allow getting administrators\n      try {\n        const adminsResponse = await fetch(`https://api.telegram.org/bot${defaultToken.token}/getChatAdministrators`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            chat_id: groupId\n          })\n        });\n\n        const adminsResult = await adminsResponse.json();\n        \n        if (!adminsResponse.ok) {\n          return res.status(400).json({ \n            message: \"Ошибка при получении участников\", \n            error: adminsResult.description || \"Неизвестная ошибка\"\n          });\n        }\n\n        // Include information about group size\n        const memberCount = chatInfo.result.members_count || 'Неизвестно';\n        \n        return res.json({ \n          members: adminsResult.result,\n          isPartialList: true,\n          totalCount: memberCount,\n          message: `Группа содержит ${memberCount} участников. Показаны только администраторы (${adminsResult.result.length}).`,\n          explanation: \"Telegram API ограничивает доступ к списку участников по соображениям приватности. Доступны только администраторы.\"\n        });\n\n      } catch (error) {\n        console.error(\"Error getting members:\", error);\n        res.status(500).json({ message: \"Failed to get group members\" });\n      }\n\n    } catch (error) {\n      console.error(\"Failed to get group members:\", error);\n      res.status(500).json({ message: \"Failed to get group members\" });\n    }\n  });\n\n  // Check specific member status\n  app.get(\"/api/projects/:projectId/bot/check-member/:groupId/:userId\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, userId } = req.params;\n      \n      if (!groupId || groupId === \"null\" || !userId) {\n        return res.status(400).json({ message: \"Group ID and User ID are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/getChatMember`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          user_id: parseInt(userId)\n        })\n      });\n\n      const result = await response.json();\n      \n      console.log(\"Telegram API response for check member:\", {\n        ok: response.ok,\n        status: response.status,\n        result: result,\n        groupId: groupId,\n        userId: userId\n      });\n      \n      if (!response.ok) {\n        console.error(\"Failed to check member status via Telegram API:\", result);\n        // Если это ошибка из-за неправильного username, пробуем объяснить\n        if (result.description && result.description.includes(\"user not found\")) {\n          return res.status(400).json({ \n            message: \"User not found\", \n            error: \"Пользователь не найден. Убедитесь, что вы указали правильный @username или числовой ID.\"\n          });\n        }\n        return res.status(400).json({ \n          message: \"Failed to check member status\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      // Return member info with friendly status\n      const member = result.result;\n      const friendlyStatus = {\n        'creator': 'Создатель',\n        'administrator': 'Администратор', \n        'member': 'Участник',\n        'restricted': 'Ограничен',\n        'left': 'Покинул группу',\n        'kicked': 'Исключен'\n      };\n\n      // Сохраняем участника в базе данных, если его там еще нет\n      try {\n        // Находим внутренний ID группы из botGroups таблицы\n        const group = await storage.getBotGroupByProjectAndGroupId(projectId, groupId);\n        if (group) {\n          // Проверяем, есть ли уже такой участник в базе\n          const existingMembers = await storage.getGroupMembers(group.id);\n          const existingMember = existingMembers.find(m => m.userId.toString() === userId);\n          \n          if (!existingMember) {\n            // Создаем нового участника\n            const memberData = {\n              groupId: group.id,\n              userId: parseInt(userId),\n              username: member.user?.username || null,\n              firstName: member.user?.first_name || null,\n              lastName: member.user?.last_name || null,\n              status: member.status,\n              isBot: member.user?.is_bot ? 1 : 0,\n              isActive: 1,\n              adminRights: member.status === 'administrator' ? {\n                can_change_info: member.can_change_info || false,\n                can_delete_messages: member.can_delete_messages || false,\n                can_restrict_members: member.can_restrict_members || false,\n                can_invite_users: member.can_invite_users || false,\n                can_pin_messages: member.can_pin_messages || false,\n                can_promote_members: member.can_promote_members || false,\n                can_manage_video_chats: member.can_manage_video_chats || false,\n                can_be_anonymous: member.is_anonymous || false\n              } : {},\n              customTitle: member.custom_title || null,\n              restrictions: {},\n              messageCount: 0,\n              lastSeen: new Date()\n            };\n            \n            await storage.createGroupMember(memberData);\n            console.log(`✅ Участник ${member.user?.first_name || userId} сохранен в базу данных`);\n          } else {\n            // Обновляем существующего участника\n            const updateData = {\n              status: member.status,\n              username: member.user?.username || existingMember.username,\n              firstName: member.user?.first_name || existingMember.firstName,\n              lastName: member.user?.last_name || existingMember.lastName,\n              isActive: 1,\n              adminRights: member.status === 'administrator' ? {\n                can_change_info: member.can_change_info || false,\n                can_delete_messages: member.can_delete_messages || false,\n                can_restrict_members: member.can_restrict_members || false,\n                can_invite_users: member.can_invite_users || false,\n                can_pin_messages: member.can_pin_messages || false,\n                can_promote_members: member.can_promote_members || false,\n                can_manage_video_chats: member.can_manage_video_chats || false,\n                can_be_anonymous: member.is_anonymous || false\n              } : {},\n              customTitle: member.custom_title || existingMember.customTitle,\n              restrictions: existingMember.restrictions || {},\n              messageCount: existingMember.messageCount || 0,\n              lastSeen: new Date()\n            };\n            \n            await storage.updateGroupMember(existingMember.id, updateData);\n            console.log(`✅ Участник ${member.user?.first_name || userId} обновлен в базе данных`);\n          }\n        }\n      } catch (dbError) {\n        console.error(\"Ошибка сохранения участника в базу:\", dbError);\n        // Не прерываем выполнение, просто логируем ошибку\n      }\n\n      const responseData = { \n        member: {\n          ...member,\n          friendlyStatus: friendlyStatus[member.status as keyof typeof friendlyStatus] || member.status\n        }\n      };\n      \n      console.log(\"Sending response:\", responseData);\n      res.json(responseData);\n    } catch (error) {\n      console.error(\"Failed to check member status:\", error);\n      res.status(500).json({ message: \"Failed to check member status\" });\n    }\n  });\n\n  // Get saved group members from database\n  app.get(\"/api/projects/:projectId/groups/:groupId/saved-members\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId } = req.params;\n      \n      if (!groupId || groupId === \"null\") {\n        return res.status(400).json({ message: \"Group ID is required\" });\n      }\n\n      // Находим внутренний ID группы из botGroups таблицы\n      const group = await storage.getBotGroupByProjectAndGroupId(projectId, groupId);\n      if (!group) {\n        return res.json({ members: [] }); // Возвращаем пустой список если группа не найдена\n      }\n\n      // Получаем сохраненных участников из базы данных\n      const savedMembers = await storage.getGroupMembers(group.id);\n      \n      // Преобразуем данные в формат, совместимый с фронтендом\n      const members = savedMembers.map(member => ({\n        user: {\n          id: member.userId,\n          username: member.username || undefined,\n          first_name: member.firstName || undefined,\n          last_name: member.lastName || undefined,\n          is_bot: member.isBot === 1\n        },\n        status: member.status,\n        custom_title: member.customTitle || undefined,\n        friendlyStatus: {\n          'creator': 'Создатель',\n          'administrator': 'Администратор', \n          'member': 'Участник',\n          'restricted': 'Ограничен',\n          'left': 'Покинул группу',\n          'kicked': 'Исключен'\n        }[member.status as keyof typeof member.status] || member.status,\n        savedFromDatabase: true, // Флаг для фронтенда\n        lastSeen: member.lastSeen,\n        messageCount: member.messageCount,\n        ...(typeof member.adminRights === 'object' && member.adminRights ? member.adminRights : {}) // Разворачиваем права администратора\n      }));\n\n      console.log(`✅ Загружено ${members.length} сохраненных участников группы ${groupId} из базы данных`);\n      res.json({ members });\n      \n    } catch (error) {\n      console.error(\"Failed to get saved group members:\", error);\n      res.status(500).json({ message: \"Failed to get saved group members\" });\n    }\n  });\n\n  // Ban group member\n  app.post(\"/api/projects/:projectId/bot/ban-member\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, userId, untilDate } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ message: \"Group ID and User ID are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/banChatMember`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          user_id: userId,\n          until_date: untilDate || undefined\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to ban member\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: \"Member banned successfully\" });\n    } catch (error) {\n      console.error(\"Failed to ban member:\", error);\n      res.status(500).json({ message: \"Failed to ban member\" });\n    }\n  });\n\n  // Unban group member\n  app.post(\"/api/projects/:projectId/bot/unban-member\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, userId } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ message: \"Group ID and User ID are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/unbanChatMember`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          user_id: userId,\n          only_if_banned: true\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to unban member\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: \"Member unbanned successfully\" });\n    } catch (error) {\n      console.error(\"Failed to unban member:\", error);\n      res.status(500).json({ message: \"Failed to unban member\" });\n    }\n  });\n\n  // Promote group member to admin\n  app.post(\"/api/projects/:projectId/bot/promote-member\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { \n        groupId, \n        userId, \n        can_manage_chat,\n        can_change_info,\n        can_delete_messages,\n        can_invite_users,\n        can_restrict_members,\n        can_pin_messages,\n        can_promote_members,\n        can_manage_video_chats\n      } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ message: \"Group ID and User ID are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      // Сначала проверяем, является ли пользователь участником группы\n      const memberCheckUrl = `https://api.telegram.org/bot${defaultToken.token}/getChatMember`;\n      const memberCheckResponse = await fetch(memberCheckUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          user_id: parseInt(userId)\n        })\n      });\n\n      const memberCheckResult = await memberCheckResponse.json();\n      \n      if (!memberCheckResponse.ok) {\n        if (memberCheckResult.error_code === 400 && memberCheckResult.description?.includes('user not found')) {\n          return res.status(400).json({\n            message: \"User is not a member of this group\",\n            error: \"Пользователь не является участником группы. Сначала пригласите пользователя в группу, а затем назначьте администратором.\"\n          });\n        }\n        return res.status(400).json({\n          message: \"Failed to check user membership\",\n          error: memberCheckResult.description || \"Unknown error\"\n        });\n      }\n\n      const memberStatus = memberCheckResult.result?.status;\n      if (memberStatus === 'left' || memberStatus === 'kicked') {\n        return res.status(400).json({\n          message: \"User is not a member of this group\",\n          error: \"Пользователь покинул группу или был исключен. Сначала пригласите пользователя в группу.\"\n        });\n      }\n\n      console.log('User membership status:', memberStatus);\n      console.log('Promoting user with rights:', {\n        groupId,\n        userId,\n        can_manage_chat,\n        can_change_info,\n        can_delete_messages,\n        can_invite_users,\n        can_restrict_members,\n        can_pin_messages,\n        can_promote_members,\n        can_manage_video_chats\n      });\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/promoteChatMember`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          user_id: parseInt(userId),\n          can_manage_chat: can_manage_chat !== undefined ? can_manage_chat : true,\n          can_change_info: can_change_info !== undefined ? can_change_info : true,\n          can_delete_messages: can_delete_messages !== undefined ? can_delete_messages : true,\n          can_invite_users: can_invite_users !== undefined ? can_invite_users : true,\n          can_restrict_members: can_restrict_members !== undefined ? can_restrict_members : true,\n          can_pin_messages: can_pin_messages !== undefined ? can_pin_messages : true,\n          can_promote_members: can_promote_members !== undefined ? can_promote_members : true,\n          can_manage_video_chats: can_manage_video_chats !== undefined ? can_manage_video_chats : true,\n          can_post_stories: true,\n          can_edit_stories: true,\n          can_delete_stories: true,\n          is_anonymous: true\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        console.error('Telegram API error:', result);\n        return res.status(400).json({ \n          message: \"Failed to promote member\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: \"Member promoted successfully\" });\n    } catch (error) {\n      console.error(\"Failed to promote member:\", error);\n      res.status(500).json({ message: \"Failed to promote member\" });\n    }\n  });\n\n  // Demote admin to regular member\n  app.post(\"/api/projects/:projectId/bot/demote-member\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, userId } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ message: \"Group ID and User ID are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/promoteChatMember`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          user_id: userId,\n          can_manage_chat: false,\n          can_change_info: false,\n          can_delete_messages: false,\n          can_invite_users: false,\n          can_restrict_members: false,\n          can_pin_messages: false,\n          can_promote_members: false,\n          can_manage_video_chats: false\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to demote member\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: \"Member demoted successfully\" });\n    } catch (error) {\n      console.error(\"Failed to demote member:\", error);\n      res.status(500).json({ message: \"Failed to demote member\" });\n    }\n  });\n\n  // Search user by username or ID for promotion\n  app.get(\"/api/projects/:projectId/bot/search-user/:query\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const query = req.params.query;\n      \n      if (!query) {\n        return res.status(400).json({ message: \"Search query is required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      // Сначала попробуем найти пользователя в локальной базе данных\n      const localUserBotData = await storage.searchUserBotData(projectId, query);\n      const localBotUsers = await storage.searchBotUsers(query);\n      \n      // Проверяем user_bot_data (специфично для проекта)\n      if (localUserBotData && localUserBotData.length > 0) {\n        const user = localUserBotData[0];\n        return res.json({\n          success: true,\n          user: {\n            id: parseInt(user.userId),\n            first_name: user.firstName,\n            last_name: user.lastName,\n            username: user.userName,\n            type: 'private'\n          },\n          userId: user.userId,\n          source: 'local_project'\n        });\n      }\n      \n      // Проверяем bot_users (глобальная таблица пользователей)\n      if (localBotUsers && localBotUsers.length > 0) {\n        const user = localBotUsers[0];\n        return res.json({\n          success: true,\n          user: {\n            id: user.userId,\n            first_name: user.firstName,\n            last_name: user.lastName,\n            username: user.username,\n            type: 'private'\n          },\n          userId: user.userId.toString(),\n          source: 'local_global'\n        });\n      }\n\n      // Если не найден в локальной базе, пробуем через Telegram API\n      const isNumeric = /^\\d+$/.test(query);\n      let userId = null;\n      \n      if (isNumeric) {\n        userId = query;\n      } else {\n        // Если это username, убираем @ если есть\n        const username = query.startsWith('@') ? query.slice(1) : query;\n        \n        // Для поиска по username нужно использовать getChatMember или getChat\n        // Но Bot API не предоставляет прямого поиска по username\n        // Поэтому попробуем сначала получить информацию через @username\n        try {\n          const chatResponse = await fetch(`https://api.telegram.org/bot${defaultToken.token}/getChat`, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify({\n              chat_id: `@${username}`\n            })\n          });\n          \n          const chatResult = await chatResponse.json();\n          if (chatResponse.ok && chatResult.result && chatResult.result.id) {\n            userId = chatResult.result.id.toString();\n          }\n        } catch (error) {\n          console.log('Username search failed, user might not have public username');\n        }\n      }\n      \n      if (!userId) {\n        return res.status(404).json({ \n          message: \"User not found\", \n          error: \"Пользователь не найден ни в локальной базе данных, ни через Telegram API. Убедитесь, что пользователь взаимодействовал с ботом или имеет публичный username.\" \n        });\n      }\n\n      // Получаем информацию о пользователе\n      const userResponse = await fetch(`https://api.telegram.org/bot${defaultToken.token}/getChat`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: userId\n        })\n      });\n\n      const userResult = await userResponse.json();\n      \n      if (!userResponse.ok) {\n        return res.status(400).json({ \n          message: \"Failed to get user info\", \n          error: userResult.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ \n        success: true, \n        user: userResult.result,\n        userId: userId,\n        source: 'telegram'\n      });\n    } catch (error) {\n      console.error(\"Failed to search user:\", error);\n      res.status(500).json({ message: \"Failed to search user\" });\n    }\n  });\n\n  // Restrict group member\n  app.post(\"/api/projects/:projectId/bot/restrict-member\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, userId, permissions, untilDate } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ message: \"Group ID and User ID are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/restrictChatMember`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          user_id: userId,\n          permissions: permissions,\n          until_date: untilDate || undefined\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        console.error(\"Bot API restrict member failed:\", result);\n        return res.status(400).json({ \n          message: \"Failed to restrict member\", \n          error: result.description || \"Unknown error\",\n          details: result\n        });\n      }\n\n      res.json({ success: true, message: \"Member restricted successfully\" });\n    } catch (error) {\n      console.error(\"Failed to restrict member:\", error);\n      res.status(500).json({ message: \"Failed to restrict member\" });\n    }\n  });\n\n  // Set group photo using Bot API\n  app.post(\"/api/projects/:projectId/bot/set-group-photo\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, photoPath } = req.body;\n      \n      if (!groupId || !photoPath) {\n        return res.status(400).json({ message: \"Group ID and photo path are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      // Читаем файл и отправляем через multipart/form-data\n      const fs = await import('fs');\n      const path = await import('path');\n      \n      const photoBuffer = fs.readFileSync(photoPath);\n      const fileName = path.basename(photoPath);\n      \n      // Создаем multipart form data вручную\n      const boundary = '----formdata-replit-' + Math.random().toString(36);\n      const CRLF = '\\r\\n';\n      \n      let body = '';\n      body += `--${boundary}${CRLF}`;\n      body += `Content-Disposition: form-data; name=\"chat_id\"${CRLF}${CRLF}`;\n      body += `${groupId}${CRLF}`;\n      body += `--${boundary}${CRLF}`;\n      body += `Content-Disposition: form-data; name=\"photo\"; filename=\"${fileName}\"${CRLF}`;\n      body += `Content-Type: image/png${CRLF}${CRLF}`;\n      \n      const bodyBuffer = Buffer.concat([\n        Buffer.from(body, 'utf8'),\n        photoBuffer,\n        Buffer.from(`${CRLF}--${boundary}--${CRLF}`, 'utf8')\n      ]);\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/setChatPhoto`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': `multipart/form-data; boundary=${boundary}`,\n          'Content-Length': bodyBuffer.length.toString(),\n        },\n        body: bodyBuffer,\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to set group photo\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: \"Group photo updated successfully\" });\n    } catch (error: any) {\n      console.error(\"Failed to set group photo:\", error);\n      res.status(500).json({ \n        message: \"Failed to set group photo\", \n        error: error.message || \"Unknown error\"\n      });\n    }\n  });\n\n  // Set group title\n  app.post(\"/api/projects/:projectId/bot/set-group-title\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, title } = req.body;\n      \n      if (!groupId || !title) {\n        return res.status(400).json({ message: \"Group ID and title are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/setChatTitle`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          title: title\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to set group title\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: \"Group title updated successfully\" });\n    } catch (error) {\n      console.error(\"Failed to set group title:\", error);\n      res.status(500).json({ message: \"Failed to set group title\" });\n    }\n  });\n\n  // Set group description\n  app.post(\"/api/projects/:projectId/bot/set-group-description\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, description } = req.body;\n      \n      if (!groupId || !description) {\n        return res.status(400).json({ message: \"Group ID and description are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/setChatDescription`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          description: description\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to set group description\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: \"Group description updated successfully\" });\n    } catch (error) {\n      console.error(\"Failed to set group description:\", error);\n      res.status(500).json({ message: \"Failed to set group description\" });\n    }\n  });\n\n  // Set group username (make public/private)\n  app.post(\"/api/projects/:projectId/bot/set-group-username\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, username } = req.body;\n      \n      if (!groupId) {\n        return res.status(400).json({ message: \"Group ID is required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      // Для установки username нужны права создателя или админа, используем Client API если доступен\n      try {\n        // Проверяем есть ли Telegram Client API доступ\n        const clientManager = telegramClientManager;\n        if (clientManager) {\n          // Пытаемся использовать Client API для установки username\n          const result = await clientManager.setChatUsername('default', groupId, username);\n          \n          res.json({ \n            success: true, \n            message: username ? \"Group username set successfully\" : \"Group made private successfully\",\n            result \n          });\n          return;\n        }\n      } catch (clientError) {\n        console.log(\"Client API не доступен, используем Bot API:\", clientError);\n      }\n\n      // Fallback: используем Bot API (ограниченная функциональность)\n      // Bot API не может изменять username, только создатель через Client API\n      return res.status(400).json({ \n        message: \"Setting group username requires creator/admin privileges. Please use Telegram Client API authorization.\",\n        requiresClientApi: true\n      });\n\n    } catch (error) {\n      console.error(\"Failed to set group username:\", error);\n      res.status(500).json({ message: \"Failed to set group username\" });\n    }\n  });\n\n  // Pin message in group\n  app.post(\"/api/projects/:projectId/bot/pin-message\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, messageId, disableNotification } = req.body;\n      \n      if (!groupId || !messageId) {\n        return res.status(400).json({ message: \"Group ID and message ID are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/pinChatMessage`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          message_id: messageId,\n          disable_notification: disableNotification || false\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to pin message\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: \"Message pinned successfully\" });\n    } catch (error) {\n      console.error(\"Failed to pin message:\", error);\n      res.status(500).json({ message: \"Failed to pin message\" });\n    }\n  });\n\n  // Unpin message in group\n  app.post(\"/api/projects/:projectId/bot/unpin-message\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, messageId } = req.body;\n      \n      if (!groupId) {\n        return res.status(400).json({ message: \"Group ID is required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = messageId \n        ? `https://api.telegram.org/bot${defaultToken.token}/unpinChatMessage`\n        : `https://api.telegram.org/bot${defaultToken.token}/unpinAllChatMessages`;\n        \n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          ...(messageId && { message_id: messageId })\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to unpin message\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: messageId ? \"Message unpinned successfully\" : \"All messages unpinned successfully\" });\n    } catch (error) {\n      console.error(\"Failed to unpin message:\", error);\n      res.status(500).json({ message: \"Failed to unpin message\" });\n    }\n  });\n\n  // Create new invite link for group\n  app.post(\"/api/projects/:projectId/bot/create-invite-link\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, name, expireDate, memberLimit, createsJoinRequest } = req.body;\n      \n      if (!groupId) {\n        return res.status(400).json({ message: \"Group ID is required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/createChatInviteLink`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          name: name || undefined,\n          expire_date: expireDate || undefined,\n          member_limit: memberLimit || undefined,\n          creates_join_request: createsJoinRequest || false\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to create invite link\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ \n        success: true, \n        inviteLink: result.result,\n        message: \"Invite link created successfully\" \n      });\n    } catch (error) {\n      console.error(\"Failed to create invite link:\", error);\n      res.status(500).json({ message: \"Failed to create invite link\" });\n    }\n  });\n\n  // Delete message in group\n  app.post(\"/api/projects/:projectId/bot/delete-message\", async (req, res) => {\n    try {\n      const projectId = parseInt(req.params.projectId);\n      const { groupId, messageId } = req.body;\n      \n      if (!groupId || !messageId) {\n        return res.status(400).json({ message: \"Group ID and message ID are required\" });\n      }\n\n      const defaultToken = await storage.getDefaultBotToken(projectId);\n      if (!defaultToken) {\n        return res.status(400).json({ message: \"Bot token not found for this project\" });\n      }\n\n      const telegramApiUrl = `https://api.telegram.org/bot${defaultToken.token}/deleteMessage`;\n      const response = await fetch(telegramApiUrl, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          chat_id: groupId,\n          message_id: messageId\n        })\n      });\n\n      const result = await response.json();\n      \n      if (!response.ok) {\n        return res.status(400).json({ \n          message: \"Failed to delete message\", \n          error: result.description || \"Unknown error\"\n        });\n      }\n\n      res.json({ success: true, message: \"Message deleted successfully\" });\n    } catch (error) {\n      console.error(\"Failed to delete message:\", error);\n      res.status(500).json({ message: \"Failed to delete message\" });\n    }\n  });\n\n  // Telegram Client API endpoints\n  \n  // Save user Telegram API credentials\n  app.post(\"/api/telegram-settings\", async (req, res) => {\n    try {\n      const { userId, apiId, apiHash, phoneNumber } = req.body;\n      \n      if (!userId || !apiId || !apiHash) {\n        return res.status(400).json({ \n          message: \"userId, apiId, and apiHash are required\" \n        });\n      }\n\n      // Here we would save to database - for now, return success\n      // TODO: Implement storage.createUserTelegramSettings()\n      \n      res.json({ \n        message: \"Telegram API credentials saved successfully\",\n        success: true \n      });\n    } catch (error) {\n      console.error(\"Failed to save Telegram API credentials:\", error);\n      res.status(500).json({ message: \"Failed to save credentials\" });\n    }\n  });\n\n  // Get group members using Telegram Client API\n  app.get(\"/api/projects/:projectId/telegram-client/group-members/:groupId\", async (req, res) => {\n    try {\n      const { groupId } = req.params;\n      \n      // Check if API credentials are available\n      const apiId = process.env.TELEGRAM_API_ID;\n      const apiHash = process.env.TELEGRAM_API_HASH;\n      \n      if (!apiId || !apiHash) {\n        console.log('⚠️ CLIENT API: Telegram API credentials not configured, returning demo data');\n        \n        // Return demo data when credentials are not configured\n        return res.json({\n          success: true,\n          message: \"🎭 Демо-режим: показаны примерные участники\",\n          explanation: \"Для получения реальных данных настройте TELEGRAM_API_ID и TELEGRAM_API_HASH\",\n          groupId,\n          memberCount: 3,\n          members: [\n            {\n              id: 123456789,\n              username: \"demo_user1\",\n              firstName: \"Демо\",\n              lastName: \"Пользователь 1\",\n              isBot: false,\n              status: \"active\",\n              joinedAt: new Date().toISOString(),\n              source: \"demo_data\"\n            },\n            {\n              id: 987654321,\n              username: \"demo_user2\", \n              firstName: \"Демо\",\n              lastName: \"Пользователь 2\",\n              isBot: false,\n              status: \"active\",\n              joinedAt: new Date().toISOString(),\n              source: \"demo_data\"\n            },\n            {\n              id: 555666777,\n              username: \"demo_bot\",\n              firstName: \"Демо\",\n              lastName: \"Бот\",\n              isBot: true,\n              status: \"active\",\n              joinedAt: new Date().toISOString(),\n              source: \"demo_data\"\n            }\n          ],\n          isDemoMode: true,\n          note: \"Это демонстрационные данные. Для получения реальных участников настройте API credentials.\"\n        });\n      }\n\n      console.log(`🔍 CLIENT API: Получение участников группы ${groupId} через Client API`);\n\n      try {\n        // Try to use real Telegram Client API to get group members\n        const members = await telegramClientManager.getGroupMembers('default', groupId);\n        \n        if (members && members.length > 0) {\n          console.log(`✅ CLIENT API: Найдено ${members.length} реальных участников группы`);\n          \n          res.json({\n            success: true,\n            message: `✅ Получен полный список участников через Client API`,\n            explanation: \"Client API позволяет получить всех участников группы, а не только администраторов\",\n            groupId,\n            memberCount: members.length,\n            members: members.map((member: any) => ({\n              id: member.id,\n              username: member.username,\n              firstName: member.firstName,\n              lastName: member.lastName,\n              isBot: member.isBot,\n              status: member.status,\n              joinedAt: member.joinedAt,\n              source: \"client_api\"\n            })),\n            advantages: [\n              `Показывает всех участников группы (${members.length} реальных участников)`,\n              \"Включает обычных пользователей, не только админов\", \n              \"Предоставляет полную информацию о пользователях\",\n              \"Обходит ограничения Bot API\"\n            ]\n          });\n        } else {\n          throw new Error('No members found or Client API not connected');\n        }\n      } catch (error: any) {\n        console.log(`⚠️ CLIENT API: Ошибка получения реальных данных: ${error?.message || 'Unknown error'}`);\n        console.log('📝 CLIENT API: Требуется настройка Telegram клиента');\n        \n        res.status(400).json({\n          success: false,\n          message: \"❌ Client API требует настройки\",\n          explanation: \"Для получения полного списка участников необходимо настроить Telegram Client API с номером телефона\",\n          groupId,\n          error: error?.message || 'Unknown error',\n          requirements: [\n            \"Подключение к Telegram Client API с номером телефона\",\n            \"Авторизация через код подтверждения\",\n            \"Права доступа к данным группы\"\n          ],\n          note: \"Bot API показывает только администраторов, Client API может показать всех участников\"\n        });\n      }\n    } catch (error) {\n      console.error(\"Failed to get group members via Client API:\", error);\n      res.status(500).json({ message: \"Failed to get group members via Client API\" });\n    }\n  });\n\n  // Send verification code to phone number\n  app.post(\"/api/telegram-auth/send-code\", async (req, res) => {\n    try {\n      const { phoneNumber } = req.body;\n      \n      if (!phoneNumber) {\n        return res.status(400).json({\n          success: false,\n          error: \"Номер телефона обязателен\"\n        });\n      }\n\n      const result = await telegramClientManager.sendCode('default', phoneNumber);\n      \n      if (result.success) {\n        res.json({\n          success: true,\n          message: \"Код отправлен на ваш номер\",\n          phoneCodeHash: result.phoneCodeHash\n        });\n      } else {\n        res.status(400).json({\n          success: false,\n          error: result.error\n        });\n      }\n    } catch (error: any) {\n      console.error(\"Failed to send verification code:\", error);\n      res.status(500).json({ \n        success: false,\n        error: \"Ошибка отправки кода\" \n      });\n    }\n  });\n\n  // Verify phone code\n  app.post(\"/api/telegram-auth/verify-code\", async (req, res) => {\n    try {\n      const { phoneNumber, phoneCode, phoneCodeHash } = req.body;\n      \n      if (!phoneNumber || !phoneCode || !phoneCodeHash) {\n        return res.status(400).json({\n          success: false,\n          error: \"Все поля обязательны\"\n        });\n      }\n\n      const result = await telegramClientManager.verifyCode('default', phoneNumber, phoneCode, phoneCodeHash);\n      \n      if (result.success) {\n        res.json({\n          success: true,\n          message: \"Авторизация успешна\"\n        });\n      } else if (result.needsPassword) {\n        // Когда требуется пароль 2FA - это не ошибка, а нормальная часть процесса\n        res.json({\n          success: false,\n          error: result.error,\n          needsPassword: true\n        });\n      } else {\n        res.status(400).json({\n          success: false,\n          error: result.error\n        });\n      }\n    } catch (error: any) {\n      console.error(\"Failed to verify code:\", error);\n      res.status(500).json({ \n        success: false,\n        error: \"Ошибка проверки кода\" \n      });\n    }\n  });\n\n  // Verify 2FA password\n  app.post(\"/api/telegram-auth/verify-password\", async (req, res) => {\n    try {\n      const { password } = req.body;\n      \n      if (!password) {\n        return res.status(400).json({\n          success: false,\n          error: \"Пароль обязателен\"\n        });\n      }\n\n      const result = await telegramClientManager.verifyPassword('default', password);\n      \n      if (result.success) {\n        res.json({\n          success: true,\n          message: \"Авторизация с 2FA успешна\"\n        });\n      } else {\n        res.status(400).json({\n          success: false,\n          error: result.error\n        });\n      }\n    } catch (error: any) {\n      console.error(\"Failed to verify password:\", error);\n      res.status(500).json({ \n        success: false,\n        error: \"Ошибка проверки пароля\" \n      });\n    }\n  });\n\n  // Save API credentials\n  app.post(\"/api/telegram-auth/save-credentials\", async (req, res) => {\n    try {\n      const { apiId, apiHash } = req.body;\n      \n      if (!apiId || !apiHash) {\n        return res.status(400).json({\n          success: false,\n          error: \"API ID и API Hash обязательны\"\n        });\n      }\n\n      const result = await telegramClientManager.setCredentials('default', apiId, apiHash);\n      \n      if (result.success) {\n        res.json({\n          success: true,\n          message: \"API credentials сохранены\"\n        });\n      } else {\n        res.status(400).json({\n          success: false,\n          error: result.error\n        });\n      }\n    } catch (error: any) {\n      console.error(\"Failed to save credentials:\", error);\n      res.status(500).json({ \n        success: false,\n        error: \"Ошибка сохранения credentials\" \n      });\n    }\n  });\n\n  // Get authentication status\n  app.get(\"/api/telegram-auth/status\", async (req, res) => {\n    try {\n      const status = await telegramClientManager.getAuthStatus('default');\n      res.json(status);\n    } catch (error: any) {\n      console.error(\"Failed to get auth status:\", error);\n      res.status(500).json({ \n        isAuthenticated: false,\n        error: \"Ошибка получения статуса авторизации\" \n      });\n    }\n  });\n\n  // Client API роуты для управления участниками\n  \n  // Исключить участника через Client API\n  app.post(\"/api/projects/:projectId/telegram-client/kick-member\", async (req, res) => {\n    try {\n      const { groupId, userId } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ \n          success: false, \n          message: \"Group ID и User ID обязательны\" \n        });\n      }\n\n      const result = await telegramClientManager.kickMember('default', groupId, userId);\n      \n      res.json({\n        success: true,\n        message: \"Участник успешно исключен через Client API\"\n      });\n    } catch (error: any) {\n      console.error(\"Failed to kick member via Client API:\", error);\n      res.status(500).json({ \n        success: false,\n        message: \"Ошибка при исключении участника\",\n        error: error.message || \"Unknown error\"\n      });\n    }\n  });\n\n  // Заблокировать участника через Client API\n  app.post(\"/api/projects/:projectId/telegram-client/ban-member\", async (req, res) => {\n    try {\n      const { groupId, userId, untilDate } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ \n          success: false, \n          message: \"Group ID и User ID обязательны\" \n        });\n      }\n\n      const result = await telegramClientManager.banMember('default', groupId, userId, untilDate);\n      \n      res.json({\n        success: true,\n        message: \"Участник успешно заблокирован через Client API\"\n      });\n    } catch (error: any) {\n      console.error(\"Failed to ban member via Client API:\", error);\n      res.status(500).json({ \n        success: false,\n        message: \"Ошибка при блокировке участника\",\n        error: error.message || \"Unknown error\"\n      });\n    }\n  });\n\n  // Замутить участника через Client API\n  app.post(\"/api/projects/:projectId/telegram-client/restrict-member\", async (req, res) => {\n    try {\n      const { groupId, userId, untilDate } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ \n          success: false, \n          message: \"Group ID и User ID обязательны\" \n        });\n      }\n\n      const result = await telegramClientManager.restrictMember('default', groupId, userId, untilDate);\n      \n      res.json({\n        success: true,\n        message: \"Участник успешно замучен через Client API\"\n      });\n    } catch (error: any) {\n      console.error(\"Failed to restrict member via Client API:\", error);\n      res.status(500).json({ \n        success: false,\n        message: \"Ошибка при заглушении участника\",\n        error: error.message || \"Unknown error\"\n      });\n    }\n  });\n\n  // Назначить администратора через Client API\n  app.post(\"/api/projects/:projectId/telegram-client/promote-member\", async (req, res) => {\n    try {\n      const { groupId, userId, adminRights } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ \n          success: false, \n          message: \"Group ID и User ID обязательны\" \n        });\n      }\n\n      const result = await telegramClientManager.promoteMember('default', groupId, userId, adminRights);\n      \n      res.json({\n        success: true,\n        message: \"Участник успешно назначен администратором через Client API\"\n      });\n    } catch (error: any) {\n      console.error(\"Failed to promote member via Client API:\", error);\n      res.status(500).json({ \n        success: false,\n        message: \"Ошибка при назначении администратора\",\n        error: error.message || \"Unknown error\"\n      });\n    }\n  });\n\n  // Снять администраторские права через Client API\n  app.post(\"/api/projects/:projectId/telegram-client/demote-member\", async (req, res) => {\n    try {\n      const { groupId, userId } = req.body;\n      \n      if (!groupId || !userId) {\n        return res.status(400).json({ \n          success: false, \n          message: \"Group ID и User ID обязательны\" \n        });\n      }\n\n      const result = await telegramClientManager.demoteMember('default', groupId, userId);\n      \n      res.json({\n        success: true,\n        message: \"Администраторские права успешно сняты через Client API\"\n      });\n    } catch (error: any) {\n      console.error(\"Failed to demote member via Client API:\", error);\n      res.status(500).json({ \n        success: false,\n        message: \"Ошибка при снятии администраторских прав\",\n        error: error.message || \"Unknown error\"\n      });\n    }\n  });\n\n  // Force update templates - Admin endpoint to refresh all system templates\n  app.post(\"/api/templates/refresh\", async (req, res) => {\n    try {\n      console.log(\"🔄 Принудительное обновление шаблонов...\");\n      await seedDefaultTemplates(true); // force = true\n      console.log(\"✅ Шаблоны обновлены успешно\");\n      res.json({ \n        message: \"Templates updated successfully\",\n        timestamp: new Date().toISOString()\n      });\n    } catch (error) {\n      console.error(\"❌ Ошибка обновления шаблонов:\", error);\n      res.status(500).json({ \n        message: \"Failed to update templates\",\n        error: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n\n","size_bytes":223890},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/components/editor/export-modal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\nimport { useIsMobile } from '@/hooks/use-mobile';\n// Динамический импорт тяжелых генераторов для улучшения производительности\nconst loadBotGenerator = () => import('@/lib/bot-generator');\nconst loadCommands = () => import('@/lib/commands');\nimport { BotData, BotGroup } from '@shared/schema';\nimport { useState, useEffect, useMemo } from 'react';\nimport { useQuery } from '@tanstack/react-query';\n\ninterface ExportModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  botData: BotData;\n  projectName: string;\n}\n\ntype ExportFormat = 'python' | 'json' | 'requirements' | 'readme' | 'dockerfile' | 'config';\n\nexport function ExportModal({ isOpen, onClose, botData, projectName }: ExportModalProps) {\n  const [generatedCode, setGeneratedCode] = useState('');\n  const [selectedFormat, setSelectedFormat] = useState<ExportFormat>('python');\n  const [exportContent, setExportContent] = useState<Record<ExportFormat, string>>({\n    python: '',\n    json: '',\n    requirements: '',\n    readme: '',\n    dockerfile: '',\n    config: ''\n  });\n  const [validationResult, setValidationResult] = useState<{ isValid: boolean; errors: string[] }>({ isValid: true, errors: [] });\n  const [botFatherCommands, setBotFatherCommands] = useState('');\n  const { toast } = useToast();\n  const isMobile = useIsMobile();\n\n  // Загрузка групп\n  const { data: groups = [] } = useQuery<BotGroup[]>({\n    queryKey: ['/api/groups'],\n    enabled: isOpen\n  });\n\n  // Функция для сбора всех узлов из всех листов проекта\n  const getAllNodes = (data: BotData) => {\n    if (!data) return [];\n    \n    if ((data as any).sheets && Array.isArray((data as any).sheets)) {\n      // Многолистовой проект - собираем узлы из всех листов\n      let allNodes: any[] = [];\n      (data as any).sheets.forEach((sheet: any) => {\n        if (sheet.nodes && Array.isArray(sheet.nodes)) {\n          allNodes = allNodes.concat(sheet.nodes);\n        }\n      });\n      return allNodes;\n    } else {\n      // Обычный проект\n      return data.nodes || [];\n    }\n  };\n\n  // Статистика бота с учетом всех листов проекта\n  const allNodes = getAllNodes(botData);\n  const botStats = {\n    totalNodes: allNodes.length,\n    commandNodes: allNodes.filter(node => node.type === 'start' || node.type === 'command').length,\n    messageNodes: allNodes.filter(node => node.type === 'message').length,\n    photoNodes: allNodes.filter(node => node.type === 'photo').length,\n    keyboardNodes: allNodes.filter(node => node.data?.keyboardType !== 'none').length,\n    totalButtons: allNodes.reduce((sum, node) => sum + (node.data?.buttons?.length || 0), 0),\n    commandsInMenu: allNodes.filter(node => \n      (node.type === 'start' || node.type === 'command') && node.data?.showInMenu\n    ).length,\n    adminOnlyCommands: allNodes.filter(node => \n      (node.type === 'start' || node.type === 'command') && node.data?.adminOnly\n    ).length,\n    privateOnlyCommands: allNodes.filter(node => \n      (node.type === 'start' || node.type === 'command') && node.data?.isPrivateOnly\n    ).length\n  };\n\n  // Асинхронная ленивая генерация экспорта - только когда нужен конкретный формат\n  const generateExportContent = useMemo(() => {\n    if (!isOpen || !botData) return {};\n    \n    return {\n      python: async () => {\n        const botGenerator = await loadBotGenerator();\n        const validation = botGenerator.validateBotStructure(botData);\n        setValidationResult(validation || { isValid: false, errors: [] });\n        \n        if (!validation?.isValid) return '';\n        return botGenerator.generatePythonCode(botData, projectName, groups);\n      },\n      json: async () => JSON.stringify(botData, null, 2),\n      requirements: async () => {\n        const botGenerator = await loadBotGenerator();\n        return botGenerator.generateRequirementsTxt();\n      },\n      readme: async () => {\n        const botGenerator = await loadBotGenerator();\n        return botGenerator.generateReadme(botData, projectName);\n      },\n      dockerfile: async () => {\n        const botGenerator = await loadBotGenerator();\n        return botGenerator.generateDockerfile();\n      },\n      config: async () => {\n        const botGenerator = await loadBotGenerator();\n        return botGenerator.generateConfigYaml(projectName);\n      }\n    };\n  }, [isOpen, botData, projectName, groups]);\n\n  // Асинхронное получение контента для выбранного формата\n  useEffect(() => {\n    async function loadContent() {\n      if (!generateExportContent[selectedFormat] || exportContent[selectedFormat]) return;\n      \n      try {\n        const content = await generateExportContent[selectedFormat]();\n        setExportContent(prev => ({ ...prev, [selectedFormat]: content }));\n        \n        // Для Python также устанавливаем основной код\n        if (selectedFormat === 'python') {\n          setGeneratedCode(content);\n        }\n      } catch (error) {\n        console.error('Error loading export content:', error);\n        toast({\n          title: \"Ошибка генерации\",\n          description: \"Не удалось сгенерировать контент для экспорта\",\n          variant: \"destructive\",\n        });\n      }\n    }\n    \n    loadContent();\n  }, [generateExportContent, selectedFormat, exportContent, toast]);\n\n  // Получение текущего контента\n  const getCurrentContent = () => {\n    return exportContent[selectedFormat] || '';\n  };\n\n  // Получение свежих данных проекта с нормализацией при открытии\n  const [freshBotData, setFreshBotData] = useState<BotData | null>(null);\n  \n  useEffect(() => {\n    async function loadFreshProjectData() {\n      if (isOpen) {\n        try {\n          // Получаем ID проекта из URL\n          const projectId = window.location.pathname.split('/').pop();\n          if (projectId && !isNaN(Number(projectId))) {\n            console.log('🔄 ExportModal: Загружаем свежие данные проекта из API...');\n            const response = await fetch(`/api/projects/${projectId}`);\n            if (response.ok) {\n              const project = await response.json();\n              console.log('📡 ExportModal: Данные проекта получены:', project);\n              // Устанавливаем свежие данные с нормализацией\n              if (project.data) {\n                console.log('✅ ExportModal: Устанавливаем свежие данные:', project.data);\n                setFreshBotData(project.data);\n              }\n            } else {\n              console.error('❌ ExportModal: Ошибка загрузки данных проекта:', response.status);\n            }\n          }\n        } catch (error) {\n          console.error('Error loading fresh project data:', error);\n        }\n      }\n    }\n    \n    loadFreshProjectData();\n  }, [isOpen]);\n\n  // Генерация команд BotFather с использованием свежих данных\n  useEffect(() => {\n    async function loadBotFatherCommands() {\n      const dataToUse = freshBotData || botData;\n      if (isOpen && dataToUse) {\n        try {\n          const commands = await loadCommands();\n          console.log('🔍 ExportModal: Полные данные для генерации команд:', dataToUse);\n          \n          // Собираем узлы из всех листов проекта\n          let nodes: any[] = [];\n          if ((dataToUse as any).sheets && Array.isArray((dataToUse as any).sheets)) {\n            // Многолистовой проект - собираем узлы из всех листов\n            console.log('📊 ExportModal: Найдено листов:', (dataToUse as any).sheets.length);\n            (dataToUse as any).sheets.forEach((sheet: any, index: number) => {\n              console.log(`📋 ExportModal: Лист ${index + 1} (${sheet.name || sheet.id}):`, sheet.nodes?.length || 0, 'узлов');\n              if (sheet.nodes && Array.isArray(sheet.nodes)) {\n                nodes = nodes.concat(sheet.nodes);\n              }\n            });\n          } else {\n            console.log('📋 ExportModal: Обычный проект, узлов:', dataToUse.nodes?.length || 0);\n            // Обычный проект\n            nodes = dataToUse.nodes || [];\n          }\n          \n          console.log('🎯 ExportModal: ИТОГО узлов из всех листов:', nodes.length);\n\n          const commandNodes = nodes.filter((node: any) => \n            (node.type === 'start' || node.type === 'command') && \n            node.data?.command &&\n            (node.data?.showInMenu !== false) // Включаем команды где showInMenu = true, undefined или не установлено\n          );\n          console.log('🎯 ExportModal: Команды для меню BotFather:', commandNodes.length, 'команд');\n          \n          const botFatherCmds = commands.generateBotFatherCommands(commandNodes); // ✅ Передаем только команды!\n          setBotFatherCommands(botFatherCmds);\n        } catch (error) {\n          console.error('Error loading BotFather commands:', error);\n        }\n      }\n    }\n    \n    loadBotFatherCommands();\n  }, [isOpen, freshBotData, botData]);\n\n  const getFileExtension = (format: ExportFormat): string => {\n    const extensions = {\n      python: 'py',\n      json: 'json',\n      requirements: 'txt',\n      readme: 'md',\n      dockerfile: '',\n      config: 'yaml'\n    };\n    return extensions[format];\n  };\n\n  const getFileName = (format: ExportFormat): string => {\n    const baseFileName = projectName.replace(/\\s+/g, '_');\n    const names = {\n      python: `${baseFileName}_bot.py`,\n      json: `${baseFileName}_data.json`,\n      requirements: 'requirements.txt',\n      readme: 'README.md',\n      dockerfile: 'Dockerfile',\n      config: 'config.yaml'\n    };\n    return names[format];\n  };\n\n  const copyToClipboard = async (content?: string) => {\n    const textToCopy = content || getCurrentContent();\n    try {\n      await navigator.clipboard.writeText(textToCopy);\n      toast({\n        title: \"Содержимое скопировано!\",\n        description: \"Содержимое скопировано в буфер обмена\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Ошибка копирования\",\n        description: \"Не удалось скопировать содержимое в буфер обмена\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const downloadFile = async (format?: ExportFormat) => {\n    const formatToDownload = format || selectedFormat;\n    const content = formatToDownload === selectedFormat ? getCurrentContent() : \n      (generateExportContent[formatToDownload] ? await generateExportContent[formatToDownload]() : '');\n    const fileName = getFileName(formatToDownload);\n    \n    const blob = new Blob([content], { type: 'text/plain' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = fileName;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n    \n    toast({\n      title: \"Файл загружен!\",\n      description: `Файл ${fileName} сохранен`,\n    });\n  };\n\n  const downloadAllFiles = () => {\n    const formats: ExportFormat[] = ['python', 'json', 'requirements', 'readme', 'dockerfile', 'config'];\n    formats.forEach(format => {\n      setTimeout(() => downloadFile(format), formats.indexOf(format) * 100);\n    });\n    \n    toast({\n      title: \"Все файлы загружены!\",\n      description: \"Полный проект бота загружен\",\n    });\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className={`${isMobile ? 'max-w-[95vw] max-h-[95vh] w-full' : 'max-w-7xl max-h-[85vh] w-[95vw]'} flex flex-col overflow-hidden`}>\n        <DialogHeader className=\"pb-2\">\n          <DialogTitle className=\"flex items-center space-x-3\">\n            <i className=\"fas fa-download text-primary\"></i>\n            <span className={`${isMobile ? 'text-sm' : ''}`}>Экспорт кода бота</span>\n          </DialogTitle>\n        </DialogHeader>\n\n        <Tabs defaultValue=\"stats\" className=\"flex flex-col flex-1 mt-2 min-h-0\">\n          {isMobile ? (\n            <div className=\"flex-shrink-0 space-y-2\">\n              <TabsList className=\"grid w-full grid-cols-3 h-auto gap-1\">\n                <TabsTrigger value=\"stats\" className=\"text-xs py-2 px-1\" data-testid=\"tab-stats\">Статистика</TabsTrigger>\n                <TabsTrigger value=\"validation\" className=\"text-xs py-2 px-1\" data-testid=\"tab-validation\">Валидация</TabsTrigger>\n                <TabsTrigger value=\"files\" className=\"text-xs py-2 px-1\" data-testid=\"tab-files\">Файлы</TabsTrigger>\n              </TabsList>\n              <TabsList className=\"grid w-full grid-cols-2 h-auto gap-1\">\n                <TabsTrigger value=\"setup\" className=\"text-xs py-2 px-1\" data-testid=\"tab-setup\">Настройка</TabsTrigger>\n                <TabsTrigger value=\"export\" className=\"text-xs py-2 px-1\" data-testid=\"tab-export\">Экспорт</TabsTrigger>\n              </TabsList>\n            </div>\n          ) : (\n            <TabsList className=\"grid w-full grid-cols-5 flex-shrink-0\">\n              <TabsTrigger value=\"stats\" data-testid=\"tab-stats\">Статистика</TabsTrigger>\n              <TabsTrigger value=\"validation\" data-testid=\"tab-validation\">Валидация</TabsTrigger>\n              <TabsTrigger value=\"files\" data-testid=\"tab-files\">Файлы</TabsTrigger>\n              <TabsTrigger value=\"export\" data-testid=\"tab-export\">Экспорт</TabsTrigger>\n              <TabsTrigger value=\"setup\" data-testid=\"tab-setup\">Настройка</TabsTrigger>\n            </TabsList>\n          )}\n\n          <TabsContent value=\"stats\" className=\"space-y-4 overflow-y-auto flex-1 min-h-0\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <i className=\"fas fa-chart-bar text-blue-500\"></i>\n                  <span>Статистика бота</span>\n                </CardTitle>\n                <CardDescription>Обзор структуры и компонентов вашего бота</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'grid-cols-2 md:grid-cols-3 gap-4'}`}>\n                  <div className={`bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                    <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-blue-600 dark:text-blue-400`}>{botStats.totalNodes}</div>\n                    <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-blue-700 dark:text-blue-300`}>Всего узлов</div>\n                  </div>\n                  <div className={`bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                    <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-green-600 dark:text-green-400`}>{botStats.commandNodes}</div>\n                    <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-green-700 dark:text-green-300`}>Команд</div>\n                  </div>\n                  <div className={`bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                    <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-purple-600 dark:text-purple-400`}>{botStats.totalButtons}</div>\n                    <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-purple-700 dark:text-purple-300`}>Кнопок</div>\n                  </div>\n                  <div className={`bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                    <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-amber-600 dark:text-amber-400`}>{botStats.keyboardNodes}</div>\n                    <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-amber-700 dark:text-amber-300`}>С клавиатурой</div>\n                  </div>\n                  <div className={`bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                    <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-indigo-600 dark:text-indigo-400`}>{botStats.commandsInMenu}</div>\n                    <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-indigo-700 dark:text-indigo-300`}>В меню</div>\n                  </div>\n                  <div className={`bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                    <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-red-600 dark:text-red-400`}>{botStats.adminOnlyCommands}</div>\n                    <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-red-700 dark:text-red-300`}>Только админ</div>\n                  </div>\n                </div>\n                \n                <Separator className=\"my-4\" />\n                \n                <div className={`space-y-${isMobile ? '4' : '3'}`}>\n                  <h4 className={`${isMobile ? 'font-semibold text-lg' : 'font-medium'}`}>Детальная статистика:</h4>\n                  <div className={`space-y-${isMobile ? '3' : '2'} ${isMobile ? 'text-base' : 'text-sm'}`}>\n                    <div className={`flex justify-between items-center ${isMobile ? 'py-2' : ''}`}>\n                      <span className={`${isMobile ? 'font-medium' : ''}`}>Текстовые сообщения:</span>\n                      <Badge variant=\"secondary\" className={`${isMobile ? 'text-base px-3 py-1' : ''}`}>{botStats.messageNodes}</Badge>\n                    </div>\n                    <div className={`flex justify-between items-center ${isMobile ? 'py-2' : ''}`}>\n                      <span className={`${isMobile ? 'font-medium' : ''}`}>Фото сообщения:</span>\n                      <Badge variant=\"secondary\" className={`${isMobile ? 'text-base px-3 py-1' : ''}`}>{botStats.photoNodes}</Badge>\n                    </div>\n                    <div className={`flex justify-between items-center ${isMobile ? 'py-2' : ''}`}>\n                      <span className={`${isMobile ? 'font-medium' : ''}`}>Приватные команды:</span>\n                      <Badge variant=\"outline\" className={`${isMobile ? 'text-base px-3 py-1' : ''}`}>{botStats.privateOnlyCommands}</Badge>\n                    </div>\n                    <div className={`flex justify-between items-center ${isMobile ? 'py-2' : ''}`}>\n                      <span className={`${isMobile ? 'font-medium' : ''}`}>Соединения между узлами:</span>\n                      <Badge variant=\"outline\" className={`${isMobile ? 'text-base px-3 py-1' : ''}`}>{botData?.connections?.length || 0}</Badge>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"validation\" className=\"space-y-4 overflow-y-auto flex-1 min-h-0\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center space-x-2\">\n                  {validationResult.isValid ? (\n                    <i className=\"fas fa-check-circle text-green-500\"></i>\n                  ) : (\n                    <i className=\"fas fa-exclamation-triangle text-red-500\"></i>\n                  )}\n                  <span>Проверка структуры бота</span>\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {validationResult.isValid ? (\n                  <div className=\"flex items-center space-x-2 text-green-600 dark:text-green-400 p-4 bg-green-50 dark:bg-green-950/30 rounded-lg border border-green-200 dark:border-green-800/40\">\n                    <i className=\"fas fa-check-circle\"></i>\n                    <span className=\"font-medium\">Структура бота корректна и готова к экспорту!</span>\n                  </div>\n                ) : (\n                  <div className=\"space-y-4\">\n                    <div className=\"flex items-center space-x-2 text-red-600 dark:text-red-400 p-3 bg-red-50 dark:bg-red-950/30 rounded-lg border border-red-200 dark:border-red-800/40\">\n                      <i className=\"fas fa-exclamation-triangle\"></i>\n                      <span className=\"font-medium\">Найдены ошибки в структуре бота:</span>\n                    </div>\n                    <div className=\"space-y-2\">\n                      {(validationResult.errors || []).map((error, index) => (\n                        <div key={index} className=\"flex items-start space-x-2 p-3 bg-red-50 dark:bg-red-950/20 rounded border-l-4 border-red-200 dark:border-red-800/60\">\n                          <i className=\"fas fa-times-circle text-red-500 dark:text-red-400 mt-0.5\"></i>\n                          <span className=\"text-sm text-red-700 dark:text-red-300\">{error}</span>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"files\" className=\"space-y-4 overflow-y-auto flex-1 min-h-0\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <i className=\"fas fa-file-archive text-blue-500\"></i>\n                  <span>Экспорт файлов проекта</span>\n                </CardTitle>\n                <CardDescription>Выберите формат для экспорта или загрузите все файлы</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className={`${isMobile ? 'flex flex-col space-y-4' : 'flex items-center justify-between'}`}>\n                  <div className={`${isMobile ? 'w-full' : 'flex items-center space-x-4'}`}>\n                    <Select value={selectedFormat} onValueChange={(value: ExportFormat) => setSelectedFormat(value)}>\n                      <SelectTrigger className={`${isMobile ? 'w-full h-12 text-base' : 'w-[200px]'}`} data-testid=\"select-format-files\">\n                        <SelectValue placeholder=\"Выберите формат\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"python\">Python код (.py)</SelectItem>\n                        <SelectItem value=\"json\">JSON данные (.json)</SelectItem>\n                        <SelectItem value=\"requirements\">Зависимости (.txt)</SelectItem>\n                        <SelectItem value=\"readme\">Документация (.md)</SelectItem>\n                        <SelectItem value=\"dockerfile\">Dockerfile</SelectItem>\n                        <SelectItem value=\"config\">Конфигурация (.yaml)</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className={`flex ${isMobile ? 'flex-col space-y-2' : 'space-x-2'}`}>\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => copyToClipboard()} className={`${isMobile ? 'w-full' : ''}`}>\n                      <i className=\"fas fa-copy mr-2\"></i>\n                      Копировать\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => downloadFile()} className={`${isMobile ? 'w-full' : ''}`}>\n                      <i className=\"fas fa-download mr-2\"></i>\n                      Скачать\n                    </Button>\n                    <Button size=\"sm\" onClick={downloadAllFiles} className={`${isMobile ? 'w-full' : ''}`}>\n                      <i className=\"fas fa-archive mr-2\"></i>\n                      Скачать все\n                    </Button>\n                  </div>\n                </div>\n                \n                <Separator />\n                \n                {validationResult.isValid ? (\n                  <Textarea\n                    value={getCurrentContent()}\n                    readOnly\n                    className={`${isMobile ? 'min-h-[200px]' : 'min-h-[350px]'} font-mono ${isMobile ? 'text-xs' : 'text-sm'} bg-muted/50 dark:bg-muted/20 border-muted dark:border-muted/40 resize-none`}\n                    placeholder=\"Выберите формат для просмотра...\"\n                  />\n                ) : (\n                  <div className=\"p-4 bg-muted/50 dark:bg-muted/20 rounded-lg text-center text-muted-foreground border border-muted dark:border-muted/40\">\n                    <i className=\"fas fa-exclamation-triangle mb-2 text-yellow-500 dark:text-yellow-400\"></i>\n                    <p>Исправьте ошибки валидации для экспорта файлов</p>\n                  </div>\n                )}\n                \n                <div className={`grid ${isMobile ? 'grid-cols-1 gap-2' : 'grid-cols-2 md:grid-cols-3 gap-3'} mt-4`}>\n                  {(['python', 'json', 'requirements', 'readme', 'dockerfile', 'config'] as ExportFormat[]).map(format => (\n                    <div key={format} className={`${isMobile ? 'p-2' : 'p-3'} border border-muted dark:border-muted/40 rounded-lg hover:bg-muted/50 dark:hover:bg-muted/20 cursor-pointer transition-colors ${format === selectedFormat ? 'bg-primary/10 dark:bg-primary/20 border-primary/50 dark:border-primary/40' : ''}`} onClick={() => setSelectedFormat(format)}>\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <div className={`font-medium ${isMobile ? 'text-xs' : 'text-sm'} text-foreground`}>{getFileName(format)}</div>\n                          <div className={`${isMobile ? 'text-xs' : 'text-xs'} text-muted-foreground`}>{format === selectedFormat ? 'Выбрано' : 'Нажмите для просмотра'}</div>\n                        </div>\n                        <Button size=\"sm\" variant=\"ghost\" onClick={(e) => { e.stopPropagation(); downloadFile(format); }}>\n                          <i className=\"fas fa-download text-xs\"></i>\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"code\" className=\"space-y-4 overflow-y-auto flex-1 min-h-0\">\n            <Card>\n              <CardHeader className={`${isMobile ? 'flex flex-col space-y-4' : 'flex flex-row items-center justify-between'}`}>\n                <div>\n                  <CardTitle>Сгенерированный Python код</CardTitle>\n                  <CardDescription>Готовый к использованию код для aiogram 3.x</CardDescription>\n                </div>\n                <div className={`flex ${isMobile ? 'flex-col space-y-2' : 'space-x-2'}`}>\n                  <Button onClick={() => copyToClipboard(exportContent.python)} variant=\"outline\" size=\"sm\" className={`${isMobile ? 'w-full' : ''}`}>\n                    <i className=\"fas fa-copy mr-2\"></i>\n                    Копировать\n                  </Button>\n                  <Button onClick={() => downloadFile('python')} size=\"sm\" className={`${isMobile ? 'w-full' : ''}`}>\n                    <i className=\"fas fa-download mr-2\"></i>\n                    Скачать\n                  </Button>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {validationResult.isValid ? (\n                  <Textarea\n                    value={exportContent.python}\n                    readOnly\n                    className={`${isMobile ? 'min-h-[300px] max-h-[400px]' : 'min-h-[400px] max-h-[600px]'} font-mono ${isMobile ? 'text-xs' : 'text-sm'} bg-muted/50 dark:bg-muted/20 border-muted dark:border-muted/40 resize-none`}\n                    placeholder=\"Генерация кода...\"\n                  />\n                ) : (\n                  <div className=\"p-4 bg-muted/50 dark:bg-muted/20 rounded-lg text-center text-muted-foreground border border-muted dark:border-muted/40\">\n                    <i className=\"fas fa-exclamation-triangle mb-2 text-yellow-500 dark:text-yellow-400\"></i>\n                    <p>Исправьте ошибки валидации для генерации кода</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"setup\" className=\"space-y-3 overflow-y-auto flex-1 min-h-0\">\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <i className=\"fas fa-cogs text-blue-500\"></i>\n                  <span>Настройка бота в @BotFather</span>\n                </CardTitle>\n                <CardDescription>Команды для настройки меню вашего бота</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-3 pt-0\">\n                {botFatherCommands ? (\n                  <div>\n                    <div className={`flex ${isMobile ? 'flex-col space-y-2' : 'justify-between items-center'} mb-2`}>\n                      <h4 className=\"font-medium\">Команды для @BotFather:</h4>\n                      <Button \n                        onClick={() => navigator.clipboard.writeText(botFatherCommands)}\n                        variant=\"outline\" \n                        size=\"sm\"\n                        className={`${isMobile ? 'w-full' : ''}`}\n                      >\n                        <i className=\"fas fa-copy mr-2\"></i>\n                        Копировать\n                      </Button>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mb-2\">\n                      Скопируйте и отправьте @BotFather для настройки меню команд:\n                    </p>\n                    <Textarea\n                      value={botFatherCommands}\n                      readOnly\n                      className={`${isMobile ? 'min-h-[120px] max-h-[200px]' : 'min-h-[150px] max-h-[300px]'} font-mono ${isMobile ? 'text-xs' : 'text-sm'} bg-muted/50 dark:bg-muted/20 border-muted dark:border-muted/40 resize-none`}\n                    />\n                  </div>\n                ) : (\n                  <div className=\"p-4 bg-muted/50 dark:bg-muted/20 rounded-lg text-center text-muted-foreground border border-muted dark:border-muted/40\">\n                    <p>Нет команд для настройки в меню</p>\n                  </div>\n                )}\n                \n                <Separator />\n                \n                <div className=\"space-y-3\">\n                  <h4 className=\"font-medium\">Подробная инструкция по запуску:</h4>\n                  \n                  <div className=\"bg-blue-50 dark:bg-blue-950/30 p-4 rounded-lg border border-blue-200 dark:border-blue-800/40\">\n                    <h5 className=\"font-medium text-blue-800 dark:text-blue-200 mb-2\">Шаг 1: Подготовка окружения</h5>\n                    <ol className=\"list-decimal list-inside space-y-1 text-sm text-blue-700 dark:text-blue-300\">\n                      <li>Убедитесь, что у вас установлен Python 3.8 или выше</li>\n                      <li>Создайте папку для вашего бота и перейдите в неё</li>\n                      <li>Скачайте все необходимые файлы (Python код, requirements.txt, README.md)</li>\n                      <li>Рекомендуется создать виртуальное окружение:\n                        <div className=\"mt-2 space-y-2\">\n                          <div className=\"bg-muted/30 dark:bg-muted/10 p-2 rounded border\">\n                            <div className=\"flex justify-between items-center mb-1\">\n                              <span className=\"text-xs text-muted-foreground\">Создание виртуального окружения:</span>\n                              <Button \n                                onClick={() => navigator.clipboard.writeText('python -m venv venv')}\n                                variant=\"ghost\" \n                                size=\"sm\" \n                                className=\"h-6 px-2\"\n                              >\n                                <i className=\"fas fa-copy text-xs\"></i>\n                              </Button>\n                            </div>\n                            <code className=\"text-sm font-mono\">python -m venv venv</code>\n                          </div>\n                          <div className=\"bg-muted/30 dark:bg-muted/10 p-2 rounded border\">\n                            <div className=\"flex justify-between items-center mb-1\">\n                              <span className=\"text-xs text-muted-foreground\">Активация (Linux/Mac):</span>\n                              <Button \n                                onClick={() => navigator.clipboard.writeText('source venv/bin/activate')}\n                                variant=\"ghost\" \n                                size=\"sm\" \n                                className=\"h-6 px-2\"\n                              >\n                                <i className=\"fas fa-copy text-xs\"></i>\n                              </Button>\n                            </div>\n                            <code className=\"text-sm font-mono\">source venv/bin/activate</code>\n                          </div>\n                          <div className=\"bg-muted/30 dark:bg-muted/10 p-2 rounded border\">\n                            <div className=\"flex justify-between items-center mb-1\">\n                              <span className=\"text-xs text-muted-foreground\">Активация (Windows):</span>\n                              <Button \n                                onClick={() => navigator.clipboard.writeText('venv\\\\Scripts\\\\activate')}\n                                variant=\"ghost\" \n                                size=\"sm\" \n                                className=\"h-6 px-2\"\n                              >\n                                <i className=\"fas fa-copy text-xs\"></i>\n                              </Button>\n                            </div>\n                            <code className=\"text-sm font-mono\">venv\\Scripts\\activate</code>\n                          </div>\n                        </div>\n                      </li>\n                    </ol>\n                  </div>\n\n                  <div className=\"bg-green-50 dark:bg-green-950/30 p-4 rounded-lg border border-green-200 dark:border-green-800/40\">\n                    <h5 className=\"font-medium text-green-800 dark:text-green-200 mb-2\">Шаг 2: Установка зависимостей</h5>\n                    <div className=\"space-y-3 text-sm\">\n                      <div>\n                        <div className=\"font-medium text-green-800 dark:text-green-200 mb-2\">Рекомендуемый способ - установка новых версий:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Команда для установки:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('pip install \"aiogram>=3.21.0\" \"aiohttp>=3.12.13\" \"requests>=2.32.4\" python-dotenv aiofiles')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono break-all\">pip install \"aiogram&gt;=3.21.0\" \"aiohttp&gt;=3.12.13\" \"requests&gt;=2.32.4\" python-dotenv aiofiles</code>\n                        </div>\n                      </div>\n\n                      <div>\n                        <div className=\"font-medium text-green-800 dark:text-green-200 mb-2\">Альтернативный способ - через requirements.txt:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Команда для установки:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('pip install -r requirements.txt')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono\">pip install -r requirements.txt</code>\n                        </div>\n                      </div>\n\n                      <div>\n                        <div className=\"font-medium text-green-800 dark:text-green-200 mb-2\">При ошибках компиляции - используйте бинарные пакеты:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Команда для установки:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('pip install --only-binary=all aiogram aiohttp requests python-dotenv aiofiles')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono break-all\">pip install --only-binary=all aiogram aiohttp requests python-dotenv aiofiles</code>\n                        </div>\n                      </div>\n\n                      <div>\n                        <div className=\"font-medium text-green-800 dark:text-green-200 mb-2\">Проверка установки:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Команда для проверки:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('python -c \"import aiogram; print(aiogram.__version__)\"')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono\">python -c \"import aiogram; print(aiogram.__version__)\"</code>\n                        </div>\n                        <p className=\"text-xs text-green-700 dark:text-green-300 mt-2\">Убедитесь что версия aiogram 3.x (например, 3.21.0+)</p>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"bg-amber-50 dark:bg-amber-950/30 p-4 rounded-lg border border-amber-200 dark:border-amber-800/40\">\n                    <h5 className=\"font-medium text-amber-800 dark:text-amber-200 mb-2\">Шаг 3: Настройка бота</h5>\n                    <div className=\"space-y-3 text-sm\">\n                      <div className=\"text-amber-700 dark:text-amber-300\">\n                        <div className=\"font-medium mb-2\">1. Откройте файл бота:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Имя файла:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText(`${projectName.replace(/\\s+/g, '_')}_bot.py`)}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono\">{projectName.replace(/\\s+/g, '_')}_bot.py</code>\n                        </div>\n                      </div>\n\n                      <div className=\"text-amber-700 dark:text-amber-300\">\n                        <div className=\"font-medium mb-2\">2. Найдите и замените токен бота:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Строка для поиска:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('BOT_TOKEN = \"YOUR_BOT_TOKEN_HERE\"')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono\">BOT_TOKEN = \"YOUR_BOT_TOKEN_HERE\"</code>\n                        </div>\n                      </div>\n\n                      <div className=\"text-amber-700 dark:text-amber-300\">\n                        <div className=\"font-medium mb-2\">3. Настройте администраторов:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Строка для поиска:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('ADMIN_IDS = [123456789]')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono\">ADMIN_IDS = [123456789]</code>\n                        </div>\n                        <p className=\"text-xs mt-2\">Замените 123456789 на ваш Telegram ID (узнать можно у @userinfobot)</p>\n                      </div>\n\n                      <div className=\"text-amber-700 dark:text-amber-300\">\n                        <div className=\"font-medium mb-2\">4. Узнайте ваш Telegram ID:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Бот для получения ID:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('@userinfobot')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono\">@userinfobot</code>\n                        </div>\n                        <p className=\"text-xs mt-2\">Напишите этому боту /start и он отправит ваш ID</p>\n                      </div>\n\n                      <div className=\"text-amber-700 dark:text-amber-300 font-medium\">\n                        5. Сохраните файл после внесения изменений\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"bg-purple-50 dark:bg-purple-950/30 p-4 rounded-lg border border-purple-200 dark:border-purple-800/40\">\n                    <h5 className=\"font-medium text-purple-800 dark:text-purple-200 mb-2\">Шаг 4: Запуск и тестирование</h5>\n                    <div className=\"space-y-3 text-sm\">\n                      <div>\n                        <div className=\"font-medium text-purple-800 dark:text-purple-200 mb-2\">Запуск бота:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Команда для запуска:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText(`python ${projectName.replace(/\\s+/g, '_')}_bot.py`)}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono\">python {projectName.replace(/\\s+/g, '_')}_bot.py</code>\n                        </div>\n                      </div>\n                      \n                      <div className=\"text-purple-700 dark:text-purple-300 space-y-1\">\n                        <div>• Дождитесь сообщения \"Бот запущен и готов к работе!\"</div>\n                        <div>• Найдите вашего бота в Telegram и отправьте команду /start</div>\n                        <div>• Проверьте работу всех команд и кнопок</div>\n                        <div>• Для остановки бота нажмите <code className=\"bg-muted/60 dark:bg-muted/40 px-1 rounded\">Ctrl+C</code> в терминале</div>\n                      </div>\n                      \n                      <div className=\"mt-4 bg-amber-50 dark:bg-amber-950/30 p-3 rounded-lg border border-amber-200 dark:border-amber-800/40\">\n                        <div className=\"font-medium text-amber-800 dark:text-amber-200 mb-2\">🖥️ Для пользователей Windows:</div>\n                        <div className=\"text-amber-700 dark:text-amber-300 text-sm space-y-2\">\n                          <div>Если видите ошибку кодировки (emoji не отображаются), выполните:</div>\n                          <div className=\"bg-muted/30 dark:bg-muted/10 p-2 rounded border\">\n                            <div className=\"flex justify-between items-center\">\n                              <code className=\"text-sm font-mono\">chcp 65001</code>\n                              <Button \n                                onClick={() => navigator.clipboard.writeText('chcp 65001')}\n                                variant=\"ghost\" \n                                size=\"sm\" \n                                className=\"h-6 px-2\"\n                              >\n                                <i className=\"fas fa-copy text-xs\"></i>\n                              </Button>\n                            </div>\n                          </div>\n                          <div>Затем запустите бот обычным способом. Эта команда включает поддержку UTF-8.</div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                <Separator className=\"my-4\" />\n\n                <div className=\"bg-cyan-50 dark:bg-cyan-950/30 p-4 rounded-lg border border-cyan-200 dark:border-cyan-800/40\">\n                  <h5 className=\"font-medium text-cyan-800 dark:text-cyan-200 mb-2\">Шаг 5: База данных (опционально)</h5>\n                  <div className=\"space-y-3 text-sm\">\n                    <div className=\"text-cyan-700 dark:text-cyan-300\">\n                      <div className=\"font-medium mb-2\">По умолчанию бот использует встроенную базу данных SQLite</div>\n                      <div className=\"space-y-2 text-sm\">\n                        <div>• Автоматически создается файл <code className=\"bg-muted/60 dark:bg-muted/40 px-1 rounded\">bot_database.db</code></div>\n                        <div>• Сохраняет данные пользователей, ответы на вопросы, статистику</div>\n                        <div>• Не требует дополнительной настройки</div>\n                        <div>• Подходит для большинства ботов</div>\n                      </div>\n                    </div>\n\n                    <div className=\"text-cyan-700 dark:text-cyan-300\">\n                      <div className=\"font-medium mb-2\">Для больших проектов можно настроить PostgreSQL:</div>\n                      <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                        <div className=\"flex justify-between items-center mb-2\">\n                          <span className=\"text-xs text-muted-foreground\">Установка PostgreSQL:</span>\n                          <Button \n                            onClick={() => navigator.clipboard.writeText('pip install asyncpg')}\n                            variant=\"ghost\" \n                            size=\"sm\" \n                            className=\"h-6 px-2\"\n                          >\n                            <i className=\"fas fa-copy text-xs mr-1\"></i>\n                            <span className=\"text-xs\">Копировать</span>\n                          </Button>\n                        </div>\n                        <code className=\"text-sm font-mono\">pip install asyncpg</code>\n                      </div>\n                    </div>\n\n                    <div className=\"text-cyan-700 dark:text-cyan-300\">\n                      <div className=\"font-medium mb-2\">Настройка подключения к PostgreSQL:</div>\n                      <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border space-y-2\">\n                        <div className=\"text-xs text-muted-foreground mb-1\">Найдите в коде бота строку:</div>\n                        <code className=\"text-sm font-mono block\">DATABASE_URL = \"sqlite:///bot_database.db\"</code>\n                        <div className=\"text-xs text-muted-foreground mb-1\">Замените на:</div>\n                        <code className=\"text-sm font-mono block break-all\">DATABASE_URL = \"postgresql://user:password@localhost/dbname\"</code>\n                        <Button \n                          onClick={() => navigator.clipboard.writeText('DATABASE_URL = \"postgresql://user:password@localhost/dbname\"')}\n                          variant=\"ghost\" \n                          size=\"sm\" \n                          className=\"h-6 px-2 mt-2\"\n                        >\n                          <i className=\"fas fa-copy text-xs mr-1\"></i>\n                          <span className=\"text-xs\">Копировать</span>\n                        </Button>\n                      </div>\n                    </div>\n\n                    <div className=\"text-cyan-700 dark:text-cyan-300 space-y-1\">\n                      <div className=\"font-medium\">Что сохраняется в базе данных:</div>\n                      <div className=\"ml-4 space-y-1 text-sm\">\n                        <div>• <strong>Пользователи:</strong> ID, имя, дата регистрации</div>\n                        <div>• <strong>Ответы:</strong> все ответы на вопросы и выбранные кнопки</div>\n                        <div>• <strong>Статистика:</strong> количество использований команд</div>\n                        <div>• <strong>Медиа:</strong> информация о загруженных файлах</div>\n                        <div>• <strong>Сессии:</strong> состояние многошагових диалогов</div>\n                      </div>\n                    </div>\n\n                    <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                      <div className=\"text-xs text-muted-foreground mb-1\">Просмотр данных (SQLite):</div>\n                      <div className=\"space-y-2\">\n                        <div>\n                          <code className=\"text-sm font-mono\">sqlite3 bot_database.db</code>\n                          <Button \n                            onClick={() => navigator.clipboard.writeText('sqlite3 bot_database.db')}\n                            variant=\"ghost\" \n                            size=\"sm\" \n                            className=\"h-6 px-2 ml-2\"\n                          >\n                            <i className=\"fas fa-copy text-xs\"></i>\n                          </Button>\n                        </div>\n                        <div>\n                          <code className=\"text-sm font-mono\">.tables</code>\n                          <Button \n                            onClick={() => navigator.clipboard.writeText('.tables')}\n                            variant=\"ghost\" \n                            size=\"sm\" \n                            className=\"h-6 px-2 ml-2\"\n                          >\n                            <i className=\"fas fa-copy text-xs\"></i>\n                          </Button>\n                        </div>\n                        <div>\n                          <code className=\"text-sm font-mono\">SELECT * FROM users LIMIT 10;</code>\n                          <Button \n                            onClick={() => navigator.clipboard.writeText('SELECT * FROM users LIMIT 10;')}\n                            variant=\"ghost\" \n                            size=\"sm\" \n                            className=\"h-6 px-2 ml-2\"\n                          >\n                            <i className=\"fas fa-copy text-xs\"></i>\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"text-cyan-700 dark:text-cyan-300\">\n                      <div className=\"font-medium mb-2\">Резервное копирование данных:</div>\n                      <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border space-y-2\">\n                        <div className=\"text-xs text-muted-foreground mb-1\">Создание резервной копии (SQLite):</div>\n                        <div>\n                          <code className=\"text-sm font-mono\">cp bot_database.db bot_database_backup_$(date +%Y%m%d).db</code>\n                          <Button \n                            onClick={() => navigator.clipboard.writeText('cp bot_database.db bot_database_backup_$(date +%Y%m%d).db')}\n                            variant=\"ghost\" \n                            size=\"sm\" \n                            className=\"h-6 px-2 ml-2\"\n                          >\n                            <i className=\"fas fa-copy text-xs\"></i>\n                          </Button>\n                        </div>\n                        <div className=\"text-xs text-muted-foreground mt-2\">Экспорт в CSV:</div>\n                        <div>\n                          <code className=\"text-sm font-mono\">sqlite3 -header -csv bot_database.db \"SELECT * FROM users;\" &gt; users.csv</code>\n                          <Button \n                            onClick={() => navigator.clipboard.writeText('sqlite3 -header -csv bot_database.db \"SELECT * FROM users;\" > users.csv')}\n                            variant=\"ghost\" \n                            size=\"sm\" \n                            className=\"h-6 px-2 ml-2\"\n                          >\n                            <i className=\"fas fa-copy text-xs\"></i>\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"text-cyan-700 dark:text-cyan-300 text-sm space-y-1\">\n                      <div className=\"font-medium\">Важные файлы для резервного копирования:</div>\n                      <div className=\"ml-4 space-y-1\">\n                        <div>• <code className=\"bg-muted/60 dark:bg-muted/40 px-1 rounded\">bot_database.db</code> - основная база данных</div>\n                        <div>• <code className=\"bg-muted/60 dark:bg-muted/40 px-1 rounded\">uploads/</code> - папка с медиафайлами пользователей</div>\n                        <div>• <code className=\"bg-muted/60 dark:bg-muted/40 px-1 rounded\">*.py</code> - файлы кода бота</div>\n                        <div>• <code className=\"bg-muted/60 dark:bg-muted/40 px-1 rounded\">config.yaml</code> - конфигурационные файлы</div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                <Separator className=\"my-4\" />\n\n                <div className=\"space-y-3\">\n                  <h4 className=\"font-medium\">Настройка меню команд в @BotFather:</h4>\n                  \n                  <div className=\"bg-indigo-50 dark:bg-indigo-950/30 p-4 rounded-lg border border-indigo-200 dark:border-indigo-800/40\">\n                    <h5 className=\"font-medium text-indigo-800 dark:text-indigo-200 mb-2\">Автоматическая настройка меню</h5>\n                    <div className=\"space-y-3 text-sm\">\n                      <div className=\"text-indigo-700 dark:text-indigo-300 space-y-1\">\n                        <div>1. Найдите @BotFather в Telegram</div>\n                        <div>2. Отправьте команду настройки меню:</div>\n                      </div>\n                      \n                      <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                        <div className=\"flex justify-between items-center mb-2\">\n                          <span className=\"text-xs text-muted-foreground\">Команда для настройки меню:</span>\n                          <Button \n                            onClick={() => navigator.clipboard.writeText('/setcommands')}\n                            variant=\"ghost\" \n                            size=\"sm\" \n                            className=\"h-6 px-2\"\n                          >\n                            <i className=\"fas fa-copy text-xs mr-1\"></i>\n                            <span className=\"text-xs\">Копировать</span>\n                          </Button>\n                        </div>\n                        <code className=\"text-sm font-mono\">/setcommands</code>\n                      </div>\n\n                      <div className=\"text-indigo-700 dark:text-indigo-300 space-y-1\">\n                        <div>3. Выберите своего бота из списка</div>\n                        <div>4. Скопируйте команды из раздела \"Команды для @BotFather\" выше</div>\n                        <div>5. Вставьте команды в чат с @BotFather и отправьте</div>\n                        <div>6. Получите подтверждение \"Ok, command list updated\"</div>\n                        <div>7. Команды автоматически появятся в меню бота с описаниями</div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"bg-muted/50 dark:bg-muted/20 p-3 rounded-lg border border-muted dark:border-muted/40\">\n                    <h6 className=\"font-medium text-foreground mb-3\">Дополнительные настройки @BotFather:</h6>\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between bg-muted/30 dark:bg-muted/10 p-2 rounded border\">\n                        <div className=\"flex items-center space-x-2\">\n                          <code className=\"text-sm font-mono\">/setdescription</code>\n                          <span className=\"text-sm text-muted-foreground\">- установить описание бота</span>\n                        </div>\n                        <Button \n                          onClick={() => navigator.clipboard.writeText('/setdescription')}\n                          variant=\"ghost\" \n                          size=\"sm\" \n                          className=\"h-6 px-2\"\n                        >\n                          <i className=\"fas fa-copy text-xs\"></i>\n                        </Button>\n                      </div>\n                      \n                      <div className=\"flex items-center justify-between bg-muted/30 dark:bg-muted/10 p-2 rounded border\">\n                        <div className=\"flex items-center space-x-2\">\n                          <code className=\"text-sm font-mono\">/setuserpic</code>\n                          <span className=\"text-sm text-muted-foreground\">- установить фото профиля</span>\n                        </div>\n                        <Button \n                          onClick={() => navigator.clipboard.writeText('/setuserpic')}\n                          variant=\"ghost\" \n                          size=\"sm\" \n                          className=\"h-6 px-2\"\n                        >\n                          <i className=\"fas fa-copy text-xs\"></i>\n                        </Button>\n                      </div>\n                      \n                      <div className=\"flex items-center justify-between bg-muted/30 dark:bg-muted/10 p-2 rounded border\">\n                        <div className=\"flex items-center space-x-2\">\n                          <code className=\"text-sm font-mono\">/setname</code>\n                          <span className=\"text-sm text-muted-foreground\">- изменить имя бота</span>\n                        </div>\n                        <Button \n                          onClick={() => navigator.clipboard.writeText('/setname')}\n                          variant=\"ghost\" \n                          size=\"sm\" \n                          className=\"h-6 px-2\"\n                        >\n                          <i className=\"fas fa-copy text-xs\"></i>\n                        </Button>\n                      </div>\n                      \n                      <div className=\"flex items-center justify-between bg-muted/30 dark:bg-muted/10 p-2 rounded border\">\n                        <div className=\"flex items-center space-x-2\">\n                          <code className=\"text-sm font-mono\">/setabouttext</code>\n                          <span className=\"text-sm text-muted-foreground\">- установить текст \"О боте\"</span>\n                        </div>\n                        <Button \n                          onClick={() => navigator.clipboard.writeText('/setabouttext')}\n                          variant=\"ghost\" \n                          size=\"sm\" \n                          className=\"h-6 px-2\"\n                        >\n                          <i className=\"fas fa-copy text-xs\"></i>\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                <Separator className=\"my-4\" />\n\n                <div className=\"space-y-3\">\n                  <h4 className=\"font-medium\">Описание экспортируемых файлов:</h4>\n                  \n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                    <div className=\"bg-muted/50 dark:bg-muted/20 p-3 rounded-lg border border-muted dark:border-muted/40\">\n                      <h6 className=\"font-medium text-foreground mb-1\">Python код (.py)</h6>\n                      <p className=\"text-sm text-muted-foreground\">Основной файл бота с логикой обработки команд, сообщений, кнопок и медиаконтента. Использует aiogram 3.x с поддержкой локальных файлов и геолокации.</p>\n                    </div>\n                    \n                    <div className=\"bg-muted/50 dark:bg-muted/20 p-3 rounded-lg border border-muted dark:border-muted/40\">\n                      <h6 className=\"font-medium text-foreground mb-1\">JSON данные (.json)</h6>\n                      <p className=\"text-sm text-muted-foreground\">Структурированные данные бота для импорта в другие системы или резервного копирования.</p>\n                    </div>\n                    \n                    <div className=\"bg-muted/50 dark:bg-muted/20 p-3 rounded-lg border border-muted dark:border-muted/40\">\n                      <h6 className=\"font-medium text-foreground mb-1\">Зависимости (.txt)</h6>\n                      <p className=\"text-sm text-muted-foreground\">Файл requirements.txt со всеми необходимыми Python библиотеками для работы бота.</p>\n                    </div>\n                    \n                    <div className=\"bg-muted/50 dark:bg-muted/20 p-3 rounded-lg border border-muted dark:border-muted/40\">\n                      <h6 className=\"font-medium text-foreground mb-1\">Документация (.md)</h6>\n                      <p className=\"text-sm text-muted-foreground\">README файл с подробным описанием бота, его функций и инструкцией по установке.</p>\n                    </div>\n                    \n                    <div className=\"bg-muted/50 dark:bg-muted/20 p-3 rounded-lg border border-muted dark:border-muted/40\">\n                      <h6 className=\"font-medium text-foreground mb-1\">Dockerfile</h6>\n                      <p className=\"text-sm text-muted-foreground\">Конфигурация для контейнеризации бота с помощью Docker для простого развертывания.</p>\n                    </div>\n                    \n                    <div className=\"bg-muted/50 dark:bg-muted/20 p-3 rounded-lg border border-muted dark:border-muted/40\">\n                      <h6 className=\"font-medium text-foreground mb-1\">Конфигурация (.yaml)</h6>\n                      <p className=\"text-sm text-muted-foreground\">Файл конфигурации для развертывания бота на серверах с автоматической настройкой.</p>\n                    </div>\n                  </div>\n                </div>\n\n                <Separator className=\"my-4\" />\n\n                <div className=\"space-y-3\">\n                  <h4 className=\"font-medium\">Тестирование и отладка:</h4>\n                  \n                  <div className=\"bg-teal-50 dark:bg-teal-950/30 p-4 rounded-lg border border-teal-200 dark:border-teal-800/40\">\n                    <h5 className=\"font-medium text-teal-800 dark:text-teal-200 mb-2\">Шаг 5: Проверка функций бота</h5>\n                    <ol className=\"list-decimal list-inside space-y-1 text-sm text-teal-700 dark:text-teal-300\">\n                      <li>Протестируйте все команды и убедитесь что они отвечают</li>\n                      <li>Проверьте inline кнопки - они должны реагировать на нажатия</li>\n                      <li>Если есть медиафайлы - убедитесь что они отправляются корректно</li>\n                      <li>Для локальных файлов создайте папку \"uploads\" и поместите туда медиафайлы</li>\n                      <li>Проверьте геолокацию - кнопки карт должны открывать правильные координаты</li>\n                      <li>Если бот не отвечает - проверьте логи в терминале на наличие ошибок</li>\n                    </ol>\n                  </div>\n\n                  <div className=\"bg-orange-50 dark:bg-orange-950/30 p-4 rounded-lg border border-orange-200 dark:border-orange-800/40\">\n                    <h5 className=\"font-medium text-orange-800 dark:text-orange-200 mb-2\">Решение проблем:</h5>\n                    <div className=\"space-y-3 text-sm\">\n                      <div>\n                        <div className=\"font-medium text-orange-800 dark:text-orange-200 mb-2\">Ошибка при установке (Rust required):</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Команда с бинарными пакетами:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('pip install --only-binary=all aiogram aiohttp requests python-dotenv aiofiles')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono break-all\">pip install --only-binary=all aiogram aiohttp requests python-dotenv aiofiles</code>\n                        </div>\n                      </div>\n\n                      <div>\n                        <div className=\"font-medium text-orange-800 dark:text-orange-200 mb-2\">Проблемы с pydantic-core:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Обновление инструментов:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('pip install --upgrade pip setuptools wheel')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono\">pip install --upgrade pip setuptools wheel</code>\n                        </div>\n                      </div>\n\n                      <div>\n                        <div className=\"font-medium text-orange-800 dark:text-orange-200 mb-2\">Переустановка aiogram при ошибках:</div>\n                        <div className=\"bg-muted/30 dark:bg-muted/10 p-3 rounded border\">\n                          <div className=\"flex justify-between items-center mb-2\">\n                            <span className=\"text-xs text-muted-foreground\">Команда обновления:</span>\n                            <Button \n                              onClick={() => navigator.clipboard.writeText('pip install --upgrade aiogram')}\n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-6 px-2\"\n                            >\n                              <i className=\"fas fa-copy text-xs mr-1\"></i>\n                              <span className=\"text-xs\">Копировать</span>\n                            </Button>\n                          </div>\n                          <code className=\"text-sm font-mono\">pip install --upgrade aiogram</code>\n                        </div>\n                      </div>\n\n                      <div className=\"text-orange-700 dark:text-orange-300 space-y-1\">\n                        <div>• <strong>Бот не запускается:</strong> Проверьте токен и версию aiogram</div>\n                        <div>• <strong>Команды не работают:</strong> Убедитесь что они настроены в @BotFather</div>\n                        <div>• <strong>Inline кнопки не реагируют:</strong> Проверьте callback обработчики в коде</div>\n                        <div>• <strong>Медиафайлы не отправляются:</strong> Убедитесь что файлы существуют в папке uploads</div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                <Separator className=\"my-4\" />\n\n                <div className=\"bg-cyan-50 dark:bg-cyan-950/30 p-4 rounded-lg border border-cyan-200 dark:border-cyan-800/40\">\n                  <h5 className=\"font-medium text-cyan-800 dark:text-cyan-200 mb-2\">🚀 Новые возможности бота:</h5>\n                  <ul className=\"text-sm text-cyan-700 dark:text-cyan-300 space-y-1\">\n                    <li>• <strong>Медиаконтент:</strong> Поддержка фото, видео, аудио и документов</li>\n                    <li>• <strong>Локальные файлы:</strong> Автоматическая работа с загруженными файлами</li>\n                    <li>• <strong>Геолокация:</strong> Интеграция с Яндекс.Карты, Google Maps, 2ГИС</li>\n                    <li>• <strong>Умные клавиатуры:</strong> Поддержка inline и reply кнопок</li>\n                    <li>• <strong>Синонимы команд:</strong> Дополнительные варианты активации команд</li>\n                    <li>• <strong>Права доступа:</strong> Админские команды и приватные чаты</li>\n                    <li>• <strong>Обработка ошибок:</strong> Автоматическое логирование и уведомления</li>\n                  </ul>\n                </div>\n\n                <div className=\"bg-red-50 dark:bg-red-950/30 p-4 rounded-lg border border-red-200 dark:border-red-800/40\">\n                  <h5 className=\"font-medium text-red-800 dark:text-red-200 mb-2\">⚠️ Важные замечания:</h5>\n                  <ul className=\"text-sm text-red-700 dark:text-red-300 space-y-1\">\n                    <li>• Никогда не публикуйте токен бота в открытом доступе</li>\n                    <li>• Регулярно обновляйте токен бота при подозрении на компрометацию</li>\n                    <li>• Для продакшена используйте переменные окружения для хранения токена</li>\n                    <li>• Тестируйте бота в приватном чате перед публикацией</li>\n                    <li>• Сохраняйте резервные копии кода и настроек</li>\n                    <li>• Для медиафайлов создайте папку \"uploads\" рядом с кодом бота</li>\n                  </ul>\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"export\" className=\"space-y-4 overflow-y-auto flex-1 min-h-0\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <i className=\"fas fa-download text-blue-500\"></i>\n                  <span>Мобильный экспорт</span>\n                </CardTitle>\n                <CardDescription>Быстрые действия для экспорта</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-6 px-4 py-5\">\n                <div className=\"grid grid-cols-1 gap-4\">\n                  <Button size=\"lg\" onClick={async () => { setSelectedFormat('python'); await downloadFile('python'); }} variant=\"outline\" className=\"h-16 flex-col space-y-1\" data-testid=\"button-download-python\">\n                    <i className=\"fas fa-code text-xl text-blue-500\"></i>\n                    <span className=\"font-medium\">Скачать Python код</span>\n                  </Button>\n                  \n                  <Button size=\"lg\" onClick={async () => { setSelectedFormat('json'); await downloadFile('json'); }} variant=\"outline\" className=\"h-16 flex-col space-y-1\" data-testid=\"button-download-json\">\n                    <i className=\"fas fa-database text-xl text-green-500\"></i>\n                    <span className=\"font-medium\">Скачать JSON данные</span>\n                  </Button>\n                  \n                  <Button size=\"lg\" onClick={downloadAllFiles} className=\"h-16 flex-col space-y-1\" data-testid=\"button-download-all\">\n                    <i className=\"fas fa-archive text-xl\"></i>\n                    <span className=\"font-medium\">Скачать все файлы</span>\n                  </Button>\n                </div>\n                \n                <Separator />\n                \n                <div className=\"space-y-3\">\n                  <h4 className=\"font-semibold text-base\">Остальные файлы проекта:</h4>\n                  <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                    <Button size=\"sm\" variant=\"ghost\" onClick={() => downloadFile('requirements')} className=\"h-auto p-3 flex-col space-y-1 border border-muted\" data-testid=\"button-download-requirements\">\n                      <i className=\"fas fa-list text-lg text-orange-500\"></i>\n                      <span className=\"font-medium\">Зависимости</span>\n                      <span className=\"text-xs text-muted-foreground\">.txt</span>\n                    </Button>\n                    <Button size=\"sm\" variant=\"ghost\" onClick={() => downloadFile('readme')} className=\"h-auto p-3 flex-col space-y-1 border border-muted\" data-testid=\"button-download-readme\">\n                      <i className=\"fas fa-file-alt text-lg text-purple-500\"></i>\n                      <span className=\"font-medium\">Документация</span>\n                      <span className=\"text-xs text-muted-foreground\">.md</span>\n                    </Button>\n                    <Button size=\"sm\" variant=\"ghost\" onClick={() => downloadFile('dockerfile')} className=\"h-auto p-3 flex-col space-y-1 border border-muted\" data-testid=\"button-download-dockerfile\">\n                      <i className=\"fab fa-docker text-lg text-cyan-500\"></i>\n                      <span className=\"font-medium\">Docker</span>\n                      <span className=\"text-xs text-muted-foreground\">Контейнер</span>\n                    </Button>\n                    <Button size=\"sm\" variant=\"ghost\" onClick={() => downloadFile('config')} className=\"h-auto p-3 flex-col space-y-1 border border-muted\" data-testid=\"button-download-config\">\n                      <i className=\"fas fa-cogs text-lg text-yellow-500\"></i>\n                      <span className=\"font-medium\">Конфиг</span>\n                      <span className=\"text-xs text-muted-foreground\">.yaml</span>\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n\n        </Tabs>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":84396},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/components/theme-provider.tsx":{"content":"import React, { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"light\" | \"dark\" | \"system\";\n\ninterface ThemeProviderProps {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n  storageKey?: string;\n}\n\ninterface ThemeProviderState {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n}\n\nconst initialState: ThemeProviderState = {\n  theme: \"system\",\n  setTheme: () => null,\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState>(initialState);\n\nexport function ThemeProvider({\n  children,\n  defaultTheme = \"system\",\n  storageKey = \"telegram-bot-builder-theme\",\n  ...props\n}: ThemeProviderProps) {\n  const [theme, setTheme] = useState<Theme>(\n    () => (localStorage.getItem(storageKey) as Theme) || defaultTheme\n  );\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n\n    root.classList.remove(\"light\", \"dark\");\n\n    if (theme === \"system\") {\n      const systemTheme = window.matchMedia(\"(prefers-color-scheme: dark)\")\n        .matches\n        ? \"dark\"\n        : \"light\";\n\n      root.classList.add(systemTheme);\n      return;\n    }\n\n    root.classList.add(theme);\n  }, [theme]);\n\n  const value = {\n    theme,\n    setTheme: (theme: Theme) => {\n      localStorage.setItem(storageKey, theme);\n      setTheme(theme);\n    },\n  };\n\n  return (\n    <ThemeProviderContext.Provider {...props} value={value}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n\n  if (context === undefined)\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n\n  return context;\n};","size_bytes":1628},"client/src/components/ui/auto-connection-panel.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Switch } from '@/components/ui/switch';\nimport { Separator } from '@/components/ui/separator';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { \n  Tooltip, \n  TooltipContent, \n  TooltipProvider, \n  TooltipTrigger \n} from '@/components/ui/tooltip';\nimport { \n  AlertCircle, \n  ArrowRight, \n  CheckCircle, \n  Link2, \n  Settings, \n  Sparkles, \n  Zap \n} from 'lucide-react';\nimport { Node, Connection } from '@/types/bot';\nimport { ConnectionManager, ConnectionSuggestion } from '@/utils/connection-manager';\n\ninterface AutoConnectionPanelProps {\n  nodes: Node[];\n  connections: Connection[];\n  onConnectionAdd: (connection: Connection) => void;\n  onNodesUpdate: (nodes: Node[]) => void;\n  autoButtonCreation: boolean;\n  onAutoButtonCreationChange: (enabled: boolean) => void;\n}\n\nexport function AutoConnectionPanel({\n  nodes,\n  connections,\n  onConnectionAdd,\n  onNodesUpdate,\n  autoButtonCreation,\n  onAutoButtonCreationChange\n}: AutoConnectionPanelProps) {\n  const [suggestions, setSuggestions] = useState<ConnectionSuggestion[]>([]);\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [appliedSuggestions, setAppliedSuggestions] = useState<Set<string>>(new Set());\n\n  const connectionManager = new ConnectionManager({\n    nodes,\n    connections,\n    autoButtonCreation\n  });\n\n  useEffect(() => {\n    generateSuggestions();\n  }, [nodes, connections]);\n\n  const generateSuggestions = () => {\n    setIsGenerating(true);\n    try {\n      const newSuggestions = connectionManager.generateConnectionSuggestions();\n      setSuggestions(newSuggestions);\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  const applySuggestion = (suggestion: ConnectionSuggestion) => {\n    try {\n      const { connection, updatedNodes } = connectionManager.createConnection(\n        suggestion.connection.source,\n        suggestion.connection.target,\n        {\n          autoCreateButton: autoButtonCreation,\n          buttonText: suggestion.suggestedButton.text,\n          buttonAction: suggestion.suggestedButton.action\n        }\n      );\n\n      onConnectionAdd(connection);\n      onNodesUpdate(updatedNodes);\n      setAppliedSuggestions(prev => new Set([...prev, suggestion.id]));\n    } catch (error) {\n      console.error('Ошибка при применении предложения:', error);\n    }\n  };\n\n  const applyAllHighConfidence = () => {\n    const highConfidenceSuggestions = suggestions.filter(s => s.confidence > 0.8);\n    \n    highConfidenceSuggestions.forEach(suggestion => {\n      if (!appliedSuggestions.has(suggestion.id)) {\n        applySuggestion(suggestion);\n      }\n    });\n  };\n\n  const syncButtonsWithConnections = () => {\n    const updatedNodes = connectionManager.syncButtonsWithConnections();\n    onNodesUpdate(updatedNodes);\n  };\n\n  const cleanupOrphanedButtons = () => {\n    const updatedNodes = connectionManager.cleanupOrphanedButtons();\n    onNodesUpdate(updatedNodes);\n  };\n\n  const getNodeName = (nodeId: string) => {\n    const node = nodes.find(n => n.id === nodeId);\n    if (!node) return 'Неизвестный узел';\n    \n    switch (node.type) {\n      case 'start': return 'Старт';\n      case 'command': return node.data.command || 'Команда';\n      case 'message': return node.data.messageText?.slice(0, 20) + '...' || 'Сообщение';\n      case 'keyboard': return 'Клавиатура';\n      case 'photo': return 'Фото';\n      case 'condition': return 'Условие';\n      case 'input': return 'Ввод';\n      default: return node.type;\n    }\n  };\n\n  const getConfidenceColor = (confidence: number) => {\n    if (confidence >= 0.8) return 'bg-green-500';\n    if (confidence >= 0.6) return 'bg-yellow-500';\n    return 'bg-red-500';\n  };\n\n  const getConfidenceText = (confidence: number) => {\n    if (confidence >= 0.8) return 'Высокая';\n    if (confidence >= 0.6) return 'Средняя';\n    return 'Низкая';\n  };\n\n  return (\n    <Card className=\"w-full max-w-md\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <Link2 className=\"h-5 w-5\" />\n            Автосоединения\n          </CardTitle>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={generateSuggestions}\n            disabled={isGenerating}\n          >\n            {isGenerating ? (\n              <Settings className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <Sparkles className=\"h-4 w-4\" />\n            )}\n          </Button>\n        </div>\n        <CardDescription>\n          Автоматическое создание связей между узлами\n        </CardDescription>\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {/* Настройки */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"space-y-1\">\n            <label className=\"text-sm font-medium\">Автосоздание кнопок</label>\n            <p className=\"text-xs text-muted-foreground\">\n              Создавать кнопки при добавлении связей\n            </p>\n          </div>\n          <Switch\n            checked={autoButtonCreation}\n            onCheckedChange={onAutoButtonCreationChange}\n          />\n        </div>\n\n        <Separator />\n\n        {/* Быстрые действия */}\n        <div className=\"space-y-2\">\n          <h4 className=\"text-sm font-medium\">Быстрые действия</h4>\n          <div className=\"grid grid-cols-2 gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={applyAllHighConfidence}\n              disabled={suggestions.filter(s => s.confidence > 0.8).length === 0}\n            >\n              <Zap className=\"h-4 w-4 mr-1\" />\n              Применить лучшие\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={syncButtonsWithConnections}\n            >\n              <CheckCircle className=\"h-4 w-4 mr-1\" />\n              Синхронизировать\n            </Button>\n          </div>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={cleanupOrphanedButtons}\n            className=\"w-full\"\n          >\n            <AlertCircle className=\"h-4 w-4 mr-1\" />\n            Очистить лишние кнопки\n          </Button>\n        </div>\n\n        <Separator />\n\n        {/* Предложения */}\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <h4 className=\"text-sm font-medium\">Предложения</h4>\n            <Badge variant=\"secondary\">{suggestions.length}</Badge>\n          </div>\n\n          {suggestions.length === 0 ? (\n            <div className=\"text-center py-6 text-muted-foreground\">\n              <Link2 className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n              <p className=\"text-sm\">Нет предложений для соединения</p>\n            </div>\n          ) : (\n            <ScrollArea className=\"h-80\">\n              <div className=\"space-y-2\">\n                {suggestions.map((suggestion) => (\n                  <Card\n                    key={suggestion.id}\n                    className={`p-3 ${appliedSuggestions.has(suggestion.id) ? 'opacity-50' : ''}`}\n                  >\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <Badge\n                            variant=\"secondary\"\n                            className={`text-xs ${getConfidenceColor(suggestion.confidence)} text-white`}\n                          >\n                            {getConfidenceText(suggestion.confidence)}\n                          </Badge>\n                          {suggestion.autoCreate && (\n                            <TooltipProvider>\n                              <Tooltip>\n                                <TooltipTrigger>\n                                  <Sparkles className=\"h-4 w-4 text-yellow-500\" />\n                                </TooltipTrigger>\n                                <TooltipContent>\n                                  <p>Рекомендуется к автоприменению</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            </TooltipProvider>\n                          )}\n                        </div>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => applySuggestion(suggestion)}\n                          disabled={appliedSuggestions.has(suggestion.id)}\n                        >\n                          {appliedSuggestions.has(suggestion.id) ? (\n                            <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                          ) : (\n                            'Применить'\n                          )}\n                        </Button>\n                      </div>\n\n                      <div className=\"flex items-center gap-2 text-sm\">\n                        <span className=\"font-medium truncate\">\n                          {getNodeName(suggestion.connection.source)}\n                        </span>\n                        <ArrowRight className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"font-medium truncate\">\n                          {getNodeName(suggestion.connection.target)}\n                        </span>\n                      </div>\n\n                      <div className=\"text-xs text-muted-foreground\">\n                        {suggestion.reason}\n                      </div>\n\n                      {autoButtonCreation && (\n                        <div className=\"bg-muted p-2 rounded text-xs\">\n                          <div className=\"font-medium\">Создаваемая кнопка:</div>\n                          <div className=\"flex items-center gap-1 mt-1\">\n                            <span className=\"bg-background px-2 py-1 rounded\">\n                              {suggestion.suggestedButton.text}\n                            </span>\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {suggestion.suggestedButton.action}\n                            </Badge>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </Card>\n                ))}\n              </div>\n            </ScrollArea>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":11089},"client/src/pages/bot-preview.tsx":{"content":"import { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Header } from '@/components/editor/header';\nimport { useQuery } from '@tanstack/react-query';\nimport { BotProject, Node, Connection, BotData, BotDataWithSheets } from '@shared/schema';\nimport { parseCommandFromText } from '@/lib/commands';\nimport { useState, useRef, useEffect, useCallback } from 'react';\nimport { useParams, useLocation } from 'wouter';\nimport { ArrowLeft, Send, Phone, MessageCircle, Users, Bot } from 'lucide-react';\nimport { SheetsManager } from '@/utils/sheets-manager';\n\n// Функция для рендеринга markdown в HTML\nconst renderMarkdown = (text: string): string => {\n  return text\n    // Жирный текст: **text** → <strong>text</strong>\n    .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\n    // Курсив: *text* → <em>text</em>\n    .replace(/\\*((?:[^*]|\\*{2})*?)\\*/g, '<em>$1</em>')\n    // Код: `text` → <code>text</code>\n    .replace(/`([^`]+)`/g, '<code class=\"bg-gray-100 px-1 py-0.5 rounded text-xs\">$1</code>')\n    // Переносы строк: \\n → <br>\n    .replace(/\\n/g, '<br>')\n    // Ссылки: [text](url) → <a href=\"url\">text</a>\n    .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href=\"$2\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-600 hover:underline\">$1</a>');\n};\n\nexport default function BotPreview() {\n  const [, setLocation] = useLocation();\n  const params = useParams();\n  const projectId = params.id ? parseInt(params.id) : null;\n\n  // Load project data\n  const { data: projects } = useQuery<BotProject[]>({\n    queryKey: ['/api/projects'],\n  });\n\n  const currentProject = projects?.find(p => p.id === projectId);\n\n  // Extract nodes and connections from project data\n  const getNodesAndConnections = useCallback(() => {\n    if (!currentProject?.data) return { nodes: [], connections: [] };\n\n    const projectData = currentProject.data as any;\n\n    // Check if it's new format with sheets\n    if (SheetsManager.isNewFormat(projectData)) {\n      const activeSheet = SheetsManager.getActiveSheet(projectData);\n      if (activeSheet) {\n        return { nodes: activeSheet.nodes, connections: activeSheet.connections };\n      }\n    } else {\n      // Legacy format\n      const botData = projectData as BotData;\n      return { nodes: botData.nodes || [], connections: botData.connections || [] };\n    }\n\n    return { nodes: [], connections: [] };\n  }, [currentProject?.data]);\n\n  const { nodes, connections } = getNodesAndConnections();\n\n  // Preview state\n  const [currentNodeId, setCurrentNodeId] = useState<string>('');\n  const [messageHistory, setMessageHistory] = useState<Array<{\n    id: string;\n    type: 'bot' | 'user';\n    text: string;\n    time: string;\n    buttons?: Array<{ text: string; target?: string; action?: string; }>;\n    keyboardType?: 'reply' | 'inline' | 'none';\n    mediaType?: 'photo' | 'video' | 'audio' | 'document' | 'sticker' | 'voice' | 'animation' | 'location' | 'contact' | 'poll' | 'dice';\n    mediaUrl?: string;\n    mediaCaption?: string;\n    mediaData?: any;\n  }>>([]);\n  const [currentReplyKeyboard, setCurrentReplyKeyboard] = useState<Array<{ text: string; target?: string; action?: string; }> | null>(null);\n  const [textInput, setTextInput] = useState('');\n  const [waitingForInput, setWaitingForInput] = useState(false);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const chatAreaRef = useRef<HTMLDivElement>(null);\n\n  // Find start node or first node\n  const startNode = nodes.find(node => node.type === 'start') || nodes[0];\n\n  // Helper function to find next node based on connections\n  const findNextNode = (currentNodeId: string, isSuccess: boolean = true) => {\n    const fromConnections = connections.filter(conn => conn.source === currentNodeId);\n    \n    if (fromConnections.length === 0) {\n      return null;\n    }\n\n    const nextConnection = fromConnections[0];\n    return nextConnection ? nodes.find(node => node.id === nextConnection.target) : null;\n  };\n\n  // Helper function to get media information from a node\n  const getMediaInfo = (node: Node) => {\n    switch (node.type) {\n      case 'photo':\n        return {\n          mediaType: 'photo' as const,\n          mediaUrl: node.data.imageUrl || 'https://picsum.photos/800/600?random=1',\n          mediaCaption: node.data.mediaCaption\n        };\n      case 'video':\n        return {\n          mediaType: 'video' as const,\n          mediaUrl: node.data.videoUrl || 'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4',\n          mediaCaption: node.data.mediaCaption\n        };\n      case 'audio':\n        return {\n          mediaType: 'audio' as const,\n          mediaUrl: node.data.audioUrl || 'https://www.soundjay.com/misc/beep-07a.wav',\n          mediaCaption: node.data.mediaCaption,\n          mediaData: {\n            performer: node.data.performer,\n            duration: node.data.duration\n          }\n        };\n      case 'document':\n        return {\n          mediaType: 'document' as const,\n          mediaUrl: node.data.documentUrl || 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',\n          mediaCaption: node.data.mediaCaption,\n          mediaData: {\n            filename: node.data.filename || node.data.documentName || 'document.pdf'\n          }\n        };\n      case 'sticker':\n        return {\n          mediaType: 'sticker' as const,\n          mediaUrl: node.data.stickerUrl || 'https://telegram.org/img/t_logo.png',\n          mediaCaption: node.data.mediaCaption\n        };\n      case 'voice':\n        return {\n          mediaType: 'voice' as const,\n          mediaUrl: node.data.voiceUrl || 'https://www.soundjay.com/misc/beep-07a.wav',\n          mediaCaption: node.data.mediaCaption,\n          mediaData: {\n            duration: node.data.duration\n          }\n        };\n      case 'animation':\n        return {\n          mediaType: 'animation' as const,\n          mediaUrl: node.data.animationUrl || 'https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif',\n          mediaCaption: node.data.mediaCaption\n        };\n      case 'location':\n        return {\n          mediaType: 'location' as const,\n          mediaData: {\n            latitude: node.data.latitude || 55.7558,\n            longitude: node.data.longitude || 37.6176,\n            title: node.data.title || 'Местоположение',\n            address: node.data.address || 'Адрес не указан'\n          }\n        };\n      case 'contact':\n        return {\n          mediaType: 'contact' as const,\n          mediaData: {\n            phoneNumber: node.data.phoneNumber || '+7 (900) 123-45-67',\n            firstName: node.data.firstName || 'Имя',\n            lastName: node.data.lastName || 'Фамилия'\n          }\n        };\n      case 'keyboard':\n        if (node.data.action === 'poll') {\n          return {\n            mediaType: 'poll' as const,\n            mediaData: {\n              question: node.data.question || 'Вопрос опроса',\n              options: node.data.options || ['Вариант 1', 'Вариант 2'],\n              isAnonymous: node.data.isAnonymous || true,\n              allowsMultipleAnswers: node.data.allowsMultipleAnswers || false\n            }\n          };\n        } else if (node.data.action === 'dice') {\n          return {\n            mediaType: 'dice' as const,\n            mediaData: {\n              emoji: node.data.emoji || '🎲'\n            }\n          };\n        }\n        break;\n      default:\n        return null;\n    }\n  };\n\n  // Process node and add to chat\n  const processNode = useCallback((node: Node, userMessage?: string) => {\n    if (!node) return;\n\n    const now = new Date();\n    const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });\n\n    // Add user message first if provided\n    if (userMessage) {\n      setMessageHistory(prev => [...prev, {\n        id: `user-${Date.now()}`,\n        type: 'user',\n        text: userMessage,\n        time: timeString\n      }]);\n    }\n\n    // Get media info for the node\n    const mediaInfo = getMediaInfo(node);\n\n    // Create bot message\n    const botMessage: any = {\n      id: node.id,\n      type: 'bot',\n      text: node.data.text || node.data.messageText || '',\n      time: timeString,\n      buttons: [],\n      keyboardType: 'none'\n    };\n\n    // Add media info if present\n    if (mediaInfo) {\n      Object.assign(botMessage, mediaInfo);\n    }\n\n    // Handle different node types\n    switch (node.type) {\n      case 'message':\n      case 'start':\n        // Add buttons if they exist\n        if (node.data.buttons && node.data.buttons.length > 0) {\n          botMessage.buttons = node.data.buttons.map((btn: any) => ({\n            text: btn.text,\n            target: btn.target,\n            action: btn.action\n          }));\n          botMessage.keyboardType = node.data.keyboardType || 'inline';\n        }\n        break;\n\n      case 'keyboard':\n        if (node.data.action === 'input') {\n          setWaitingForInput(true);\n          setTimeout(() => {\n            inputRef.current?.focus();\n          }, 100);\n        }\n        break;\n\n      case 'condition':\n        // For condition nodes, automatically proceed to next node\n        const nextNode = findNextNode(node.id, true);\n        if (nextNode) {\n          setTimeout(() => processNode(nextNode), 500);\n          return;\n        }\n        break;\n    }\n\n    // Add bot message to history\n    setMessageHistory(prev => [...prev, botMessage]);\n\n    // Set current reply keyboard\n    if (botMessage.buttons && botMessage.buttons.length > 0 && botMessage.keyboardType === 'reply') {\n      setCurrentReplyKeyboard(botMessage.buttons);\n    } else if (botMessage.keyboardType === 'inline' || botMessage.keyboardType === 'none') {\n      setCurrentReplyKeyboard(null);\n    }\n\n    // Auto scroll to bottom\n    setTimeout(() => {\n      if (chatAreaRef.current) {\n        chatAreaRef.current.scrollTop = chatAreaRef.current.scrollHeight;\n      }\n    }, 100);\n\n    // Check for auto transition first\n    if (node.data.autoTransitionTo) {\n      console.log(`⚡ Автопереход от ${node.id} к ${node.data.autoTransitionTo}`);\n      const autoTransitionNode = nodes.find(n => n.id === node.data.autoTransitionTo);\n      if (autoTransitionNode) {\n        setTimeout(() => processNode(autoTransitionNode), 800);\n        setCurrentNodeId(node.id);\n        return;\n      }\n    }\n    \n    // If not an input node and not a node with buttons, automatically proceed to next\n    if (!(node.type === 'keyboard' && node.data.action === 'input') && (!botMessage.buttons || botMessage.buttons.length === 0)) {\n      const nextNode = findNextNode(node.id);\n      if (nextNode) {\n        setTimeout(() => processNode(nextNode), 1000);\n      }\n    }\n\n    setCurrentNodeId(node.id);\n  }, [connections, findNextNode, nodes]);\n\n  // Handle button click\n  const handleButtonClick = (button: { text: string; target?: string; action?: string; }) => {\n    const now = new Date();\n    const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });\n\n    // Add user message\n    setMessageHistory(prev => [...prev, {\n      id: `user-${Date.now()}`,\n      type: 'user',\n      text: button.text,\n      time: timeString\n    }]);\n\n    // Clear reply keyboard after button click\n    setCurrentReplyKeyboard(null);\n\n    // Find target node and process it\n    if (button.target) {\n      const targetNode = nodes.find(node => node.id === button.target);\n      if (targetNode) {\n        setTimeout(() => processNode(targetNode), 500);\n      }\n    } else {\n      // If no target, find next node from current\n      const nextNode = findNextNode(currentNodeId);\n      if (nextNode) {\n        setTimeout(() => processNode(nextNode), 500);\n      }\n    }\n  };\n\n  // Handle text input\n  const handleSendMessage = () => {\n    if (!textInput.trim()) return;\n\n    const now = new Date();\n    const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });\n\n    // Add user message\n    setMessageHistory(prev => [...prev, {\n      id: `user-${Date.now()}`,\n      type: 'user',\n      text: textInput,\n      time: timeString\n    }]);\n\n    const inputText = textInput;\n    setTextInput('');\n    setWaitingForInput(false);\n\n    // Parse command if it starts with '/'\n    if (inputText.startsWith('/')) {\n      const command = parseCommandFromText(inputText);\n      if (command && command.command) {\n        // Find node with matching command\n        const commandNode = nodes.find(node => \n          node.data.command === command.command || \n          (node.data.text || node.data.messageText)?.includes(command.command)\n        );\n        if (commandNode) {\n          setTimeout(() => processNode(commandNode), 500);\n          return;\n        }\n      }\n    }\n\n    // For input nodes, proceed to next node\n    const currentNode = nodes.find(node => node.id === currentNodeId);\n    if (currentNode?.type === 'keyboard' && currentNode.data.action === 'input') {\n      const nextNode = findNextNode(currentNodeId);\n      if (nextNode) {\n        setTimeout(() => processNode(nextNode), 500);\n      }\n    }\n  };\n\n  // Handle keyboard enter\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSendMessage();\n    }\n  };\n\n  // Handle reply keyboard button click\n  const handleReplyKeyboardClick = (button: { text: string; target?: string; action?: string; }) => {\n    setTextInput(button.text);\n    handleSendMessage();\n  };\n\n  // Reset chat\n  const resetChat = () => {\n    setMessageHistory([]);\n    setCurrentNodeId('');\n    setCurrentReplyKeyboard(null);\n    setTextInput('');\n    setWaitingForInput(false);\n    \n    if (startNode) {\n      setTimeout(() => processNode(startNode), 500);\n    }\n  };\n\n  // Initialize chat when component mounts or nodes change\n  useEffect(() => {\n    if (startNode && messageHistory.length === 0) {\n      processNode(startNode);\n    }\n  }, [startNode, processNode, messageHistory.length]);\n\n  // Go back to editor\n  const handleGoBack = () => {\n    setLocation(`/editor/${projectId}`);\n  };\n\n  // Handle tab change for header\n  const handleTabChange = (tab: 'editor' | 'preview' | 'export' | 'bot') => {\n    if (tab === 'editor') {\n      handleGoBack();\n    } else if (tab === 'preview') {\n      // Already on preview\n      return;\n    }\n    // Other tabs would need navigation logic if implemented\n  };\n\n  // Handle save (no-op for preview)\n  const handleSave = () => {\n    // Preview page doesn't save\n  };\n\n  // Handle export (could navigate to export or show modal)\n  const handleExport = () => {\n    // Could implement export functionality\n  };\n\n  if (!currentProject) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <Card className=\"max-w-md w-full\">\n          <CardContent className=\"pt-6\">\n            <p className=\"text-center text-muted-foreground\">Проект не найден</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <Header\n        projectName={currentProject.name}\n        currentTab=\"preview\"\n        onTabChange={handleTabChange}\n        onSave={handleSave}\n        onExport={handleExport}\n        isSaving={false}\n      />\n\n      {/* Chat Interface */}\n      <div className=\"container mx-auto px-4 py-6 max-w-4xl\">\n        <Card className=\"h-[calc(100vh-200px)] flex flex-col\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Bot className=\"h-5 w-5\" />\n              Чат с ботом\n              <span className=\"text-sm font-normal text-muted-foreground ml-auto\">\n                {messageHistory.length} сообщений\n              </span>\n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={resetChat}\n                  data-testid=\"button-reset\"\n                >\n                  Перезапустить\n                </Button>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\" \n                  onClick={handleGoBack}\n                  data-testid=\"button-back\"\n                >\n                  <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                  К редактору\n                </Button>\n              </div>\n            </CardTitle>\n          </CardHeader>\n          \n          <CardContent className=\"flex-1 flex flex-col gap-4 overflow-hidden\">\n            {/* Chat messages */}\n            <div \n              ref={chatAreaRef}\n              className=\"flex-1 overflow-y-auto space-y-3 p-2 border rounded bg-muted/20\"\n              data-testid=\"chat-area\"\n            >\n              {messageHistory.map((message, index) => (\n                <div \n                  key={`${message.id}-${index}-${message.time}`} \n                  className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}\n                >\n                  <div className={`max-w-xs lg:max-w-md px-3 py-2 rounded-lg ${\n                    message.type === 'user' \n                      ? 'bg-primary text-primary-foreground' \n                      : 'bg-card border'\n                  }`}>\n                    {/* Media content */}\n                    {message.mediaType && message.mediaType !== 'location' && message.mediaType !== 'contact' && message.mediaType !== 'poll' && message.mediaType !== 'dice' && (\n                      <div className=\"mb-2\">\n                        {message.mediaType === 'photo' && (\n                          <img src={message.mediaUrl} alt=\"Фото\" className=\"max-w-full h-auto rounded\" />\n                        )}\n                        {message.mediaType === 'video' && (\n                          <video controls className=\"max-w-full h-auto rounded\">\n                            <source src={message.mediaUrl} type=\"video/mp4\" />\n                            Ваш браузер не поддерживает видео.\n                          </video>\n                        )}\n                        {message.mediaType === 'audio' && (\n                          <div className=\"flex items-center gap-2 p-2 bg-muted rounded\">\n                            <MessageCircle className=\"h-4 w-4\" />\n                            <span className=\"text-sm\">Аудио сообщение</span>\n                            {message.mediaData?.duration && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                {message.mediaData.duration}с\n                              </span>\n                            )}\n                          </div>\n                        )}\n                        {message.mediaType === 'document' && (\n                          <div className=\"flex items-center gap-2 p-2 bg-muted rounded\">\n                            <MessageCircle className=\"h-4 w-4\" />\n                            <span className=\"text-sm\">\n                              {message.mediaData?.filename || 'Документ'}\n                            </span>\n                          </div>\n                        )}\n                        {message.mediaType === 'sticker' && (\n                          <img src={message.mediaUrl} alt=\"Стикер\" className=\"w-32 h-32 object-contain\" />\n                        )}\n                        {message.mediaType === 'voice' && (\n                          <div className=\"flex items-center gap-2 p-2 bg-muted rounded\">\n                            <MessageCircle className=\"h-4 w-4\" />\n                            <span className=\"text-sm\">Голосовое сообщение</span>\n                            {message.mediaData?.duration && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                {message.mediaData.duration}с\n                              </span>\n                            )}\n                          </div>\n                        )}\n                        {message.mediaType === 'animation' && (\n                          <img src={message.mediaUrl} alt=\"Анимация\" className=\"max-w-full h-auto rounded\" />\n                        )}\n                      </div>\n                    )}\n\n                    {/* Special media types */}\n                    {message.mediaType === 'location' && (\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center gap-2 p-2 bg-muted rounded\">\n                          <MessageCircle className=\"h-4 w-4\" />\n                          <div>\n                            <div className=\"font-medium\">{message.mediaData?.title}</div>\n                            <div className=\"text-sm text-muted-foreground\">{message.mediaData?.address}</div>\n                          </div>\n                        </div>\n                      </div>\n                    )}\n\n                    {message.mediaType === 'contact' && (\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center gap-2 p-2 bg-muted rounded\">\n                          <Users className=\"h-4 w-4\" />\n                          <div>\n                            <div className=\"font-medium\">\n                              {message.mediaData?.firstName} {message.mediaData?.lastName}\n                            </div>\n                            <div className=\"text-sm text-muted-foreground flex items-center gap-1\">\n                              <Phone className=\"h-3 w-3\" />\n                              {message.mediaData?.phoneNumber}\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    )}\n\n                    {message.mediaType === 'poll' && (\n                      <div className=\"space-y-2\">\n                        <div className=\"font-medium\">{message.mediaData?.question}</div>\n                        <div className=\"space-y-1\">\n                          {message.mediaData?.options?.map((option: string, index: number) => (\n                            <div key={index} className=\"p-2 bg-muted rounded text-sm\">\n                              {option}\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {message.mediaType === 'dice' && (\n                      <div className=\"text-center\">\n                        <div className=\"text-4xl\">{message.mediaData?.emoji}</div>\n                      </div>\n                    )}\n\n                    {/* Text content */}\n                    {message.text && (\n                      <div \n                        className=\"text-sm whitespace-pre-wrap\"\n                        dangerouslySetInnerHTML={{ __html: renderMarkdown(message.text) }}\n                      />\n                    )}\n                    \n                    {/* Caption for media */}\n                    {message.mediaCaption && (\n                      <div className=\"text-xs text-muted-foreground mt-1\">\n                        {message.mediaCaption}\n                      </div>\n                    )}\n\n                    {/* Inline buttons */}\n                    {message.buttons && message.buttons.length > 0 && message.keyboardType === 'inline' && (\n                      <div className=\"mt-2 space-y-1\">\n                        {message.buttons.map((button, index) => (\n                          <Button\n                            key={index}\n                            variant=\"outline\"\n                            size=\"sm\"\n                            className=\"w-full text-xs\"\n                            onClick={() => handleButtonClick(button)}\n                            data-testid={`button-inline-${index}`}\n                          >\n                            {button.text}\n                          </Button>\n                        ))}\n                      </div>\n                    )}\n\n                    <div className=\"text-xs opacity-70 mt-1\">\n                      {message.time}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n\n            {/* Reply keyboard */}\n            {currentReplyKeyboard && currentReplyKeyboard.length > 0 && (\n              <div className=\"border rounded p-2 bg-muted/20\">\n                <div className=\"text-xs text-muted-foreground mb-2\">Быстрые ответы:</div>\n                <div className=\"grid grid-cols-2 gap-2\">\n                  {currentReplyKeyboard.map((button, index) => (\n                    <Button\n                      key={index}\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handleReplyKeyboardClick(button)}\n                      data-testid={`button-reply-${index}`}\n                    >\n                      {button.text}\n                    </Button>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Input area */}\n            <div className=\"flex gap-2\">\n              <Input\n                ref={inputRef}\n                value={textInput}\n                onChange={(e) => setTextInput(e.target.value)}\n                onKeyPress={handleKeyPress}\n                placeholder={waitingForInput ? \"Введите ответ...\" : \"Введите сообщение или команду...\"}\n                className=\"flex-1\"\n                data-testid=\"input-message\"\n              />\n              <Button \n                onClick={handleSendMessage} \n                disabled={!textInput.trim()}\n                data-testid=\"button-send\"\n              >\n                <Send className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","size_bytes":26183},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"client/src/components/ui/connections-layer.tsx":{"content":"import { Connection, Node } from '@/types/bot';\nimport { EnhancedConnectionLine } from './enhanced-connection-line';\n\ninterface ConnectionsLayerProps {\n  connections: Connection[];\n  nodes: Node[];\n  selectedConnectionId?: string;\n  onConnectionSelect?: (connectionId: string) => void;\n  onConnectionDelete?: (connectionId: string) => void;\n}\n\nexport function ConnectionsLayer({ \n  connections, \n  nodes, \n  selectedConnectionId,\n  onConnectionSelect,\n  onConnectionDelete\n}: ConnectionsLayerProps) {\n  if (!connections || connections.length === 0) return null;\n\n  return (\n    <svg \n      className=\"absolute inset-0 w-full h-full pointer-events-none\"\n      style={{ \n        zIndex: 2,\n        overflow: 'visible'\n      }}\n    >\n      {connections.map((connection) => (\n        <EnhancedConnectionLine\n          key={connection.id}\n          connection={connection}\n          nodes={nodes}\n          isSelected={selectedConnectionId === connection.id}\n          onClick={() => onConnectionSelect?.(connection.id)}\n          onDelete={() => onConnectionDelete?.(connection.id)}\n          showButtonInfo={true}\n        />\n      ))}\n    </svg>\n  );\n}","size_bytes":1149},"server/cache.ts":{"content":"// Простой in-memory кеш для API запросов\ninterface CacheEntry<T> {\n  data: T;\n  timestamp: number;\n  ttl: number; // time to live в миллисекундах\n}\n\nclass SimpleCache {\n  private cache = new Map<string, CacheEntry<any>>();\n\n  set<T>(key: string, data: T, ttlMs: number = 60000): void {\n    this.cache.set(key, {\n      data,\n      timestamp: Date.now(),\n      ttl: ttlMs\n    });\n  }\n\n  get<T>(key: string): T | null {\n    const entry = this.cache.get(key);\n    if (!entry) return null;\n\n    const now = Date.now();\n    const isExpired = now - entry.timestamp > entry.ttl;\n    \n    if (isExpired) {\n      this.cache.delete(key);\n      return null;\n    }\n\n    return entry.data as T;\n  }\n\n  delete(key: string): boolean {\n    return this.cache.delete(key);\n  }\n\n  clear(): void {\n    this.cache.clear();\n  }\n\n  // Автоматическая очистка просроченных записей\n  cleanup(): void {\n    const now = Date.now();\n    for (const [key, entry] of Array.from(this.cache.entries())) {\n      if (now - entry.timestamp > entry.ttl) {\n        this.cache.delete(key);\n      }\n    }\n  }\n\n  // Статистика кеша\n  getStats() {\n    return {\n      size: this.cache.size,\n      keys: Array.from(this.cache.keys())\n    };\n  }\n}\n\nexport const serverCache = new SimpleCache();\n\n// Запускаем очистку кеша каждые 5 минут\nsetInterval(() => {\n  serverCache.cleanup();\n}, 5 * 60 * 1000);\n\n// Хелпер для кеширования с проверкой\nexport function getCachedOrExecute<T>(\n  key: string,\n  fn: () => Promise<T>,\n  ttlMs: number = 60000\n): Promise<T> {\n  const cached = serverCache.get<T>(key);\n  if (cached !== null) {\n    return Promise.resolve(cached);\n  }\n\n  return fn().then(result => {\n    serverCache.set(key, result, ttlMs);\n    return result;\n  });\n}","size_bytes":1868},"client/src/components/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"@/components/theme-provider\";\n\nexport function ThemeToggle() {\n  const { setTheme, theme } = useTheme();\n\n  const toggleTheme = () => {\n    setTheme(theme === \"dark\" ? \"light\" : \"dark\");\n  };\n\n  return (\n    <Button \n      variant=\"outline\" \n      size=\"icon\" \n      className=\"relative overflow-hidden\"\n      onClick={toggleTheme}\n    >\n      <Sun className=\"h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all duration-300 dark:-rotate-90 dark:scale-0\" />\n      <Moon className=\"absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all duration-300 dark:rotate-0 dark:scale-100\" />\n      <span className=\"sr-only\">Переключить тему</span>\n    </Button>\n  );\n}","size_bytes":803},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { ServerStatus } from \"@/components/server-status\";\nimport { lazy, Suspense } from \"react\";\nimport { Loader2 } from \"lucide-react\";\nimport React from \"react\";\n\n// Ленивая загрузка страниц для улучшения производительности\nconst Home = lazy(() => import(\"@/pages/home\"));\nconst Editor = lazy(() => import(\"@/pages/editor\"));\nconst BotPreview = lazy(() => import(\"@/pages/bot-preview\"));\nconst TemplatesPage = lazy(() => import(\"@/pages/templates-wrapper\"));\nconst DatabaseManager = lazy(() => import(\"@/pages/DatabaseManager\"));\nconst NotFound = lazy(() => import(\"@/pages/not-found\"));\n\n// Более красивый компонент загрузки\nfunction LoadingSpinner() {\n  return (\n    <div className=\"flex items-center justify-center min-h-screen bg-background\">\n      <div className=\"flex flex-col items-center space-y-6\">\n        {/* Логотип или иконка */}\n        <div className=\"relative\">\n          <div className=\"w-16 h-16 rounded-full border-4 border-primary/20\"></div>\n          <Loader2 className=\"h-16 w-16 animate-spin text-primary absolute inset-0\" />\n        </div>\n        \n        {/* Текст загрузки */}\n        <div className=\"text-center space-y-2\">\n          <h3 className=\"text-lg font-medium text-foreground\">Telegram Bot Builder</h3>\n          <p className=\"text-sm text-muted-foreground\">Загружаем интерфейс...</p>\n          \n          {/* Индикатор прогресса */}\n          <div className=\"w-48 h-1 bg-muted rounded-full overflow-hidden\">\n            <div className=\"h-full bg-primary rounded-full animate-pulse\"></div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction Router() {\n  return (\n    <Suspense fallback={<LoadingSpinner />}>\n      <Switch>\n        <Route path=\"/projects\" component={Home} />\n        <Route path=\"/templates\" component={TemplatesPage} />\n        <Route path=\"/database\" component={DatabaseManager} />\n        <Route path=\"/preview/:id\" component={BotPreview} />\n        <Route path=\"/editor/:id\" component={Editor} />\n        <Route path=\"/projects/:id\" component={Editor} />\n        <Route path=\"/\" component={Editor} />\n        <Route component={NotFound} />\n      </Switch>\n    </Suspense>\n  );\n}\n\nfunction App() {\n  return (\n    <ThemeProvider defaultTheme=\"system\" storageKey=\"telegram-bot-builder-theme\">\n      <QueryClientProvider client={queryClient}>\n        <TooltipProvider>\n          <ServerStatus />\n          <Toaster />\n          <Router />\n        </TooltipProvider>\n      </QueryClientProvider>\n    </ThemeProvider>\n  );\n}\n\nexport default App;\n","size_bytes":2991},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"client/src/utils/button-connection-manager.ts":{"content":"import { Node, Connection, Button } from '@shared/schema';\nimport { nanoid } from 'nanoid';\n\nexport interface РекомендацияКнопки {\n  id: string;\n  текст: string;\n  исходныйУзел: string;\n  целевойУзел: string;\n  типДействия: 'goto' | 'command';\n  уверенность: number;\n  причина: string;\n}\n\n// Создание кнопки для соединения между узлами\nexport function создатьКнопкуДляСоединения(\n  исходныйУзел: Node,\n  целевойУзел: Node,\n  типДействия: 'goto' | 'command' = 'goto'\n): Button {\n  const текстКнопки = получитьТекстКнопки(целевойУзел, типДействия);\n  \n  return {\n    id: nanoid(),\n    text: текстКнопки,\n    action: типДействия,\n    target: типДействия === 'goto' ? целевойУзел.id : undefined,\n    url: типДействия === 'command' ? целевойУзел.data.command : undefined\n  };\n}\n\n// Генерация подходящего текста для кнопки\nfunction получитьТекстКнопки(узел: Node, типДействия: 'goto' | 'command'): string {\n  if (типДействия === 'command' && узел.data.command) {\n    return узел.data.command;\n  }\n\n  switch (узел.type) {\n    case 'start':\n      return '🏠 Главное меню';\n    case 'message':\n      return узел.data.messageText \n        ? узел.data.messageText.slice(0, 20) + (узел.data.messageText.length > 20 ? '...' : '')\n        : '💬 Сообщение';\n    case 'photo':\n      return '🖼️ Посмотреть фото';\n    case 'keyboard':\n      return '⌨️ Показать меню';\n    case 'input':\n      return '✏️ Ввести данные';\n    case 'condition':\n      return '🔀 Проверить условие';\n    case 'command':\n      return узел.data.command || '⚡ Выполнить команду';\n    default:\n      return '➡️ Продолжить';\n  }\n}\n\n// Анализ соединений и создание рекомендаций кнопок\nexport function найтиНужныеКнопки(\n  узлы: Node[],\n  соединения: Connection[]\n): РекомендацияКнопки[] {\n  const рекомендации: РекомендацияКнопки[] = [];\n\n  for (const соединение of соединения) {\n    const исходныйУзел = узлы.find(узел => узел.id === соединение.source);\n    const целевойУзел = узлы.find(узел => узел.id === соединение.target);\n\n    if (!исходныйУзел || !целевойУзел) continue;\n\n    // Проверяем, может ли узел иметь кнопки\n    if (!можетИметьКнопки(исходныйУзел)) continue;\n\n    // Проверяем, есть ли уже кнопка для этого соединения\n    const существующаяКнопка = исходныйУзел.data.buttons.find(кнопка => \n      (кнопка.action === 'goto' && кнопка.target === целевойУзел.id) ||\n      (кнопка.action === 'command' && кнопка.url === целевойУзел.data.command)\n    );\n\n    if (существующаяКнопка) continue;\n\n    // Определяем тип действия\n    const типДействия = целевойУзел.type === 'command' ? 'command' : 'goto';\n    \n    рекомендации.push({\n      id: nanoid(),\n      текст: получитьТекстКнопки(целевойУзел, типДействия),\n      исходныйУзел: исходныйУзел.id,\n      целевойУзел: целевойУзел.id,\n      типДействия,\n      уверенность: рассчитатьУверенность(исходныйУзел, целевойУзел),\n      причина: `Добавить кнопку \"${получитьТекстКнопки(целевойУзел, типДействия)}\" для перехода к ${получитьНазваниеТипа(целевойУзел)}`\n    });\n  }\n\n  return рекомендации.sort((а, б) => б.уверенность - а.уверенность);\n}\n\n// Проверка, может ли узел иметь кнопки\nfunction можетИметьКнопки(узел: Node): boolean {\n  return ['message', 'photo', 'keyboard', 'start', 'input'].includes(узел.type);\n}\n\n// Расчет уверенности для создания кнопки\nfunction рассчитатьУверенность(исходныйУзел: Node, целевойУзел: Node): number {\n  let уверенность = 0.7;\n\n  // Увеличиваем уверенность для логичных переходов\n  if (исходныйУзел.type === 'message' && целевойУзел.type === 'keyboard') уверенность += 0.2;\n  if (исходныйУзел.type === 'start' && целевойУзел.type === 'message') уверенность += 0.2;\n  if (исходныйУзел.type === 'keyboard' && целевойУзел.type === 'message') уверенность += 0.1;\n  if (целевойУзел.type === 'command') уверенность += 0.15;\n\n  // Уменьшаем для узлов с большим количеством кнопок\n  const количествоКнопок = исходныйУзел.data.buttons.length;\n  if (количествоКнопок > 3) уверенность -= 0.1;\n  if (количествоКнопок > 6) уверенность -= 0.2;\n\n  return Math.min(0.95, Math.max(0.3, уверенность));\n}\n\n// Получение названия типа узла\nfunction получитьНазваниеТипа(узел: Node): string {\n  const названияТипов = {\n    start: 'главному меню',\n    message: 'сообщению',\n    photo: 'фото',\n    keyboard: 'клавиатуре',\n    input: 'вводу данных',\n    condition: 'условию',\n    command: 'команде'\n  };\n  return названияТипов[узел.type] || 'узлу';\n}\n\n// Автоматическое создание всех нужных кнопок\nexport function автоСозданиеКнопок(\n  узлы: Node[],\n  соединения: Connection[]\n): { обновленныеУзлы: Node[]; созданоКнопок: number } {\n  const рекомендации = найтиНужныеКнопки(узлы, соединения);\n  let созданоКнопок = 0;\n  \n  const обновленныеУзлы = узлы.map(узел => {\n    const рекомендацииДляУзла = рекомендации.filter(р => р.исходныйУзел === узел.id);\n    \n    if (рекомендацииДляУзла.length === 0) return узел;\n\n    const новыеКнопки = рекомендацииДляУзла.map(рекомендация => {\n      const целевойУзел = узлы.find(у => у.id === рекомендация.целевойУзел)!;\n      return создатьКнопкуДляСоединения(узел, целевойУзел, рекомендация.типДействия);\n    });\n\n    созданоКнопок += новыеКнопки.length;\n\n    return {\n      ...узел,\n      data: {\n        ...узел.data,\n        buttons: [...узел.data.buttons, ...новыеКнопки]\n      }\n    };\n  });\n\n  return { обновленныеУзлы, созданоКнопок };\n}\n\n// Удаление ненужных кнопок\nexport function очиститьЛишниеКнопки(\n  узлы: Node[],\n  соединения: Connection[]\n): { обновленныеУзлы: Node[]; удаленоКнопок: number } {\n  let удаленоКнопок = 0;\n  \n  const обновленныеУзлы = узлы.map(узел => {\n    const валидныеКнопки = узел.data.buttons.filter(кнопка => {\n      if (кнопка.action === 'goto' && кнопка.target) {\n        // Проверяем, есть ли соединение для этой кнопки\n        const естьСоединение = соединения.some(соед => \n          соед.source === узел.id && соед.target === кнопка.target\n        );\n        if (!естьСоединение) {\n          удаленоКнопок++;\n          return false;\n        }\n      }\n      return true;\n    });\n\n    return {\n      ...узел,\n      data: {\n        ...узел.data,\n        buttons: валидныеКнопки\n      }\n    };\n  });\n\n  return { обновленныеУзлы, удаленоКнопок };\n}\n\n// Синхронизация кнопок с соединениями\nexport function синхронизироватьКнопкиСоединения(\n  узлы: Node[],\n  соединения: Connection[]\n): { обновленныеУзлы: Node[]; изменения: { создано: number; удалено: number } } {\n  // Сначала убираем ненужные кнопки\n  const { обновленныеУзлы: очищенныеУзлы, удаленоКнопок } = очиститьЛишниеКнопки(узлы, соединения);\n  \n  // Затем создаем недостающие кнопки\n  const { обновленныеУзлы: финальныеУзлы, созданоКнопок } = автоСозданиеКнопок(очищенныеУзлы, соединения);\n\n  return {\n    обновленныеУзлы: финальныеУзлы,\n    изменения: {\n      создано: созданоКнопок,\n      удалено: удаленоКнопок\n    }\n  };\n}","size_bytes":9881},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground transition-all duration-200 dark:border-2 dark:border-border/80 dark:hover:border-primary/80 dark:hover:shadow-lg dark:hover:scale-105 dark:data-[state=checked]:border-primary dark:data-[state=checked]:shadow-primary/20 dark:data-[state=checked]:shadow-lg\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current transition-all duration-200 dark:drop-shadow-sm\")}\n    >\n      <Check className=\"h-4 w-4 dark:font-bold dark:stroke-2\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1389},"server/db-cache.ts":{"content":"// Enhanced caching layer for database operations\nimport { BotProject, BotTemplate, BotInstance } from '@shared/schema';\n\nexport class DatabaseCache {\n  private static instance: DatabaseCache;\n  private cache: Map<string, { data: any; timestamp: number; ttl: number }> = new Map();\n  private defaultTTL = 5 * 60 * 1000; // 5 minutes\n\n  private constructor() {}\n\n  static getInstance(): DatabaseCache {\n    if (!DatabaseCache.instance) {\n      DatabaseCache.instance = new DatabaseCache();\n    }\n    return DatabaseCache.instance;\n  }\n\n  // Set cache entry\n  set(key: string, data: any, ttl: number = this.defaultTTL): void {\n    this.cache.set(key, {\n      data: JSON.parse(JSON.stringify(data)), // Deep clone\n      timestamp: Date.now(),\n      ttl\n    });\n  }\n\n  // Get cache entry\n  get<T>(key: string): T | null {\n    const entry = this.cache.get(key);\n    if (!entry) return null;\n\n    // Check if expired\n    if (Date.now() - entry.timestamp > entry.ttl) {\n      this.cache.delete(key);\n      return null;\n    }\n\n    return entry.data as T;\n  }\n\n  // Delete cache entry\n  delete(key: string): void {\n    this.cache.delete(key);\n  }\n\n  // Clear cache by pattern\n  clearByPattern(pattern: string): void {\n    const regex = new RegExp(pattern);\n    for (const key of this.cache.keys()) {\n      if (regex.test(key)) {\n        this.cache.delete(key);\n      }\n    }\n  }\n\n  // Clear all cache\n  clear(): void {\n    this.cache.clear();\n  }\n\n  // Get cache statistics\n  getStats() {\n    const entries = Array.from(this.cache.entries());\n    const now = Date.now();\n    \n    return {\n      totalEntries: entries.length,\n      expiredEntries: entries.filter(([_, entry]) => now - entry.timestamp > entry.ttl).length,\n      memoryUsage: this.getMemoryUsage(),\n      hitRate: this.getHitRate()\n    };\n  }\n\n  // Cleanup expired entries\n  cleanup(): void {\n    const now = Date.now();\n    const keysToDelete: string[] = [];\n\n    for (const [key, entry] of this.cache.entries()) {\n      if (now - entry.timestamp > entry.ttl) {\n        keysToDelete.push(key);\n      }\n    }\n\n    keysToDelete.forEach(key => this.cache.delete(key));\n    console.log(`Cleaned up ${keysToDelete.length} expired cache entries`);\n  }\n\n  private getMemoryUsage(): number {\n    const entries = Array.from(this.cache.values());\n    return entries.reduce((size, entry) => {\n      return size + JSON.stringify(entry.data).length;\n    }, 0);\n  }\n\n  private hitRate(): number {\n    // This would require tracking hits and misses\n    // For now, return a placeholder\n    return 0.85; // 85% hit rate\n  }\n\n  private getHitRate(): number {\n    return this.hitRate();\n  }\n}\n\n// Cached storage operations\nexport class CachedDatabaseOperations {\n  private cache = DatabaseCache.getInstance();\n\n  // Cache project data\n  async getProjectCached(id: number, fetcher: () => Promise<BotProject | undefined>): Promise<BotProject | undefined> {\n    const key = `project:${id}`;\n    const cached = this.cache.get<BotProject>(key);\n    \n    if (cached) {\n      return cached;\n    }\n\n    const project = await fetcher();\n    if (project) {\n      this.cache.set(key, project);\n    }\n    \n    return project;\n  }\n\n  // Cache template data\n  async getTemplateCached(id: number, fetcher: () => Promise<BotTemplate | undefined>): Promise<BotTemplate | undefined> {\n    const key = `template:${id}`;\n    const cached = this.cache.get<BotTemplate>(key);\n    \n    if (cached) {\n      return cached;\n    }\n\n    const template = await fetcher();\n    if (template) {\n      this.cache.set(key, template, 10 * 60 * 1000); // 10 minutes for templates\n    }\n    \n    return template;\n  }\n\n  // Cache templates list\n  async getTemplateListCached(category: string, fetcher: () => Promise<BotTemplate[]>): Promise<BotTemplate[]> {\n    const key = `templates:${category}`;\n    const cached = this.cache.get<BotTemplate[]>(key);\n    \n    if (cached) {\n      return cached;\n    }\n\n    const templates = await fetcher();\n    this.cache.set(key, templates, 2 * 60 * 1000); // 2 minutes for lists\n    \n    return templates;\n  }\n\n  // Invalidate related caches\n  invalidateProject(id: number): void {\n    this.cache.delete(`project:${id}`);\n    this.cache.clearByPattern(`project:${id}:.*`);\n  }\n\n  invalidateTemplate(id: number): void {\n    this.cache.delete(`template:${id}`);\n    this.cache.clearByPattern(`templates:.*`); // Invalidate all template lists\n  }\n\n  invalidateAllTemplates(): void {\n    this.cache.clearByPattern(`templates:.*`);\n  }\n\n  // Get cache statistics\n  getStats() {\n    return this.cache.getStats();\n  }\n\n  // Cleanup expired entries\n  cleanup(): void {\n    this.cache.cleanup();\n  }\n}\n\n// Auto-cleanup every 5 minutes\nsetInterval(() => {\n  DatabaseCache.getInstance().cleanup();\n}, 5 * 60 * 1000);\n\nexport const dbCache = DatabaseCache.getInstance();\nexport const cachedOps = new CachedDatabaseOperations();","size_bytes":4854},"client/src/components/media/file-optimizer.tsx":{"content":"import React, { useState, useCallback } from 'react';\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Zap, Image, FileVideo, FileAudio, Download, Settings, CheckCircle2 } from \"lucide-react\";\n\ninterface FileOptimizerProps {\n  files: File[];\n  onOptimizedFiles?: (files: File[]) => void;\n  onClose?: () => void;\n}\n\ninterface OptimizationSettings {\n  images: {\n    compress: boolean;\n    quality: number;\n    maxWidth: number;\n    format: 'original' | 'jpeg' | 'webp';\n  };\n  videos: {\n    compress: boolean;\n    quality: 'low' | 'medium' | 'high';\n    maxSize: number;\n  };\n  audio: {\n    compress: boolean;\n    bitrate: number;\n  };\n}\n\nexport function FileOptimizer({ files, onOptimizedFiles, onClose }: FileOptimizerProps) {\n  const { toast } = useToast();\n  const [isOptimizing, setIsOptimizing] = useState(false);\n  const [optimizationProgress, setOptimizationProgress] = useState(0);\n  const [optimizedFiles, setOptimizedFiles] = useState<File[]>([]);\n  const [settings, setSettings] = useState<OptimizationSettings>({\n    images: {\n      compress: true,\n      quality: 85,\n      maxWidth: 1920,\n      format: 'original'\n    },\n    videos: {\n      compress: false,\n      quality: 'medium',\n      maxSize: 50\n    },\n    audio: {\n      compress: false,\n      bitrate: 128\n    }\n  });\n\n  // Статистика файлов\n  const fileStats = files.reduce((acc, file) => {\n    const type = file.type.split('/')[0];\n    acc[type] = (acc[type] || 0) + 1;\n    acc.totalSize = (acc.totalSize || 0) + file.size;\n    return acc;\n  }, {} as Record<string, number>);\n\n  // Сжатие изображений\n  const compressImage = useCallback(async (file: File): Promise<File> => {\n    return new Promise((resolve) => {\n      const canvas = document.createElement('canvas');\n      const ctx = canvas.getContext('2d');\n      const img = new Image();\n      \n      img.onload = () => {\n        // Вычисляем новые размеры\n        let { width, height } = img;\n        const maxWidth = settings.images.maxWidth;\n        \n        if (width > maxWidth) {\n          height = (height * maxWidth) / width;\n          width = maxWidth;\n        }\n        \n        canvas.width = width;\n        canvas.height = height;\n        \n        // Рисуем сжатое изображение\n        ctx?.drawImage(img, 0, 0, width, height);\n        \n        // Конвертируем в Blob\n        canvas.toBlob((blob) => {\n          if (blob) {\n            const compressedFile = new File([blob], file.name, {\n              type: settings.images.format === 'original' ? file.type : `image/${settings.images.format}`,\n              lastModified: Date.now()\n            });\n            resolve(compressedFile);\n          } else {\n            resolve(file);\n          }\n        }, settings.images.format === 'original' ? file.type : `image/${settings.images.format}`, settings.images.quality / 100);\n      };\n      \n      img.src = URL.createObjectURL(file);\n    });\n  }, [settings.images]);\n\n  // Оптимизация файлов\n  const optimizeFiles = useCallback(async () => {\n    setIsOptimizing(true);\n    setOptimizationProgress(0);\n    \n    try {\n      const optimized: File[] = [];\n      \n      for (let i = 0; i < files.length; i++) {\n        const file = files[i];\n        let optimizedFile = file;\n        \n        // Оптимизируем изображения\n        if (file.type.startsWith('image/') && settings.images.compress) {\n          optimizedFile = await compressImage(file);\n        }\n        \n        optimized.push(optimizedFile);\n        setOptimizationProgress(Math.round(((i + 1) / files.length) * 100));\n        \n        // Небольшая задержка для показа прогресса\n        await new Promise(resolve => setTimeout(resolve, 100));\n      }\n      \n      setOptimizedFiles(optimized);\n      \n      // Вычисляем статистику сжатия\n      const originalSize = files.reduce((sum, file) => sum + file.size, 0);\n      const optimizedSize = optimized.reduce((sum, file) => sum + file.size, 0);\n      const savedPercentage = Math.round(((originalSize - optimizedSize) / originalSize) * 100);\n      \n      toast({\n        title: \"Оптимизация завершена\",\n        description: `Сэкономлено ${savedPercentage}% места (${formatFileSize(originalSize - optimizedSize)})`,\n      });\n      \n    } catch (error) {\n      console.error('Optimization error:', error);\n      toast({\n        title: \"Ошибка оптимизации\",\n        description: \"Не удалось оптимизировать некоторые файлы\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsOptimizing(false);\n    }\n  }, [files, settings, compressImage, toast]);\n\n  // Форматирование размера файла\n  const formatFileSize = (bytes: number): string => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  // Применение оптимизированных файлов\n  const applyOptimizedFiles = () => {\n    onOptimizedFiles?.(optimizedFiles);\n    onClose?.();\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Заголовок */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-xl font-semibold flex items-center\">\n            <Zap className=\"w-5 h-5 mr-2 text-yellow-500\" />\n            Оптимизация файлов\n          </h2>\n          <p className=\"text-sm text-muted-foreground mt-1\">\n            Сжатие и оптимизация файлов для ускорения загрузки\n          </p>\n        </div>\n      </div>\n\n      {/* Статистика файлов */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">Обзор файлов</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-blue-600\">{files.length}</div>\n              <div className=\"text-muted-foreground\">Всего файлов</div>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-green-600\">{fileStats.image || 0}</div>\n              <div className=\"text-muted-foreground\">Изображений</div>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-purple-600\">{fileStats.video || 0}</div>\n              <div className=\"text-muted-foreground\">Видео</div>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-orange-600\">{formatFileSize(fileStats.totalSize || 0)}</div>\n              <div className=\"text-muted-foreground\">Общий размер</div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Настройки оптимизации */}\n      <Tabs defaultValue=\"images\">\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"images\" className=\"flex items-center\">\n            <Image className=\"w-4 h-4 mr-2\" />\n            Изображения\n            <Badge variant=\"secondary\" className=\"ml-2\">{fileStats.image || 0}</Badge>\n          </TabsTrigger>\n          <TabsTrigger value=\"videos\" disabled={!fileStats.video}>\n            <FileVideo className=\"w-4 h-4 mr-2\" />\n            Видео\n            <Badge variant=\"secondary\" className=\"ml-2\">{fileStats.video || 0}</Badge>\n          </TabsTrigger>\n          <TabsTrigger value=\"audio\" disabled={!fileStats.audio}>\n            <FileAudio className=\"w-4 h-4 mr-2\" />\n            Аудио\n            <Badge variant=\"secondary\" className=\"ml-2\">{fileStats.audio || 0}</Badge>\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"images\" className=\"space-y-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"compress-images\">Сжимать изображения</Label>\n                  <Switch\n                    id=\"compress-images\"\n                    checked={settings.images.compress}\n                    onCheckedChange={(checked) => \n                      setSettings(prev => ({ \n                        ...prev, \n                        images: { ...prev.images, compress: checked }\n                      }))\n                    }\n                  />\n                </div>\n                \n                {settings.images.compress && (\n                  <>\n                    <div className=\"space-y-2\">\n                      <Label>Качество: {settings.images.quality}%</Label>\n                      <Slider\n                        value={[settings.images.quality]}\n                        onValueChange={([value]) => \n                          setSettings(prev => ({ \n                            ...prev, \n                            images: { ...prev.images, quality: value }\n                          }))\n                        }\n                        max={100}\n                        min={10}\n                        step={5}\n                      />\n                    </div>\n                    \n                    <div className=\"space-y-2\">\n                      <Label>Максимальная ширина: {settings.images.maxWidth}px</Label>\n                      <Slider\n                        value={[settings.images.maxWidth]}\n                        onValueChange={([value]) => \n                          setSettings(prev => ({ \n                            ...prev, \n                            images: { ...prev.images, maxWidth: value }\n                          }))\n                        }\n                        max={4096}\n                        min={800}\n                        step={100}\n                      />\n                    </div>\n                  </>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"videos\" className=\"space-y-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-center text-muted-foreground\">\n                <FileVideo className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n                <p>Оптимизация видео будет добавлена в следующих версиях</p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"audio\" className=\"space-y-4\">\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-center text-muted-foreground\">\n                <FileAudio className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n                <p>Оптимизация аудио будет добавлена в следующих версиях</p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      {/* Прогресс оптимизации */}\n      {isOptimizing && (\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <Label>Оптимизация файлов...</Label>\n            <span className=\"text-sm text-muted-foreground\">{optimizationProgress}%</span>\n          </div>\n          <Progress value={optimizationProgress} />\n        </div>\n      )}\n\n      {/* Результаты оптимизации */}\n      {optimizedFiles.length > 0 && !isOptimizing && (\n        <Card className=\"border-green-200 bg-green-50 dark:bg-green-950 dark:border-green-800\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center mb-4\">\n              <CheckCircle2 className=\"w-5 h-5 text-green-600 mr-2\" />\n              <span className=\"font-medium text-green-800 dark:text-green-200\">\n                Оптимизация завершена успешно\n              </span>\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\n              <div>\n                <span className=\"text-muted-foreground\">Исходный размер:</span>\n                <div className=\"font-medium\">{formatFileSize(files.reduce((sum, file) => sum + file.size, 0))}</div>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Оптимизированный размер:</span>\n                <div className=\"font-medium text-green-600\">\n                  {formatFileSize(optimizedFiles.reduce((sum, file) => sum + file.size, 0))}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Кнопки действий */}\n      <div className=\"flex justify-end gap-3\">\n        <Button variant=\"outline\" onClick={onClose} disabled={isOptimizing}>\n          Отмена\n        </Button>\n        \n        {optimizedFiles.length === 0 ? (\n          <Button \n            onClick={optimizeFiles} \n            disabled={isOptimizing || !settings.images.compress}\n            className=\"flex items-center\"\n          >\n            <Zap className=\"w-4 h-4 mr-2\" />\n            {isOptimizing ? 'Оптимизация...' : 'Оптимизировать'}\n          </Button>\n        ) : (\n          <Button onClick={applyOptimizedFiles} className=\"flex items-center\">\n            <Download className=\"w-4 h-4 mr-2\" />\n            Применить оптимизированные файлы\n          </Button>\n        )}\n      </div>\n    </div>\n  );\n}","size_bytes":14396},"client/src/pages/editor.tsx":{"content":"import { useState, useCallback, useEffect } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { useLocation, useParams, useRoute } from 'wouter';\nimport { Header } from '@/components/editor/header';\nimport { ComponentsSidebar } from '@/components/editor/components-sidebar';\nimport { Canvas } from '@/components/editor/canvas';\nimport { PropertiesPanel } from '@/components/editor/properties-panel';\nimport { CodePanel } from '@/components/editor/code-panel';\nimport { ExportPanel } from '@/components/editor/export-panel';\nimport { BotControl } from '@/components/editor/bot-control';\nimport { SaveTemplateModal } from '@/components/editor/save-template-modal';\nimport { VisibilityControls } from '@/components/editor/visibility-controls';\n\nimport { ConnectionManagerPanel } from '@/components/editor/connection-manager-panel';\nimport { EnhancedConnectionControls } from '@/components/editor/enhanced-connection-controls';\nimport { ConnectionVisualization } from '@/components/editor/connection-visualization';\nimport { SmartConnectionCreator } from '@/components/editor/smart-connection-creator';\nimport { UserDatabasePanel } from '@/components/editor/user-database-panel';\nimport { GroupsPanel } from '@/components/editor/groups-panel';\nimport { AdaptiveLayout } from '@/components/layout/adaptive-layout';\nimport { AdaptiveHeader } from '@/components/layout/adaptive-header';\nimport { LayoutManager, useLayoutManager } from '@/components/layout/layout-manager';\nimport { LayoutCustomizer } from '@/components/layout/layout-customizer';\nimport { SimpleLayoutCustomizer, SimpleLayoutConfig } from '@/components/layout/simple-layout-customizer';\nimport { FlexibleLayout } from '@/components/layout/flexible-layout';\nimport { ResizablePanelGroup, ResizablePanel, ResizableHandle } from '@/components/ui/resizable';\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from '@/components/ui/sheet';\nimport { useBotEditor } from '@/hooks/use-bot-editor';\nimport { useToast } from '@/hooks/use-toast';\nimport { useIsMobile } from '@/hooks/use-mobile';\nimport { apiRequest } from '@/lib/queryClient';\nimport { BotProject, Connection, ComponentDefinition, BotData, BotDataWithSheets, Node } from '@shared/schema';\nimport { SheetsManager } from '@/utils/sheets-manager';\nimport { nanoid } from 'nanoid';\n\nexport default function Editor() {\n  const [, setLocation] = useLocation();\n  const [match, params] = useRoute('/editor/:id');\n  const projectId = params?.id ? parseInt(params.id) : null;\n  const [currentTab, setCurrentTab] = useState<'editor' | 'preview' | 'export' | 'bot' | 'users' | 'groups'>('editor');\n  const [showSaveTemplate, setShowSaveTemplate] = useState(false);\n  const [showMobileSidebar, setShowMobileSidebar] = useState(false);\n  const [showMobileProperties, setShowMobileProperties] = useState(false);\n  \n  // Определяем мобильное устройство\n  const isMobile = useIsMobile();\n\n  // Эффект для корректного восстановления мобильного интерфейса при навигации\n  useEffect(() => {\n    if (isMobile) {\n      // Закрываем все мобильные панели при возврате к редактору\n      setShowMobileSidebar(false);\n      setShowMobileProperties(false);\n      \n      // Устанавливаем корректную конфигурацию layout для мобильных устройств\n      setFlexibleLayoutConfig(prev => ({\n        ...prev,\n        elements: prev.elements.map(element => {\n          // На мобильных устройствах по умолчанию скрываем sidebar и properties панели,\n          // но оставляем их в конфигурации, чтобы кнопки мобильного доступа работали\n          if (element.type === 'sidebar' || element.type === 'properties') {\n            return { ...element, visible: false };\n          }\n          return element;\n        })\n      }));\n    } else {\n      // На десктопе восстанавливаем все панели\n      setFlexibleLayoutConfig(prev => ({\n        ...prev,\n        elements: prev.elements.map(element => ({\n          ...element,\n          visible: true\n        }))\n      }));\n    }\n  }, [isMobile]); // Убираем match из зависимостей, чтобы эффект не срабатывал при каждой навигации\n\n  const [selectedConnectionId, setSelectedConnectionId] = useState<string | null>(null);\n  const [autoButtonCreation, setAutoButtonCreation] = useState(true);\n  const [selectedConnection, setSelectedConnection] = useState<Connection | null>(null);\n  const [showLayoutManager, setShowLayoutManager] = useState(false);\n  const [showLayoutCustomizer, setShowLayoutCustomizer] = useState(false);\n  const [useFlexibleLayout, setUseFlexibleLayout] = useState(true);\n  \n  // Новая система листов\n  const [botDataWithSheets, setBotDataWithSheets] = useState<BotDataWithSheets | null>(null);\n  \n  // Состояние для реальных размеров узлов (для иерархического layout)\n  const [currentNodeSizes, setCurrentNodeSizes] = useState<Map<string, { width: number; height: number }>>(new Map());\n  \n  // Флаг для предотвращения перезаписи данных во время загрузки шаблона  \n  const [isLoadingTemplate, setIsLoadingTemplate] = useState(false);\n  \n  // Флаг для предотвращения перезаписи при локальных изменениях\n  const [hasLocalChanges, setHasLocalChanges] = useState(false);\n  \n  // Track the last loaded project ID to prevent unnecessary reloads\n  const [lastLoadedProjectId, setLastLoadedProjectId] = useState<number | null>(null);\n  \n  // Callback для получения размеров узлов из Canvas\n  const handleNodeSizesChange = useCallback((nodeSizes: Map<string, { width: number; height: number }>) => {\n    setCurrentNodeSizes(nodeSizes);\n  }, []);\n  \n  // Функции для управления видимостью панелей\n  const handleToggleHeader = useCallback(() => {\n    setFlexibleLayoutConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(element =>\n        element.id === 'header'\n          ? { ...element, visible: !element.visible }\n          : element\n      )\n    }));\n  }, []);\n\n  const handleToggleSidebar = useCallback(() => {\n    setFlexibleLayoutConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(element =>\n        element.id === 'sidebar'\n          ? { ...element, visible: !element.visible }\n          : element\n      )\n    }));\n  }, []);\n\n  const handleToggleProperties = useCallback(() => {\n    setFlexibleLayoutConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(element =>\n        element.id === 'properties'\n          ? { ...element, visible: !element.visible }\n          : element\n      )\n    }));\n  }, []);\n\n  const handleToggleCanvas = useCallback(() => {\n    setFlexibleLayoutConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(element =>\n        element.id === 'canvas'\n          ? { ...element, visible: !element.visible }\n          : element\n      )\n    }));\n  }, []);\n\n  const handleToggleCode = useCallback(() => {\n    setFlexibleLayoutConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(element =>\n        element.id === 'code'\n          ? { ...element, visible: !element.visible }\n          : element\n      )\n    }));\n  }, []);\n\n  const handleOpenMobileSidebar = useCallback(() => {\n    setShowMobileSidebar(true);\n  }, []);\n\n  const handleOpenMobileProperties = useCallback(() => {\n    setShowMobileProperties(true);\n  }, []);\n\n  // Создаем динамическую конфигурацию макета\n  const getFlexibleLayoutConfig = useCallback((): SimpleLayoutConfig => {\n    // Используем компактный заголовок для всех устройств\n    const headerSize = isMobile ? 2.5 : 3;\n    \n    return {\n      elements: [\n        {\n          id: 'header',\n          type: 'header',\n          name: 'Шапка',\n          position: 'top',\n          size: headerSize,\n          visible: true\n        },\n        {\n          id: 'sidebar',\n          type: 'sidebar',\n          name: 'Боковая панель',\n          position: 'left',\n          size: 20,\n          visible: true\n        },\n        {\n          id: 'canvas',\n          type: 'canvas',\n          name: 'Холст',\n          position: 'center',\n          size: 35,\n          visible: true\n        },\n        {\n          id: 'properties',\n          type: 'properties',\n          name: 'Свойства',\n          position: 'right',\n          size: 20,\n          visible: true\n        },\n        {\n          id: 'code',\n          type: 'code',\n          name: 'Код',\n          position: 'right',\n          size: 25,\n          visible: false\n        }\n      ],\n      compactMode: false,\n      showGrid: true\n    };\n  }, [currentTab, isMobile]);\n\n  const [flexibleLayoutConfig, setFlexibleLayoutConfig] = useState<SimpleLayoutConfig>(getFlexibleLayoutConfig());\n  \n  // Обновляем конфигурацию макета при изменении вкладки или размера экрана\n  useEffect(() => {\n    setFlexibleLayoutConfig(getFlexibleLayoutConfig());\n  }, [getFlexibleLayoutConfig]);\n  \n  const { config: layoutConfig, updateConfig: updateLayoutConfig, resetConfig: resetLayoutConfig, applyConfig: applyLayoutConfig } = useLayoutManager();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Load all projects\n  const { data: projects } = useQuery<BotProject[]>({\n    queryKey: ['/api/projects'],\n  });\n\n  // Find current project by ID from URL\n  const currentProject = projects?.find(p => p.id === projectId) || projects?.[0];\n\n  const {\n    nodes,\n    connections,\n    selectedNode,\n    selectedNodeId,\n    setSelectedNodeId,\n    addNode,\n    updateNode,\n    deleteNode,\n    duplicateNode,\n    duplicateNodes,\n    addConnection,\n    deleteConnection,\n    updateConnection,\n    updateNodeData,\n    addButton,\n    updateButton,\n    deleteButton,\n    updateNodes,\n    setBotData,\n    getBotData,\n    undo,\n    redo,\n    canUndo,\n    canRedo,\n    copyToClipboard,\n    pasteFromClipboard,\n    hasClipboardData,\n    isNodeBeingDragged,\n    setIsNodeBeingDragged\n  } = useBotEditor(currentProject?.data as BotData);\n\n  // Reset hasLocalChanges when project changes\n  useEffect(() => {\n    if (currentProject?.id !== lastLoadedProjectId && lastLoadedProjectId !== null) {\n      setHasLocalChanges(false);\n    }\n  }, [currentProject?.id, lastLoadedProjectId]);\n\n  // Обработчик обновления данных листов\n  const handleBotDataUpdate = useCallback((updatedData: BotDataWithSheets) => {\n    setBotDataWithSheets(updatedData);\n    \n    // Синхронизируем активный лист с системой редактора\n    const activeSheet = SheetsManager.getActiveSheet(updatedData);\n    if (activeSheet) {\n      // Всегда применяем автоиерархию при обновлении данных листов для правильного отображения\n      const shouldSkipLayout = false; // Автоиерархия необходима для корректного расположения узлов\n      setBotData({ nodes: activeSheet.nodes, connections: activeSheet.connections }, undefined, shouldSkipLayout ? undefined : currentNodeSizes, shouldSkipLayout);\n    }\n  }, [setBotData, currentNodeSizes, isMobile, nodes.length]);\n\n  // Обертка для обновления узлов, которая синхронизирует изменения с системой листов\n  const handleNodeUpdateWithSheets = useCallback((nodeId: string, updates: any) => {\n    // Обновляем в старой системе\n    updateNodeData(nodeId, updates);\n    \n    // Также обновляем в новой системе листов\n    if (botDataWithSheets && botDataWithSheets.activeSheetId) {\n      const updatedSheets = botDataWithSheets.sheets.map(sheet => {\n        if (sheet.id === botDataWithSheets.activeSheetId) {\n          return {\n            ...sheet,\n            nodes: sheet.nodes.map(node => \n              node.id === nodeId \n                ? { ...node, data: { ...node.data, ...updates } }\n                : node\n            )\n          };\n        }\n        return sheet;\n      });\n      \n      setBotDataWithSheets({\n        ...botDataWithSheets,\n        sheets: updatedSheets\n      });\n    }\n  }, [updateNodeData, botDataWithSheets]);\n\n  // Обработчик смены типа узла\n  const handleNodeTypeChange = useCallback((nodeId: string, newType: any, newData: any) => {\n    // Обновляем в старой системе\n    updateNode(nodeId, { type: newType, data: newData });\n    \n    // Также обновляем в новой системе листов\n    if (botDataWithSheets && botDataWithSheets.activeSheetId) {\n      const updatedSheets = botDataWithSheets.sheets.map(sheet => {\n        if (sheet.id === botDataWithSheets.activeSheetId) {\n          return {\n            ...sheet,\n            nodes: sheet.nodes.map(node => \n              node.id === nodeId \n                ? { ...node, type: newType, data: newData }\n                : node\n            )\n          };\n        }\n        return sheet;\n      });\n      \n      setBotDataWithSheets({\n        ...botDataWithSheets,\n        sheets: updatedSheets\n      });\n    }\n  }, [updateNode, botDataWithSheets]);\n\n  // Обновляем данные бота при смене проекта - only when truly switching projects\n  useEffect(() => {\n    \n    // Only load project data when:\n    // 1. We have a project with data\n    // 2. We're not loading a template  \n    // 3. We don't have local changes in progress\n    // 4. This is truly a new project (ID changed) OR initial load (lastLoadedProjectId is null)\n    if (currentProject?.data && !isLoadingTemplate && !hasLocalChanges && \n        (lastLoadedProjectId !== currentProject?.id)) {\n      \n      console.log('📂 Loading project data for project ID:', currentProject.id);\n      const projectData = currentProject.data as any;\n      \n      // Проверяем, новый ли это формат с листами\n      if (SheetsManager.isNewFormat(projectData)) {\n        setBotDataWithSheets(projectData);\n        // Устанавливаем активный лист для совместимости со старой системой\n        const activeSheet = SheetsManager.getActiveSheet(projectData);\n        if (activeSheet) {\n          // Всегда применяем layout при первой загрузке проекта, пропускаем только при повторной загрузке на мобильных\n          const shouldSkipLayout = isMobile && nodes.length > 0 && !isLoadingTemplate && lastLoadedProjectId !== null;\n          setBotData({ nodes: activeSheet.nodes, connections: activeSheet.connections }, undefined, shouldSkipLayout ? undefined : currentNodeSizes, shouldSkipLayout);\n        }\n      } else {\n        // Мигрируем старые данные к новому формату\n        const migratedData = SheetsManager.migrateLegacyData(projectData as BotData);\n        setBotDataWithSheets(migratedData);\n        // Всегда применяем layout при первой загрузке проекта, пропускаем только при повторной загрузке на мобильных\n        const shouldSkipLayout = isMobile && nodes.length > 0 && !isLoadingTemplate && lastLoadedProjectId !== null;\n        setBotData(projectData as BotData, undefined, shouldSkipLayout ? undefined : currentNodeSizes, shouldSkipLayout);\n      }\n      \n      // Update the last loaded project ID\n      setLastLoadedProjectId(currentProject.id);\n      \n      // Сохраняем ID текущего проекта для возврата со страницы шаблонов\n      localStorage.setItem('lastProjectId', currentProject.id.toString());\n    }\n  }, [currentProject?.id, currentProject?.data, setBotData, currentNodeSizes, isLoadingTemplate, hasLocalChanges, lastLoadedProjectId, isMobile, nodes.length]);\n\n  const updateProjectMutation = useMutation({\n    mutationFn: async (data: any) => {\n      if (!currentProject) return;\n      \n      // Всегда используем текущие данные с холста для сохранения\n      let projectData;\n      \n      if (botDataWithSheets) {\n        // Обновляем активный лист текущими данными холста\n        const currentCanvasData = getBotData();\n        const activeSheetId = botDataWithSheets.activeSheetId;\n        const updatedSheets = botDataWithSheets.sheets.map(sheet => \n          sheet.id === activeSheetId \n            ? { ...sheet, nodes: currentCanvasData.nodes, connections: currentCanvasData.connections, updatedAt: new Date() }\n            : sheet\n        );\n        \n        projectData = {\n          ...botDataWithSheets,\n          sheets: updatedSheets\n        };\n      } else {\n        // Если нет формата с листами, используем текущие данные холста\n        projectData = getBotData();\n      }\n      \n      return apiRequest('PUT', `/api/projects/${currentProject.id}`, {\n        data: projectData\n      });\n    },\n    onSuccess: (updatedProject) => {\n      console.log('Проект сохранен, обновляем кеш проектов');\n      \n      // Reset local changes flag only after successful save\n      setHasLocalChanges(false);\n      \n      // Обновляем кеш проектов\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      \n      toast({\n        title: \"Проект сохранен\",\n        description: \"Изменения успешно сохранены\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Ошибка сохранения\",\n        description: \"Не удалось сохранить проект\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSave = useCallback(() => {\n    updateProjectMutation.mutate({});\n  }, [updateProjectMutation]);\n\n  const handleTabChange = useCallback((tab: 'editor' | 'preview' | 'export' | 'bot' | 'users' | 'groups') => {\n    setCurrentTab(tab);\n    if (tab === 'preview') {\n      // Auto-save before showing preview\n      updateProjectMutation.mutate({});\n      // Navigate to preview page instead of showing modal\n      setLocation(`/preview/${currentProject?.id}`);\n      return;\n    } else if (tab === 'export') {\n      // Auto-save before showing export page\n      updateProjectMutation.mutate({});\n    } else if (tab === 'bot') {\n      // Auto-save before showing bot controls\n      updateProjectMutation.mutate({});\n    } else if (tab === 'users') {\n      // Auto-save before showing users panel\n      updateProjectMutation.mutate({});\n    }\n  }, [updateProjectMutation]);\n\n  // Функции управления листами\n  const handleSheetAdd = useCallback((name: string) => {\n    if (!botDataWithSheets) return;\n    \n    try {\n      const updatedData = SheetsManager.addSheet(botDataWithSheets, name);\n      setBotDataWithSheets(updatedData);\n      \n      // Переключаемся на новый лист\n      const newSheet = SheetsManager.getActiveSheet(updatedData);\n      if (newSheet) {\n        // При добавлении нового листа всегда применяем автоиерархию\n        const shouldSkipLayout = false; // Автоиерархия нужна для правильного расположения новых листов\n        setBotData({ nodes: newSheet.nodes, connections: newSheet.connections }, undefined, shouldSkipLayout ? undefined : currentNodeSizes, shouldSkipLayout);\n      }\n      \n      // Сохраняем изменения\n      updateProjectMutation.mutate({});\n      \n      toast({\n        title: \"Лист создан\",\n        description: `Лист \"${name}\" успешно создан`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Ошибка создания\",\n        description: \"Не удалось создать лист\",\n        variant: \"destructive\",\n      });\n    }\n  }, [botDataWithSheets, setBotData, updateProjectMutation, toast, isMobile, nodes.length, currentNodeSizes]);\n\n  const handleSheetDelete = useCallback((sheetId: string) => {\n    if (!botDataWithSheets) return;\n    \n    try {\n      const updatedData = SheetsManager.deleteSheet(botDataWithSheets, sheetId);\n      setBotDataWithSheets(updatedData);\n      \n      // Переключаемся на активный лист\n      const activeSheet = SheetsManager.getActiveSheet(updatedData);\n      if (activeSheet) {\n        setBotData({ nodes: activeSheet.nodes, connections: activeSheet.connections }); // автоиерархия должна работать при переключении листов\n      }\n      \n      // Сохраняем изменения\n      updateProjectMutation.mutate({});\n      \n      toast({\n        title: \"Лист удален\",\n        description: \"Лист успешно удален\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Ошибка удаления\",\n        description: \"Не удалось удалить лист\",\n        variant: \"destructive\",\n      });\n    }\n  }, [botDataWithSheets, setBotData, updateProjectMutation, toast]);\n\n  const handleSheetRename = useCallback((sheetId: string, newName: string) => {\n    if (!botDataWithSheets) return;\n    \n    try {\n      const updatedData = SheetsManager.renameSheet(botDataWithSheets, sheetId, newName);\n      setBotDataWithSheets(updatedData);\n      \n      // Сохраняем изменения\n      updateProjectMutation.mutate({});\n      \n      toast({\n        title: \"Лист переименован\",\n        description: `Лист переименован в \"${newName}\"`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Ошибка переименования\",\n        description: \"Не удалось переименовать лист\",\n        variant: \"destructive\",\n      });\n    }\n  }, [botDataWithSheets, updateProjectMutation, toast]);\n\n  const handleSheetDuplicate = useCallback((sheetId: string) => {\n    if (!botDataWithSheets) return;\n    \n    try {\n      const updatedData = SheetsManager.duplicateSheetInProject(botDataWithSheets, sheetId);\n      setBotDataWithSheets(updatedData);\n      \n      // Переключаемся на дублированный лист\n      const newSheet = SheetsManager.getActiveSheet(updatedData);\n      if (newSheet) {\n        // При дублировании листа всегда применяем автоиерархию\n        const shouldSkipLayout = false; // Автоиерархия нужна для правильного расположения дублированных листов\n        setBotData({ nodes: newSheet.nodes, connections: newSheet.connections }, undefined, shouldSkipLayout ? undefined : currentNodeSizes, shouldSkipLayout);\n      }\n      \n      // Сохраняем изменения\n      updateProjectMutation.mutate({});\n      \n      toast({\n        title: \"Лист дублирован\",\n        description: \"Лист успешно дублирован\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Ошибка дублирования\",\n        description: \"Не удалось дублировать лист\",\n        variant: \"destructive\",\n      });\n    }\n  }, [botDataWithSheets, setBotData, updateProjectMutation, toast]);\n\n  const handleSheetSelect = useCallback((sheetId: string) => {\n    if (!botDataWithSheets) return;\n    \n    try {\n      // Сначала сохраняем текущие данные холста в активном листе\n      const currentCanvasData = getBotData();\n      const activeSheetId = botDataWithSheets.activeSheetId;\n      const updatedSheets = botDataWithSheets.sheets.map(sheet => \n        sheet.id === activeSheetId \n          ? { ...sheet, nodes: currentCanvasData.nodes, connections: currentCanvasData.connections, updatedAt: new Date() }\n          : sheet\n      );\n      \n      // Затем переключаемся на новый лист\n      const updatedData = SheetsManager.setActiveSheet(\n        { ...botDataWithSheets, sheets: updatedSheets }, \n        sheetId\n      );\n      setBotDataWithSheets(updatedData);\n      \n      // Загружаем данные нового активного листа на холст\n      const newActiveSheet = SheetsManager.getActiveSheet(updatedData);\n      if (newActiveSheet) {\n        // При переключении листов применяем автоиерархию для лучшего отображения\n        const shouldSkipLayout = false; // Автоиерархия нужна для правильного отображения\n        setBotData({ nodes: newActiveSheet.nodes, connections: newActiveSheet.connections }, undefined, shouldSkipLayout ? undefined : currentNodeSizes, shouldSkipLayout);\n      }\n      \n      // Сохраняем изменения\n      updateProjectMutation.mutate({});\n    } catch (error) {\n      toast({\n        title: \"Ошибка переключения\",\n        description: \"Не удалось переключиться на лист\",\n        variant: \"destructive\",\n      });\n    }\n  }, [botDataWithSheets, getBotData, setBotData, updateProjectMutation, toast, isMobile, nodes.length, currentNodeSizes]);\n\n  // Проверяем, есть ли выбранный шаблон при загрузке страницы\n  useEffect(() => {\n    const selectedTemplateData = localStorage.getItem('selectedTemplate');\n    if (selectedTemplateData && currentProject) {\n      try {\n        setIsLoadingTemplate(true); // Устанавливаем флаг загрузки шаблона\n        const template = JSON.parse(selectedTemplateData);\n        console.log('Применяем сохраненный шаблон:', template.name);\n        \n        // Проверяем, есть ли в шаблоне многолистовая структура\n        if (template.data.sheets && Array.isArray(template.data.sheets)) {\n          console.log('Применяем многолистовой шаблон с листами:', template.data.sheets.length);\n          \n          // Создаем новые ID для листов шаблона\n          const updatedSheets = template.data.sheets.map((sheet: any) => {\n            // Очищаем узлы от потенциальных циклических ссылок\n            const cleanNodes = sheet.nodes?.map((node: any) => {\n              const cleanNode = {\n                id: node.id,\n                type: node.type,\n                position: node.position || { x: 0, y: 0 },\n                data: {\n                  ...node.data,\n                  // Убираем любые потенциальные циклические ссылки\n                  parent: undefined,\n                  children: undefined\n                }\n              };\n              return cleanNode;\n            }) || [];\n\n            // Очищаем соединения\n            const cleanConnections = sheet.connections?.map((conn: any) => ({\n              id: conn.id,\n              source: conn.source,\n              target: conn.target,\n              sourceHandle: conn.sourceHandle,\n              targetHandle: conn.targetHandle\n            })) || [];\n\n            return {\n              id: nanoid(), // Новый уникальный ID для листа\n              name: sheet.name,\n              nodes: cleanNodes,\n              connections: cleanConnections,\n              viewState: sheet.viewState || { position: { x: 0, y: 0 }, zoom: 1 },\n              createdAt: new Date(),\n              updatedAt: new Date()\n            };\n          });\n          \n          const templateDataWithSheets = {\n            sheets: updatedSheets,\n            activeSheetId: updatedSheets[0]?.id,\n            version: 2,\n            interSheetConnections: template.data.interSheetConnections || []\n          };\n          \n          // Устанавливаем многолистовые данные\n          setBotDataWithSheets(templateDataWithSheets);\n          \n          // Устанавливаем первый лист как активный на холсте\n          const firstSheet = updatedSheets[0];\n          if (firstSheet) {\n            // Всегда применяем автоиерархию при загрузке шаблонов для правильного расположения\n            const shouldSkipLayout = false; // Автоиерархия необходима при загрузке многолистовых шаблонов\n            setBotData({ nodes: firstSheet.nodes, connections: firstSheet.connections }, template.name, currentNodeSizes, shouldSkipLayout);\n          }\n          \n          // Сохраняем в проект\n          updateProjectMutation.mutate({\n            data: templateDataWithSheets\n          });\n        } else {\n          // Обычный шаблон без листов - мигрируем к формату с листами\n          console.log('Применяем обычный шаблон и мигрируем к формату с листами');\n          const migratedData = SheetsManager.migrateLegacyData(template.data);\n          setBotDataWithSheets(migratedData);\n          // Всегда применяем автоиерархию при загрузке шаблонов для правильного расположения\n          const shouldSkipLayout = false; // Автоиерархия необходима при загрузке обычных шаблонов\n          setBotData(template.data, template.name, currentNodeSizes, shouldSkipLayout); // автоиерархия должна работать при загрузке шаблонов\n          \n          updateProjectMutation.mutate({\n            data: migratedData\n          });\n        }\n        \n        // Принудительно инвалидируем кеш проектов после применения шаблона\n        // чтобы на странице \"Проекты\" отображалось правильное количество листов\n        queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n        \n        toast({\n          title: 'Шаблон применен',\n          description: `Шаблон \"${template.name}\" успешно загружен`,\n        });\n        \n        // Удаляем сохраненный шаблон\n        localStorage.removeItem('selectedTemplate');\n        \n        // Небольшая задержка, чтобы дать время на сохранение, затем убираем флаг\n        setTimeout(() => {\n          setIsLoadingTemplate(false);\n        }, 1000);\n      } catch (error) {\n        console.error('Ошибка применения сохраненного шаблона:', error);\n        localStorage.removeItem('selectedTemplate');\n        setIsLoadingTemplate(false); // Убираем флаг при ошибке\n      }\n    }\n  }, [currentProject?.id, setBotData, setBotDataWithSheets, updateProjectMutation, toast, queryClient]);\n\n  // Enhanced onNodeUpdate that auto-saves changes\n  const handleNodeUpdate = useCallback((nodeId: string, updates: any) => {\n    // First update local state\n    updateNodeData(nodeId, updates);\n    // Set local changes flag - don't reset it immediately\n    setHasLocalChanges(true);\n    // Then auto-save to database with a small delay\n    setTimeout(() => {\n      updateProjectMutation.mutate({});\n    }, 500); // 500ms delay to allow for rapid typing\n  }, [updateNodeData, updateProjectMutation]);\n\n  const handleNodeMove = useCallback((nodeId: string, position: { x: number; y: number }) => {\n    updateNode(nodeId, { position });\n  }, [updateNode]);\n\n  const handleComponentDrag = useCallback((component: ComponentDefinition) => {\n    // Handle component drag start if needed\n  }, []);\n\n  const handleComponentAdd = useCallback((component: ComponentDefinition) => {\n    // Prevent adding nodes during template loading\n    if (isLoadingTemplate) {\n      return;\n    }\n    \n    // Set local changes flag first to prevent useEffect from running\n    setHasLocalChanges(true);\n    \n    // Создаем новый узел из компонента\n    const newNode: Node = {\n      id: nanoid(),\n      type: component.type,\n      position: { x: 200 + Math.random() * 100, y: 200 + Math.random() * 100 }, // Случайная позиция с небольшим смещением\n      data: component.defaultData || {}\n    };\n    \n    // Добавляем узел на холст\n    addNode(newNode);\n    \n    \n    // Auto-save after a short delay to persist the new node\n    setTimeout(() => {\n      updateProjectMutation.mutate({});\n    }, 1000);\n  }, [addNode, isLoadingTemplate, updateProjectMutation]);\n\n  const handleSaveAsTemplate = useCallback(() => {\n    setShowSaveTemplate(true);\n  }, []);\n\n  const handleLoadTemplate = useCallback(() => {\n    console.log('Template button clicked, navigating to templates page...');\n    setLocation('/templates');\n  }, [setLocation]);\n\n  const handleGoToProjects = useCallback(() => {\n    setLocation('/projects');\n  }, [setLocation]);\n\n  const handleProjectSelect = useCallback((newProjectId: number) => {\n    setLocation(`/editor/${newProjectId}`);\n  }, [setLocation]);\n\n  const handleSelectTemplate = useCallback((template: any) => {\n    // Применяем шаблон к текущему проекту\n    try {\n      setIsLoadingTemplate(true); // Устанавливаем флаг загрузки шаблона\n      console.log('Обработка выбора шаблона:', template.name);\n      console.log('Данные шаблона:', template.data);\n      \n      // Проверяем, есть ли в шаблоне многолистовая структура\n      if (template.data.sheets && Array.isArray(template.data.sheets)) {\n        console.log('Применяем многолистовой шаблон с листами:', template.data.sheets.length);\n        \n        // Создаем новые ID для листов шаблона\n        const updatedSheets = template.data.sheets.map((sheet: any) => {\n          // Очищаем узлы от потенциальных циклических ссылок\n          const cleanNodes = sheet.nodes?.map((node: any) => {\n            const cleanNode = {\n              id: node.id,\n              type: node.type,\n              position: node.position || { x: 0, y: 0 },\n              data: {\n                ...node.data,\n                // Убираем любые потенциальные циклические ссылки\n                parent: undefined,\n                children: undefined\n              }\n            };\n            return cleanNode;\n          }) || [];\n\n          // Очищаем соединения\n          const cleanConnections = sheet.connections?.map((conn: any) => ({\n            id: conn.id,\n            source: conn.source,\n            target: conn.target,\n            sourceHandle: conn.sourceHandle,\n            targetHandle: conn.targetHandle\n          })) || [];\n\n          return {\n            id: nanoid(), // Новый уникальный ID для листа\n            name: sheet.name,\n            nodes: cleanNodes,\n            connections: cleanConnections,\n            viewState: sheet.viewState || { position: { x: 0, y: 0 }, zoom: 1 },\n            createdAt: new Date(),\n            updatedAt: new Date()\n          };\n        });\n        \n        const templateDataWithSheets = {\n          sheets: updatedSheets,\n          activeSheetId: updatedSheets[0]?.id,\n          version: 2,\n          interSheetConnections: template.data.interSheetConnections || []\n        };\n        \n        // Устанавливаем многолистовые данные\n        setBotDataWithSheets(templateDataWithSheets);\n        \n        // Устанавливаем первый лист как активный на холсте\n        const firstSheet = updatedSheets[0];\n        if (firstSheet) {\n          // При применении шаблона layout всегда применяется независимо от устройства\n          setBotData({ nodes: firstSheet.nodes, connections: firstSheet.connections }, template.name, currentNodeSizes, false);\n          console.log('Применили первый лист, узлов:', firstSheet.nodes.length);\n          console.log('Применили первый лист, связей:', firstSheet.connections.length);\n        }\n        \n        // Сохраняем в проект\n        updateProjectMutation.mutate({\n          data: templateDataWithSheets\n        });\n      } else {\n        // Обычный шаблон без листов\n        console.log('Применяем обычный шаблон');\n        const templateData = template.data;\n        \n        if (!templateData || !templateData.nodes) {\n          throw new Error('Некорректные данные шаблона');\n        }\n        \n        // Мигрируем к формату с листами\n        const migratedData = SheetsManager.migrateLegacyData(templateData);\n        setBotDataWithSheets(migratedData);\n        // При применении шаблона layout всегда применяется независимо от устройства\n        setBotData(templateData, template.name, currentNodeSizes, false);\n        \n        console.log('Применили данные шаблона, узлов:', templateData.nodes.length);\n        console.log('Применили данные шаблона, связей:', templateData.connections?.length || 0);\n        \n        // Сохраняем изменения в базе данных сразу с новыми данными\n        console.log('Сохраняем шаблон в БД, узлов:', migratedData.sheets?.[0]?.nodes?.length || templateData.nodes?.length);\n        updateProjectMutation.mutate({\n          data: migratedData\n        });\n      }\n      \n      // Обновляем кеш проектов для синхронизации панели компонентов  \n      console.log('Шаблон применен, обновляем кеш проектов');\n      // Даем небольшую задержку для завершения мутации, затем обновляем кеш\n      setTimeout(() => {\n        queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      }, 500);\n      \n      toast({\n        title: 'Шаблон применен',\n        description: `Шаблон \"${template.name}\" успешно загружен`,\n      });\n      \n      // Небольшая задержка, чтобы дать время на сохранение, затем убираем флаг\n      setTimeout(() => {\n        setIsLoadingTemplate(false);\n      }, 1000);\n    } catch (error) {\n      console.error('Ошибка применения шаблона:', error);\n      toast({\n        title: 'Ошибка',\n        description: 'Не удалось применить шаблон',\n        variant: 'destructive',\n      });\n      setIsLoadingTemplate(false); // Убираем флаг при ошибке\n    }\n  }, [setBotData, setBotDataWithSheets, updateProjectMutation, toast, queryClient]);\n\n  // Обработчики для управления связями\n  const handleConnectionsChange = useCallback((newConnections: Connection[]) => {\n    // Обновляем связи через существующий механизм\n    const currentData = getBotData();\n    updateProjectMutation.mutate({\n      data: {\n        ...currentData,\n        connections: newConnections\n      }\n    });\n  }, [getBotData, updateProjectMutation]);\n\n  const handleConnectionSelect = useCallback((connection: Connection | null) => {\n    setSelectedConnection(connection);\n    setSelectedConnectionId(connection?.id || null);\n  }, []);\n\n  const handleConnectionEdit = useCallback((connection: Connection) => {\n    setSelectedConnection(connection);\n    setSelectedConnectionId(connection.id);\n    // Можно добавить логику редактирования\n  }, []);\n\n  const handleConnectionDelete = useCallback((connectionId: string) => {\n    deleteConnection(connectionId);\n    if (selectedConnectionId === connectionId) {\n      setSelectedConnectionId(null);\n      setSelectedConnection(null);\n    }\n  }, [deleteConnection, selectedConnectionId]);\n\n\n\n  // Определяем содержимое панели свойств для переиспользования\n  const propertiesContent = currentProject ? (\n    <PropertiesPanel\n      projectId={currentProject.id}\n      selectedNode={selectedNode}\n      allNodes={nodes}\n      allSheets={botDataWithSheets?.sheets || []}\n      currentSheetId={botDataWithSheets?.activeSheetId || undefined}\n      onNodeUpdate={handleNodeUpdateWithSheets}\n      onNodeTypeChange={handleNodeTypeChange}\n      onButtonAdd={addButton}\n      onButtonUpdate={updateButton}\n      onButtonDelete={deleteButton}\n    />\n  ) : null;\n\n  // Определяем содержимое панели кода\n  const codeContent = currentProject ? (\n    <CodePanel\n      botData={(botDataWithSheets || getBotData()) as any}\n      projectName={currentProject.name}\n      projectId={currentProject.id}\n      selectedNodeId={selectedNodeId}\n    />\n  ) : null;\n\n  if (!currentProject) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-4\">\n            <i className=\"fas fa-spinner fa-spin text-gray-400 text-xl\"></i>\n          </div>\n          <p className=\"text-gray-600\">Загрузка проекта...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Функция рендеринга содержимого для гибкого макета\n  const renderFlexibleLayoutContent = () => {\n    const headerContent = (\n      <AdaptiveHeader\n        config={layoutConfig}\n        projectName={currentProject.name}\n        currentTab={currentTab}\n        onTabChange={handleTabChange}\n        onExport={() => {}}\n        onSaveAsTemplate={handleSaveAsTemplate}\n        onLoadTemplate={handleLoadTemplate}\n        onLayoutSettings={() => setShowLayoutManager(true)}\n        onToggleHeader={handleToggleHeader}\n        onToggleSidebar={handleToggleSidebar}\n        onToggleProperties={handleToggleProperties}\n        onToggleCanvas={handleToggleCanvas}\n        onToggleCode={handleToggleCode}\n        headerVisible={flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible ?? true}\n        sidebarVisible={flexibleLayoutConfig.elements.find(el => el.id === 'sidebar')?.visible ?? true}\n        propertiesVisible={flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible ?? true}\n        canvasVisible={flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible ?? true}\n        codeVisible={flexibleLayoutConfig.elements.find(el => el.id === 'code')?.visible ?? false}\n        onOpenMobileSidebar={() => setShowMobileSidebar(true)}\n        onOpenMobileProperties={() => setShowMobileProperties(true)}\n      />\n    );\n\n    const canvasContent = (\n      <div className=\"h-full\">\n        {currentTab === 'groups' ? (\n          <GroupsPanel\n            projectId={currentProject.id}\n            projectName={currentProject.name}\n          />\n        ) : currentTab === 'editor' ? (\n          <Canvas\n            // Новая система листов\n            botData={botDataWithSheets || undefined}\n            onBotDataUpdate={handleBotDataUpdate}\n            // Существующие пропсы для совместимости\n            nodes={nodes}\n            connections={connections}\n            selectedNodeId={selectedNodeId}\n            selectedConnectionId={selectedConnectionId ?? undefined}\n            onNodeSelect={setSelectedNodeId}\n            onNodeAdd={addNode}\n            onNodeDelete={deleteNode}\n            onNodeDuplicate={duplicateNode}\n            onNodeMove={handleNodeMove}\n            onConnectionSelect={setSelectedConnectionId}\n            onConnectionDelete={deleteConnection}\n            onConnectionAdd={addConnection}\n            onNodesUpdate={updateNodes}\n            onUndo={undo}\n            onRedo={redo}\n            canUndo={canUndo}\n            canRedo={canRedo}\n            onSave={() => updateProjectMutation.mutate({})}\n            isSaving={updateProjectMutation.isPending}\n            onCopyToClipboard={copyToClipboard}\n            onPasteFromClipboard={pasteFromClipboard}\n            hasClipboardData={hasClipboardData()}\n            isNodeBeingDragged={isNodeBeingDragged}\n            setIsNodeBeingDragged={setIsNodeBeingDragged}\n            onToggleHeader={handleToggleHeader}\n            onToggleSidebar={handleToggleSidebar}\n            onToggleProperties={handleToggleProperties}\n            onToggleCanvas={handleToggleCanvas}\n            headerVisible={flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible ?? true}\n            sidebarVisible={flexibleLayoutConfig.elements.find(el => el.id === 'sidebar')?.visible ?? true}\n            propertiesVisible={flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible ?? true}\n            canvasVisible={flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible ?? true}\n            onOpenMobileSidebar={handleOpenMobileSidebar}\n            onOpenMobileProperties={handleOpenMobileProperties}\n            onNodeSizesChange={handleNodeSizesChange}\n          />\n        ) : currentTab === 'bot' ? (\n          <div className=\"h-full p-6 bg-background overflow-auto\">\n            <div className=\"max-w-2xl mx-auto\">\n              <BotControl\n                projectId={currentProject.id}\n                projectName={currentProject.name}\n              />\n            </div>\n          </div>\n        ) : currentTab === 'users' ? (\n          <div className=\"h-full\">\n            <UserDatabasePanel\n              projectId={currentProject.id}\n              projectName={currentProject.name}\n            />\n          </div>\n        ) : currentTab === 'export' ? (\n          <ExportPanel\n            botData={(botDataWithSheets || getBotData()) as any}\n            projectName={currentProject.name}\n            projectId={currentProject.id}\n          />\n        ) : null}\n      </div>\n    );\n\n    const sidebarContent = (\n      <ComponentsSidebar \n        onComponentDrag={handleComponentDrag}\n        onComponentAdd={handleComponentAdd}\n        onLoadTemplate={handleLoadTemplate}\n        onOpenLayoutCustomizer={() => setShowLayoutCustomizer(true)}\n        onLayoutChange={updateLayoutConfig}\n        onGoToProjects={handleGoToProjects}\n        onProjectSelect={handleProjectSelect}\n        currentProjectId={currentProject?.id}\n        activeSheetId={botDataWithSheets?.activeSheetId}\n        headerContent={headerContent}\n        sidebarContent={<div>Sidebar</div>}\n        canvasContent={canvasContent}\n        propertiesContent={propertiesContent}\n        onToggleCanvas={handleToggleCanvas}\n        onToggleHeader={handleToggleHeader}\n        onToggleProperties={handleToggleProperties}\n        onShowFullLayout={() => {\n          setFlexibleLayoutConfig(prev => ({\n            ...prev,\n            elements: prev.elements.map(element => ({ ...element, visible: true }))\n          }))\n        }}\n        canvasVisible={flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible ?? true}\n        headerVisible={flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible ?? true}\n        propertiesVisible={flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible ?? true}\n        showLayoutButtons={!flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible && !flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible}\n        onSheetAdd={handleSheetAdd}\n        onSheetDelete={handleSheetDelete}\n        onSheetRename={handleSheetRename}\n        onSheetDuplicate={handleSheetDuplicate}\n        onSheetSelect={handleSheetSelect}\n        isMobile={isMobile}\n      />\n    );\n\n    if (useFlexibleLayout) {\n      return (\n        <SimpleLayoutCustomizer\n          config={flexibleLayoutConfig}\n          onConfigChange={setFlexibleLayoutConfig}\n        >\n          <FlexibleLayout\n            config={flexibleLayoutConfig}\n            headerContent={headerContent}\n            sidebarContent={sidebarContent}\n            canvasContent={canvasContent}\n            propertiesContent={propertiesContent}\n            codeContent={codeContent}\n            onConfigChange={setFlexibleLayoutConfig}\n            hideOnMobile={isMobile}\n            currentTab={currentTab}\n          />\n        </SimpleLayoutCustomizer>\n      );\n    }\n\n    return null;\n  };\n\n  return (\n    <>\n      {useFlexibleLayout ? (\n        renderFlexibleLayoutContent()\n      ) : (\n        <AdaptiveLayout\n          config={layoutConfig}\n          header={\n            <AdaptiveHeader\n              config={layoutConfig}\n              projectName={currentProject.name}\n              currentTab={currentTab}\n              onTabChange={handleTabChange}\n              onExport={() => {}}\n              onSaveAsTemplate={handleSaveAsTemplate}\n              onLoadTemplate={handleLoadTemplate}\n              onLayoutSettings={() => setShowLayoutManager(true)}\n              onToggleHeader={handleToggleHeader}\n              onToggleSidebar={handleToggleSidebar}\n              onToggleProperties={handleToggleProperties}\n              onToggleCanvas={handleToggleCanvas}\n              onToggleCode={handleToggleCode}\n              headerVisible={flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible ?? true}\n              sidebarVisible={flexibleLayoutConfig.elements.find(el => el.id === 'sidebar')?.visible ?? true}\n              propertiesVisible={flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible ?? true}\n              canvasVisible={flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible ?? true}\n              codeVisible={flexibleLayoutConfig.elements.find(el => el.id === 'code')?.visible ?? false}\n              onOpenMobileSidebar={() => setShowMobileSidebar(true)}\n              onOpenMobileProperties={() => setShowMobileProperties(true)}\n            />\n          }\n          sidebar={\n            <ComponentsSidebar \n              onComponentDrag={handleComponentDrag}\n              onComponentAdd={handleComponentAdd}\n              onLoadTemplate={handleLoadTemplate}\n              onOpenLayoutCustomizer={() => setShowLayoutCustomizer(true)}\n              onLayoutChange={updateLayoutConfig}\n              onGoToProjects={handleGoToProjects}\n              onProjectSelect={handleProjectSelect}\n              currentProjectId={currentProject?.id}\n              activeSheetId={botDataWithSheets?.activeSheetId}\n              onToggleCanvas={handleToggleCanvas}\n              onToggleHeader={handleToggleHeader}\n              onToggleProperties={handleToggleProperties}\n              onShowFullLayout={() => {\n                setFlexibleLayoutConfig(prev => ({\n                  ...prev,\n                  elements: prev.elements.map(element => ({ ...element, visible: true }))\n                }))\n              }}\n              canvasVisible={flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible ?? true}\n              headerVisible={flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible ?? true}\n              propertiesVisible={flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible ?? true}\n              showLayoutButtons={!flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible && !flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible}\n              onSheetAdd={handleSheetAdd}\n              onSheetDelete={handleSheetDelete}\n              onSheetRename={handleSheetRename}\n              onSheetDuplicate={handleSheetDuplicate}\n              onSheetSelect={handleSheetSelect}\n              isMobile={isMobile}\n            />\n          }\n          canvas={\n            <div className=\"h-full\">\n              {currentTab === 'editor' ? (\n                <Canvas\n                  botData={botDataWithSheets || undefined}\n                  onBotDataUpdate={handleBotDataUpdate}\n                  nodes={nodes}\n                  connections={connections}\n                  selectedNodeId={selectedNodeId}\n                  selectedConnectionId={selectedConnectionId || undefined}\n                  onNodeSelect={setSelectedNodeId}\n                  onNodeAdd={addNode}\n                  onNodeDelete={deleteNode}\n                  onNodeDuplicate={duplicateNode}\n                  onNodeMove={handleNodeMove}\n                  onConnectionSelect={setSelectedConnectionId}\n                  onConnectionDelete={deleteConnection}\n                  onConnectionAdd={addConnection}\n                  onNodesUpdate={updateNodes}\n                  onUndo={undo}\n                  onRedo={redo}\n                  canUndo={canUndo}\n                  canRedo={canRedo}\n                  onSave={() => updateProjectMutation.mutate({})}\n                  isSaving={updateProjectMutation.isPending}\n                  onCopyToClipboard={copyToClipboard}\n                  onPasteFromClipboard={pasteFromClipboard}\n                  hasClipboardData={hasClipboardData()}\n                  onToggleHeader={handleToggleHeader}\n                  onToggleSidebar={handleToggleSidebar}\n                  onToggleProperties={handleToggleProperties}\n                  onToggleCanvas={handleToggleCanvas}\n                  headerVisible={flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible ?? true}\n                  sidebarVisible={flexibleLayoutConfig.elements.find(el => el.id === 'sidebar')?.visible ?? true}\n                  propertiesVisible={flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible ?? true}\n                  canvasVisible={flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible ?? true}\n                  onOpenMobileSidebar={handleOpenMobileSidebar}\n                />\n              ) : currentTab === 'bot' ? (\n                <div className=\"h-full p-6 bg-background overflow-auto\">\n                  <div className=\"max-w-2xl mx-auto\">\n                    <BotControl\n                      projectId={currentProject.id}\n                      projectName={currentProject.name}\n                    />\n                  </div>\n                </div>\n              ) : currentTab === 'users' ? (\n                <div className=\"h-full\">\n                  <UserDatabasePanel\n                    projectId={currentProject.id}\n                    projectName={currentProject.name}\n                  />\n                </div>\n              ) : currentTab === 'groups' ? (\n                <div className=\"h-full\">\n                  <GroupsPanel\n                    projectId={currentProject.id}\n                    projectName={currentProject.name}\n                  />\n                </div>\n              ) : currentTab === 'export' ? (\n                <ExportPanel\n                  botData={(botDataWithSheets || getBotData()) as any}\n                  projectName={currentProject.name}\n                  projectId={currentProject.id}\n                />\n              ) : null}\n            </div>\n          }\n          properties={\n            <PropertiesPanel\n              projectId={currentProject.id}\n              selectedNode={selectedNode}\n              allNodes={nodes}\n              allSheets={botDataWithSheets?.sheets || []}\n              currentSheetId={botDataWithSheets?.activeSheetId || undefined}\n              onNodeUpdate={handleNodeUpdateWithSheets}\n              onButtonAdd={addButton}\n              onButtonUpdate={updateButton}\n              onButtonDelete={deleteButton}\n            />\n          }\n        />\n      )}\n\n      {showLayoutManager && (\n        <LayoutManager\n          config={layoutConfig}\n          onConfigChange={updateLayoutConfig}\n          onApply={applyLayoutConfig}\n          onReset={resetLayoutConfig}\n        />\n      )}\n\n      {showLayoutCustomizer && (\n        <LayoutCustomizer\n          headerContent={\n            <AdaptiveHeader\n              config={layoutConfig}\n              projectName={currentProject.name}\n              currentTab={currentTab}\n              onTabChange={handleTabChange}\n              onExport={() => {}}\n              onSaveAsTemplate={handleSaveAsTemplate}\n              onLoadTemplate={handleLoadTemplate}\n              onLayoutSettings={() => setShowLayoutManager(true)}\n              onToggleCode={handleToggleCode}\n              codeVisible={flexibleLayoutConfig.elements.find(el => el.id === 'code')?.visible ?? false}\n              onOpenMobileSidebar={() => setShowMobileSidebar(true)}\n              onOpenMobileProperties={() => setShowMobileProperties(true)}\n            />\n          }\n          sidebarContent={\n            <ComponentsSidebar \n              onComponentDrag={handleComponentDrag}\n              onComponentAdd={handleComponentAdd}\n              onLoadTemplate={handleLoadTemplate}\n              onOpenLayoutCustomizer={() => setShowLayoutCustomizer(true)}\n              onLayoutChange={updateLayoutConfig}\n              activeSheetId={botDataWithSheets?.activeSheetId}\n              headerContent={\n                <AdaptiveHeader\n                  config={layoutConfig}\n                  projectName={currentProject.name}\n                  currentTab={currentTab}\n                  onTabChange={handleTabChange}\n                  onExport={() => {}}\n                  onSaveAsTemplate={handleSaveAsTemplate}\n                  onLoadTemplate={handleLoadTemplate}\n                  onLayoutSettings={() => setShowLayoutManager(true)}\n                  onToggleCode={handleToggleCode}\n                  codeVisible={flexibleLayoutConfig.elements.find(el => el.id === 'code')?.visible ?? false}\n                  onOpenMobileSidebar={() => setShowMobileSidebar(true)}\n                  onOpenMobileProperties={() => setShowMobileProperties(true)}\n                />\n              }\n              sidebarContent={<div>Sidebar</div>}\n              canvasContent={\n                <div className=\"h-full\">\n                  {currentTab === 'editor' ? (\n                    <Canvas\n                      // Новая система листов\n                      botData={botDataWithSheets || undefined}\n                      onBotDataUpdate={handleBotDataUpdate}\n                      // Существующие пропсы для совместимости\n                      nodes={nodes}\n                      connections={connections}\n                      selectedNodeId={selectedNodeId}\n                      selectedConnectionId={selectedConnectionId || undefined}\n                      onNodeSelect={setSelectedNodeId}\n                      onNodeAdd={addNode}\n                      onNodeDelete={deleteNode}\n                      onNodeDuplicate={duplicateNode}\n                      onNodeMove={handleNodeMove}\n                      onConnectionSelect={setSelectedConnectionId}\n                      onConnectionDelete={deleteConnection}\n                      onConnectionAdd={addConnection}\n                      onNodesUpdate={updateNodes}\n                      onUndo={undo}\n                      onRedo={redo}\n                      canUndo={canUndo}\n                      canRedo={canRedo}\n                      onSave={() => updateProjectMutation.mutate({})}\n                      isSaving={updateProjectMutation.isPending}\n                      onCopyToClipboard={copyToClipboard}\n                      onPasteFromClipboard={pasteFromClipboard}\n                      hasClipboardData={hasClipboardData()}\n                      onToggleHeader={handleToggleHeader}\n                      onToggleSidebar={handleToggleSidebar}\n                      onToggleProperties={handleToggleProperties}\n                      headerVisible={flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible ?? true}\n                      sidebarVisible={flexibleLayoutConfig.elements.find(el => el.id === 'sidebar')?.visible ?? true}\n                      propertiesVisible={flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible ?? true}\n                    />\n                  ) : null}\n                </div>\n              }\n              propertiesContent={\n                <PropertiesPanel\n                  projectId={currentProject.id}\n                  selectedNode={selectedNode}\n                  allNodes={nodes}\n                  allSheets={botDataWithSheets?.sheets || []}\n                  currentSheetId={botDataWithSheets?.activeSheetId || undefined}\n                  onNodeUpdate={handleNodeUpdateWithSheets}\n                  onButtonAdd={addButton}\n                  onButtonUpdate={updateButton}\n                  onButtonDelete={deleteButton}\n                />\n              }\n              onSheetAdd={handleSheetAdd}\n              onSheetDelete={handleSheetDelete}\n              onSheetRename={handleSheetRename}\n              onSheetDuplicate={handleSheetDuplicate}\n              onSheetSelect={handleSheetSelect}\n              isMobile={isMobile}\n            />\n          }\n          canvasContent={\n            <div className=\"h-full\">\n              {currentTab === 'editor' ? (\n                <Canvas\n                  botData={botDataWithSheets || undefined}\n                  onBotDataUpdate={handleBotDataUpdate}\n                  nodes={nodes}\n                  connections={connections}\n                  selectedNodeId={selectedNodeId}\n                  selectedConnectionId={selectedConnectionId || undefined}\n                  onNodeSelect={setSelectedNodeId}\n                  onNodeAdd={addNode}\n                  onNodeDelete={deleteNode}\n                  onNodeDuplicate={duplicateNode}\n                  onNodeMove={handleNodeMove}\n                  onConnectionSelect={setSelectedConnectionId}\n                  onConnectionDelete={deleteConnection}\n                  onConnectionAdd={addConnection}\n                  onNodesUpdate={updateNodes}\n                  onUndo={undo}\n                  onRedo={redo}\n                  canUndo={canUndo}\n                  canRedo={canRedo}\n                  onSave={() => updateProjectMutation.mutate({})}\n                  isSaving={updateProjectMutation.isPending}\n                  isNodeBeingDragged={isNodeBeingDragged}\n                  setIsNodeBeingDragged={setIsNodeBeingDragged}\n                  onToggleHeader={handleToggleHeader}\n                  onToggleSidebar={handleToggleSidebar}\n                  onToggleProperties={handleToggleProperties}\n                  headerVisible={flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible ?? true}\n                  sidebarVisible={(() => { \n                    const calculated = !isMobile && (flexibleLayoutConfig.elements.find(el => el.id === 'sidebar')?.visible ?? true);\n                    console.log('🔧 SIDEBAR VISIBLE CALC:', { isMobile, flexSidebarVisible: flexibleLayoutConfig.elements.find(el => el.id === 'sidebar')?.visible, calculated });\n                    return calculated;\n                  })()}\n                  propertiesVisible={(() => { \n                    const calculated = !isMobile && (flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible ?? true);\n                    console.log('🔧 PROPERTIES VISIBLE CALC:', { isMobile, flexPropertiesVisible: flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible, calculated });\n                    return calculated;\n                  })()}\n                  onOpenMobileSidebar={handleOpenMobileSidebar}\n                  onOpenMobileProperties={handleOpenMobileProperties}\n                />\n              ) : null}\n            </div>\n          }\n          propertiesContent={\n            <PropertiesPanel\n              projectId={currentProject.id}\n              selectedNode={selectedNode}\n              allNodes={nodes}\n              allSheets={botDataWithSheets?.sheets || []}\n              currentSheetId={botDataWithSheets?.activeSheetId || undefined}\n              onNodeUpdate={handleNodeUpdateWithSheets}\n              onButtonAdd={addButton}\n              onButtonUpdate={updateButton}\n              onButtonDelete={deleteButton}\n            />\n          }\n          onLayoutChange={(elements) => {\n            // Layout changed\n            // Здесь можно обновить конфигурацию макета\n          }}\n        />\n      )}\n\n\n\n      <SaveTemplateModal\n        isOpen={showSaveTemplate}\n        onClose={() => setShowSaveTemplate(false)}\n        botData={(botDataWithSheets || getBotData()) as any}\n        projectName={currentProject.name}\n      />\n\n\n      {/* Мобильный sidebar */}\n      <Sheet open={showMobileSidebar} onOpenChange={setShowMobileSidebar}>\n        <SheetContent side=\"left\" className=\"p-0 w-80\">\n          <SheetHeader className=\"px-4 py-3 border-b\">\n            <SheetTitle>Компоненты</SheetTitle>\n          </SheetHeader>\n          <div className=\"h-full overflow-auto\">\n            <ComponentsSidebar \n              onComponentDrag={handleComponentDrag}\n              onComponentAdd={handleComponentAdd}\n              onLoadTemplate={handleLoadTemplate}\n              onOpenLayoutCustomizer={() => setShowLayoutCustomizer(true)}\n              onLayoutChange={updateLayoutConfig}\n              onGoToProjects={handleGoToProjects}\n              onProjectSelect={handleProjectSelect}\n              currentProjectId={currentProject?.id}\n              activeSheetId={botDataWithSheets?.activeSheetId}\n              onToggleCanvas={handleToggleCanvas}\n              onToggleHeader={handleToggleHeader}\n              onToggleProperties={handleToggleProperties}\n              onShowFullLayout={() => {\n                setFlexibleLayoutConfig(prev => ({\n                  ...prev,\n                  elements: prev.elements.map(element => ({ ...element, visible: true }))\n                }))\n              }}\n              canvasVisible={flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible ?? true}\n              headerVisible={flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible ?? true}\n              propertiesVisible={flexibleLayoutConfig.elements.find(el => el.id === 'properties')?.visible ?? true}\n              showLayoutButtons={!flexibleLayoutConfig.elements.find(el => el.id === 'canvas')?.visible && !flexibleLayoutConfig.elements.find(el => el.id === 'header')?.visible}\n              onSheetAdd={handleSheetAdd}\n              onSheetDelete={handleSheetDelete}\n              onSheetRename={handleSheetRename}\n              onSheetDuplicate={handleSheetDuplicate}\n              onSheetSelect={handleSheetSelect}\n              isMobile={isMobile}\n            />\n          </div>\n        </SheetContent>\n      </Sheet>\n\n      {/* Мобильная панель свойств */}\n      <Sheet open={showMobileProperties} onOpenChange={setShowMobileProperties}>\n        <SheetContent side=\"right\" className=\"p-0 w-80\">\n          <SheetHeader className=\"px-4 py-3 border-b\">\n            <SheetTitle>Свойства</SheetTitle>\n          </SheetHeader>\n          <div className=\"h-full overflow-auto\">\n            {propertiesContent}\n          </div>\n        </SheetContent>\n      </Sheet>\n\n    </>\n  );\n}\n","size_bytes":68676},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\nimport { useState } from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => {\n  const [isHovered, setIsHovered] = useState(false)\n  const [isDragging, setIsDragging] = useState(false)\n\n  return (\n    <ResizablePrimitive.PanelResizeHandle\n      className={cn(\n        \"group relative flex w-px items-center justify-center bg-border transition-all duration-200\",\n        \"hover:bg-primary/20 hover:w-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2\",\n        \"after:absolute after:inset-y-0 after:left-1/2 after:w-3 after:-translate-x-1/2 after:bg-transparent hover:after:bg-primary/10 after:transition-all after:duration-200\",\n        \"data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:hover:h-1\",\n        \"data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-3 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0\",\n        \"[&[data-panel-group-direction=vertical]>div]:rotate-90\",\n        isDragging && \"bg-primary w-1 after:bg-primary/20\",\n        className\n      )}\n      onMouseEnter={() => setIsHovered(true)}\n      onMouseLeave={() => setIsHovered(false)}\n      onMouseDown={() => setIsDragging(true)}\n      onMouseUp={() => setIsDragging(false)}\n      {...props}\n    >\n      {withHandle && (\n        <div className={cn(\n          \"grip-handle z-10 flex h-6 w-4 items-center justify-center rounded-md border border-border bg-background shadow-sm transition-all duration-200\",\n          \"group-hover:bg-muted group-hover:border-primary/30 group-hover:shadow-md group-hover:scale-105\",\n          \"dark:bg-background dark:border-border dark:group-hover:bg-muted dark:group-hover:border-primary/50\",\n          \"focus-within:ring-2 focus-within:ring-primary focus-within:ring-offset-1\",\n          isHovered && \"scale-110 shadow-lg border-primary/40\",\n          isDragging && \"scale-105 bg-primary/10 border-primary shadow-lg ring-2 ring-primary/20\"\n        )}>\n          <GripVertical className={cn(\n            \"h-3 w-3 text-muted-foreground transition-all duration-200\",\n            \"group-hover:text-primary group-hover:drop-shadow-sm\",\n            isHovered && \"scale-110 text-primary\",\n            isDragging && \"text-primary scale-125 drop-shadow-md\"\n          )} />\n          \n          {/* Dot indicators for better visual feedback */}\n          <div className={cn(\n            \"absolute inset-0 rounded-md opacity-0 transition-opacity duration-200\",\n            \"bg-gradient-to-r from-primary/5 via-primary/10 to-primary/5\",\n            isHovered && \"opacity-100\",\n            isDragging && \"opacity-100 from-primary/10 via-primary/20 to-primary/10\"\n          )} />\n        </div>\n      )}\n    </ResizablePrimitive.PanelResizeHandle>\n  )\n}\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":3631},"shared/schema.ts":{"content":"import { pgTable, text, serial, integer, jsonb, timestamp, bigint } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const botProjects = pgTable(\"bot_projects\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  data: jsonb(\"data\").notNull(),\n  botToken: text(\"bot_token\"), // Сохраненный токен бота\n  userDatabaseEnabled: integer(\"user_database_enabled\").default(1), // 0 = выключена, 1 = включена\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const botInstances = pgTable(\"bot_instances\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").references(() => botProjects.id).notNull(),\n  tokenId: integer(\"token_id\").references(() => botTokens.id, { onDelete: \"cascade\" }).notNull(),\n  status: text(\"status\").notNull(), // \"running\", \"stopped\", \"error\"\n  token: text(\"token\").notNull(),\n  processId: text(\"process_id\"),\n  startedAt: timestamp(\"started_at\").defaultNow(),\n  stoppedAt: timestamp(\"stopped_at\"),\n  errorMessage: text(\"error_message\"),\n});\n\nexport const botTemplates = pgTable(\"bot_templates\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  data: jsonb(\"data\").notNull(),\n  category: text(\"category\").default(\"custom\"), // \"official\", \"community\", \"custom\", \"business\", \"entertainment\", \"education\", \"utility\", \"games\"\n  tags: text(\"tags\").array(),\n  isPublic: integer(\"is_public\").default(0), // 0 = private, 1 = public\n  difficulty: text(\"difficulty\").default(\"easy\"), // \"easy\", \"medium\", \"hard\"\n  authorId: text(\"author_id\"), // ID автора шаблона\n  authorName: text(\"author_name\"), // Имя автора\n  useCount: integer(\"use_count\").notNull().default(0), // Количество использований\n  rating: integer(\"rating\").notNull().default(0), // Рейтинг от 1 до 5\n  ratingCount: integer(\"rating_count\").notNull().default(0), // Количество оценок\n  featured: integer(\"featured\").notNull().default(0), // 0 = не рекомендуемый, 1 = рекомендуемый\n  version: text(\"version\").default(\"1.0.0\"), // Версия шаблона\n  previewImage: text(\"preview_image\"), // URL изображения для предварительного просмотра\n  lastUsedAt: timestamp(\"last_used_at\"), // Время последнего использования\n  downloadCount: integer(\"download_count\").notNull().default(0), // Количество скачиваний\n  likeCount: integer(\"like_count\").notNull().default(0), // Количество лайков\n  bookmarkCount: integer(\"bookmark_count\").notNull().default(0), // Количество закладок\n  viewCount: integer(\"view_count\").notNull().default(0), // Количество просмотров\n  language: text(\"language\").default(\"ru\"), // Язык шаблона\n  requiresToken: integer(\"requires_token\").notNull().default(0), // Требует ли бот токен\n  complexity: integer(\"complexity\").notNull().default(1), // Сложность от 1 до 10\n  estimatedTime: integer(\"estimated_time\").notNull().default(5), // Примерное время настройки в минутах\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const botTokens = pgTable(\"bot_tokens\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").references(() => botProjects.id, { onDelete: \"cascade\" }).notNull(),\n  name: text(\"name\").notNull(), // Пользовательское имя для токена\n  token: text(\"token\").notNull(), // Сам токен\n  isDefault: integer(\"is_default\").default(0), // 0 = нет, 1 = да (токен по умолчанию)\n  isActive: integer(\"is_active\").default(1), // 0 = неактивен, 1 = активен\n  description: text(\"description\"), // Описание токена\n  // Информация о боте из Telegram API\n  botFirstName: text(\"bot_first_name\"), // Имя бота\n  botUsername: text(\"bot_username\"), // @username бота\n  botDescription: text(\"bot_description\"), // Полное описание бота\n  botShortDescription: text(\"bot_short_description\"), // Короткое описание бота\n  botPhotoUrl: text(\"bot_photo_url\"), // URL аватарки бота\n  botCanJoinGroups: integer(\"bot_can_join_groups\"), // Может ли бот присоединяться к группам\n  botCanReadAllGroupMessages: integer(\"bot_can_read_all_group_messages\"), // Может ли читать все сообщения в группах\n  botSupportsInlineQueries: integer(\"bot_supports_inline_queries\"), // Поддерживает ли инлайн запросы\n  botHasMainWebApp: integer(\"bot_has_main_web_app\"), // Есть ли главное веб-приложение\n  lastUsedAt: timestamp(\"last_used_at\"), // Время последнего использования\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const mediaFiles = pgTable(\"media_files\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").references(() => botProjects.id, { onDelete: \"cascade\" }).notNull(),\n  fileName: text(\"file_name\").notNull(), // Оригинальное имя файла\n  fileType: text(\"file_type\").notNull(), // photo, video, audio, document\n  filePath: text(\"file_path\").notNull(), // Путь к файлу на сервере\n  fileSize: integer(\"file_size\").notNull(), // Размер файла в байтах\n  mimeType: text(\"mime_type\").notNull(), // MIME тип файла\n  url: text(\"url\").notNull(), // URL для доступа к файлу\n  description: text(\"description\"), // Описание файла\n  tags: text(\"tags\").array().default([]), // Теги для поиска\n  isPublic: integer(\"is_public\").default(0), // 0 = приватный, 1 = публичный\n  usageCount: integer(\"usage_count\").default(0), // Количество использований\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const userBotData = pgTable(\"user_bot_data\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").references(() => botProjects.id, { onDelete: \"cascade\" }).notNull(),\n  userId: text(\"user_id\").notNull(), // Telegram user ID\n  userName: text(\"user_name\"), // Имя пользователя в Telegram\n  firstName: text(\"first_name\"), // Имя пользователя\n  lastName: text(\"last_name\"), // Фамилия пользователя\n  languageCode: text(\"language_code\"), // Код языка пользователя\n  isBot: integer(\"is_bot\").default(0), // 0 = человек, 1 = бот\n  isPremium: integer(\"is_premium\").default(0), // 0 = обычный, 1 = премиум\n  // Данные взаимодействий\n  lastInteraction: timestamp(\"last_interaction\").defaultNow(),\n  interactionCount: integer(\"interaction_count\").default(0),\n  // Сохраненные данные из узлов сбора ввода\n  userData: jsonb(\"user_data\").default({}), // Пользовательские данные (ответы на вопросы, формы и т.д.)\n  // Настройки и состояние\n  currentState: text(\"current_state\"), // Текущее состояние в диалоге с ботом\n  preferences: jsonb(\"preferences\").default({}), // Пользовательские настройки\n  // Статистика\n  commandsUsed: jsonb(\"commands_used\").default({}), // Статистика использования команд\n  sessionsCount: integer(\"sessions_count\").default(1), // Количество сессий\n  totalMessagesSent: integer(\"total_messages_sent\").default(0), // Общее количество отправленных сообщений\n  totalMessagesReceived: integer(\"total_messages_received\").default(0), // Общее количество полученных сообщений\n  // Метаданные\n  deviceInfo: text(\"device_info\"), // Информация об устройстве\n  locationData: jsonb(\"location_data\"), // Данные геолокации (если предоставлены)\n  contactData: jsonb(\"contact_data\"), // Контактные данные (если предоставлены)\n  isBlocked: integer(\"is_blocked\").default(0), // 0 = не заблокирован, 1 = заблокирован\n  isActive: integer(\"is_active\").default(1), // 0 = неактивен, 1 = активен\n  tags: text(\"tags\").array().default([]), // Теги для категоризации пользователей\n  notes: text(\"notes\"), // Заметки администратора\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const botUsers = pgTable(\"bot_users\", {\n  userId: bigint(\"user_id\", { mode: \"number\" }).primaryKey(),\n  username: text(\"username\"),\n  firstName: text(\"first_name\"),\n  lastName: text(\"last_name\"),\n  registeredAt: timestamp(\"registered_at\").defaultNow(),\n  lastInteraction: timestamp(\"last_interaction\").defaultNow(),\n  interactionCount: integer(\"interaction_count\").default(0),\n  userData: jsonb(\"user_data\").default({}),\n  isActive: integer(\"is_active\").default(1),\n});\n\nexport const botGroups = pgTable(\"bot_groups\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").references(() => botProjects.id, { onDelete: \"cascade\" }).notNull(),\n  groupId: text(\"group_id\"), // Telegram group ID\n  name: text(\"name\").notNull(), // Отображаемое название группы\n  url: text(\"url\").notNull(), // Ссылка на группу\n  isAdmin: integer(\"is_admin\").default(0), // 0 = участник, 1 = администратор\n  memberCount: integer(\"member_count\"), // Количество участников\n  isActive: integer(\"is_active\").default(1), // 0 = неактивная, 1 = активная\n  description: text(\"description\"), // Описание группы\n  settings: jsonb(\"settings\").default({}), // Настройки группы\n  // Расширенные поля для управления группами\n  avatarUrl: text(\"avatar_url\"), // URL аватарки группы\n  chatType: text(\"chat_type\").default(\"group\"), // \"group\", \"supergroup\", \"channel\"\n  inviteLink: text(\"invite_link\"), // Пригласительная ссылка\n  // Права администратора бота в группе\n  adminRights: jsonb(\"admin_rights\").default({\n    can_manage_chat: false,\n    can_change_info: false,\n    can_delete_messages: false,\n    can_invite_users: false,\n    can_restrict_members: false,\n    can_pin_messages: false,\n    can_promote_members: false,\n    can_manage_video_chats: false\n  }),\n  // Статистика группы\n  messagesCount: integer(\"messages_count\").default(0),\n  activeUsers: integer(\"active_users\").default(0),\n  lastActivity: timestamp(\"last_activity\"),\n  // Дополнительные настройки\n  isPublic: integer(\"is_public\").default(0), // 0 = частная, 1 = публичная\n  language: text(\"language\").default(\"ru\"), // Основной язык группы\n  timezone: text(\"timezone\"), // Часовой пояс группы\n  tags: text(\"tags\").array().default([]), // Теги для категоризации\n  notes: text(\"notes\"), // Заметки администратора\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Таблица участников групп\nexport const groupMembers = pgTable(\"group_members\", {\n  id: serial(\"id\").primaryKey(),\n  groupId: integer(\"group_id\").references(() => botGroups.id, { onDelete: \"cascade\" }).notNull(),\n  userId: bigint(\"user_id\", { mode: \"number\" }).notNull(), // Telegram user ID\n  username: text(\"username\"),\n  firstName: text(\"first_name\"),\n  lastName: text(\"last_name\"),\n  status: text(\"status\").default(\"member\"), // \"creator\", \"administrator\", \"member\", \"restricted\", \"left\", \"kicked\"\n  isBot: integer(\"is_bot\").default(0),\n  // Права администратора (если пользователь админ)\n  adminRights: jsonb(\"admin_rights\").default({}),\n  customTitle: text(\"custom_title\"), // Кастомный титул администратора\n  // Ограничения (если пользователь ограничен)\n  restrictions: jsonb(\"restrictions\").default({}),\n  restrictedUntil: timestamp(\"restricted_until\"),\n  // Метаданные\n  joinedAt: timestamp(\"joined_at\").defaultNow(),\n  lastSeen: timestamp(\"last_seen\"),\n  messageCount: integer(\"message_count\").default(0),\n  isActive: integer(\"is_active\").default(1),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Таблица пользовательских настроек для Telegram Client API\nexport const userTelegramSettings = pgTable(\"user_telegram_settings\", {\n  id: serial(\"id\").primaryKey(),\n  userId: text(\"user_id\").notNull().unique(), // Уникальный ID пользователя (например, email или внутренний ID)\n  apiId: text(\"api_id\"), // Telegram API ID\n  apiHash: text(\"api_hash\"), // Telegram API Hash\n  phoneNumber: text(\"phone_number\"), // Номер телефона для авторизации\n  sessionString: text(\"session_string\"), // Сохраненная сессия\n  isActive: integer(\"is_active\").default(1), // 0 = неактивен, 1 = активен\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Таблица истории сообщений между ботом и пользователями\nexport const botMessages = pgTable(\"bot_messages\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").references(() => botProjects.id, { onDelete: \"cascade\" }).notNull(),\n  userId: text(\"user_id\").notNull(), // Telegram user ID\n  messageType: text(\"message_type\").notNull(), // \"user\" или \"bot\"\n  messageText: text(\"message_text\"), // Текст сообщения\n  messageData: jsonb(\"message_data\"), // Дополнительные данные (медиа, кнопки и т.д.)\n  nodeId: text(\"node_id\"), // ID узла бота, который отправил сообщение\n  primaryMediaId: integer(\"primary_media_id\").references(() => mediaFiles.id, { onDelete: \"set null\" }), // Основное медиа (фото/видео) для быстрого доступа\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Таблица связи сообщений с медиафайлами (для множественных медиа)\nexport const botMessageMedia = pgTable(\"bot_message_media\", {\n  id: serial(\"id\").primaryKey(),\n  messageId: integer(\"message_id\").references(() => botMessages.id, { onDelete: \"cascade\" }).notNull(),\n  mediaFileId: integer(\"media_file_id\").references(() => mediaFiles.id, { onDelete: \"cascade\" }).notNull(),\n  mediaKind: text(\"media_kind\").notNull(), // \"photo\", \"video\", \"audio\", \"document\"\n  orderIndex: integer(\"order_index\").default(0), // Порядок для множественных медиа\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertBotProjectSchema = createInsertSchema(botProjects).pick({\n  name: true,\n  description: true,\n  data: true,\n  botToken: true,\n  userDatabaseEnabled: true,\n}).extend({\n  botToken: z.string().nullish(),\n  userDatabaseEnabled: z.number().min(0).max(1).default(1),\n});\n\nexport const insertBotInstanceSchema = createInsertSchema(botInstances).pick({\n  projectId: true,\n  tokenId: true,\n  status: true,\n  token: true,\n  processId: true,\n  errorMessage: true,\n  startedAt: true,\n  stoppedAt: true,\n});\n\nexport const insertBotTemplateSchema = createInsertSchema(botTemplates).pick({\n  name: true,\n  description: true,\n  data: true,\n  category: true,\n  tags: true,\n  isPublic: true,\n  difficulty: true,\n  authorId: true,\n  authorName: true,\n  version: true,\n  previewImage: true,\n  featured: true,\n  language: true,\n  requiresToken: true,\n  complexity: true,\n  estimatedTime: true,\n}).extend({\n  category: z.enum([\"custom\", \"business\", \"entertainment\", \"education\", \"utility\", \"games\", \"official\", \"community\"]).default(\"custom\"),\n  difficulty: z.enum([\"easy\", \"medium\", \"hard\"]).default(\"easy\"),\n  language: z.enum([\"ru\", \"en\", \"es\", \"fr\", \"de\", \"it\", \"pt\", \"zh\", \"ja\", \"ko\"]).default(\"ru\"),\n  complexity: z.number().min(1).max(10).default(1),\n  estimatedTime: z.number().min(1).max(120).default(5),\n  rating: z.number().min(1).max(5).optional(),\n});\n\nexport const insertBotTokenSchema = createInsertSchema(botTokens).pick({\n  projectId: true,\n  name: true,\n  token: true,\n  isDefault: true,\n  isActive: true,\n  description: true,\n  botFirstName: true,\n  botUsername: true,\n  botDescription: true,\n  botShortDescription: true,\n  botPhotoUrl: true,\n  botCanJoinGroups: true,\n  botCanReadAllGroupMessages: true,\n  botSupportsInlineQueries: true,\n  botHasMainWebApp: true,\n}).extend({\n  name: z.string().min(1, \"Имя токена обязательно\"),\n  token: z.string().min(1, \"Токен обязателен\"),\n  isDefault: z.number().min(0).max(1).default(0),\n  isActive: z.number().min(0).max(1).default(1),\n  botCanJoinGroups: z.number().min(0).max(1).optional(),\n  botCanReadAllGroupMessages: z.number().min(0).max(1).optional(),\n  botSupportsInlineQueries: z.number().min(0).max(1).optional(),\n  botHasMainWebApp: z.number().min(0).max(1).optional(),\n});\n\nexport const insertMediaFileSchema = createInsertSchema(mediaFiles).pick({\n  projectId: true,\n  fileName: true,\n  fileType: true,\n  filePath: true,\n  fileSize: true,\n  mimeType: true,\n  url: true,\n  description: true,\n  tags: true,\n  isPublic: true,\n}).extend({\n  fileName: z.string().min(1, \"Имя файла обязательно\"),\n  fileType: z.enum([\"photo\", \"video\", \"audio\", \"document\"]),\n  filePath: z.string().min(1, \"Путь к файлу обязателен\"),\n  fileSize: z.number().min(1, \"Размер файла должен быть больше 0\"),\n  mimeType: z.string().min(1, \"MIME тип обязателен\"),\n  url: z.string().url(\"Некорректный URL\"),\n  tags: z.array(z.string()).default([]),\n  isPublic: z.number().min(0).max(1).default(0),\n});\n\nexport const insertUserBotDataSchema = createInsertSchema(userBotData).pick({\n  projectId: true,\n  userId: true,\n  userName: true,\n  firstName: true,\n  lastName: true,\n  languageCode: true,\n  isBot: true,\n  isPremium: true,\n  interactionCount: true,\n  userData: true,\n  currentState: true,\n  preferences: true,\n  commandsUsed: true,\n  sessionsCount: true,\n  totalMessagesSent: true,\n  totalMessagesReceived: true,\n  deviceInfo: true,\n  locationData: true,\n  contactData: true,\n  isBlocked: true,\n  isActive: true,\n  tags: true,\n  notes: true,\n}).extend({\n  userId: z.string().min(1, \"ID пользователя обязателен\"),\n  userData: z.record(z.any()).default({}),\n  preferences: z.record(z.any()).default({}),\n  commandsUsed: z.record(z.any()).default({}),\n  tags: z.array(z.string()).default([]),\n  isBot: z.number().min(0).max(1).default(0),\n  isPremium: z.number().min(0).max(1).default(0),\n  isBlocked: z.number().min(0).max(1).default(0),\n  isActive: z.number().min(0).max(1).default(1),\n  sessionsCount: z.number().min(1).default(1),\n  totalMessagesSent: z.number().min(0).default(0),\n  totalMessagesReceived: z.number().min(0).default(0),\n});\n\nexport const insertBotUserSchema = createInsertSchema(botUsers).pick({\n  userId: true,\n  username: true,\n  firstName: true,\n  lastName: true,\n  interactionCount: true,\n  userData: true,\n  isActive: true,\n}).extend({\n  userId: z.number().positive(\"ID пользователя должен быть положительным числом\"),\n  userData: z.record(z.any()).default({}),\n  isActive: z.number().min(0).max(1).default(1),\n  interactionCount: z.number().min(0).default(0),\n});\n\nexport const insertBotGroupSchema = createInsertSchema(botGroups).pick({\n  projectId: true,\n  groupId: true,\n  name: true,\n  url: true,\n  isAdmin: true,\n  memberCount: true,\n  isActive: true,\n  description: true,\n  settings: true,\n  avatarUrl: true,\n  chatType: true,\n  inviteLink: true,\n  adminRights: true,\n  messagesCount: true,\n  activeUsers: true,\n  lastActivity: true,\n  isPublic: true,\n  language: true,\n  timezone: true,\n  tags: true,\n  notes: true,\n}).extend({\n  name: z.string().min(1, \"Название группы обязательно\"),\n  url: z.string().optional().default(\"\"), // Ссылка может быть пустой для числовых ID групп\n  isAdmin: z.number().min(0).max(1).default(0),\n  isActive: z.number().min(0).max(1).default(1),\n  isPublic: z.number().min(0).max(1).default(0),\n  settings: z.record(z.any()).default({}),\n  adminRights: z.record(z.any()).default({\n    can_manage_chat: false,\n    can_change_info: false,\n    can_delete_messages: false,\n    can_invite_users: false,\n    can_restrict_members: false,\n    can_pin_messages: false,\n    can_promote_members: false,\n    can_manage_video_chats: false\n  }),\n  language: z.enum([\"ru\", \"en\", \"es\", \"fr\", \"de\", \"it\", \"pt\", \"zh\", \"ja\", \"ko\"]).default(\"ru\"),\n  chatType: z.enum([\"group\", \"supergroup\", \"channel\"]).default(\"group\"),\n  tags: z.array(z.string()).default([]),\n  messagesCount: z.number().min(0).default(0),\n  activeUsers: z.number().min(0).default(0),\n});\n\n// Схема для участников групп\nexport const insertGroupMemberSchema = createInsertSchema(groupMembers).pick({\n  groupId: true,\n  userId: true,\n  username: true,\n  firstName: true,\n  lastName: true,\n  status: true,\n  isBot: true,\n  adminRights: true,\n  customTitle: true,\n  restrictions: true,\n  restrictedUntil: true,\n  joinedAt: true,\n  lastSeen: true,\n  messageCount: true,\n  isActive: true,\n}).extend({\n  userId: z.number().positive(\"ID пользователя должен быть положительным числом\"),\n  status: z.enum([\"creator\", \"administrator\", \"member\", \"restricted\", \"left\", \"kicked\"]).default(\"member\"),\n  isBot: z.number().min(0).max(1).default(0),\n  isActive: z.number().min(0).max(1).default(1),\n  adminRights: z.record(z.any()).default({}),\n  restrictions: z.record(z.any()).default({}),\n  messageCount: z.number().min(0).default(0),\n});\n\n// Схема для пользовательских настроек Telegram API\nexport const insertUserTelegramSettingsSchema = createInsertSchema(userTelegramSettings).pick({\n  userId: true,\n  apiId: true,\n  apiHash: true,\n  phoneNumber: true,\n  sessionString: true,\n  isActive: true,\n}).extend({\n  userId: z.string().min(1, \"ID пользователя обязателен\"),\n  apiId: z.string().min(1, \"API ID обязателен\"),\n  apiHash: z.string().min(1, \"API Hash обязателен\"),\n  phoneNumber: z.string().optional(),\n  isActive: z.number().min(0).max(1).default(1),\n});\n\n// Схема для сообщений бота\nexport const insertBotMessageSchema = createInsertSchema(botMessages).pick({\n  projectId: true,\n  userId: true,\n  messageType: true,\n  messageText: true,\n  messageData: true,\n  nodeId: true,\n  primaryMediaId: true,\n}).extend({\n  projectId: z.number().positive(\"ID проекта должен быть положительным числом\"),\n  userId: z.string().min(1, \"ID пользователя обязателен\"),\n  messageType: z.enum([\"user\", \"bot\"]),\n  messageText: z.string().optional(),\n  messageData: z.record(z.any()).optional(),\n  nodeId: z.string().nullish(),\n  primaryMediaId: z.number().positive().optional(),\n});\n\n// Схема для связи сообщений с медиафайлами\nexport const insertBotMessageMediaSchema = createInsertSchema(botMessageMedia).pick({\n  messageId: true,\n  mediaFileId: true,\n  mediaKind: true,\n  orderIndex: true,\n}).extend({\n  messageId: z.number().positive(\"ID сообщения должен быть положительным числом\"),\n  mediaFileId: z.number().positive(\"ID медиафайла должен быть положительным числом\"),\n  mediaKind: z.enum([\"photo\", \"video\", \"audio\", \"document\"]),\n  orderIndex: z.number().min(0).default(0),\n});\n\n// Схема для оценки шаблона\nexport const rateTemplateSchema = z.object({\n  templateId: z.number(),\n  rating: z.number().min(1).max(5),\n});\n\nexport type InsertBotProject = z.infer<typeof insertBotProjectSchema>;\nexport type BotProject = typeof botProjects.$inferSelect;\nexport type InsertBotInstance = z.infer<typeof insertBotInstanceSchema>;\nexport type BotInstance = typeof botInstances.$inferSelect;\nexport type InsertBotTemplate = z.infer<typeof insertBotTemplateSchema>;\nexport type BotTemplate = typeof botTemplates.$inferSelect;\nexport type InsertBotToken = z.infer<typeof insertBotTokenSchema>;\nexport type BotToken = typeof botTokens.$inferSelect;\nexport type InsertMediaFile = z.infer<typeof insertMediaFileSchema>;\nexport type MediaFile = typeof mediaFiles.$inferSelect;\nexport type InsertUserBotData = z.infer<typeof insertUserBotDataSchema>;\nexport type UserBotData = typeof userBotData.$inferSelect;\nexport type InsertBotUser = z.infer<typeof insertBotUserSchema>;\nexport type BotUser = typeof botUsers.$inferSelect;\nexport type InsertBotGroup = z.infer<typeof insertBotGroupSchema>;\nexport type BotGroup = typeof botGroups.$inferSelect;\nexport type InsertGroupMember = z.infer<typeof insertGroupMemberSchema>;\nexport type GroupMember = typeof groupMembers.$inferSelect;\nexport type InsertUserTelegramSettings = z.infer<typeof insertUserTelegramSettingsSchema>;\nexport type UserTelegramSettings = typeof userTelegramSettings.$inferSelect;\nexport type InsertBotMessage = z.infer<typeof insertBotMessageSchema>;\nexport type BotMessage = typeof botMessages.$inferSelect;\nexport type InsertBotMessageMedia = z.infer<typeof insertBotMessageMediaSchema>;\nexport type BotMessageMedia = typeof botMessageMedia.$inferSelect;\n\n// Bot structure schemas\nexport const buttonSchema = z.object({\n  id: z.string(),\n  text: z.string(),\n  action: z.enum(['goto', 'command', 'url', 'contact', 'location', 'selection']),\n  target: z.string().optional(),\n  url: z.string().optional(),\n  requestContact: z.boolean().optional(),\n  requestLocation: z.boolean().optional(),\n  buttonType: z.enum(['normal', 'option', 'complete']).default('normal'),\n  skipDataCollection: z.boolean().default(false), // Отключить сбор ответов для этой кнопки\n});\n\nexport const nodeSchema = z.object({\n  id: z.string(),\n  type: z.enum(['start', 'message', 'photo', 'video', 'audio', 'document', 'keyboard', 'command', 'sticker', 'voice', 'animation', 'location', 'contact', 'pin_message', 'unpin_message', 'delete_message', 'ban_user', 'unban_user', 'mute_user', 'unmute_user', 'kick_user', 'promote_user', 'demote_user', 'admin_rights']),\n  position: z.object({\n    x: z.number(),\n    y: z.number(),\n  }),\n  data: z.object({\n    command: z.string().optional(),\n    description: z.string().optional(),\n    messageText: z.string().optional(),\n    imageUrl: z.string().optional(),\n    videoUrl: z.string().optional(),\n    audioUrl: z.string().optional(),\n    documentUrl: z.string().optional(),\n    documentName: z.string().optional(),\n    mediaCaption: z.string().optional(),\n    keyboardType: z.enum(['reply', 'inline', 'none']).default('none'),\n    buttons: z.array(buttonSchema).default([]),\n    oneTimeKeyboard: z.boolean().default(false),\n    resizeKeyboard: z.boolean().default(true),\n    markdown: z.boolean().default(false),\n    formatMode: z.enum(['html', 'markdown', 'none']).default('none'),\n    // Синонимы для команд - текстовые сообщения, которые будут вызывать ту же функцию\n    synonyms: z.array(z.string()).default([]),\n    // Дополнительные настройки безопасности\n    isPrivateOnly: z.boolean().default(false),\n    adminOnly: z.boolean().default(false),\n    requiresAuth: z.boolean().default(false),\n    showInMenu: z.boolean().default(true),\n    // Настройки команд\n    commandTimeout: z.number().optional(), // Время ожидания выполнения команды в секундах\n    cooldownTime: z.number().optional(), // Время перезарядки команды в секундах\n    maxUsagesPerDay: z.number().optional(), // Максимальное количество использований в день\n    enableStatistics: z.boolean().default(true), // Включить сбор статистики\n    customParameters: z.array(z.string()).default([]), // Дополнительные параметры команды\n    // Поля для управления контентом в группах\n    targetMessageId: z.string().optional(), // ID сообщения для закрепления/удаления\n    messageIdSource: z.enum(['manual', 'variable', 'last_message']).default('last_message'), // Источник ID сообщения\n    variableName: z.string().optional(), // Имя переменной с ID сообщения\n    disableNotification: z.boolean().default(false), // Отключить уведомления\n    // Поля для управления пользователями в группах\n    targetUserId: z.string().optional(), // ID пользователя для модерации\n    userIdSource: z.enum(['manual', 'variable', 'last_message']).default('last_message'), // Источник ID пользователя\n    userVariableName: z.string().optional(), // Имя переменной с ID пользователя\n    // Дополнительные поля для новых типов узлов\n    stickerUrl: z.string().optional(),\n    stickerFileId: z.string().optional(),\n    voiceUrl: z.string().optional(),\n    animationUrl: z.string().optional(),\n    latitude: z.number().optional(),\n    longitude: z.number().optional(),\n    title: z.string().optional(),\n    address: z.string().optional(),\n    foursquareId: z.string().optional(),\n    foursquareType: z.string().optional(),\n    // Поддержка различных картографических сервисов\n    mapService: z.enum(['yandex', 'google', '2gis', 'custom']).default('custom'),\n    yandexMapUrl: z.string().optional(),\n    googleMapUrl: z.string().optional(),\n    gisMapUrl: z.string().optional(), // 2ГИС\n    mapZoom: z.number().min(1).max(20).default(15),\n    showDirections: z.boolean().default(false),\n    generateMapPreview: z.boolean().default(true),\n    phoneNumber: z.string().optional(),\n    firstName: z.string().optional(),\n    lastName: z.string().optional(),\n    userId: z.number().optional(),\n    vcard: z.string().optional(),\n    question: z.string().optional(),\n    options: z.array(z.string()).default([]),\n    allowsMultipleAnswers: z.boolean().default(false),\n    anonymousVoting: z.boolean().default(true),\n    emoji: z.string().optional(),\n    mediaDuration: z.number().optional(), // Длительность медиа-файла в секундах\n    width: z.number().optional(),\n    height: z.number().optional(),\n    performer: z.string().optional(),\n    fileSize: z.number().optional(),\n    filename: z.string().optional(),\n    // Настройки для сбора пользовательского ввода\n    inputType: z.enum(['text', 'number', 'email', 'phone', 'photo', 'video', 'audio', 'document', 'location', 'contact', 'any']).default('text'),\n    responseType: z.enum(['text', 'buttons']).default('text'), // Тип ответа: текстовый ввод или кнопки\n    responseOptions: z.array(z.object({\n      id: z.string(),\n      text: z.string(),\n      value: z.string().optional(),\n      action: z.enum(['goto', 'command', 'url']).default('goto'),\n      target: z.string().optional(),\n      url: z.string().optional()\n    })).default([]), // Варианты ответов для кнопок\n    allowMultipleSelection: z.boolean().default(false), // Разрешить множественный выбор\n    multiSelectVariable: z.string().optional(), // Имя переменной для сохранения множественного выбора\n    continueButtonText: z.string().optional(), // Текст кнопки завершения выбора\n    continueButtonTarget: z.string().optional(), // Узел для перехода после завершения выбора\n    inputVariable: z.string().optional(), // Имя переменной для сохранения ответа\n    inputPrompt: z.string().optional(), // Текст запроса ввода\n    inputValidation: z.string().optional(), // Правило валидации (regex или описание)\n    inputRequired: z.boolean().default(true), // Обязательность ввода\n    inputTimeout: z.number().optional(), // Таймаут ожидания ввода в секундах\n    inputRetryMessage: z.string().optional(), // Сообщение при неверном вводе\n    inputSuccessMessage: z.string().optional(), // Сообщение при успешном вводе\n    // Условные сообщения на основе пользовательских данных\n    enableConditionalMessages: z.boolean().default(false), // Включить условные сообщения\n    conditionalMessages: z.array(z.object({\n      id: z.string(),\n      condition: z.enum(['user_data_exists', 'user_data_equals', 'user_data_not_exists', 'user_data_contains', 'first_time', 'returning_user']).default('user_data_exists'), // Тип условия\n      variableName: z.string().optional(), // Имя переменной для проверки (для обратной совместимости)\n      variableNames: z.array(z.string()).default([]), // Массив имен переменных для проверки нескольких вопросов\n      logicOperator: z.enum(['AND', 'OR']).default('AND'), // Логический оператор для проверки нескольких переменных\n      expectedValue: z.string().optional(), // Ожидаемое значение для сравнения\n      messageText: z.string(), // Текст сообщения для этого условия\n      formatMode: z.enum(['text', 'markdown', 'html']).default('text'), // Режим форматирования текста условного сообщения\n      keyboardType: z.enum(['reply', 'inline', 'none']).default('none'), // Тип клавиатуры для условного сообщения\n      buttons: z.array(buttonSchema).default([]), // Кнопки для условного сообщения\n      resizeKeyboard: z.boolean().default(true).optional(), // Автоматически подбирать размер клавиатуры\n      oneTimeKeyboard: z.boolean().default(false).optional(), // Скрыть клавиатуру после использования\n      waitForTextInput: z.boolean().default(false), // Ожидание текстового ввода после показа сообщения\n      textInputVariable: z.string().optional(), // Переменная для сохранения текстового ввода\n      nextNodeAfterInput: z.string().optional(), // ID узла, к которому перейти после получения ввода\n      priority: z.number().default(0) // Приоритет проверки (чем больше, тем выше приоритет)\n    })).default([]), // Массив условных сообщений\n    fallbackMessage: z.string().optional(), // Сообщение по умолчанию, если ни одно условие не выполнено\n    saveToDatabase: z.boolean().default(false), // Сохранять ли в базу данных\n    allowSkip: z.boolean().default(false), // Разрешить пропуск ввода\n    \n    // Универсальные настройки сбора ввода для всех типов узлов\n    collectUserInput: z.boolean().default(false), // Включить сбор пользовательского ввода\n    inputTargetNodeId: z.string().optional(), // ID узла, к которому переходить после сбора ввода\n    inputButtonType: z.enum(['inline', 'reply']).default('inline'), // Тип кнопок для ответов\n    \n    // Автопереход - отправка сообщения и автоматический переход к следующему узлу без ожидания ввода\n    autoTransitionTo: z.string().optional(), // ID узла для автоматического перехода после отправки сообщения\n    minLength: z.number().optional(), // Минимальная длина текста\n    maxLength: z.number().optional(), // Максимальная длина текста\n    placeholder: z.string().optional(), // Подсказка для ввода\n    defaultValue: z.string().optional(), // Значение по умолчанию\n    \n    \n    // Настройки пользовательских действий\n    enableUserActions: z.boolean().default(false), // Включить пользовательские действия\n    actionTrigger: z.enum(['join', 'leave', 'message', 'button_click', 'custom']).optional(), // Триггер действия\n    triggerText: z.string().optional(), // Текст триггера\n    userActionType: z.enum(['message', 'command', 'button', 'media']).optional(), // Тип пользовательского действия\n    actionTag: z.string().optional(), // Тег действия\n    actionMessage: z.string().optional(), // Сообщение действия\n    silentAction: z.boolean().default(false), // Беззвучное действие\n    \n    // Дополнительные поля для различных типов узлов\n    mimeType: z.string().optional(),\n    stickerSetName: z.string().optional(),\n    fileName: z.string().optional(),\n    city: z.string().optional(),\n    country: z.string().optional(),\n    enableTextInput: z.boolean().optional(),\n    enablePhotoInput: z.boolean().optional(), // Включить ввод фото\n    enableVideoInput: z.boolean().optional(), // Включить ввод видео\n    enableAudioInput: z.boolean().optional(), // Включить ввод аудио\n    enableDocumentInput: z.boolean().optional(), // Включить ввод документа\n    photoInputVariable: z.string().optional(), // Переменная для сохранения file_id фото\n    videoInputVariable: z.string().optional(), // Переменная для сохранения file_id видео\n    audioInputVariable: z.string().optional(), // Переменная для сохранения file_id аудио\n    documentInputVariable: z.string().optional(), // Переменная для сохранения file_id документа\n    name: z.string().optional(),\n    label: z.string().optional(),\n    checkmarkSymbol: z.string().optional(),\n    multiSelectCheckmark: z.string().optional(),\n    \n    // Поля для управления пользователями (ID определяется автоматически из контекста)\n    duration: z.number().optional(), // Длительность действия в секундах\n    muteDuration: z.number().optional(), // Длительность действия (для mute) в секундах\n    reason: z.string().optional(), // Причина действия (бан, мут и т.д.)\n    // Права для promote/demote\n    canChangeInfo: z.boolean().default(false), // Может изменять информацию о группе\n    canDeleteMessages: z.boolean().default(false), // Может удалять сообщения\n    canBanUsers: z.boolean().default(false), // Может банить пользователей\n    canInviteUsers: z.boolean().default(false), // Может приглашать пользователей\n    canPinMessages: z.boolean().default(false), // Может закреплять сообщения\n    canAddAdmins: z.boolean().default(false), // Может добавлять администраторов\n    canRestrictMembers: z.boolean().default(false), // Может ограничивать участников\n    canPromoteMembers: z.boolean().default(false), // Может повышать участников\n    canManageVideoChats: z.boolean().default(false), // Может управлять видеочатами\n    canManageTopics: z.boolean().default(false), // Может управлять темами (для форумов)\n    isAnonymous: z.boolean().default(false), // Анонимные права администратора\n    // Ограничения для restrict пользователей\n    canSendMessages: z.boolean().default(true), // Может отправлять сообщения\n    canSendMediaMessages: z.boolean().default(true), // Может отправлять медиа\n    canSendPolls: z.boolean().default(true), // Может отправлять опросы\n    canSendOtherMessages: z.boolean().default(true), // Может отправлять другие сообщения\n    canAddWebPagePreviews: z.boolean().default(true), // Может добавлять превью веб-страниц\n    canChangeGroupInfo: z.boolean().default(true), // Может изменять информацию о группе\n    canInviteUsers2: z.boolean().default(true), // Может приглашать пользователей (дубликат для restrict)\n    canPinMessages2: z.boolean().default(true), // Может закреплять сообщения (дубликат для restrict)\n    untilDate: z.number().optional(), // Дата окончания ограничения (Unix timestamp)\n    \n    // Поля для узла admin_rights - управление правами администратора (в соответствии с Telegram Bot API)\n    adminTargetUserId: z.string().optional(), // ID пользователя для изменения прав\n    adminUserIdSource: z.enum(['manual', 'variable', 'last_message']).default('last_message'), // Источник ID пользователя\n    adminUserVariableName: z.string().optional(), // Имя переменной с ID пользователя\n    // Права администратора согласно Telegram Bot API (promoteChatMember)\n    can_manage_chat: z.boolean().default(false), // Может управлять чатом\n    can_post_messages: z.boolean().default(false), // Может публиковать сообщения (только каналы)\n    can_edit_messages: z.boolean().default(false), // Может редактировать сообщения (только каналы)\n    can_delete_messages: z.boolean().default(false), // Может удалять сообщения\n    can_post_stories: z.boolean().default(false), // Может публиковать истории\n    can_edit_stories: z.boolean().default(false), // Может редактировать истории\n    can_delete_stories: z.boolean().default(false), // Может удалять истории\n    can_manage_video_chats: z.boolean().default(false), // Может управлять видеочатами\n    can_restrict_members: z.boolean().default(false), // Может ограничивать участников\n    can_promote_members: z.boolean().default(false), // Может повышать участников\n    can_change_info: z.boolean().default(false), // Может изменять информацию чата\n    can_invite_users: z.boolean().default(false), // Может приглашать пользователей\n    can_pin_messages: z.boolean().default(false), // Может закреплять сообщения\n    can_manage_topics: z.boolean().default(false), // Может управлять темами (только супергруппы)\n    is_anonymous: z.boolean().default(false), // Может быть анонимным\n    // Связка с конкретным чатом или группой\n    adminChatId: z.string().optional(), // ID чата для применения прав\n    adminChatIdSource: z.enum(['manual', 'variable', 'current_chat']).default('current_chat'), // Источник ID чата\n    adminChatVariableName: z.string().optional(), // Имя переменной с ID чата\n    \n    // Прикрепленные медиапеременные (для отправки медиафайлов)\n    attachedMedia: z.array(z.string()).default([]) // Список имен медиапеременных для прикрепления к сообщению\n  }),\n});\n\nexport const connectionSchema = z.object({\n  id: z.string(),\n  source: z.string(),\n  target: z.string(),\n  sourceHandle: z.string().optional(),\n  targetHandle: z.string().optional(),\n  // Поддержка межлистовых соединений\n  sourceSheetId: z.string().optional(), // ID листа источника (если не указан, то текущий лист)\n  targetSheetId: z.string().optional(), // ID листа назначения (если не указан, то текущий лист)\n  isInterSheet: z.boolean().default(false), // Флаг межлистового соединения\n});\n\n// Схема для состояния вида листа (позиция и масштаб)\nexport const sheetViewStateSchema = z.object({\n  pan: z.object({\n    x: z.number().default(0),\n    y: z.number().default(0),\n  }).default({ x: 0, y: 0 }),\n  zoom: z.number().default(100),\n});\n\n// Схема для отдельного листа холста\nexport const canvasSheetSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  nodes: z.array(nodeSchema).default([]),\n  connections: z.array(connectionSchema).default([]),\n  viewState: sheetViewStateSchema.default({ pan: { x: 0, y: 0 }, zoom: 100 }),\n  createdAt: z.date().optional(),\n  updatedAt: z.date().optional(),\n});\n\n// Обновленная схема данных бота с поддержкой листов\nexport const botDataWithSheetsSchema = z.object({\n  sheets: z.array(canvasSheetSchema).default([]),\n  activeSheetId: z.string().optional(),\n  // Версия структуры данных для миграции\n  version: z.number().default(2),\n});\n\n// Старая схема для обратной совместимости\nexport const botDataSchema = z.object({\n  nodes: z.array(nodeSchema),\n  connections: z.array(connectionSchema),\n});\n\nexport type Button = z.infer<typeof buttonSchema>;\nexport type Node = z.infer<typeof nodeSchema>;\nexport type Connection = z.infer<typeof connectionSchema>;\nexport type SheetViewState = z.infer<typeof sheetViewStateSchema>;\nexport type CanvasSheet = z.infer<typeof canvasSheetSchema>;\nexport type BotDataWithSheets = z.infer<typeof botDataWithSheetsSchema>;\nexport type BotData = z.infer<typeof botDataSchema>;\n\n// Component definition for drag and drop\nexport interface ComponentDefinition {\n  id: string;\n  type: Node['type'];\n  name: string;\n  description: string;\n  icon: string;\n  color: string;\n  defaultData?: any;\n  [key: string]: any; // Allow additional properties for compatibility\n}\n\n// Schema for sending message to user from admin panel\nexport const sendMessageSchema = z.object({\n  messageText: z.string().min(1, \"Message text is required\").max(4096, \"Message text is too long\"),\n});\n\nexport type SendMessage = z.infer<typeof sendMessageSchema>;\n","size_bytes":48357},"client/src/hooks/use-url-download.ts":{"content":"import { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { MediaFile } from \"@shared/schema\";\n\nexport interface UrlCheckResult {\n  accessible: boolean;\n  fileInfo?: {\n    mimeType?: string;\n    size?: number;\n    fileName?: string;\n    fileType?: string;\n    category?: string;\n    sizeMB?: number;\n  };\n  error?: string;\n  code?: string;\n}\n\nexport interface UrlDownloadResult extends MediaFile {\n  downloadInfo: {\n    sourceUrl: string;\n    category?: string;\n    sizeMB: number;\n    autoTagsAdded: number;\n    downloadDate: string;\n    method: 'url_download';\n  };\n}\n\nexport interface BatchDownloadResult {\n  success: number;\n  errors: number;\n  downloadedFiles: UrlDownloadResult[];\n  errorDetails: Array<{\n    url: string;\n    error: string;\n  }>;\n  summary: {\n    total: number;\n    successful: number;\n    failed: number;\n    totalSize: number;\n  };\n}\n\nexport function useCheckUrl() {\n  return useMutation<UrlCheckResult, Error, string>({\n    mutationFn: async (url: string) => {\n      return await apiRequest('POST', '/api/media/check-url', { url });\n    }\n  });\n}\n\nexport function useDownloadUrl(projectId: number) {\n  const queryClient = useQueryClient();\n  \n  return useMutation<UrlDownloadResult, Error, {\n    url: string;\n    description?: string;\n    tags?: string;\n    isPublic?: boolean;\n    customFileName?: string;\n  }>({\n    mutationFn: async ({ url, description, tags, isPublic, customFileName }) => {\n      return await apiRequest('POST', `/api/media/download-url/${projectId}`, { \n        url, \n        description, \n        tags, \n        isPublic, \n        customFileName \n      });\n    },\n    onSuccess: () => {\n      // Обновляем кэш медиафайлов проекта\n      queryClient.invalidateQueries({ \n        queryKey: ['/api/media/project', projectId] \n      });\n    }\n  });\n}\n\nexport function useDownloadUrls(projectId: number) {\n  const queryClient = useQueryClient();\n  \n  return useMutation<BatchDownloadResult, Error, {\n    urls: Array<string | { \n      url: string; \n      fileName?: string; \n      description?: string; \n    }>;\n    isPublic?: boolean;\n    defaultDescription?: string;\n  }>({\n    mutationFn: async ({ urls, isPublic, defaultDescription }) => {\n      return await apiRequest('POST', `/api/media/download-urls/${projectId}`, { \n        urls, \n        isPublic, \n        defaultDescription \n      });\n    },\n    onSuccess: () => {\n      // Обновляем кэш медиафайлов проекта\n      queryClient.invalidateQueries({ \n        queryKey: ['/api/media/project', projectId] \n      });\n    }\n  });\n}\n\n// Функция для валидации URL\nexport function isValidUrl(string: string): boolean {\n  try {\n    const url = new URL(string);\n    return ['http:', 'https:'].includes(url.protocol);\n  } catch {\n    return false;\n  }\n}\n\n// Функция для извлечения имени файла из URL\nexport function extractFileNameFromUrl(url: string): string {\n  try {\n    const urlObj = new URL(url);\n    const pathname = urlObj.pathname;\n    const segments = pathname.split('/');\n    const fileName = segments[segments.length - 1];\n    \n    // Если есть расширение файла, возвращаем имя файла\n    if (fileName && fileName.includes('.')) {\n      return fileName;\n    }\n    \n    // Если нет расширения, пытаемся определить по Content-Disposition в заголовках\n    return fileName || 'downloaded-file';\n  } catch {\n    return 'downloaded-file';\n  }\n}\n\n// Функция для определения типа файла по URL\nexport function getFileTypeFromUrl(url: string): 'photo' | 'video' | 'audio' | 'document' | 'unknown' {\n  const fileName = extractFileNameFromUrl(url).toLowerCase();\n  \n  // Изображения\n  if (/\\.(jpg|jpeg|png|gif|webp|svg|bmp)$/i.test(fileName)) {\n    return 'photo';\n  }\n  \n  // Видео\n  if (/\\.(mp4|webm|avi|mov|mkv|flv|wmv)$/i.test(fileName)) {\n    return 'video';\n  }\n  \n  // Аудио\n  if (/\\.(mp3|wav|ogg|aac|flac|m4a)$/i.test(fileName)) {\n    return 'audio';\n  }\n  \n  // Документы\n  if (/\\.(pdf|doc|docx|txt|xls|xlsx|ppt|pptx|zip|rar)$/i.test(fileName)) {\n    return 'document';\n  }\n  \n  return 'unknown';\n}\n\n// Функция для форматирования размера файла\nexport function formatFileSize(bytes?: number): string {\n  if (!bytes) return '0 Б';\n  \n  const sizes = ['Б', 'КБ', 'МБ', 'ГБ'];\n  const i = Math.floor(Math.log(bytes) / Math.log(1024));\n  const formattedSize = (bytes / Math.pow(1024, i)).toFixed(1);\n  \n  return `${formattedSize} ${sizes[i]}`;\n}\n\n// Функция для проверки поддерживаемых типов файлов\nexport function isSupportedFileType(url: string): boolean {\n  const fileType = getFileTypeFromUrl(url);\n  return fileType !== 'unknown';\n}","size_bytes":4952},"README.md":{"content":"# Telegram Bot Builder 🤖\n\nВизуальная платформа для создания и управления Telegram ботами с drag-and-drop интерфейсом и автоматической генерацией Python кода.\n\n## ⚡ Быстрый старт\n\n1. **Клонируйте репозиторий:**\n   ```bash\n   git clone https://github.com/fedorabakumets/telegram-bot-builder.git\n   cd telegram-bot-builder\n   ```\n\n2. **Установите зависимости:**\n   ```bash\n   npm install\n   ```\n\n3. **Настройте базу данных:**\n   ```bash\n   # Скопируйте настройки\n   cp .env.example .env\n   # Отредактируйте DATABASE_URL в .env\n   \n   # Примените миграции\n   npm run db:push\n   ```\n\n4. **Запустите приложение:**\n   ```bash\n   npm run dev\n   ```\n\n5. **Откройте браузер:** http://localhost:5000\n\n> 📖 **Подробная установка:** см. [SETUP.md](SETUP.md) для детальных инструкций по установке на Windows и других платформах.\n\n## 🌟 Основные возможности\n\n- 🎨 **Визуальный редактор** - создавайте ботов перетаскиванием элементов на холст\n- 🔧 **Автогенерация кода** - получайте готовый Python код для aiogram 3.x\n- 📱 **Предпросмотр в реальном времени** - тестируйте бота прямо в браузере\n- 🗄️ **Интеграция с PostgreSQL** - автоматическое сохранение данных пользователей\n- 📊 **Готовые шаблоны** - используйте примеры для быстрого старта\n- 🎭 **Темная/светлая темы** - современный адаптивный интерфейс\n- 🔐 **Безопасность** - защищенное хранение токенов ботов\n- 📊 **Аналитика пользователей** - статистика использования и команд\n\n## 🛠 Технологии\n\n### Frontend\n- **React 18** с TypeScript\n- **Vite** для быстрой разработки\n- **Tailwind CSS** для стилизации\n- **Shadcn/ui** компоненты\n- **TanStack Query** для управления состоянием\n- **Wouter** для роутинга\n\n### Backend\n- **Node.js** с Express.js\n- **TypeScript** (ES modules)\n- **PostgreSQL** с Drizzle ORM\n- **WebSocket** для реального времени\n- **Express Session** с PostgreSQL storage\n\n### Генерация ботов\n- **Python** с aiogram 3.x\n- **PostgreSQL** для данных пользователей\n- **aiohttp** для HTTP запросов\n- **asyncpg** для асинхронной работы с БД\n\n## 🎯 Возможности создаваемых ботов\n\n### Типы узлов\n- **Start** - стартовый узел бота\n- **Message** - отправка текстовых сообщений\n- **Photo** - отправка изображений\n- **Keyboard** - inline и reply клавиатуры\n- **Condition** - условная логика\n- **Command** - обработка команд\n- **User Input** - сбор данных от пользователей\n- **Media** - работа с файлами\n\n### Функциональность\n- ✅ Текстовое форматирование (Markdown/HTML)\n- ✅ Inline и reply клавиатуры\n- ✅ Медиафайлы (фото, видео, аудио, документы)\n- ✅ Геолокация с интеграцией карт\n- ✅ Сбор пользовательских данных с валидацией\n- ✅ Условная логика и навигация\n- ✅ База данных пользователей\n- ✅ Статистика и аналитика\n\n## 📁 Структура проекта\n\n```\ntelegram-bot-builder/\n├── client/                 # React frontend\n│   ├── src/\n│   │   ├── components/     # UI компоненты\n│   │   │   ├── ui/         # Базовые компоненты\n│   │   │   └── editor/     # Компоненты редактора\n│   │   ├── pages/          # Страницы приложения\n│   │   └── lib/            # Утилиты и хуки\n├── server/                 # Express backend\n│   ├── routes.ts           # API маршруты\n│   ├── storage.ts          # Интерфейс БД\n│   ├── db.ts              # Подключение к БД\n│   └── telegram-client.ts  # Telegram API\n├── shared/                 # Общие типы и схемы\n│   └── schema.ts           # Схемы Drizzle ORM\n├── scripts/               # Утилиты БД\n├── bots/                  # Сгенерированные боты\n└── uploads/               # Загруженные файлы\n```\n\n## 🔌 API Endpoints\n\n### Проекты\n- `GET /api/projects` - Список всех проектов\n- `POST /api/projects` - Создание нового проекта\n- `GET /api/projects/:id` - Получение проекта по ID\n- `PUT /api/projects/:id` - Обновление проекта\n- `DELETE /api/projects/:id` - Удаление проекта\n\n### Управление ботами\n- `POST /api/projects/:id/bot/start` - Запуск бота\n- `POST /api/projects/:id/bot/stop` - Остановка бота\n- `GET /api/projects/:id/bot/status` - Статус бота\n\n### Шаблоны\n- `GET /api/templates` - Получение шаблонов\n- `POST /api/templates` - Создание шаблона\n- `PUT /api/templates/:id` - Обновление шаблона\n\n### Медиафайлы\n- `POST /api/projects/:id/media/upload` - Загрузка файлов\n- `GET /api/projects/:id/media` - Список медиафайлов\n\n### База данных\n- `GET /api/database/health` - Статус подключения к БД\n- `GET /api/database/stats` - Статистика базы данных\n\n## 🚀 Развертывание\n\n### Для разработки\n```bash\nnpm run dev          # Запуск в режиме разработки\nnpm run db:push      # Обновление схемы БД\nnpm run check        # Проверка TypeScript\n```\n\n### Для продакшена\n```bash\n# Сборка приложения\nnpm run build\n\n# Настройка переменных окружения\nexport NODE_ENV=production\nexport DATABASE_URL=your_postgres_url\nexport PORT=5000\n\n# Запуск\nnpm start\n```\n\n## 📋 Системные требования\n\n- **Node.js** 18.0.0 или выше\n- **PostgreSQL** 13 или выше\n- **Python** 3.11+ (для генерируемых ботов)\n- **npm** или **yarn**\n\n## 🐛 Решение проблем\n\n### База данных\n- Убедитесь что PostgreSQL запущен\n- Проверьте строку подключения в `.env`\n- Выполните `npm run db:push` для создания таблиц\n\n### Порт занят\n```bash\n# Найдите процесс на порту 5000\nnetstat -tulpn | grep 5000\n# Завершите процесс\nkill -9 PID\n```\n\n### Ошибки установки\n- Запустите от имени администратора (Windows)\n- Очистите кеш: `npm cache clean --force`\n- Удалите `node_modules` и выполните `npm install`\n\n## 📄 Лицензия\n\nMIT License - см. [LICENSE](LICENSE) для подробностей.\n\n## 🤝 Поддержка\n\n- 📧 **Баги и предложения:** [GitHub Issues](https://github.com/fedorabakumets/telegram-bot-builder/issues)\n- 💬 **Обсуждения:** [GitHub Discussions](https://github.com/fedorabakumets/telegram-bot-builder/discussions)\n- 📖 **Документация:** [Wiki](https://github.com/fedorabakumets/telegram-bot-builder/wiki)\n\n---\n\nСделано с ❤️ для сообщества разработчиков Telegram ботов","size_bytes":8295},"client/src/pages/editor-simple.tsx":{"content":"import { useState, useCallback, useEffect } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { useLocation, useParams } from 'wouter';\nimport { AdaptiveHeader } from '@/components/layout/adaptive-header';\nimport { ComponentsSidebar } from '@/components/editor/components-sidebar';\nimport { Canvas } from '@/components/editor/canvas';\nimport { PropertiesPanel } from '@/components/editor/properties-panel';\nimport { PreviewModal } from '@/components/editor/preview-modal';\nimport { ExportModal } from '@/components/editor/export-modal';\nimport { BotControl } from '@/components/editor/bot-control';\nimport { SaveTemplateModal } from '@/components/editor/save-template-modal';\n\nimport { ConnectionManagerPanel } from '@/components/editor/connection-manager-panel';\nimport { EnhancedConnectionControls } from '@/components/editor/enhanced-connection-controls';\nimport { ConnectionVisualization } from '@/components/editor/connection-visualization';\nimport { SmartConnectionCreator } from '@/components/editor/smart-connection-creator';\nimport { UserDatabasePanel } from '@/components/editor/user-database-panel';\nimport { ResponsesPanel } from '@/components/editor/responses-panel';\nimport { SimpleLayoutCustomizer, SimpleLayoutConfig } from '@/components/layout/simple-layout-customizer';\nimport { FlexibleLayout } from '@/components/layout/flexible-layout';\nimport { useBotEditor } from '@/hooks/use-bot-editor';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport { BotProject, Connection, ComponentDefinition, BotData } from '@shared/schema';\n\nexport default function EditorSimple() {\n  const [, setLocation] = useLocation();\n  const [currentTab, setCurrentTab] = useState<'editor' | 'preview' | 'export' | 'bot' | 'connections' | 'database' | 'responses'>('editor');\n  const [showPreview, setShowPreview] = useState(false);\n  const [showExport, setShowExport] = useState(false);\n  const [showSaveTemplate, setShowSaveTemplate] = useState(false);\n\n  const [selectedConnectionId, setSelectedConnectionId] = useState<string | null>(null);\n  const [autoButtonCreation, setAutoButtonCreation] = useState(true);\n  const [selectedConnection, setSelectedConnection] = useState<Connection | null>(null);\n  \n  // Базовая конфигурация макета\n  const baseLayoutConfig: SimpleLayoutConfig = {\n    elements: [\n      {\n        id: 'header',\n        type: 'header',\n        name: 'Шапка',\n        position: 'top',\n        size: 64,\n        visible: true\n      },\n      {\n        id: 'sidebar',\n        type: 'sidebar',\n        name: 'Боковая панель',\n        position: 'left',\n        size: 20,\n        visible: true\n      },\n      {\n        id: 'canvas',\n        type: 'canvas',\n        name: 'Холст',\n        position: 'center',\n        size: 55,\n        visible: true\n      },\n      {\n        id: 'properties',\n        type: 'properties',\n        name: 'Свойства',\n        position: 'right',\n        size: 25,\n        visible: true\n      }\n    ],\n    compactMode: false,\n    showGrid: true\n  };\n\n  const [flexibleLayoutConfig, setFlexibleLayoutConfig] = useState<SimpleLayoutConfig>(baseLayoutConfig);\n\n  // Используем хук для отслеживания размера экрана\n  const isMobile = useMediaQuery('(max-width: 1200px)');\n\n  // Создаем адаптивную конфигурацию в зависимости от текущей вкладки\n  const adaptiveLayoutConfig = useMemo(() => {\n    console.log('Adaptive Layout Config Update:', {\n      currentTab,\n      isMobile,\n      shouldHidePanels: currentTab === 'bot' && isMobile\n    });\n    \n    if (currentTab === 'bot' && isMobile) {\n      // На странице бота на мобильных устройствах скрываем боковые панели\n      const newConfig = {\n        ...flexibleLayoutConfig,\n        elements: flexibleLayoutConfig.elements.map(el => ({\n          ...el,\n          visible: el.type === 'sidebar' || el.type === 'properties' ? false : el.visible\n        }))\n      };\n      console.log('Hiding panels for mobile bot page', newConfig);\n      return newConfig;\n    }\n    \n    console.log('Using default layout', flexibleLayoutConfig);\n    return flexibleLayoutConfig;\n  }, [flexibleLayoutConfig, currentTab, isMobile]);\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Load the first project for demo\n  const { data: projects } = useQuery<BotProject[]>({\n    queryKey: ['/api/projects'],\n  });\n\n  const currentProject = projects?.[0];\n\n  const {\n    nodes,\n    connections,\n    selectedNode,\n    selectedNodeId,\n    setSelectedNodeId,\n    addNode,\n    updateNode,\n    deleteNode,\n    addConnection,\n    deleteConnection,\n    updateConnection,\n    updateNodeData,\n    addButton,\n    updateButton,\n    deleteButton,\n    updateNodes,\n    setBotData,\n    getBotData\n  } = useBotEditor(currentProject?.data as BotData);\n\n  const updateProjectMutation = useMutation({\n    mutationFn: async (data: any) => {\n      if (!currentProject) return;\n      return apiRequest('PUT', `/api/projects/${currentProject.id}`, {\n        data: getBotData()\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      toast({\n        title: \"Проект сохранен\",\n        description: \"Изменения успешно сохранены\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Ошибка сохранения\",\n        description: \"Не удалось сохранить проект\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSave = useCallback(() => {\n    updateProjectMutation.mutate({});\n  }, [updateProjectMutation]);\n\n  const handleTabChange = useCallback((tab: 'editor' | 'preview' | 'export' | 'bot' | 'connections' | 'database' | 'responses') => {\n    setCurrentTab(tab);\n    if (tab === 'preview') {\n      updateProjectMutation.mutate({});\n      setShowPreview(true);\n    } else if (tab === 'export') {\n      setShowExport(true);\n    } else if (tab === 'bot') {\n      updateProjectMutation.mutate({});\n    } else if (tab === 'connections') {\n      updateProjectMutation.mutate({});\n    } else if (tab === 'database') {\n      // Перенаправляем на страницу базы данных\n      setLocation('/database');\n    } else if (tab === 'responses') {\n      updateProjectMutation.mutate({});\n    }\n  }, [updateProjectMutation, setLocation]);\n\n  const handleNodeMove = useCallback((nodeId: string, position: { x: number; y: number }) => {\n    updateNode(nodeId, { position });\n  }, [updateNode]);\n\n  const handleComponentDrag = useCallback((component: ComponentDefinition) => {\n    // Handle component drag start if needed\n  }, []);\n\n  const handleSaveAsTemplate = useCallback(() => {\n    setShowSaveTemplate(true);\n  }, []);\n\n  const handleLoadTemplate = useCallback(() => {\n    setLocation('/templates');\n  }, [setLocation]);\n\n  const handleSelectTemplate = useCallback((template: any) => {\n    try {\n      const templateData = template.data;\n      if (!templateData || !templateData.nodes) {\n        throw new Error('Некорректные данные шаблона');\n      }\n      \n      setBotData(templateData);\n      updateProjectMutation.mutate({\n        data: templateData\n      });\n      \n      toast({\n        title: 'Шаблон применен',\n        description: `Шаблон \"${template.name}\" успешно загружен на холст`,\n      });\n    } catch (error) {\n      console.error('Ошибка применения шаблона:', error);\n      toast({\n        title: 'Ошибка',\n        description: 'Не удалось применить шаблон',\n        variant: 'destructive',\n      });\n    }\n  }, [setBotData, updateProjectMutation, toast]);\n\n  // Проверяем наличие выбранного шаблона в localStorage при загрузке\n  useEffect(() => {\n    const selectedTemplateData = localStorage.getItem('selectedTemplate');\n    if (selectedTemplateData && currentProject) {\n      try {\n        const template = JSON.parse(selectedTemplateData);\n        handleSelectTemplate(template);\n        localStorage.removeItem('selectedTemplate'); // Удаляем после использования\n      } catch (error) {\n        console.error('Ошибка применения шаблона из localStorage:', error);\n        localStorage.removeItem('selectedTemplate');\n      }\n    }\n  }, [currentProject, handleSelectTemplate]);\n\n  const handleConnectionSelect = useCallback((connection: Connection | null) => {\n    setSelectedConnection(connection);\n    setSelectedConnectionId(connection?.id || null);\n  }, []);\n\n  const handleConnectionEdit = useCallback((connection: Connection) => {\n    setSelectedConnection(connection);\n    setSelectedConnectionId(connection.id);\n  }, []);\n\n  const handleConnectionDelete = useCallback((connectionId: string) => {\n    deleteConnection(connectionId);\n    if (selectedConnectionId === connectionId) {\n      setSelectedConnectionId(null);\n      setSelectedConnection(null);\n    }\n  }, [deleteConnection, selectedConnectionId]);\n\n  if (!currentProject) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-4\">\n            <i className=\"fas fa-spinner fa-spin text-gray-400 text-xl\"></i>\n          </div>\n          <p className=\"text-gray-600\">Загрузка проекта...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Создаем содержимое для каждого элемента макета\n  const headerContent = (\n    <AdaptiveHeader\n      config={{\n        headerPosition: 'top',\n        sidebarPosition: 'left',\n        propertiesPosition: 'right',\n        canvasFullscreen: false,\n        compactMode: false,\n        showGrid: true,\n        panelSizes: {\n          sidebar: 20,\n          properties: 25,\n          canvas: 55\n        }\n      }}\n      projectName={currentProject.name}\n      currentTab={currentTab}\n      onTabChange={handleTabChange}\n      onSave={handleSave}\n      onExport={() => setShowExport(true)}\n      onSaveAsTemplate={handleSaveAsTemplate}\n      onLoadTemplate={handleLoadTemplate}\n      onLayoutSettings={() => {}}\n      isSaving={updateProjectMutation.isPending}\n    />\n  );\n\n  const sidebarContent = (\n    <ComponentsSidebar \n      onComponentDrag={handleComponentDrag} \n      onLoadTemplate={handleLoadTemplate}\n    />\n  );\n\n  const canvasContent = (\n    <div className=\"h-full\">\n      {currentTab === 'editor' ? (\n        <Canvas\n          nodes={nodes}\n          connections={connections}\n          selectedNodeId={selectedNodeId}\n          selectedConnectionId={selectedConnectionId || undefined}\n          onNodeSelect={setSelectedNodeId}\n          onNodeAdd={addNode}\n          onNodeDelete={deleteNode}\n          onNodeMove={handleNodeMove}\n          onConnectionSelect={setSelectedConnectionId}\n          onConnectionDelete={deleteConnection}\n          onConnectionAdd={addConnection}\n          onNodesUpdate={updateNodes}\n        />\n      ) : currentTab === 'bot' ? (\n        <div className=\"h-full p-6 bg-gray-50 overflow-auto\">\n          <div className=\"max-w-2xl mx-auto\">\n            <BotControl\n              projectId={currentProject.id}\n              projectName={currentProject.name}\n            />\n          </div>\n        </div>\n      ) : currentTab === 'connections' ? (\n        <div className=\"h-full bg-background\">\n          <div className=\"h-full flex\">\n            <div className=\"w-1/2 p-4 space-y-4 overflow-auto\">\n              <SmartConnectionCreator\n                nodes={nodes}\n                connections={connections}\n                onConnectionAdd={addConnection}\n                onNodesChange={updateNodes}\n                autoButtonCreation={autoButtonCreation}\n                selectedNodeId={selectedNodeId || undefined}\n              />\n              \n              <EnhancedConnectionControls\n                nodes={nodes}\n                connections={connections}\n                onConnectionAdd={addConnection}\n                onConnectionDelete={deleteConnection}\n                onConnectionUpdate={updateConnection}\n                onNodesChange={updateNodes}\n                autoButtonCreation={autoButtonCreation}\n                onAutoButtonCreationChange={setAutoButtonCreation}\n                selectedConnection={selectedConnection}\n                onConnectionSelect={setSelectedConnection}\n              />\n            </div>\n            \n            <div className=\"w-1/2 p-4 overflow-auto border-l\">\n              <ConnectionVisualization\n                nodes={nodes}\n                connections={connections}\n                onConnectionSelect={handleConnectionSelect}\n                onConnectionDelete={handleConnectionDelete}\n                onConnectionEdit={handleConnectionEdit}\n                selectedConnectionId={selectedConnectionId || undefined}\n                showLabels={true}\n                showMetrics={true}\n                interactive={true}\n              />\n            </div>\n          </div>\n        </div>\n      ) : currentTab === 'database' ? (\n        <div className=\"h-full\">\n          <UserDatabasePanel\n            projectId={currentProject.id}\n            projectName={currentProject.name}\n          />\n        </div>\n      ) : currentTab === 'responses' ? (\n        <div className=\"h-full\">\n          <ResponsesPanel\n            projectId={currentProject.id}\n            projectName={currentProject.name}\n          />\n        </div>\n      ) : null}\n    </div>\n  );\n\n  const propertiesContent = (\n    <PropertiesPanel\n      projectId={currentProject.id}\n      selectedNode={selectedNode}\n      allNodes={nodes}\n      onNodeUpdate={updateNodeData}\n      onButtonAdd={addButton}\n      onButtonUpdate={updateButton}\n      onButtonDelete={deleteButton}\n    />\n  );\n\n  return (\n    <>\n      <SimpleLayoutCustomizer\n        config={flexibleLayoutConfig}\n        onConfigChange={setFlexibleLayoutConfig}\n      >\n        <FlexibleLayout\n          config={adaptiveLayoutConfig}\n          headerContent={headerContent}\n          sidebarContent={sidebarContent}\n          canvasContent={canvasContent}\n          propertiesContent={propertiesContent}\n          onConfigChange={setFlexibleLayoutConfig}\n        />\n      </SimpleLayoutCustomizer>\n\n      <PreviewModal\n        isOpen={showPreview}\n        onClose={() => {\n          setShowPreview(false);\n          setCurrentTab('editor');\n        }}\n        nodes={nodes}\n        connections={connections}\n        projectName={currentProject.name}\n      />\n\n      <ExportModal\n        isOpen={showExport}\n        onClose={() => {\n          setShowExport(false);\n          setCurrentTab('editor');\n        }}\n        botData={currentProject?.data as any}\n        projectName={currentProject.name}\n      />\n\n      <SaveTemplateModal\n        isOpen={showSaveTemplate}\n        onClose={() => setShowSaveTemplate(false)}\n        botData={currentProject?.data as any}\n        projectName={currentProject.name}\n      />\n\n\n    </>\n  );\n}","size_bytes":15363},"client/src/components/layout/layout-toggle-buttons.tsx":{"content":"import { Navigation, Sidebar, Sliders, Monitor } from 'lucide-react';\n\ninterface LayoutToggleButtonsProps {\n  onToggleHeader?: () => void;\n  onToggleSidebar?: () => void;\n  onToggleProperties?: () => void;\n  onToggleCanvas?: () => void;\n  headerVisible?: boolean;\n  sidebarVisible?: boolean;\n  propertiesVisible?: boolean;\n  canvasVisible?: boolean;\n}\n\nexport function LayoutToggleButtons({\n  onToggleHeader,\n  onToggleSidebar,\n  onToggleProperties,\n  onToggleCanvas,\n  headerVisible,\n  sidebarVisible,\n  propertiesVisible,\n  canvasVisible\n}: LayoutToggleButtonsProps) {\n  if (!(onToggleHeader || onToggleSidebar || onToggleProperties || onToggleCanvas)) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed top-4 right-4 z-50\">\n      <div className=\"flex items-center space-x-1 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 p-1\">\n        {onToggleHeader && (\n          <button\n            onClick={onToggleHeader}\n            className={`p-2 rounded-md transition-all duration-200 ${\n              headerVisible \n                ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400' \n                : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'\n            }`}\n            title={`${headerVisible ? 'Скрыть' : 'Показать'} шапку`}\n          >\n            <Navigation className=\"w-4 h-4\" />\n          </button>\n        )}\n        \n        {onToggleSidebar && (\n          <button\n            onClick={onToggleSidebar}\n            className={`p-2 rounded-md transition-all duration-200 ${\n              sidebarVisible \n                ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400' \n                : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'\n            }`}\n            title={`${sidebarVisible ? 'Скрыть' : 'Показать'} боковую панель`}\n          >\n            <Sidebar className=\"w-4 h-4\" />\n          </button>\n        )}\n        \n        {onToggleCanvas && (\n          <button\n            onClick={onToggleCanvas}\n            className={`p-2 rounded-md transition-all duration-200 ${\n              canvasVisible \n                ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400' \n                : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'\n            }`}\n            title={`${canvasVisible ? 'Скрыть' : 'Показать'} холст`}\n          >\n            <Monitor className=\"w-4 h-4\" />\n          </button>\n        )}\n        \n        {onToggleProperties && (\n          <button\n            onClick={onToggleProperties}\n            className={`p-2 rounded-md transition-all duration-200 ${\n              propertiesVisible \n                ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400' \n                : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'\n            }`}\n            title={`${propertiesVisible ? 'Скрыть' : 'Показать'} панель свойств`}\n          >\n            <Sliders className=\"w-4 h-4\" />\n          </button>\n        )}\n      </div>\n    </div>\n  );\n}","size_bytes":3249},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }","size_bytes":1229},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/components/editor/fullscreen-canvas.tsx":{"content":"import { useEffect, useCallback, useState } from 'react';\nimport { Canvas } from '@/components/editor/canvas';\nimport { ComponentsSidebar } from '@/components/editor/components-sidebar';\nimport { Button } from '@/components/ui/button';\nimport { Node, Connection, ComponentDefinition } from '@/types/bot';\n\ninterface FullscreenCanvasProps {\n  nodes: Node[];\n  connections: Connection[];\n  selectedNodeId: string | null;\n  selectedConnectionId?: string;\n  onNodeSelect: (nodeId: string) => void;\n  onNodeAdd: (node: Node) => void;\n  onNodeDelete: (nodeId: string) => void;\n  onNodeDuplicate?: (nodeId: string) => void;\n  onNodeMove: (nodeId: string, position: { x: number; y: number }) => void;\n  onConnectionSelect?: (connectionId: string) => void;\n  onConnectionDelete?: (connectionId: string) => void;\n  onConnectionAdd?: (connection: Connection) => void;\n  onNodesUpdate?: (nodes: Node[]) => void;\n  onUndo?: () => void;\n  onRedo?: () => void;\n  canUndo?: boolean;\n  canRedo?: boolean;\n  onSave?: () => void;\n  isSaving?: boolean;\n  onExitFullscreen: () => void;\n}\n\nexport function FullscreenCanvas({\n  nodes,\n  connections,\n  selectedNodeId,\n  selectedConnectionId,\n  onNodeSelect,\n  onNodeAdd,\n  onNodeDelete,\n  onNodeDuplicate,\n  onNodeMove,\n  onConnectionSelect,\n  onConnectionDelete,\n  onConnectionAdd,\n  onNodesUpdate,\n  onUndo,\n  onRedo,\n  canUndo,\n  canRedo,\n  onSave,\n  isSaving,\n  onExitFullscreen\n}: FullscreenCanvasProps) {\n  \n  const [showComponentsSidebar, setShowComponentsSidebar] = useState(false);\n  const [isNodeBeingDragged, setIsNodeBeingDragged] = useState(false);\n\n  const handleComponentDrag = useCallback((component: ComponentDefinition) => {\n    // Handle component drag if needed\n  }, []);\n\n  const handleComponentAdd = useCallback((component: ComponentDefinition) => {\n    // Создаем новый узел из компонента\n    const newNode: any = {\n      id: Date.now().toString(), // Простой уникальный ID\n      type: component.type,\n      position: { x: 200 + Math.random() * 100, y: 200 + Math.random() * 100 },\n      data: component.defaultData || {}\n    };\n    \n    // Добавляем узел на холст\n    onNodeAdd(newNode);\n  }, [onNodeAdd]);\n\n  const toggleComponentsSidebar = useCallback(() => {\n    setShowComponentsSidebar(prev => !prev);\n  }, []);\n  \n  // Handle ESC key to exit fullscreen\n  const handleKeyDown = useCallback((event: KeyboardEvent) => {\n    if (event.key === 'Escape') {\n      onExitFullscreen();\n    }\n  }, [onExitFullscreen]);\n\n  // Handle F11 key\n  const handleF11 = useCallback((event: KeyboardEvent) => {\n    if (event.key === 'F11') {\n      event.preventDefault();\n      onExitFullscreen();\n    }\n  }, [onExitFullscreen]);\n\n  useEffect(() => {\n    document.addEventListener('keydown', handleKeyDown);\n    document.addEventListener('keydown', handleF11);\n    \n    // Hide scrollbars on body when in fullscreen\n    document.body.style.overflow = 'hidden';\n    \n    return () => {\n      document.removeEventListener('keydown', handleKeyDown);\n      document.removeEventListener('keydown', handleF11);\n      document.body.style.overflow = 'auto';\n    };\n  }, [handleKeyDown, handleF11]);\n\n  return (\n    <div className=\"fixed inset-0 z-50 bg-white dark:bg-slate-950 flex\">\n      {/* Components Sidebar */}\n      {showComponentsSidebar && (\n        <div className=\"w-80 h-full bg-white/95 dark:bg-slate-950/95 backdrop-blur-md border-r border-gray-200/50 dark:border-slate-700/50 shadow-2xl flex-shrink-0\">\n          <div className=\"h-full flex flex-col\">\n            <div className=\"p-4 border-b border-gray-200/50 dark:border-slate-700/50\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-lg font-semibold text-gray-900 dark:text-gray-100\">Компоненты</h3>\n                <Button\n                  onClick={toggleComponentsSidebar}\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-8 w-8 p-0\"\n                >\n                  <i className=\"fas fa-times text-gray-500\"></i>\n                </Button>\n              </div>\n            </div>\n            <div className=\"flex-1 overflow-hidden\">\n              <ComponentsSidebar\n                onComponentDrag={handleComponentDrag}\n                onComponentAdd={handleComponentAdd}\n              />\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Main canvas area */}\n      <div className=\"flex-1 relative\">\n        {/* Top controls */}\n        <div className=\"absolute top-4 right-4 z-50 flex items-center space-x-2\">\n          <Button\n            onClick={toggleComponentsSidebar}\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"bg-white/90 dark:bg-slate-900/90 backdrop-blur-md shadow-xl border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800\"\n          >\n            <i className=\"fas fa-th-large mr-2\"></i>\n            Компоненты\n          </Button>\n          <Button\n            onClick={onExitFullscreen}\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"bg-white/90 dark:bg-slate-900/90 backdrop-blur-md shadow-xl border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800\"\n          >\n            <i className=\"fas fa-times mr-2\"></i>\n            Выйти из полноэкранного режима\n          </Button>\n        </div>\n\n        {/* Help text */}\n        <div className=\"absolute bottom-4 left-4 z-50\">\n          <div className=\"bg-white/90 dark:bg-slate-900/90 backdrop-blur-md rounded-lg shadow-xl border border-gray-200/50 dark:border-slate-700/50 px-3 py-2 text-xs text-gray-600 dark:text-gray-400\">\n            <div className=\"flex items-center space-x-2\">\n              <i className=\"fas fa-keyboard text-blue-500\"></i>\n              <span>ESC или F11 для выхода</span>\n            </div>\n          </div>\n        </div>\n\n        {/* Canvas taking full remaining space */}\n        <div className=\"w-full h-full\">\n          <Canvas\n            nodes={nodes}\n            connections={connections}\n            selectedNodeId={selectedNodeId}\n            selectedConnectionId={selectedConnectionId}\n            onNodeSelect={onNodeSelect}\n            onNodeAdd={onNodeAdd}\n            onNodeDelete={onNodeDelete}\n            onNodeDuplicate={onNodeDuplicate}\n            onNodeMove={onNodeMove}\n            onConnectionSelect={onConnectionSelect}\n            onConnectionDelete={onConnectionDelete}\n            onConnectionAdd={onConnectionAdd}\n            onNodesUpdate={onNodesUpdate}\n            onUndo={onUndo}\n            onRedo={onRedo}\n            canUndo={canUndo}\n            canRedo={canRedo}\n            onSave={onSave}\n            isSaving={isSaving}\n            isNodeBeingDragged={isNodeBeingDragged}\n            setIsNodeBeingDragged={setIsNodeBeingDragged}\n          />\n        </div>\n      </div>\n    </div>\n  );\n}","size_bytes":6979},"client/src/utils/hierarchical-layout.ts":{"content":"import { Node, Connection } from '@/types/bot';\nimport { getIsMobile } from '@/hooks/use-mobile';\n\ninterface LayoutNode extends Node {\n  level?: number;\n  children?: LayoutNode[];\n  visited?: boolean;\n}\n\ninterface HierarchicalLayoutOptions {\n  levelHeight: number;\n  nodeWidth: number;\n  nodeHeight: number; // Добавлена высота узла\n  horizontalSpacing: number;\n  verticalSpacing: number;\n  startX: number;\n  startY: number;\n  nodeSizes?: Map<string, { width: number; height: number }>; // Карта реальных размеров узлов\n}\n\nconst DEFAULT_OPTIONS: HierarchicalLayoutOptions = {\n  levelHeight: 150,\n  nodeWidth: 320,\n  nodeHeight: 120, // Добавлена типичная высота узла\n  horizontalSpacing: 150, // Увеличено до 150 для лучшего избежания пересечений\n  verticalSpacing: 120, // Увеличено до 120 для лучшего избежания пересечений\n  startX: 50,\n  startY: 50\n};\n\n/**\n * Получает размер узла с учетом реальных измерений или дефолтных значений\n */\nfunction getNodeSize(nodeId: string, options: HierarchicalLayoutOptions): { width: number; height: number } {\n  const realSize = options.nodeSizes?.get(nodeId);\n  return realSize || { width: options.nodeWidth, height: options.nodeHeight };\n}\n\n/**\n * Создает иерархическое расположение узлов на основе соединений\n * @param nodes - массив узлов для расположения\n * @param connections - массив соединений между узлами\n * @param options - опции компоновки\n * @returns обновленные узлы с новыми позициями\n */\nexport function createHierarchicalLayout(\n  nodes: Node[], \n  connections: Connection[], \n  options: Partial<HierarchicalLayoutOptions> = {}\n): Node[] {\n  console.log('🔄 Hierarchical layout called with', nodes.length, 'nodes, nodeSizes:', !!options.nodeSizes);\n  const opts = { ...DEFAULT_OPTIONS, ...options };\n  \n  if (nodes.length === 0) return nodes;\n\n  // Создаем копию узлов для обработки\n  const layoutNodes: LayoutNode[] = nodes.map(node => ({ \n    ...node, \n    level: 0, \n    children: [], \n    visited: false \n  }));\n\n  // Находим стартовый узел (обычно с типом 'start' или без входящих соединений)\n  const startNode = findStartNode(layoutNodes, connections);\n  if (!startNode) {\n    // Если стартовый узел не найден, берем первый\n    return arrangeNodesLinear(layoutNodes, opts);\n  }\n\n  // Строим дерево зависимостей\n  buildDependencyTree(layoutNodes, connections, startNode);\n  \n  // Вычисляем уровни для каждого узла\n  assignLevels(startNode);\n\n  // Группируем узлы по уровням\n  const levels = groupNodesByLevel(layoutNodes);\n  \n  // Располагаем узлы по уровням\n  return arrangeNodesByLevel(levels, opts);\n}\n\n/**\n * Находит стартовый узел (узел типа 'start' или узел без входящих соединений)\n */\nfunction findStartNode(nodes: LayoutNode[], connections: Connection[]): LayoutNode | null {\n  // Сначала ищем узел типа 'start'\n  const startNode = nodes.find(node => node.type === 'start');\n  if (startNode) return startNode;\n\n  // Если нет узла 'start', ищем узел без входящих соединений\n  const nodeIds = nodes.map(n => n.id);\n  const targetIds = new Set(connections.map(c => c.target));\n  \n  const rootNodes = nodes.filter(node => !targetIds.has(node.id));\n  return rootNodes.length > 0 ? rootNodes[0] : nodes[0];\n}\n\n/**\n * Строит дерево зависимостей на основе соединений\n */\nfunction buildDependencyTree(nodes: LayoutNode[], connections: Connection[], startNode: LayoutNode) {\n  const nodeMap = new Map(nodes.map(node => [node.id, node]));\n  \n  // Создаем граф соединений\n  const graph = new Map<string, string[]>();\n  connections.forEach(connection => {\n    if (!graph.has(connection.source)) {\n      graph.set(connection.source, []);\n    }\n    graph.get(connection.source)!.push(connection.target);\n  });\n\n  // Рекурсивно строим дерево\n  function buildTree(node: LayoutNode, visited = new Set<string>()) {\n    if (visited.has(node.id)) return; // Избегаем циклов\n    visited.add(node.id);\n    \n    const children = graph.get(node.id) || [];\n    node.children = children\n      .map(childId => nodeMap.get(childId))\n      .filter(Boolean) as LayoutNode[];\n    \n    node.children.forEach(child => buildTree(child, visited));\n  }\n\n  buildTree(startNode);\n}\n\n/**\n * Присваивает уровни узлам в дереве\n */\nfunction assignLevels(startNode: LayoutNode, level = 0) {\n  startNode.level = level;\n  startNode.visited = true;\n  \n  if (startNode.children) {\n    startNode.children.forEach(child => {\n      if (!child.visited) {\n        assignLevels(child, level + 1);\n      }\n    });\n  }\n}\n\n/**\n * Группирует узлы по уровням\n */\nfunction groupNodesByLevel(nodes: LayoutNode[]): LayoutNode[][] {\n  const levels: LayoutNode[][] = [];\n  \n  nodes.forEach(node => {\n    const level = node.level || 0;\n    if (!levels[level]) {\n      levels[level] = [];\n    }\n    levels[level].push(node);\n  });\n  \n  return levels;\n}\n\n/**\n * Исправляет коллизии узлов на одном уровне\n */\nfunction fixCollisions(nodes: Node[], options: HierarchicalLayoutOptions): Node[] {\n  // Группируем узлы по уровням (приблизительно по X координатам)\n  const levelGroups = new Map<number, Node[]>();\n  const levelWidth = options.nodeWidth + options.horizontalSpacing;\n  \n  nodes.forEach(node => {\n    // Округляем X координату до ближайшего уровня\n    const level = Math.round((node.position.x - options.startX) / levelWidth);\n    if (!levelGroups.has(level)) {\n      levelGroups.set(level, []);\n    }\n    levelGroups.get(level)!.push(node);\n  });\n  \n  // Для каждого уровня проверяем коллизии и корректируем позиции\n  levelGroups.forEach((levelNodes) => {\n    // Сортируем узлы по Y координате\n    levelNodes.sort((a, b) => a.position.y - b.position.y);\n    \n    // Проверяем и исправляем перекрытия\n    for (let i = 1; i < levelNodes.length; i++) {\n      const currentNode = levelNodes[i];\n      const prevNode = levelNodes[i - 1];\n      \n      const currentSize = getNodeSize(currentNode.id, options);\n      const prevSize = getNodeSize(prevNode.id, options);\n      \n      const prevBottom = prevNode.position.y + prevSize.height;\n      const currentTop = currentNode.position.y;\n      \n      // Если есть перекрытие или недостаточное расстояние\n      const minSpacing = options.verticalSpacing;\n      if (currentTop < prevBottom + minSpacing) {\n        // Сдвигаем текущий узел вниз\n        currentNode.position.y = prevBottom + minSpacing;\n      }\n    }\n  });\n  \n  return nodes;\n}\n\n/**\n * Располагает узлы в правильной вертикальной древовидной иерархии\n */\nfunction arrangeNodesByLevel(levels: LayoutNode[][], options: HierarchicalLayoutOptions): Node[] {\n  const result: Node[] = [];\n  \n  // Создаем карту узлов для быстрого доступа\n  const nodeMap = new Map<string, LayoutNode>();\n  levels.flat().forEach(node => nodeMap.set(node.id, node));\n  \n  // Вычисляем размер поддерева (количество листьев) для каждого узла\n  function computeLeafCount(node: LayoutNode): number {\n    if (!node.children || node.children.length === 0) {\n      return 1;\n    }\n    return node.children.reduce((sum, child) => sum + computeLeafCount(child), 0);\n  }\n  \n  // Назначаем y позиции с учетом размеров поддеревьев\n  function assignYPositions(node: LayoutNode, startY: number, visited = new Set<string>()): number {\n    // Проверяем на циклы - если узел уже посещен, возвращаем текущую позицию\n    if (visited.has(node.id)) {\n      return startY;\n    }\n    \n    visited.add(node.id);\n    const nodeSize = getNodeSize(node.id, options);\n    \n    if (!node.children || node.children.length === 0) {\n      // Листовой узел - присваиваем текущую позицию\n      (node as any)._y = startY;\n      visited.delete(node.id); // Убираем из visited после обработки\n      return startY + nodeSize.height + options.verticalSpacing;\n    }\n    \n    // Сначала назначаем позиции детям\n    let childY = startY;\n    const childCenters: number[] = [];\n    \n    for (const child of node.children) {\n      // Передаем копию visited сета для каждого дочернего узла\n      const childVisited = new Set(visited);\n      childY = assignYPositions(child, childY, childVisited);\n      const childSize = getNodeSize(child.id, options);\n      const childCenterY = (child as any)._y + childSize.height / 2;\n      childCenters.push(childCenterY);\n    }\n    \n    // Центрируем родительский узел относительно центров дочерних узлов\n    if (childCenters.length > 0) {\n      const avgChildCenterY = childCenters.reduce((sum, y) => sum + y, 0) / childCenters.length;\n      const parentSize = getNodeSize(node.id, options);\n      (node as any)._y = avgChildCenterY - parentSize.height / 2;\n    } else {\n      // Если нет дочерних узлов, используем стартовую позицию\n      (node as any)._y = startY;\n    }\n    \n    visited.delete(node.id); // Убираем из visited после обработки\n    return childY;\n  }\n  \n  // Находим корневые узлы (уровень 0)\n  const rootNodes = levels[0] || [];\n  let currentY = options.startY;\n  \n  // Назначаем позиции для каждого корневого узла\n  rootNodes.forEach(rootNode => {\n    currentY = assignYPositions(rootNode, currentY);\n    currentY += options.verticalSpacing; // Полный отступ между корневыми деревьями\n  });\n  \n  // Создаем результат с правильными позициями\n  levels.forEach((levelNodes, levelIndex) => {\n    // Вычисляем X позицию с учетом максимальной ширины узлов на предыдущих уровнях\n    let x = options.startX;\n    for (let i = 0; i < levelIndex; i++) {\n      const prevLevel = levels[i] || [];\n      const prevLevelMaxWidth = prevLevel.length > 0 \n        ? Math.max(...prevLevel.map(n => getNodeSize(n.id, options).width))\n        : 0; // Исправляем проблему с пустыми уровнями\n      x += prevLevelMaxWidth + options.horizontalSpacing;\n    }\n    \n    levelNodes.forEach((node) => {\n      const y = (node as any)._y || (options.startY + result.length * options.verticalSpacing);\n      \n      // Убираем циклические свойства перед добавлением в результат\n      const { children, visited, level, ...cleanNode } = node;\n      result.push({\n        ...cleanNode,\n        position: { x, y }\n      });\n    });\n  });\n  \n  // Проверка коллизий на одном уровне и корректировка позиций\n  const resultWithCollisionFix = fixCollisions(result, options);\n  \n  return resultWithCollisionFix;\n}\n\n/**\n * Линейное расположение узлов (fallback)\n */\nfunction arrangeNodesLinear(nodes: LayoutNode[], options: HierarchicalLayoutOptions): Node[] {\n  return nodes.map((node, index) => {\n    // Убираем циклические свойства перед возвратом\n    const { children, visited, level, ...cleanNode } = node;\n    return {\n      ...cleanNode,\n      position: {\n        x: options.startX + (index % 3) * (options.nodeWidth + options.horizontalSpacing),\n        y: options.startY + Math.floor(index / 3) * options.verticalSpacing\n      }\n    };\n  });\n}\n\n/**\n * Функция для специального расположения шаблона VProgulke\n */\nexport function createVProgulkeHierarchicalLayout(nodes: Node[], connections: Connection[]): Node[] {\n  // Определяем последовательность узлов для VProgulke бота\n  const nodeSequence = [\n    'start',\n    'join_request', \n    'decline_response',\n    'gender_selection',\n    'name_input',\n    'age_input', \n    'metro_selection',\n    'interests_categories',\n    'hobby_interests',\n    'relationship_status',\n    'sexual_orientation',\n    'telegram_channel_ask',\n    'telegram_channel_input',\n    'additional_info',\n    'profile_complete',\n    'chat_link',\n    'show_profile'\n  ];\n\n  // Создаем карту узлов для быстрого доступа\n  const nodeMap = new Map(nodes.map(node => [node.id, node]));\n  \n  // Специальные позиции для узлов VProgulke\n  const specialPositions: Record<string, {x: number, y: number}> = {\n    // Уровень 1: Старт\n    'start': { x: 100, y: 50 },\n    \n    // Уровень 2: Выбор участия\n    'join_request': { x: 100, y: 250 },\n    'decline_response': { x: 450, y: 250 },\n    \n    // Уровень 3: Основные данные\n    'gender_selection': { x: 100, y: 450 },\n    'name_input': { x: 450, y: 450 },\n    'age_input': { x: 800, y: 450 },\n    \n    // Уровень 4: Локация и интересы\n    'metro_selection': { x: 100, y: 650 },\n    'interests_categories': { x: 450, y: 650 },\n    'hobby_interests': { x: 800, y: 650 },\n    \n    // Уровень 5: Дополнительная информация\n    'relationship_status': { x: 100, y: 850 },\n    'sexual_orientation': { x: 450, y: 850 },\n    'telegram_channel_ask': { x: 800, y: 850 },\n    \n    // Уровень 6: Дополнительные данные\n    'telegram_channel_input': { x: 100, y: 1050 },\n    'additional_info': { x: 450, y: 1050 },\n    \n    // Уровень 7: Завершение\n    'profile_complete': { x: 100, y: 1250 },\n    'chat_link': { x: 450, y: 1250 },\n    'show_profile': { x: 800, y: 1250 }\n  };\n\n  // Применяем позиции к узлам\n  const layoutNodes = nodes.map(node => {\n    const position = specialPositions[node.id] || { \n      x: Math.random() * 800 + 100, \n      y: Math.random() * 600 + 100 \n    };\n    \n    return {\n      ...node,\n      position\n    };\n  });\n\n  return layoutNodes;\n}\n\n/**\n * Автоматически определяет тип шаблона и применяет соответствующую компоновку\n */\nexport function applyTemplateLayout(\n  nodes: Node[], \n  connections: Connection[], \n  templateName?: string, \n  nodeSizes?: Map<string, { width: number; height: number }>\n): Node[] {\n  console.log('🎯 ApplyTemplateLayout called:', templateName, 'nodes:', nodes.length, 'nodeSizes:', !!nodeSizes);\n  \n  // Проверяем, это шаблон VProgulke\n  if (templateName?.toLowerCase().includes('vprogulke') || templateName?.toLowerCase().includes('знакомства')) {\n    console.log('🌟 Using VProgulke layout');\n    return createVProgulkeHierarchicalLayout(nodes, connections);\n  }\n  \n  // Определяем, мобильное ли это устройство\n  const isMobile = getIsMobile();\n  \n  // Для остальных шаблонов используем стандартную иерархическую компоновку\n  console.log(isMobile ? '📱 Using mobile-optimized hierarchical layout' : '📏 Using desktop hierarchical layout with real sizes');\n  \n  // Параметры для мобильных устройств - более компактные\n  const mobileOptions = {\n    levelHeight: 120,\n    nodeWidth: 280,\n    nodeHeight: 100,\n    horizontalSpacing: 60, // Значительно уменьшено для мобильных экранов\n    verticalSpacing: 50, // Значительно уменьшено для мобильных экранов\n    startX: 50,\n    startY: 50,\n    nodeSizes\n  };\n  \n  // Параметры для десктопных устройств\n  const desktopOptions = {\n    levelHeight: 150,\n    nodeWidth: 320,\n    nodeHeight: 120,\n    horizontalSpacing: 100,\n    verticalSpacing: 80,\n    startX: 100,\n    startY: 100,\n    nodeSizes\n  };\n  \n  return createHierarchicalLayout(nodes, connections, isMobile ? mobileOptions : desktopOptions);\n}","size_bytes":17150},"client/src/components/editor/token-manager.tsx":{"content":"import React, { useState } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '@/components/ui/dropdown-menu';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Switch } from '@/components/ui/switch';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport { Plus, MoreVertical, Star, StarOff, Edit, Trash2, Copy, Eye, EyeOff } from 'lucide-react';\n\ninterface BotToken {\n  id: number;\n  projectId: number;\n  name: string;\n  token: string; // Partially hidden\n  isDefault: number;\n  isActive: number;\n  description?: string;\n  lastUsedAt?: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface TokenManagerProps {\n  projectId: number;\n  onTokenSelect?: (tokenId: number) => void;\n  selectedTokenId?: number | null;\n}\n\nexport function TokenManager({ projectId, onTokenSelect, selectedTokenId }: TokenManagerProps) {\n  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [editingToken, setEditingToken] = useState<BotToken | null>(null);\n  const [newTokenData, setNewTokenData] = useState({\n    name: '',\n    token: '',\n    description: '',\n    isDefault: false\n  });\n  const [showTokenValues, setShowTokenValues] = useState<Record<number, boolean>>({});\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Получаем все токены проекта\n  const { data: tokens = [], isLoading } = useQuery<BotToken[]>({\n    queryKey: [`/api/projects/${projectId}/tokens`],\n  });\n\n  // Создание токена\n  const createTokenMutation = useMutation({\n    mutationFn: async (tokenData: typeof newTokenData) => {\n      return apiRequest('POST', `/api/projects/${projectId}/tokens`, {\n        ...tokenData,\n        isDefault: tokenData.isDefault ? 1 : 0\n      });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Токен создан\",\n        description: \"Новый токен успешно добавлен.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/tokens`] });\n      setIsAddDialogOpen(false);\n      setNewTokenData({ name: '', token: '', description: '', isDefault: false });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка создания\",\n        description: error.message || \"Не удалось создать токен.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Обновление токена\n  const updateTokenMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: Partial<BotToken> }) => {\n      return apiRequest('PUT', `/api/tokens/${id}`, data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Токен обновлен\",\n        description: \"Токен успешно обновлен.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/tokens`] });\n      setIsEditDialogOpen(false);\n      setEditingToken(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка обновления\",\n        description: error.message || \"Не удалось обновить токен.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Удаление токена\n  const deleteTokenMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest('DELETE', `/api/tokens/${id}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Токен удален\",\n        description: \"Токен успешно удален.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/tokens`] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка удаления\",\n        description: error.message || \"Не удалось удалить токен.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Установка токена по умолчанию\n  const setDefaultMutation = useMutation({\n    mutationFn: async (tokenId: number) => {\n      return apiRequest('POST', `/api/projects/${projectId}/tokens/${tokenId}/set-default`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Токен по умолчанию\",\n        description: \"Токен установлен по умолчанию.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/tokens`] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка\",\n        description: error.message || \"Не удалось установить токен по умолчанию.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCreateToken = () => {\n    createTokenMutation.mutate(newTokenData);\n  };\n\n  const handleEditToken = (token: BotToken) => {\n    setEditingToken(token);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdateToken = () => {\n    if (!editingToken) return;\n    \n    updateTokenMutation.mutate({\n      id: editingToken.id,\n      data: {\n        name: editingToken.name,\n        description: editingToken.description,\n        isActive: editingToken.isActive\n      }\n    });\n  };\n\n  const handleDeleteToken = (id: number) => {\n    if (window.confirm('Вы уверены, что хотите удалить этот токен?')) {\n      deleteTokenMutation.mutate(id);\n    }\n  };\n\n  const handleSetDefault = (tokenId: number) => {\n    setDefaultMutation.mutate(tokenId);\n  };\n\n  const toggleTokenVisibility = (tokenId: number) => {\n    setShowTokenValues(prev => ({\n      ...prev,\n      [tokenId]: !prev[tokenId]\n    }));\n  };\n\n  const copyToClipboard = (text: string) => {\n    navigator.clipboard.writeText(text);\n    toast({\n      title: \"Скопировано\",\n      description: \"Токен скопирован в буфер обмена.\",\n    });\n  };\n\n  if (isLoading) {\n    return <div className=\"p-4\">Загрузка токенов...</div>;\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h3 className=\"text-lg font-semibold\">Управление токенами</h3>\n          <p className=\"text-sm text-muted-foreground\">\n            Управляйте токенами Telegram ботов для этого проекта\n          </p>\n        </div>\n        \n        <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>\n          <DialogTrigger asChild>\n            <Button>\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Добавить токен\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Добавить новый токен</DialogTitle>\n              <DialogDescription>\n                Добавьте новый токен бота от @BotFather\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"token-name\">Название токена</Label>\n                <Input\n                  id=\"token-name\"\n                  placeholder=\"Например: Основной бот\"\n                  value={newTokenData.name}\n                  onChange={(e) => setNewTokenData({ ...newTokenData, name: e.target.value })}\n                />\n              </div>\n              \n              <div>\n                <Label htmlFor=\"token-value\">Токен бота</Label>\n                <Input\n                  id=\"token-value\"\n                  type=\"password\"\n                  placeholder=\"Введите токен от @BotFather\"\n                  value={newTokenData.token}\n                  onChange={(e) => setNewTokenData({ ...newTokenData, token: e.target.value })}\n                />\n              </div>\n              \n              <div>\n                <Label htmlFor=\"token-description\">Описание (опционально)</Label>\n                <Textarea\n                  id=\"token-description\"\n                  placeholder=\"Описание назначения токена\"\n                  value={newTokenData.description}\n                  onChange={(e) => setNewTokenData({ ...newTokenData, description: e.target.value })}\n                />\n              </div>\n              \n              <div className=\"flex items-center space-x-2\">\n                <Switch\n                  id=\"is-default\"\n                  checked={newTokenData.isDefault}\n                  onCheckedChange={(checked) => setNewTokenData({ ...newTokenData, isDefault: checked })}\n                />\n                <Label htmlFor=\"is-default\">Использовать по умолчанию</Label>\n              </div>\n            </div>\n            \n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsAddDialogOpen(false)}>\n                Отмена\n              </Button>\n              <Button \n                onClick={handleCreateToken}\n                disabled={!newTokenData.name || !newTokenData.token || createTokenMutation.isPending}\n              >\n                {createTokenMutation.isPending ? 'Создание...' : 'Создать токен'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {tokens.length === 0 ? (\n        <Card>\n          <CardContent className=\"p-6 text-center\">\n            <p className=\"text-muted-foreground\">Токены не найдены</p>\n            <p className=\"text-sm text-muted-foreground mt-1\">\n              Добавьте токен для запуска бота\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-3\">\n          {tokens.map((token) => (\n            <Card \n              key={token.id} \n              className={`cursor-pointer transition-colors ${\n                selectedTokenId === token.id \n                  ? 'ring-2 ring-primary bg-primary/5' \n                  : 'hover:bg-accent/50'\n              }`}\n              onClick={() => onTokenSelect?.(token.id)}\n            >\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <h4 className=\"font-medium\">{token.name}</h4>\n                      {token.isDefault === 1 && (\n                        <Badge variant=\"default\">\n                          <Star className=\"w-3 h-3 mr-1\" />\n                          По умолчанию\n                        </Badge>\n                      )}\n                      {token.isActive === 0 && (\n                        <Badge variant=\"secondary\">Неактивен</Badge>\n                      )}\n                    </div>\n                    \n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <span className=\"font-mono\">\n                        {showTokenValues[token.id] ? '••••••••••' : token.token}\n                      </span>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          toggleTokenVisibility(token.id);\n                        }}\n                      >\n                        {showTokenValues[token.id] ? (\n                          <EyeOff className=\"w-3 h-3\" />\n                        ) : (\n                          <Eye className=\"w-3 h-3\" />\n                        )}\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          copyToClipboard(token.token);\n                        }}\n                      >\n                        <Copy className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                    \n                    {token.description && (\n                      <p className=\"text-sm text-muted-foreground mt-1\">\n                        {token.description}\n                      </p>\n                    )}\n                    \n                    {token.lastUsedAt && (\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Последнее использование: {new Date(token.lastUsedAt).toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })}\n                      </p>\n                    )}\n                  </div>\n                  \n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"ghost\" size=\"sm\" onClick={(e) => e.stopPropagation()}>\n                        <MoreVertical className=\"w-4 h-4\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem onClick={() => handleEditToken(token)}>\n                        <Edit className=\"w-4 h-4 mr-2\" />\n                        Редактировать\n                      </DropdownMenuItem>\n                      \n                      {token.isDefault !== 1 && (\n                        <DropdownMenuItem onClick={() => handleSetDefault(token.id)}>\n                          <Star className=\"w-4 h-4 mr-2\" />\n                          Сделать по умолчанию\n                        </DropdownMenuItem>\n                      )}\n                      \n                      <DropdownMenuItem \n                        onClick={() => handleDeleteToken(token.id)}\n                        className=\"text-destructive\"\n                      >\n                        <Trash2 className=\"w-4 h-4 mr-2\" />\n                        Удалить\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      {/* Edit Token Dialog */}\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Редактировать токен</DialogTitle>\n            <DialogDescription>\n              Измените настройки токена\n            </DialogDescription>\n          </DialogHeader>\n          \n          {editingToken && (\n            <div className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"edit-token-name\">Название токена</Label>\n                <Input\n                  id=\"edit-token-name\"\n                  value={editingToken.name}\n                  onChange={(e) => setEditingToken({ ...editingToken, name: e.target.value })}\n                />\n              </div>\n              \n              <div>\n                <Label htmlFor=\"edit-token-description\">Описание</Label>\n                <Textarea\n                  id=\"edit-token-description\"\n                  value={editingToken.description || ''}\n                  onChange={(e) => setEditingToken({ ...editingToken, description: e.target.value })}\n                />\n              </div>\n              \n              <div className=\"flex items-center space-x-2\">\n                <Switch\n                  id=\"edit-is-active\"\n                  checked={editingToken.isActive === 1}\n                  onCheckedChange={(checked) => setEditingToken({ \n                    ...editingToken, \n                    isActive: checked ? 1 : 0 \n                  })}\n                />\n                <Label htmlFor=\"edit-is-active\">Активный токен</Label>\n              </div>\n            </div>\n          )}\n          \n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsEditDialogOpen(false)}>\n              Отмена\n            </Button>\n            <Button \n              onClick={handleUpdateToken}\n              disabled={updateTokenMutation.isPending}\n            >\n              {updateTokenMutation.isPending ? 'Сохранение...' : 'Сохранить'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","size_bytes":17091},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/editor/connection-visualization.tsx":{"content":"import React, { useState, useCallback, useMemo } from 'react';\nimport { Node, Connection, Button } from '@/types/bot';\nimport { Badge } from '@/components/ui/badge';\nimport { Button as UIButton } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\nimport { \n  ArrowRight, \n  Link, \n  AlertTriangle, \n  CheckCircle, \n  XCircle, \n  Zap,\n  Eye,\n  Edit3,\n  Trash2,\n  MousePointer,\n  Network,\n  Target\n} from 'lucide-react';\nimport { cn } from '@/lib/utils';\n\ninterface ConnectionVisualizationProps {\n  nodes: Node[];\n  connections: Connection[];\n  onConnectionSelect?: (connection: Connection) => void;\n  onConnectionDelete?: (connectionId: string) => void;\n  onConnectionEdit?: (connection: Connection) => void;\n  selectedConnectionId?: string;\n  showLabels?: boolean;\n  showMetrics?: boolean;\n  interactive?: boolean;\n}\n\ninterface ConnectionMetrics {\n  id: string;\n  strength: number;\n  usage: number;\n  importance: number;\n  hasButton: boolean;\n  buttonType?: 'goto' | 'command' | 'url';\n  isValid: boolean;\n  errors: string[];\n  suggestions: string[];\n}\n\nexport function ConnectionVisualization({\n  nodes,\n  connections,\n  onConnectionSelect,\n  onConnectionDelete,\n  onConnectionEdit,\n  selectedConnectionId,\n  showLabels = true,\n  showMetrics = true,\n  interactive = true\n}: ConnectionVisualizationProps) {\n  const [hoveredConnectionId, setHoveredConnectionId] = useState<string | null>(null);\n  const [viewMode, setViewMode] = useState<'all' | 'strong' | 'weak' | 'problematic'>('all');\n\n  // Расчет метрик для каждой связи\n  const connectionMetrics = useMemo(() => {\n    return connections.map(connection => {\n      const sourceNode = nodes.find(n => n.id === connection.source);\n      const targetNode = nodes.find(n => n.id === connection.target);\n      \n      if (!sourceNode || !targetNode) {\n        return {\n          id: connection.id,\n          strength: 0,\n          usage: 0,\n          importance: 0,\n          hasButton: false,\n          isValid: false,\n          errors: ['Отсутствует исходный или целевой узел'],\n          suggestions: ['Удалить неработающую связь']\n        } as ConnectionMetrics;\n      }\n\n      // Проверка наличия кнопки\n      const relatedButton = sourceNode.data.buttons?.find(b => \n        b.action === 'goto' && b.target === connection.target\n      );\n\n      // Расчет силы связи\n      let strength = 0.5;\n      if (relatedButton) strength += 0.3;\n      if (sourceNode.type === 'start') strength += 0.2;\n      if (targetNode.type === 'message') strength += 0.1;\n\n      // Расчет важности\n      let importance = 0.5;\n      if (sourceNode.type === 'start') importance += 0.3;\n      if (relatedButton) importance += 0.2;\n      const connectionsFromSource = connections.filter(c => c.source === connection.source).length;\n      importance += Math.min(0.2, connectionsFromSource * 0.05);\n\n      // Проверка валидности\n      const errors: string[] = [];\n      const suggestions: string[] = [];\n\n      if (!relatedButton && ['message', 'photo', 'keyboard'].includes(sourceNode.type)) {\n        errors.push('Отсутствует кнопка для перехода');\n        suggestions.push('Добавить кнопку перехода');\n      }\n\n      if (connectionsFromSource > 10) {\n        errors.push('Слишком много связей от одного узла');\n        suggestions.push('Разбить на несколько узлов');\n      }\n\n      const isValid = errors.length === 0;\n\n      return {\n        id: connection.id,\n        strength,\n        usage: Math.random() * 100, // В реальной системе это будет аналитика\n        importance,\n        hasButton: !!relatedButton,\n        buttonType: relatedButton?.action,\n        isValid,\n        errors,\n        suggestions\n      } as ConnectionMetrics;\n    });\n  }, [connections, nodes]);\n\n  // Фильтрация по режиму просмотра\n  const filteredConnections = useMemo(() => {\n    const filtered = connectionMetrics.filter(metrics => {\n      switch (viewMode) {\n        case 'strong':\n          return metrics.strength >= 0.7;\n        case 'weak':\n          return metrics.strength < 0.5;\n        case 'problematic':\n          return !metrics.isValid;\n        default:\n          return true;\n      }\n    });\n\n    return filtered.map(metrics => ({\n      connection: connections.find(c => c.id === metrics.id)!,\n      metrics\n    }));\n  }, [connectionMetrics, connections, viewMode]);\n\n  // Получение цвета связи\n  const getConnectionColor = useCallback((metrics: ConnectionMetrics) => {\n    if (!metrics.isValid) return 'rgb(239, 68, 68)'; // red-500\n    if (metrics.strength >= 0.8) return 'rgb(34, 197, 94)'; // green-500\n    if (metrics.strength >= 0.6) return 'rgb(59, 130, 246)'; // blue-500\n    if (metrics.strength >= 0.4) return 'rgb(245, 158, 11)'; // yellow-500\n    return 'rgb(156, 163, 175)'; // gray-400\n  }, []);\n\n  // Получение толщины линии\n  const getConnectionWidth = useCallback((metrics: ConnectionMetrics) => {\n    return Math.max(1, Math.floor(metrics.strength * 5));\n  }, []);\n\n  // Получение названия узла\n  const getNodeName = useCallback((nodeId: string) => {\n    const node = nodes.find(n => n.id === nodeId);\n    if (!node) return 'Неизвестный узел';\n    \n    const typeNames = {\n      start: 'Старт',\n      command: node.data.command || 'Команда',\n      message: 'Сообщение',\n      keyboard: 'Клавиатура',\n      photo: 'Фото',\n      video: 'Видео',\n      audio: 'Аудио',\n      document: 'Документ',\n      condition: 'Условие',\n      input: 'Ввод',\n      'user-input': 'Пользовательский ввод',\n      sticker: 'Стикер',\n      voice: 'Голосовое',\n      animation: 'Анимация',\n      location: 'Геолокация',\n      contact: 'Контакт',\n      poll: 'Опрос',\n      dice: 'Кубик'\n    };\n    \n    return typeNames[node.type] || node.type;\n  }, [nodes]);\n\n  // Получение иконки типа связи\n  const getConnectionIcon = useCallback((metrics: ConnectionMetrics) => {\n    if (!metrics.hasButton) return <ArrowRight className=\"h-4 w-4\" />;\n    \n    switch (metrics.buttonType) {\n      case 'command':\n        return <Zap className=\"h-4 w-4\" />;\n      case 'url':\n        return <Link className=\"h-4 w-4\" />;\n      default:\n        return <MousePointer className=\"h-4 w-4\" />;\n    }\n  }, []);\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Панель управления */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Network className=\"h-5 w-5\" />\n            Визуализация связей\n          </CardTitle>\n          <CardDescription>\n            Анализ и управление связями между узлами бота\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {/* Фильтры */}\n          <div className=\"flex gap-2 mb-4\">\n            <UIButton\n              variant={viewMode === 'all' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setViewMode('all')}\n            >\n              Все связи\n            </UIButton>\n            <UIButton\n              variant={viewMode === 'strong' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setViewMode('strong')}\n            >\n              Сильные\n            </UIButton>\n            <UIButton\n              variant={viewMode === 'weak' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setViewMode('weak')}\n            >\n              Слабые\n            </UIButton>\n            <UIButton\n              variant={viewMode === 'problematic' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setViewMode('problematic')}\n            >\n              Проблемные\n            </UIButton>\n          </div>\n\n          {/* Легенда */}\n          <div className=\"flex flex-wrap gap-4 mb-4 p-3 bg-muted/50 rounded-lg\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-1 bg-green-500 rounded\"></div>\n              <span className=\"text-sm\">Сильная связь</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-1 bg-blue-500 rounded\"></div>\n              <span className=\"text-sm\">Средняя связь</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-1 bg-yellow-500 rounded\"></div>\n              <span className=\"text-sm\">Слабая связь</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-1 bg-red-500 rounded\"></div>\n              <span className=\"text-sm\">Проблемная связь</span>\n            </div>\n          </div>\n\n          {/* Метрики */}\n          {showMetrics && (\n            <div className=\"grid grid-cols-4 gap-4 mb-4\">\n              <div className=\"text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n                <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\n                  {filteredConnections.length}\n                </div>\n                <div className=\"text-sm text-muted-foreground\">Показано связей</div>\n              </div>\n              <div className=\"text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg\">\n                <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                  {filteredConnections.filter(({ metrics }) => metrics.isValid).length}\n                </div>\n                <div className=\"text-sm text-muted-foreground\">Валидных</div>\n              </div>\n              <div className=\"text-center p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg\">\n                <div className=\"text-2xl font-bold text-yellow-600 dark:text-yellow-400\">\n                  {filteredConnections.filter(({ metrics }) => metrics.hasButton).length}\n                </div>\n                <div className=\"text-sm text-muted-foreground\">С кнопками</div>\n              </div>\n              <div className=\"text-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg\">\n                <div className=\"text-2xl font-bold text-purple-600 dark:text-purple-400\">\n                  {Math.round(filteredConnections.reduce((sum, { metrics }) => sum + metrics.strength, 0) / filteredConnections.length * 100) || 0}%\n                </div>\n                <div className=\"text-sm text-muted-foreground\">Средняя сила</div>\n              </div>\n            </div>\n          )}\n\n          {/* Список связей */}\n          <div className=\"space-y-2 max-h-96 overflow-y-auto\">\n            <TooltipProvider>\n              {filteredConnections.map(({ connection, metrics }) => (\n                <Tooltip key={connection.id}>\n                  <TooltipTrigger asChild>\n                    <div\n                      className={cn(\n                        \"p-3 border rounded-lg transition-all duration-200\",\n                        interactive && \"cursor-pointer hover:bg-accent\",\n                        selectedConnectionId === connection.id && \"bg-accent border-primary\",\n                        hoveredConnectionId === connection.id && \"shadow-md\",\n                        !metrics.isValid && \"border-red-200 bg-red-50 dark:bg-red-900/10\"\n                      )}\n                      onClick={() => interactive && onConnectionSelect?.(connection)}\n                      onMouseEnter={() => setHoveredConnectionId(connection.id)}\n                      onMouseLeave={() => setHoveredConnectionId(null)}\n                    >\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-3\">\n                          {/* Иконка типа связи */}\n                          <div className=\"flex items-center justify-center w-8 h-8 rounded-full bg-muted\">\n                            {getConnectionIcon(metrics)}\n                          </div>\n                          \n                          {/* Информация о связи */}\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <span className=\"font-medium text-sm\">\n                                {getNodeName(connection.source)} → {getNodeName(connection.target)}\n                              </span>\n                              \n                              {/* Индикатор валидности */}\n                              {metrics.isValid ? (\n                                <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                              ) : (\n                                <XCircle className=\"h-4 w-4 text-red-500\" />\n                              )}\n                            </div>\n                            \n                            {/* Прогресс-бар силы связи */}\n                            <div className=\"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2\">\n                              <div\n                                className=\"h-2 rounded-full transition-all duration-300\"\n                                style={{\n                                  width: `${metrics.strength * 100}%`,\n                                  backgroundColor: getConnectionColor(metrics)\n                                }}\n                              />\n                            </div>\n                            \n                            {/* Метрики */}\n                            <div className=\"flex gap-2 mt-1\">\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                Сила: {Math.round(metrics.strength * 100)}%\n                              </Badge>\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                Важность: {Math.round(metrics.importance * 100)}%\n                              </Badge>\n                              {metrics.hasButton && (\n                                <Badge variant=\"secondary\" className=\"text-xs\">\n                                  {metrics.buttonType === 'goto' ? 'Переход' : \n                                   metrics.buttonType === 'command' ? 'Команда' : 'Ссылка'}\n                                </Badge>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n                        \n                        {/* Действия */}\n                        {interactive && (\n                          <div className=\"flex gap-1\">\n                            <UIButton\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                onConnectionEdit?.(connection);\n                              }}\n                            >\n                              <Edit3 className=\"h-4 w-4\" />\n                            </UIButton>\n                            <UIButton\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                onConnectionDelete?.(connection.id);\n                              }}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                            </UIButton>\n                          </div>\n                        )}\n                      </div>\n                      \n                      {/* Ошибки и предложения */}\n                      {(!metrics.isValid && metrics.errors.length > 0) && (\n                        <div className=\"mt-2 space-y-1\">\n                          {metrics.errors.map((error, idx) => (\n                            <div key={idx} className=\"flex items-center gap-2 text-xs text-red-600\">\n                              <AlertTriangle className=\"h-3 w-3\" />\n                              {error}\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                      \n                      {metrics.suggestions.length > 0 && (\n                        <div className=\"mt-2 flex flex-wrap gap-1\">\n                          {metrics.suggestions.map((suggestion, idx) => (\n                            <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n                              💡 {suggestion}\n                            </Badge>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <div className=\"space-y-1\">\n                      <p className=\"font-medium\">Связь {connection.id}</p>\n                      <p className=\"text-sm\">Сила: {Math.round(metrics.strength * 100)}%</p>\n                      <p className=\"text-sm\">Важность: {Math.round(metrics.importance * 100)}%</p>\n                      {metrics.hasButton && (\n                        <p className=\"text-sm\">Тип кнопки: {metrics.buttonType}</p>\n                      )}\n                    </div>\n                  </TooltipContent>\n                </Tooltip>\n              ))}\n            </TooltipProvider>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":18208},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input dark:border-border/50 dark:data-[state=unchecked]:bg-muted/30\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-all duration-200 data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0 dark:border dark:border-border/60 dark:shadow-xl dark:data-[state=checked]:bg-primary-foreground dark:data-[state=unchecked]:bg-background\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1357},"client/src/components/editor/quick-format-toolbar.tsx":{"content":"import { Button } from '@/components/ui/button';\nimport { Separator } from '@/components/ui/separator';\nimport { Badge } from '@/components/ui/badge';\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';\nimport { \n  Bold, \n  Italic, \n  Underline, \n  Strikethrough, \n  Code, \n  Link, \n  List,\n  ListOrdered,\n  Quote,\n  Smile,\n  Zap,\n  Star,\n  CheckSquare,\n  AlertTriangle,\n  Heart,\n  Phone,\n  Mail,\n  MapPin,\n  Calendar,\n  Clock,\n  Settings,\n  Sparkles,\n  Plus\n} from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface QuickFormatToolbarProps {\n  onInsert: (text: string) => void;\n  isMarkdown?: boolean;\n}\n\nexport function QuickFormatToolbar({ onInsert, isMarkdown = false }: QuickFormatToolbarProps) {\n  const { toast } = useToast();\n\n  const formatButtons = [\n    { \n      icon: Bold, \n      name: 'Жирный', \n      markdown: '**текст**', \n      html: '<b>текст</b>',\n      shortcut: 'Ctrl+B'\n    },\n    { \n      icon: Italic, \n      name: 'Курсив', \n      markdown: '_текст_', \n      html: '<i>текст</i>',\n      shortcut: 'Ctrl+I'\n    },\n    { \n      icon: Underline, \n      name: 'Подчеркнутый', \n      markdown: '__текст__', \n      html: '<u>текст</u>',\n      shortcut: 'Ctrl+U'\n    },\n    { \n      icon: Strikethrough, \n      name: 'Зачеркнутый', \n      markdown: '~текст~', \n      html: '<s>текст</s>',\n      shortcut: 'Ctrl+Shift+X'\n    },\n    { \n      icon: Code, \n      name: 'Код', \n      markdown: '`код`', \n      html: '<code>код</code>',\n      shortcut: 'Ctrl+E'\n    },\n    { \n      icon: Link, \n      name: 'Ссылка', \n      markdown: '[текст](url)', \n      html: '<a href=\"url\">текст</a>',\n      shortcut: 'Ctrl+K'\n    }\n  ];\n\n  const quickEmojis = [\n    { emoji: '👍', name: 'Лайк' },\n    { emoji: '❤️', name: 'Сердце' },\n    { emoji: '🔥', name: 'Огонь' },\n    { emoji: '⭐', name: 'Звезда' },\n    { emoji: '✅', name: 'Галочка' },\n    { emoji: '⚠️', name: 'Внимание' },\n    { emoji: '📞', name: 'Телефон' },\n    { emoji: '📧', name: 'Email' },\n    { emoji: '📍', name: 'Локация' },\n    { emoji: '⏰', name: 'Время' },\n    { emoji: '🚀', name: 'Ракета' },\n    { emoji: '💡', name: 'Идея' }\n  ];\n\n  const quickSymbols = [\n    { symbol: '•', name: 'Маркер' },\n    { symbol: '→', name: 'Стрелка' },\n    { symbol: '✓', name: 'Галочка' },\n    { symbol: '✗', name: 'Крестик' },\n    { symbol: '—', name: 'Тире' },\n    { symbol: '…', name: 'Многоточие' },\n    { symbol: '«»', name: 'Кавычки' },\n    { symbol: '№', name: 'Номер' },\n    { symbol: '©', name: 'Копирайт' },\n    { symbol: '®', name: 'Товарный знак' },\n    { symbol: '™', name: 'Торговая марка' },\n    { symbol: '§', name: 'Параграф' }\n  ];\n\n  const quickTemplates = [\n    {\n      name: 'Список',\n      icon: List,\n      template: isMarkdown ? '• Пункт 1\\n• Пункт 2\\n• Пункт 3' : '• Пункт 1<br>• Пункт 2<br>• Пункт 3'\n    },\n    {\n      name: 'Нумерованный список',\n      icon: ListOrdered,\n      template: isMarkdown ? '1. Пункт 1\\n2. Пункт 2\\n3. Пункт 3' : '1. Пункт 1<br>2. Пункт 2<br>3. Пункт 3'\n    },\n    {\n      name: 'Цитата',\n      icon: Quote,\n      template: isMarkdown ? '> Это цитата' : '<blockquote>Это цитата</blockquote>'\n    },\n    {\n      name: 'Задачи',\n      icon: CheckSquare,\n      template: '☐ Задача 1\\n☐ Задача 2\\n☑ Выполнено'\n    },\n    {\n      name: 'Предупреждение',\n      icon: AlertTriangle,\n      template: '⚠️ **Внимание!**\\nВажная информация'\n    },\n    {\n      name: 'Контакты',\n      icon: Phone,\n      template: '📞 Телефон: +7 (999) 123-45-67\\n📧 Email: example@email.com'\n    }\n  ];\n\n  const handleInsert = (text: string, name: string) => {\n    onInsert(text);\n    toast({\n      title: \"Добавлено\",\n      description: `${name} добавлен в текст`\n    });\n  };\n\n  return (\n    <div className=\"flex flex-wrap gap-2 p-3 bg-muted/30 rounded-lg border\">\n      {/* Format buttons */}\n      <div className=\"flex gap-1\">\n        {formatButtons.map((format) => (\n          <Button\n            key={format.name}\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleInsert(isMarkdown ? format.markdown : format.html, format.name)}\n            className=\"h-8 w-8 p-0\"\n            title={`${format.name} (${format.shortcut})`}\n          >\n            <format.icon className=\"w-3 h-3\" />\n          </Button>\n        ))}\n      </div>\n\n      <Separator orientation=\"vertical\" className=\"h-6\" />\n\n      {/* Quick emojis */}\n      <div className=\"flex gap-1\">\n        {quickEmojis.slice(0, 6).map((item) => (\n          <Button\n            key={item.emoji}\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleInsert(item.emoji, item.name)}\n            className=\"h-8 w-8 p-0\"\n            title={item.name}\n          >\n            {item.emoji}\n          </Button>\n        ))}\n        \n        <Popover>\n          <PopoverTrigger asChild>\n            <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\" title=\"Больше эмодзи\">\n              <Plus className=\"w-3 h-3\" />\n            </Button>\n          </PopoverTrigger>\n          <PopoverContent className=\"w-64 p-3\" align=\"start\">\n            <div className=\"grid grid-cols-6 gap-1\">\n              {quickEmojis.map((item) => (\n                <Button\n                  key={item.emoji}\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => handleInsert(item.emoji, item.name)}\n                  className=\"h-8 w-8 p-0\"\n                  title={item.name}\n                >\n                  {item.emoji}\n                </Button>\n              ))}\n            </div>\n          </PopoverContent>\n        </Popover>\n      </div>\n\n      <Separator orientation=\"vertical\" className=\"h-6\" />\n\n      {/* Quick symbols */}\n      <div className=\"flex gap-1\">\n        {quickSymbols.slice(0, 4).map((item) => (\n          <Button\n            key={item.symbol}\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleInsert(item.symbol, item.name)}\n            className=\"h-8 w-8 p-0 text-xs\"\n            title={item.name}\n          >\n            {item.symbol}\n          </Button>\n        ))}\n        \n        <Popover>\n          <PopoverTrigger asChild>\n            <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\" title=\"Больше символов\">\n              <Sparkles className=\"w-3 h-3\" />\n            </Button>\n          </PopoverTrigger>\n          <PopoverContent className=\"w-64 p-3\" align=\"start\">\n            <div className=\"grid grid-cols-4 gap-1\">\n              {quickSymbols.map((item) => (\n                <Button\n                  key={item.symbol}\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => handleInsert(item.symbol, item.name)}\n                  className=\"h-8 justify-start text-xs\"\n                  title={item.name}\n                >\n                  {item.symbol}\n                </Button>\n              ))}\n            </div>\n          </PopoverContent>\n        </Popover>\n      </div>\n\n      <Separator orientation=\"vertical\" className=\"h-6\" />\n\n      {/* Quick templates */}\n      <Popover>\n        <PopoverTrigger asChild>\n          <Button variant=\"ghost\" size=\"sm\" className=\"h-8 px-2 text-xs\" title=\"Шаблоны\">\n            <Settings className=\"w-3 h-3 mr-1\" />\n            Шаблоны\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent className=\"w-64 p-3\" align=\"start\">\n          <div className=\"space-y-1\">\n            {quickTemplates.map((template) => (\n              <Button\n                key={template.name}\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => handleInsert(template.template, template.name)}\n                className=\"w-full justify-start h-8 text-xs\"\n              >\n                <template.icon className=\"w-3 h-3 mr-2\" />\n                {template.name}\n              </Button>\n            ))}\n          </div>\n        </PopoverContent>\n      </Popover>\n\n      {/* Format mode indicator */}\n      <div className=\"ml-auto flex items-center\">\n        <Badge variant=\"outline\" className=\"text-xs\">\n          {isMarkdown ? 'Markdown' : 'HTML'}\n        </Badge>\n      </div>\n    </div>\n  );\n}","size_bytes":8743},"server/db-routes.ts":{"content":"import { Router } from 'express';\nimport { storage } from './storage';\nimport { dbManager } from './db-utils';\nimport { dbCache } from './db-cache';\nimport { dbBackup } from './db-backup';\nimport multer from 'multer';\nimport { join } from 'path';\n\nconst router = Router();\n\n// Database health and statistics endpoints\nrouter.get('/health', async (req, res) => {\n  try {\n    const isHealthy = await dbManager.performHealthCheck();\n    const stats = dbManager.getConnectionStats();\n    \n    res.json({\n      healthy: isHealthy,\n      stats,\n      timestamp: new Date().toISOString()\n    });\n  } catch (error) {\n    res.status(500).json({ error: 'Health check failed', message: error.message });\n  }\n});\n\n// Database statistics\nrouter.get('/stats', async (req, res) => {\n  try {\n    const stats = await (storage as any).getDetailedStats();\n    res.json(stats);\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to get stats', message: error.message });\n  }\n});\n\n// Database metrics\nrouter.get('/metrics', async (req, res) => {\n  try {\n    const metrics = await dbManager.getDatabaseMetrics();\n    res.json(metrics);\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to get metrics', message: error.message });\n  }\n});\n\n// Cache statistics\nrouter.get('/cache/stats', async (req, res) => {\n  try {\n    const stats = dbCache.getStats();\n    res.json(stats);\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to get cache stats', message: error.message });\n  }\n});\n\n// Clear cache\nrouter.post('/cache/clear', async (req, res) => {\n  try {\n    const { pattern } = req.body;\n    \n    if (pattern) {\n      dbCache.clearByPattern(pattern);\n    } else {\n      dbCache.clear();\n    }\n    \n    res.json({ message: 'Cache cleared successfully' });\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to clear cache', message: error.message });\n  }\n});\n\n// Database maintenance\nrouter.post('/maintenance', async (req, res) => {\n  try {\n    await (storage as any).performMaintenance();\n    res.json({ message: 'Database maintenance completed successfully' });\n  } catch (error) {\n    res.status(500).json({ error: 'Maintenance failed', message: error.message });\n  }\n});\n\n// Database backup\nrouter.post('/backup', async (req, res) => {\n  try {\n    const backupName = await (storage as any).createBackup();\n    res.json({ message: 'Backup created successfully', backupName });\n  } catch (error) {\n    res.status(500).json({ error: 'Backup failed', message: error.message });\n  }\n});\n\n// Database optimization\nrouter.post('/optimize', async (req, res) => {\n  try {\n    await dbManager.optimizeConnections();\n    res.json({ message: 'Database connections optimized' });\n  } catch (error) {\n    res.status(500).json({ error: 'Optimization failed', message: error.message });\n  }\n});\n\n// Cleanup old data\nrouter.post('/cleanup', async (req, res) => {\n  try {\n    const { days = 30 } = req.body;\n    await dbManager.cleanupOldData(days);\n    res.json({ message: `Cleaned up data older than ${days} days` });\n  } catch (error) {\n    res.status(500).json({ error: 'Cleanup failed', message: error.message });\n  }\n});\n\n// Connection pool information\nrouter.get('/pool', async (req, res) => {\n  try {\n    const stats = dbManager.getConnectionStats();\n    res.json(stats.poolInfo);\n  } catch (error) {\n    res.status(500).json({ error: 'Failed to get pool info', message: error.message });\n  }\n});\n\n// Настройка multer для загрузки резервных копий\nconst upload = multer({\n  dest: './backups',\n  fileFilter: (req, file, cb) => {\n    // Разрешить только JSON файлы\n    if (file.mimetype === 'application/json' || file.originalname.endsWith('.json')) {\n      cb(null, true);\n    } else {\n      cb(new Error('Только JSON файлы разрешены для загрузки'));\n    }\n  },\n  limits: {\n    fileSize: 50 * 1024 * 1024 // 50MB максимальный размер файла\n  }\n});\n\n// BACKUP AND RESTORE ENDPOINTS\n\n// Создать резервную копию базы данных\nrouter.post('/backup', async (req, res) => {\n  try {\n    const { description } = req.body;\n    const filepath = await dbBackup.createFullBackup(description);\n    \n    res.json({\n      success: true,\n      message: 'Резервная копия создана успешно',\n      filepath,\n      timestamp: new Date().toISOString()\n    });\n  } catch (error) {\n    res.status(500).json({ \n      success: false, \n      error: 'Не удалось создать резервную копию', \n      message: error.message \n    });\n  }\n});\n\n// Получить список резервных копий\nrouter.get('/backups', async (req, res) => {\n  try {\n    const backups = await dbBackup.listBackups();\n    res.json({\n      success: true,\n      backups,\n      count: backups.length\n    });\n  } catch (error) {\n    res.status(500).json({ \n      success: false, \n      error: 'Не удалось получить список резервных копий', \n      message: error.message \n    });\n  }\n});\n\n// Скачать резервную копию\nrouter.get('/backup/:filename', async (req, res) => {\n  try {\n    const { filename } = req.params;\n    const filepath = join('./backups', filename);\n    \n    // Проверить что файл существует\n    const fs = await import('fs');\n    if (!fs.existsSync(filepath)) {\n      return res.status(404).json({ \n        success: false, \n        error: 'Резервная копия не найдена' \n      });\n    }\n\n    // Отправить файл для скачивания\n    res.download(filepath, filename, (err) => {\n      if (err) {\n        console.error('Download error:', err);\n        res.status(500).json({ \n          success: false, \n          error: 'Не удалось скачать файл' \n        });\n      }\n    });\n  } catch (error) {\n    res.status(500).json({ \n      success: false, \n      error: 'Не удалось скачать резервную копию', \n      message: error.message \n    });\n  }\n});\n\n// Восстановить из резервной копии\nrouter.post('/restore', async (req, res) => {\n  try {\n    const { filename, options } = req.body;\n    const filepath = join('./backups', filename);\n    \n    await dbBackup.restoreFromBackup(filepath, options);\n    \n    res.json({\n      success: true,\n      message: 'База данных восстановлена успешно',\n      timestamp: new Date().toISOString()\n    });\n  } catch (error) {\n    res.status(500).json({ \n      success: false, \n      error: 'Не удалось восстановить базу данных', \n      message: error.message \n    });\n  }\n});\n\n// Загрузить резервную копию\nrouter.post('/backup/upload', upload.single('backup'), async (req, res) => {\n  try {\n    if (!req.file) {\n      return res.status(400).json({ \n        success: false, \n        error: 'Файл не загружен' \n      });\n    }\n\n    const { restoreImmediately, clearExisting } = req.body;\n    const filepath = req.file.path;\n    \n    // Переименовать файл чтобы иметь правильное расширение\n    const fs = await import('fs');\n    const newFilepath = filepath + '.json';\n    fs.renameSync(filepath, newFilepath);\n\n    let result: any = {\n      success: true,\n      message: 'Файл загружен успешно',\n      filename: req.file.filename + '.json',\n      size: req.file.size\n    };\n\n    // Если указано восстановить немедленно\n    if (restoreImmediately === 'true') {\n      try {\n        await dbBackup.restoreFromBackup(newFilepath, {\n          clearExisting: clearExisting === 'true'\n        });\n        result.message = 'Файл загружен и база данных восстановлена успешно';\n        result.restored = true;\n      } catch (restoreError) {\n        result.warning = 'Файл загружен, но восстановление не удалось: ' + restoreError.message;\n      }\n    }\n\n    res.json(result);\n  } catch (error) {\n    res.status(500).json({ \n      success: false, \n      error: 'Не удалось загрузить файл', \n      message: error.message \n    });\n  }\n});\n\n// Удалить резервную копию\nrouter.delete('/backup/:filename', async (req, res) => {\n  try {\n    const { filename } = req.params;\n    await dbBackup.deleteBackup(filename);\n    \n    res.json({\n      success: true,\n      message: 'Резервная копия удалена успешно'\n    });\n  } catch (error) {\n    res.status(500).json({ \n      success: false, \n      error: 'Не удалось удалить резервную копию', \n      message: error.message \n    });\n  }\n});\n\n// Получить статистику базы данных\nrouter.get('/stats/detailed', async (req, res) => {\n  try {\n    const stats = await dbBackup.getDatabaseStats();\n    res.json({\n      success: true,\n      stats\n    });\n  } catch (error) {\n    res.status(500).json({ \n      success: false, \n      error: 'Не удалось получить статистику', \n      message: error.message \n    });\n  }\n});\n\nexport default router;","size_bytes":9295},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/lib/commands.ts":{"content":"// Стандартные команды Telegram и их описания\nexport const STANDARD_COMMANDS = [\n  {\n    command: '/start',\n    description: 'Начать работу с ботом',\n    category: 'system',\n    showInMenu: true\n  },\n  {\n    command: '/help',\n    description: 'Показать справку',\n    category: 'system',\n    showInMenu: true\n  },\n  {\n    command: '/settings',\n    description: 'Настройки бота',\n    category: 'system',\n    showInMenu: true\n  },\n  {\n    command: '/menu',\n    description: 'Главное меню',\n    category: 'navigation',\n    showInMenu: true\n  },\n  {\n    command: '/profile',\n    description: 'Профиль пользователя',\n    category: 'user',\n    showInMenu: true\n  },\n  {\n    command: '/info',\n    description: 'Информация о боте',\n    category: 'system',\n    showInMenu: true\n  },\n  {\n    command: '/cancel',\n    description: 'Отменить текущее действие',\n    category: 'system',\n    showInMenu: false\n  },\n  {\n    command: '/back',\n    description: 'Вернуться назад',\n    category: 'navigation',\n    showInMenu: false\n  },\n  {\n    command: '/support',\n    description: 'Техническая поддержка',\n    category: 'system',\n    showInMenu: true\n  },\n  {\n    command: '/about',\n    description: 'О боте',\n    category: 'system',\n    showInMenu: true\n  },\n  {\n    command: '/subscribe',\n    description: 'Подписаться на уведомления',\n    category: 'user',\n    showInMenu: true\n  },\n  {\n    command: '/unsubscribe',\n    description: 'Отписаться от уведомлений',\n    category: 'user',\n    showInMenu: false\n  },\n  {\n    command: '/feedback',\n    description: 'Оставить отзыв',\n    category: 'user',\n    showInMenu: true\n  },\n  {\n    command: '/language',\n    description: 'Выбрать язык',\n    category: 'system',\n    showInMenu: true\n  },\n  {\n    command: '/notifications',\n    description: 'Настройки уведомлений',\n    category: 'user',\n    showInMenu: true\n  }\n];\n\nexport const COMMAND_CATEGORIES = {\n  system: 'Системные',\n  user: 'Пользовательские',\n  navigation: 'Навигация',\n  admin: 'Администрирование'\n};\n\n// Валидация команды\nexport function validateCommand(command: string): { isValid: boolean; errors: string[] } {\n  const errors: string[] = [];\n  \n  if (!command) {\n    errors.push('Команда не может быть пустой');\n    return { isValid: false, errors };\n  }\n  \n  if (!command.startsWith('/')) {\n    errors.push('Команда должна начинаться с символа \"/\"');\n  }\n  \n  if (command.length < 2) {\n    errors.push('Команда должна содержать хотя бы один символ после \"/\"');\n  }\n  \n  if (command.length > 32) {\n    errors.push('Команда не может быть длиннее 32 символов');\n  }\n  \n  // Проверка на допустимые символы\n  const validPattern = /^\\/[a-zA-Z][a-zA-Z0-9_]*$/;\n  if (!validPattern.test(command)) {\n    errors.push('Команда может содержать только латинские буквы, цифры и подчёркивания');\n  }\n  \n  // Проверка на зарезервированные команды Telegram\n  const reservedCommands = ['/newbot', '/mybots', '/setname', '/setdescription', '/setabouttext', '/setuserpic', '/setinline', '/setjoingroups', '/setprivacy'];\n  if (reservedCommands.includes(command.toLowerCase())) {\n    errors.push('Эта команда зарезервирована системой Telegram');\n  }\n  \n  return {\n    isValid: errors.length === 0,\n    errors\n  };\n}\n\n// Генерация автодополнения команд\nexport function getCommandSuggestions(input: string): typeof STANDARD_COMMANDS {\n  if (!input.startsWith('/')) {\n    return [];\n  }\n  \n  const query = input.toLowerCase();\n  return STANDARD_COMMANDS.filter(cmd => \n    cmd.command.toLowerCase().includes(query) ||\n    cmd.description.toLowerCase().includes(query.slice(1))\n  ).slice(0, 10);\n}\n\n// Получение команды по тексту\nexport function parseCommandFromText(text: string): string | null {\n  if (!text || !text.startsWith('/')) {\n    return null;\n  }\n  \n  const match = text.match(/^\\/([a-zA-Z][a-zA-Z0-9_]*)/);\n  return match ? `/${match[1]}` : null;\n}\n\n// Генерация BotFather команд для настройки меню\nexport function generateBotFatherCommands(nodes: any[]): string {\n  if (!nodes || !Array.isArray(nodes)) {\n    return '';\n  }\n  \n  const commandNodes = nodes.filter(node => \n    (node.type === 'start' || node.type === 'command') && \n    node.data?.command &&\n    (node.data?.showInMenu !== false) // Включаем команды где showInMenu = true, undefined или не установлено\n  );\n  \n  if (commandNodes.length === 0) {\n    return '';\n  }\n  \n  let botFatherCommands = '';\n  \n  commandNodes.forEach(node => {\n    const command = node.data.command.replace('/', '');\n    const description = node.data.description || 'Команда бота';\n    botFatherCommands += `${command} - ${description}\\n`;\n  });\n  \n  return botFatherCommands.trim();\n}","size_bytes":5362},"client/src/components/ui/tooltip.tsx":{"content":"import * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }","size_bytes":1144},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":791},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\napp.use(express.json({ limit: '50mb' }));\napp.use(express.urlencoded({ extended: false, limit: '50mb' }));\n\n// Отдача загруженных файлов\napp.use('/uploads', express.static('uploads'));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      // Skip logging frequent HEAD requests to /api and /api/health to reduce noise\n      if (req.method === \"HEAD\" && (path === \"/api\" || path === \"/api/health\")) {\n        return;\n      }\n\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on port 5000\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = 5000;\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","size_bytes":2246},"client/src/components/editor/emoji-picker.tsx":{"content":"import { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Badge } from '@/components/ui/badge';\nimport { \n  Smile, \n  Heart, \n  Star, \n  Zap, \n  Search,\n  Copy,\n  Sparkles\n} from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface EmojiPickerProps {\n  onEmojiSelect: (emoji: string) => void;\n  onSymbolSelect: (symbol: string) => void;\n}\n\ninterface EmojiCategory {\n  name: string;\n  icon: React.ComponentType<{ className?: string }>;\n  emojis: string[];\n}\n\ninterface SymbolCategory {\n  name: string;\n  symbols: Array<{\n    symbol: string;\n    name: string;\n    description: string;\n  }>;\n}\n\nexport function EmojiPicker({ onEmojiSelect, onSymbolSelect }: EmojiPickerProps) {\n  const [searchTerm, setSearchTerm] = useState('');\n  const [activeTab, setActiveTab] = useState<'emojis' | 'symbols' | 'templates'>('emojis');\n  const { toast } = useToast();\n\n  const emojiCategories: EmojiCategory[] = [\n    {\n      name: 'Эмоции',\n      icon: Smile,\n      emojis: ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗', '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄', '😯', '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐', '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕']\n    },\n    {\n      name: 'Жесты',\n      icon: Heart,\n      emojis: ['👍', '👎', '👌', '🤌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👋', '🤚', '🖐️', '✋', '🖖', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🫀', '🫁', '🦷', '🦴', '👀', '👁️', '👅', '👄', '💋', '🩸']\n    },\n    {\n      name: 'Объекты',\n      icon: Star,\n      emojis: ['⭐', '🌟', '💫', '✨', '🔥', '💥', '💢', '💦', '💨', '🌪️', '⚡', '🔔', '🔕', '💡', '🔦', '🕯️', '🪔', '🧿', '📱', '💻', '🖥️', '⌨️', '🖱️', '🖨️', '💾', '💿', '📀', '🎥', '📷', '📹', '📼', '🔍', '🔎', '🕯️', '💰', '💎', '⚖️', '🔧', '🔨', '⚒️', '🛠️', '⛏️', '🔩', '⚙️', '🧰', '🧲', '🔫', '💣', '🧨', '🔪', '⚔️', '🛡️', '🚬', '⚰️', '⚱️', '🏺', '🔮', '📿', '🧿', '💈', '⚗️', '🔭', '🔬', '🕳️', '🩹', '🩺', '💊', '💉', '🧬', '🦠', '🧫', '🧪', '🌡️', '🧹', '🧽', '🚽', '🚰', '🚿', '🛁', '🛀', '🧴', '🧷', '🧹', '🧺', '🧻', '🧼', '🧽', '🧯', '🛒']\n    },\n    {\n      name: 'Природа',\n      icon: Zap,\n      emojis: ['🌱', '🌿', '🍀', '🌾', '🌵', '🌴', '🌳', '🌲', '🌰', '🌯', '🌻', '🌺', '🌸', '🌼', '🌷', '🥀', '🌹', '🌚', '🌛', '🌜', '🌝', '🌞', '🌟', '⭐', '🌠', '⚡', '⛅', '⛈️', '🌤️', '🌦️', '🌧️', '🌨️', '🌩️', '🌪️', '🌫️', '🌬️', '🌀', '🌈', '☀️', '🌤️', '⛅', '🌥️', '☁️', '🌦️', '🌧️', '⛈️', '🌩️', '🌨️', '❄️', '☃️', '⛄', '🌬️', '💨', '💧', '💦', '☔', '☂️', '🌊', '🌍', '🌎', '🌏', '🪐', '💫', '⭐', '🌟', '✨', '⚡', '☄️', '💥', '🔥', '🌪️', '🌈', '☀️', '🌤️', '⛅', '🌦️', '🌧️', '⛈️', '🌩️', '🌨️', '❄️', '☃️', '⛄', '🌬️', '💨', '💧', '💦', '☔']\n    }\n  ];\n\n  const symbolCategories: SymbolCategory[] = [\n    {\n      name: 'Стрелки',\n      symbols: [\n        { symbol: '→', name: 'Стрелка вправо', description: 'Для указания направления' },\n        { symbol: '←', name: 'Стрелка влево', description: 'Для указания направления' },\n        { symbol: '↑', name: 'Стрелка вверх', description: 'Для указания направления' },\n        { symbol: '↓', name: 'Стрелка вниз', description: 'Для указания направления' },\n        { symbol: '↗', name: 'Стрелка вправо-вверх', description: 'Диагональная стрелка' },\n        { symbol: '↘', name: 'Стрелка вправо-вниз', description: 'Диагональная стрелка' },\n        { symbol: '↙', name: 'Стрелка влево-вниз', description: 'Диагональная стрелка' },\n        { symbol: '↖', name: 'Стрелка влево-вверх', description: 'Диагональная стрелка' },\n        { symbol: '⇒', name: 'Двойная стрелка вправо', description: 'Жирная стрелка' },\n        { symbol: '⇐', name: 'Двойная стрелка влево', description: 'Жирная стрелка' },\n        { symbol: '⇑', name: 'Двойная стрелка вверх', description: 'Жирная стрелка' },\n        { symbol: '⇓', name: 'Двойная стрелка вниз', description: 'Жирная стрелка' }\n      ]\n    },\n    {\n      name: 'Математические',\n      symbols: [\n        { symbol: '±', name: 'Плюс-минус', description: 'Математический символ' },\n        { symbol: '×', name: 'Умножение', description: 'Знак умножения' },\n        { symbol: '÷', name: 'Деление', description: 'Знак деления' },\n        { symbol: '=', name: 'Равно', description: 'Знак равенства' },\n        { symbol: '≠', name: 'Не равно', description: 'Знак неравенства' },\n        { symbol: '≤', name: 'Меньше или равно', description: 'Математическое сравнение' },\n        { symbol: '≥', name: 'Больше или равно', description: 'Математическое сравнение' },\n        { symbol: '∞', name: 'Бесконечность', description: 'Символ бесконечности' },\n        { symbol: '√', name: 'Квадратный корень', description: 'Математический корень' },\n        { symbol: '²', name: 'Степень 2', description: 'Надстрочный индекс' },\n        { symbol: '³', name: 'Степень 3', description: 'Надстрочный индекс' },\n        { symbol: '%', name: 'Процент', description: 'Знак процента' }\n      ]\n    },\n    {\n      name: 'Пунктуация',\n      symbols: [\n        { symbol: '•', name: 'Маркер списка', description: 'Для создания списков' },\n        { symbol: '◦', name: 'Белый маркер', description: 'Для вложенных списков' },\n        { symbol: '▪', name: 'Черный квадратик', description: 'Альтернативный маркер' },\n        { symbol: '▫', name: 'Белый квадратик', description: 'Альтернативный маркер' },\n        { symbol: '—', name: 'Длинное тире', description: 'Пунктуационный знак' },\n        { symbol: '–', name: 'Короткое тире', description: 'Пунктуационный знак' },\n        { symbol: '…', name: 'Многоточие', description: 'Три точки' },\n        { symbol: '«', name: 'Левая кавычка', description: 'Открывающая кавычка' },\n        { symbol: '»', name: 'Правая кавычка', description: 'Закрывающая кавычка' },\n        { symbol: '\"', name: 'Левая двойная кавычка', description: 'Открывающая кавычка' },\n        { symbol: '\"', name: 'Правая двойная кавычка', description: 'Закрывающая кавычка' },\n        { symbol: '§', name: 'Параграф', description: 'Знак параграфа' }\n      ]\n    },\n    {\n      name: 'Специальные',\n      symbols: [\n        { symbol: '☑', name: 'Галочка в квадрате', description: 'Выполненная задача' },\n        { symbol: '☐', name: 'Пустой квадрат', description: 'Невыполненная задача' },\n        { symbol: '✓', name: 'Галочка', description: 'Знак выполнения' },\n        { symbol: '✗', name: 'Крестик', description: 'Знак отмены' },\n        { symbol: '⚠', name: 'Предупреждение', description: 'Знак внимания' },\n        { symbol: '⚡', name: 'Молния', description: 'Быстрота, энергия' },\n        { symbol: '♨', name: 'Горячие источники', description: 'Символ температуры' },\n        { symbol: '♻', name: 'Переработка', description: 'Экологический символ' },\n        { symbol: '©', name: 'Копирайт', description: 'Авторское право' },\n        { symbol: '®', name: 'Зарегистрированный товарный знак', description: 'Торговая марка' },\n        { symbol: '™', name: 'Товарный знак', description: 'Торговая марка' },\n        { symbol: '№', name: 'Номер', description: 'Знак номера' }\n      ]\n    }\n  ];\n\n  const textTemplates = [\n    {\n      name: 'Приветствие',\n      template: '👋 Добро пожаловать!\\n\\n🎉 Мы рады видеть вас здесь!'\n    },\n    {\n      name: 'Список задач',\n      template: '📋 **Список задач:**\\n\\n☐ Задача 1\\n☐ Задача 2\\n☑ Выполненная задача'\n    },\n    {\n      name: 'Предупреждение',\n      template: '⚠️ **Внимание!**\\n\\n🚨 Важная информация для пользователей'\n    },\n    {\n      name: 'Успех',\n      template: '✅ **Успешно!**\\n\\n🎊 Операция выполнена успешно'\n    },\n    {\n      name: 'Контакты',\n      template: '📞 **Контакты:**\\n\\n📧 Email: example@email.com\\n📱 Телефон: +7 (999) 123-45-67'\n    },\n    {\n      name: 'Меню',\n      template: '🍽️ **Меню:**\\n\\n• Пункт 1\\n• Пункт 2\\n• Пункт 3'\n    }\n  ];\n\n  const handleEmojiClick = (emoji: string) => {\n    onEmojiSelect(emoji);\n    toast({\n      title: \"Эмодзи добавлен\",\n      description: `${emoji} добавлен в текст`\n    });\n  };\n\n  const handleSymbolClick = (symbol: string) => {\n    onSymbolSelect(symbol);\n    toast({\n      title: \"Символ добавлен\",\n      description: `${symbol} добавлен в текст`\n    });\n  };\n\n  const copyTemplate = async (template: string) => {\n    try {\n      await navigator.clipboard.writeText(template);\n      toast({\n        title: \"Шаблон скопирован\",\n        description: \"Шаблон скопирован в буфер обмена\"\n      });\n    } catch (err) {\n      console.error('Failed to copy template: ', err);\n    }\n  };\n\n  const filteredEmojis = emojiCategories.map(category => ({\n    ...category,\n    emojis: category.emojis.filter(emoji => \n      !searchTerm || emoji.includes(searchTerm)\n    )\n  }));\n\n  const filteredSymbols = symbolCategories.map(category => ({\n    ...category,\n    symbols: category.symbols.filter(item => \n      !searchTerm || \n      item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      item.description.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      item.symbol.includes(searchTerm)\n    )\n  }));\n\n  return (\n    <Card className=\"w-full\">\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-sm flex items-center gap-2\">\n          <Sparkles className=\"w-4 h-4\" />\n          Эмодзи и символы\n        </CardTitle>\n        <div className=\"flex items-center gap-2\">\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-2 top-2.5 w-4 h-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Поиск эмодзи или символов...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-8 h-8 text-xs\"\n            />\n          </div>\n        </div>\n      </CardHeader>\n      \n      <CardContent>\n        <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as any)}>\n          <TabsList className=\"grid w-full grid-cols-3\">\n            <TabsTrigger value=\"emojis\">Эмодзи</TabsTrigger>\n            <TabsTrigger value=\"symbols\">Символы</TabsTrigger>\n            <TabsTrigger value=\"templates\">Шаблоны</TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"emojis\" className=\"space-y-4\">\n            <ScrollArea className=\"h-64 pr-4\">\n              {filteredEmojis.map((category) => (\n                <div key={category.name} className=\"mb-4\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <category.icon className=\"w-4 h-4\" />\n                    <Label className=\"text-xs font-medium\">{category.name}</Label>\n                  </div>\n                  <div className=\"grid grid-cols-8 gap-1\">\n                    {category.emojis.map((emoji, index) => (\n                      <Button\n                        key={index}\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleEmojiClick(emoji)}\n                        className=\"h-8 w-8 p-0 hover:bg-muted\"\n                      >\n                        {emoji}\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n              ))}\n            </ScrollArea>\n          </TabsContent>\n\n          <TabsContent value=\"symbols\" className=\"space-y-4\">\n            <ScrollArea className=\"h-64 pr-4\">\n              {filteredSymbols.map((category) => (\n                <div key={category.name} className=\"mb-4\">\n                  <Label className=\"text-xs font-medium mb-2 block\">{category.name}</Label>\n                  <div className=\"grid grid-cols-1 gap-1\">\n                    {category.symbols.map((item, index) => (\n                      <Button\n                        key={index}\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleSymbolClick(item.symbol)}\n                        className=\"justify-start h-8 px-2 gap-3\"\n                      >\n                        <span className=\"text-base\">{item.symbol}</span>\n                        <span className=\"text-xs text-muted-foreground\">{item.name}</span>\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n              ))}\n            </ScrollArea>\n          </TabsContent>\n\n          <TabsContent value=\"templates\" className=\"space-y-4\">\n            <ScrollArea className=\"h-64 pr-4\">\n              <div className=\"space-y-2\">\n                {textTemplates.map((template, index) => (\n                  <div key={index} className=\"p-3 bg-muted/50 rounded-lg\">\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {template.name}\n                      </Badge>\n                      <div className=\"flex gap-1\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => onEmojiSelect(template.template)}\n                          className=\"h-6 px-2 text-xs\"\n                        >\n                          Вставить\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => copyTemplate(template.template)}\n                          className=\"h-6 px-2\"\n                        >\n                          <Copy className=\"w-3 h-3\" />\n                        </Button>\n                      </div>\n                    </div>\n                    <pre className=\"text-xs text-muted-foreground whitespace-pre-wrap\">\n                      {template.template}\n                    </pre>\n                  </div>\n                ))}\n              </div>\n            </ScrollArea>\n          </TabsContent>\n        </Tabs>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":17235},"server/seed-templates.ts":{"content":"import { storage } from \"./storage\";\n\n// Стандартные шаблоны для демонстрации\nasync function seedDefaultTemplates(force = false) {\n  try {\n    console.log(`📋 seedDefaultTemplates вызван с force=${force}`);\n    const existingTemplates = await storage.getAllBotTemplates();\n    \n    // Проверяем, есть ли уже системные шаблоны\n    const systemTemplates = existingTemplates.filter(t => t.authorName === 'Система');\n    console.log(`📊 Найдено ${systemTemplates.length} системных шаблонов`);\n    \n    if (force) {\n      console.log('🔄 Принудительное обновление системных шаблонов...');\n      // Удаляем существующие системные шаблоны\n      for (const template of systemTemplates) {\n        await storage.deleteBotTemplate(template.id);\n      }\n      console.log(`🗑️ Удалено ${systemTemplates.length} старых системных шаблонов`);\n    } else if (systemTemplates.length >= 1) {\n      console.log('Системные шаблоны уже существуют, пропускаем инициализацию');\n      return;\n    }\n\n    // Создаем шаблон VProgulke Bot для знакомств\n    await storage.createBotTemplate({\n      name: \"🌟 VProgulke Bot - Знакомства СПб\",\n      description: \"Продвинутый бот знакомств для Санкт-Петербурга с детальной анкетой, системой метро и многоуровневыми интересами\",\n      category: \"community\",\n      tags: [\"знакомства\", \"профиль\", \"метро\", \"интересы\", \"СПб\", \"анкета\", \"чат\"],\n      isPublic: 1,\n      difficulty: \"hard\",\n      authorName: \"Система\",\n      version: \"3.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 9,\n      estimatedTime: 45,\n      data: {\n        nodes: [\n          {\n            id: \"start\",\n            type: \"start\",\n            position: { x: 100, y: 50 },\n            data: {\n              command: \"/start\",\n              description: \"Приветствие и источник\",\n              messageText: \"🌟 Привет от ᴠᴨᴩᴏᴦʏᴧᴋᴇ Bot!\\n\\nЭтот бот поможет тебе найти интересных людей в Санкт-Петербурге!\\n\\nОткуда ты узнал о нашем чате? 😎\",\n              synonyms: [\"старт\", \"начать\", \"привет\", \"начало\", \"начинаем\"],\n              keyboardType: \"none\",\n              buttons: [],\n              collectUserInput: true,\n              enableTextInput: true,\n              inputVariable: \"user_source\",\n              inputTargetNodeId: \"join_request\",\n              markdown: false,\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n\n          {\n            id: \"join_request\",\n            type: \"message\",\n            position: { x: 100, y: 250 },\n            data: {\n              messageText: \"Хочешь присоединиться к нашему чату? 🚀\",\n              synonyms: [],\n              keyboardType: \"inline\",\n              collectUserInput: true,\n              inputVariable: \"join_request_response\",\n              buttons: [\n                {\n                  id: \"btn-yes\",\n                  text: \"Да 😎\",\n                  value: \"yes\",\n                  action: \"goto\",\n                  target: \"gender_selection\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-no\", \n                  text: \"Нет 🙅\",\n                  value: \"no\",\n                  action: \"goto\",\n                  target: \"decline_response\",\n                  buttonType: \"option\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: true,\n              resizeKeyboard: true\n            }\n          },\n\n          {\n            id: \"decline_response\",\n            type: \"message\",\n            position: { x: 100, y: 450 },\n            data: {\n              messageText: \"Понятно! Если передумаешь, напиши /start! 😊\",\n              synonyms: [],\n              keyboardType: \"none\",\n              removeKeyboard: true,\n              buttons: [],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"gender_selection\",\n            type: \"message\",\n            position: { x: 500, y: 250 },\n            data: {\n              messageText: \"Укажи свой пол: 👨👩\",\n              keyboardType: \"inline\",\n              collectUserInput: true,\n              inputVariable: \"gender\",\n              synonyms: [\"пол\", \"гендер\", \"мужчина\", \"женщина\"],\n              buttons: [\n                {\n                  id: \"btn-male\",\n                  text: \"Мужчина 👨\",\n                  value: \"male\",\n                  action: \"goto\",\n                  target: \"name_input\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-female\",\n                  text: \"Женщина 👩\",\n                  value: \"female\",\n                  action: \"goto\",\n                  target: \"name_input\",\n                  buttonType: \"option\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: true,\n              resizeKeyboard: true\n            }\n          },\n\n          {\n            id: \"name_input\",\n            type: \"message\",\n            position: { x: 900, y: 250 },\n            data: {\n              messageText: \"Как тебя зовут? ✏️\\n\\nНапиши своё имя в сообщении:\",\n              keyboardType: \"none\",\n              collectUserInput: true,\n              enableTextInput: true,\n              inputVariable: \"user_name\",\n              synonyms: [\"имя\", \"зовут\", \"называют\", \"как зовут\"],\n              inputTargetNodeId: \"age_input\",\n              buttons: [],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"age_input\",\n            type: \"message\",\n            position: { x: 1300, y: 250 },\n            data: {\n              messageText: \"Сколько тебе лет? 🎂\\n\\nНапиши свой возраст числом (например, 25):\",\n              keyboardType: \"none\",\n              collectUserInput: true,\n              enableTextInput: true,\n              inputVariable: \"user_age\",\n              synonyms: [\"возраст\", \"лет\", \"годы\", \"сколько лет\"],\n              inputTargetNodeId: \"metro_selection\",\n              buttons: [],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"metro_selection\",\n            type: \"message\",\n            position: { x: 100, y: 450 },\n            data: {\n              messageText: \"На какой станции метро ты обычно бываешь? 🚇\\n\\nВыбери свою ветку:\",\n              keyboardType: \"inline\",\n              collectUserInput: true,\n              inputVariable: \"metro_stations\",\n              synonyms: [\"метро\", \"станция\", \"где живу\", \"район\"],\n              buttons: [\n                {\n                  id: \"btn-red\",\n                  text: \"Красная ветка 🟥\",\n                  action: \"goto\",\n                  target: \"red_line_stations\",\n                  buttonType: \"option\",\n                  skipDataCollection: true\n                },\n                {\n                  id: \"btn-blue\",\n                  text: \"Синяя ветка 🟦\",\n                  action: \"goto\", \n                  target: \"blue_line_stations\",\n                  buttonType: \"option\",\n                  skipDataCollection: true\n                },\n                {\n                  id: \"btn-green\",\n                  text: \"Зелёная ветка 🟩\",\n                  action: \"goto\",\n                  target: \"green_line_stations\",\n                  buttonType: \"option\",\n                  skipDataCollection: true\n                },\n                {\n                  id: \"btn-orange\",\n                  text: \"Оранжевая ветка 🟧\",\n                  action: \"goto\",\n                  target: \"orange_line_stations\",\n                  buttonType: \"option\",\n                  skipDataCollection: true\n                },\n                {\n                  id: \"btn-purple\",\n                  text: \"Фиолетовая ветка 🟪\",\n                  action: \"goto\",\n                  target: \"purple_line_stations\",\n                  buttonType: \"option\",\n                  skipDataCollection: true\n                },\n                {\n                  id: \"btn-lo\",\n                  text: \"Я из ЛО 🏡\",\n                  value: \"ЛО\",\n                  action: \"goto\",\n                  target: \"interests_categories\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-not-spb\",\n                  text: \"Я не в Питере 🌍\",\n                  value: \"Не в СПб\",\n                  action: \"goto\",\n                  target: \"interests_categories\",\n                  buttonType: \"option\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: true,\n              resizeKeyboard: true\n            }\n          },\n\n          // Красная ветка (Кировско-Выборгская) - станции\n          {\n            id: \"red_line_stations\",\n            type: \"message\",\n            position: { x: 1500, y: 450 },\n            data: {\n              messageText: \"🟥 Кировско-Выборгская линия\\n\\nВыбери свою станцию:\",\n              synonyms: [\"красная линия\", \"кировско-выборгская\", \"красная ветка\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"metro_stations\",\n              continueButtonTarget: \"interests_categories\",\n              buttons: [\n                { id: \"red-devyatkino\", text: \"🟥 Девяткино\", action: \"selection\", target: \"devyatkino\", buttonType: \"option\" },\n                { id: \"red-grazhdansky\", text: \"🟥 Гражданский проспект\", action: \"selection\", target: \"grazhdansky\", buttonType: \"option\" },\n                { id: \"red-akademicheskaya\", text: \"🟥 Академическая\", action: \"selection\", target: \"akademicheskaya\", buttonType: \"option\" },\n                { id: \"red-politehnicheskaya\", text: \"🟥 Политехническая\", action: \"selection\", target: \"politehnicheskaya\", buttonType: \"option\" },\n                { id: \"red-pl-muzhestva\", text: \"🟥 Площадь Мужества\", action: \"selection\", target: \"pl_muzhestva\", buttonType: \"option\" },\n                { id: \"red-lesnaya\", text: \"🟥 Лесная\", action: \"selection\", target: \"lesnaya\", buttonType: \"option\" },\n                { id: \"red-vyborgskaya\", text: \"🟥 Выборгская\", action: \"selection\", target: \"vyborgskaya\", buttonType: \"option\" },\n                { id: \"red-pl-lenina\", text: \"🟥 Площадь Ленина\", action: \"selection\", target: \"pl_lenina\", buttonType: \"option\" },\n                { id: \"red-chernyshevskaya\", text: \"🟥 Чернышевская\", action: \"selection\", target: \"chernyshevskaya\", buttonType: \"option\" },\n                { id: \"red-pl-vosstaniya\", text: \"🟥 Площадь Восстания\", action: \"selection\", target: \"pl_vosstaniya\", buttonType: \"option\" },\n                { id: \"red-vladimirskaya\", text: \"🟥 Владимирская\", action: \"selection\", target: \"vladimirskaya\", buttonType: \"option\" },\n                { id: \"red-pushkinskaya\", text: \"🟥 Пушкинская\", action: \"selection\", target: \"pushkinskaya\", buttonType: \"option\" },\n                { id: \"red-tehinstitut1\", text: \"🟥 Технологический институт-1\", action: \"selection\", target: \"tehinstitut1\", buttonType: \"option\" },\n                { id: \"red-baltiyskaya\", text: \"🟥 Балтийская\", action: \"selection\", target: \"baltiyskaya\", buttonType: \"option\" },\n                { id: \"red-narvskaya\", text: \"🟥 Нарвская\", action: \"selection\", target: \"narvskaya\", buttonType: \"option\" },\n                { id: \"red-kirovsky\", text: \"🟥 Кировский завод\", action: \"selection\", target: \"kirovsky\", buttonType: \"option\" },\n                { id: \"red-avtovo\", text: \"🟥 Автово\", action: \"selection\", target: \"avtovo\", buttonType: \"option\" },\n                { id: \"red-leninsky\", text: \"🟥 Ленинский проспект\", action: \"selection\", target: \"leninsky\", buttonType: \"option\" },\n                { id: \"red-veteranov\", text: \"🟥 Проспект Ветеранов\", action: \"selection\", target: \"veteranov\", buttonType: \"option\" },\n                { id: \"btn-back-metro\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n              ],\n              markdown: false\n            }\n          },\n\n          // Синяя ветка (Московско-Петроградская) - станции\n          {\n            id: \"blue_line_stations\",\n            type: \"message\",\n            position: { x: 1900, y: 450 },\n            data: {\n              messageText: \"🟦 Московско-Петроградская линия\\n\\nВыбери свою станцию:\",\n              synonyms: [\"синяя линия\", \"московско-петроградская\", \"синяя ветка\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"metro_stations\",\n              continueButtonTarget: \"interests_categories\",\n              buttons: [\n                { id: \"blue-parnas\", text: \"🟦 Парнас\", action: \"selection\", target: \"parnas\", buttonType: \"option\" },\n                { id: \"blue-prosp-prosvesh\", text: \"🟦 Проспект Просвещения\", action: \"selection\", target: \"prosp_prosvesh\", buttonType: \"option\" },\n                { id: \"blue-ozerki\", text: \"🟦 Озерки\", action: \"selection\", target: \"ozerki\", buttonType: \"option\" },\n                { id: \"blue-udelnaya\", text: \"🟦 Удельная\", action: \"selection\", target: \"udelnaya\", buttonType: \"option\" },\n                { id: \"blue-pionerskaya\", text: \"🟦 Пионерская\", action: \"selection\", target: \"pionerskaya\", buttonType: \"option\" },\n                { id: \"blue-chernaya\", text: \"🟦 Черная речка\", action: \"selection\", target: \"chernaya\", buttonType: \"option\" },\n                { id: \"blue-petrogradskaya\", text: \"🟦 Петроградская\", action: \"selection\", target: \"petrogradskaya\", buttonType: \"option\" },\n                { id: \"blue-gorkovskaya\", text: \"🟦 Горьковская\", action: \"selection\", target: \"gorkovskaya\", buttonType: \"option\" },\n                { id: \"blue-nevsky\", text: \"🟦 Невский проспект\", action: \"selection\", target: \"nevsky\", buttonType: \"option\" },\n                { id: \"blue-sennaya\", text: \"🟦 Сенная площадь\", action: \"selection\", target: \"sennaya\", buttonType: \"option\" },\n                { id: \"blue-tehinstitut2\", text: \"🟦 Технологический институт-2\", action: \"selection\", target: \"tehinstitut2\", buttonType: \"option\" },\n                { id: \"blue-frunzenskaya\", text: \"🟦 Фрунзенская\", action: \"selection\", target: \"frunzenskaya\", buttonType: \"option\" },\n                { id: \"blue-mosk-vorota\", text: \"🟦 Московские ворота\", action: \"selection\", target: \"mosk_vorota\", buttonType: \"option\" },\n                { id: \"blue-elektrosila\", text: \"🟦 Электросила\", action: \"selection\", target: \"elektrosila\", buttonType: \"option\" },\n                { id: \"blue-park-pobedy\", text: \"🟦 Парк Победы\", action: \"selection\", target: \"park_pobedy\", buttonType: \"option\" },\n                { id: \"blue-moskovskaya\", text: \"🟦 Московская\", action: \"selection\", target: \"moskovskaya\", buttonType: \"option\" },\n                { id: \"blue-zvezdnaya\", text: \"🟦 Звездная\", action: \"selection\", target: \"zvezdnaya\", buttonType: \"option\" },\n                { id: \"blue-kupchino\", text: \"🟦 Купчино\", action: \"selection\", target: \"kupchino\", buttonType: \"option\" },\n                { id: \"btn-back-metro-blue\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n              ],\n              markdown: false\n            }\n          },\n\n          // Зелёная ветка (Невско-Василеостровская) - станции\n          {\n            id: \"green_line_stations\",\n            type: \"message\",\n            position: { x: 2300, y: 450 },\n            data: {\n              messageText: \"🟩 Невско-Василеостровская линия\\n\\nВыбери свою станцию:\",\n              synonyms: [\"зеленая линия\", \"невско-василеостровская\", \"зеленая ветка\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"metro_stations\",\n              continueButtonTarget: \"interests_categories\",\n              buttons: [\n                { id: \"green-primorskaya\", text: \"🟩 Приморская\", action: \"selection\", target: \"primorskaya\", buttonType: \"option\" },\n                { id: \"green-vasileostr\", text: \"🟩 Василеостровская\", action: \"selection\", target: \"vasileostr\", buttonType: \"option\" },\n                { id: \"green-gostiny\", text: \"🟩 Гостиный двор\", action: \"selection\", target: \"gostiny\", buttonType: \"option\" },\n                { id: \"green-mayakovskaya\", text: \"🟩 Маяковская\", action: \"selection\", target: \"mayakovskaya\", buttonType: \"option\" },\n                { id: \"green-pl-nevsk\", text: \"🟩 Площадь Александра Невского-1\", action: \"selection\", target: \"pl_nevsk\", buttonType: \"option\" },\n                { id: \"green-elizarovskaya\", text: \"🟩 Елизаровская\", action: \"selection\", target: \"elizarovskaya\", buttonType: \"option\" },\n                { id: \"green-lomonosovskaya\", text: \"🟩 Ломоносовская\", action: \"selection\", target: \"lomonosovskaya\", buttonType: \"option\" },\n                { id: \"green-proletarskaya\", text: \"🟩 Пролетарская\", action: \"selection\", target: \"proletarskaya\", buttonType: \"option\" },\n                { id: \"green-obuhovo\", text: \"🟩 Обухово\", action: \"selection\", target: \"obuhovo\", buttonType: \"option\" },\n                { id: \"green-rybackoe\", text: \"🟩 Рыбацкое\", action: \"selection\", target: \"rybackoe\", buttonType: \"option\" },\n                { id: \"green-novokrestovsk\", text: \"🟩 Новокрестовская\", action: \"selection\", target: \"novokrestovsk\", buttonType: \"option\" },\n                { id: \"green-begovaya\", text: \"🟩 Беговая\", action: \"selection\", target: \"begovaya\", buttonType: \"option\" },\n                { id: \"btn-back-metro-green\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n              ],\n              markdown: false\n            }\n          },\n\n          // Оранжевая ветка (Правобережная) - станции\n          {\n            id: \"orange_line_stations\",\n            type: \"message\",\n            position: { x: 2700, y: 450 },\n            data: {\n              messageText: \"🟧 Правобережная линия\\n\\nВыбери свою станцию:\",\n              synonyms: [\"оранжевая линия\", \"правобережная\", \"оранжевая ветка\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"metro_stations\",\n              continueButtonTarget: \"interests_categories\",\n              buttons: [\n                { id: \"orange-spasskaya\", text: \"🟧 Спасская\", action: \"selection\", target: \"spasskaya\", buttonType: \"option\" },\n                { id: \"orange-dostoevskaya\", text: \"🟧 Достоевская\", action: \"selection\", target: \"dostoevskaya\", buttonType: \"option\" },\n                { id: \"orange-ligovsky\", text: \"🟧 Лиговский проспект\", action: \"selection\", target: \"ligovsky\", buttonType: \"option\" },\n                { id: \"orange-pl-nevsk2\", text: \"🟧 Площадь Александра Невского-2\", action: \"selection\", target: \"pl_nevsk2\", buttonType: \"option\" },\n                { id: \"orange-novocherk\", text: \"🟧 Новочеркасская\", action: \"selection\", target: \"novocherk\", buttonType: \"option\" },\n                { id: \"orange-ladozhskaya\", text: \"🟧 Ладожская\", action: \"selection\", target: \"ladozhskaya\", buttonType: \"option\" },\n                { id: \"orange-bolshevikov\", text: \"🟧 Проспект Большевиков\", action: \"selection\", target: \"bolshevikov\", buttonType: \"option\" },\n                { id: \"orange-dybenko\", text: \"🟧 Дыбенко\", action: \"selection\", target: \"dybenko\", buttonType: \"option\" },\n                { id: \"orange-gorny\", text: \"🟧 Горный институт\", action: \"selection\", target: \"gorny\", buttonType: \"option\" },\n                { id: \"btn-back-metro-orange\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n              ],\n              markdown: false\n            }\n          },\n\n          // Фиолетовая ветка (Фрунзенско-Приморская) - станции\n          {\n            id: \"purple_line_stations\",\n            type: \"message\",\n            position: { x: 3100, y: 450 },\n            data: {\n              messageText: \"🟪 Фрунзенско-Приморская линия\\n\\nВыбери свою станцию:\",\n              synonyms: [\"фиолетовая линия\", \"фрунзенско-приморская\", \"фиолетовая ветка\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"metro_stations\",\n              continueButtonTarget: \"interests_categories\",\n              buttons: [\n                { id: \"purple-komendantsky\", text: \"🟪 Комендантский проспект\", action: \"selection\", target: \"komendantsky\", buttonType: \"option\" },\n                { id: \"purple-staraya\", text: \"🟪 Старая Деревня\", action: \"selection\", target: \"staraya\", buttonType: \"option\" },\n                { id: \"purple-krestovsky\", text: \"🟪 Крестовский остров\", action: \"selection\", target: \"krestovsky\", buttonType: \"option\" },\n                { id: \"purple-chkalovskaya\", text: \"🟪 Чкаловская\", action: \"selection\", target: \"chkalovskaya\", buttonType: \"option\" },\n                { id: \"purple-sportivnaya\", text: \"🟪 Спортивная\", action: \"selection\", target: \"sportivnaya\", buttonType: \"option\" },\n                { id: \"purple-admiralteyskaya\", text: \"🟪 Адмиралтейская\", action: \"selection\", target: \"admiralteyskaya\", buttonType: \"option\" },\n                { id: \"purple-sadovaya\", text: \"🟪 Садовая\", action: \"selection\", target: \"sadovaya\", buttonType: \"option\" },\n                { id: \"purple-zvenigorodskaya\", text: \"🟪 Звенигородская\", action: \"selection\", target: \"zvenigorodskaya\", buttonType: \"option\" },\n                { id: \"purple-obvodniy\", text: \"🟪 Обводный канал\", action: \"selection\", target: \"obvodniy\", buttonType: \"option\" },\n                { id: \"purple-volkovskaya\", text: \"🟪 Волковская\", action: \"selection\", target: \"volkovskaya\", buttonType: \"option\" },\n                { id: \"purple-buharestskaya\", text: \"🟪 Бухарестская\", action: \"selection\", target: \"buharestskaya\", buttonType: \"option\" },\n                { id: \"purple-mezhdunar\", text: \"🟪 Международная\", action: \"selection\", target: \"mezhdunar\", buttonType: \"option\" },\n                { id: \"purple-slavy\", text: \"🟪 Проспект Славы\", action: \"selection\", target: \"slavy\", buttonType: \"option\" },\n                { id: \"purple-dunayskaya\", text: \"🟪 Дунайская\", action: \"selection\", target: \"dunayskaya\", buttonType: \"option\" },\n                { id: \"purple-shushary\", text: \"🟪 Шушары\", action: \"selection\", target: \"shushary\", buttonType: \"option\" },\n                { id: \"btn-back-metro-purple\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"interests_categories\",\n            type: \"message\",\n            position: { x: 500, y: 450 },\n            data: {\n              messageText: \"Выбери категории интересов 🎯:\",\n              keyboardType: \"inline\",\n              synonyms: [\"интересы\", \"хобби\", \"увлечения\", \"нравится\"],\n              buttons: [\n                {\n                  id: \"btn-hobby\",\n                  text: \"🎮 Хобби\",\n                  action: \"goto\",\n                  target: \"hobby_interests\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-social\",\n                  text: \"👥 Социальная жизнь\",\n                  action: \"goto\",\n                  target: \"social_interests\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-creativity\",\n                  text: \"🎨 Творчество\", \n                  action: \"goto\",\n                  target: \"creativity_interests\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-active\",\n                  text: \"🏃 Активный образ жизни\",\n                  action: \"goto\",\n                  target: \"active_interests\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-food\",\n                  text: \"🍕 Еда и напитки\",\n                  action: \"goto\",\n                  target: \"food_interests\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-sport\",\n                  text: \"⚽ Спорт\",\n                  action: \"goto\",\n                  target: \"sport_interests\",\n                  buttonType: \"option\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"hobby_interests\",\n            type: \"message\",\n            position: { x: 900, y: 450 },\n            data: {\n              messageText: \"Выбери интересы в категории 🎮 Хобби:\",\n              synonyms: [\"хобби\", \"увлечения\", \"занятия\", \"игры\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"user_interests\",\n              continueButtonTarget: \"marital_status\",\n              buttons: [\n                {\n                  id: \"hobby-games\",\n                  text: \"🎮 Компьютерные игры\",\n                  action: \"selection\",\n                  target: \"computer_games\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"hobby-fashion\",\n                  text: \"💄 Мода и красота\",\n                  action: \"selection\",\n                  target: \"fashion\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"hobby-cars\",\n                  text: \"🚗 Автомобили\",\n                  action: \"selection\",\n                  target: \"cars\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"hobby-it\",\n                  text: \"💻 IT и технологии\",\n                  action: \"selection\",\n                  target: \"it_tech\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"hobby-psychology\",\n                  text: \"🧠 Психология\",\n                  action: \"selection\",\n                  target: \"psychology\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"hobby-astrology\",\n                  text: \"🔮 Астрология\",\n                  action: \"selection\",\n                  target: \"astrology\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"hobby-meditation\",\n                  text: \"🧘 Медитации\",\n                  action: \"selection\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"hobby-books\",\n                  text: \"📚 Книги\",\n                  action: \"selection\",\n                  target: \"books\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"hobby-anime\",\n                  text: \"🌸 Аниме\",\n                  action: \"selection\",\n                  target: \"anime\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"hobby-crypto\",\n                  text: \"💰 Криптовалюты\",\n                  action: \"selection\",\n                  target: \"crypto\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-back-categories\",\n                  text: \"⬅️ К категориям\",\n                  action: \"goto\",\n                  target: \"interests_categories\",\n                  buttonType: \"navigation\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"social_interests\",\n            type: \"message\",\n            position: { x: 1300, y: 450 },\n            data: {\n              messageText: \"Выбери интересы в категории 👥 Социальная жизнь:\",\n              synonyms: [\"общение\", \"социальное\", \"люди\", \"тусовки\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"user_interests\",\n              continueButtonTarget: \"marital_status\",\n              buttons: [\n                {\n                  id: \"social-parties\",\n                  text: \"🎉 Вечеринки\",\n                  action: \"selection\",\n                  target: \"parties\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"social-networking\",\n                  text: \"🤝 Нетворкинг\",\n                  action: \"selection\",\n                  target: \"networking\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"social-dating\",\n                  text: \"💕 Знакомства\",\n                  action: \"selection\",\n                  target: \"dating\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"social-volunteering\",\n                  text: \"🤲 Волонтёрство\",\n                  action: \"selection\",\n                  target: \"volunteering\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"social-events\",\n                  text: \"🎪 Мероприятия\",\n                  action: \"selection\",\n                  target: \"events\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"social-community\",\n                  text: \"👥 Сообщества\",\n                  action: \"selection\",\n                  target: \"community\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-back-categories-social\",\n                  text: \"⬅️ К категориям\",\n                  action: \"goto\",\n                  target: \"interests_categories\",\n                  buttonType: \"navigation\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"creativity_interests\",\n            type: \"message\",\n            position: { x: 100, y: 650 },\n            data: {\n              messageText: \"Выбери интересы в категории 🎨 Творчество:\",\n              synonyms: [\"творчество\", \"искусство\", \"рисование\", \"музыка\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"user_interests\",\n              continueButtonTarget: \"marital_status\",\n              buttons: [\n                {\n                  id: \"creativity-art\",\n                  text: \"🎨 Рисование\",\n                  action: \"selection\",\n                  target: \"art\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"creativity-music\",\n                  text: \"🎵 Музыка\",\n                  action: \"selection\",\n                  target: \"music\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"creativity-photography\",\n                  text: \"📸 Фотография\",\n                  action: \"selection\",\n                  target: \"photography\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"creativity-writing\",\n                  text: \"✍️ Писательство\",\n                  action: \"selection\",\n                  target: \"writing\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"creativity-design\",\n                  text: \"🖌️ Дизайн\",\n                  action: \"selection\",\n                  target: \"design\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"creativity-handmade\",\n                  text: \"🧶 Рукоделие\",\n                  action: \"selection\",\n                  target: \"handmade\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"creativity-theater\",\n                  text: \"🎭 Театр\",\n                  action: \"selection\",\n                  target: \"theater\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-back-categories-creativity\",\n                  text: \"⬅️ К категориям\",\n                  action: \"goto\",\n                  target: \"interests_categories\",\n                  buttonType: \"navigation\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"active_interests\",\n            type: \"message\",\n            position: { x: 500, y: 650 },\n            data: {\n              messageText: \"Выбери интересы в категории 🏃 Активный образ жизни:\",\n              synonyms: [\"активность\", \"активный\", \"движение\", \"здоровье\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"user_interests\",\n              continueButtonTarget: \"marital_status\",\n              buttons: [\n                {\n                  id: \"active-running\",\n                  text: \"🏃 Бег\",\n                  action: \"selection\",\n                  target: \"running\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"active-gym\",\n                  text: \"💪 Тренажёрный зал\",\n                  action: \"selection\",\n                  target: \"gym\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"active-cycling\",\n                  text: \"🚴 Велосипед\",\n                  action: \"selection\",\n                  target: \"cycling\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"active-hiking\",\n                  text: \"🥾 Походы\",\n                  action: \"selection\",\n                  target: \"hiking\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"active-yoga\",\n                  text: \"🧘 Йога\",\n                  action: \"selection\",\n                  target: \"yoga\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"active-swimming\",\n                  text: \"🏊 Плавание\",\n                  action: \"selection\",\n                  target: \"swimming\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"active-dancing\",\n                  text: \"💃 Танцы\",\n                  action: \"selection\",\n                  target: \"dancing\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-back-categories-active\",\n                  text: \"⬅️ К категориям\",\n                  action: \"goto\",\n                  target: \"interests_categories\",\n                  buttonType: \"navigation\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"food_interests\",\n            type: \"message\",\n            position: { x: 900, y: 650 },\n            data: {\n              messageText: \"Выбери интересы в категории 🍕 Еда и напитки:\",\n              synonyms: [\"еда\", \"напитки\", \"кухня\", \"рестораны\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"user_interests\",\n              continueButtonTarget: \"marital_status\",\n              buttons: [\n                {\n                  id: \"food-cooking\",\n                  text: \"👨‍🍳 Готовка\",\n                  action: \"selection\",\n                  target: \"cooking\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"food-restaurants\",\n                  text: \"🍽️ Рестораны\",\n                  action: \"selection\",\n                  target: \"restaurants\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"food-wine\",\n                  text: \"🍷 Вино\",\n                  action: \"selection\",\n                  target: \"wine\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"food-coffee\",\n                  text: \"☕ Кофе\",\n                  action: \"selection\",\n                  target: \"coffee\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"food-baking\",\n                  text: \"🧁 Выпечка\",\n                  action: \"selection\",\n                  target: \"baking\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"food-street\",\n                  text: \"🌮 Стрит-фуд\",\n                  action: \"selection\",\n                  target: \"street_food\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"food-healthy\",\n                  text: \"🥗 Здоровое питание\",\n                  action: \"selection\",\n                  target: \"healthy_food\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-back-categories-food\",\n                  text: \"⬅️ К категориям\",\n                  action: \"goto\",\n                  target: \"interests_categories\",\n                  buttonType: \"navigation\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"sport_interests\",\n            type: \"message\",\n            position: { x: 1300, y: 650 },\n            data: {\n              messageText: \"Выбери интересы в категории ⚽ Спорт:\",\n              synonyms: [\"спорт\", \"фитнес\", \"тренировки\", \"футбол\"],\n              keyboardType: \"inline\",\n              allowMultipleSelection: true,\n              multiSelectVariable: \"user_interests\",\n              continueButtonTarget: \"marital_status\",\n              buttons: [\n                {\n                  id: \"sport-football\",\n                  text: \"⚽ Футбол\",\n                  action: \"selection\",\n                  target: \"football\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"sport-basketball\",\n                  text: \"🏀 Баскетбол\",\n                  action: \"selection\",\n                  target: \"basketball\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"sport-tennis\",\n                  text: \"🎾 Теннис\",\n                  action: \"selection\",\n                  target: \"tennis\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"sport-hockey\",\n                  text: \"🏒 Хоккей\",\n                  action: \"selection\",\n                  target: \"hockey\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"sport-volleyball\",\n                  text: \"🏐 Волейбол\",\n                  action: \"selection\",\n                  target: \"volleyball\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"sport-mma\",\n                  text: \"🥊 Единоборства\",\n                  action: \"selection\",\n                  target: \"mma\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"sport-esports\",\n                  text: \"🎮 Киберспорт\",\n                  action: \"selection\",\n                  target: \"esports\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-back-categories-sport\",\n                  text: \"⬅️ К категориям\",\n                  action: \"goto\",\n                  target: \"interests_categories\",\n                  buttonType: \"navigation\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"marital_status\",\n            type: \"message\",\n            position: { x: 1300, y: 450 },\n            data: {\n              messageText: \"Выбери семейное положение 💍:\",\n              keyboardType: \"inline\",\n              collectUserInput: true,\n              inputVariable: \"marital_status\",\n              synonyms: [\"семейное положение\", \"статус\", \"отношения\", \"семья\"],\n              buttons: [\n                {\n                  id: \"btn-single\",\n                  text: \"В активном поиске ❤️\",\n                  value: \"single\",\n                  action: \"goto\",\n                  target: \"sexual_orientation\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-relationship\",\n                  text: \"В отношениях 💕\",\n                  value: \"relationship\",\n                  action: \"goto\",\n                  target: \"sexual_orientation\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-married\",\n                  text: \"Женат/Замужем 💒\",\n                  value: \"married\",\n                  action: \"goto\",\n                  target: \"sexual_orientation\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-complicated\",\n                  text: \"Всё сложно 🤷\",\n                  value: \"complicated\",\n                  action: \"goto\",\n                  target: \"sexual_orientation\",\n                  buttonType: \"option\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: true,\n              resizeKeyboard: true\n            }\n          },\n\n          {\n            id: \"sexual_orientation\",\n            type: \"message\",\n            position: { x: 100, y: 650 },\n            data: {\n              messageText: \"Укажи свою сексуальную ориентацию 🌈:\",\n              keyboardType: \"inline\",\n              collectUserInput: true,\n              inputVariable: \"sexual_orientation\",\n              synonyms: [\"ориентация\", \"предпочтения\", \"кого ищу\"],\n              buttons: [\n                {\n                  id: \"btn-hetero\",\n                  text: \"Гетеро 👫\",\n                  value: \"hetero\",\n                  action: \"goto\",\n                  target: \"channel_choice\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-gay\",\n                  text: \"Гей 👬\",\n                  value: \"gay\",\n                  action: \"goto\",\n                  target: \"channel_choice\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-lesbian\",\n                  text: \"Лесби 👭\",\n                  value: \"lesbian\",\n                  action: \"goto\",\n                  target: \"channel_choice\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-bi\",\n                  text: \"Би 🌈\",\n                  value: \"bi\",\n                  action: \"goto\",\n                  target: \"channel_choice\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-other\",\n                  text: \"Другое 💫\",\n                  value: \"other\",\n                  action: \"goto\",\n                  target: \"channel_choice\",\n                  buttonType: \"option\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: true,\n              resizeKeyboard: true\n            }\n          },\n\n          {\n            id: \"channel_choice\",\n            type: \"message\",\n            position: { x: 500, y: 650 },\n            data: {\n              messageText: \"Хочешь указать свой телеграм-канал? 📢\\n\\nВведи ссылку, ник с @ или просто имя канала, либо нажми 'Пропустить':\",\n              keyboardType: \"inline\",\n              collectUserInput: true,\n              enableTextInput: true,\n              inputVariable: \"telegram_channel\",\n              synonyms: [\"тгк\", \"телеграм\", \"канал\", \"тг канал\"],\n              inputTargetNodeId: \"extra_info\",\n              buttons: [\n                {\n                  id: \"btn-skip-channel\",\n                  text: \"Пропустить ⏭️\",\n                  action: \"goto\",\n                  target: \"extra_info\",\n                  buttonType: \"option\",\n                  skipDataCollection: true\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"extra_info\",\n            type: \"message\",\n            position: { x: 1300, y: 650 },\n            data: {\n              messageText: \"Хочешь добавить что-то ещё о себе? 📝\\n\\nРасскажи о себе (до 2000 символов) или нажми 'Пропустить':\",\n              keyboardType: \"inline\",\n              collectUserInput: true,\n              enableTextInput: true,\n              inputVariable: \"extra_info\",\n              synonyms: [\"о себе\", \"описание\", \"расскажи\", \"инфо\"],\n              inputTargetNodeId: \"profile_complete\",\n              buttons: [\n                {\n                  id: \"btn-skip-extra\",\n                  text: \"Пропустить ⏭️\",\n                  action: \"goto\",\n                  target: \"profile_complete\",\n                  buttonType: \"option\",\n                  skipDataCollection: true\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"profile_complete\",\n            type: \"message\",\n            position: { x: 100, y: 850 },\n            data: {\n              messageText: \"🎉 Отлично! Твой профиль заполнен!\\n\\n👤 Твоя анкета:\\nПол: {gender}\\nИмя: {user_name}\\nВозраст: {user_age}\\nМетро: {metro_stations}\\nИнтересы: {user_interests}\\nСемейное положение: {marital_status}\\nОриентация: {sexual_orientation}\\n\\nМожешь посмотреть полную анкету или сразу получить ссылку на чат!\",\n              synonyms: [],\n              keyboardType: \"inline\",\n              removeKeyboard: false,\n              enableConditionalMessages: true,\n              conditionalMessages: [\n                {\n                  id: \"with_both\",\n                  condition: \"user_data_exists\",\n                  variableNames: [\"telegram_channel\", \"extra_info\"],\n                  messageText: \"🎉 Отлично! Твой профиль заполнен!\\n\\n👤 Твоя анкета:\\nПол: {gender}\\nИмя: {user_name}\\nВозраст: {user_age}\\nМетро: {metro_stations}\\nИнтересы: {user_interests}\\nСемейное положение: {marital_status}\\nОриентация: {sexual_orientation}\\nТелеграм: {telegram_channel} 📢\\nО себе: {extra_info} 📝\\n\\nМожешь посмотреть полную анкету или сразу получить ссылку на чат!\",\n                  formatMode: \"text\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-profile\",\n                      text: \"📋 Показать анкету\",\n                      action: \"command\",\n                      target: \"/profile\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-chat-link\",\n                      text: \"🔗 Получить ссылку на чат\",\n                      action: \"goto\",\n                      target: \"chat_link\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  priority: 1\n                },\n                {\n                  id: \"with_telegram_only\",\n                  condition: \"user_data_exists\",\n                  variableNames: [\"telegram_channel\"],\n                  messageText: \"🎉 Отлично! Твой профиль заполнен!\\n\\n👤 Твоя анкета:\\nПол: {gender}\\nИмя: {user_name}\\nВозраст: {user_age}\\nМетро: {metro_stations}\\nИнтересы: {user_interests}\\nСемейное положение: {marital_status}\\nОриентация: {sexual_orientation}\\nТелеграм: {telegram_channel} 📢\\n\\nМожешь посмотреть полную анкету или сразу получить ссылку на чат!\",\n                  formatMode: \"text\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-profile\",\n                      text: \"📋 Показать анкету\",\n                      action: \"command\",\n                      target: \"/profile\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-chat-link\",\n                      text: \"🔗 Получить ссылку на чат\",\n                      action: \"goto\",\n                      target: \"chat_link\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  priority: 2\n                },\n                {\n                  id: \"with_extra_only\",\n                  condition: \"user_data_exists\",\n                  variableNames: [\"extra_info\"],\n                  messageText: \"🎉 Отлично! Твой профиль заполнен!\\n\\n👤 Твоя анкета:\\nПол: {gender}\\nИмя: {user_name}\\nВозраст: {user_age}\\nМетро: {metro_stations}\\nИнтересы: {user_interests}\\nСемейное положение: {marital_status}\\nОриентация: {sexual_orientation}\\nО себе: {extra_info} 📝\\n\\nМожешь посмотреть полную анкету или сразу получить ссылку на чат!\",\n                  formatMode: \"text\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-profile\",\n                      text: \"📋 Показать анкету\",\n                      action: \"command\",\n                      target: \"/profile\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-chat-link\",\n                      text: \"🔗 Получить ссылку на чат\",\n                      action: \"goto\",\n                      target: \"chat_link\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  priority: 3\n                }\n              ],\n              buttons: [\n                {\n                  id: \"btn-profile\",\n                  text: \"📋 Показать анкету\",\n                  action: \"command\",\n                  target: \"/profile\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-chat-link\",\n                  text: \"🔗 Получить ссылку на чат\",\n                  action: \"goto\",\n                  target: \"chat_link\",\n                  buttonType: \"option\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"show_profile\",\n            type: \"command\",\n            position: { x: 500, y: 850 },\n            data: {\n              command: \"/profile\",\n              commandName: \"/profile\",\n              description: \"Показать и редактировать профиль пользователя\",\n              synonyms: [\"профиль\", \"анкета\", \"мой профиль\", \"посмотреть профиль\", \"редактировать профиль\"],\n              messageText: \"👤 Твой профиль:\\n\\nПол: {gender} 👤\\nИмя: {user_name} ✏️\\nВозраст: {user_age} 🎂\\nМетро: {metro_stations} 🚇\\nИнтересы: {user_interests} 🎯\\nСемейное положение: {marital_status} 💍\\nОриентация: {sexual_orientation} 🌈\\n\\n✏️ Выберите действие:\",\n              keyboardType: \"inline\",\n              enableConditionalMessages: true,\n              conditionalMessages: [\n                {\n                  id: \"with_both_show\",\n                  condition: \"user_data_exists\",\n                  variableNames: [\"telegram_channel\", \"extra_info\"],\n                  messageText: \"👤 Твой профиль:\\n\\nПол: {gender} 👤\\nИмя: {user_name} ✏️\\nВозраст: {user_age} 🎂\\nМетро: {metro_stations} 🚇\\nИнтересы: {user_interests} 🎯\\nСемейное положение: {marital_status} 💍\\nОриентация: {sexual_orientation} 🌈\\nТелеграм: {telegram_channel} 📢\\nО себе: {extra_info} 📝\\n\\n✏️ Выберите действие:\",\n                  formatMode: \"text\",\n                  keyboardType: \"inline\",\n                  buttons: [\n\n                    {\n                      id: \"btn-edit-gender\",\n                      text: \"👨👩 Изменить пол\",\n                      action: \"goto\",\n                      target: \"gender_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-name\",\n                      text: \"✏️ Изменить имя\",\n                      action: \"goto\",\n                      target: \"name_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-age\",\n                      text: \"🎂 Изменить возраст\",\n                      action: \"goto\",\n                      target: \"age_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-metro\",\n                      text: \"🚇 Изменить метро\",\n                      action: \"goto\",\n                      target: \"metro_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-interests\",\n                      text: \"🎯 Изменить интересы\",\n                      action: \"goto\",\n                      target: \"interests_categories\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-marital\",\n                      text: \"💍 Изменить семейное положение\",\n                      action: \"goto\",\n                      target: \"marital_status\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-orientation\",\n                      text: \"🌈 Изменить ориентацию\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-channel\",\n                      text: \"📢 Изменить ТГК\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-extra\",\n                      text: \"📝 Изменить о себе\",\n                      action: \"goto\",\n                      target: \"extra_info\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-restart-from-profile\",\n                      text: \"🔄 Начать заново\",\n                      action: \"command\",\n                      target: \"/start\",\n                      buttonType: \"navigation\"\n                    }\n                  ],\n                  priority: 1\n                },\n                {\n                  id: \"with_telegram_show\",\n                  condition: \"user_data_exists\",\n                  variableNames: [\"telegram_channel\"],\n                  messageText: \"👤 Твой профиль:\\n\\nПол: {gender} 👤\\nИмя: {user_name} ✏️\\nВозраст: {user_age} 🎂\\nМетро: {metro_stations} 🚇\\nИнтересы: {user_interests} 🎯\\nСемейное положение: {marital_status} 💍\\nОриентация: {sexual_orientation} 🌈\\nТелеграм: {telegram_channel} 📢\\n\\n✏️ Выберите действие:\",\n                  formatMode: \"text\",\n                  keyboardType: \"inline\",\n                  buttons: [\n\n                    {\n                      id: \"btn-edit-gender\",\n                      text: \"👨👩 Изменить пол\",\n                      action: \"goto\",\n                      target: \"gender_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-name\",\n                      text: \"✏️ Изменить имя\",\n                      action: \"goto\",\n                      target: \"name_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-age\",\n                      text: \"🎂 Изменить возраст\",\n                      action: \"goto\",\n                      target: \"age_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-metro\",\n                      text: \"🚇 Изменить метро\",\n                      action: \"goto\",\n                      target: \"metro_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-interests\",\n                      text: \"🎯 Изменить интересы\",\n                      action: \"goto\",\n                      target: \"interests_categories\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-marital\",\n                      text: \"💍 Изменить семейное положение\",\n                      action: \"goto\",\n                      target: \"marital_status\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-orientation\",\n                      text: \"🌈 Изменить ориентацию\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-channel\",\n                      text: \"📢 Изменить ТГК\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-extra\",\n                      text: \"📝 Добавить о себе\",\n                      action: \"goto\",\n                      target: \"extra_info\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-restart-from-profile\",\n                      text: \"🔄 Начать заново\",\n                      action: \"command\",\n                      target: \"/start\",\n                      buttonType: \"navigation\"\n                    }\n                  ],\n                  priority: 2\n                },\n                {\n                  id: \"with_extra_show\",\n                  condition: \"user_data_exists\",\n                  variableNames: [\"extra_info\"],\n                  messageText: \"👤 Твой профиль:\\n\\nПол: {gender} 👤\\nИмя: {user_name} ✏️\\nВозраст: {user_age} 🎂\\nМетро: {metro_stations} 🚇\\nИнтересы: {user_interests} 🎯\\nСемейное положение: {marital_status} 💍\\nОриентация: {sexual_orientation} 🌈\\nО себе: {extra_info} 📝\\n\\n✏️ Выберите действие:\",\n                  formatMode: \"text\",\n                  keyboardType: \"inline\",\n                  buttons: [\n\n                    {\n                      id: \"btn-edit-gender\",\n                      text: \"👨👩 Изменить пол\",\n                      action: \"goto\",\n                      target: \"gender_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-name\",\n                      text: \"✏️ Изменить имя\",\n                      action: \"goto\",\n                      target: \"name_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-age\",\n                      text: \"🎂 Изменить возраст\",\n                      action: \"goto\",\n                      target: \"age_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-metro\",\n                      text: \"🚇 Изменить метро\",\n                      action: \"goto\",\n                      target: \"metro_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-interests\",\n                      text: \"🎯 Изменить интересы\",\n                      action: \"goto\",\n                      target: \"interests_categories\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-marital\",\n                      text: \"💍 Изменить семейное положение\",\n                      action: \"goto\",\n                      target: \"marital_status\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-orientation\",\n                      text: \"🌈 Изменить ориентацию\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-channel\",\n                      text: \"📢 Указать ТГК\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-extra\",\n                      text: \"📝 Изменить о себе\",\n                      action: \"goto\",\n                      target: \"extra_info\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-restart-from-profile\",\n                      text: \"🔄 Начать заново\",\n                      action: \"command\",\n                      target: \"/start\",\n                      buttonType: \"navigation\"\n                    }\n                  ],\n                  priority: 3\n                }\n              ],\n              buttons: [\n                {\n                  id: \"btn-edit-gender\",\n                  text: \"👨👩 Изменить пол\",\n                  action: \"goto\",\n                  target: \"gender_selection\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-edit-name\",\n                  text: \"✏️ Изменить имя\",\n                  action: \"goto\",\n                  target: \"name_input\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-edit-age\",\n                  text: \"🎂 Изменить возраст\",\n                  action: \"goto\",\n                  target: \"age_input\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-edit-metro\",\n                  text: \"🚇 Изменить метро\",\n                  action: \"goto\",\n                  target: \"metro_selection\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-edit-interests\",\n                  text: \"🎯 Изменить интересы\",\n                  action: \"goto\",\n                  target: \"interests_categories\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-edit-marital\",\n                  text: \"💍 Изменить семейное положение\",\n                  action: \"goto\",\n                  target: \"marital_status\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-edit-orientation\",\n                  text: \"🌈 Изменить ориентацию\",\n                  action: \"goto\",\n                  target: \"sexual_orientation\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-edit-channel\",\n                  text: \"📢 Указать ТГК\",\n                  action: \"goto\",\n                  target: \"channel_choice\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-edit-extra\",\n                  text: \"📝 Добавить о себе\",\n                  action: \"goto\",\n                  target: \"extra_info\",\n                  buttonType: \"option\"\n                },\n                {\n                  id: \"btn-restart-from-profile\",\n                  text: \"🔄 Начать заново\",\n                  action: \"command\",\n                  target: \"/start\",\n                  buttonType: \"navigation\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"chat_link\",\n            type: \"command\",\n            position: { x: 900, y: 850 },\n            data: {\n              command: \"/link\",\n              commandName: \"/link\",\n              description: \"Получить ссылку на чат сообщества\",\n              synonyms: [\"ссылка\", \"чат\", \"сообщество\", \"впрогулке\", \"линк\"],\n              messageText: \"🔗 Актуальная ссылка на чат:\\n\\nhttps://t.me/+agkIVgCzHtY2ZTA6\\n\\nДобро пожаловать в сообщество ᴠᴨᴩᴏᴦʏᴧᴋᴇ! 🎉\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-back-profile\",\n                  text: \"⬅️ Назад к анкете\",\n                  action: \"command\",\n                  target: \"/profile\",\n                  buttonType: \"navigation\"\n                },\n                {\n                  id: \"btn-restart\",\n                  text: \"🔄 Начать заново\",\n                  action: \"command\",\n                  target: \"/start\",\n                  buttonType: \"navigation\"\n                }\n              ],\n              markdown: false\n            }\n          },\n\n          {\n            id: \"help_command\",\n            type: \"command\",\n            position: { x: 1300, y: 850 },\n            data: {\n              command: \"/help\",\n              commandName: \"/help\",\n              description: \"Помощь и список всех команд с синонимами\",\n              synonyms: [\"помощь\", \"справка\", \"команды\", \"что писать\", \"как пользоваться\"],\n              messageText: \"🤖 **Добро пожаловать в справочный центр!**\\n\\n🌟 **ᴠᴨᴩᴏᴦʏᴧᴋᴇ Bot**\\n*Твой помощник в знакомствах*\\n\\n\\n🎯 **ОСНОВНЫЕ КОМАНДЫ**\\n\\n🚀 **Start** — Начать заново\\n   📝 *старт, начать, привет, начало, начинаем*\\n\\n👤 **Profile** — Мой профиль\\n   📝 *профиль, анкета, мой профиль, посмотреть профиль*\\n\\n🔗 **Link** — Ссылка на чат\\n   📝 *ссылка, чат, сообщество, впрогулке, линк*\\n\\n🆘 **Help** — Эта справка\\n   📝 *помощь, справка, команды, что писать*\\n\\n\\n📋 **ЗАПОЛНЕНИЕ АНКЕТЫ**\\n\\n👫 **Пол** — мужской, женский\\n🏷️ **Имя** — любое имя\\n🎂 **Возраст** — число от 18 до 99\\n🚇 **Метро** — выбор линии и станции\\n\\n🎨 **ИНТЕРЕСЫ**\\n🎮 Хобби • 🤝 Социальная жизнь • 🎭 Творчество\\n💪 Активность • 🍕 Еда • ⚽ Спорт\\n\\n💑 **СЕМЕЙНОЕ ПОЛОЖЕНИЕ**\\nПоиск • Отношения • Женат/Замужем • Сложно\\n\\n🌈 **ОРИЕНТАЦИЯ**\\nГетеро • Гей • Лесби • Би • Другое\\n\\n📺 **ТЕЛЕГРАМ-КАНАЛ** (опционально)\\n📖 **О СЕБЕ** — дополнительная информация\\n\\n\\n💡 **ПОЛЕЗНЫЕ СОВЕТЫ**\\n\\n✨ Пишите команды или синонимы в любом месте\\n✨ Бот поймет сообщения даже без команд\\n✨ Используйте /start для начала заново\\n✨ Используйте /profile для изменения данных\\n\\n🎉 **Удачных знакомств в Питере!**\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-help-start\",\n                  text: \"🚀 Начать заполнение\",\n                  action: \"command\",\n                  target: \"/start\",\n                  buttonType: \"navigation\"\n                },\n                {\n                  id: \"btn-help-profile\",\n                  text: \"👤 Мой профиль\",\n                  action: \"command\",\n                  target: \"/profile\",\n                  buttonType: \"navigation\"\n                },\n                {\n                  id: \"btn-help-link\",\n                  text: \"🔗 Ссылка на чат\",\n                  action: \"command\",\n                  target: \"/link\",\n                  buttonType: \"navigation\"\n                }\n              ],\n              markdown: true\n            }\n          }\n        ],\n        connections: [\n          {\n            id: \"conn-1\",\n            sourceNodeId: \"start\",\n            targetNodeId: \"join_request\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-2\",\n            sourceNodeId: \"join_request\",\n            targetNodeId: \"gender_selection\",\n            sourceHandle: \"btn-yes\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-3\",\n            sourceNodeId: \"join_request\",\n            targetNodeId: \"decline_response\",\n            sourceHandle: \"btn-no\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-4\",\n            sourceNodeId: \"gender_selection\",\n            targetNodeId: \"name_input\",\n            sourceHandle: \"btn-male\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-5\",\n            sourceNodeId: \"gender_selection\",\n            targetNodeId: \"name_input\",\n            sourceHandle: \"btn-female\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-6\",\n            sourceNodeId: \"name_input\",\n            targetNodeId: \"age_input\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-7\",\n            sourceNodeId: \"age_input\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          // Connections from metro_selection to different line stations\n          {\n            id: \"conn-8a\",\n            sourceNodeId: \"metro_selection\", \n            targetNodeId: \"red_line_stations\",\n            sourceHandle: \"btn-red\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8b\",\n            sourceNodeId: \"metro_selection\",\n            targetNodeId: \"blue_line_stations\", \n            sourceHandle: \"btn-blue\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8c\",\n            sourceNodeId: \"metro_selection\",\n            targetNodeId: \"green_line_stations\",\n            sourceHandle: \"btn-green\", \n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8d\",\n            sourceNodeId: \"metro_selection\",\n            targetNodeId: \"orange_line_stations\",\n            sourceHandle: \"btn-orange\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8e\",\n            sourceNodeId: \"metro_selection\",\n            targetNodeId: \"purple_line_stations\",\n            sourceHandle: \"btn-purple\",\n            targetHandle: \"target\"\n          },\n          // Direct connections to interests for ЛО and non-SPb users\n          {\n            id: \"conn-8f\",\n            sourceNodeId: \"metro_selection\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-lo\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8g\",\n            sourceNodeId: \"metro_selection\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-not-spb\",\n            targetHandle: \"target\"\n          },\n          // Back connections from station nodes to metro selection\n          {\n            id: \"conn-8h\",\n            sourceNodeId: \"red_line_stations\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"btn-back-metro\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8i\",\n            sourceNodeId: \"blue_line_stations\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"btn-back-metro-blue\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8j\",\n            sourceNodeId: \"green_line_stations\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"btn-back-metro-green\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8k\",\n            sourceNodeId: \"orange_line_stations\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"btn-back-metro-orange\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8l\",\n            sourceNodeId: \"purple_line_stations\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"btn-back-metro-purple\",\n            targetHandle: \"target\"\n          },\n          // Forward connections from station nodes to interests\n          {\n            id: \"conn-8m\",\n            sourceNodeId: \"red_line_stations\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8n\",\n            sourceNodeId: \"blue_line_stations\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8o\",\n            sourceNodeId: \"green_line_stations\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8p\",\n            sourceNodeId: \"orange_line_stations\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-8q\",\n            sourceNodeId: \"purple_line_stations\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-9\",\n            sourceNodeId: \"interests_categories\",\n            targetNodeId: \"hobby_interests\",\n            sourceHandle: \"btn-hobby\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-10\",\n            sourceNodeId: \"hobby_interests\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-back-categories\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-11\",\n            sourceNodeId: \"hobby_interests\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-30\",\n            sourceNodeId: \"interests_categories\",\n            targetNodeId: \"social_interests\",\n            sourceHandle: \"btn-social\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-31\",\n            sourceNodeId: \"social_interests\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-back-categories-social\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-32\",\n            sourceNodeId: \"social_interests\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-33\",\n            sourceNodeId: \"interests_categories\",\n            targetNodeId: \"creativity_interests\",\n            sourceHandle: \"btn-creativity\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-34\",\n            sourceNodeId: \"creativity_interests\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-back-categories-creativity\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-35\",\n            sourceNodeId: \"creativity_interests\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-36\",\n            sourceNodeId: \"interests_categories\",\n            targetNodeId: \"active_interests\",\n            sourceHandle: \"btn-active\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-37\",\n            sourceNodeId: \"active_interests\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-back-categories-active\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-38\",\n            sourceNodeId: \"active_interests\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-39\",\n            sourceNodeId: \"interests_categories\",\n            targetNodeId: \"food_interests\",\n            sourceHandle: \"btn-food\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-40\",\n            sourceNodeId: \"food_interests\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-back-categories-food\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-41\",\n            sourceNodeId: \"food_interests\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-42\",\n            sourceNodeId: \"interests_categories\",\n            targetNodeId: \"sport_interests\",\n            sourceHandle: \"btn-sport\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-43\",\n            sourceNodeId: \"sport_interests\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-back-categories-sport\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-44\",\n            sourceNodeId: \"sport_interests\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-12\",\n            sourceNodeId: \"marital_status\",\n            targetNodeId: \"sexual_orientation\",\n            sourceHandle: \"btn-single\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-13\",\n            sourceNodeId: \"marital_status\",\n            targetNodeId: \"sexual_orientation\",\n            sourceHandle: \"btn-relationship\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-14\",\n            sourceNodeId: \"marital_status\",\n            targetNodeId: \"sexual_orientation\",\n            sourceHandle: \"btn-married\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-15\",\n            sourceNodeId: \"marital_status\",\n            targetNodeId: \"sexual_orientation\",\n            sourceHandle: \"btn-complicated\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-16\",\n            sourceNodeId: \"sexual_orientation\",\n            targetNodeId: \"channel_choice\",\n            sourceHandle: \"btn-hetero\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-17\",\n            sourceNodeId: \"sexual_orientation\",\n            targetNodeId: \"channel_choice\",\n            sourceHandle: \"btn-gay\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-18\",\n            sourceNodeId: \"sexual_orientation\",\n            targetNodeId: \"channel_choice\",\n            sourceHandle: \"btn-lesbian\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-19\",\n            sourceNodeId: \"sexual_orientation\",\n            targetNodeId: \"channel_choice\",\n            sourceHandle: \"btn-bi\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-20\",\n            sourceNodeId: \"sexual_orientation\",\n            targetNodeId: \"channel_choice\",\n            sourceHandle: \"btn-other\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-21\",\n            sourceNodeId: \"channel_choice\",\n            targetNodeId: \"extra_info\",\n            sourceHandle: \"btn-skip-channel\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-22\",\n            sourceNodeId: \"channel_choice\",\n            targetNodeId: \"extra_info\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-24\",\n            sourceNodeId: \"extra_info\",\n            targetNodeId: \"profile_complete\",\n            sourceHandle: \"btn-skip-extra\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-25\",\n            sourceNodeId: \"extra_info\",\n            targetNodeId: \"profile_complete\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-27\",\n            sourceNodeId: \"profile_complete\",\n            targetNodeId: \"chat_link\",\n            sourceHandle: \"btn-chat-link\",\n            targetHandle: \"target\"\n          },\n          // Connections for profile editing buttons\n          {\n            id: \"conn-edit-1\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"gender_selection\",\n            sourceHandle: \"btn-edit-gender\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-edit-2\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"name_input\",\n            sourceHandle: \"btn-edit-name\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-edit-3\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"age_input\",\n            sourceHandle: \"btn-edit-age\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-edit-4\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"btn-edit-metro\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-edit-5\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-edit-interests\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-edit-6\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"btn-edit-marital\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-edit-7\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"sexual_orientation\",\n            sourceHandle: \"btn-edit-orientation\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-edit-8\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"channel_choice\",\n            sourceHandle: \"btn-edit-channel\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"conn-edit-9\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"extra_info\",\n            sourceHandle: \"btn-edit-extra\",\n            targetHandle: \"target\"\n          }\n        ]\n      }\n    });\n\n    console.log('✅ Шаблон VProgulke Bot создан');\n\n    // Создаем шаблон с многолистовой структурой и навигацией\n    await storage.createBotTemplate({\n      name: \"🏢 Многолистовой бизнес-бот\",\n      description: \"Демонстрация многолистовой структуры с разными разделами: услуги, прайс, портфолио и контакты\",\n      category: \"business\",\n      tags: [\"многолистовой\", \"навигация\", \"бизнес\", \"меню\", \"структура\", \"разделы\"],\n      isPublic: 1,\n      difficulty: \"medium\",\n      authorName: \"Система\",\n      version: \"1.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 6,\n      estimatedTime: 25,\n      data: {\n        sheets: [\n          {\n            id: \"main_sheet\",\n            name: \"Главное меню\",\n            nodes: [\n              {\n                id: \"start\",\n                type: \"start\",\n                position: { x: 400, y: 100 },\n                data: {\n                  command: \"/start\",\n                  description: \"Приветствие и главное меню\",\n                  messageText: \"🏢 Добро пожаловать в нашу компанию!\\n\\nМы предоставляем профессиональные услуги в области IT-разработки.\\n\\nВыберите интересующий вас раздел:\",\n                  synonyms: [\"старт\", \"начать\", \"меню\", \"главная\"],\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-services\",\n                      text: \"💼 Наши услуги\",\n                      action: \"goto\",\n                      target: \"services_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-portfolio\",\n                      text: \"📁 Портфолио\",\n                      action: \"goto\", \n                      target: \"portfolio_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-pricing\",\n                      text: \"💰 Прайс-лист\",\n                      action: \"goto\",\n                      target: \"pricing_main\", \n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-contacts\",\n                      text: \"📞 Контакты\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-about\",\n                      text: \"ℹ️ О компании\",\n                      action: \"goto\",\n                      target: \"about_company\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: false,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"about_company\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"ℹ️ О нашей компании:\\n\\n🔹 Работаем на рынке с 2018 года\\n🔹 Команда из 15+ опытных разработчиков\\n🔹 Более 200 успешно реализованных проектов\\n🔹 Полный цикл разработки от идеи до запуска\\n🔹 Поддержка проектов 24/7\\n\\nНаша миссия - создавать качественные IT-решения, которые помогают бизнесу расти и развиваться.\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-main\",\n                      text: \"⬅️ Главное меню\",\n                      action: \"goto\",\n                      target: \"start\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false\n                }\n              }\n            ],\n            connections: [\n              {\n                id: \"conn-start-services\",\n                source: \"start\",\n                target: \"services_main\",\n                sourceHandle: \"btn-services\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-start-portfolio\", \n                source: \"start\",\n                target: \"portfolio_main\",\n                sourceHandle: \"btn-portfolio\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-start-pricing\",\n                source: \"start\", \n                target: \"pricing_main\",\n                sourceHandle: \"btn-pricing\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-start-contacts\",\n                source: \"start\",\n                target: \"contacts_main\", \n                sourceHandle: \"btn-contacts\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-start-about\",\n                source: \"start\",\n                target: \"about_company\",\n                sourceHandle: \"btn-about\", \n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-about-main\",\n                source: \"about_company\",\n                target: \"start\",\n                sourceHandle: \"btn-back-main\",\n                targetHandle: \"target\"\n              }\n            ],\n            viewState: {\n              position: { x: 0, y: 0 },\n              zoom: 1\n            }\n          },\n          {\n            id: \"services_sheet\",\n            name: \"Услуги\",\n            nodes: [\n              {\n                id: \"services_main\",\n                type: \"message\",\n                position: { x: 400, y: 100 },\n                data: {\n                  messageText: \"💼 Наши услуги:\\n\\nМы предлагаем полный спектр IT-услуг для вашего бизнеса.\\n\\nВыберите интересующую категорию:\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-web-dev\",\n                      text: \"🌐 Веб-разработка\",\n                      action: \"goto\",\n                      target: \"web_development\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-mobile-dev\",\n                      text: \"📱 Мобильная разработка\",\n                      action: \"goto\", \n                      target: \"mobile_development\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-design\",\n                      text: \"🎨 Дизайн\",\n                      action: \"goto\",\n                      target: \"design_services\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-consulting\",\n                      text: \"🧠 IT-консалтинг\",\n                      action: \"goto\",\n                      target: \"consulting\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-back-services\",\n                      text: \"⬅️ Главное меню\",\n                      action: \"goto\",\n                      target: \"start\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"web_development\",\n                type: \"message\",\n                position: { x: 100, y: 300 },\n                data: {\n                  messageText: \"🌐 Веб-разработка:\\n\\n✅ Корпоративные сайты\\n✅ Интернет-магазины\\n✅ Веб-приложения\\n✅ CRM и ERP системы\\n✅ API разработка\\n✅ Поддержка и развитие\\n\\nТехнологии: React, Vue.js, Node.js, Python, PHP\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-services-web\",\n                      text: \"⬅️ Назад к услугам\",\n                      action: \"goto\",\n                      target: \"services_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-consultation-web\",\n                      text: \"📞 Получить консультацию\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"mobile_development\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"📱 Мобильная разработка:\\n\\n✅ Нативные iOS приложения\\n✅ Нативные Android приложения\\n✅ Кроссплатформенные решения\\n✅ Игры для мобильных устройств\\n✅ Интеграция с внешними сервисами\\n✅ Публикация в App Store и Google Play\\n\\nТехнологии: Swift, Kotlin, React Native, Flutter\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-services-mobile\",\n                      text: \"⬅️ Назад к услугам\",\n                      action: \"goto\",\n                      target: \"services_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-consultation-mobile\",\n                      text: \"📞 Получить консультацию\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"design_services\",\n                type: \"message\",\n                position: { x: 700, y: 300 },\n                data: {\n                  messageText: \"🎨 Дизайн услуги:\\n\\n✅ UI/UX дизайн веб-сайтов\\n✅ Дизайн мобильных приложений\\n✅ Брендинг и фирменный стиль\\n✅ Логотипы и графика\\n✅ Анимация и видео\\n✅ Прототипирование\\n\\nИнструменты: Figma, Adobe Creative Suite, Sketch\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-services-design\",\n                      text: \"⬅️ Назад к услугам\",\n                      action: \"goto\",\n                      target: \"services_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-portfolio-design\",\n                      text: \"📁 Смотреть портфолио\",\n                      action: \"goto\",\n                      target: \"portfolio_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"consulting\",\n                type: \"message\",\n                position: { x: 1000, y: 300 },\n                data: {\n                  messageText: \"🧠 IT-консалтинг:\\n\\n✅ Аудит текущих IT-решений\\n✅ Планирование цифровой трансформации\\n✅ Выбор технологий\\n✅ Архитектурное планирование\\n✅ Оптимизация бизнес-процессов\\n✅ Обучение команды\\n\\nПоможем выбрать наилучшие решения для вашего бизнеса!\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-services-consulting\",\n                      text: \"⬅️ Назад к услугам\",\n                      action: \"goto\",\n                      target: \"services_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-consultation-consulting\",\n                      text: \"📞 Получить консультацию\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false\n                }\n              }\n            ],\n            connections: [\n              {\n                id: \"conn-services-web\",\n                source: \"services_main\",\n                target: \"web_development\",\n                sourceHandle: \"btn-web-dev\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-services-mobile\",\n                source: \"services_main\",\n                target: \"mobile_development\",\n                sourceHandle: \"btn-mobile-dev\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-services-design\",\n                source: \"services_main\",\n                target: \"design_services\",\n                sourceHandle: \"btn-design\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-services-consulting\",\n                source: \"services_main\",\n                target: \"consulting\",\n                sourceHandle: \"btn-consulting\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-web-back\",\n                source: \"web_development\",\n                target: \"services_main\",\n                sourceHandle: \"btn-back-services-web\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-mobile-back\",\n                source: \"mobile_development\",\n                target: \"services_main\",\n                sourceHandle: \"btn-back-services-mobile\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-design-back\",\n                source: \"design_services\",\n                target: \"services_main\",\n                sourceHandle: \"btn-back-services-design\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-consulting-back\",\n                source: \"consulting\",\n                target: \"services_main\",\n                sourceHandle: \"btn-back-services-consulting\",\n                targetHandle: \"target\"\n              }\n            ],\n            viewState: {\n              position: { x: 0, y: 0 },\n              zoom: 1\n            }\n          },\n          {\n            id: \"portfolio_sheet\", \n            name: \"Портфолио\",\n            nodes: [\n              {\n                id: \"portfolio_main\",\n                type: \"message\",\n                position: { x: 400, y: 100 },\n                data: {\n                  messageText: \"📁 Наше портфолио:\\n\\nМы гордимся нашими работами и рады показать примеры успешных проектов.\\n\\nВыберите категорию проектов:\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-web-portfolio\",\n                      text: \"🌐 Веб-проекты\",\n                      action: \"goto\",\n                      target: \"web_portfolio\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-mobile-portfolio\",\n                      text: \"📱 Мобильные приложения\",\n                      action: \"goto\",\n                      target: \"mobile_portfolio\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-design-portfolio\",\n                      text: \"🎨 Дизайн-проекты\",\n                      action: \"goto\",\n                      target: \"design_portfolio\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-back-portfolio\",\n                      text: \"⬅️ Главное меню\",\n                      action: \"goto\",\n                      target: \"start\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"web_portfolio\",\n                type: \"message\",\n                position: { x: 100, y: 300 },\n                data: {\n                  messageText: \"🌐 Веб-проекты:\\n\\n🔹 **ТехноМарт** - Интернет-магазин электроники\\n   • React + Node.js\\n   • 10,000+ товаров\\n   • Интеграция с 1С\\n\\n🔹 **МедКлиника Плюс** - Система записи к врачам\\n   • Vue.js + Python\\n   • Онлайн-консультации\\n   • Система уведомлений\\n\\n🔹 **LogiTrans** - CRM для логистической компании\\n   • Angular + .NET\\n   • Трекинг грузов\\n   • Автоматизация процессов\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-portfolio-web\",\n                      text: \"⬅️ Назад к портфолио\",\n                      action: \"goto\",\n                      target: \"portfolio_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-consultation-portfolio\",\n                      text: \"📞 Обсудить проект\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              },\n              {\n                id: \"mobile_portfolio\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"📱 Мобильные приложения:\\n\\n🔹 **FitTracker** - Фитнес-трекер (iOS/Android)\\n   • React Native\\n   • 50,000+ скачиваний\\n   • Интеграция с умными часами\\n\\n🔹 **BankSecure** - Банковское приложение\\n   • Native iOS/Android\\n   • Биометрическая аутентификация\\n   • Push-уведомления\\n\\n🔹 **DeliveryFast** - Доставка еды\\n   • Flutter\\n   • Геолокация\\n   • Онлайн-платежи\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-portfolio-mobile\",\n                      text: \"⬅️ Назад к портфолио\",\n                      action: \"goto\",\n                      target: \"portfolio_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-consultation-mobile-portfolio\",\n                      text: \"📞 Обсудить проект\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              },\n              {\n                id: \"design_portfolio\",\n                type: \"message\",\n                position: { x: 700, y: 300 },\n                data: {\n                  messageText: \"🎨 Дизайн-проекты:\\n\\n🔹 **EcoStyle** - Брендинг эко-магазина\\n   • Логотип и фирменный стиль\\n   • Дизайн упаковки\\n   • Веб-дизайн\\n\\n🔹 **StartupHub** - UI/UX для стартап-платформы\\n   • Пользовательский интерфейс\\n   • Мобильная версия\\n   • Система иконок\\n\\n🔹 **RestaurantChain** - Дизайн сети ресторанов\\n   • Меню и интерьер\\n   • Мобильное приложение\\n   • Маркетинговые материалы\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-portfolio-design\",\n                      text: \"⬅️ Назад к портфолио\",\n                      action: \"goto\",\n                      target: \"portfolio_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-consultation-design-portfolio\",\n                      text: \"📞 Обсудить проект\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              }\n            ],\n            connections: [\n              {\n                id: \"conn-portfolio-web\",\n                source: \"portfolio_main\",\n                target: \"web_portfolio\",\n                sourceHandle: \"btn-web-portfolio\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-portfolio-mobile\",\n                source: \"portfolio_main\",\n                target: \"mobile_portfolio\",\n                sourceHandle: \"btn-mobile-portfolio\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-portfolio-design\",\n                source: \"portfolio_main\",\n                target: \"design_portfolio\",\n                sourceHandle: \"btn-design-portfolio\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-web-portfolio-back\",\n                source: \"web_portfolio\",\n                target: \"portfolio_main\",\n                sourceHandle: \"btn-back-portfolio-web\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-mobile-portfolio-back\",\n                source: \"mobile_portfolio\",\n                target: \"portfolio_main\",\n                sourceHandle: \"btn-back-portfolio-mobile\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-design-portfolio-back\",\n                source: \"design_portfolio\",\n                target: \"portfolio_main\",\n                sourceHandle: \"btn-back-portfolio-design\",\n                targetHandle: \"target\"\n              }\n            ],\n            viewState: {\n              position: { x: 0, y: 0 },\n              zoom: 1\n            }\n          },\n          {\n            id: \"pricing_sheet\",\n            name: \"Прайс-лист\",\n            nodes: [\n              {\n                id: \"pricing_main\",\n                type: \"message\",\n                position: { x: 400, y: 100 },\n                data: {\n                  messageText: \"💰 Прайс-лист:\\n\\nПрозрачные цены на наши услуги. Стоимость может варьироваться в зависимости от сложности проекта.\\n\\nВыберите интересующую категорию:\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-web-pricing\",\n                      text: \"🌐 Веб-разработка\",\n                      action: \"goto\",\n                      target: \"web_pricing\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-mobile-pricing\",\n                      text: \"📱 Мобильные приложения\",\n                      action: \"goto\",\n                      target: \"mobile_pricing\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-design-pricing\",\n                      text: \"🎨 Дизайн\",\n                      action: \"goto\",\n                      target: \"design_pricing\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-packages\",\n                      text: \"📦 Готовые пакеты\",\n                      action: \"goto\",\n                      target: \"pricing_packages\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-back-pricing\",\n                      text: \"⬅️ Главное меню\",\n                      action: \"goto\",\n                      target: \"start\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"web_pricing\",\n                type: \"message\",\n                position: { x: 100, y: 300 },\n                data: {\n                  messageText: \"🌐 Веб-разработка - цены:\\n\\n💼 **Корпоративный сайт**\\n   • Лендинг: от 50,000₽\\n   • Многостраничный: от 120,000₽\\n   • С админкой: от 180,000₽\\n\\n🛒 **Интернет-магазин**\\n   • Простой: от 200,000₽\\n   • Средней сложности: от 400,000₽\\n   • Крупный маркетплейс: от 800,000₽\\n\\n🔧 **Веб-приложение**\\n   • CRM/ERP: от 500,000₽\\n   • SaaS платформа: от 1,000,000₽\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-pricing-web\",\n                      text: \"⬅️ Назад к прайсу\",\n                      action: \"goto\",\n                      target: \"pricing_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-calculate-web\",\n                      text: \"🧮 Рассчитать стоимость\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              },\n              {\n                id: \"mobile_pricing\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"📱 Мобильные приложения - цены:\\n\\n📲 **iOS / Android (нативные)**\\n   • Простое приложение: от 300,000₽\\n   • Среднее по сложности: от 600,000₽\\n   • Сложное приложение: от 1,200,000₽\\n\\n🔄 **Кроссплатформенные**\\n   • React Native: от 250,000₽\\n   • Flutter: от 280,000₽\\n\\n🎮 **Игры**\\n   • Простая игра: от 400,000₽\\n   • Игра средней сложности: от 800,000₽\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-pricing-mobile\",\n                      text: \"⬅️ Назад к прайсу\",\n                      action: \"goto\",\n                      target: \"pricing_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-calculate-mobile\",\n                      text: \"🧮 Рассчитать стоимость\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              },\n              {\n                id: \"design_pricing\",\n                type: \"message\",\n                position: { x: 700, y: 300 },\n                data: {\n                  messageText: \"🎨 Дизайн - цены:\\n\\n🎯 **UI/UX дизайн**\\n   • Лендинг: от 30,000₽\\n   • Сайт (5-10 страниц): от 60,000₽\\n   • Приложение: от 80,000₽\\n\\n🏷️ **Брендинг**\\n   • Логотип: от 20,000₽\\n   • Фирменный стиль: от 50,000₽\\n   • Полный ребрендинг: от 150,000₽\\n\\n📱 **Мобильный дизайн**\\n   • Прототип: от 40,000₽\\n   • Полный дизайн: от 100,000₽\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-pricing-design\",\n                      text: \"⬅️ Назад к прайсу\",\n                      action: \"goto\",\n                      target: \"pricing_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-calculate-design\",\n                      text: \"🧮 Рассчитать стоимость\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              },\n              {\n                id: \"pricing_packages\",\n                type: \"message\",\n                position: { x: 1000, y: 300 },\n                data: {\n                  messageText: \"📦 Готовые пакеты:\\n\\n🚀 **СТАРТАП** - 150,000₽\\n   • Лендинг + дизайн\\n   • Мобильная версия\\n   • Базовая SEO\\n   • 3 месяца поддержки\\n\\n💼 **БИЗНЕС** - 400,000₽\\n   • Корпоративный сайт\\n   • Админ-панель\\n   • Интеграции\\n   • 6 месяцев поддержки\\n\\n🏢 **ENTERPRISE** - 1,000,000₽\\n   • Полнофункциональная платформа\\n   • Мобильные приложения\\n   • Интеграция с системами\\n   • Год поддержки + развитие\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-pricing-packages\",\n                      text: \"⬅️ Назад к прайсу\",\n                      action: \"goto\",\n                      target: \"pricing_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-choose-package\",\n                      text: \"✅ Выбрать пакет\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              }\n            ],\n            connections: [\n              {\n                id: \"conn-pricing-web\",\n                source: \"pricing_main\",\n                target: \"web_pricing\",\n                sourceHandle: \"btn-web-pricing\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-pricing-mobile\",\n                source: \"pricing_main\",\n                target: \"mobile_pricing\",\n                sourceHandle: \"btn-mobile-pricing\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-pricing-design\",\n                source: \"pricing_main\",\n                target: \"design_pricing\",\n                sourceHandle: \"btn-design-pricing\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-pricing-packages\",\n                source: \"pricing_main\",\n                target: \"pricing_packages\",\n                sourceHandle: \"btn-packages\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-web-pricing-back\",\n                source: \"web_pricing\",\n                target: \"pricing_main\",\n                sourceHandle: \"btn-back-pricing-web\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-mobile-pricing-back\",\n                source: \"mobile_pricing\",\n                target: \"pricing_main\",\n                sourceHandle: \"btn-back-pricing-mobile\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-design-pricing-back\",\n                source: \"design_pricing\",\n                target: \"pricing_main\",\n                sourceHandle: \"btn-back-pricing-design\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-packages-pricing-back\",\n                source: \"pricing_packages\",\n                target: \"pricing_main\",\n                sourceHandle: \"btn-back-pricing-packages\",\n                targetHandle: \"target\"\n              }\n            ],\n            viewState: {\n              position: { x: 0, y: 0 },\n              zoom: 1\n            }\n          },\n          {\n            id: \"contacts_sheet\",\n            name: \"Контакты\",\n            nodes: [\n              {\n                id: \"contacts_main\",\n                type: \"message\",\n                position: { x: 400, y: 100 },\n                data: {\n                  messageText: \"📞 Наши контакты:\\n\\n🏢 **Адрес офиса:**\\nг. Москва, ул. Тверская, д. 15, офис 401\\n\\n📧 **Email:**\\ninfo@itcompany.ru\\n\\n📱 **Телефон:**\\n+7 (495) 123-45-67\\n\\n🕒 **Время работы:**\\nПн-Пт: 9:00 - 18:00\\nСб-Вс: выходные\\n\\nВыберите удобный способ связи:\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-call-request\",\n                      text: \"📞 Заказать звонок\",\n                      action: \"goto\",\n                      target: \"call_request\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-consultation\",\n                      text: \"💬 Бесплатная консультация\",\n                      action: \"goto\",\n                      target: \"consultation_form\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-social-links\",\n                      text: \"🌐 Мы в соцсетях\",\n                      action: \"goto\",\n                      target: \"social_links\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-back-contacts\",\n                      text: \"⬅️ Главное меню\",\n                      action: \"goto\",\n                      target: \"start\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              },\n              {\n                id: \"call_request\",\n                type: \"message\",\n                position: { x: 100, y: 300 },\n                data: {\n                  messageText: \"📞 Заказать обратный звонок:\\n\\nОставьте ваш номер телефона, и мы перезвоним в течение 30 минут в рабочее время.\\n\\nУкажите ваш номер телефона:\",\n                  keyboardType: \"none\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"phone_number\",\n                  inputTargetNodeId: \"call_confirmation\",\n                  inputType: \"phone\",\n                  inputValidation: \"^\\\\+?[1-9]\\\\d{1,14}$\",\n                  inputRetryMessage: \"Пожалуйста, введите корректный номер телефона\",\n                  markdown: false\n                }\n              },\n              {\n                id: \"call_confirmation\",\n                type: \"message\",\n                position: { x: 100, y: 500 },\n                data: {\n                  messageText: \"✅ Спасибо! Ваша заявка принята.\\n\\nНомер телефона: {phone_number}\\n\\nМы перезвоним вам в ближайшее время!\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-contacts-call\",\n                      text: \"⬅️ К контактам\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-main-menu-call\",\n                      text: \"🏠 Главное меню\",\n                      action: \"goto\",\n                      target: \"start\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"consultation_form\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"💬 Бесплатная консультация:\\n\\nОпишите ваш проект или задачу, и мы предложим оптимальное решение.\\n\\nРасскажите о вашем проекте:\",\n                  keyboardType: \"none\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"project_description\",\n                  inputTargetNodeId: \"consultation_contact\",\n                  inputType: \"text\",\n                  minLength: 10,\n                  maxLength: 2000,\n                  inputRetryMessage: \"Пожалуйста, опишите ваш проект подробнее (минимум 10 символов)\",\n                  markdown: false\n                }\n              },\n              {\n                id: \"consultation_contact\",\n                type: \"message\",\n                position: { x: 400, y: 500 },\n                data: {\n                  messageText: \"Отлично! Теперь укажите ваш контактный телефон для связи:\",\n                  keyboardType: \"none\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"consultation_phone\",\n                  inputTargetNodeId: \"consultation_confirmation\",\n                  inputType: \"phone\",\n                  inputValidation: \"^\\\\+?[1-9]\\\\d{1,14}$\",\n                  inputRetryMessage: \"Пожалуйста, введите корректный номер телефона\",\n                  markdown: false\n                }\n              },\n              {\n                id: \"consultation_confirmation\",\n                type: \"message\",\n                position: { x: 400, y: 700 },\n                data: {\n                  messageText: \"🎉 Заявка на консультацию отправлена!\\n\\n📝 **Описание проекта:**\\n{project_description}\\n\\n📞 **Контактный телефон:**\\n{consultation_phone}\\n\\nНаш специалист свяжется с вами в течение 2 часов для обсуждения деталей.\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-contacts-consultation\",\n                      text: \"⬅️ К контактам\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-main-menu-consultation\",\n                      text: \"🏠 Главное меню\",\n                      action: \"goto\",\n                      target: \"start\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              },\n              {\n                id: \"social_links\",\n                type: \"message\",\n                position: { x: 700, y: 300 },\n                data: {\n                  messageText: \"🌐 Мы в социальных сетях:\\n\\n📘 **ВКонтакте:** vk.com/itcompany\\n📸 **Instagram:** @itcompany_official\\n💼 **LinkedIn:** IT Company\\n📹 **YouTube:** IT Company Channel\\n💬 **Telegram:** @itcompany_chat\\n\\nПодписывайтесь на наши каналы и следите за новостями и полезными материалами!\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-back-contacts-social\",\n                      text: \"⬅️ К контактам\",\n                      action: \"goto\",\n                      target: \"contacts_main\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: true\n                }\n              }\n            ],\n            connections: [\n              {\n                id: \"conn-contacts-call\",\n                source: \"contacts_main\",\n                target: \"call_request\",\n                sourceHandle: \"btn-call-request\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-contacts-consultation\",\n                source: \"contacts_main\",\n                target: \"consultation_form\",\n                sourceHandle: \"btn-consultation\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-contacts-social\",\n                source: \"contacts_main\",\n                target: \"social_links\",\n                sourceHandle: \"btn-social-links\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-call-confirmation\",\n                source: \"call_request\",\n                target: \"call_confirmation\",\n                sourceHandle: \"input-phone\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-consultation-contact\",\n                source: \"consultation_form\",\n                target: \"consultation_contact\",\n                sourceHandle: \"input-description\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-consultation-confirmation\",\n                source: \"consultation_contact\",\n                target: \"consultation_confirmation\",\n                sourceHandle: \"input-phone\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-call-back-contacts\",\n                source: \"call_confirmation\",\n                target: \"contacts_main\",\n                sourceHandle: \"btn-back-contacts-call\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-consultation-back-contacts\",\n                source: \"consultation_confirmation\",\n                target: \"contacts_main\",\n                sourceHandle: \"btn-back-contacts-consultation\",\n                targetHandle: \"target\"\n              },\n              {\n                id: \"conn-social-back-contacts\",\n                source: \"social_links\",\n                target: \"contacts_main\",\n                sourceHandle: \"btn-back-contacts-social\",\n                targetHandle: \"target\"\n              }\n            ],\n            viewState: {\n              position: { x: 0, y: 0 },\n              zoom: 1\n            }\n          }\n        ],\n        // Межлистовые соединения\n        interSheetConnections: [\n          {\n            id: \"inter-main-services\",\n            sourceSheetId: \"main_sheet\",\n            targetSheetId: \"services_sheet\", \n            sourceNodeId: \"start\",\n            targetNodeId: \"services_main\",\n            sourceHandle: \"btn-services\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-main-portfolio\",\n            sourceSheetId: \"main_sheet\",\n            targetSheetId: \"portfolio_sheet\",\n            sourceNodeId: \"start\", \n            targetNodeId: \"portfolio_main\",\n            sourceHandle: \"btn-portfolio\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-main-pricing\",\n            sourceSheetId: \"main_sheet\",\n            targetSheetId: \"pricing_sheet\",\n            sourceNodeId: \"start\",\n            targetNodeId: \"pricing_main\",\n            sourceHandle: \"btn-pricing\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-main-contacts\",\n            sourceSheetId: \"main_sheet\", \n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"start\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-contacts\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-services-main\",\n            sourceSheetId: \"services_sheet\",\n            targetSheetId: \"main_sheet\",\n            sourceNodeId: \"services_main\",\n            targetNodeId: \"start\",\n            sourceHandle: \"btn-back-services\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-portfolio-main\",\n            sourceSheetId: \"portfolio_sheet\",\n            targetSheetId: \"main_sheet\",\n            sourceNodeId: \"portfolio_main\",\n            targetNodeId: \"start\",\n            sourceHandle: \"btn-back-portfolio\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-pricing-main\",\n            sourceSheetId: \"pricing_sheet\",\n            targetSheetId: \"main_sheet\",\n            sourceNodeId: \"pricing_main\",\n            targetNodeId: \"start\",\n            sourceHandle: \"btn-back-pricing\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-contacts-main\",\n            sourceSheetId: \"contacts_sheet\",\n            targetSheetId: \"main_sheet\",\n            sourceNodeId: \"contacts_main\",\n            targetNodeId: \"start\",\n            sourceHandle: \"btn-back-contacts\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-services-contacts\",\n            sourceSheetId: \"services_sheet\",\n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"web_development\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-consultation-web\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-services-contacts-mobile\",\n            sourceSheetId: \"services_sheet\",\n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"mobile_development\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-consultation-mobile\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-services-portfolio\",\n            sourceSheetId: \"services_sheet\",\n            targetSheetId: \"portfolio_sheet\",\n            sourceNodeId: \"design_services\",\n            targetNodeId: \"portfolio_main\",\n            sourceHandle: \"btn-portfolio-design\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-services-contacts-consulting\",\n            sourceSheetId: \"services_sheet\",\n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"consulting\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-consultation-consulting\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-portfolio-contacts\",\n            sourceSheetId: \"portfolio_sheet\",\n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"web_portfolio\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-consultation-portfolio\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-portfolio-contacts-mobile\",\n            sourceSheetId: \"portfolio_sheet\",\n            targetSheetId: \"contacts_sheet\", \n            sourceNodeId: \"mobile_portfolio\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-consultation-mobile-portfolio\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-portfolio-contacts-design\",\n            sourceSheetId: \"portfolio_sheet\",\n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"design_portfolio\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-consultation-design-portfolio\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-pricing-contacts-web\",\n            sourceSheetId: \"pricing_sheet\",\n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"web_pricing\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-calculate-web\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-pricing-contacts-mobile\",\n            sourceSheetId: \"pricing_sheet\",\n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"mobile_pricing\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-calculate-mobile\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-pricing-contacts-design\",\n            sourceSheetId: \"pricing_sheet\",\n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"design_pricing\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-calculate-design\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-pricing-contacts-packages\",\n            sourceSheetId: \"pricing_sheet\",\n            targetSheetId: \"contacts_sheet\",\n            sourceNodeId: \"pricing_packages\",\n            targetNodeId: \"contacts_main\",\n            sourceHandle: \"btn-choose-package\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-contacts-main-call\",\n            sourceSheetId: \"contacts_sheet\",\n            targetSheetId: \"main_sheet\",\n            sourceNodeId: \"call_confirmation\",\n            targetNodeId: \"start\",\n            sourceHandle: \"btn-main-menu-call\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-contacts-main-consultation\",\n            sourceSheetId: \"contacts_sheet\",\n            targetSheetId: \"main_sheet\",\n            sourceNodeId: \"consultation_confirmation\",\n            targetNodeId: \"start\",\n            sourceHandle: \"btn-main-menu-consultation\",\n            targetHandle: \"target\"\n          }\n        ]\n      }\n    });\n\n    console.log('✅ Шаблон многолистовой структуры создан');\n\n    // Создаем новый многолистовой шаблон ВПрогулке\n    await storage.createBotTemplate({\n      name: \"🌟 ВПрогулке Multi-Sheet - Знакомства СПб\",\n      description: \"Многолистовая версия бота знакомств с разделением на логические разделы: знакомство, метро, интересы, личная информация и профиль\",\n      category: \"community\",\n      tags: [\"знакомства\", \"многолистовой\", \"метро\", \"интересы\", \"СПб\", \"анкета\", \"навигация\"],\n      isPublic: 1,\n      difficulty: \"hard\",\n      authorName: \"Система\",\n      version: \"4.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 9,\n      estimatedTime: 50,\n      data: {\n        sheets: [\n          // Лист 1: Приветствие и основная информация\n          {\n            id: \"welcome_sheet\",\n            name: \"🎉 Приветствие\",\n            nodes: [\n              {\n                id: \"start\",\n                type: \"start\",\n                position: { x: 400, y: 100 },\n                data: {\n                  command: \"/start\",\n                  description: \"Приветствие и источник\",\n                  messageText: \"🌟 Привет от ᴠᴨᴩᴏᴦʏᴧᴋᴇ Bot!\\n\\nЭтот бот поможет тебе найти интересных людей в Санкт-Петербурге!\\n\\nОткуда ты узнал о нашем чате? 😎\",\n                  synonyms: [\"старт\", \"начать\", \"привет\", \"начало\", \"начинаем\"],\n                  keyboardType: \"none\",\n                  buttons: [],\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"user_source\",\n                  inputTargetNodeId: \"join_request\",\n                  markdown: false,\n                  oneTimeKeyboard: false,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"join_request\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"Хочешь присоединиться к нашему чату? 🚀\",\n                  synonyms: [],\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"join_request_response\",\n                  buttons: [\n                    {\n                      id: \"btn-yes\",\n                      text: \"Да 😎\",\n                      value: \"yes\",\n                      action: \"goto\",\n                      target: \"gender_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-no\", \n                      text: \"Нет 🙅\",\n                      value: \"no\",\n                      action: \"goto\",\n                      target: \"decline_response\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"decline_response\",\n                type: \"message\",\n                position: { x: 400, y: 500 },\n                data: {\n                  messageText: \"Понятно! Если передумаешь, напиши /start! 😊\",\n                  synonyms: [],\n                  keyboardType: \"none\",\n                  removeKeyboard: true,\n                  buttons: [],\n                  markdown: false\n                }\n              }\n            ]\n          },\n\n          // Лист 2: Основная информация (пол, имя, возраст)\n          {\n            id: \"basic_info_sheet\", \n            name: \"👤 Основная информация\",\n            nodes: [\n              {\n                id: \"gender_selection\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"Укажи свой пол: 👨👩\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"gender\",\n                  synonyms: [\"пол\", \"гендер\", \"мужчина\", \"женщина\"],\n                  buttons: [\n                    {\n                      id: \"btn-male\",\n                      text: \"Мужчина 👨\",\n                      value: \"male\",\n                      action: \"goto\",\n                      target: \"name_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-female\",\n                      text: \"Женщина 👩\",\n                      value: \"female\", \n                      action: \"goto\",\n                      target: \"name_input\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"name_input\",\n                type: \"message\",\n                position: { x: 400, y: 500 },\n                data: {\n                  messageText: \"Как тебя зовут? ✏️\\n\\nНапиши своё имя в сообщении:\",\n                  keyboardType: \"none\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"user_name\",\n                  synonyms: [\"имя\", \"зовут\", \"называют\", \"как зовут\"],\n                  inputTargetNodeId: \"age_input\",\n                  buttons: [],\n                  markdown: false\n                }\n              },\n              {\n                id: \"age_input\",\n                type: \"message\",\n                position: { x: 400, y: 700 },\n                data: {\n                  messageText: \"Сколько тебе лет? 🎂\\n\\nНапиши свой возраст числом (например, 25):\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"user_age\",\n                  synonyms: [\"возраст\", \"лет\", \"годы\", \"сколько лет\"],\n                  inputTargetNodeId: \"metro_selection\",\n                  buttons: [],\n                  markdown: false\n                }\n              },\n            ]\n          },\n\n          // Лист 3: Метро и местоположение\n          {\n            id: \"metro_sheet\",\n            name: \"🚇 Метро и местоположение\",\n            nodes: [\n              {\n                id: \"metro_selection\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"На какой станции метро ты обычно бываешь? 🚇\\n\\nВыбери свою ветку:\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"metro_stations\",\n                  synonyms: [\"метро\", \"станция\", \"где живу\", \"район\"],\n                  buttons: [\n                    {\n                      id: \"btn-red\",\n                      text: \"Красная ветка 🟥\",\n                      action: \"goto\",\n                      target: \"red_line_stations\",\n                      buttonType: \"option\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-blue\",\n                      text: \"Синяя ветка 🟦\",\n                      action: \"goto\", \n                      target: \"blue_line_stations\",\n                      buttonType: \"option\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-green\",\n                      text: \"Зелёная ветка 🟩\",\n                      action: \"goto\",\n                      target: \"green_line_stations\",\n                      buttonType: \"option\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-orange\",\n                      text: \"Оранжевая ветка 🟧\",\n                      action: \"goto\",\n                      target: \"orange_line_stations\",\n                      buttonType: \"option\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-purple\",\n                      text: \"Фиолетовая ветка 🟪\",\n                      action: \"goto\",\n                      target: \"purple_line_stations\",\n                      buttonType: \"option\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-lo\",\n                      text: \"Я из ЛО 🏡\",\n                      value: \"ЛО\",\n                      action: \"goto\",\n                      target: \"interests_categories\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-not-spb\",\n                      text: \"Я не в Питере 🌍\",\n                      value: \"Не в СПб\",\n                      action: \"goto\",\n                      target: \"interests_categories\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"red_line_stations\",\n                type: \"message\",\n                position: { x: 100, y: 500 },\n                data: {\n                  messageText: \"🟥 Кировско-Выборгская линия\\n\\nВыбери свою станцию:\",\n                  synonyms: [\"красная линия\", \"кировско-выборгская\", \"красная ветка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"metro_stations\",\n                  continueButtonTarget: \"interests_categories\",\n                  buttons: [\n                    { id: \"red-devyatkino\", text: \"🟥 Девяткино\", action: \"selection\", target: \"devyatkino\", buttonType: \"option\" },\n                    { id: \"red-grazhdansky\", text: \"🟥 Гражданский проспект\", action: \"selection\", target: \"grazhdansky\", buttonType: \"option\" },\n                    { id: \"red-akademicheskaya\", text: \"🟥 Академическая\", action: \"selection\", target: \"akademicheskaya\", buttonType: \"option\" },\n                    { id: \"red-politehnicheskaya\", text: \"🟥 Политехническая\", action: \"selection\", target: \"politehnicheskaya\", buttonType: \"option\" },\n                    { id: \"red-pl-muzhestva\", text: \"🟥 Площадь Мужества\", action: \"selection\", target: \"pl_muzhestva\", buttonType: \"option\" },\n                    { id: \"red-lesnaya\", text: \"🟥 Лесная\", action: \"selection\", target: \"lesnaya\", buttonType: \"option\" },\n                    { id: \"red-vyborgskaya\", text: \"🟥 Выборгская\", action: \"selection\", target: \"vyborgskaya\", buttonType: \"option\" },\n                    { id: \"red-pl-lenina\", text: \"🟥 Площадь Ленина\", action: \"selection\", target: \"pl_lenina\", buttonType: \"option\" },\n                    { id: \"red-chernyshevskaya\", text: \"🟥 Чернышевская\", action: \"selection\", target: \"chernyshevskaya\", buttonType: \"option\" },\n                    { id: \"red-pl-vosstaniya\", text: \"🟥 Площадь Восстания\", action: \"selection\", target: \"pl_vosstaniya\", buttonType: \"option\" },\n                    { id: \"red-vladimirskaya\", text: \"🟥 Владимирская\", action: \"selection\", target: \"vladimirskaya\", buttonType: \"option\" },\n                    { id: \"red-pushkinskaya\", text: \"🟥 Пушкинская\", action: \"selection\", target: \"pushkinskaya\", buttonType: \"option\" },\n                    { id: \"red-tehinstitut1\", text: \"🟥 Технологический институт-1\", action: \"selection\", target: \"tehinstitut1\", buttonType: \"option\" },\n                    { id: \"red-baltiyskaya\", text: \"🟥 Балтийская\", action: \"selection\", target: \"baltiyskaya\", buttonType: \"option\" },\n                    { id: \"red-narvskaya\", text: \"🟥 Нарвская\", action: \"selection\", target: \"narvskaya\", buttonType: \"option\" },\n                    { id: \"red-kirovsky\", text: \"🟥 Кировский завод\", action: \"selection\", target: \"kirovsky\", buttonType: \"option\" },\n                    { id: \"red-avtovo\", text: \"🟥 Автово\", action: \"selection\", target: \"avtovo\", buttonType: \"option\" },\n                    { id: \"red-leninsky\", text: \"🟥 Ленинский проспект\", action: \"selection\", target: \"leninsky\", buttonType: \"option\" },\n                    { id: \"red-veteranov\", text: \"🟥 Проспект Ветеранов\", action: \"selection\", target: \"veteranov\", buttonType: \"option\" },\n                    { id: \"btn-back-metro\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"blue_line_stations\",\n                type: \"message\",\n                position: { x: 700, y: 500 },\n                data: {\n                  messageText: \"🟦 Московско-Петроградская линия\\n\\nВыбери свою станцию:\",\n                  synonyms: [\"синяя линия\", \"московско-петроградская\", \"синяя ветка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"metro_stations\",\n                  continueButtonTarget: \"interests_categories\",\n                  buttons: [\n                    { id: \"blue-parnas\", text: \"🟦 Парнас\", action: \"selection\", target: \"parnas\", buttonType: \"option\" },\n                    { id: \"blue-prosp-prosvesh\", text: \"🟦 Проспект Просвещения\", action: \"selection\", target: \"prosp_prosvesh\", buttonType: \"option\" },\n                    { id: \"blue-ozerki\", text: \"🟦 Озерки\", action: \"selection\", target: \"ozerki\", buttonType: \"option\" },\n                    { id: \"blue-udelnaya\", text: \"🟦 Удельная\", action: \"selection\", target: \"udelnaya\", buttonType: \"option\" },\n                    { id: \"blue-pionerskaya\", text: \"🟦 Пионерская\", action: \"selection\", target: \"pionerskaya\", buttonType: \"option\" },\n                    { id: \"blue-chernaya\", text: \"🟦 Черная речка\", action: \"selection\", target: \"chernaya\", buttonType: \"option\" },\n                    { id: \"blue-petrogradskaya\", text: \"🟦 Петроградская\", action: \"selection\", target: \"petrogradskaya\", buttonType: \"option\" },\n                    { id: \"blue-gorkovskaya\", text: \"🟦 Горьковская\", action: \"selection\", target: \"gorkovskaya\", buttonType: \"option\" },\n                    { id: \"blue-nevsky\", text: \"🟦 Невский проспект\", action: \"selection\", target: \"nevsky\", buttonType: \"option\" },\n                    { id: \"blue-sennaya\", text: \"🟦 Сенная площадь\", action: \"selection\", target: \"sennaya\", buttonType: \"option\" },\n                    { id: \"blue-tehinstitut2\", text: \"🟦 Технологический институт-2\", action: \"selection\", target: \"tehinstitut2\", buttonType: \"option\" },\n                    { id: \"blue-frunzenskaya\", text: \"🟦 Фрунзенская\", action: \"selection\", target: \"frunzenskaya\", buttonType: \"option\" },\n                    { id: \"blue-mosk-vorota\", text: \"🟦 Московские ворота\", action: \"selection\", target: \"mosk_vorota\", buttonType: \"option\" },\n                    { id: \"blue-elektrosila\", text: \"🟦 Электросила\", action: \"selection\", target: \"elektrosila\", buttonType: \"option\" },\n                    { id: \"blue-park-pobedy\", text: \"🟦 Парк Победы\", action: \"selection\", target: \"park_pobedy\", buttonType: \"option\" },\n                    { id: \"blue-moskovskaya\", text: \"🟦 Московская\", action: \"selection\", target: \"moskovskaya\", buttonType: \"option\" },\n                    { id: \"blue-zvezdnaya\", text: \"🟦 Звездная\", action: \"selection\", target: \"zvezdnaya\", buttonType: \"option\" },\n                    { id: \"blue-kupchino\", text: \"🟦 Купчино\", action: \"selection\", target: \"kupchino\", buttonType: \"option\" },\n                    { id: \"btn-back-metro-blue\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"green_line_stations\",\n                type: \"message\",\n                position: { x: 1000, y: 500 },\n                data: {\n                  messageText: \"🟩 Невско-Василеостровская линия\\n\\nВыбери свою станцию:\",\n                  synonyms: [\"зеленая линия\", \"невско-василеостровская\", \"зеленая ветка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"metro_stations\",\n                  continueButtonTarget: \"interests_categories\",\n                  buttons: [\n                    { id: \"green-primorskaya\", text: \"🟩 Приморская\", action: \"selection\", target: \"primorskaya\", buttonType: \"option\" },\n                    { id: \"green-vasileostr\", text: \"🟩 Василеостровская\", action: \"selection\", target: \"vasileostr\", buttonType: \"option\" },\n                    { id: \"green-gostiny\", text: \"🟩 Гостиный двор\", action: \"selection\", target: \"gostiny\", buttonType: \"option\" },\n                    { id: \"green-mayakovskaya\", text: \"🟩 Маяковская\", action: \"selection\", target: \"mayakovskaya\", buttonType: \"option\" },\n                    { id: \"green-pl-nevsk\", text: \"🟩 Площадь Александра Невского-1\", action: \"selection\", target: \"pl_nevsk\", buttonType: \"option\" },\n                    { id: \"green-elizarovskaya\", text: \"🟩 Елизаровская\", action: \"selection\", target: \"elizarovskaya\", buttonType: \"option\" },\n                    { id: \"green-lomonosovskaya\", text: \"🟩 Ломоносовская\", action: \"selection\", target: \"lomonosovskaya\", buttonType: \"option\" },\n                    { id: \"green-proletarskaya\", text: \"🟩 Пролетарская\", action: \"selection\", target: \"proletarskaya\", buttonType: \"option\" },\n                    { id: \"green-obuhovo\", text: \"🟩 Обухово\", action: \"selection\", target: \"obuhovo\", buttonType: \"option\" },\n                    { id: \"green-rybackoe\", text: \"🟩 Рыбацкое\", action: \"selection\", target: \"rybackoe\", buttonType: \"option\" },\n                    { id: \"green-novokrestovsk\", text: \"🟩 Новокрестовская\", action: \"selection\", target: \"novokrestovsk\", buttonType: \"option\" },\n                    { id: \"green-begovaya\", text: \"🟩 Беговая\", action: \"selection\", target: \"begovaya\", buttonType: \"option\" },\n                    { id: \"btn-back-metro-green\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"orange_line_stations\",\n                type: \"message\",\n                position: { x: 1300, y: 500 },\n                data: {\n                  messageText: \"🟧 Правобережная линия\\n\\nВыбери свою станцию:\",\n                  synonyms: [\"оранжевая линия\", \"правобережная\", \"оранжевая ветка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"metro_stations\",\n                  continueButtonTarget: \"interests_categories\",\n                  buttons: [\n                    { id: \"orange-spasskaya\", text: \"🟧 Спасская\", action: \"selection\", target: \"spasskaya\", buttonType: \"option\" },\n                    { id: \"orange-dostoevskaya\", text: \"🟧 Достоевская\", action: \"selection\", target: \"dostoevskaya\", buttonType: \"option\" },\n                    { id: \"orange-ligovsky\", text: \"🟧 Лиговский проспект\", action: \"selection\", target: \"ligovsky\", buttonType: \"option\" },\n                    { id: \"orange-pl-nevsk2\", text: \"🟧 Площадь Александра Невского-2\", action: \"selection\", target: \"pl_nevsk2\", buttonType: \"option\" },\n                    { id: \"orange-novocherk\", text: \"🟧 Новочеркасская\", action: \"selection\", target: \"novocherk\", buttonType: \"option\" },\n                    { id: \"orange-ladozhskaya\", text: \"🟧 Ладожская\", action: \"selection\", target: \"ladozhskaya\", buttonType: \"option\" },\n                    { id: \"orange-bolshevikov\", text: \"🟧 Проспект Большевиков\", action: \"selection\", target: \"bolshevikov\", buttonType: \"option\" },\n                    { id: \"orange-dybenko\", text: \"🟧 Дыбенко\", action: \"selection\", target: \"dybenko\", buttonType: \"option\" },\n                    { id: \"orange-gorny\", text: \"🟧 Горный институт\", action: \"selection\", target: \"gorny\", buttonType: \"option\" },\n                    { id: \"btn-back-metro-orange\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"purple_line_stations\",\n                type: \"message\",\n                position: { x: 1600, y: 500 },\n                data: {\n                  messageText: \"🟪 Фрунзенско-Приморская линия\\n\\nВыбери свою станцию:\",\n                  synonyms: [\"фиолетовая линия\", \"фрунзенско-приморская\", \"фиолетовая ветка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"metro_stations\",\n                  continueButtonTarget: \"interests_categories\",\n                  buttons: [\n                    { id: \"purple-komendantsky\", text: \"🟪 Комендантский проспект\", action: \"selection\", target: \"komendantsky\", buttonType: \"option\" },\n                    { id: \"purple-staraya\", text: \"🟪 Старая Деревня\", action: \"selection\", target: \"staraya\", buttonType: \"option\" },\n                    { id: \"purple-krestovsky\", text: \"🟪 Крестовский остров\", action: \"selection\", target: \"krestovsky\", buttonType: \"option\" },\n                    { id: \"purple-chkalovskaya\", text: \"🟪 Чкаловская\", action: \"selection\", target: \"chkalovskaya\", buttonType: \"option\" },\n                    { id: \"purple-sportivnaya\", text: \"🟪 Спортивная\", action: \"selection\", target: \"sportivnaya\", buttonType: \"option\" },\n                    { id: \"purple-admiralteyskaya\", text: \"🟪 Адмиралтейская\", action: \"selection\", target: \"admiralteyskaya\", buttonType: \"option\" },\n                    { id: \"purple-sadovaya\", text: \"🟪 Садовая\", action: \"selection\", target: \"sadovaya\", buttonType: \"option\" },\n                    { id: \"purple-zvenigorodskaya\", text: \"🟪 Звенигородская\", action: \"selection\", target: \"zvenigorodskaya\", buttonType: \"option\" },\n                    { id: \"purple-obvodniy\", text: \"🟪 Обводный канал\", action: \"selection\", target: \"obvodniy\", buttonType: \"option\" },\n                    { id: \"purple-volkovskaya\", text: \"🟪 Волковская\", action: \"selection\", target: \"volkovskaya\", buttonType: \"option\" },\n                    { id: \"purple-buharestskaya\", text: \"🟪 Бухарестская\", action: \"selection\", target: \"buharestskaya\", buttonType: \"option\" },\n                    { id: \"purple-mezhdunar\", text: \"🟪 Международная\", action: \"selection\", target: \"mezhdunar\", buttonType: \"option\" },\n                    { id: \"btn-back-metro-purple\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n            ]\n          },\n\n          // Лист 4: Интересы и хобби\n          {\n            id: \"interests_sheet\",\n            name: \"🎯 Интересы\",\n            nodes: [\n              {\n                id: \"interests_categories\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"Выбери категории интересов: 🎯\\n\\n(Можешь выбрать несколько)\",\n                  synonyms: [\"интересы\", \"хобби\", \"увлечения\", \"что нравится\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"interests_categories\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    {\n                      id: \"btn-music\",\n                      text: \"🎵 Музыка\",\n                      action: \"goto\",\n                      target: \"music_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-hobby\",\n                      text: \"🎨 Хобби\",\n                      action: \"goto\",\n                      target: \"hobby_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-social\",\n                      text: \"👥 Общение\",\n                      action: \"goto\",\n                      target: \"social_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-creativity\",\n                      text: \"🎭 Творчество\",\n                      action: \"goto\",\n                      target: \"creativity_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-active\",\n                      text: \"⚽ Активности\",\n                      action: \"goto\",\n                      target: \"active_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-food\",\n                      text: \"🍔 Еда\",\n                      action: \"goto\",\n                      target: \"food_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-sport\",\n                      text: \"🏋️ Спорт\",\n                      action: \"goto\",\n                      target: \"sport_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"music_interests\",\n                type: \"message\",\n                position: { x: 100, y: 500 },\n                data: {\n                  messageText: \"🎵 Какая музыка тебе нравится?\\n\\n(Можешь выбрать несколько)\",\n                  synonyms: [\"музыка\", \"песни\", \"треки\", \"жанры\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"music-pop\", text: \"🎤 Поп\", action: \"selection\", target: \"pop\", buttonType: \"option\" },\n                    { id: \"music-rock\", text: \"🎸 Рок\", action: \"selection\", target: \"rock\", buttonType: \"option\" },\n                    { id: \"music-electronic\", text: \"🎧 Электро\", action: \"selection\", target: \"electronic\", buttonType: \"option\" },\n                    { id: \"music-jazz\", text: \"🎺 Джаз\", action: \"selection\", target: \"jazz\", buttonType: \"option\" },\n                    { id: \"music-classical\", text: \"🎼 Классика\", action: \"selection\", target: \"classical\", buttonType: \"option\" },\n                    { id: \"music-hiphop\", text: \"🎤 Хип-хоп\", action: \"selection\", target: \"hiphop\", buttonType: \"option\" },\n                    { id: \"music-indie\", text: \"🎸 Инди\", action: \"selection\", target: \"indie\", buttonType: \"option\" },\n                    { id: \"music-rnb\", text: \"🎵 R&B\", action: \"selection\", target: \"rnb\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-music\", text: \"⬅️ Назад к категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"hobby_interests\",\n                type: \"message\",\n                position: { x: 700, y: 500 },\n                data: {\n                  messageText: \"🎨 Какие у тебя хобби?\\n\\n(Можешь выбрать несколько)\",\n                  synonyms: [\"хобби\", \"увлечения\", \"занятия\", \"досуг\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"hobby-reading\", text: \"📚 Чтение\", action: \"selection\", target: \"reading\", buttonType: \"option\" },\n                    { id: \"hobby-gaming\", text: \"🎮 Игры\", action: \"selection\", target: \"gaming\", buttonType: \"option\" },\n                    { id: \"hobby-cooking\", text: \"👨‍🍳 Готовка\", action: \"selection\", target: \"cooking\", buttonType: \"option\" },\n                    { id: \"hobby-gardening\", text: \"🌱 Садоводство\", action: \"selection\", target: \"gardening\", buttonType: \"option\" },\n                    { id: \"hobby-collecting\", text: \"🏺 Коллекции\", action: \"selection\", target: \"collecting\", buttonType: \"option\" },\n                    { id: \"hobby-diy\", text: \"🔨 DIY\", action: \"selection\", target: \"diy\", buttonType: \"option\" },\n                    { id: \"hobby-pets\", text: \"🐕 Животные\", action: \"selection\", target: \"pets\", buttonType: \"option\" },\n                    { id: \"hobby-tech\", text: \"💻 Технологии\", action: \"selection\", target: \"tech\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-hobby\", text: \"⬅️ Назад к категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"social_interests\",\n                type: \"message\",\n                position: { x: 100, y: 500 },\n                data: {\n                  messageText: \"Выбери интересы в категории 👥 Общение:\",\n                  synonyms: [\"общение\", \"социальное\", \"люди\", \"тусовки\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"social-parties\", text: \"🎉 Вечеринки\", action: \"selection\", target: \"parties\", buttonType: \"option\" },\n                    { id: \"social-networking\", text: \"🤝 Нетворкинг\", action: \"selection\", target: \"networking\", buttonType: \"option\" },\n                    { id: \"social-dating\", text: \"💕 Знакомства\", action: \"selection\", target: \"dating\", buttonType: \"option\" },\n                    { id: \"social-volunteering\", text: \"🤲 Волонтёрство\", action: \"selection\", target: \"volunteering\", buttonType: \"option\" },\n                    { id: \"social-events\", text: \"🎪 Мероприятия\", action: \"selection\", target: \"events\", buttonType: \"option\" },\n                    { id: \"social-community\", text: \"👥 Сообщества\", action: \"selection\", target: \"community\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-social\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"creativity_interests\",\n                type: \"message\",\n                position: { x: 700, y: 700 },\n                data: {\n                  messageText: \"Выбери интересы в категории 🎭 Творчество:\",\n                  synonyms: [\"творчество\", \"искусство\", \"рисование\", \"музыка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"creativity-art\", text: \"🎨 Рисование\", action: \"selection\", target: \"art\", buttonType: \"option\" },\n                    { id: \"creativity-music\", text: \"🎵 Музыка\", action: \"selection\", target: \"music\", buttonType: \"option\" },\n                    { id: \"creativity-photography\", text: \"📸 Фотография\", action: \"selection\", target: \"photography\", buttonType: \"option\" },\n                    { id: \"creativity-writing\", text: \"✍️ Писательство\", action: \"selection\", target: \"writing\", buttonType: \"option\" },\n                    { id: \"creativity-design\", text: \"🖌️ Дизайн\", action: \"selection\", target: \"design\", buttonType: \"option\" },\n                    { id: \"creativity-handmade\", text: \"🧶 Рукоделие\", action: \"selection\", target: \"handmade\", buttonType: \"option\" },\n                    { id: \"creativity-theater\", text: \"🎭 Театр\", action: \"selection\", target: \"theater\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-creativity\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"active_interests\",\n                type: \"message\",\n                position: { x: 1000, y: 700 },\n                data: {\n                  messageText: \"Выбери интересы в категории ⚽ Активности:\",\n                  synonyms: [\"активность\", \"активный\", \"движение\", \"здоровье\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"active-running\", text: \"🏃 Бег\", action: \"selection\", target: \"running\", buttonType: \"option\" },\n                    { id: \"active-gym\", text: \"💪 Тренажёрный зал\", action: \"selection\", target: \"gym\", buttonType: \"option\" },\n                    { id: \"active-cycling\", text: \"🚴 Велосипед\", action: \"selection\", target: \"cycling\", buttonType: \"option\" },\n                    { id: \"active-hiking\", text: \"🥾 Походы\", action: \"selection\", target: \"hiking\", buttonType: \"option\" },\n                    { id: \"active-yoga\", text: \"🧘 Йога\", action: \"selection\", target: \"yoga\", buttonType: \"option\" },\n                    { id: \"active-swimming\", text: \"🏊 Плавание\", action: \"selection\", target: \"swimming\", buttonType: \"option\" },\n                    { id: \"active-dancing\", text: \"💃 Танцы\", action: \"selection\", target: \"dancing\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-active\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"food_interests\",\n                type: \"message\",\n                position: { x: 1300, y: 700 },\n                data: {\n                  messageText: \"Выбери интересы в категории 🍔 Еда:\",\n                  synonyms: [\"еда\", \"напитки\", \"кухня\", \"рестораны\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"food-cooking\", text: \"👨‍🍳 Готовка\", action: \"selection\", target: \"cooking\", buttonType: \"option\" },\n                    { id: \"food-restaurants\", text: \"🍽️ Рестораны\", action: \"selection\", target: \"restaurants\", buttonType: \"option\" },\n                    { id: \"food-wine\", text: \"🍷 Вино\", action: \"selection\", target: \"wine\", buttonType: \"option\" },\n                    { id: \"food-coffee\", text: \"☕ Кофе\", action: \"selection\", target: \"coffee\", buttonType: \"option\" },\n                    { id: \"food-baking\", text: \"🧁 Выпечка\", action: \"selection\", target: \"baking\", buttonType: \"option\" },\n                    { id: \"food-street\", text: \"🌮 Стрит-фуд\", action: \"selection\", target: \"street_food\", buttonType: \"option\" },\n                    { id: \"food-healthy\", text: \"🥗 Здоровое питание\", action: \"selection\", target: \"healthy_food\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-food\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"sport_interests\",\n                type: \"message\",\n                position: { x: 1600, y: 700 },\n                data: {\n                  messageText: \"Выбери интересы в категории 🏋️ Спорт:\",\n                  synonyms: [\"спорт\", \"фитнес\", \"тренировки\", \"футбол\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"sport-football\", text: \"⚽ Футбол\", action: \"selection\", target: \"football\", buttonType: \"option\" },\n                    { id: \"sport-basketball\", text: \"🏀 Баскетбол\", action: \"selection\", target: \"basketball\", buttonType: \"option\" },\n                    { id: \"sport-tennis\", text: \"🎾 Теннис\", action: \"selection\", target: \"tennis\", buttonType: \"option\" },\n                    { id: \"sport-hockey\", text: \"🏒 Хоккей\", action: \"selection\", target: \"hockey\", buttonType: \"option\" },\n                    { id: \"sport-volleyball\", text: \"🏐 Волейбол\", action: \"selection\", target: \"volleyball\", buttonType: \"option\" },\n                    { id: \"sport-mma\", text: \"🥊 Единоборства\", action: \"selection\", target: \"mma\", buttonType: \"option\" },\n                    { id: \"sport-esports\", text: \"🎮 Киберспорт\", action: \"selection\", target: \"esports\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-sport\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n            ]\n          },\n\n          // Лист 5: Личная информация\n          {\n            id: \"personal_sheet\",\n            name: \"💝 Личная информация\",\n            nodes: [\n              {\n                id: \"marital_status\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"Твое семейное положение: 💍\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"marital_status\",\n                  synonyms: [\"семейное положение\", \"отношения\", \"статус\"],\n                  buttons: [\n                    {\n                      id: \"btn-single\",\n                      text: \"Холост/Не замужем 💚\",\n                      value: \"single\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-relationship\",\n                      text: \"В отношениях 💙\",\n                      value: \"relationship\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-married\",\n                      text: \"Женат/Замужем 💛\",\n                      value: \"married\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-complicated\",\n                      text: \"Всё сложно 🤷\",\n                      value: \"complicated\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"sexual_orientation\",\n                type: \"message\",\n                position: { x: 400, y: 500 },\n                data: {\n                  messageText: \"Твоя ориентация: 🌈\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"sexual_orientation\",\n                  synonyms: [\"ориентация\", \"предпочтения\", \"интерес\"],\n                  buttons: [\n                    {\n                      id: \"btn-hetero\",\n                      text: \"Гетеро 👫\",\n                      value: \"heterosexual\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-gay\",\n                      text: \"Гей 👬\",\n                      value: \"gay\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-lesbian\",\n                      text: \"Лесбиянка 👭\",\n                      value: \"lesbian\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-bi\",\n                      text: \"Би 🌈\",\n                      value: \"bisexual\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-other\",\n                      text: \"Другое 🎭\",\n                      value: \"other\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"channel_choice\",\n                type: \"message\",\n                position: { x: 400, y: 700 },\n                data: {\n                  messageText: \"Хочешь указать свой телеграм-канал? 📢\\n\\nВведи ссылку, ник с @ или просто имя канала, либо нажми 'Пропустить':\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"telegram_channel\",\n                  synonyms: [\"канал\", \"тг\", \"телеграм\", \"ссылка\"],\n                  inputTargetNodeId: \"extra_info\",\n                  buttons: [\n                    {\n                      id: \"btn-skip-channel\",\n                      text: \"Пропустить ⏭️\",\n                      action: \"goto\",\n                      target: \"extra_info\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"extra_info\",\n                type: \"message\",\n                position: { x: 400, y: 900 },\n                data: {\n                  messageText: \"Хочешь добавить что-то ещё о себе? 📝\\n\\nРасскажи о себе (до 2000 символов) или нажми 'Пропустить':\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"extra_info\",\n                  synonyms: [\"о себе\", \"дополнительно\", \"больше\", \"еще\"],\n                  inputTargetNodeId: \"profile_complete\",\n                  buttons: [\n                    {\n                      id: \"btn-skip-extra\",\n                      text: \"Пропустить ⏭️\",\n                      action: \"goto\",\n                      target: \"profile_complete\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n            ]\n          },\n\n          // Лист 6: Профиль и команды\n          {\n            id: \"profile_sheet\",\n            name: \"👤 Профиль\",\n            nodes: [\n              {\n                id: \"profile_complete\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"🎉 Отлично! Твой профиль заполнен!\\n\\n👤 Твоя анкета:\\nПол: {gender}\\nИмя: {user_name}\\nВозраст: {user_age}\\nМетро: {metro_stations}\\nИнтересы: {user_interests}\\nСемейное положение: {marital_status}\\nОриентация: {sexual_orientation}\\n\\n💬 Источник: {user_source}\\n\\nМожешь посмотреть полную анкету или сразу получить ссылку на чат!\",\n                  synonyms: [],\n                  keyboardType: \"inline\",\n                  removeKeyboard: false,\n                  enableConditionalMessages: true,\n                  conditionalMessages: [\n                    {\n                      id: \"with_both\",\n                      condition: \"user_data_exists\",\n                      variableNames: [\"telegram_channel\", \"extra_info\"],\n                      messageText: \"🎉 Отлично! Твой профиль заполнен!\\n\\n👤 Твоя анкета:\\nПол: {gender}\\nИмя: {user_name}\\nВозраст: {user_age}\\nМетро: {metro_stations}\\nИнтересы: {user_interests}\\nСемейное положение: {marital_status}\\nОриентация: {sexual_orientation}\\nТелеграм: {telegram_channel} 📢\\nО себе: {extra_info} 📝\\n\\n💬 Источник: {user_source}\\n\\nМожешь посмотреть полную анкету или сразу получить ссылку на чат!\",\n                      formatMode: \"text\",\n                      keyboardType: \"inline\",\n                      buttons: [\n                        {\n                          id: \"btn-chat-link\",\n                          text: \"Ссылка на чат 🔗\",\n                          action: \"command\",\n                          target: \"/link\",\n                          buttonType: \"normal\"\n                        },\n                        {\n                          id: \"btn-show-profile-edit\",\n                          text: \"Редактировать профиль ✏️\",\n                          action: \"command\",\n                          target: \"/profile\",\n                          buttonType: \"normal\"\n                        }\n                      ],\n                      priority: 1\n                    },\n                    {\n                      id: \"with_telegram_only\",\n                      condition: \"user_data_exists\",\n                      variableNames: [\"telegram_channel\"],\n                      messageText: \"🎉 Отлично! Твой профиль заполнен!\\n\\n👤 Твоя анкета:\\nПол: {gender}\\nИмя: {user_name}\\nВозраст: {user_age}\\nМетро: {metro_stations}\\nИнтересы: {user_interests}\\nСемейное положение: {marital_status}\\nОриентация: {sexual_orientation}\\nТелеграм: {telegram_channel} 📢\\n\\n💬 Источник: {user_source}\\n\\nМожешь посмотреть полную анкету или сразу получить ссылку на чат!\",\n                      formatMode: \"text\",\n                      keyboardType: \"inline\",\n                      buttons: [\n                        {\n                          id: \"btn-chat-link\",\n                          text: \"Ссылка на чат 🔗\",\n                          action: \"command\",\n                          target: \"/link\",\n                          buttonType: \"normal\"\n                        },\n                        {\n                          id: \"btn-show-profile-edit\",\n                          text: \"Редактировать профиль ✏️\",\n                          action: \"command\",\n                          target: \"/profile\",\n                          buttonType: \"normal\"\n                        }\n                      ],\n                      priority: 2\n                    },\n                    {\n                      id: \"with_extra_only\",\n                      condition: \"user_data_exists\",\n                      variableNames: [\"extra_info\"],\n                      messageText: \"🎉 Отлично! Твой профиль заполнен!\\n\\n👤 Твоя анкета:\\nПол: {gender}\\nИмя: {user_name}\\nВозраст: {user_age}\\nМетро: {metro_stations}\\nИнтересы: {user_interests}\\nСемейное положение: {marital_status}\\nОриентация: {sexual_orientation}\\nО себе: {extra_info} 📝\\n\\n💬 Источник: {user_source}\\n\\nМожешь посмотреть полную анкету или сразу получить ссылку на чат!\",\n                      formatMode: \"text\",\n                      keyboardType: \"inline\",\n                      buttons: [\n                        {\n                          id: \"btn-chat-link\",\n                          text: \"Ссылка на чат 🔗\",\n                          action: \"command\",\n                          target: \"/link\",\n                          buttonType: \"normal\"\n                        },\n                        {\n                          id: \"btn-show-profile-edit\",\n                          text: \"Редактировать профиль ✏️\",\n                          action: \"command\",\n                          target: \"/profile\",\n                          buttonType: \"normal\"\n                        }\n                      ],\n                      priority: 3\n                    }\n                  ],\n                  buttons: [\n                    {\n                      id: \"btn-chat-link\",\n                      text: \"Ссылка на чат 🔗\",\n                      action: \"command\",\n                      target: \"/link\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-show-profile-edit\",\n                      text: \"Редактировать профиль ✏️\",\n                      action: \"command\",\n                      target: \"/profile\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"show_profile\",\n                type: \"command\",\n                position: { x: 400, y: 500 },\n                data: {\n                  command: \"/profile\",\n                  commandName: \"/profile\",\n                  description: \"Показать и редактировать профиль пользователя\",\n                  synonyms: [\"профиль\", \"анкета\", \"мои данные\", \"редактировать\"],\n                  messageText: \"👤 Твой профиль:\\n\\nПол: {gender} 👤\\nИмя: {user_name} ✏️\\nВозраст: {user_age} 🎂\\nМетро: {metro_stations} 🚇\\nИнтересы: {user_interests} 🎯\\nСемейное положение: {marital_status} 💍\\nОриентация: {sexual_orientation} 🌈\\n\\n💬 Источник: {user_source}\\n\\n✏️ Выберите действие:\",\n                  keyboardType: \"inline\",\n                  enableConditionalMessages: true,\n                  conditionalMessages: [\n                    {\n                      id: \"with_both_show\",\n                      condition: \"user_data_exists\",\n                      variableNames: [\"telegram_channel\", \"extra_info\"],\n                      messageText: \"👤 Твой профиль:\\n\\nПол: {gender} 👤\\nИмя: {user_name} ✏️\\nВозраст: {user_age} 🎂\\nМетро: {metro_stations} 🚇\\nИнтересы: {user_interests} 🎯\\nСемейное положение: {marital_status} 💍\\nОриентация: {sexual_orientation} 🌈\\nТелеграм: {telegram_channel} 📢\\nО себе: {extra_info} 📝\\n\\n💬 Источник: {user_source}\\n\\n✏️ Выберите действие:\",\n                      formatMode: \"text\",\n                      keyboardType: \"inline\",\n                      priority: 1\n                    },\n                    {\n                      id: \"with_telegram_only_show\",\n                      condition: \"user_data_exists\",\n                      variableNames: [\"telegram_channel\"],\n                      messageText: \"👤 Твой профиль:\\n\\nПол: {gender} 👤\\nИмя: {user_name} ✏️\\nВозраст: {user_age} 🎂\\nМетро: {metro_stations} 🚇\\nИнтересы: {user_interests} 🎯\\nСемейное положение: {marital_status} 💍\\nОриентация: {sexual_orientation} 🌈\\nТелеграм: {telegram_channel} 📢\\n\\n💬 Источник: {user_source}\\n\\n✏️ Выберите действие:\",\n                      formatMode: \"text\",\n                      keyboardType: \"inline\",\n                      priority: 2\n                    },\n                    {\n                      id: \"with_extra_only_show\",\n                      condition: \"user_data_exists\",\n                      variableNames: [\"extra_info\"],\n                      messageText: \"👤 Твой профиль:\\n\\nПол: {gender} 👤\\nИмя: {user_name} ✏️\\nВозраст: {user_age} 🎂\\nМетро: {metro_stations} 🚇\\nИнтересы: {user_interests} 🎯\\nСемейное положение: {marital_status} 💍\\nОриентация: {sexual_orientation} 🌈\\nО себе: {extra_info} 📝\\n\\n💬 Источник: {user_source}\\n\\n✏️ Выберите действие:\",\n                      formatMode: \"text\",\n                      keyboardType: \"inline\",\n                      priority: 3\n                    }\n                  ],\n                  buttons: [\n                    {\n                      id: \"btn-edit-gender\",\n                      text: \"👤 Изменить пол\",\n                      action: \"goto\",\n                      target: \"gender_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-name\",\n                      text: \"✏️ Изменить имя\",\n                      action: \"goto\",\n                      target: \"name_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-age\",\n                      text: \"🎂 Изменить возраст\",\n                      action: \"goto\",\n                      target: \"age_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-metro\",\n                      text: \"🚇 Изменить метро\",\n                      action: \"goto\",\n                      target: \"metro_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-interests\",\n                      text: \"🎯 Изменить интересы\",\n                      action: \"goto\",\n                      target: \"interests_categories\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-marital\",\n                      text: \"💍 Изменить семейное положение\",\n                      action: \"goto\",\n                      target: \"marital_status\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-orientation\",\n                      text: \"🌈 Изменить ориентацию\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-channel\",\n                      text: \"📢 Указать ТГК\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-extra\",\n                      text: \"📝 Добавить о себе\",\n                      action: \"goto\",\n                      target: \"extra_info\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-restart-from-profile\",\n                      text: \"🔄 Начать заново\",\n                      action: \"command\",\n                      target: \"/start\",\n                      buttonType: \"navigation\"\n                    }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"chat_link\",\n                type: \"command\",\n                position: { x: 400, y: 700 },\n                data: {\n                  command: \"/link\",\n                  commandName: \"/link\",\n                  description: \"Получить ссылку на чат сообщества\",\n                  synonyms: [\"ссылка\", \"чат\", \"сообщество\", \"впрогулке\", \"линк\"],\n                  messageText: \"🔗 Актуальная ссылка на чат:\\n\\nhttps://t.me/+agkIVgCzHtY2ZTA6\\n\\nДобро пожаловать в сообщество ᴠᴨᴩᴏᴦʏᴧᴋᴇ! 🎉\",\n                  keyboardType: \"none\",\n                  buttons: [],\n                  markdown: false\n                }\n              },\n              {\n                id: \"help_command\",\n                type: \"command\",\n                position: { x: 400, y: 900 },\n                data: {\n                  command: \"/help\",\n                  commandName: \"/help\", \n                  description: \"Помощь и список всех команд с синонимами\",\n                  synonyms: [\"помощь\", \"справка\", \"команды\", \"что писать\", \"как пользоваться\"],\n                  messageText: \"🤖 **Добро пожаловать в справочный центр!**\\n\\n🌟 **ᴠᴨᴩᴏᴦʏᴧᴋᴇ Bot**\\n*Твой помощник в знакомствах*\\n\\n\\n📋 **ДОСТУПНЫЕ КОМАНДЫ**\\n\\n🚀 **Start** — Начать знакомство\\n   📝 *старт, начать, привет, начало, начинаем*\\n\\n👤 **Profile** — Мой профиль\\n   📝 *профиль, анкета, мои данные, редактировать*\\n\\n🔗 **Link** — Ссылка на чат\\n   📝 *ссылка, чат, сообщество, впрогулке, линк*\\n\\n❓ **Help** — Справка и команды\\n   📝 *помощь, справка, команды, что писать*\\n\\n\\n💡 **КАК ПОЛЬЗОВАТЬСЯ**\\n\\n✨ Пишите команды или синонимы в любом месте\\n✨ Используйте команды с символом /\\n✨ Бот понимает естественную речь!\\n\\n🎉 **Удачного общения в сообществе!**\",\n                  keyboardType: \"none\",\n                  buttons: [],\n                  markdown: true\n                }\n              }\n            ]\n          }\n        ],\n\n        // Связи между листами\n        interSheetConnections: [\n          // Из приветствия к основной информации\n          {\n            id: \"inter-welcome-basic\",\n            sourceSheetId: \"welcome_sheet\",\n            targetSheetId: \"basic_info_sheet\",\n            sourceNodeId: \"join_request\",\n            targetNodeId: \"gender_selection\",\n            sourceHandle: \"btn-yes\",\n            targetHandle: \"target\"\n          },\n          // Из основной информации к метро\n          {\n            id: \"inter-basic-metro\",\n            sourceSheetId: \"basic_info_sheet\",\n            targetSheetId: \"metro_sheet\",\n            sourceNodeId: \"age_input\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          // Из метро к интересам\n          {\n            id: \"inter-metro-interests\",\n            sourceSheetId: \"metro_sheet\",\n            targetSheetId: \"interests_sheet\",\n            sourceNodeId: \"metro_selection\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          // Из интересов к личной информации\n          {\n            id: \"inter-interests-personal\",\n            sourceSheetId: \"interests_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"interests_categories\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          // Из личной информации к профилю\n          {\n            id: \"inter-personal-profile\",\n            sourceSheetId: \"personal_sheet\",\n            targetSheetId: \"profile_sheet\",\n            sourceNodeId: \"extra_info\",\n            targetNodeId: \"profile_complete\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          // Редактирование профиля - возврат к соответствующим листам\n          {\n            id: \"inter-profile-basic-gender\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"basic_info_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"gender_selection\",\n            sourceHandle: \"btn-edit-gender\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-basic-name\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"basic_info_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"name_input\",\n            sourceHandle: \"btn-edit-name\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-basic-age\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"basic_info_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"age_input\",\n            sourceHandle: \"btn-edit-age\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-metro\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"metro_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"btn-edit-metro\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-interests\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"interests_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-edit-interests\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-personal-marital\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"btn-edit-marital\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-personal-orientation\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"sexual_orientation\",\n            sourceHandle: \"btn-edit-orientation\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-personal-channel\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"channel_choice\",\n            sourceHandle: \"btn-edit-channel\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-personal-extra\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"extra_info\",\n            sourceHandle: \"btn-edit-extra\",\n            targetHandle: \"target\"\n          }\n        ]\n      }\n    });\n\n    console.log('✅ Многолистовой шаблон ВПрогулке создан');\n\n    // Создаем шаблон с элементами управления контентом и пользователями\n    await storage.createBotTemplate({\n      name: \"👮‍♂️ Админ-панель модератора\",\n      description: \"Полный набор инструментов для модерации группы: управление сообщениями, пользователями и контентом\",\n      category: \"utility\",\n      tags: [\"модерация\", \"админ\", \"управление\", \"группа\", \"контент\", \"пользователи\", \"администрирование\"],\n      isPublic: 1,\n      difficulty: \"medium\",\n      authorName: \"Система\",\n      version: \"1.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 6,\n      estimatedTime: 20,\n      data: {\n        sheets: [\n          {\n            id: \"main_sheet\",\n            name: \"🏠 Главное меню\",\n            description: \"Основное меню навигации по функциям модерации\",\n            nodes: [\n              {\n                id: \"start\",\n                type: \"start\",\n                position: { x: 400, y: 200 },\n                data: {\n                  command: \"/start\",\n                  description: \"Начать работу с админ-панелью\",\n                  messageText: \"👮‍♂️ Добро пожаловать в админ-панель модератора!\\n\\nЭтот бот поможет вам управлять группой с помощью команд.\\n\\nВыберите действие:\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-help\",\n                      text: \"❓ Справка по командам\",\n                      action: \"goto\",\n                      target: \"help_commands\",\n                      buttonType: \"navigation\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"help_commands\",\n                type: \"command\",\n                position: { x: 400, y: 500 },\n                data: {\n                  command: \"/help\",\n                  description: \"Справка по командам модератора\",\n                  messageText: \"❓ <b>Справка по командам модератора</b>\\n\\n<b>Управление контентом:</b>\\n📌 <code>/pin_message</code> - Закрепить сообщение\\n   Синонимы: <code>закрепить</code>, <code>прикрепить</code>, <code>зафиксировать</code>\\n\\n📌❌ <code>/unpin_message</code> - Открепить сообщение\\n   Синонимы: <code>открепить</code>, <code>отцепить</code>, <code>убрать закрепление</code>\\n\\n🗑️ <code>/delete_message</code> - Удалить сообщение\\n   Синонимы: <code>удалить</code>, <code>стереть</code>, <code>убрать сообщение</code>\\n\\n<b>Управление пользователями:</b>\\n🚫 <code>/ban_user</code> - Заблокировать пользователя\\n   Синонимы: <code>забанить</code>, <code>заблокировать</code>, <code>бан</code>\\n\\n✅ <code>/unban_user</code> - Разблокировать пользователя\\n   Синонимы: <code>разбанить</code>, <code>разблокировать</code>, <code>unbан</code>\\n\\n🔇 <code>/mute_user</code> - Ограничить пользователя\\n   Синонимы: <code>замутить</code>, <code>заглушить</code>, <code>мут</code>\\n\\n🔊 <code>/unmute_user</code> - Снять ограничения\\n   Синонимы: <code>размутить</code>, <code>разглушить</code>, <code>анмут</code>\\n\\n👢 <code>/kick_user</code> - Исключить пользователя\\n   Синонимы: <code>кикнуть</code>, <code>исключить</code>, <code>выгнать</code>\\n\\n👑 <code>/promote_user</code> - Назначить администратором\\n   Синонимы: <code>повысить</code>, <code>назначить админом</code>, <code>промоут</code>\\n\\n👤 <code>/demote_user</code> - Снять с администратора\\n   Синонимы: <code>понизить</code>, <code>снять с админа</code>, <code>демоут</code>\\n\\n⚙️ <code>/admin_rights</code> - Настроить права администратора\\n   Синонимы: <code>права админа</code>, <code>настроить права</code>, <code>тг права</code>\\n   ⚠️ Только для администраторов группы!\\n   💡 Ответьте на сообщение пользователя командой\\n\\n<b>Примеры использования:</b>\\n• Ответьте на сообщение командой для его обработки\\n• Используйте команды в ответ на сообщения нарушителей\\n• Команды с правами работают только в группах/супергруппах\\n• Все действия логируются для отчетности\",\n                  synonyms: [\"справка\", \"помощь\", \"команды\", \"хелп\"],\n                  markdown: false,\n                  formatMode: \"html\",\n                  keyboardType: \"none\",\n                  buttons: [],\n                  showInMenu: true,\n                  isPrivateOnly: false,\n                  requiresAuth: false,\n                  adminOnly: false\n                }\n              }\n            ],\n            connections: [\n              {\n                id: \"start-help\",\n                sourceNodeId: \"start\",\n                targetNodeId: \"help_commands\",\n                sourceHandle: \"btn-help\",\n                targetHandle: \"target\"\n              }\n            ]\n          },\n          {\n            id: \"content_sheet\",\n            name: \"📝 Управление контентом\",\n            description: \"Инструменты для модерации сообщений и контента\",\n            nodes: [\n              {\n                id: \"pin_message_node\",\n                type: \"pin_message\",\n                position: { x: 200, y: 300 },\n                data: {\n                  command: \"/pin_message\",\n                  messageText: \"📌 Сообщение успешно закреплено!\",\n                  synonyms: [\"закрепить\", \"прикрепить\", \"зафиксировать\"],\n                  disableNotification: false,\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"unpin_message_node\",\n                type: \"unpin_message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  command: \"/unpin_message\",\n                  messageText: \"📌❌ Сообщение успешно откреплено!\",\n                  synonyms: [\"открепить\", \"отцепить\", \"убрать закрепление\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"delete_message_node\",\n                type: \"delete_message\",\n                position: { x: 600, y: 300 },\n                data: {\n                  command: \"/delete_message\",\n                  messageText: \"🗑️ Сообщение успешно удалено!\",\n                  synonyms: [\"удалить\", \"стереть\", \"убрать сообщение\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              }\n            ],\n            connections: []\n          },\n          {\n            id: \"users_sheet\",\n            name: \"👥 Управление пользователями\",\n            description: \"Инструменты для модерации участников группы\",\n            nodes: [\n              {\n                id: \"ban_user_node\",\n                type: \"ban_user\",\n                position: { x: 100, y: 500 },\n                data: {\n                  command: \"/ban_user\",\n                  messageText: \"🚫 Пользователь заблокирован в группе!\",\n                  synonyms: [\"забанить\", \"заблокировать\", \"бан\"],\n                  reason: \"Нарушение правил группы\",\n                  untilDate: 0,\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"unban_user_node\",\n                type: \"unban_user\",\n                position: { x: 250, y: 500 },\n                data: {\n                  command: \"/unban_user\",\n                  messageText: \"✅ Пользователь разблокирован!\",\n                  synonyms: [\"разбанить\", \"разблокировать\", \"unbан\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"mute_user_node\",\n                type: \"mute_user\",\n                position: { x: 400, y: 500 },\n                data: {\n                  command: \"/mute_user\",\n                  messageText: \"🔇 Пользователь ограничен в правах!\",\n                  synonyms: [\"замутить\", \"заглушить\", \"мут\"],\n                  reason: \"Нарушение правил группы\",\n                  duration: 3600,\n                  canSendMessages: false,\n                  canSendMediaMessages: false,\n                  canSendPolls: false,\n                  canSendOtherMessages: false,\n                  canAddWebPagePreviews: false,\n                  canChangeGroupInfo: false,\n                  canInviteUsers2: false,\n                  canPinMessages2: false,\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"unmute_user_node\",\n                type: \"unmute_user\",\n                position: { x: 550, y: 500 },\n                data: {\n                  command: \"/unmute_user\",\n                  messageText: \"🔊 Ограничения с пользователя сняты!\",\n                  synonyms: [\"размутить\", \"разглушить\", \"анмут\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"kick_user_node\",\n                type: \"kick_user\",\n                position: { x: 700, y: 500 },\n                data: {\n                  command: \"/kick_user\",\n                  messageText: \"👢 Пользователь исключен из группы!\",\n                  synonyms: [\"кикнуть\", \"исключить\", \"выгнать\"],\n                  reason: \"Нарушение правил группы\",\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"promote_user_node\",\n                type: \"promote_user\",\n                position: { x: 500, y: 700 },\n                data: {\n                  command: \"/promote_user\",\n                  messageText: \"👑 Пользователь назначен администратором!\",\n                  synonyms: [\"повысить\", \"назначить админом\", \"промоут\"],\n                  canChangeInfo: false,\n                  canDeleteMessages: true,\n                  canBanUsers: false,\n                  canInviteUsers: true,\n                  canPinMessages: true,\n                  canAddAdmins: false,\n                  canRestrictMembers: false,\n                  canPromoteMembers: false,\n                  canManageVideoChats: false,\n                  isAnonymous: false,\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"demote_user_node\",\n                type: \"demote_user\",\n                position: { x: 700, y: 700 },\n                data: {\n                  command: \"/demote_user\",\n                  messageText: \"👤 Пользователь снят с должности администратора!\",\n                  synonyms: [\"понизить\", \"снять с админа\", \"демоут\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"admin_rights_node\",\n                type: \"admin_rights\",\n                position: { x: 300, y: 900 },\n                data: {\n                  command: \"/admin_rights\",\n                  messageText: \"⚙️ Права администратора настроены для пользователя!\\n\\n💡 Чтобы настроить права, ответьте на сообщение пользователя и используйте команду /admin_rights\",\n                  synonyms: [\"права админа\", \"настроить права\", \"тг права\", \"права администратора\", \"admin rights\"],\n                  description: \"Настройка прав администратора в группе (только для админов)\",\n                  adminUserIdSource: \"reply_to_message\", // Исправлено: используем reply вместо last_message\n                  adminOnly: true, // Добавлено: только администраторы могут использовать\n                  requiresGroup: true, // Добавлено: команда работает только в группах\n                  isPrivateOnly: false, // Команда для групп, не для приватных чатов\n                  // Базовые права администратора\n                  can_manage_chat: false,\n                  can_delete_messages: true,\n                  can_manage_video_chats: false,\n                  can_restrict_members: true,\n                  can_promote_members: false,\n                  can_change_info: false,\n                  can_invite_users: true,\n                  can_pin_messages: true,\n                  can_manage_topics: false,\n                  is_anonymous: false,\n                  adminChatIdSource: \"current_chat\",\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              }\n            ],\n            connections: []\n          }\n        ],\n        interSheetConnections: []\n      }\n    });\n\n    console.log('✅ Шаблон админ-панели модератора создан');\n\n    // Создаем объединенный шаблон: ВПрогулке + Админ панель (ПОЛНАЯ ВЕРСИЯ)\n    await storage.createBotTemplate({\n      name: \"🌟👮‍♂️ ВПрогулке + Админ панель - Полная версия\",\n      description: \"Полноценный объединенный шаблон: продвинутый бот знакомств для Санкт-Петербурга со всеми функциями (метро, интересы, ориентация) + полный набор инструментов модерации группы\",\n      category: \"community\", \n      tags: [\"знакомства\", \"модерация\", \"админ\", \"метро\", \"интересы\", \"СПб\", \"анкета\", \"управление\", \"группа\", \"контент\", \"ориентация\", \"полнофункциональный\"],\n      isPublic: 1,\n      difficulty: \"hard\",\n      authorName: \"Система\",\n      version: \"2.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 10,\n      estimatedTime: 80,\n      data: {\n        sheets: [\n          // ===== ЛИСТЫ ИЗ ВПрогулке Multi-Sheet (ПОЛНАЯ КОПИЯ) =====\n          \n          // Лист 1: Приветствие\n          {\n            id: \"welcome_sheet\",\n            name: \"🎉 Приветствие\",\n            nodes: [\n              {\n                id: \"start\",\n                type: \"start\",\n                position: { x: 400, y: 100 },\n                data: {\n                  command: \"/start\",\n                  description: \"Приветствие и источник\",\n                  messageText: \"🌟 Привет от ᴠᴨᴩᴏᴦʏᴧᴋᴇ Bot!\\n\\nЭтот бот поможет тебе найти интересных людей в Санкт-Петербурге!\\n\\nОткуда ты узнал о нашем чате? 😎\",\n                  synonyms: [\"старт\", \"начать\", \"привет\", \"начало\", \"начинаем\"],\n                  keyboardType: \"none\",\n                  buttons: [],\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"user_source\",\n                  inputTargetNodeId: \"join_request\",\n                  markdown: false,\n                  oneTimeKeyboard: false,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"join_request\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"Хочешь присоединиться к нашему чату? 🚀\",\n                  synonyms: [],\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"join_request_response\",\n                  buttons: [\n                    {\n                      id: \"btn-yes\",\n                      text: \"Да 😎\",\n                      value: \"yes\",\n                      action: \"goto\",\n                      target: \"gender_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-no\", \n                      text: \"Нет 🙅\",\n                      value: \"no\",\n                      action: \"goto\",\n                      target: \"decline_response\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"decline_response\",\n                type: \"message\",\n                position: { x: 400, y: 500 },\n                data: {\n                  messageText: \"Понятно! Если передумаешь, напиши /start! 😊\",\n                  synonyms: [],\n                  keyboardType: \"none\",\n                  removeKeyboard: true,\n                  buttons: [],\n                  markdown: false\n                }\n              }\n            ]\n          },\n\n          // Лист 2: Основная информация (пол, имя, возраст)\n          {\n            id: \"basic_info_sheet\", \n            name: \"👤 Основная информация\",\n            nodes: [\n              {\n                id: \"gender_selection\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"Укажи свой пол: 👨👩\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"gender\",\n                  synonyms: [\"пол\", \"гендер\", \"мужчина\", \"женщина\"],\n                  buttons: [\n                    {\n                      id: \"btn-male\",\n                      text: \"Мужчина 👨\",\n                      value: \"male\",\n                      action: \"goto\",\n                      target: \"name_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-female\",\n                      text: \"Женщина 👩\",\n                      value: \"female\", \n                      action: \"goto\",\n                      target: \"name_input\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"name_input\",\n                type: \"message\",\n                position: { x: 400, y: 500 },\n                data: {\n                  messageText: \"Как тебя зовут? ✏️\\n\\nНапиши своё имя в сообщении:\",\n                  keyboardType: \"none\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"user_name\",\n                  synonyms: [\"имя\", \"зовут\", \"называют\", \"как зовут\"],\n                  inputTargetNodeId: \"age_input\",\n                  buttons: [],\n                  markdown: false\n                }\n              },\n              {\n                id: \"age_input\",\n                type: \"message\",\n                position: { x: 400, y: 700 },\n                data: {\n                  messageText: \"Сколько тебе лет? 🎂\\n\\nНапиши свой возраст числом (например, 25):\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"user_age\",\n                  synonyms: [\"возраст\", \"лет\", \"годы\", \"сколько лет\"],\n                  inputTargetNodeId: \"metro_selection\",\n                  buttons: [],\n                  markdown: false\n                }\n              },\n            ]\n          },\n\n          // Лист 3: Метро и местоположение\n          {\n            id: \"metro_sheet\",\n            name: \"🚇 Метро и местоположение\",\n            nodes: [\n              {\n                id: \"metro_selection\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"На какой станции метро ты обычно бываешь? 🚇\\n\\nВыбери свою ветку:\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"metro_stations\",\n                  synonyms: [\"метро\", \"станция\", \"где живу\", \"район\"],\n                  buttons: [\n                    {\n                      id: \"btn-red\",\n                      text: \"Красная ветка 🟥\",\n                      action: \"goto\",\n                      target: \"red_line_stations\",\n                      buttonType: \"option\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-blue\",\n                      text: \"Синяя ветка 🟦\",\n                      action: \"goto\", \n                      target: \"blue_line_stations\",\n                      buttonType: \"option\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-green\",\n                      text: \"Зелёная ветка 🟩\",\n                      action: \"goto\",\n                      target: \"green_line_stations\",\n                      buttonType: \"option\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-purple\",\n                      text: \"Фиолетовая ветка 🟪\",\n                      action: \"goto\",\n                      target: \"purple_line_stations\",\n                      buttonType: \"option\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-lo\",\n                      text: \"Я из ЛО 🏡\",\n                      value: \"ЛО\",\n                      action: \"goto\",\n                      target: \"interests_categories\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-not-spb\",\n                      text: \"Я не в Питере 🌍\",\n                      value: \"Не в СПб\",\n                      action: \"goto\",\n                      target: \"interests_categories\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"red_line_stations\",\n                type: \"message\",\n                position: { x: 100, y: 500 },\n                data: {\n                  messageText: \"🟥 Кировско-Выборгская линия\\n\\nВыбери свою станцию:\",\n                  synonyms: [\"красная линия\", \"кировско-выборгская\", \"красная ветка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"metro_stations\",\n                  continueButtonTarget: \"interests_categories\",\n                  buttons: [\n                    { id: \"red-devyatkino\", text: \"🟥 Девяткино\", action: \"selection\", target: \"devyatkino\", buttonType: \"option\" },\n                    { id: \"red-grazhdansky\", text: \"🟥 Гражданский проспект\", action: \"selection\", target: \"grazhdansky\", buttonType: \"option\" },\n                    { id: \"red-akademicheskaya\", text: \"🟥 Академическая\", action: \"selection\", target: \"akademicheskaya\", buttonType: \"option\" },\n                    { id: \"red-politehnicheskaya\", text: \"🟥 Политехническая\", action: \"selection\", target: \"politehnicheskaya\", buttonType: \"option\" },\n                    { id: \"red-pl-muzhestva\", text: \"🟥 Площадь Мужества\", action: \"selection\", target: \"pl_muzhestva\", buttonType: \"option\" },\n                    { id: \"red-lesnaya\", text: \"🟥 Лесная\", action: \"selection\", target: \"lesnaya\", buttonType: \"option\" },\n                    { id: \"red-vyborgskaya\", text: \"🟥 Выборгская\", action: \"selection\", target: \"vyborgskaya\", buttonType: \"option\" },\n                    { id: \"red-pl-lenina\", text: \"🟥 Площадь Ленина\", action: \"selection\", target: \"pl_lenina\", buttonType: \"option\" },\n                    { id: \"red-chernyshevskaya\", text: \"🟥 Чернышевская\", action: \"selection\", target: \"chernyshevskaya\", buttonType: \"option\" },\n                    { id: \"red-pl-vosstaniya\", text: \"🟥 Площадь Восстания\", action: \"selection\", target: \"pl_vosstaniya\", buttonType: \"option\" },\n                    { id: \"red-vladimirskaya\", text: \"🟥 Владимирская\", action: \"selection\", target: \"vladimirskaya\", buttonType: \"option\" },\n                    { id: \"red-pushkinskaya\", text: \"🟥 Пушкинская\", action: \"selection\", target: \"pushkinskaya\", buttonType: \"option\" },\n                    { id: \"red-tehinstitut1\", text: \"🟥 Технологический институт-1\", action: \"selection\", target: \"tehinstitut1\", buttonType: \"option\" },\n                    { id: \"red-baltiyskaya\", text: \"🟥 Балтийская\", action: \"selection\", target: \"baltiyskaya\", buttonType: \"option\" },\n                    { id: \"red-narvskaya\", text: \"🟥 Нарвская\", action: \"selection\", target: \"narvskaya\", buttonType: \"option\" },\n                    { id: \"red-kirovsky\", text: \"🟥 Кировский завод\", action: \"selection\", target: \"kirovsky\", buttonType: \"option\" },\n                    { id: \"red-avtovo\", text: \"🟥 Автово\", action: \"selection\", target: \"avtovo\", buttonType: \"option\" },\n                    { id: \"red-leninsky\", text: \"🟥 Ленинский проспект\", action: \"selection\", target: \"leninsky\", buttonType: \"option\" },\n                    { id: \"red-veteranov\", text: \"🟥 Проспект Ветеранов\", action: \"selection\", target: \"veteranov\", buttonType: \"option\" },\n                    { id: \"btn-back-metro\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"blue_line_stations\",\n                type: \"message\",\n                position: { x: 700, y: 500 },\n                data: {\n                  messageText: \"🟦 Московско-Петроградская линия\\n\\nВыбери свою станцию:\",\n                  synonyms: [\"синяя линия\", \"московско-петроградская\", \"синяя ветка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"metro_stations\",\n                  continueButtonTarget: \"interests_categories\",\n                  buttons: [\n                    { id: \"blue-parnas\", text: \"🟦 Парнас\", action: \"selection\", target: \"parnas\", buttonType: \"option\" },\n                    { id: \"blue-prosp-prosvesh\", text: \"🟦 Проспект Просвещения\", action: \"selection\", target: \"prosp_prosvesh\", buttonType: \"option\" },\n                    { id: \"blue-ozerki\", text: \"🟦 Озерки\", action: \"selection\", target: \"ozerki\", buttonType: \"option\" },\n                    { id: \"blue-udelnaya\", text: \"🟦 Удельная\", action: \"selection\", target: \"udelnaya\", buttonType: \"option\" },\n                    { id: \"blue-pionerskaya\", text: \"🟦 Пионерская\", action: \"selection\", target: \"pionerskaya\", buttonType: \"option\" },\n                    { id: \"blue-chernaya\", text: \"🟦 Черная речка\", action: \"selection\", target: \"chernaya\", buttonType: \"option\" },\n                    { id: \"blue-petrogradskaya\", text: \"🟦 Петроградская\", action: \"selection\", target: \"petrogradskaya\", buttonType: \"option\" },\n                    { id: \"blue-gorkovskaya\", text: \"🟦 Горьковская\", action: \"selection\", target: \"gorkovskaya\", buttonType: \"option\" },\n                    { id: \"blue-nevsky\", text: \"🟦 Невский проспект\", action: \"selection\", target: \"nevsky\", buttonType: \"option\" },\n                    { id: \"blue-sennaya\", text: \"🟦 Сенная площадь\", action: \"selection\", target: \"sennaya\", buttonType: \"option\" },\n                    { id: \"blue-tehinstitut2\", text: \"🟦 Технологический институт-2\", action: \"selection\", target: \"tehinstitut2\", buttonType: \"option\" },\n                    { id: \"blue-frunzenskaya\", text: \"🟦 Фрунзенская\", action: \"selection\", target: \"frunzenskaya\", buttonType: \"option\" },\n                    { id: \"blue-mosk-vorota\", text: \"🟦 Московские ворота\", action: \"selection\", target: \"mosk_vorota\", buttonType: \"option\" },\n                    { id: \"blue-elektrosila\", text: \"🟦 Электросила\", action: \"selection\", target: \"elektrosila\", buttonType: \"option\" },\n                    { id: \"blue-park-pobedy\", text: \"🟦 Парк Победы\", action: \"selection\", target: \"park_pobedy\", buttonType: \"option\" },\n                    { id: \"blue-moskovskaya\", text: \"🟦 Московская\", action: \"selection\", target: \"moskovskaya\", buttonType: \"option\" },\n                    { id: \"blue-zvezdnaya\", text: \"🟦 Звездная\", action: \"selection\", target: \"zvezdnaya\", buttonType: \"option\" },\n                    { id: \"blue-kupchino\", text: \"🟦 Купчино\", action: \"selection\", target: \"kupchino\", buttonType: \"option\" },\n                    { id: \"btn-back-metro-blue\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"green_line_stations\",\n                type: \"message\",\n                position: { x: 1000, y: 500 },\n                data: {\n                  messageText: \"🟩 Невско-Василеостровская линия\\n\\nВыбери свою станцию:\",\n                  synonyms: [\"зеленая линия\", \"невско-василеостровская\", \"зеленая ветка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"metro_stations\",\n                  continueButtonTarget: \"interests_categories\",\n                  buttons: [\n                    { id: \"green-primorskaya\", text: \"🟩 Приморская\", action: \"selection\", target: \"primorskaya\", buttonType: \"option\" },\n                    { id: \"green-vasileostr\", text: \"🟩 Василеостровская\", action: \"selection\", target: \"vasileostr\", buttonType: \"option\" },\n                    { id: \"green-gostiny\", text: \"🟩 Гостиный двор\", action: \"selection\", target: \"gostiny\", buttonType: \"option\" },\n                    { id: \"green-mayakovskaya\", text: \"🟩 Маяковская\", action: \"selection\", target: \"mayakovskaya\", buttonType: \"option\" },\n                    { id: \"green-pl-nevsk\", text: \"🟩 Площадь Александра Невского-1\", action: \"selection\", target: \"pl_nevsk\", buttonType: \"option\" },\n                    { id: \"green-elizarovskaya\", text: \"🟩 Елизаровская\", action: \"selection\", target: \"elizarovskaya\", buttonType: \"option\" },\n                    { id: \"green-lomonosovskaya\", text: \"🟩 Ломоносовская\", action: \"selection\", target: \"lomonosovskaya\", buttonType: \"option\" },\n                    { id: \"green-proletarskaya\", text: \"🟩 Пролетарская\", action: \"selection\", target: \"proletarskaya\", buttonType: \"option\" },\n                    { id: \"green-obuhovo\", text: \"🟩 Обухово\", action: \"selection\", target: \"obuhovo\", buttonType: \"option\" },\n                    { id: \"green-rybackoe\", text: \"🟩 Рыбацкое\", action: \"selection\", target: \"rybackoe\", buttonType: \"option\" },\n                    { id: \"green-novokrestovsk\", text: \"🟩 Новокрестовская\", action: \"selection\", target: \"novokrestovsk\", buttonType: \"option\" },\n                    { id: \"green-begovaya\", text: \"🟩 Беговая\", action: \"selection\", target: \"begovaya\", buttonType: \"option\" },\n                    { id: \"btn-back-metro-green\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"purple_line_stations\",\n                type: \"message\",\n                position: { x: 1600, y: 500 },\n                data: {\n                  messageText: \"🟪 Фрунзенско-Приморская линия\\n\\nВыбери свою станцию:\",\n                  synonyms: [\"фиолетовая линия\", \"фрунзенско-приморская\", \"фиолетовая ветка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"metro_stations\",\n                  continueButtonTarget: \"interests_categories\",\n                  buttons: [\n                    { id: \"purple-komendantsky\", text: \"🟪 Комендантский проспект\", action: \"selection\", target: \"komendantsky\", buttonType: \"option\" },\n                    { id: \"purple-staraya\", text: \"🟪 Старая Деревня\", action: \"selection\", target: \"staraya\", buttonType: \"option\" },\n                    { id: \"purple-krestovsky\", text: \"🟪 Крестовский остров\", action: \"selection\", target: \"krestovsky\", buttonType: \"option\" },\n                    { id: \"purple-chkalovskaya\", text: \"🟪 Чкаловская\", action: \"selection\", target: \"chkalovskaya\", buttonType: \"option\" },\n                    { id: \"purple-sportivnaya\", text: \"🟪 Спортивная\", action: \"selection\", target: \"sportivnaya\", buttonType: \"option\" },\n                    { id: \"purple-admiralteyskaya\", text: \"🟪 Адмиралтейская\", action: \"selection\", target: \"admiralteyskaya\", buttonType: \"option\" },\n                    { id: \"purple-sadovaya\", text: \"🟪 Садовая\", action: \"selection\", target: \"sadovaya\", buttonType: \"option\" },\n                    { id: \"purple-zvenigorodskaya\", text: \"🟪 Звенигородская\", action: \"selection\", target: \"zvenigorodskaya\", buttonType: \"option\" },\n                    { id: \"purple-obvodniy\", text: \"🟪 Обводный канал\", action: \"selection\", target: \"obvodniy\", buttonType: \"option\" },\n                    { id: \"purple-volkovskaya\", text: \"🟪 Волковская\", action: \"selection\", target: \"volkovskaya\", buttonType: \"option\" },\n                    { id: \"purple-buharestskaya\", text: \"🟪 Бухарестская\", action: \"selection\", target: \"buharestskaya\", buttonType: \"option\" },\n                    { id: \"purple-mezhdunar\", text: \"🟪 Международная\", action: \"selection\", target: \"mezhdunar\", buttonType: \"option\" },\n                    { id: \"btn-back-metro-purple\", text: \"⬅️ Назад к веткам\", action: \"goto\", target: \"metro_selection\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n            ]\n          },\n\n          // Лист 4: Интересы и хобби\n          {\n            id: \"interests_sheet\",\n            name: \"🎯 Интересы\",\n            nodes: [\n              {\n                id: \"interests_categories\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"Выбери категории интересов: 🎯\\n\\n(Можешь выбрать несколько)\",\n                  synonyms: [\"интересы\", \"хобби\", \"увлечения\", \"что нравится\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"interests_categories\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    {\n                      id: \"btn-music\",\n                      text: \"🎵 Музыка\",\n                      action: \"goto\",\n                      target: \"music_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-hobby\",\n                      text: \"🎨 Хобби\",\n                      action: \"goto\",\n                      target: \"hobby_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-social\",\n                      text: \"👥 Общение\",\n                      action: \"goto\",\n                      target: \"social_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-creativity\",\n                      text: \"🎭 Творчество\",\n                      action: \"goto\",\n                      target: \"creativity_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-active\",\n                      text: \"⚽ Активности\",\n                      action: \"goto\",\n                      target: \"active_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-food\",\n                      text: \"🍔 Еда\",\n                      action: \"goto\",\n                      target: \"food_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    },\n                    {\n                      id: \"btn-sport\",\n                      text: \"🏋️ Спорт\",\n                      action: \"goto\",\n                      target: \"sport_interests\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"music_interests\",\n                type: \"message\",\n                position: { x: 100, y: 500 },\n                data: {\n                  messageText: \"🎵 Какая музыка тебе нравится?\\n\\n(Можешь выбрать несколько)\",\n                  synonyms: [\"музыка\", \"песни\", \"треки\", \"жанры\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"music-pop\", text: \"🎤 Поп\", action: \"selection\", target: \"pop\", buttonType: \"option\" },\n                    { id: \"music-rock\", text: \"🎸 Рок\", action: \"selection\", target: \"rock\", buttonType: \"option\" },\n                    { id: \"music-electronic\", text: \"🎧 Электро\", action: \"selection\", target: \"electronic\", buttonType: \"option\" },\n                    { id: \"music-jazz\", text: \"🎺 Джаз\", action: \"selection\", target: \"jazz\", buttonType: \"option\" },\n                    { id: \"music-classical\", text: \"🎼 Классика\", action: \"selection\", target: \"classical\", buttonType: \"option\" },\n                    { id: \"music-hiphop\", text: \"🎤 Хип-хоп\", action: \"selection\", target: \"hiphop\", buttonType: \"option\" },\n                    { id: \"music-indie\", text: \"🎸 Инди\", action: \"selection\", target: \"indie\", buttonType: \"option\" },\n                    { id: \"music-rnb\", text: \"🎵 R&B\", action: \"selection\", target: \"rnb\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-music\", text: \"⬅️ Назад к категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"hobby_interests\",\n                type: \"message\",\n                position: { x: 700, y: 500 },\n                data: {\n                  messageText: \"🎨 Какие у тебя хобби?\\n\\n(Можешь выбрать несколько)\",\n                  synonyms: [\"хобби\", \"увлечения\", \"занятия\", \"досуг\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"hobby-reading\", text: \"📚 Чтение\", action: \"selection\", target: \"reading\", buttonType: \"option\" },\n                    { id: \"hobby-gaming\", text: \"🎮 Игры\", action: \"selection\", target: \"gaming\", buttonType: \"option\" },\n                    { id: \"hobby-cooking\", text: \"👨‍🍳 Готовка\", action: \"selection\", target: \"cooking\", buttonType: \"option\" },\n                    { id: \"hobby-gardening\", text: \"🌱 Садоводство\", action: \"selection\", target: \"gardening\", buttonType: \"option\" },\n                    { id: \"hobby-collecting\", text: \"🏺 Коллекции\", action: \"selection\", target: \"collecting\", buttonType: \"option\" },\n                    { id: \"hobby-diy\", text: \"🔨 DIY\", action: \"selection\", target: \"diy\", buttonType: \"option\" },\n                    { id: \"hobby-pets\", text: \"🐕 Животные\", action: \"selection\", target: \"pets\", buttonType: \"option\" },\n                    { id: \"hobby-tech\", text: \"💻 Технологии\", action: \"selection\", target: \"tech\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-hobby\", text: \"⬅️ Назад к категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"social_interests\",\n                type: \"message\",\n                position: { x: 100, y: 500 },\n                data: {\n                  messageText: \"Выбери интересы в категории 👥 Общение:\",\n                  synonyms: [\"общение\", \"социальное\", \"люди\", \"тусовки\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"social-parties\", text: \"🎉 Вечеринки\", action: \"selection\", target: \"parties\", buttonType: \"option\" },\n                    { id: \"social-networking\", text: \"🤝 Нетворкинг\", action: \"selection\", target: \"networking\", buttonType: \"option\" },\n                    { id: \"social-dating\", text: \"💕 Знакомства\", action: \"selection\", target: \"dating\", buttonType: \"option\" },\n                    { id: \"social-volunteering\", text: \"🤲 Волонтёрство\", action: \"selection\", target: \"volunteering\", buttonType: \"option\" },\n                    { id: \"social-events\", text: \"🎪 Мероприятия\", action: \"selection\", target: \"events\", buttonType: \"option\" },\n                    { id: \"social-community\", text: \"👥 Сообщества\", action: \"selection\", target: \"community\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-social\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"creativity_interests\",\n                type: \"message\",\n                position: { x: 700, y: 700 },\n                data: {\n                  messageText: \"Выбери интересы в категории 🎭 Творчество:\",\n                  synonyms: [\"творчество\", \"искусство\", \"рисование\", \"музыка\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"creativity-art\", text: \"🎨 Рисование\", action: \"selection\", target: \"art\", buttonType: \"option\" },\n                    { id: \"creativity-music\", text: \"🎵 Музыка\", action: \"selection\", target: \"music\", buttonType: \"option\" },\n                    { id: \"creativity-photography\", text: \"📸 Фотография\", action: \"selection\", target: \"photography\", buttonType: \"option\" },\n                    { id: \"creativity-writing\", text: \"✍️ Писательство\", action: \"selection\", target: \"writing\", buttonType: \"option\" },\n                    { id: \"creativity-design\", text: \"🖌️ Дизайн\", action: \"selection\", target: \"design\", buttonType: \"option\" },\n                    { id: \"creativity-handmade\", text: \"🧶 Рукоделие\", action: \"selection\", target: \"handmade\", buttonType: \"option\" },\n                    { id: \"creativity-theater\", text: \"🎭 Театр\", action: \"selection\", target: \"theater\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-creativity\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"active_interests\",\n                type: \"message\",\n                position: { x: 1000, y: 700 },\n                data: {\n                  messageText: \"Выбери интересы в категории ⚽ Активности:\",\n                  synonyms: [\"активность\", \"активный\", \"движение\", \"здоровье\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"active-running\", text: \"🏃 Бег\", action: \"selection\", target: \"running\", buttonType: \"option\" },\n                    { id: \"active-gym\", text: \"💪 Тренажёрный зал\", action: \"selection\", target: \"gym\", buttonType: \"option\" },\n                    { id: \"active-cycling\", text: \"🚴 Велосипед\", action: \"selection\", target: \"cycling\", buttonType: \"option\" },\n                    { id: \"active-hiking\", text: \"🥾 Походы\", action: \"selection\", target: \"hiking\", buttonType: \"option\" },\n                    { id: \"active-yoga\", text: \"🧘 Йога\", action: \"selection\", target: \"yoga\", buttonType: \"option\" },\n                    { id: \"active-swimming\", text: \"🏊 Плавание\", action: \"selection\", target: \"swimming\", buttonType: \"option\" },\n                    { id: \"active-dancing\", text: \"💃 Танцы\", action: \"selection\", target: \"dancing\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-active\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"food_interests\",\n                type: \"message\",\n                position: { x: 1300, y: 700 },\n                data: {\n                  messageText: \"Выбери интересы в категории 🍔 Еда:\",\n                  synonyms: [\"еда\", \"напитки\", \"кухня\", \"рестораны\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"food-cooking\", text: \"👨‍🍳 Готовка\", action: \"selection\", target: \"cooking\", buttonType: \"option\" },\n                    { id: \"food-restaurants\", text: \"🍽️ Рестораны\", action: \"selection\", target: \"restaurants\", buttonType: \"option\" },\n                    { id: \"food-wine\", text: \"🍷 Вино\", action: \"selection\", target: \"wine\", buttonType: \"option\" },\n                    { id: \"food-coffee\", text: \"☕ Кофе\", action: \"selection\", target: \"coffee\", buttonType: \"option\" },\n                    { id: \"food-baking\", text: \"🧁 Выпечка\", action: \"selection\", target: \"baking\", buttonType: \"option\" },\n                    { id: \"food-street\", text: \"🌮 Стрит-фуд\", action: \"selection\", target: \"street_food\", buttonType: \"option\" },\n                    { id: \"food-healthy\", text: \"🥗 Здоровое питание\", action: \"selection\", target: \"healthy_food\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-food\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"sport_interests\",\n                type: \"message\",\n                position: { x: 1600, y: 700 },\n                data: {\n                  messageText: \"Выбери интересы в категории 🏋️ Спорт:\",\n                  synonyms: [\"спорт\", \"фитнес\", \"тренировки\", \"футбол\"],\n                  keyboardType: \"inline\",\n                  allowMultipleSelection: true,\n                  multiSelectVariable: \"user_interests\",\n                  continueButtonTarget: \"marital_status\",\n                  buttons: [\n                    { id: \"sport-football\", text: \"⚽ Футбол\", action: \"selection\", target: \"football\", buttonType: \"option\" },\n                    { id: \"sport-basketball\", text: \"🏀 Баскетбол\", action: \"selection\", target: \"basketball\", buttonType: \"option\" },\n                    { id: \"sport-tennis\", text: \"🎾 Теннис\", action: \"selection\", target: \"tennis\", buttonType: \"option\" },\n                    { id: \"sport-hockey\", text: \"🏒 Хоккей\", action: \"selection\", target: \"hockey\", buttonType: \"option\" },\n                    { id: \"sport-volleyball\", text: \"🏐 Волейбол\", action: \"selection\", target: \"volleyball\", buttonType: \"option\" },\n                    { id: \"sport-mma\", text: \"🥊 Единоборства\", action: \"selection\", target: \"mma\", buttonType: \"option\" },\n                    { id: \"sport-esports\", text: \"🎮 Киберспорт\", action: \"selection\", target: \"esports\", buttonType: \"option\" },\n                    { id: \"btn-back-categories-sport\", text: \"⬅️ К категориям\", action: \"goto\", target: \"interests_categories\", buttonType: \"navigation\" }\n                  ],\n                  markdown: false\n                }\n              },\n            ]\n          },\n\n          // Лист 5: Личная информация\n          {\n            id: \"personal_sheet\",\n            name: \"💝 Личная информация\",\n            nodes: [\n              {\n                id: \"marital_status\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"Твое семейное положение: 💍\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"marital_status\",\n                  synonyms: [\"семейное положение\", \"отношения\", \"статус\"],\n                  buttons: [\n                    {\n                      id: \"btn-single\",\n                      text: \"Холост/Не замужем 💚\",\n                      value: \"single\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-relationship\",\n                      text: \"В отношениях 💙\",\n                      value: \"relationship\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-married\",\n                      text: \"Женат/Замужем 💛\",\n                      value: \"married\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-complicated\",\n                      text: \"Всё сложно 🤷\",\n                      value: \"complicated\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"sexual_orientation\",\n                type: \"message\",\n                position: { x: 400, y: 500 },\n                data: {\n                  messageText: \"Твоя ориентация: 🌈\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  inputVariable: \"sexual_orientation\",\n                  synonyms: [\"ориентация\", \"предпочтения\", \"интерес\"],\n                  buttons: [\n                    {\n                      id: \"btn-hetero\",\n                      text: \"Гетеро 👫\",\n                      value: \"heterosexual\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-gay\",\n                      text: \"Гей 👬\",\n                      value: \"gay\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-lesbian\",\n                      text: \"Лесбиянка 👭\",\n                      value: \"lesbian\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-bi\",\n                      text: \"Би 🌈\",\n                      value: \"bisexual\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-other\",\n                      text: \"Другое 🎭\",\n                      value: \"other\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"channel_choice\",\n                type: \"message\",\n                position: { x: 400, y: 700 },\n                data: {\n                  messageText: \"Хочешь указать свой телеграм-канал? 📢\\n\\nВведи ссылку, ник с @ или просто имя канала, либо нажми 'Пропустить':\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"telegram_channel\",\n                  synonyms: [\"канал\", \"тг\", \"телеграм\", \"ссылка\"],\n                  inputTargetNodeId: \"extra_info\",\n                  buttons: [\n                    {\n                      id: \"btn-skip-channel\",\n                      text: \"Пропустить ⏭️\",\n                      action: \"goto\",\n                      target: \"extra_info\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"extra_info\",\n                type: \"message\",\n                position: { x: 400, y: 900 },\n                data: {\n                  messageText: \"Хочешь добавить что-то ещё о себе? 📝\\n\\nРасскажи о себе (до 2000 символов) или нажми 'Пропустить':\",\n                  keyboardType: \"inline\",\n                  collectUserInput: true,\n                  enableTextInput: true,\n                  inputVariable: \"extra_info\",\n                  synonyms: [\"о себе\", \"дополнительно\", \"больше\", \"еще\"],\n                  inputTargetNodeId: \"profile_complete\",\n                  buttons: [\n                    {\n                      id: \"btn-skip-extra\",\n                      text: \"Пропустить ⏭️\",\n                      action: \"goto\",\n                      target: \"profile_complete\",\n                      buttonType: \"normal\",\n                      skipDataCollection: true\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n            ]\n          },\n\n          // Лист 6: Профиль и команды\n          {\n            id: \"profile_sheet\",\n            name: \"👤 Профиль\",\n            nodes: [\n              {\n                id: \"profile_complete\",\n                type: \"message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  messageText: \"🎉 Отлично! Твой профиль заполнен!\\n\\n👤 Твоя анкета:\\nПол: {gender}\\nИмя: {user_name}\\nВозраст: {user_age}\\nМетро: {metro_stations}\\nИнтересы: {user_interests}\\nСемейное положение: {marital_status}\\nОриентация: {sexual_orientation}\\n\\n💬 Источник: {user_source}\\n\\nМожешь посмотреть полную анкету или сразу получить ссылку на чат!\",\n                  synonyms: [],\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-chat-link\",\n                      text: \"Ссылка на чат 🔗\",\n                      action: \"command\",\n                      target: \"/link\",\n                      buttonType: \"normal\"\n                    },\n                    {\n                      id: \"btn-show-profile-edit\",\n                      text: \"Редактировать профиль ✏️\",\n                      action: \"command\",\n                      target: \"/profile\",\n                      buttonType: \"normal\"\n                    }\n                  ],\n                  markdown: false,\n                  oneTimeKeyboard: true,\n                  resizeKeyboard: true\n                }\n              },\n              {\n                id: \"show_profile\",\n                type: \"command\",\n                position: { x: 400, y: 500 },\n                data: {\n                  command: \"/profile\",\n                  commandName: \"/profile\",\n                  description: \"Показать и редактировать профиль пользователя\",\n                  synonyms: [\"профиль\", \"анкета\", \"мои данные\", \"редактировать\"],\n                  messageText: \"👤 Твой профиль:\\n\\nПол: {gender} 👤\\nИмя: {user_name} ✏️\\nВозраст: {user_age} 🎂\\nМетро: {metro_stations} 🚇\\nИнтересы: {user_interests} 🎯\\nСемейное положение: {marital_status} 💍\\nОриентация: {sexual_orientation} 🌈\\n\\n💬 Источник: {user_source}\\n\\n✏️ Выберите действие:\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-edit-gender\",\n                      text: \"👤 Изменить пол\",\n                      action: \"goto\",\n                      target: \"gender_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-name\",\n                      text: \"✏️ Изменить имя\",\n                      action: \"goto\",\n                      target: \"name_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-age\",\n                      text: \"🎂 Изменить возраст\",\n                      action: \"goto\",\n                      target: \"age_input\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-metro\",\n                      text: \"🚇 Изменить метро\",\n                      action: \"goto\",\n                      target: \"metro_selection\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-interests\",\n                      text: \"🎯 Изменить интересы\",\n                      action: \"goto\",\n                      target: \"interests_categories\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-marital\",\n                      text: \"💍 Изменить семейное положение\",\n                      action: \"goto\",\n                      target: \"marital_status\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-orientation\",\n                      text: \"🌈 Изменить ориентацию\",\n                      action: \"goto\",\n                      target: \"sexual_orientation\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-channel\",\n                      text: \"📢 Указать ТГК\",\n                      action: \"goto\",\n                      target: \"channel_choice\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-edit-extra\",\n                      text: \"📝 Добавить о себе\",\n                      action: \"goto\",\n                      target: \"extra_info\",\n                      buttonType: \"option\"\n                    },\n                    {\n                      id: \"btn-restart-from-profile\",\n                      text: \"🔄 Начать заново\",\n                      action: \"command\",\n                      target: \"/start\",\n                      buttonType: \"navigation\"\n                    }\n                  ],\n                  markdown: false\n                }\n              },\n              {\n                id: \"chat_link\",\n                type: \"command\",\n                position: { x: 400, y: 700 },\n                data: {\n                  command: \"/link\",\n                  commandName: \"/link\",\n                  description: \"Получить ссылку на чат сообщества\",\n                  synonyms: [\"ссылка\", \"чат\", \"сообщество\", \"впрогулке\", \"линк\"],\n                  messageText: \"🔗 Актуальная ссылка на чат:\\n\\nhttps://t.me/+agkIVgCzHtY2ZTA6\\n\\nДобро пожаловать в сообщество ᴠᴨᴩᴏᴦʏᴧᴋᴇ! 🎉\",\n                  keyboardType: \"none\",\n                  buttons: [],\n                  markdown: false\n                }\n              },\n              {\n                id: \"help_command\",\n                type: \"command\",\n                position: { x: 400, y: 900 },\n                data: {\n                  command: \"/help\",\n                  commandName: \"/help\",\n                  description: \"Полная справка по всем командам бота и модерации\",\n                  synonyms: [\"помощь\", \"справка\", \"команды\", \"что писать\", \"как пользоваться\", \"админ справка\", \"админ помощь\", \"админ команды\"],\n                  messageText: \"🤖 **Добро пожаловать в справочный центр!**\\n\\n🌟 **ᴠᴨᴩᴏᴦʏᴧᴋᴇ Bot**\\n*Твой помощник в знакомствах*\\n\\n🎯 **ОСНОВНЫЕ КОМАНДЫ:**\\n\\n🚀 `/start` — *Начать заново*\\n   📝 Синонимы: `старт`, `начать`, `привет`, `начало`, `начинаем`\\n\\n👤 `/profile` — *Мой профиль*\\n   📝 Синонимы: `профиль`, `анкета`, `мой профиль`, `посмотреть профиль`, `редактировать профиль`\\n\\n🔗 `/link` — *Ссылка на чат*\\n   📝 Синонимы: `ссылка`, `чат`, `сообщество`, `впрогулке`, `линк`\\n\\n🆘 `/help` — *Эта справка*\\n   📝 Синонимы: `помощь`, `справка`, `команды`, `что писать`, `как пользоваться`\\n\\n📋 **РАЗДЕЛЫ АНКЕТЫ И ИХ СИНОНИМЫ:**\\n\\n👫 **Пол:** мужской, женский\\n   📝 Синонимы: `пол`, `gender`\\n\\n🏷️ **Имя:** любое имя\\n   📝 Синонимы: `имя`, `как зовут`, `назовись`\\n\\n🎂 **Возраст:** число от 18 до 99\\n   📝 Синонимы: `возраст`, `лет`, `сколько лет`\\n\\n🚇 **Метро:** выбор линии и станции\\n   📝 Синонимы: `метро`, `станция`\\n   🟥 Красная линия: `красная линия`, `кировско-выборгская`, `красная ветка`\\n   🟦 Синяя линия: `синяя линия`, `московско-петроградская`, `синяя ветка`\\n   🟩 Зеленая линия: `зеленая линия`, `невско-василеостровская`, `зеленая ветка`\\n   🟧 Оранжевая линия: `оранжевая линия`, `правобережная`, `оранжевая ветка`\\n   🟪 Фиолетовая линия: `фиолетовая линия`, `фрунзенско-приморская`, `фиолетовая ветка`\\n\\n🎨 **Интересы и их синонимы:**\\n   🎮 Хобби: `хобби`, `увлечения`, `занятия`, `игры`\\n   🤝 Социальная жизнь: `общение`, `социальное`, `люди`, `тусовки`\\n   🎭 Творчество: `творчество`, `искусство`, `рисование`, `музыка`\\n   💪 Активный образ жизни: `активность`, `активный`, `движение`, `здоровье`\\n   🍕 Еда и напитки: `еда`, `напитки`, `кухня`, `рестораны`\\n   ⚽ Спорт: `спорт`, `фитнес`, `тренировки`, `футбол`\\n\\n💑 **Семейное положение:** поиск, отношения, женат/замужем, сложно\\n   📝 Синонимы: `семейное положение`, `статус`, `отношения`, `семья`\\n\\n🌈 **Ориентация:** гетеро, гей, лесби, би, другое\\n   📝 Синонимы: `ориентация`, `предпочтения`\\n\\n📺 **Телеграм-канал:** опционально\\n   📝 Синонимы: `тгк`, `телеграм`, `канал`, `тг канал`\\n\\n📖 **О себе:** дополнительная информация\\n   📝 Синонимы: `о себе`, `описание`, `расскажи`, `инфо`\\n\\n👮‍♂️ **КОМАНДЫ МОДЕРАЦИИ:**\\n\\n**Управление контентом:**\\n📌 `/pin_message` - Закрепить сообщение\\n   📝 Синонимы: `закрепить`, `прикрепить`, `зафиксировать`\\n\\n📌❌ `/unpin_message` - Открепить сообщение\\n   📝 Синонимы: `открепить`, `отцепить`, `убрать закрепление`\\n\\n🗑️ `/delete_message` - Удалить сообщение\\n   📝 Синонимы: `удалить`, `стереть`, `убрать сообщение`\\n\\n**Управление пользователями:**\\n🚫 `/ban_user` - Заблокировать пользователя\\n   📝 Синонимы: `забанить`, `заблокировать`, `бан`\\n\\n✅ `/unban_user` - Разблокировать пользователя\\n   📝 Синонимы: `разбанить`, `разблокировать`, `unbán`\\n\\n🔇 `/mute_user` - Ограничить пользователя\\n   📝 Синонимы: `замутить`, `заглушить`, `мут`\\n\\n🔊 `/unmute_user` - Снять ограничения\\n   📝 Синонимы: `размутить`, `разглушить`, `анмут`\\n\\n👢 `/kick_user` - Исключить пользователя\\n   📝 Синонимы: `кикнуть`, `исключить`, `выгнать`\\n\\n👑 `/promote_user` - Назначить администратором\\n   📝 Синонимы: `повысить`, `назначить админом`, `промоут`\\n\\n👤 `/demote_user` - Снять с администратора\\n   📝 Синонимы: `понизить`, `снять с админа`, `демоут`\\n\\n⚙️ `/admin_rights` - Настроить права администратора\\n   📝 Синонимы: `права админа`, `настроить права`, `тг права`\\n   ⚠️ Только для администраторов группы!\\n   💡 Ответьте на сообщение пользователя командой\\n\\n**Примеры использования:**\\n• Ответьте на сообщение командой для его обработки\\n• Используйте команды в ответ на сообщения нарушителей\\n• Команды с правами работают только в группах/супергруппах\\n• Все действия логируются для отчетности\\n\\n💡 **ПОЛЕЗНЫЕ СОВЕТЫ:**\\n\\n✨ Можешь писать команды или синонимы в любом месте разговора\\n✨ Бот поймет твои сообщения даже без команд\\n✨ В любой момент можешь написать /start для начала заново\\n✨ Используй /profile для изменения любых данных\\n✨ Нажми на любое выделенное слово чтобы скопировать его!\\n\\n🎉 **Удачных знакомств в Питере!** 🎉\",\n                  keyboardType: \"inline\",\n                  buttons: [\n                    {\n                      id: \"btn-help-start\",\n                      text: \"🚀 Начать заполнение\",\n                      action: \"command\",\n                      target: \"/start\",\n                      buttonType: \"navigation\"\n                    },\n                    {\n                      id: \"btn-help-profile\",\n                      text: \"👤 Мой профиль\",\n                      action: \"command\",\n                      target: \"/profile\",\n                      buttonType: \"navigation\"\n                    },\n                    {\n                      id: \"btn-help-link\",\n                      text: \"🔗 Ссылка на чат\",\n                      action: \"command\",\n                      target: \"/link\",\n                      buttonType: \"navigation\"\n                    }\n                  ],\n                  markdown: true,\n                  formatMode: \"markdown\",\n                  showInMenu: true,\n                  isPrivateOnly: false,\n                  requiresAuth: false,\n                  adminOnly: false\n                }\n              }\n            ]\n          },\n\n          // ===== ЛИСТЫ ИЗ АДМИН-ПАНЕЛИ МОДЕРАТОРА =====\n\n          // Лист 8: Управление контентом\n          {\n            id: \"content_sheet\",\n            name: \"📝 Управление контентом\",\n            description: \"Инструменты для модерации сообщений и контента\",\n            nodes: [\n              {\n                id: \"pin_message_node\",\n                type: \"pin_message\",\n                position: { x: 200, y: 300 },\n                data: {\n                  command: \"/pin_message\",\n                  messageText: \"📌 Сообщение успешно закреплено!\",\n                  synonyms: [\"закрепить\", \"прикрепить\", \"зафиксировать\"],\n                  disableNotification: false,\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"unpin_message_node\",\n                type: \"unpin_message\",\n                position: { x: 400, y: 300 },\n                data: {\n                  command: \"/unpin_message\",\n                  messageText: \"📌❌ Сообщение успешно откреплено!\",\n                  synonyms: [\"открепить\", \"отцепить\", \"убрать закрепление\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"delete_message_node\",\n                type: \"delete_message\",\n                position: { x: 600, y: 300 },\n                data: {\n                  command: \"/delete_message\",\n                  messageText: \"🗑️ Сообщение успешно удалено!\",\n                  synonyms: [\"удалить\", \"стереть\", \"убрать сообщение\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              }\n            ],\n            connections: []\n          },\n\n          // Лист 9: Управление пользователями\n          {\n            id: \"users_sheet\",\n            name: \"👥 Управление пользователями\",\n            description: \"Инструменты для модерации участников группы\",\n            nodes: [\n              {\n                id: \"ban_user_node\",\n                type: \"ban_user\",\n                position: { x: 100, y: 500 },\n                data: {\n                  command: \"/ban_user\",\n                  messageText: \"🚫 Пользователь заблокирован в группе!\",\n                  synonyms: [\"забанить\", \"заблокировать\", \"бан\"],\n                  reason: \"Нарушение правил группы\",\n                  untilDate: 0,\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"unban_user_node\",\n                type: \"unban_user\",\n                position: { x: 250, y: 500 },\n                data: {\n                  command: \"/unban_user\",\n                  messageText: \"✅ Пользователь разблокирован!\",\n                  synonyms: [\"разбанить\", \"разблокировать\", \"unbан\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"mute_user_node\",\n                type: \"mute_user\",\n                position: { x: 400, y: 500 },\n                data: {\n                  command: \"/mute_user\",\n                  messageText: \"🔇 Пользователь ограничен в правах!\",\n                  synonyms: [\"замутить\", \"заглушить\", \"мут\"],\n                  reason: \"Нарушение правил группы\",\n                  duration: 3600,\n                  canSendMessages: false,\n                  canSendMediaMessages: false,\n                  canSendPolls: false,\n                  canSendOtherMessages: false,\n                  canAddWebPagePreviews: false,\n                  canChangeGroupInfo: false,\n                  canInviteUsers2: false,\n                  canPinMessages2: false,\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"unmute_user_node\",\n                type: \"unmute_user\",\n                position: { x: 550, y: 500 },\n                data: {\n                  command: \"/unmute_user\",\n                  messageText: \"🔊 Ограничения с пользователя сняты!\",\n                  synonyms: [\"размутить\", \"разглушить\", \"анмут\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"kick_user_node\",\n                type: \"kick_user\",\n                position: { x: 700, y: 500 },\n                data: {\n                  command: \"/kick_user\",\n                  messageText: \"👢 Пользователь исключен из группы!\",\n                  synonyms: [\"кикнуть\", \"исключить\", \"выгнать\"],\n                  reason: \"Нарушение правил группы\",\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"promote_user_node\",\n                type: \"promote_user\",\n                position: { x: 500, y: 700 },\n                data: {\n                  command: \"/promote_user\",\n                  messageText: \"👑 Пользователь назначен администратором!\",\n                  synonyms: [\"повысить\", \"назначить админом\", \"промоут\"],\n                  canChangeInfo: false,\n                  canDeleteMessages: true,\n                  canBanUsers: false,\n                  canInviteUsers: true,\n                  canPinMessages: true,\n                  canAddAdmins: false,\n                  canRestrictMembers: false,\n                  canPromoteMembers: false,\n                  canManageVideoChats: false,\n                  isAnonymous: false,\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"demote_user_node\",\n                type: \"demote_user\",\n                position: { x: 700, y: 700 },\n                data: {\n                  command: \"/demote_user\",\n                  messageText: \"👤 Пользователь снят с должности администратора!\",\n                  synonyms: [\"понизить\", \"снять с админа\", \"демоут\"],\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              },\n              {\n                id: \"admin_rights_node\",\n                type: \"admin_rights\",\n                position: { x: 300, y: 900 },\n                data: {\n                  command: \"/admin_rights\",\n                  messageText: \"⚙️ Права администратора настроены для пользователя!\\n\\n💡 Чтобы настроить права, ответьте на сообщение пользователя и используйте команду /admin_rights\",\n                  synonyms: [\"права админа\", \"настроить права\", \"тг права\", \"права администратора\", \"admin rights\"],\n                  description: \"Настройка прав администратора в группе (только для админов)\",\n                  adminUserIdSource: \"reply_to_message\",\n                  adminOnly: true,\n                  requiresGroup: true,\n                  isPrivateOnly: false,\n                  can_manage_chat: false,\n                  can_delete_messages: true,\n                  can_manage_video_chats: false,\n                  can_restrict_members: true,\n                  can_promote_members: false,\n                  can_change_info: false,\n                  can_invite_users: true,\n                  can_pin_messages: true,\n                  can_manage_topics: false,\n                  is_anonymous: false,\n                  adminChatIdSource: \"current_chat\",\n                  keyboardType: \"none\",\n                  buttons: []\n                }\n              }\n            ],\n            connections: []\n          }\n        ],\n\n        // Связи между листами\n        interSheetConnections: [\n          // === ОСНОВНОЙ ПОТОК ВПрогулке ===\n          // Из приветствия к основной информации\n          {\n            id: \"inter-welcome-basic\",\n            sourceSheetId: \"welcome_sheet\",\n            targetSheetId: \"basic_info_sheet\",\n            sourceNodeId: \"join_request\",\n            targetNodeId: \"gender_selection\",\n            sourceHandle: \"btn-yes\",\n            targetHandle: \"target\"\n          },\n          // Из основной информации к метро\n          {\n            id: \"inter-basic-metro\",\n            sourceSheetId: \"basic_info_sheet\",\n            targetSheetId: \"metro_sheet\",\n            sourceNodeId: \"age_input\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          // Из метро к интересам\n          {\n            id: \"inter-metro-interests\",\n            sourceSheetId: \"metro_sheet\",\n            targetSheetId: \"interests_sheet\",\n            sourceNodeId: \"metro_selection\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          // Из интересов к личной информации\n          {\n            id: \"inter-interests-personal\",\n            sourceSheetId: \"interests_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"interests_categories\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n          // Из личной информации к профилю\n          {\n            id: \"inter-personal-profile\",\n            sourceSheetId: \"personal_sheet\",\n            targetSheetId: \"profile_sheet\",\n            sourceNodeId: \"extra_info\",\n            targetNodeId: \"profile_complete\",\n            sourceHandle: \"source\",\n            targetHandle: \"target\"\n          },\n\n          // === РЕДАКТИРОВАНИЕ ПРОФИЛЯ (Возврат к соответствующим листам) ===\n          {\n            id: \"inter-profile-basic-gender\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"basic_info_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"gender_selection\",\n            sourceHandle: \"btn-edit-gender\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-basic-name\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"basic_info_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"name_input\",\n            sourceHandle: \"btn-edit-name\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-basic-age\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"basic_info_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"age_input\",\n            sourceHandle: \"btn-edit-age\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-metro\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"metro_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"metro_selection\",\n            sourceHandle: \"btn-edit-metro\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-interests\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"interests_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"interests_categories\",\n            sourceHandle: \"btn-edit-interests\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-personal-marital\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"marital_status\",\n            sourceHandle: \"btn-edit-marital\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-personal-orientation\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"sexual_orientation\",\n            sourceHandle: \"btn-edit-orientation\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-personal-channel\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"channel_choice\",\n            sourceHandle: \"btn-edit-channel\",\n            targetHandle: \"target\"\n          },\n          {\n            id: \"inter-profile-personal-extra\",\n            sourceSheetId: \"profile_sheet\",\n            targetSheetId: \"personal_sheet\",\n            sourceNodeId: \"show_profile\",\n            targetNodeId: \"extra_info\",\n            sourceHandle: \"btn-edit-extra\",\n            targetHandle: \"target\"\n          }\n        ]\n      }\n    });\n\n    console.log('✅ Объединенный шаблон ВПрогулке + Админ панель создан');\n\n    // Создаем шаблон \"Котик\" - простая анкета знакомств (новейшая версия)\n    await storage.createBotTemplate({\n      name: \"🐱 Котик - Простая анкета\",\n      description: \"Продвинутая анкета для знакомств: возраст, пол, интересы, город, имя, описание и фото. Включает полный цикл с просмотром анкет! С условными сообщениями.\",\n      category: \"community\",\n      tags: [\"котик\", \"анкета\", \"знакомства\", \"простой\", \"начинающие\", \"условные сообщения\"],\n      isPublic: 1,\n      difficulty: \"easy\",\n      authorName: \"Система\",\n      version: \"3.1.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 3,\n      estimatedTime: 10,\n      data: JSON.parse('{\"sheets\":[{\"id\":\"IqCRMfjpni9xmghloqlEx\",\"name\":\"Основной поток\",\"nodes\":[{\"_y\":100,\"id\":\"start\",\"data\":{\"buttons\":[],\"command\":\"/start\",\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"description\":\"Запустить бота\",\"messageText\":\"Сколько тебе лет?\",\"keyboardType\":\"none\",\"requiresAuth\":false,\"inputVariable\":\"age\",\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"enableTextInput\":true,\"oneTimeKeyboard\":false,\"collectUserInput\":true,\"enableStatistics\":true,\"inputTargetNodeId\":\"f90r9k3FSLu2Tjn74cBn_\",\"conditionalMessages\":[{\"id\":\"condition-1763692642023\",\"buttons\":[{\"id\":\"b5XNyuzu_-YIFk3yfUfpj\",\"url\":\"\",\"text\":\"{age}\",\"action\":\"goto\",\"target\":\"f90r9k3FSLu2Tjn74cBn_\",\"buttonType\":\"normal\",\"skipDataCollection\":false}],\"priority\":10,\"condition\":\"user_data_exists\",\"formatMode\":\"text\",\"messageText\":\"\\\\n\",\"keyboardType\":\"reply\",\"variableName\":\"age\",\"logicOperator\":\"AND\",\"variableNames\":[\"age\"],\"waitForTextInput\":true,\"nextNodeAfterInput\":\"f90r9k3FSLu2Tjn74cBn_\"}],\"enableConditionalMessages\":true},\"type\":\"start\",\"position\":{\"x\":100,\"y\":100}},{\"_y\":380,\"id\":\"f90r9k3FSLu2Tjn74cBn_\",\"data\":{\"buttons\":[{\"id\":\"iIkbMb2jlZRJOxGHMNl1a\",\"text\":\"Я девушка\",\"action\":\"goto\",\"target\":\"RFTgm4KzC6dI39AMTPcmo\",\"buttonType\":\"normal\",\"skipDataCollection\":false},{\"id\":\"0dBjAkcTa9rEsjEP48XzB\",\"text\":\"Я парень\",\"action\":\"goto\",\"target\":\"RFTgm4KzC6dI39AMTPcmo\",\"buttonType\":\"normal\",\"skipDataCollection\":false}],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"Теперь определимся с полом\",\"keyboardType\":\"reply\",\"requiresAuth\":false,\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"oneTimeKeyboard\":false,\"enableStatistics\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":380}},{\"_y\":660,\"id\":\"RFTgm4KzC6dI39AMTPcmo\",\"data\":{\"buttons\":[{\"id\":\"6bA3YPgWd20pCqPAeyuLe\",\"text\":\"Девушки\",\"action\":\"goto\",\"target\":\"sIh3xXKEtb_TtrhHqZQzX\",\"buttonType\":\"normal\",\"skipDataCollection\":false},{\"id\":\"hI7nsCdodrcUnft1SXYpg\",\"text\":\"Парни\",\"action\":\"goto\",\"target\":\"sIh3xXKEtb_TtrhHqZQzX\",\"buttonType\":\"normal\",\"skipDataCollection\":false},{\"id\":\"VhOGaPeyFpFV9a7QDBfzo\",\"text\":\"Все равно\",\"action\":\"goto\",\"target\":\"sIh3xXKEtb_TtrhHqZQzX\",\"buttonType\":\"normal\",\"skipDataCollection\":false}],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"Кто тебе интересен?\",\"keyboardType\":\"reply\",\"requiresAuth\":false,\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"oneTimeKeyboard\":false,\"enableStatistics\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":660}},{\"_y\":940,\"id\":\"sIh3xXKEtb_TtrhHqZQzX\",\"data\":{\"buttons\":[],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"Из какого ты города?\",\"keyboardType\":\"none\",\"requiresAuth\":false,\"inputVariable\":\"city\",\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"enableTextInput\":true,\"oneTimeKeyboard\":false,\"collectUserInput\":true,\"enableStatistics\":true,\"inputTargetNodeId\":\"tS2XGL2Mn4LkE63SnxhPy\",\"conditionalMessages\":[{\"id\":\"cond-city-1\",\"buttons\":[{\"id\":\"btn-city-yes\",\"text\":\"{city}\",\"action\":\"goto\",\"target\":\"tS2XGL2Mn4LkE63SnxhPy\",\"buttonType\":\"normal\",\"skipDataCollection\":false}],\"priority\":10,\"condition\":\"user_data_exists\",\"formatMode\":\"text\",\"messageText\":\"\\\\n\",\"keyboardType\":\"reply\",\"variableName\":\"city\",\"logicOperator\":\"AND\",\"variableNames\":[\"city\"],\"waitForTextInput\":true,\"nextNodeAfterInput\":\"tS2XGL2Mn4LkE63SnxhPy\"}],\"enableConditionalMessages\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":940}},{\"_y\":1220,\"id\":\"tS2XGL2Mn4LkE63SnxhPy\",\"data\":{\"buttons\":[],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"Как мне тебя называть?\",\"keyboardType\":\"none\",\"requiresAuth\":false,\"inputVariable\":\"name\",\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"enableTextInput\":true,\"oneTimeKeyboard\":false,\"collectUserInput\":true,\"enableStatistics\":true,\"inputTargetNodeId\":\"lBPy3gcGVLla0NGdSYb35\",\"conditionalMessages\":[{\"id\":\"cond-name-1\",\"buttons\":[{\"id\":\"9Qihav_1tM43MLvkUr1y1\",\"url\":\"\",\"text\":\"{name}\",\"action\":\"goto\",\"target\":\"\",\"buttonType\":\"normal\",\"skipDataCollection\":false}],\"priority\":10,\"condition\":\"user_data_exists\",\"formatMode\":\"text\",\"messageText\":\"\\\\n\",\"keyboardType\":\"reply\",\"variableName\":\"name\",\"logicOperator\":\"AND\",\"variableNames\":[\"name\"],\"waitForTextInput\":false,\"nextNodeAfterInput\":\"lBPy3gcGVLla0NGdSYb35\"}],\"enableConditionalMessages\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":1220}},{\"_y\":1500,\"id\":\"lBPy3gcGVLla0NGdSYb35\",\"data\":{\"buttons\":[{\"id\":\"g9KWWguVciHEUMMeyZ-WN\",\"text\":\"Пропустить\",\"action\":\"goto\",\"target\":\"Y9zLRp1BLpVhm-HcsNkJV\",\"buttonType\":\"normal\",\"skipDataCollection\":true}],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"Расскажи о себе и кого хочешь найти, чем предлагаешь заняться. Это поможет лучше подобрать тебе компанию.\",\"keyboardType\":\"reply\",\"requiresAuth\":false,\"inputVariable\":\"info\",\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"enableTextInput\":true,\"oneTimeKeyboard\":false,\"collectUserInput\":true,\"enableStatistics\":true,\"inputTargetNodeId\":\"vxPv7G4n0QGyhnv4ucOM5\",\"conditionalMessages\":[{\"id\":\"cond-info-1\",\"buttons\":[{\"id\":\"btn-info-skip\",\"text\":\"Оставить текущий текст\",\"action\":\"goto\",\"target\":\"Y9zLRp1BLpVhm-HcsNkJV\",\"buttonType\":\"normal\",\"skipDataCollection\":true}],\"priority\":10,\"condition\":\"user_data_exists\",\"formatMode\":\"text\",\"messageText\":\"\\\\n\",\"keyboardType\":\"reply\",\"variableName\":\"info\",\"logicOperator\":\"AND\",\"variableNames\":[\"info\"],\"waitForTextInput\":true,\"nextNodeAfterInput\":\"vxPv7G4n0QGyhnv4ucOM5\"}],\"enableConditionalMessages\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":1500}},{\"_y\":1780,\"id\":\"Y9zLRp1BLpVhm-HcsNkJV\",\"data\":{\"buttons\":[],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"Теперь пришли фото или запиши видео 👍 (до 15 сек), его будут видеть другие пользователи\",\"keyboardType\":\"none\",\"requiresAuth\":false,\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"oneTimeKeyboard\":false,\"collectUserInput\":true,\"enablePhotoInput\":true,\"enableStatistics\":true,\"inputTargetNodeId\":\"8xSJaWAJNz7Hz_54mjFTF\",\"photoInputVariable\":\"photo\",\"conditionalMessages\":[{\"id\":\"cond-photo-1\",\"buttons\":[{\"id\":\"btn-photo-keep\",\"text\":\"Оставить текущее\",\"action\":\"goto\",\"target\":\"8xSJaWAJNz7Hz_54mjFTF\",\"buttonType\":\"normal\",\"skipDataCollection\":true}],\"priority\":10,\"condition\":\"user_data_exists\",\"formatMode\":\"text\",\"messageText\":\"\\\\n\",\"keyboardType\":\"reply\",\"variableName\":\"photo\",\"logicOperator\":\"AND\",\"variableNames\":[\"photo\"],\"waitForTextInput\":false}],\"enableConditionalMessages\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":1780}},{\"_y\":2060,\"id\":\"8xSJaWAJNz7Hz_54mjFTF\",\"data\":{\"buttons\":[],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"\\\\n{name}, {age}, {city} - {info}\\\\n\",\"keyboardType\":\"none\",\"requiresAuth\":false,\"attachedMedia\":[\"photo\"],\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"oneTimeKeyboard\":false,\"autoTransitionTo\":\"KE-8sR9elPEefApjXtBxC\",\"enableStatistics\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":2060}},{\"_y\":2340,\"id\":\"KE-8sR9elPEefApjXtBxC\",\"data\":{\"buttons\":[{\"id\":\"Y6DFar0NH2ejdlKLTFgwC\",\"text\":\"Да\",\"action\":\"goto\",\"target\":\"yrsc8v81qQa5oQx538Dzn\",\"buttonType\":\"normal\",\"skipDataCollection\":false},{\"id\":\"e1ZTOjUMpLqjln0LWH3JD\",\"text\":\"Изменить анкету\",\"action\":\"goto\",\"target\":\"start\",\"buttonType\":\"normal\",\"skipDataCollection\":false}],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"Все верно?\",\"keyboardType\":\"reply\",\"requiresAuth\":false,\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"oneTimeKeyboard\":false,\"enableStatistics\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":2340}},{\"_y\":2620,\"id\":\"yrsc8v81qQa5oQx538Dzn\",\"data\":{\"buttons\":[{\"id\":\"kfzexViyPfMpgOffuWXY3\",\"text\":\"1\",\"action\":\"goto\",\"target\":\"\",\"buttonType\":\"normal\",\"skipDataCollection\":false},{\"id\":\"YqVio9545knVkcQWVLbgT\",\"text\":\"2\",\"action\":\"goto\",\"target\":\"start\",\"buttonType\":\"normal\",\"skipDataCollection\":false},{\"id\":\"vMzKMEg84JLzu6EEnrQ5W\",\"text\":\"3\",\"action\":\"goto\",\"target\":\"Y9zLRp1BLpVhm-HcsNkJV\",\"buttonType\":\"normal\",\"skipDataCollection\":false},{\"id\":\"En0QBjOLWkcEpIGLqy6EQ\",\"text\":\"4\",\"action\":\"goto\",\"target\":\"lBPy3gcGVLla0NGdSYb35\",\"buttonType\":\"normal\",\"skipDataCollection\":false}],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"1. Смотреть анкеты.\\\\n2. Заполнить анкету заново.\\\\n3. Изменить фото/видео.\\\\n4. Изменить текст анкеты.\",\"keyboardType\":\"reply\",\"requiresAuth\":false,\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"oneTimeKeyboard\":false,\"enableStatistics\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":2620}},{\"_y\":2900,\"id\":\"vxPv7G4n0QGyhnv4ucOM5\",\"data\":{\"buttons\":[],\"markdown\":false,\"adminOnly\":false,\"showInMenu\":true,\"messageText\":\"<span style=\\\\\"color: rgb(250, 250, 250);\\\\\">Так выглядит твоя анкета:</span>\",\"keyboardType\":\"none\",\"requiresAuth\":false,\"isPrivateOnly\":false,\"resizeKeyboard\":true,\"oneTimeKeyboard\":false,\"autoTransitionTo\":\"8xSJaWAJNz7Hz_54mjFTF\",\"enableStatistics\":true},\"type\":\"message\",\"position\":{\"x\":100,\"y\":2900}}],\"createdAt\":\"2025-11-21T05:08:54.727Z\",\"updatedAt\":\"2025-11-21T05:13:47.377Z\",\"viewState\":{\"zoom\":1,\"position\":{\"x\":0,\"y\":0}},\"connections\":[]}],\"version\":2,\"activeSheetId\":\"IqCRMfjpni9xmghloqlEx\",\"interSheetConnections\":[]}')\n    });\n\n    console.log('✅ Шаблон Котик v3.1 создан (с условными сообщениями из \"котик новая версия\")');\n\n  } catch (error) {\n    console.error('Ошибка при создании шаблонов:', error);\n  }\n}\n\nexport { seedDefaultTemplates };","size_bytes":310932},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\";\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  );\n}\n\n// Предустановленные скелетоны для разных элементов\nfunction EditorSkeleton() {\n  return (\n    <div className=\"flex h-screen\">\n      {/* Боковая панель */}\n      <div className=\"w-64 border-r bg-background p-4 space-y-4\">\n        <Skeleton className=\"h-8 w-full\" />\n        <div className=\"space-y-2\">\n          <Skeleton className=\"h-12 w-full\" />\n          <Skeleton className=\"h-12 w-full\" />\n          <Skeleton className=\"h-12 w-full\" />\n          <Skeleton className=\"h-12 w-full\" />\n        </div>\n      </div>\n      \n      {/* Основная область */}\n      <div className=\"flex-1 flex flex-col\">\n        {/* Заголовок */}\n        <div className=\"border-b h-16 flex items-center px-6 space-x-4\">\n          <Skeleton className=\"h-6 w-32\" />\n          <Skeleton className=\"h-8 w-24\" />\n          <Skeleton className=\"h-8 w-20\" />\n        </div>\n        \n        {/* Холст */}\n        <div className=\"flex-1 flex\">\n          <div className=\"flex-1 p-6\">\n            <div className=\"grid grid-cols-3 gap-6\">\n              <Skeleton className=\"h-32 w-full\" />\n              <Skeleton className=\"h-32 w-full\" />\n              <Skeleton className=\"h-32 w-full\" />\n            </div>\n          </div>\n          \n          {/* Панель свойств */}\n          <div className=\"w-80 border-l p-4 space-y-4\">\n            <Skeleton className=\"h-8 w-full\" />\n            <div className=\"space-y-2\">\n              <Skeleton className=\"h-10 w-full\" />\n              <Skeleton className=\"h-20 w-full\" />\n              <Skeleton className=\"h-10 w-full\" />\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction ProjectsSkeleton() {\n  return (\n    <div className=\"container mx-auto px-6 py-8\">\n      <div className=\"mb-8\">\n        <Skeleton className=\"h-8 w-48 mb-4\" />\n        <div className=\"flex space-x-4\">\n          <Skeleton className=\"h-10 w-32\" />\n          <Skeleton className=\"h-10 w-24\" />\n        </div>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {Array.from({ length: 6 }).map((_, i) => (\n          <div key={i} className=\"border rounded-lg p-4 space-y-4\">\n            <Skeleton className=\"h-6 w-3/4\" />\n            <Skeleton className=\"h-4 w-full\" />\n            <Skeleton className=\"h-4 w-2/3\" />\n            <div className=\"flex space-x-2\">\n              <Skeleton className=\"h-8 w-20\" />\n              <Skeleton className=\"h-8 w-16\" />\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction TemplatesSkeleton() {\n  return (\n    <div className=\"container mx-auto px-6 py-8\">\n      <div className=\"mb-8\">\n        <Skeleton className=\"h-8 w-40 mb-4\" />\n        <div className=\"flex space-x-4\">\n          <Skeleton className=\"h-10 w-64\" />\n          <Skeleton className=\"h-10 w-32\" />\n          <Skeleton className=\"h-10 w-24\" />\n        </div>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {Array.from({ length: 8 }).map((_, i) => (\n          <div key={i} className=\"border rounded-lg p-4 space-y-3\">\n            <Skeleton className=\"h-32 w-full\" />\n            <Skeleton className=\"h-5 w-3/4\" />\n            <Skeleton className=\"h-4 w-full\" />\n            <div className=\"flex justify-between items-center\">\n              <Skeleton className=\"h-6 w-16\" />\n              <Skeleton className=\"h-8 w-20\" />\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport { Skeleton, EditorSkeleton, ProjectsSkeleton, TemplatesSkeleton };\n","size_bytes":3888},"client/src/components/layout/quick-layout-switcher.tsx":{"content":"import React, { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { \n  Layout, \n  ArrowUp, \n  ArrowDown, \n  ArrowLeft, \n  ArrowRight,\n  Grid,\n  Monitor,\n  Smartphone,\n  Tablet\n} from 'lucide-react';\n\nexport interface QuickLayoutPreset {\n  id: string;\n  name: string;\n  description: string;\n  icon: React.ReactNode;\n  config: {\n    headerPosition: 'top' | 'bottom' | 'left' | 'right';\n    sidebarPosition: 'left' | 'right';\n    propertiesPosition: 'right' | 'left';\n    headerSize: number;\n    sidebarSize: number;\n    propertiesSize: number;\n  };\n  preview: React.ReactNode;\n}\n\nconst LAYOUT_PRESETS: QuickLayoutPreset[] = [\n  {\n    id: 'default',\n    name: 'Стандартный',\n    description: 'Заголовок сверху, боковая панель слева, свойства справа',\n    icon: <Monitor className=\"w-5 h-5\" />,\n    config: {\n      headerPosition: 'top',\n      sidebarPosition: 'left',\n      propertiesPosition: 'right',\n      headerSize: 60,\n      sidebarSize: 280,\n      propertiesSize: 320\n    },\n    preview: (\n      <div className=\"w-full h-20 border rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-800\">\n        <div className=\"h-3 bg-blue-200 dark:bg-blue-800\"></div>\n        <div className=\"flex h-17\">\n          <div className=\"w-1/4 bg-green-200 dark:bg-green-800\"></div>\n          <div className=\"flex-1 bg-gray-100 dark:bg-gray-700\"></div>\n          <div className=\"w-1/4 bg-orange-200 dark:bg-orange-800\"></div>\n        </div>\n      </div>\n    )\n  },\n  {\n    id: 'header-bottom',\n    name: 'Заголовок снизу',\n    description: 'Необычный макет с заголовком внизу экрана',\n    icon: <ArrowDown className=\"w-5 h-5\" />,\n    config: {\n      headerPosition: 'bottom',\n      sidebarPosition: 'left',\n      propertiesPosition: 'right',\n      headerSize: 60,\n      sidebarSize: 280,\n      propertiesSize: 320\n    },\n    preview: (\n      <div className=\"w-full h-20 border rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-800\">\n        <div className=\"flex h-17\">\n          <div className=\"w-1/4 bg-green-200 dark:bg-green-800\"></div>\n          <div className=\"flex-1 bg-gray-100 dark:bg-gray-700\"></div>\n          <div className=\"w-1/4 bg-orange-200 dark:bg-orange-800\"></div>\n        </div>\n        <div className=\"h-3 bg-blue-200 dark:bg-blue-800\"></div>\n      </div>\n    )\n  },\n  {\n    id: 'sidebar-right',\n    name: 'Боковая панель справа',\n    description: 'Боковая панель справа, свойства слева',\n    icon: <ArrowRight className=\"w-5 h-5\" />,\n    config: {\n      headerPosition: 'top',\n      sidebarPosition: 'right',\n      propertiesPosition: 'left',\n      headerSize: 60,\n      sidebarSize: 280,\n      propertiesSize: 320\n    },\n    preview: (\n      <div className=\"w-full h-20 border rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-800\">\n        <div className=\"h-3 bg-blue-200 dark:bg-blue-800\"></div>\n        <div className=\"flex h-17\">\n          <div className=\"w-1/4 bg-orange-200 dark:bg-orange-800\"></div>\n          <div className=\"flex-1 bg-gray-100 dark:bg-gray-700\"></div>\n          <div className=\"w-1/4 bg-green-200 dark:bg-green-800\"></div>\n        </div>\n      </div>\n    )\n  },\n  {\n    id: 'header-left',\n    name: 'Заголовок слева',\n    description: 'Вертикальный заголовок слева, компактный макет',\n    icon: <ArrowLeft className=\"w-5 h-5\" />,\n    config: {\n      headerPosition: 'left',\n      sidebarPosition: 'right',\n      propertiesPosition: 'right',\n      headerSize: 200,\n      sidebarSize: 280,\n      propertiesSize: 320\n    },\n    preview: (\n      <div className=\"w-full h-20 border rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-800\">\n        <div className=\"flex h-full\">\n          <div className=\"w-1/5 bg-blue-200 dark:bg-blue-800\"></div>\n          <div className=\"flex-1 bg-gray-100 dark:bg-gray-700\"></div>\n          <div className=\"w-1/4 bg-green-200 dark:bg-green-800\"></div>\n          <div className=\"w-1/4 bg-orange-200 dark:bg-orange-800\"></div>\n        </div>\n      </div>\n    )\n  },\n  {\n    id: 'compact',\n    name: 'Компактный',\n    description: 'Минимальные размеры для больших экранов',\n    icon: <Tablet className=\"w-5 h-5\" />,\n    config: {\n      headerPosition: 'top',\n      sidebarPosition: 'left',\n      propertiesPosition: 'right',\n      headerSize: 48,\n      sidebarSize: 240,\n      propertiesSize: 260\n    },\n    preview: (\n      <div className=\"w-full h-20 border rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-800\">\n        <div className=\"h-2 bg-blue-200 dark:bg-blue-800\"></div>\n        <div className=\"flex h-18\">\n          <div className=\"w-1/5 bg-green-200 dark:bg-green-800\"></div>\n          <div className=\"flex-1 bg-gray-100 dark:bg-gray-700\"></div>\n          <div className=\"w-1/5 bg-orange-200 dark:bg-orange-800\"></div>\n        </div>\n      </div>\n    )\n  },\n  {\n    id: 'mobile',\n    name: 'Мобильный',\n    description: 'Оптимизированный для мобильных устройств',\n    icon: <Smartphone className=\"w-5 h-5\" />,\n    config: {\n      headerPosition: 'top',\n      sidebarPosition: 'left',\n      propertiesPosition: 'right',\n      headerSize: 56,\n      sidebarSize: 200,\n      propertiesSize: 200\n    },\n    preview: (\n      <div className=\"w-full h-20 border rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-800\">\n        <div className=\"h-3 bg-blue-200 dark:bg-blue-800\"></div>\n        <div className=\"flex h-17\">\n          <div className=\"w-1/6 bg-green-200 dark:bg-green-800\"></div>\n          <div className=\"flex-1 bg-gray-100 dark:bg-gray-700\"></div>\n          <div className=\"w-1/6 bg-orange-200 dark:bg-orange-800\"></div>\n        </div>\n      </div>\n    )\n  }\n];\n\ninterface QuickLayoutSwitcherProps {\n  currentConfig?: any;\n  onLayoutChange: (config: any) => void;\n}\n\nconst QuickLayoutSwitcher: React.FC<QuickLayoutSwitcherProps> = ({\n  currentConfig,\n  onLayoutChange\n}) => {\n  const [isOpen, setIsOpen] = useState(false);\n  const [selectedPreset, setSelectedPreset] = useState<string>('default');\n\n  const handlePresetSelect = (preset: QuickLayoutPreset) => {\n    setSelectedPreset(preset.id);\n    \n    // Преобразуем пресет в конфигурацию макета\n    const layoutConfig = {\n      headerPosition: preset.config.headerPosition,\n      sidebarPosition: preset.config.sidebarPosition,\n      propertiesPosition: preset.config.propertiesPosition,\n      canvasFullscreen: false,\n      compactMode: preset.id === 'compact' || preset.id === 'mobile',\n      showGrid: true,\n      panelSizes: {\n        sidebar: preset.config.sidebarSize / 15, // Конвертируем в проценты\n        properties: preset.config.propertiesSize / 15,\n        canvas: 100 - (preset.config.sidebarSize / 15) - (preset.config.propertiesSize / 15)\n      }\n    };\n\n    onLayoutChange(layoutConfig);\n    setIsOpen(false);\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\n          <Layout className=\"w-4 h-4\" />\n          Быстрая настройка\n        </Button>\n      </DialogTrigger>\n      <DialogContent className=\"max-w-4xl\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Grid className=\"w-5 h-5\" />\n            Быстрая настройка макета\n          </DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          <p className=\"text-sm text-muted-foreground\">\n            Выберите готовый макет для быстрой настройки интерфейса\n          </p>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {LAYOUT_PRESETS.map((preset) => (\n              <Card \n                key={preset.id}\n                className={`cursor-pointer transition-all duration-200 hover:shadow-md ${\n                  selectedPreset === preset.id \n                    ? 'ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20' \n                    : 'hover:bg-gray-50 dark:hover:bg-gray-800'\n                }`}\n                onClick={() => handlePresetSelect(preset)}\n              >\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      {preset.icon}\n                      {preset.name}\n                    </CardTitle>\n                    {selectedPreset === preset.id && (\n                      <Badge variant=\"default\" className=\"text-xs\">\n                        Выбран\n                      </Badge>\n                    )}\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      {preset.description}\n                    </p>\n                    \n                    <div className=\"space-y-2\">\n                      <div className=\"text-xs font-medium text-muted-foreground\">\n                        Предпросмотр:\n                      </div>\n                      {preset.preview}\n                    </div>\n                    \n                    <Separator />\n                    \n                    <div className=\"space-y-1 text-xs text-muted-foreground\">\n                      <div className=\"flex justify-between\">\n                        <span>Заголовок:</span>\n                        <span className=\"capitalize\">{preset.config.headerPosition}</span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span>Боковая панель:</span>\n                        <span className=\"capitalize\">{preset.config.sidebarPosition}</span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span>Свойства:</span>\n                        <span className=\"capitalize\">{preset.config.propertiesPosition}</span>\n                      </div>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n          \n          <div className=\"mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n            <div className=\"flex items-start gap-3\">\n              <Layout className=\"w-5 h-5 text-blue-600 mt-0.5\" />\n              <div>\n                <h4 className=\"font-medium text-blue-900 dark:text-blue-100\">\n                  Совет по использованию\n                </h4>\n                <p className=\"text-sm text-blue-700 dark:text-blue-300 mt-1\">\n                  Выберите макет и нажмите на него для применения. Вы можете в любое время вернуться к настройкам и выбрать другой вариант.\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default QuickLayoutSwitcher;","size_bytes":11671},"client/src/pages/home.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Link, useLocation } from 'wouter';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { Plus, Bot, Edit, Trash2, Calendar, User, Download } from 'lucide-react';\nimport { ThemeToggle } from '@/components/theme-toggle';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport type { BotProject } from '@shared/schema';\nimport { SheetsManager } from '@/utils/sheets-manager';\n\nconst createProjectSchema = z.object({\n  name: z.string().min(1, 'Название проекта обязательно'),\n  description: z.string().optional(),\n});\n\ntype CreateProjectForm = z.infer<typeof createProjectSchema>;\n\nexport default function Home() {\n  const [, setLocation] = useLocation();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n\n  const form = useForm<CreateProjectForm>({\n    resolver: zodResolver(createProjectSchema),\n    defaultValues: {\n      name: '',\n      description: '',\n    },\n  });\n\n  // Загрузка списка проектов\n  const { data: projects = [], isLoading } = useQuery({\n    queryKey: ['/api/projects'],\n  });\n\n  // Создание нового проекта\n  const createProjectMutation = useMutation({\n    mutationFn: (data: CreateProjectForm) => apiRequest('POST', '/api/projects', {\n      ...data,\n      data: {\n        nodes: [{\n          id: 'start',\n          type: 'start',\n          position: { x: 100, y: 100 },\n          data: {\n            messageText: 'Привет! Я ваш новый бот.',\n            keyboardType: 'none',\n            buttons: [],\n          }\n        }],\n        connections: []\n      }\n    }),\n    onSuccess: (newProject: BotProject) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      toast({\n        title: \"Проект создан\",\n        description: `Проект \"${newProject.name}\" успешно создан`,\n      });\n      setIsCreateDialogOpen(false);\n      form.reset();\n      // Переходим в редактор нового проекта\n      setLocation(`/editor/${newProject.id}`);\n    },\n    onError: () => {\n      toast({\n        title: \"Ошибка создания\",\n        description: \"Не удалось создать проект\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Удаление проекта\n  const deleteProjectMutation = useMutation({\n    mutationFn: (projectId: number) => apiRequest('DELETE', `/api/projects/${projectId}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      toast({\n        title: \"Проект удален\",\n        description: \"Проект успешно удален\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Ошибка удаления\",\n        description: \"Не удалось удалить проект\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleCreateProject = (data: CreateProjectForm) => {\n    createProjectMutation.mutate(data);\n  };\n\n  const handleDeleteProject = (project: BotProject) => {\n    if (confirm(`Вы уверены, что хотите удалить проект \"${project.name}\"? Это действие нельзя отменить.`)) {\n      deleteProjectMutation.mutate(project.id);\n    }\n  };\n\n  const formatDate = (dateString: string | Date | null) => {\n    if (!dateString) return 'Неизвестно';\n    const date = typeof dateString === 'string' ? new Date(dateString) : dateString;\n    return date.toLocaleDateString('ru-RU', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  const getNodeCount = (project: BotProject) => {\n    if (!project.data || typeof project.data !== 'object') return 0;\n    \n    // Проверяем, новый формат с листами или старый\n    if (SheetsManager.isNewFormat(project.data)) {\n      const sheets = (project.data as any).sheets || [];\n      return sheets.reduce((total: number, sheet: any) => total + (sheet.nodes?.length || 0), 0);\n    } else {\n      const data = project.data as { nodes?: any[] };\n      return data.nodes?.length || 0;\n    }\n  };\n\n  const getSheetsInfo = (project: BotProject) => {\n    if (!project.data || typeof project.data !== 'object') return { count: 0, names: [] };\n    \n    // Проверяем, новый формат с листами или старый\n    if (SheetsManager.isNewFormat(project.data)) {\n      const sheets = (project.data as any).sheets || [];\n      return {\n        count: sheets.length,\n        names: sheets.map((sheet: any) => sheet.name || 'Лист')\n      };\n    } else {\n      // Старый формат - один лист\n      return {\n        count: 1,\n        names: ['Главный лист']\n      };\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-4\">\n            <i className=\"fas fa-spinner fa-spin text-gray-400 text-xl\"></i>\n          </div>\n          <p className=\"text-gray-600\">Загрузка проектов...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Заголовок */}\n      <header className=\"border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container flex h-16 items-center justify-between\">\n          <div className=\"flex items-center space-x-3\">\n            <div className=\"w-8 h-8 bg-primary rounded-lg flex items-center justify-center\">\n              <i className=\"fab fa-telegram-plane text-primary-foreground text-lg\"></i>\n            </div>\n            <div>\n              <h1 className=\"text-lg font-semibold text-foreground\">BotCraft Studio</h1>\n              <p className=\"text-xs text-muted-foreground\">Конструктор Telegram ботов</p>\n            </div>\n          </div>\n          \n          <div className=\"flex items-center space-x-4\">\n            <Link href=\"/templates\">\n              <Button variant=\"outline\" size=\"sm\">\n                <Bot className=\"h-4 w-4 mr-2\" />\n                Шаблоны\n              </Button>\n            </Link>\n            <ThemeToggle />\n          </div>\n        </div>\n      </header>\n\n      {/* Основной контент */}\n      <main className=\"container py-8\">\n        <div className=\"flex items-center justify-between mb-8\">\n          <div>\n            <h2 className=\"text-3xl font-bold tracking-tight\">Мои проекты</h2>\n            <p className=\"text-muted-foreground\">\n              Управляйте своими Telegram ботами\n            </p>\n          </div>\n          \n          <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n            <DialogTrigger asChild>\n              <Button>\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Новый проект\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Создать новый проект</DialogTitle>\n              </DialogHeader>\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(handleCreateProject)} className=\"space-y-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"name\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Название проекта</FormLabel>\n                        <FormControl>\n                          <Input {...field} placeholder=\"Мой новый бот\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"description\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Описание (опционально)</FormLabel>\n                        <FormControl>\n                          <Textarea {...field} placeholder=\"Краткое описание бота\" rows={3} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)}>\n                      Отмена\n                    </Button>\n                    <Button type=\"submit\" disabled={createProjectMutation.isPending}>\n                      {createProjectMutation.isPending ? 'Создание...' : 'Создать'}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        {/* Список проектов */}\n        {projects.length === 0 ? (\n          <div className=\"text-center py-12\">\n            <Bot className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">Нет проектов</h3>\n            <p className=\"text-muted-foreground mb-4\">\n              Создайте свой первый проект для начала работы\n            </p>\n            <Button onClick={() => setIsCreateDialogOpen(true)}>\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Создать проект\n            </Button>\n          </div>\n        ) : (\n          <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n            {projects.map((project) => (\n              <Card key={project.id} className=\"group hover:shadow-lg transition-shadow\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <CardTitle className=\"text-lg\">{project.name}</CardTitle>\n                      <CardDescription className=\"mt-1\">\n                        {project.description || 'Без описания'}\n                      </CardDescription>\n                    </div>\n                    <div className=\"flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\"\n                        onClick={() => handleDeleteProject(project)}\n                        className=\"h-8 w-8 p-0 text-destructive hover:text-destructive\"\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"pt-0\">\n                  <div className=\"space-y-3\">\n                    {/* Статистика */}\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center space-x-4 text-sm text-muted-foreground\">\n                        <div className=\"flex items-center\">\n                          <User className=\"h-4 w-4 mr-1\" />\n                          {getNodeCount(project)} узлов\n                        </div>\n                        <div className=\"flex items-center\">\n                          <Calendar className=\"h-4 w-4 mr-1\" />\n                          {formatDate(project.updatedAt)}\n                        </div>\n                      </div>\n                      \n                      {/* Информация о листах */}\n                      {(() => {\n                        const sheetsInfo = getSheetsInfo(project);\n                        return (\n                          <div className=\"flex items-center space-x-2 text-sm text-muted-foreground\">\n                            <div className=\"flex items-center\">\n                              <Bot className=\"h-4 w-4 mr-1\" />\n                              {sheetsInfo.count} {sheetsInfo.count === 1 ? 'лист' : sheetsInfo.count < 5 ? 'листа' : 'листов'}:\n                            </div>\n                            <div className=\"flex flex-wrap gap-1\">\n                              {sheetsInfo.names.slice(0, 3).map((name, index) => (\n                                <Badge key={index} variant=\"secondary\" className=\"text-xs px-2 py-0.5\">\n                                  {name}\n                                </Badge>\n                              ))}\n                              {sheetsInfo.names.length > 3 && (\n                                <Badge variant=\"outline\" className=\"text-xs px-2 py-0.5\">\n                                  +{sheetsInfo.names.length - 3}\n                                </Badge>\n                              )}\n                            </div>\n                          </div>\n                        );\n                      })()}\n                    </div>\n\n\n\n                    {/* Действия */}\n                    <div className=\"flex space-x-2\">\n                      <Link href={`/editor/${project.id}`} className=\"flex-1\">\n                        <Button className=\"w-full\">\n                          <Edit className=\"h-4 w-4 mr-2\" />\n                          Редактировать\n                        </Button>\n                      </Link>\n                      <Link href={`/editor/${project.id}?tab=export`}>\n                        <Button variant=\"outline\" size=\"sm\">\n                          <Download className=\"h-4 w-4\" />\n                        </Button>\n                      </Link>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </main>\n    </div>\n  );\n}","size_bytes":14849},"client/src/components/media/enhanced-media-uploader.tsx":{"content":"import React, { useState, useCallback } from 'react';\nimport { useDropzone } from 'react-dropzone';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useUploadMedia, useUploadMultipleMedia } from \"@/hooks/use-media\";\nimport { FileOptimizer } from \"./file-optimizer\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { \n  Upload, \n  X, \n  FileImage, \n  FileVideo, \n  FileAudio, \n  FileText,\n  AlertTriangle,\n  CheckCircle2,\n  Loader2,\n  Eye,\n  Trash2,\n  Tag,\n  Settings,\n  Zap\n} from \"lucide-react\";\nimport type { MediaFile } from \"@shared/schema\";\n\ninterface FileWithPreview extends File {\n  preview?: string;\n  id: string;\n  uploadProgress?: number;\n  uploadStatus?: 'pending' | 'uploading' | 'success' | 'error';\n  uploadError?: string;\n}\n\ninterface EnhancedMediaUploaderProps {\n  projectId: number;\n  onUploadComplete?: (files: MediaFile[]) => void;\n  onClose?: () => void;\n  maxFiles?: number;\n  acceptedTypes?: string[];\n}\n\nexport function EnhancedMediaUploader({ \n  projectId, \n  onUploadComplete, \n  onClose,\n  maxFiles = 20,\n  acceptedTypes = [\n    'image/*', \n    'video/*', \n    'audio/*', \n    '.pdf', \n    '.doc', \n    '.docx',\n    '.txt',\n    '.xls',\n    '.xlsx',\n    '.zip',\n    '.rar',\n    'application/pdf',\n    'application/msword',\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n    'text/plain'\n  ]\n}: EnhancedMediaUploaderProps) {\n  const { toast } = useToast();\n  const [files, setFiles] = useState<FileWithPreview[]>([]);\n  const [isPublic, setIsPublic] = useState(false);\n  const [defaultDescription, setDefaultDescription] = useState('');\n  const [defaultTags, setDefaultTags] = useState('');\n  const [isUploading, setIsUploading] = useState(false);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [showAdvanced, setShowAdvanced] = useState(false);\n  const [showOptimizer, setShowOptimizer] = useState(false);\n  const [showPreview, setShowPreview] = useState(false);\n\n  const uploadSingleMutation = useUploadMedia(projectId);\n  const uploadMultipleMutation = useUploadMultipleMedia(projectId);\n\n  // Расширенная валидация файла\n  const validateFile = useCallback((file: File): string | null => {\n    // Определяем максимальные размеры по типу файла\n    const maxSizes = {\n      'image': 25 * 1024 * 1024, // 25MB\n      'video': 200 * 1024 * 1024, // 200MB\n      'audio': 100 * 1024 * 1024, // 100MB\n      'application': 50 * 1024 * 1024, // 50MB\n      'text': 10 * 1024 * 1024 // 10MB\n    };\n\n    // Определяем поддерживаемые расширения\n    const supportedExtensions = [\n      '.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg', '.bmp', // Изображения\n      '.mp4', '.webm', '.avi', '.mov', '.mkv', // Видео\n      '.mp3', '.wav', '.ogg', '.aac', '.flac', '.m4a', // Аудио\n      '.pdf', '.doc', '.docx', '.txt', '.xls', '.xlsx', '.zip', '.rar' // Документы\n    ];\n\n    // Проверяем расширение файла\n    const extension = '.' + file.name.split('.').pop()?.toLowerCase();\n    if (!supportedExtensions.includes(extension)) {\n      return `Неподдерживаемое расширение файла: ${extension}. Поддерживаются: изображения, видео, аудио, документы`;\n    }\n\n    const fileType = file.type.split('/')[0];\n    const maxSize = maxSizes[fileType as keyof typeof maxSizes] || maxSizes.application;\n\n    if (file.size > maxSize) {\n      const maxSizeMB = Math.round(maxSize / (1024 * 1024));\n      return `Файл \"${file.name}\" слишком большой. Максимальный размер для ${fileType}: ${maxSizeMB}МБ`;\n    }\n\n    if (file.name.length > 255) {\n      return 'Имя файла слишком длинное (максимум 255 символов)';\n    }\n\n    // Проверяем на подозрительные символы в имени файла\n    const dangerousChars = /[<>:\"|?*]/;\n    if (dangerousChars.test(file.name)) {\n      return 'Имя файла содержит недопустимые символы: < > : \" | ? *';\n    }\n\n    return null;\n  }, []);\n\n  // Обработка добавления файлов\n  const onDrop = useCallback((acceptedFiles: File[], rejectedFiles: any[]) => {\n    // Обрабатываем отклоненные файлы\n    rejectedFiles.forEach(({ file, errors }) => {\n      errors.forEach((error: any) => {\n        toast({\n          title: \"Файл отклонен\",\n          description: `${file.name}: ${error.message}`,\n          variant: \"destructive\",\n        });\n      });\n    });\n\n    // Обрабатываем принятые файлы\n    const newFiles: FileWithPreview[] = acceptedFiles.map(file => {\n      const validationError = validateFile(file);\n      if (validationError) {\n        toast({\n          title: \"Ошибка валидации\",\n          description: `${file.name}: ${validationError}`,\n          variant: \"destructive\",\n        });\n        return null;\n      }\n\n      // Создаем превью для изображений и некоторых других типов файлов\n      let preview = undefined;\n      if (file.type.startsWith('image/')) {\n        preview = URL.createObjectURL(file);\n      } else if (file.type.startsWith('video/')) {\n        // Для видео создаем thumbnail через canvas (будет реализовано позже)\n        preview = undefined; // TODO: Генерация thumbnail для видео\n      }\n\n      return {\n        ...file,\n        preview,\n        id: Math.random().toString(36).substr(2, 9),\n        uploadStatus: 'pending' as const,\n        uploadProgress: 0\n      };\n    }).filter(Boolean) as FileWithPreview[];\n\n    if (files.length + newFiles.length > maxFiles) {\n      toast({\n        title: \"Слишком много файлов\",\n        description: `Максимум ${maxFiles} файлов за раз`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setFiles(prev => [...prev, ...newFiles]);\n  }, [files.length, maxFiles, validateFile, toast]);\n\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({\n    onDrop,\n    accept: acceptedTypes.reduce((acc, type) => {\n      acc[type] = [];\n      return acc;\n    }, {} as Record<string, string[]>),\n    maxFiles: maxFiles - files.length,\n    multiple: true\n  });\n\n  // Удаление файла из списка\n  const removeFile = useCallback((fileId: string) => {\n    setFiles(prev => {\n      const updated = prev.filter(f => f.id !== fileId);\n      // Освобождаем memory для превью\n      const removedFile = prev.find(f => f.id === fileId);\n      if (removedFile?.preview) {\n        URL.revokeObjectURL(removedFile.preview);\n      }\n      return updated;\n    });\n  }, []);\n\n  // Получение иконки файла\n  const getFileIcon = (file: File) => {\n    const type = file.type.split('/')[0];\n    switch (type) {\n      case 'image': return <FileImage className=\"w-5 h-5\" />;\n      case 'video': return <FileVideo className=\"w-5 h-5\" />;\n      case 'audio': return <FileAudio className=\"w-5 h-5\" />;\n      default: return <FileText className=\"w-5 h-5\" />;\n    }\n  };\n\n  // Форматирование размера файла\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  // Загрузка файлов\n  const handleUpload = async () => {\n    if (files.length === 0) return;\n\n    setIsUploading(true);\n    setUploadProgress(0);\n\n    try {\n      const tags = defaultTags.split(',').map(tag => tag.trim()).filter(Boolean);\n\n      if (files.length === 1) {\n        // Одиночная загрузка\n        const file = files[0];\n        setFiles(prev => prev.map(f => \n          f.id === file.id \n            ? { ...f, uploadStatus: 'uploading', uploadProgress: 0 }\n            : f\n        ));\n\n        const result = await uploadSingleMutation.mutateAsync({\n          file,\n          description: defaultDescription,\n          tags,\n          isPublic,\n          onProgress: (progress) => {\n            setUploadProgress(progress);\n            setFiles(prev => prev.map(f => \n              f.id === file.id \n                ? { ...f, uploadProgress: progress }\n                : f\n            ));\n          }\n        });\n\n        setFiles(prev => prev.map(f => \n          f.id === file.id \n            ? { ...f, uploadStatus: 'success', uploadProgress: 100 }\n            : f\n        ));\n\n        toast({\n          title: \"Файл загружен\",\n          description: `${file.name} успешно загружен`,\n        });\n\n        onUploadComplete?.([result]);\n      } else {\n        // Множественная загрузка\n        setFiles(prev => prev.map(f => ({ ...f, uploadStatus: 'uploading', uploadProgress: 0 })));\n\n        const result = await uploadMultipleMutation.mutateAsync({\n          files,\n          defaultDescription,\n          isPublic,\n          onProgress: (progress) => {\n            setUploadProgress(progress);\n            setFiles(prev => prev.map(f => ({ ...f, uploadProgress: progress })));\n          }\n        });\n\n        setFiles(prev => prev.map(f => ({ ...f, uploadStatus: 'success', uploadProgress: 100 })));\n\n        toast({\n          title: \"Файлы загружены\",\n          description: `Успешно загружено ${result.success} из ${files.length} файлов`,\n        });\n\n        if (result.errors > 0) {\n          result.errorDetails.forEach((error: any) => {\n            toast({\n              title: \"Ошибка загрузки\",\n              description: `${error.fileName}: ${error.error}`,\n              variant: \"destructive\",\n            });\n          });\n        }\n\n        onUploadComplete?.(result.uploadedFiles);\n      }\n\n      // Очищаем файлы после успешной загрузки\n      setTimeout(() => {\n        setFiles([]);\n        onClose?.();\n      }, 2000);\n\n    } catch (error) {\n      console.error('Upload error:', error);\n      setFiles(prev => prev.map(f => ({ \n        ...f, \n        uploadStatus: 'error', \n        uploadError: error instanceof Error ? error.message : 'Неизвестная ошибка'\n      })));\n      \n      toast({\n        title: \"Ошибка загрузки\",\n        description: error instanceof Error ? error.message : 'Неизвестная ошибка',\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsUploading(false);\n      setUploadProgress(0);\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Заголовок */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-xl font-semibold\">Загрузка медиа файлов</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\">\n            Поддерживаются изображения, видео, аудио и документы\n          </p>\n        </div>\n        {onClose && (\n          <Button variant=\"ghost\" size=\"icon\" onClick={onClose}>\n            <X className=\"w-4 h-4\" />\n          </Button>\n        )}\n      </div>\n\n      {/* Зона загрузки */}\n      <div\n        {...getRootProps()}\n        className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ${\n          isDragActive \n            ? 'border-blue-500 bg-blue-50 dark:bg-blue-950/20' \n            : 'border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500'\n        }`}\n      >\n        <input {...getInputProps()} />\n        <Upload className=\"w-12 h-12 mx-auto mb-4 text-gray-400\" />\n        {isDragActive ? (\n          <div>\n            <p className=\"text-lg font-medium text-blue-600 dark:text-blue-400\">\n              Отпустите файлы здесь\n            </p>\n            <p className=\"text-sm text-blue-500\">\n              Файлы будут добавлены в список загрузки\n            </p>\n          </div>\n        ) : (\n          <div>\n            <p className=\"text-lg font-medium text-gray-600 dark:text-gray-400 mb-2\">\n              Перетащите файлы сюда или нажмите для выбора\n            </p>\n            <p className=\"text-sm text-gray-500\">\n              Максимум {maxFiles} файлов, до 200МБ для видео, 25МБ для изображений\n            </p>\n            <div className=\"flex flex-wrap gap-2 mt-2 text-xs text-muted-foreground\">\n              <span className=\"bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded\">📷 JPG, PNG, GIF</span>\n              <span className=\"bg-green-100 dark:bg-green-900 px-2 py-1 rounded\">🎬 MP4, WebM</span>\n              <span className=\"bg-orange-100 dark:bg-orange-900 px-2 py-1 rounded\">🎵 MP3, WAV</span>\n              <span className=\"bg-purple-100 dark:bg-purple-900 px-2 py-1 rounded\">📄 PDF, DOC, TXT</span>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Настройки загрузки */}\n      {files.length > 0 && (\n        <div className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <Label className=\"text-base font-medium\">Настройки загрузки</Label>\n            <div className=\"flex gap-2\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setShowPreview(true)}\n                className=\"flex items-center\"\n              >\n                <Eye className=\"w-4 h-4 mr-2\" />\n                Предпросмотр\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setShowOptimizer(true)}\n                className=\"flex items-center\"\n              >\n                <Zap className=\"w-4 h-4 mr-2\" />\n                Оптимизировать\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setShowAdvanced(!showAdvanced)}\n              >\n                <Settings className=\"w-4 h-4 mr-2\" />\n                {showAdvanced ? 'Скрыть' : 'Показать'} дополнительные\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Описание по умолчанию</Label>\n              <Textarea\n                id=\"description\"\n                placeholder=\"Описание для всех файлов...\"\n                value={defaultDescription}\n                onChange={(e) => setDefaultDescription(e.target.value)}\n                rows={3}\n              />\n            </div>\n\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"tags\">Теги (через запятую)</Label>\n                <Input\n                  id=\"tags\"\n                  placeholder=\"тег1, тег2, тег3...\"\n                  value={defaultTags}\n                  onChange={(e) => setDefaultTags(e.target.value)}\n                />\n              </div>\n\n              <div className=\"flex items-center space-x-2\">\n                <Switch\n                  id=\"public\"\n                  checked={isPublic}\n                  onCheckedChange={setIsPublic}\n                />\n                <Label htmlFor=\"public\">Сделать файлы публичными</Label>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Сводка по файлам */}\n      {files.length > 0 && (\n        <div className=\"bg-gray-50 dark:bg-gray-800 rounded-lg p-4 space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <Label className=\"text-base font-medium\">\n              Файлы для загрузки ({files.length})\n            </Label>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setFiles([])}\n              disabled={isUploading}\n            >\n              <Trash2 className=\"w-4 h-4 mr-2\" />\n              Очистить все\n            </Button>\n          </div>\n          \n          {/* Статистика по типам файлов */}\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2 text-xs\">\n            {(() => {\n              const stats = files.reduce((acc, file) => {\n                const type = file.type.split('/')[0];\n                acc[type] = (acc[type] || 0) + 1;\n                return acc;\n              }, {} as Record<string, number>);\n              \n              return Object.entries(stats).map(([type, count]) => {\n                const icons = { image: '📷', video: '🎬', audio: '🎵', application: '📄', text: '📄' };\n                return (\n                  <div key={type} className=\"bg-white dark:bg-gray-700 rounded px-2 py-1 text-center\">\n                    <span className=\"mr-1\">{icons[type as keyof typeof icons] || '📄'}</span>\n                    {count} {type === 'image' ? 'изобр.' : type === 'video' ? 'видео' : type === 'audio' ? 'аудио' : 'док.'}\n                  </div>\n                );\n              });\n            })()}\n          </div>\n          \n          {/* Общий размер */}\n          <div className=\"text-sm text-muted-foreground\">\n            Общий размер: {formatFileSize(files.reduce((sum, file) => sum + file.size, 0))}\n          </div>\n        </div>\n      )}\n\n      {/* Список файлов */}\n      {files.length > 0 && (\n        <div className=\"space-y-3\">\n\n          <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n            {files.map((file) => (\n              <div\n                key={file.id}\n                className=\"flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg\"\n              >\n                {/* Расширенное превью или иконка */}\n                <div className=\"flex-shrink-0 relative\">\n                  {file.preview ? (\n                    <div className=\"relative\">\n                      <img\n                        src={file.preview}\n                        alt={file.name}\n                        className=\"w-12 h-12 object-cover rounded\"\n                      />\n                      {/* Индикатор типа файла */}\n                      <div className=\"absolute -top-1 -right-1 bg-blue-500 text-white text-xs px-1 rounded\">\n                        {file.type.split('/')[1]?.toUpperCase().substring(0, 3) || 'IMG'}\n                      </div>\n                    </div>\n                  ) : (\n                    <div className=\"w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded flex items-center justify-center relative\">\n                      {getFileIcon(file)}\n                      {/* Индикатор размера файла */}\n                      <div className=\"absolute -bottom-1 -right-1 bg-gray-600 text-white text-xs px-1 rounded\">\n                        {file.size > 1024 * 1024 ? `${Math.round(file.size / (1024 * 1024))}M` : `${Math.round(file.size / 1024)}K`}\n                      </div>\n                    </div>\n                  )}\n                </div>\n\n                {/* Информация о файле */}\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium text-gray-900 dark:text-gray-100 truncate\">\n                    {file.name}\n                  </p>\n                  <p className=\"text-xs text-gray-500\">\n                    {formatFileSize(file.size)}\n                  </p>\n                  \n                  {/* Прогресс загрузки */}\n                  {file.uploadStatus === 'uploading' && (\n                    <Progress value={file.uploadProgress || 0} className=\"mt-1\" />\n                  )}\n                  \n                  {/* Статус */}\n                  {file.uploadStatus === 'success' && (\n                    <div className=\"flex items-center mt-1 text-green-600 text-xs\">\n                      <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n                      Загружено\n                    </div>\n                  )}\n                  \n                  {file.uploadStatus === 'error' && (\n                    <div className=\"flex items-center mt-1 text-red-600 text-xs\">\n                      <AlertTriangle className=\"w-3 h-3 mr-1\" />\n                      {file.uploadError || 'Ошибка'}\n                    </div>\n                  )}\n                </div>\n\n                {/* Действия */}\n                <div className=\"flex items-center space-x-2\">\n                  {file.uploadStatus === 'uploading' && (\n                    <Loader2 className=\"w-4 h-4 animate-spin\" />\n                  )}\n                  \n                  {file.uploadStatus !== 'uploading' && (\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => removeFile(file.id)}\n                      disabled={isUploading}\n                    >\n                      <X className=\"w-4 h-4\" />\n                    </Button>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Общий прогресс загрузки */}\n      {isUploading && (\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <Label>Прогресс загрузки</Label>\n            <span className=\"text-sm text-muted-foreground\">{uploadProgress}%</span>\n          </div>\n          <Progress value={uploadProgress} />\n        </div>\n      )}\n\n      {/* Кнопки действий */}\n      {files.length > 0 && (\n        <div className=\"flex justify-end space-x-3 pt-4 border-t\">\n          {onClose && (\n            <Button variant=\"outline\" onClick={onClose} disabled={isUploading}>\n              Отмена\n            </Button>\n          )}\n          <Button \n            onClick={handleUpload} \n            disabled={isUploading || files.length === 0}\n            className=\"min-w-[120px]\"\n          >\n            {isUploading ? (\n              <>\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                Загрузка...\n              </>\n            ) : (\n              <>\n                <Upload className=\"w-4 h-4 mr-2\" />\n                Загрузить ({files.length})\n              </>\n            )}\n          </Button>\n        </div>\n      )}\n\n      {/* Диалог оптимизации файлов */}\n      <Dialog open={showOptimizer} onOpenChange={setShowOptimizer}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" aria-describedby=\"optimizer-description\">\n          <DialogHeader>\n            <DialogTitle>Оптимизация файлов</DialogTitle>\n            <div id=\"optimizer-description\" className=\"text-sm text-muted-foreground\">\n              Сжатие и оптимизация файлов для ускорения загрузки и экономии места\n            </div>\n          </DialogHeader>\n          <FileOptimizer\n            files={files}\n            onOptimizedFiles={(optimizedFiles) => {\n              setFiles(optimizedFiles.map((file, index) => ({\n                ...file,\n                preview: file.type.startsWith('image/') ? URL.createObjectURL(file) : undefined,\n                id: Math.random().toString(36).substr(2, 9),\n                uploadStatus: 'pending' as const,\n                uploadProgress: 0\n              })));\n              setShowOptimizer(false);\n              toast({\n                title: \"Файлы оптимизированы\",\n                description: `${optimizedFiles.length} файлов готовы к загрузке`,\n              });\n            }}\n            onClose={() => setShowOptimizer(false)}\n          />\n        </DialogContent>\n      </Dialog>\n\n      {/* Диалог предпросмотра файлов */}\n      <Dialog open={showPreview} onOpenChange={setShowPreview}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" aria-describedby=\"preview-description\">\n          <DialogHeader>\n            <DialogTitle>Предпросмотр файлов</DialogTitle>\n            <div id=\"preview-description\" className=\"text-sm text-muted-foreground\">\n              Просмотр всех выбранных файлов перед загрузкой\n            </div>\n          </DialogHeader>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto\">\n            {files.map((file) => (\n              <div key={file.id} className=\"border rounded-lg p-4 space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm font-medium truncate\">{file.name}</span>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleRemoveFile(file.id)}\n                    className=\"text-red-500 hover:text-red-700\"\n                  >\n                    <X className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n                \n                {file.preview && (\n                  <div className=\"relative\">\n                    <img\n                      src={file.preview}\n                      alt={file.name}\n                      className=\"w-full h-32 object-cover rounded\"\n                    />\n                  </div>\n                )}\n                \n                {!file.preview && (\n                  <div className=\"flex items-center justify-center h-32 bg-muted rounded\">\n                    {getFileIcon(file)}\n                  </div>\n                )}\n                \n                <div className=\"text-xs text-muted-foreground\">\n                  {formatFileSize(file.size)} • {file.type}\n                </div>\n              </div>\n            ))}\n          </div>\n          \n          <div className=\"flex justify-end gap-2 pt-4 border-t\">\n            <Button variant=\"outline\" onClick={() => setShowPreview(false)}>\n              Закрыть\n            </Button>\n            <Button onClick={() => setShowPreview(false)}>\n              Продолжить загрузку\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","size_bytes":27388},"SETUP.md":{"content":"# 🛠 Установка и настройка\n\nПодробное руководство по установке Telegram Bot Builder на различных платформах.\n\n## 📋 Системные требования\n\n- **Node.js** 18.0.0+ (LTS рекомендуется)\n- **PostgreSQL** 13+ \n- **Python** 3.11+ (для генерируемых ботов)\n- **Git** (для клонирования репозитория)\n\n---\n\n## 🖥 Установка на Windows\n\n### 1️⃣ Установка зависимостей\n\n**Node.js:**\n1. Перейдите на https://nodejs.org/\n2. Скачайте **LTS версию** (рекомендуется)\n3. Установите с настройками по умолчанию\n4. **Важно:** Перезапустите командную строку после установки\n\n**PostgreSQL:**\n1. Перейдите на https://www.postgresql.org/download/windows/\n2. Скачайте PostgreSQL installer\n3. При установке:\n   - **Запомните пароль** для пользователя `postgres`\n   - Оставьте порт **5432**\n   - Установите pgAdmin 4 (рекомендуется)\n\n**Python (опционально):**\n1. Перейдите на https://python.org/downloads/\n2. Скачайте Python 3.11+\n3. При установке отметьте \"Add Python to PATH\"\n\n### 2️⃣ Настройка базы данных\n\n**Через pgAdmin 4:**\n1. Откройте **pgAdmin 4**\n2. Подключитесь к серверу (введите пароль postgres)\n3. Создайте базу данных:\n   - Правый клик на \"Databases\" → Create → Database\n   - Имя: `telegram_bot_builder`\n4. Создайте пользователя (опционально):\n   - Правый клик на \"Login/Group Roles\" → Create → Login/Group Role\n   - General: Имя `bot_user`\n   - Definition: Пароль `your_secure_password`\n   - Privileges: ✅ Can login?, ✅ Superuser?\n\n**Через командную строку:**\n```powershell\n# В PowerShell (замените \"ваш_пароль\"):\n$env:PGPASSWORD=\"ваш_пароль\"\n& \"C:\\Program Files\\PostgreSQL\\17\\bin\\psql.exe\" -U postgres -c \"CREATE DATABASE telegram_bot_builder;\"\n```\n\n### 3️⃣ Настройка проекта\n\n```cmd\n# 1. Клонируйте репозиторий\ngit clone https://github.com/yourusername/telegram-bot-builder.git\ncd telegram-bot-builder\n\n# 2. Скопируйте файл конфигурации\ncopy .env.example .env\n\n# 3. Отредактируйте настройки\nnotepad .env\n```\n\n**Настройки в .env файле:**\n```env\n# Основные настройки\nNODE_ENV=development\nPORT=5000\n\n# База данных (замените на свои данные)\nDATABASE_URL=postgresql://postgres:ваш_пароль@localhost:5432/telegram_bot_builder\n\n# Опционально\nPGHOST=localhost\nPGPORT=5432\nPGUSER=postgres\nPGPASSWORD=ваш_пароль\nPGDATABASE=telegram_bot_builder\n```\n\n```cmd\n# 4. Установите зависимости\nnpm install\n\n# 5. Создайте таблицы в базе данных\nnpm run db:push\n```\n\n### 4️⃣ Запуск проекта\n\n**Способ 1 - PowerShell (РЕКОМЕНДУЕТСЯ):**\n```powershell\n$env:NODE_ENV=\"development\"; tsx server/index.ts\n```\n\n**Способ 2 - CMD:**\n```cmd\nnpm run dev\n```\n\n**Способ 3 - Создайте bat файл:**\nСоздайте файл `start.bat`:\n```batch\n@echo off\nset NODE_ENV=development\nnpx tsx server/index.ts\npause\n```\n\n### 5️⃣ Откройте браузер\n\nПерейдите по адресу: **http://localhost:5000**\n\n---\n\n## 🐧 Установка на Linux/macOS\n\n### Ubuntu/Debian\n\n```bash\n# Обновите систему\nsudo apt update && sudo apt upgrade -y\n\n# Установите Node.js\ncurl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -\nsudo apt-get install -y nodejs\n\n# Установите PostgreSQL\nsudo apt install postgresql postgresql-contrib\n\n# Настройте PostgreSQL\nsudo -u postgres createdb telegram_bot_builder\nsudo -u postgres psql -c \"ALTER USER postgres PASSWORD 'your_password';\"\n\n# Клонируйте и настройте проект\ngit clone https://github.com/yourusername/telegram-bot-builder.git\ncd telegram-bot-builder\ncp .env.example .env\n# Отредактируйте .env файл\nnano .env\n\n# Установите зависимости и запустите\nnpm install\nnpm run db:push\nnpm run dev\n```\n\n### macOS\n\n```bash\n# Установите Homebrew (если еще не установлен)\n/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"\n\n# Установите зависимости\nbrew install node postgresql\n\n# Запустите PostgreSQL\nbrew services start postgresql\n\n# Создайте базу данных\ncreatedb telegram_bot_builder\n\n# Клонируйте и настройте проект\ngit clone https://github.com/yourusername/telegram-bot-builder.git\ncd telegram-bot-builder\ncp .env.example .env\n# Отредактируйте .env файл\n\n# Установите зависимости и запустите\nnpm install\nnpm run db:push\nnpm run dev\n```\n\n---\n\n## 🐳 Docker установка\n\n```bash\n# Клонируйте репозиторий\ngit clone https://github.com/yourusername/telegram-bot-builder.git\ncd telegram-bot-builder\n\n# Запустите с Docker Compose\ndocker-compose up -d\n\n# Примените миграции\ndocker-compose exec app npm run db:push\n```\n\n**docker-compose.yml:**\n```yaml\nversion: '3.8'\nservices:\n  app:\n    build: .\n    ports:\n      - \"5000:5000\"\n    depends_on:\n      - postgres\n    environment:\n      - NODE_ENV=development\n      - DATABASE_URL=postgresql://postgres:password@postgres:5432/telegram_bot_builder\n\n  postgres:\n    image: postgres:15\n    environment:\n      - POSTGRES_DB=telegram_bot_builder\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASSWORD=password\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n    ports:\n      - \"5432:5432\"\n\nvolumes:\n  postgres_data:\n```\n\n---\n\n## 🔧 Команды разработчика\n\n```bash\n# Разработка\nnpm run dev              # Запуск в режиме разработки\nnpm run build            # Сборка для продакшна\nnpm run start            # Запуск продакшн версии\nnpm run check            # Проверка TypeScript\n\n# База данных\nnpm run db:push          # Применить изменения схемы\nnpm run db:pull          # Получить схему из БД\nnpm run db:generate      # Генерация миграций\nnpm run db:migrate       # Применить миграции\n\n# Утилиты\nnpm run lint             # Проверка кода\nnpm run format           # Форматирование кода\nnpm test                 # Запуск тестов\n```\n\n---\n\n## 🐛 Решение проблем\n\n### Windows специфичные проблемы\n\n**\"node не является внутренней командой\"**\n```cmd\n# Перезапустите командную строку\n# Проверьте установку\nnode --version\nnpm --version\n```\n\n**\"npm run db:push\" не работает**\n1. Убедитесь что PostgreSQL запущен (services.msc → postgresql)\n2. Проверьте настройки в `.env`\n3. Проверьте подключение: `psql -U postgres -d telegram_bot_builder`\n\n**Порт 5000 уже занят**\n```cmd\n# Найдите процесс\nnetstat -ano | findstr 5000\n# Завершите его (замените 1234 на реальный PID)\ntaskkill /PID 1234 /F\n```\n\n**Ошибки прав доступа**\n- Запустите командную строку от имени администратора\n- Или используйте PowerShell\n\n### Общие проблемы\n\n**Ошибка подключения к базе данных**\n```bash\n# Проверьте статус PostgreSQL\n# Linux/macOS:\nsudo systemctl status postgresql\n# или\nbrew services list | grep postgres\n\n# Windows:\nservices.msc → найдите postgresql\n\n# Проверьте подключение\npsql -U postgres -d telegram_bot_builder -h localhost\n```\n\n**Ошибки установки пакетов**\n```bash\n# Очистите кеш npm\nnpm cache clean --force\n\n# Удалите node_modules и переустановите\nrm -rf node_modules package-lock.json\nnpm install\n\n# Если проблемы с правами (Linux/macOS)\nsudo chown -R $(whoami) ~/.npm\n```\n\n**Ошибки TypeScript**\n```bash\n# Проверьте версию Node.js\nnode --version  # должно быть 18+\n\n# Переустановите TypeScript\nnpm install -g typescript\nnpm run check\n```\n\n### Производительность\n\n**Медленная работа**\n- Добавьте больше RAM PostgreSQL в `postgresql.conf`\n- Используйте SSD для базы данных\n- Настройте индексы для больших данных\n\n**Большие медиафайлы**\n- Настройте внешнее хранилище (AWS S3, Cloudinary)\n- Измените лимиты в `server/routes.ts`\n\n---\n\n## 🔒 Настройка безопасности\n\n### Продакшн среда\n\n```bash\n# Создайте .env.production\nNODE_ENV=production\nDATABASE_URL=postgresql://secure_user:secure_pass@localhost:5432/bot_builder_prod\nSESSION_SECRET=your_very_long_random_string\n```\n\n### PostgreSQL безопасность\n\n```sql\n-- Создайте специального пользователя\nCREATE USER bot_builder_user WITH PASSWORD 'secure_password';\nGRANT CONNECT ON DATABASE telegram_bot_builder TO bot_builder_user;\nGRANT USAGE ON SCHEMA public TO bot_builder_user;\nGRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO bot_builder_user;\n```\n\n### Файрвол\n\n```bash\n# Ограничьте доступ к PostgreSQL\nsudo ufw allow from your_app_server_ip to any port 5432\n\n# Или полностью закройте внешний доступ\nsudo ufw deny 5432\n```\n\n---\n\n## 📊 Мониторинг\n\n### Логи приложения\n\n```bash\n# Просмотр логов в реальном времени\ntail -f logs/app.log\n\n# Логи PostgreSQL\n# Linux: /var/log/postgresql/\n# macOS: /usr/local/var/log/\n# Windows: C:\\Program Files\\PostgreSQL\\xx\\data\\log\\\n```\n\n### Метрики базы данных\n\n```sql\n-- Размер базы данных\nSELECT pg_size_pretty(pg_database_size('telegram_bot_builder'));\n\n-- Активные подключения\nSELECT count(*) FROM pg_stat_activity;\n\n-- Самые медленные запросы\nSELECT query, mean_time, calls FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;\n```\n\n---\n\n💡 **Нужна помощь?** Опишите вашу проблему подробно в [GitHub Issues](https://github.com/yourusername/telegram-bot-builder/issues) - мы поможем решить любые сложности!","size_bytes":11208},"client/src/pages/templates.tsx":{"content":"import { useState, useMemo } from 'react';\nimport { Link, useLocation } from 'wouter';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Badge } from '@/components/ui/badge';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Loader2, Search, Download, Eye, Calendar, User, Filter, Star, TrendingUp, Crown, Sparkles, Trash2, Heart, Bookmark, Clock, Globe, Shield, ArrowLeft, Layout } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { format } from 'date-fns';\nimport { ru } from 'date-fns/locale';\nimport type { BotTemplate } from '@shared/schema';\nimport type { BotData } from '@/types/bot';\nimport { AdaptiveHeader } from '@/components/layout/adaptive-header';\nimport { SimpleLayoutCustomizer, SimpleLayoutConfig } from '@/components/layout/simple-layout-customizer';\nimport { FlexibleLayout } from '@/components/layout/flexible-layout';\n\ninterface TemplatesPageProps {\n  onSelectTemplate?: (template: BotTemplate) => void;\n}\n\nexport function TemplatesPage({ onSelectTemplate }: TemplatesPageProps) {\n  const [, setLocation] = useLocation();\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedCategory, setSelectedCategory] = useState<string>('all');\n  const [selectedTemplate, setSelectedTemplate] = useState<BotTemplate | null>(null);\n  const [showPreview, setShowPreview] = useState(false);\n  const [currentTab, setCurrentTab] = useState('all');\n  const [sortBy, setSortBy] = useState<'popular' | 'rating' | 'recent' | 'name'>('popular');\n  \n  const [flexibleLayoutConfig, setFlexibleLayoutConfig] = useState<SimpleLayoutConfig>({\n    elements: [\n      {\n        id: 'header',\n        type: 'header',\n        name: 'Шапка',\n        position: 'top',\n        size: 64,\n        visible: true\n      },\n      {\n        id: 'sidebar',\n        type: 'sidebar',\n        name: 'Боковая панель',\n        position: 'left',\n        size: 20,\n        visible: true\n      },\n      {\n        id: 'canvas',\n        type: 'canvas',\n        name: 'Содержимое',\n        position: 'center',\n        size: 60,\n        visible: true\n      },\n      {\n        id: 'properties',\n        type: 'properties',\n        name: 'Фильтры',\n        position: 'right',\n        size: 20,\n        visible: true\n      }\n    ],\n    compactMode: false,\n    showGrid: false\n  });\n\n  const { toast } = useToast();\n\n  const { data: templates = [], isLoading } = useQuery<BotTemplate[]>({\n    queryKey: ['/api/templates'],\n  });\n\n  const { data: featuredTemplates = [], isLoading: isLoadingFeatured } = useQuery<BotTemplate[]>({\n    queryKey: ['/api/templates/featured'],\n    enabled: currentTab === 'featured',\n  });\n\n  const { data: myTemplates = [], isLoading: isLoadingMy } = useQuery<BotTemplate[]>({\n    queryKey: ['/api/templates/category/custom'],\n    staleTime: 0, // Always refetch when needed\n  });\n\n  // Мутация для увеличения счетчика использования\n  const useTemplateMutation = useMutation({\n    mutationFn: async (templateId: number) => {\n      const response = await fetch(`/api/templates/${templateId}/use`, {\n        method: 'POST',\n      });\n      if (!response.ok) throw new Error('Failed to increment use count');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n    },\n  });\n\n  // Мутация для оценки шаблона\n  const rateTemplateMutation = useMutation({\n    mutationFn: async ({ templateId, rating }: { templateId: number; rating: number }) => {\n      const response = await fetch(`/api/templates/${templateId}/rate`, {\n        method: 'POST',\n        body: JSON.stringify({ rating }),\n        headers: { 'Content-Type': 'application/json' },\n      });\n      if (!response.ok) throw new Error('Failed to rate template');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n      toast({\n        title: 'Спасибо за оценку!',\n        description: 'Ваша оценка поможет другим пользователям',\n      });\n    },\n  });\n\n  // Мутация для удаления шаблона\n  const deleteTemplateMutation = useMutation({\n    mutationFn: async (templateId: number) => {\n      const response = await fetch(`/api/templates/${templateId}`, {\n        method: 'DELETE',\n      });\n      if (!response.ok) throw new Error('Failed to delete template');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/templates/category/custom'] });\n      toast({\n        title: 'Шаблон удален',\n        description: 'Шаблон успешно удален из вашей библиотеки',\n      });\n    },\n  });\n\n  // Мутация для лайка шаблона\n  const likeTemplateMutation = useMutation({\n    mutationFn: async ({ templateId, liked }: { templateId: number; liked: boolean }) => {\n      const response = await fetch(`/api/templates/${templateId}/like`, {\n        method: 'POST',\n        body: JSON.stringify({ liked }),\n        headers: { 'Content-Type': 'application/json' },\n      });\n      if (!response.ok) throw new Error('Failed to like template');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n      toast({\n        title: 'Отлично!',\n        description: 'Ваш голос учтен',\n      });\n    },\n  });\n\n  // Мутация для добавления в закладки\n  const bookmarkTemplateMutation = useMutation({\n    mutationFn: async ({ templateId, bookmarked }: { templateId: number; bookmarked: boolean }) => {\n      const response = await fetch(`/api/templates/${templateId}/bookmark`, {\n        method: 'POST',\n        body: JSON.stringify({ bookmarked }),\n        headers: { 'Content-Type': 'application/json' },\n      });\n      if (!response.ok) throw new Error('Failed to bookmark template');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n      toast({\n        title: 'Готово!',\n        description: 'Закладка обновлена',\n      });\n    },\n  });\n\n  // Мутация для скачивания шаблона\n  const downloadTemplateMutation = useMutation({\n    mutationFn: async (templateId: number) => {\n      const response = await fetch(`/api/templates/${templateId}/download`, {\n        method: 'POST',\n      });\n      if (!response.ok) throw new Error('Failed to increment download count');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n    },\n  });\n\n  const categories = [\n    { value: 'all', label: 'Все категории' },\n    { value: 'official', label: 'Официальные' },\n    { value: 'business', label: 'Бизнес' },\n    { value: 'education', label: 'Образование' },\n    { value: 'entertainment', label: 'Развлечения' },\n    { value: 'utility', label: 'Утилиты' },\n    { value: 'health', label: 'Здоровье' },\n    { value: 'finance', label: 'Финансы' },\n    { value: 'social', label: 'Социальные' },\n    { value: 'custom', label: 'Пользовательские' },\n  ];\n\n  const getTemplateStats = (data: BotData | any) => {\n    let allNodes: any[] = [];\n    let allConnections: any[] = [];\n    \n    // Проверяем, это многолистовой шаблон или обычный\n    if (data.sheets && Array.isArray(data.sheets)) {\n      // Многолистовой шаблон - собираем все узлы и связи из всех листов\n      data.sheets.forEach((sheet: any) => {\n        if (sheet.nodes) allNodes.push(...sheet.nodes);\n        if (sheet.connections) allConnections.push(...sheet.connections);\n      });\n      // Добавляем межлистовые связи\n      if (data.interSheetConnections) {\n        allConnections.push(...data.interSheetConnections);\n      }\n    } else {\n      // Обычный шаблон\n      allNodes = data.nodes || [];\n      allConnections = data.connections || [];\n    }\n    \n    const nodes = allNodes.length;\n    const connections = allConnections.length;\n    const commands = allNodes.filter(node => node.type === 'command').length;\n    const buttons = allNodes.reduce((total, node) => {\n      return total + (node.data?.buttons?.length || 0);\n    }, 0);\n\n    return { nodes, connections, commands, buttons };\n  };\n\n  const filteredAndSortedTemplates = useMemo(() => {\n    let currentTemplates = templates;\n    \n    // Фильтрация по вкладкам\n    if (currentTab === 'featured') {\n      currentTemplates = featuredTemplates;\n    } else if (currentTab === 'popular') {\n      currentTemplates = templates.filter(t => (t.useCount || 0) > 5);\n    } else if (currentTab === 'my') {\n      currentTemplates = myTemplates;\n    }\n\n    // Фильтрация по поиску\n    if (searchTerm) {\n      currentTemplates = currentTemplates.filter(template =>\n        template.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        template.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        template.tags?.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))\n      );\n    }\n\n    // Фильтрация по категории\n    if (selectedCategory !== 'all') {\n      currentTemplates = currentTemplates.filter(template => template.category === selectedCategory);\n    }\n\n    // Сортировка\n    const sorted = [...currentTemplates].sort((a, b) => {\n      switch (sortBy) {\n        case 'popular':\n          return (b.useCount || 0) - (a.useCount || 0);\n        case 'rating':\n          return (b.rating || 0) - (a.rating || 0);\n        case 'recent':\n          return new Date(b.createdAt || 0).getTime() - new Date(a.createdAt || 0).getTime();\n        case 'name':\n          return a.name.localeCompare(b.name, 'ru');\n        default:\n          return 0;\n      }\n    });\n\n    return sorted;\n  }, [templates, featuredTemplates, myTemplates, currentTab, searchTerm, selectedCategory, sortBy]);\n\n  const handleUseTemplate = (template: BotTemplate) => {\n    useTemplateMutation.mutate(template.id);\n    downloadTemplateMutation.mutate(template.id);\n    \n    if (onSelectTemplate) {\n      onSelectTemplate(template);\n    } else {\n      // Сохраняем выбранный шаблон в localStorage для загрузки в редакторе\n      localStorage.setItem('selectedTemplate', JSON.stringify(template));\n      \n      // Пытаемся получить ID текущего проекта из истории браузера или localStorage\n      const lastProjectId = localStorage.getItem('lastProjectId');\n      const referrer = document.referrer;\n      \n      // Если пришли из редактора, возвращаемся туда\n      if (referrer && referrer.includes('/editor/') && lastProjectId) {\n        setLocation(`/editor/${lastProjectId}`);\n      } else {\n        // Иначе переходим на главную страницу\n        setLocation('/');\n      }\n    }\n    \n    toast({\n      title: 'Шаблон загружен!',\n      description: `Шаблон \"${template.name}\" будет применен к вашему проекту`,\n    });\n  };\n\n  const handlePreview = (template: BotTemplate) => {\n    setSelectedTemplate(template);\n    setShowPreview(true);\n  };\n\n  const handleRateTemplate = (template: BotTemplate, rating: number) => {\n    rateTemplateMutation.mutate({ templateId: template.id, rating });\n  };\n\n  const handleDeleteTemplate = (template: BotTemplate) => {\n    if (confirm(`Вы уверены, что хотите удалить шаблон \"${template.name}\"?`)) {\n      deleteTemplateMutation.mutate(template.id);\n    }\n  };\n\n  const TemplateGrid = ({ \n    templates, \n    isLoading, \n    onPreview, \n    onUse, \n    onRate, \n    onDelete, \n    searchTerm, \n    selectedCategory,\n    showDeleteButton = false \n  }: {\n    templates: BotTemplate[];\n    isLoading: boolean;\n    onPreview: (template: BotTemplate) => void;\n    onUse: (template: BotTemplate) => void;\n    onRate: (template: BotTemplate, rating: number) => void;\n    onDelete?: (template: BotTemplate) => void;\n    searchTerm: string;\n    selectedCategory: string;\n    showDeleteButton?: boolean;\n  }) => {\n    if (isLoading) {\n      return (\n        <div className=\"flex items-center justify-center py-12\">\n          <Loader2 className=\"h-8 w-8 animate-spin\" />\n        </div>\n      );\n    }\n\n    if (templates.length === 0) {\n      return (\n        <div className=\"text-center py-12\">\n          <Sparkles className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n          <h3 className=\"text-lg font-medium mb-2\">\n            {searchTerm || selectedCategory !== 'all' \n              ? 'Шаблоны не найдены' \n              : 'Шаблоны пока не созданы'\n            }\n          </h3>\n          <p className=\"text-muted-foreground\">\n            {searchTerm || selectedCategory !== 'all'\n              ? 'Попробуйте изменить фильтры поиска'\n              : 'Создайте свой первый шаблон бота'\n            }\n          </p>\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 py-4\">\n        {templates.map((template: BotTemplate) => {\n          const stats = getTemplateStats(template.data as BotData);\n          \n          return (\n            <Card key={template.id} className=\"hover:shadow-lg dark:hover:shadow-xl transition-all duration-200 border-muted/50 dark:border-muted/20 bg-card/50 dark:bg-card/30 backdrop-blur-sm\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1 min-w-0\">\n                    <CardTitle className=\"text-base leading-tight mb-1 flex items-center gap-2\">\n                      {template.featured === 1 && (\n                        <Crown className=\"h-4 w-4 text-yellow-500 dark:text-yellow-400 flex-shrink-0\" />\n                      )}\n                      <span className=\"truncate\">{template.name}</span>\n                    </CardTitle>\n                    {template.description && (\n                      <CardDescription className=\"text-sm line-clamp-2 leading-relaxed\">\n                        {template.description}\n                      </CardDescription>\n                    )}\n                  </div>\n                  \n                  <div className=\"flex items-center gap-1 ml-2 flex-shrink-0\">\n                    {template.rating && template.rating > 0 && (\n                      <div className=\"flex items-center gap-1 bg-yellow-50 dark:bg-yellow-950/30 px-2 py-1 rounded-full\">\n                        <Star className=\"h-3 w-3 fill-yellow-500 text-yellow-500\" />\n                        <span className=\"text-xs font-medium text-yellow-700 dark:text-yellow-300\">\n                          {template.rating.toFixed(1)}\n                        </span>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {/* Основная статистика */}\n                <div className=\"grid grid-cols-4 gap-2 text-xs\">\n                  <div className=\"text-center p-2 bg-muted dark:bg-muted/30 rounded\">\n                    <div className=\"font-medium\">{stats.nodes}</div>\n                    <div className=\"text-muted-foreground\">узлов</div>\n                  </div>\n                  <div className=\"text-center p-2 bg-muted dark:bg-muted/30 rounded\">\n                    <div className=\"font-medium\">{stats.connections}</div>\n                    <div className=\"text-muted-foreground\">связей</div>\n                  </div>\n                  <div className=\"text-center p-2 bg-muted dark:bg-muted/30 rounded\">\n                    <div className=\"font-medium\">{stats.commands}</div>\n                    <div className=\"text-muted-foreground\">команд</div>\n                  </div>\n                  <div className=\"text-center p-2 bg-muted dark:bg-muted/30 rounded\">\n                    <div className=\"font-medium\">{stats.buttons}</div>\n                    <div className=\"text-muted-foreground\">кнопок</div>\n                  </div>\n                </div>\n\n                {/* Расширенная статистика */}\n                <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                  <div className=\"flex items-center gap-2 p-2 bg-muted/50 dark:bg-muted/20 rounded\">\n                    <Eye className=\"h-3 w-3 text-muted-foreground\" />\n                    <span className=\"font-medium\">{template.viewCount || 0}</span>\n                    <span className=\"text-muted-foreground\">просмотров</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 p-2 bg-muted/50 dark:bg-muted/20 rounded\">\n                    <Download className=\"h-3 w-3 text-muted-foreground\" />\n                    <span className=\"font-medium\">{template.downloadCount || 0}</span>\n                    <span className=\"text-muted-foreground\">скачиваний</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 p-2 bg-muted/50 dark:bg-muted/20 rounded\">\n                    <Heart className=\"h-3 w-3 text-muted-foreground\" />\n                    <span className=\"font-medium\">{template.likeCount || 0}</span>\n                    <span className=\"text-muted-foreground\">лайков</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 p-2 bg-muted/50 dark:bg-muted/20 rounded\">\n                    <Clock className=\"h-3 w-3 text-muted-foreground\" />\n                    <span className=\"font-medium\">{template.estimatedTime || 5}</span>\n                    <span className=\"text-muted-foreground\">мин.</span>\n                  </div>\n                </div>\n\n                {/* Дополнительные индикаторы */}\n                <div className=\"flex items-center gap-2 text-xs\">\n                  {template.requiresToken === 1 && (\n                    <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                      <Shield className=\"h-3 w-3\" />\n                      Токен\n                    </Badge>\n                  )}\n                  {template.language && template.language !== 'ru' && (\n                    <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                      <Globe className=\"h-3 w-3\" />\n                      {template.language.toUpperCase()}\n                    </Badge>\n                  )}\n                  <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                    <TrendingUp className=\"h-3 w-3\" />\n                    {template.complexity || 1}/10\n                  </Badge>\n                </div>\n                \n                {template.tags && template.tags.length > 0 && (\n                  <div className=\"flex flex-wrap gap-1\">\n                    {template.tags.slice(0, 3).map((tag) => (\n                      <Badge key={tag} variant=\"outline\" className=\"text-xs\">\n                        {tag}\n                      </Badge>\n                    ))}\n                    {template.tags.length > 3 && (\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        +{template.tags.length - 3}\n                      </Badge>\n                    )}\n                  </div>\n                )}\n                \n                <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                  <div className=\"flex items-center gap-1\">\n                    <Calendar className=\"h-3 w-3\" />\n                    {template.createdAt && format(new Date(template.createdAt), 'dd.MM.yyyy', { locale: ru })}\n                  </div>\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    {categories.find(c => c.value === template.category)?.label || template.category}\n                  </Badge>\n                </div>\n                \n                <div className=\"flex gap-2\">\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={() => onPreview(template)}\n                    className=\"flex-1\"\n                  >\n                    <Eye className=\"h-4 w-4 mr-1\" />\n                    Просмотр\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    onClick={() => onUse(template)}\n                    className=\"flex-1\"\n                  >\n                    <Download className=\"h-4 w-4 mr-1\" />\n                    Использовать\n                  </Button>\n                  {showDeleteButton && onDelete && template.category === 'custom' && (\n                    <Button\n                      size=\"sm\"\n                      variant=\"destructive\"\n                      onClick={() => onDelete(template)}\n                      className=\"px-2\"\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  )}\n                </div>\n\n                {/* Интерактивные действия */}\n                <div className=\"flex items-center justify-between pt-2 border-t\">\n                  <div className=\"flex items-center gap-2\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => likeTemplateMutation.mutate({ \n                        templateId: template.id, \n                        liked: true \n                      })}\n                      className=\"h-7 px-2\"\n                    >\n                      <Heart className=\"h-3 w-3 mr-1\" />\n                      <span className=\"text-xs\">{template.likeCount || 0}</span>\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => bookmarkTemplateMutation.mutate({ \n                        templateId: template.id, \n                        bookmarked: true \n                      })}\n                      className=\"h-7 px-2\"\n                    >\n                      <Bookmark className=\"h-3 w-3 mr-1\" />\n                      <span className=\"text-xs\">{template.bookmarkCount || 0}</span>\n                    </Button>\n                  </div>\n                  \n                  <div className=\"flex items-center gap-1\">\n                    <span className=\"text-xs text-muted-foreground mr-1\">Оценить:</span>\n                    {[1, 2, 3, 4, 5].map((rating) => (\n                      <button\n                        key={rating}\n                        onClick={() => onRate(template, rating)}\n                        className=\"text-muted-foreground hover:text-yellow-500 transition-colors\"\n                      >\n                        <Star className=\"h-3 w-3\" />\n                      </button>\n                    ))}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          );\n        })}\n      </div>\n    );\n  };\n\n  const TemplatePreview = ({ template }: { template: BotTemplate }) => {\n    const stats = getTemplateStats(template.data as BotData);\n    \n    return (\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-lg font-semibold\">{template.name}</h3>\n          <Button size=\"sm\" onClick={() => setShowPreview(false)}>\n            Закрыть\n          </Button>\n        </div>\n        \n        {template.description && (\n          <p className=\"text-muted-foreground\">{template.description}</p>\n        )}\n        \n        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n          <div className=\"p-3 bg-muted dark:bg-muted/50 rounded-lg\">\n            <div className=\"font-medium\">Узлов</div>\n            <div className=\"text-2xl font-bold text-primary\">{stats.nodes}</div>\n          </div>\n          <div className=\"p-3 bg-muted dark:bg-muted/50 rounded-lg\">\n            <div className=\"font-medium\">Связей</div>\n            <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">{stats.connections}</div>\n          </div>\n          <div className=\"p-3 bg-muted dark:bg-muted/50 rounded-lg\">\n            <div className=\"font-medium\">Команд</div>\n            <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">{stats.commands}</div>\n          </div>\n          <div className=\"p-3 bg-muted dark:bg-muted/50 rounded-lg\">\n            <div className=\"font-medium\">Кнопок</div>\n            <div className=\"text-2xl font-bold text-purple-600 dark:text-purple-400\">{stats.buttons}</div>\n          </div>\n        </div>\n        \n        {template.tags && template.tags.length > 0 && (\n          <div>\n            <h4 className=\"font-medium mb-2\">Теги:</h4>\n            <div className=\"flex flex-wrap gap-2\">\n              {template.tags.map((tag) => (\n                <Badge key={tag} variant=\"secondary\">{tag}</Badge>\n              ))}\n            </div>\n          </div>\n        )}\n        \n        <div className=\"flex gap-2 pt-4\">\n          <Button onClick={() => handleUseTemplate(template)} className=\"flex-1\">\n            <Download className=\"h-4 w-4 mr-2\" />\n            Использовать шаблон\n          </Button>\n        </div>\n      </div>\n    );\n  };\n\n  // Компоненты для layout\n  const headerContent = (\n    <div className=\"h-16 bg-background border-b border-border px-6 flex items-center justify-between relative\">\n      {/* Левая часть - логотип и название */}\n      <div className=\"flex items-center space-x-6\">\n        <div className=\"flex items-center space-x-3\">\n          <div className=\"bg-primary rounded-lg w-8 h-8 flex items-center justify-center\">\n            <Sparkles className=\"h-5 w-5 text-primary-foreground\" />\n          </div>\n          <div>\n            <h1 className=\"text-lg font-semibold text-foreground\">TelegramBot Builder</h1>\n            <p className=\"text-xs text-muted-foreground\">Шаблоны ботов</p>\n          </div>\n        </div>\n\n        {/* Навигация по основным разделам */}\n        <nav className=\"flex items-center space-x-1\">\n          {[\n            { key: 'editor', label: 'Редактор', onClick: () => setLocation('/') },\n            { key: 'templates', label: 'Шаблоны', onClick: () => {}, isActive: true },\n            { key: 'export', label: 'Экспорт', onClick: () => setLocation('/') },\n            { key: 'bot', label: 'Бот', onClick: () => setLocation('/') }\n          ].map((tab) => {\n            const isActive = tab.isActive;\n            return (\n              <button\n                key={tab.key}\n                onClick={tab.onClick}\n                className={`\n                  relative px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200 \n                  flex items-center gap-2 group\n                  ${isActive \n                    ? 'text-primary bg-primary/10 shadow-sm' \n                    : 'text-muted-foreground hover:text-foreground hover:bg-muted/50'\n                  }\n                `}\n              >\n                {tab.label}\n              </button>\n            );\n          })}\n        </nav>\n      </div>\n\n      {/* Правая часть - действия и настройки */}\n      <div className=\"flex items-center space-x-3\">\n        {/* Настройки макета */}\n        <SimpleLayoutCustomizer\n          config={flexibleLayoutConfig}\n          onConfigChange={setFlexibleLayoutConfig}\n        >\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            className=\"transition-all hover:scale-105\"\n          >\n            <Layout className=\"h-4 w-4 mr-2\" />\n            Настройки макета\n          </Button>\n        </SimpleLayoutCustomizer>\n        \n        <Button \n          variant=\"outline\" \n          size=\"sm\"\n          onClick={() => {\n            const lastProjectId = localStorage.getItem('lastProjectId');\n            if (lastProjectId) {\n              setLocation(`/editor/${lastProjectId}`);\n            } else {\n              setLocation('/');\n            }\n          }}\n          className=\"transition-all hover:scale-105\"\n        >\n          <ArrowLeft className=\"h-4 w-4 mr-2\" />\n          Назад к редактору\n        </Button>\n      </div>\n    </div>\n  );\n\n  const sidebarContent = (\n    <div className=\"p-4 space-y-4\">\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles className=\"h-5 w-5 text-primary\" />\n        <h2 className=\"font-semibold\">Категории</h2>\n      </div>\n      \n      <Tabs value={currentTab} onValueChange={setCurrentTab} orientation=\"vertical\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-1 h-auto\">\n          <TabsTrigger value=\"all\" className=\"justify-start gap-2\">\n            <Filter className=\"h-4 w-4\" />\n            Все шаблоны\n          </TabsTrigger>\n          <TabsTrigger value=\"featured\" className=\"justify-start gap-2\">\n            <Crown className=\"h-4 w-4\" />\n            Рекомендуемые\n          </TabsTrigger>\n          <TabsTrigger value=\"popular\" className=\"justify-start gap-2\">\n            <TrendingUp className=\"h-4 w-4\" />\n            Популярные\n          </TabsTrigger>\n          <TabsTrigger value=\"my\" className=\"justify-start gap-2\">\n            <User className=\"h-4 w-4\" />\n            Мои шаблоны\n          </TabsTrigger>\n        </TabsList>\n      </Tabs>\n\n      <div className=\"space-y-3\">\n        <div>\n          <label className=\"text-sm font-medium mb-2 block\">Категория</label>\n          <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n            <SelectTrigger className=\"w-full\">\n              <SelectValue placeholder=\"Выберите категорию\" />\n            </SelectTrigger>\n            <SelectContent>\n              {categories.map((category) => (\n                <SelectItem key={category.value} value={category.value}>\n                  {category.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n        \n        <div>\n          <label className=\"text-sm font-medium mb-2 block\">Сортировка</label>\n          <Select value={sortBy} onValueChange={(value: any) => setSortBy(value)}>\n            <SelectTrigger className=\"w-full\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"popular\">Популярность</SelectItem>\n              <SelectItem value=\"rating\">Рейтинг</SelectItem>\n              <SelectItem value=\"recent\">Новые</SelectItem>\n              <SelectItem value=\"name\">По алфавиту</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n    </div>\n  );\n\n  const canvasContent = (\n    <div className=\"p-4 h-full\">\n      {showPreview && selectedTemplate ? (\n        <TemplatePreview template={selectedTemplate} />\n      ) : (\n        <div className=\"space-y-4\">\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4\" />\n            <Input\n              placeholder=\"Поиск шаблонов...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-10\"\n            />\n          </div>\n\n          <div className=\"h-full overflow-y-auto\">\n            <TabsContent value=\"all\" className=\"mt-0\">\n              <TemplateGrid \n                templates={filteredAndSortedTemplates} \n                isLoading={isLoading}\n                onPreview={handlePreview}\n                onUse={handleUseTemplate}\n                onRate={handleRateTemplate}\n                searchTerm={searchTerm}\n                selectedCategory={selectedCategory}\n              />\n            </TabsContent>\n            \n            <TabsContent value=\"featured\" className=\"mt-0\">\n              <TemplateGrid \n                templates={filteredAndSortedTemplates} \n                isLoading={isLoadingFeatured}\n                onPreview={handlePreview}\n                onUse={handleUseTemplate}\n                onRate={handleRateTemplate}\n                searchTerm={searchTerm}\n                selectedCategory={selectedCategory}\n              />\n            </TabsContent>\n            \n            <TabsContent value=\"popular\" className=\"mt-0\">\n              <TemplateGrid \n                templates={filteredAndSortedTemplates} \n                isLoading={isLoading}\n                onPreview={handlePreview}\n                onUse={handleUseTemplate}\n                onRate={handleRateTemplate}\n                searchTerm={searchTerm}\n                selectedCategory={selectedCategory}\n              />\n            </TabsContent>\n            \n            <TabsContent value=\"my\" className=\"mt-0\">\n              <TemplateGrid \n                templates={filteredAndSortedTemplates} \n                isLoading={isLoadingMy}\n                onPreview={handlePreview}\n                onUse={handleUseTemplate}\n                onRate={handleRateTemplate}\n                onDelete={handleDeleteTemplate}\n                searchTerm={searchTerm}\n                selectedCategory={selectedCategory}\n                showDeleteButton={true}\n              />\n            </TabsContent>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n\n  const propertiesContent = (\n    <div className=\"p-4 space-y-4\">\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Filter className=\"h-5 w-5 text-primary\" />\n        <h2 className=\"font-semibold\">Фильтры</h2>\n      </div>\n      \n      {selectedTemplate && showPreview ? (\n        <div className=\"space-y-4\">\n          <h3 className=\"font-medium\">Информация о шаблоне</h3>\n          <div className=\"space-y-2 text-sm\">\n            <div>\n              <span className=\"font-medium\">Название:</span>\n              <p className=\"text-muted-foreground\">{selectedTemplate.name}</p>\n            </div>\n            {selectedTemplate.description && (\n              <div>\n                <span className=\"font-medium\">Описание:</span>\n                <p className=\"text-muted-foreground\">{selectedTemplate.description}</p>\n              </div>\n            )}\n            <div>\n              <span className=\"font-medium\">Категория:</span>\n              <p className=\"text-muted-foreground\">\n                {categories.find(c => c.value === selectedTemplate.category)?.label || selectedTemplate.category}\n              </p>\n            </div>\n            {selectedTemplate.tags && selectedTemplate.tags.length > 0 && (\n              <div>\n                <span className=\"font-medium\">Теги:</span>\n                <div className=\"flex flex-wrap gap-1 mt-1\">\n                  {selectedTemplate.tags.map((tag) => (\n                    <Badge key={tag} variant=\"outline\" className=\"text-xs\">\n                      {tag}\n                    </Badge>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      ) : (\n        <div className=\"space-y-4 text-sm\">\n          <div>\n            <span className=\"font-medium\">Всего шаблонов:</span>\n            <p className=\"text-muted-foreground\">{templates.length}</p>\n          </div>\n          <div>\n            <span className=\"font-medium\">Отфильтровано:</span>\n            <p className=\"text-muted-foreground\">{filteredAndSortedTemplates.length}</p>\n          </div>\n          {searchTerm && (\n            <div>\n              <span className=\"font-medium\">Поиск:</span>\n              <p className=\"text-muted-foreground\">\"{searchTerm}\"</p>\n            </div>\n          )}\n          <div>\n            <span className=\"font-medium\">Текущая вкладка:</span>\n            <p className=\"text-muted-foreground\">\n              {currentTab === 'all' && 'Все шаблоны'}\n              {currentTab === 'featured' && 'Рекомендуемые'}\n              {currentTab === 'popular' && 'Популярные'}\n              {currentTab === 'my' && 'Мои шаблоны'}\n            </p>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n\n  return (\n    <Tabs value={currentTab} onValueChange={setCurrentTab}>\n      <SimpleLayoutCustomizer\n        config={flexibleLayoutConfig}\n        onConfigChange={setFlexibleLayoutConfig}\n      >\n        <FlexibleLayout\n          config={flexibleLayoutConfig}\n          headerContent={headerContent}\n          sidebarContent={sidebarContent}\n          canvasContent={canvasContent}\n          propertiesContent={propertiesContent}\n        />\n      </SimpleLayoutCustomizer>\n    </Tabs>\n  );\n}\n\nexport default TemplatesPage;","size_bytes":37999},"client/src/components/server-status.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Button } from '@/components/ui/button';\nimport { RefreshCw, CheckCircle, AlertCircle, Loader2 } from 'lucide-react';\n\ninterface ServerHealthStatus {\n  database: boolean;\n  templates: boolean;\n  telegram: boolean;\n  ready: boolean;\n}\n\nexport function ServerStatus() {\n  const [status, setStatus] = useState<ServerHealthStatus | null>(null);\n  const [isVisible, setIsVisible] = useState(true);\n\n  const checkHealth = async () => {\n    try {\n      const response = await fetch('/api/health');\n      const data = await response.json();\n      setStatus(data);\n      \n      // Автоматически скрываем индикатор когда все готово\n      if (data.ready) {\n        setTimeout(() => setIsVisible(false), 2000);\n      }\n    } catch (error) {\n      console.error('Health check failed:', error);\n      // Повторяем проверку через 2 секунды при ошибке\n      setTimeout(checkHealth, 2000);\n    }\n  };\n\n  useEffect(() => {\n    checkHealth();\n    \n    // Только делаем один запрос при загрузке, дальше полагаемся на кеширование\n    let interval: NodeJS.Timeout | null = null;\n    \n    if (!status?.ready) {\n      // Проверяем каждые 5 секунд только если сервер не готов\n      interval = setInterval(checkHealth, 5000);\n    }\n    \n    return () => {\n      if (interval) {\n        clearInterval(interval);\n      }\n    };\n  }, [status?.ready]);\n\n  // Не показываем индикатор если статус неизвестен или система готова и прошло время\n  if (!status || (!isVisible && status.ready)) {\n    return null;\n  }\n\n  // Не показываем если уже все готово\n  if (status.ready && isVisible) {\n    return (\n      <Alert className=\"fixed top-4 right-4 w-80 z-50 border-green-200 bg-green-50 dark:bg-green-950\">\n        <CheckCircle className=\"h-4 w-4 text-green-600\" />\n        <AlertDescription className=\"text-green-800 dark:text-green-200\">\n          Сервер готов к работе!\n        </AlertDescription>\n      </Alert>\n    );\n  }\n\n  return (\n    <Alert className=\"fixed top-4 right-4 w-80 z-50\">\n      <Loader2 className=\"h-4 w-4 animate-spin\" />\n      <AlertDescription>\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"font-medium\">Загрузка сервера...</span>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              onClick={checkHealth}\n              className=\"h-6 w-6 p-0\"\n            >\n              <RefreshCw className=\"h-3 w-3\" />\n            </Button>\n          </div>\n          \n          <div className=\"space-y-1 text-sm\">\n            <div className=\"flex items-center gap-2\">\n              {status.database ? (\n                <CheckCircle className=\"h-3 w-3 text-green-600\" />\n              ) : (\n                <Loader2 className=\"h-3 w-3 animate-spin text-orange-500\" />\n              )}\n              <span className={status.database ? 'text-green-700 dark:text-green-300' : 'text-orange-600 dark:text-orange-400'}>\n                База данных\n              </span>\n            </div>\n            \n            <div className=\"flex items-center gap-2\">\n              {status.templates ? (\n                <CheckCircle className=\"h-3 w-3 text-green-600\" />\n              ) : (\n                <Loader2 className=\"h-3 w-3 animate-spin text-orange-500\" />\n              )}\n              <span className={status.templates ? 'text-green-700 dark:text-green-300' : 'text-orange-600 dark:text-orange-400'}>\n                Шаблоны\n              </span>\n            </div>\n            \n            <div className=\"flex items-center gap-2\">\n              {status.telegram ? (\n                <CheckCircle className=\"h-3 w-3 text-green-600\" />\n              ) : (\n                <Loader2 className=\"h-3 w-3 animate-spin text-orange-500\" />\n              )}\n              <span className={status.telegram ? 'text-green-700 dark:text-green-300' : 'text-orange-600 dark:text-orange-400'}>\n                Telegram\n              </span>\n            </div>\n          </div>\n          \n          {!status.ready && (\n            <div className=\"text-xs text-muted-foreground mt-2\">\n              Некоторые функции могут быть временно недоступны\n            </div>\n          )}\n        </div>\n      </AlertDescription>\n    </Alert>\n  );\n}","size_bytes":4708},"scripts/migrate.ts":{"content":"import { Pool } from 'pg';\nimport { drizzle } from 'drizzle-orm/node-postgres';\nimport { migrate } from 'drizzle-orm/node-postgres/migrator';\nimport * as schema from '../shared/schema';\n\nasync function runMigrations() {\n  const databaseUrl = process.env.DATABASE_URL;\n  \n  if (!databaseUrl) {\n    console.error('DATABASE_URL must be set');\n    process.exit(1);\n  }\n\n  console.log('Initializing database connection...');\n  \n  const pool = new Pool({ \n    connectionString: databaseUrl,\n    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n  });\n\n  const db = drizzle(pool, { schema });\n\n  try {\n    console.log('Running migrations...');\n    await migrate(db, { migrationsFolder: './migrations' });\n    console.log('Migrations completed successfully!');\n  } catch (error) {\n    console.error('Migration failed:', error);\n    process.exit(1);\n  } finally {\n    await pool.end();\n  }\n}\n\nrunMigrations().catch(console.error);","size_bytes":955},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b border-border\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:no-underline hover:bg-muted/50 rounded-lg px-2 text-foreground\",\n        \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2\",\n        \"[&[data-state=open]>svg]:rotate-180 [&[data-state=open]]:bg-muted/30\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-300 text-muted-foreground group-hover:text-foreground\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":2252},"client/src/components/layout/layout-customizer.tsx":{"content":"import React, { useState, useCallback } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Switch } from '@/components/ui/switch';\nimport { Label } from '@/components/ui/label';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { DraggableLayout, useDraggableLayout, LayoutElement } from './draggable-layout';\nimport { \n  Layout, \n  Move, \n  Settings, \n  Grid, \n  Eye, \n  EyeOff, \n  Lock, \n  Unlock,\n  RotateCcw,\n  Play,\n  Pause\n} from 'lucide-react';\n\ninterface LayoutCustomizerProps {\n  headerContent: React.ReactNode;\n  sidebarContent: React.ReactNode;\n  canvasContent: React.ReactNode;\n  propertiesContent: React.ReactNode;\n  onLayoutChange?: (elements: LayoutElement[]) => void;\n}\n\nexport const LayoutCustomizer: React.FC<LayoutCustomizerProps> = ({\n  headerContent,\n  sidebarContent,\n  canvasContent,\n  propertiesContent,\n  onLayoutChange\n}) => {\n  const [isCustomizing, setIsCustomizing] = useState(false);\n  const {\n    config,\n    updateConfig,\n    moveElement,\n    resizeElement,\n    toggleElementVisibility,\n    toggleElementLock,\n    resetLayout\n  } = useDraggableLayout();\n\n  // Создаем элементы с реальным контентом\n  const elementsWithContent = config.elements.map(element => ({\n    ...element,\n    content: (() => {\n      switch (element.type) {\n        case 'header':\n          return headerContent;\n        case 'sidebar':\n          return sidebarContent;\n        case 'canvas':\n          return canvasContent;\n        case 'properties':\n          return propertiesContent;\n        default:\n          return null;\n      }\n    })()\n  }));\n\n  const handleApplyLayout = useCallback(() => {\n    if (onLayoutChange) {\n      onLayoutChange(elementsWithContent);\n    }\n    setIsCustomizing(false);\n  }, [elementsWithContent, onLayoutChange]);\n\n  const handleToggleCustomizer = useCallback(() => {\n    setIsCustomizing(!isCustomizing);\n  }, [isCustomizing]);\n\n  const visibleElements = elementsWithContent.filter(el => el.visible);\n  const lockedElements = elementsWithContent.filter(el => el.locked);\n\n  return (\n    <Dialog open={isCustomizing} onOpenChange={setIsCustomizing}>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\" size=\"sm\" onClick={handleToggleCustomizer}>\n          <Move className=\"w-4 h-4 mr-2\" />\n          Настроить расположение\n        </Button>\n      </DialogTrigger>\n      \n      <DialogContent className=\"max-w-7xl max-h-[90vh] p-0\">\n        <DialogHeader className=\"p-6 pb-0\">\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Layout className=\"w-5 h-5\" />\n            Настройка расположения интерфейса\n          </DialogTitle>\n        </DialogHeader>\n        \n        <Tabs defaultValue=\"customize\" className=\"flex-1 flex flex-col\">\n          <div className=\"px-6\">\n            <TabsList className=\"grid w-full grid-cols-2\">\n              <TabsTrigger value=\"customize\">Настройка</TabsTrigger>\n              <TabsTrigger value=\"elements\">Элементы</TabsTrigger>\n            </TabsList>\n          </div>\n          \n          <TabsContent value=\"customize\" className=\"flex-1 m-0\">\n            <div className=\"h-[600px] flex flex-col\">\n              <DraggableLayout\n                elements={elementsWithContent}\n                config={config}\n                onElementMove={moveElement}\n                onElementResize={resizeElement}\n                onElementToggleVisibility={toggleElementVisibility}\n                onElementToggleLock={toggleElementLock}\n                onConfigChange={updateConfig}\n              />\n            </div>\n          </TabsContent>\n          \n          <TabsContent value=\"elements\" className=\"flex-1 m-0 p-6\">\n            <div className=\"space-y-6\">\n              {/* Статистика */}\n              <div className=\"grid grid-cols-4 gap-4\">\n                <Card>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <Layout className=\"w-4 h-4 text-blue-500\" />\n                      <div>\n                        <p className=\"text-sm font-medium\">Всего элементов</p>\n                        <p className=\"text-lg font-bold\">{elementsWithContent.length}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n                \n                <Card>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <Eye className=\"w-4 h-4 text-green-500\" />\n                      <div>\n                        <p className=\"text-sm font-medium\">Видимые</p>\n                        <p className=\"text-lg font-bold\">{visibleElements.length}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n                \n                <Card>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <Lock className=\"w-4 h-4 text-orange-500\" />\n                      <div>\n                        <p className=\"text-sm font-medium\">Заблокированные</p>\n                        <p className=\"text-lg font-bold\">{lockedElements.length}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n                \n                <Card>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center gap-2\">\n                      <Grid className=\"w-4 h-4 text-purple-500\" />\n                      <div>\n                        <p className=\"text-sm font-medium\">Сетка</p>\n                        <p className=\"text-lg font-bold\">{config.gridSize}%</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Список элементов */}\n              <div className=\"space-y-4\">\n                <h3 className=\"text-lg font-semibold\">Управление элементами</h3>\n                \n                {elementsWithContent.map((element) => (\n                  <Card key={element.id} className=\"border-l-4 border-l-blue-500\">\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-8 h-8 rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center\">\n                            <Layout className=\"w-4 h-4\" />\n                          </div>\n                          <div>\n                            <h4 className=\"font-medium capitalize\">{element.type}</h4>\n                            <p className=\"text-sm text-gray-500\">\n                              {Math.round(element.position.x)}%, {Math.round(element.position.y)}% • \n                              {Math.round(element.size.width)}×{Math.round(element.size.height)}%\n                            </p>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-2\">\n                          <Badge variant={element.visible ? \"default\" : \"secondary\"}>\n                            {element.visible ? \"Видимый\" : \"Скрытый\"}\n                          </Badge>\n                          <Badge variant={element.locked ? \"destructive\" : \"outline\"}>\n                            {element.locked ? \"Заблокирован\" : \"Разблокирован\"}\n                          </Badge>\n                          \n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => toggleElementVisibility(element.id)}\n                          >\n                            {element.visible ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                          </Button>\n                          \n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => toggleElementLock(element.id)}\n                          >\n                            {element.locked ? <Unlock className=\"w-4 h-4\" /> : <Lock className=\"w-4 h-4\" />}\n                          </Button>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n\n              {/* Быстрые действия */}\n              <div className=\"space-y-4\">\n                <h3 className=\"text-lg font-semibold\">Быстрые действия</h3>\n                \n                <div className=\"flex flex-wrap gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => {\n                      elementsWithContent.forEach(el => {\n                        toggleElementVisibility(el.id);\n                      });\n                    }}\n                  >\n                    {visibleElements.length === elementsWithContent.length ? (\n                      <>\n                        <EyeOff className=\"w-4 h-4 mr-2\" />\n                        Скрыть все\n                      </>\n                    ) : (\n                      <>\n                        <Eye className=\"w-4 h-4 mr-2\" />\n                        Показать все\n                      </>\n                    )}\n                  </Button>\n                  \n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => {\n                      elementsWithContent.forEach(el => {\n                        toggleElementLock(el.id);\n                      });\n                    }}\n                  >\n                    {lockedElements.length === elementsWithContent.length ? (\n                      <>\n                        <Unlock className=\"w-4 h-4 mr-2\" />\n                        Разблокировать все\n                      </>\n                    ) : (\n                      <>\n                        <Lock className=\"w-4 h-4 mr-2\" />\n                        Заблокировать все\n                      </>\n                    )}\n                  </Button>\n                  \n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => updateConfig({ previewMode: !config.previewMode })}\n                  >\n                    {config.previewMode ? (\n                      <>\n                        <Pause className=\"w-4 h-4 mr-2\" />\n                        Режим редактирования\n                      </>\n                    ) : (\n                      <>\n                        <Play className=\"w-4 h-4 mr-2\" />\n                        Режим предпросмотра\n                      </>\n                    )}\n                  </Button>\n                  \n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={resetLayout}\n                  >\n                    <RotateCcw className=\"w-4 h-4 mr-2\" />\n                    Сбросить\n                  </Button>\n                </div>\n              </div>\n            </div>\n          </TabsContent>\n        </Tabs>\n        \n        {/* Кнопки действий */}\n        <div className=\"flex justify-between items-center p-6 pt-0 border-t\">\n          <div className=\"flex items-center gap-2\">\n            <Switch\n              id=\"live-preview\"\n              checked={config.previewMode}\n              onCheckedChange={(checked) => updateConfig({ previewMode: checked })}\n            />\n            <Label htmlFor=\"live-preview\">Режим предпросмотра</Label>\n          </div>\n          \n          <div className=\"flex gap-2\">\n            <Button variant=\"outline\" onClick={() => setIsCustomizing(false)}>\n              Отмена\n            </Button>\n            <Button onClick={handleApplyLayout}>\n              Применить расположение\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default LayoutCustomizer;","size_bytes":12851},"client/src/components/layout/layout-toggle-button.tsx":{"content":"import React from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\nimport { Badge } from '@/components/ui/badge';\nimport { \n  Layout, \n  Settings, \n  Move, \n  Eye,\n  EyeOff,\n  ArrowUp,\n  ArrowDown,\n  ArrowLeft,\n  ArrowRight,\n  Grid\n} from 'lucide-react';\n\ninterface LayoutToggleButtonProps {\n  isEditing: boolean;\n  onToggle: () => void;\n  hasUnsavedChanges?: boolean;\n  elementsCount?: number;\n  className?: string;\n}\n\nexport const LayoutToggleButton: React.FC<LayoutToggleButtonProps> = ({\n  isEditing,\n  onToggle,\n  hasUnsavedChanges = false,\n  elementsCount = 4,\n  className = ''\n}) => {\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Button\n            variant={isEditing ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={onToggle}\n            className={`relative ${className}`}\n          >\n            <Layout className=\"w-4 h-4 mr-2\" />\n            {isEditing ? 'Редактор макета' : 'Настроить макет'}\n            \n            {hasUnsavedChanges && (\n              <div className=\"absolute -top-1 -right-1 w-2 h-2 bg-orange-500 rounded-full animate-pulse\" />\n            )}\n          </Button>\n        </TooltipTrigger>\n        <TooltipContent>\n          <div className=\"text-sm\">\n            {isEditing ? (\n              <div>\n                <p className=\"font-medium\">Режим редактирования активен</p>\n                <p className=\"text-xs text-muted-foreground\">\n                  Перетащите элементы для изменения макета\n                </p>\n              </div>\n            ) : (\n              <div>\n                <p className=\"font-medium\">Настроить расположение элементов</p>\n                <p className=\"text-xs text-muted-foreground\">\n                  Управление позицией панелей и размерами\n                </p>\n                <div className=\"flex items-center justify-between mt-2\">\n                  <span className=\"text-xs\">Элементов:</span>\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {elementsCount}\n                  </Badge>\n                </div>\n              </div>\n            )}\n          </div>\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  );\n};\n\ninterface QuickLayoutControlsProps {\n  onMoveHeader: (position: 'top' | 'bottom') => void;\n  onToggleSidebar: () => void;\n  onToggleProperties: () => void;\n  onResetLayout: () => void;\n  headerPosition: 'top' | 'bottom';\n  sidebarVisible: boolean;\n  propertiesVisible: boolean;\n  className?: string;\n}\n\nexport const QuickLayoutControls: React.FC<QuickLayoutControlsProps> = ({\n  onMoveHeader,\n  onToggleSidebar,\n  onToggleProperties,\n  onResetLayout,\n  headerPosition,\n  sidebarVisible,\n  propertiesVisible,\n  className = ''\n}) => {\n  return (\n    <div className={`flex items-center space-x-1 ${className}`}>\n      <TooltipProvider>\n        {/* Быстрое перемещение шапки */}\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => onMoveHeader(headerPosition === 'top' ? 'bottom' : 'top')}\n            >\n              {headerPosition === 'top' ? (\n                <ArrowDown className=\"w-4 h-4\" />\n              ) : (\n                <ArrowUp className=\"w-4 h-4\" />\n              )}\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p className=\"text-xs\">\n              Переместить шапку {headerPosition === 'top' ? 'вниз' : 'вверх'}\n            </p>\n          </TooltipContent>\n        </Tooltip>\n\n        {/* Переключение боковой панели */}\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={onToggleSidebar}\n            >\n              {sidebarVisible ? (\n                <EyeOff className=\"w-4 h-4\" />\n              ) : (\n                <Eye className=\"w-4 h-4\" />\n              )}\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p className=\"text-xs\">\n              {sidebarVisible ? 'Скрыть' : 'Показать'} боковую панель\n            </p>\n          </TooltipContent>\n        </Tooltip>\n\n        {/* Переключение панели свойств */}\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={onToggleProperties}\n            >\n              {propertiesVisible ? (\n                <ArrowRight className=\"w-4 h-4\" />\n              ) : (\n                <ArrowLeft className=\"w-4 h-4\" />\n              )}\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p className=\"text-xs\">\n              {propertiesVisible ? 'Скрыть' : 'Показать'} панель свойств\n            </p>\n          </TooltipContent>\n        </Tooltip>\n\n        {/* Сброс макета */}\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={onResetLayout}\n            >\n              <Grid className=\"w-4 h-4\" />\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p className=\"text-xs\">Сбросить макет к умолчанию</p>\n          </TooltipContent>\n        </Tooltip>\n      </TooltipProvider>\n    </div>\n  );\n};\n\ninterface LayoutStatusIndicatorProps {\n  config: {\n    elements: Array<{\n      id: string;\n      type: string;\n      position: string;\n      visible: boolean;\n      size: number;\n    }>;\n    lastModified: Date;\n  };\n  className?: string;\n}\n\nexport const LayoutStatusIndicator: React.FC<LayoutStatusIndicatorProps> = ({\n  config,\n  className = ''\n}) => {\n  const visibleElements = config.elements.filter(el => el.visible);\n  const customized = config.elements.some(el => \n    (el.type === 'header' && el.position !== 'top') ||\n    (el.type === 'sidebar' && el.position !== 'left') ||\n    (el.type === 'properties' && el.position !== 'right') ||\n    !el.visible\n  );\n\n  return (\n    <div className={`flex items-center space-x-2 ${className}`}>\n      <div className=\"flex items-center space-x-1\">\n        {customized && (\n          <div className=\"w-2 h-2 bg-blue-500 rounded-full animate-pulse\" />\n        )}\n        <span className=\"text-xs text-muted-foreground\">\n          {visibleElements.length}/{config.elements.length} элементов\n        </span>\n      </div>\n      \n      <Badge variant={customized ? \"default\" : \"secondary\"} className=\"text-xs\">\n        {customized ? 'Настроен' : 'По умолчанию'}\n      </Badge>\n    </div>\n  );\n};","size_bytes":7048},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"client/src/components/editor/visibility-controls.tsx":{"content":"import { Button } from '@/components/ui/button';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Eye, EyeOff, Layout, Sidebar, Square, Settings } from 'lucide-react';\n\ninterface VisibilityControlsProps {\n  headerVisible: boolean;\n  sidebarVisible: boolean;\n  canvasVisible: boolean;\n  propertiesVisible: boolean;\n  onToggleHeader: () => void;\n  onToggleSidebar: () => void;\n  onToggleCanvas: () => void;\n  onToggleProperties: () => void;\n}\n\nexport function VisibilityControls({\n  headerVisible,\n  sidebarVisible,\n  canvasVisible,\n  propertiesVisible,\n  onToggleHeader,\n  onToggleSidebar,\n  onToggleCanvas,\n  onToggleProperties,\n}: VisibilityControlsProps) {\n  // Определяем, нужно ли показать панель управления\n  const shouldShowControls = !headerVisible || !sidebarVisible || !canvasVisible || !propertiesVisible;\n\n  if (!shouldShowControls) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed top-4 left-4 z-50\">\n      <Card className=\"bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border shadow-lg\">\n        <CardContent className=\"p-3\">\n          <div className=\"flex flex-col gap-2\">\n            <h3 className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n              Показать панели:\n            </h3>\n            \n            <div className=\"grid grid-cols-2 gap-2\">\n              <Button\n                variant={headerVisible ? \"default\" : \"outline\"}\n                size=\"sm\"\n                onClick={onToggleHeader}\n                className=\"flex items-center gap-2 text-xs\"\n              >\n                {headerVisible ? <Eye size={14} /> : <EyeOff size={14} />}\n                Шапка\n              </Button>\n\n              <Button\n                variant={sidebarVisible ? \"default\" : \"outline\"}\n                size=\"sm\"\n                onClick={onToggleSidebar}\n                className=\"flex items-center gap-2 text-xs\"\n              >\n                {sidebarVisible ? <Eye size={14} /> : <EyeOff size={14} />}\n                Боковая панель\n              </Button>\n\n              <Button\n                variant={canvasVisible ? \"default\" : \"outline\"}\n                size=\"sm\"\n                onClick={onToggleCanvas}\n                className=\"flex items-center gap-2 text-xs\"\n              >\n                {canvasVisible ? <Eye size={14} /> : <EyeOff size={14} />}\n                Холст\n              </Button>\n\n              <Button\n                variant={propertiesVisible ? \"default\" : \"outline\"}\n                size=\"sm\"\n                onClick={onToggleProperties}\n                className=\"flex items-center gap-2 text-xs\"\n              >\n                {propertiesVisible ? <Eye size={14} /> : <EyeOff size={14} />}\n                Свойства\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":2928},"client/src/components/editor/properties-panel.tsx":{"content":"import { Node, Button } from '@shared/schema';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Switch } from '@/components/ui/switch';\nimport { Button as UIButton } from '@/components/ui/button';\nimport { Label } from '@/components/ui/label';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';\nimport { MediaSelector } from '@/components/media/media-selector';\nimport { nanoid } from 'nanoid';\nimport { useToast } from '@/hooks/use-toast';\nimport { validateCommand, getCommandSuggestions, STANDARD_COMMANDS } from '@/lib/commands';\nimport { extractCoordinatesFromUrl, formatCoordinates, getLocationInfo } from '@/lib/map-utils';\nimport { useState, useMemo, useCallback } from 'react';\n\nimport { InlineRichEditor } from './inline-rich-editor';\nimport { EmojiPicker } from './emoji-picker';\nimport { Image, Video, Music, FileText, X, Plus } from 'lucide-react';\nimport { \n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n  DropdownMenuLabel\n} from '@/components/ui/dropdown-menu';\n\n// Переиспользуемый компонент для редактирования синонимов\ninterface SynonymEditorProps {\n  synonyms: string[];\n  onUpdate: (synonyms: string[]) => void;\n  placeholder?: string;\n  title?: string;\n  description?: string;\n}\n\nconst SynonymEditor = ({ synonyms, onUpdate, placeholder = \"Например: старт, привет, начать\", title = \"Синонимы\", description }: SynonymEditorProps) => {\n  return (\n    <div>\n      <Label className=\"text-xs font-medium text-muted-foreground\">{title}</Label>\n      {description && (\n        <div className=\"text-xs text-muted-foreground mt-1 mb-2\">\n          {description}\n        </div>\n      )}\n      <div className=\"mt-2 space-y-2\">\n        {synonyms.map((synonym, index) => (\n          <div key={index} className=\"flex items-center gap-2\">\n            <Input\n              value={synonym}\n              onChange={(e) => {\n                const newSynonyms = [...synonyms];\n                newSynonyms[index] = e.target.value;\n                onUpdate(newSynonyms);\n              }}\n              placeholder={placeholder}\n              className=\"flex-1 text-xs\"\n            />\n            <UIButton\n              onClick={() => {\n                const newSynonyms = [...synonyms];\n                newSynonyms.splice(index, 1);\n                onUpdate(newSynonyms);\n              }}\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"px-2 py-1 h-8\"\n            >\n              <i className=\"fas fa-trash text-xs\"></i>\n            </UIButton>\n          </div>\n        ))}\n        <UIButton\n          onClick={() => {\n            const newSynonyms = [...synonyms, ''];\n            onUpdate(newSynonyms);\n          }}\n          variant=\"outline\"\n          size=\"sm\"\n          className=\"w-full text-xs\"\n        >\n          <i className=\"fas fa-plus mr-2\"></i>\n          Добавить синоним\n        </UIButton>\n      </div>\n    </div>\n  );\n};\n\ninterface PropertiesPanelProps {\n  projectId: number;\n  selectedNode: Node | null;\n  allNodes?: Node[];\n  onNodeUpdate: (nodeId: string, updates: Partial<Node['data']>) => void;\n  onNodeTypeChange?: (nodeId: string, newType: Node['type'], newData: Partial<Node['data']>) => void;\n  onButtonAdd: (nodeId: string, button: Button) => void;\n  onButtonUpdate: (nodeId: string, buttonId: string, updates: Partial<Button>) => void;\n  onButtonDelete: (nodeId: string, buttonId: string) => void;\n  // Поддержка межлистовых соединений\n  allSheets?: any[];\n  currentSheetId?: string;\n}\n\nexport function PropertiesPanel({ \n  projectId,\n  selectedNode,\n  allNodes = [],\n  onNodeUpdate, \n  onNodeTypeChange,\n  onButtonAdd, \n  onButtonUpdate, \n  onButtonDelete,\n  allSheets = [],\n  currentSheetId\n}: PropertiesPanelProps) {\n  const { toast } = useToast();\n  const [commandInput, setCommandInput] = useState('');\n  const [showCommandSuggestions, setShowCommandSuggestions] = useState(false);\n  const [urlValidation, setUrlValidation] = useState<{[key: string]: { isValid: boolean; message?: string }}>({});\n\n  // Функция для получения данных по умолчанию для каждого типа узла\n  const getDefaultDataForType = (type: Node['type']) => {\n    const defaults: Record<Node['type'], any> = {\n      message: {},\n      photo: { imageUrl: '', mediaCaption: '' },\n      video: { videoUrl: '', mediaCaption: '', duration: 0 },\n      audio: { audioUrl: '', mediaCaption: '', duration: 0 },\n      document: { documentUrl: '', documentName: 'document.pdf', mediaCaption: '' },\n      sticker: { stickerUrl: '', stickerFileId: '' },\n      voice: { voiceUrl: '', duration: 0 },\n      animation: { animationUrl: '', duration: 0, width: 0, height: 0, mediaCaption: '' },\n      location: { latitude: 55.7558, longitude: 37.6176, title: 'Москва', address: 'Москва, Россия', foursquareId: '', foursquareType: '' },\n      contact: { phoneNumber: '+7 (999) 123-45-67', firstName: 'Имя', lastName: 'Фамилия', userId: 0, vcard: '' },\n      keyboard: { keyboardType: 'reply' },\n      start: { command: '/start', description: 'Запустить бота', showInMenu: true, isPrivateOnly: false, requiresAuth: false, adminOnly: false },\n      command: { command: '/custom', description: 'Новая команда', showInMenu: true, isPrivateOnly: false, requiresAuth: false, adminOnly: false },\n      pin_message: { \n        command: '/pin_message',\n        synonyms: ['закрепить', 'прикрепить', 'зафиксировать'],\n        disableNotification: false\n      },\n      unpin_message: { \n        command: '/unpin_message',\n        synonyms: ['открепить', 'отцепить', 'убрать закрепление']\n      },\n      delete_message: { \n        command: '/delete_message',\n        synonyms: ['удалить', 'стереть', 'убрать сообщение']\n      },\n      ban_user: {\n        command: '/ban_user',\n        synonyms: ['забанить', 'заблокировать', 'бан'],\n        reason: 'Нарушение правил группы',\n        untilDate: 0\n      },\n      unban_user: {\n        command: '/unban_user',\n        synonyms: ['разбанить', 'разблокировать', 'unbан']\n      },\n      mute_user: {\n        command: '/mute_user',\n        synonyms: ['замутить', 'заглушить', 'мут'],\n        reason: 'Нарушение правил группы',\n        duration: 3600,\n        canSendMessages: false,\n        canSendMediaMessages: false,\n        canSendPolls: false,\n        canSendOtherMessages: false,\n        canAddWebPagePreviews: false,\n        canChangeGroupInfo: false,\n        canInviteUsers2: false,\n        canPinMessages2: false\n      },\n      unmute_user: {\n        command: '/unmute_user',\n        synonyms: ['размутить', 'разглушить', 'анмут']\n      },\n      kick_user: {\n        command: '/kick_user',\n        synonyms: ['кикнуть', 'исключить', 'выгнать'],\n        reason: 'Нарушение правил группы'\n      },\n      promote_user: {\n        command: '/promote_user',\n        synonyms: ['повысить', 'назначить админом', 'промоут'],\n        canChangeInfo: false,\n        canDeleteMessages: true,\n        canBanUsers: false,\n        canInviteUsers: true,\n        canPinMessages: true,\n        canAddAdmins: false,\n        canRestrictMembers: false,\n        canPromoteMembers: false,\n        canManageVideoChats: false,\n        canManageTopics: false,\n        isAnonymous: false\n      },\n      demote_user: {\n        command: '/demote_user',\n        synonyms: ['понизить', 'снять с админки', 'демоут']\n      },\n      admin_rights: {\n        command: '/admin_rights',\n        description: 'Управление правами администратора',\n        synonyms: ['права админа', 'изменить права', 'админ права', 'тг права', 'права'],\n        adminUserIdSource: 'last_message',\n        adminChatIdSource: 'current_chat',\n        keyboardType: 'inline',\n        buttons: [\n          {\n            id: 'perm_change_info',\n            text: '🏷️ Изменение профиля',\n            action: 'command',\n            target: 'toggle_change_info',\n            buttonType: 'option',\n            skipDataCollection: false\n          },\n          {\n            id: 'perm_delete_messages',\n            text: '🗑️ Удаление сообщений',\n            action: 'command',\n            target: 'toggle_delete_messages',\n            buttonType: 'option',\n            skipDataCollection: false\n          },\n          {\n            id: 'perm_restrict_members',\n            text: '🚫 Блокировка участников',\n            action: 'command',\n            target: 'toggle_restrict_members',\n            buttonType: 'option',\n            skipDataCollection: false\n          },\n          {\n            id: 'perm_invite_users',\n            text: '📨 Приглашение участников',\n            action: 'command',\n            target: 'toggle_invite_users',\n            buttonType: 'option',\n            skipDataCollection: false\n          },\n          {\n            id: 'perm_pin_messages',\n            text: '📌 Закрепление сообщений',\n            action: 'command',\n            target: 'toggle_pin_messages',\n            buttonType: 'option',\n            skipDataCollection: false\n          },\n          {\n            id: 'perm_manage_video_chats',\n            text: '🎥 Управление видеочатами',\n            action: 'command',\n            target: 'toggle_manage_video_chats',\n            buttonType: 'option',\n            skipDataCollection: false\n          },\n          {\n            id: 'perm_anonymous',\n            text: '🔒 Анонимность',\n            action: 'command',\n            target: 'toggle_anonymous',\n            buttonType: 'option',\n            skipDataCollection: false\n          },\n          {\n            id: 'perm_promote_members',\n            text: '👑 Назначение администраторов',\n            action: 'command',\n            target: 'toggle_promote_members',\n            buttonType: 'option',\n            skipDataCollection: false\n          }\n        ],\n        // Права администратора согласно Telegram Bot API\n        can_manage_chat: false,\n        can_post_messages: false,\n        can_edit_messages: false,\n        can_delete_messages: true,\n        can_post_stories: false,\n        can_edit_stories: false,\n        can_delete_stories: false,\n        can_manage_video_chats: false,\n        can_restrict_members: false,\n        can_promote_members: false,\n        can_change_info: false,\n        can_invite_users: true,\n        can_pin_messages: true,\n        can_manage_topics: false,\n        is_anonymous: false\n      }\n    };\n    \n    return defaults[type] || {};\n  };\n\n  // Функция для получения всех узлов из всех листов для межлистовых соединений\n  const getAllNodesFromAllSheets = useMemo(() => {\n    const allNodesFromSheets: { node: Node; sheetId: string; sheetName: string }[] = [];\n    \n    if (allSheets && allSheets.length > 0) {\n      allSheets.forEach((sheet: any) => {\n        if (sheet.nodes) {\n          sheet.nodes.forEach((node: Node) => {\n            allNodesFromSheets.push({\n              node,\n              sheetId: sheet.id,\n              sheetName: sheet.name\n            });\n          });\n        }\n      });\n    } else {\n      // Если листы не переданы, используем только узлы текущего листа\n      allNodes.forEach((node: Node) => {\n        allNodesFromSheets.push({\n          node,\n          sheetId: currentSheetId || 'current',\n          sheetName: 'Текущий лист'\n        });\n      });\n    }\n    \n    return allNodesFromSheets;\n  }, [allSheets, allNodes, currentSheetId]);\n  const [showEmojiPicker, setShowEmojiPicker] = useState(false);\n  \n  // URL validation function\n  const validateUrl = (url: string, type: string): { isValid: boolean; message?: string } => {\n    if (!url) return { isValid: true };\n    \n    try {\n      new URL(url);\n      \n      const validImageTypes = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];\n      const validVideoTypes = ['.mp4', '.avi', '.mov', '.mkv', '.webm'];\n      const validAudioTypes = ['.mp3', '.wav', '.ogg', '.m4a', '.aac'];\n      \n      if (type === 'image' && !validImageTypes.some(ext => url.toLowerCase().includes(ext))) {\n        return { isValid: false, message: 'URL должен содержать изображение (JPG, PNG, GIF, WebP)' };\n      }\n      if (type === 'video' && !validVideoTypes.some(ext => url.toLowerCase().includes(ext))) {\n        return { isValid: false, message: 'URL должен содержать видео (MP4, AVI, MOV, MKV, WebM)' };\n      }\n      if (type === 'audio' && !validAudioTypes.some(ext => url.toLowerCase().includes(ext))) {\n        return { isValid: false, message: 'URL должен содержать аудио (MP3, WAV, OGG, M4A, AAC)' };\n      }\n      \n      return { isValid: true };\n    } catch {\n      return { isValid: false, message: 'Неверный формат URL' };\n    }\n  };\n\n  // Extract all available questions from keyboard and user-input nodes (including media variables)\n  const availableQuestions = useMemo(() => {\n    const questions: Array<{name: string, nodeId: string, nodeType: string, mediaType?: string}> = [];\n    \n    allNodes.forEach(node => {\n      \n      // From any nodes with additional input collection that have inputVariable\n      if (node.data.collectUserInput && node.data.inputVariable) {\n        questions.push({\n          name: node.data.inputVariable,\n          nodeId: node.id,\n          nodeType: node.type\n        });\n      }\n\n      // From nodes with photo input\n      if (node.data.enablePhotoInput && node.data.photoInputVariable) {\n        questions.push({\n          name: node.data.photoInputVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          mediaType: 'photo'\n        });\n      }\n\n      // From nodes with video input\n      if (node.data.enableVideoInput && node.data.videoInputVariable) {\n        questions.push({\n          name: node.data.videoInputVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          mediaType: 'video'\n        });\n      }\n\n      // From nodes with audio input\n      if (node.data.enableAudioInput && node.data.audioInputVariable) {\n        questions.push({\n          name: node.data.audioInputVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          mediaType: 'audio'\n        });\n      }\n\n      // From nodes with document input\n      if (node.data.enableDocumentInput && node.data.documentInputVariable) {\n        questions.push({\n          name: node.data.documentInputVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          mediaType: 'document'\n        });\n      }\n    });\n    \n    // Remove duplicates by question name\n    const uniqueQuestions = questions.filter((question, index, self) => \n      index === self.findIndex(q => q.name === question.name)\n    );\n    \n    return uniqueQuestions;\n  }, [allNodes]);\n\n  // Extract all available variables and split into text and media\n  const { textVariables, mediaVariables } = useMemo(() => {\n    // Use Map for proper deduplication by variable name\n    const variablesMap = new Map<string, {name: string, nodeId: string, nodeType: string, description?: string, mediaType?: string}>();\n    \n    allNodes.forEach(node => {\n      \n      // From any nodes with additional input collection that have inputVariable\n      if (node.data.collectUserInput && node.data.inputVariable && !variablesMap.has(node.data.inputVariable)) {\n        variablesMap.set(node.data.inputVariable, {\n          name: node.data.inputVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          description: `Данные из узла типа ${node.type}`\n        });\n      }\n\n      // From nodes with photo input\n      if (node.data.enablePhotoInput && node.data.photoInputVariable && !variablesMap.has(node.data.photoInputVariable)) {\n        variablesMap.set(node.data.photoInputVariable, {\n          name: node.data.photoInputVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          mediaType: 'photo',\n          description: 'File ID фотографии'\n        });\n      }\n\n      // From nodes with video input\n      if (node.data.enableVideoInput && node.data.videoInputVariable && !variablesMap.has(node.data.videoInputVariable)) {\n        variablesMap.set(node.data.videoInputVariable, {\n          name: node.data.videoInputVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          mediaType: 'video',\n          description: 'File ID видео'\n        });\n      }\n\n      // From nodes with audio input\n      if (node.data.enableAudioInput && node.data.audioInputVariable && !variablesMap.has(node.data.audioInputVariable)) {\n        variablesMap.set(node.data.audioInputVariable, {\n          name: node.data.audioInputVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          mediaType: 'audio',\n          description: 'File ID аудио'\n        });\n      }\n\n      // From nodes with document input\n      if (node.data.enableDocumentInput && node.data.documentInputVariable && !variablesMap.has(node.data.documentInputVariable)) {\n        variablesMap.set(node.data.documentInputVariable, {\n          name: node.data.documentInputVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          mediaType: 'document',\n          description: 'File ID документа'\n        });\n      }\n\n      // From nodes with multi-select variable\n      if (node.data.allowMultipleSelection && node.data.multiSelectVariable && !variablesMap.has(node.data.multiSelectVariable)) {\n        variablesMap.set(node.data.multiSelectVariable, {\n          name: node.data.multiSelectVariable,\n          nodeId: node.id,\n          nodeType: node.type,\n          description: 'Множественный выбор (список)'\n        });\n      }\n\n      // From conditional messages with textInputVariable\n      if (node.data.conditionalMessages) {\n        node.data.conditionalMessages.forEach((condition: any) => {\n          if (condition.textInputVariable && !variablesMap.has(condition.textInputVariable)) {\n            variablesMap.set(condition.textInputVariable, {\n              name: condition.textInputVariable,\n              nodeId: node.id,\n              nodeType: 'conditional',\n              description: `Условный ввод: ${condition.messageText?.substring(0, 50) || 'Условное сообщение'}...`\n            });\n          }\n        });\n      }\n    });\n\n    // Add common bot variables (they have priority, so add them last to override)\n    const commonVariables = [\n      { name: 'user_name', nodeId: 'system', nodeType: 'system', description: 'Имя пользователя' },\n      { name: 'user_id', nodeId: 'system', nodeType: 'system', description: 'ID пользователя в Telegram' },\n      { name: 'chat_id', nodeId: 'system', nodeType: 'system', description: 'ID чата' },\n      { name: 'bot_name', nodeId: 'system', nodeType: 'system', description: 'Имя бота' }\n    ];\n\n    commonVariables.forEach(v => {\n      if (!variablesMap.has(v.name)) {\n        variablesMap.set(v.name, v);\n      }\n    });\n    \n    // Convert Map to Array and split into text and media variables\n    const allVariables = Array.from(variablesMap.values());\n    const text = allVariables.filter(v => !v.mediaType);\n    const media = allVariables.filter(v => v.mediaType);\n    \n    return { textVariables: text, mediaVariables: media };\n  }, [allNodes]);\n\n  // Получаем список прикрепленных медиапеременных из node.data.attachedMedia\n  const attachedMediaVariables = useMemo(() => {\n    if (!selectedNode?.data.attachedMedia || mediaVariables.length === 0) {\n      return [];\n    }\n    \n    const attachedMediaNames = selectedNode.data.attachedMedia as string[];\n    return mediaVariables.filter(v => attachedMediaNames.includes(v.name));\n  }, [selectedNode?.data.attachedMedia, mediaVariables]);\n  \n  // Обработчик добавления медиапеременной\n  const handleMediaVariableSelect = useCallback((variableName: string, mediaType: string) => {\n    if (!selectedNode) return;\n    \n    const currentAttachedMedia = (selectedNode.data.attachedMedia as string[]) || [];\n    \n    // Проверяем, не добавлена ли уже эта переменная\n    if (currentAttachedMedia.includes(variableName)) {\n      return;\n    }\n    \n    // Добавляем новую медиапеременную\n    const updatedAttachedMedia = [...currentAttachedMedia, variableName];\n    onNodeUpdate(selectedNode.id, { attachedMedia: updatedAttachedMedia });\n  }, [selectedNode, onNodeUpdate]);\n  \n  // Обработчик удаления медиапеременной\n  const handleMediaVariableRemove = useCallback((variableName: string) => {\n    if (!selectedNode) return;\n    \n    const currentAttachedMedia = (selectedNode.data.attachedMedia as string[]) || [];\n    const updatedAttachedMedia = currentAttachedMedia.filter(name => name !== variableName);\n    onNodeUpdate(selectedNode.id, { attachedMedia: updatedAttachedMedia });\n  }, [selectedNode, onNodeUpdate]);\n\n  // Function to detect conflicts between conditional message rules\n  const detectRuleConflicts = useMemo(() => {\n    if (!selectedNode?.data.conditionalMessages) return [];\n    \n    const rules = selectedNode.data.conditionalMessages || [];\n    const conflicts: Array<{\n      ruleIndex: number;\n      conflictType: string;\n      description: string;\n      severity: 'warning' | 'error';\n      suggestion: string;\n    }> = [];\n    \n    for (let i = 0; i < rules.length; i++) {\n      const rule = rules[i];\n      const ruleVariables = rule.variableNames || (rule.variableName ? [rule.variableName] : []);\n      \n      // Check for duplicate rules\n      for (let j = i + 1; j < rules.length; j++) {\n        const otherRule = rules[j];\n        const otherVariables = otherRule.variableNames || (otherRule.variableName ? [otherRule.variableName] : []);\n        \n        // Same condition type with same variables\n        if (rule.condition === otherRule.condition && \n            JSON.stringify(ruleVariables.sort()) === JSON.stringify(otherVariables.sort()) &&\n            rule.expectedValue === otherRule.expectedValue &&\n            rule.logicOperator === otherRule.logicOperator) {\n          conflicts.push({\n            ruleIndex: i,\n            conflictType: 'duplicate',\n            description: `Правило ${i + 1} дублирует правило ${j + 1}`,\n            severity: 'error',\n            suggestion: 'Удалите одно из дублирующихся правил или измените условия'\n          });\n        }\n        \n        // Contradictory rules\n        if ((rule.condition === 'user_data_exists' && otherRule.condition === 'user_data_not_exists') ||\n            (rule.condition === 'user_data_not_exists' && otherRule.condition === 'user_data_exists')) {\n          const hasCommonVariables = ruleVariables.some(v => otherVariables.includes(v));\n          if (hasCommonVariables) {\n            conflicts.push({\n              ruleIndex: i,\n              conflictType: 'contradiction',\n              description: `Правило ${i + 1} противоречит правилу ${j + 1}`,\n              severity: 'warning',\n              suggestion: 'Проверьте логику: одно правило проверяет существование переменной, другое - отсутствие'\n            });\n          }\n        }\n      }\n      \n      // Check for unreachable rules due to priority\n      const higherPriorityRules = rules.filter((r, idx) => \n        idx < i && (r.priority || 0) >= (rule.priority || 0)\n      );\n      \n      for (const higherRule of higherPriorityRules) {\n        const higherVariables = higherRule.variableNames || (higherRule.variableName ? [higherRule.variableName] : []);\n        if (higherRule.condition === 'first_time' || higherRule.condition === 'returning_user') {\n          // These conditions might make subsequent rules unreachable\n          conflicts.push({\n            ruleIndex: i,\n            conflictType: 'unreachable',\n            description: `Правило ${i + 1} может быть недостижимо из-за правила выше`,\n            severity: 'warning',\n            suggestion: 'Проверьте порядок правил и их приоритеты'\n          });\n        }\n      }\n      \n      // Check for empty variable names\n      if ((rule.condition.includes('user_data') || rule.condition.includes('equals') || rule.condition.includes('contains')) && \n          ruleVariables.length === 0) {\n        conflicts.push({\n          ruleIndex: i,\n          conflictType: 'missing_variables',\n          description: `Правило ${i + 1} не имеет указанных переменных для проверки`,\n          severity: 'error',\n          suggestion: 'Выберите хотя бы одну переменную для проверки условия'\n        });\n      }\n      \n      // Check for missing expected values\n      if ((rule.condition === 'user_data_equals' || rule.condition === 'user_data_contains') && \n          !rule.expectedValue) {\n        conflicts.push({\n          ruleIndex: i,\n          conflictType: 'missing_value',\n          description: `Правило ${i + 1} требует указания ожидаемого значения`,\n          severity: 'error',\n          suggestion: 'Укажите значение для сравнения'\n        });\n      }\n    }\n    \n    return conflicts;\n  }, [selectedNode?.data.conditionalMessages]);\n\n  // Function to auto-fix rule priorities\n  const autoFixPriorities = () => {\n    if (!selectedNode?.data.conditionalMessages) return;\n    \n    const rules = [...selectedNode.data.conditionalMessages];\n    \n    // Assign priorities based on logical order\n    rules.forEach((rule, index) => {\n      // Higher priority for more specific conditions\n      let priority = 0;\n      \n      if (rule.condition === 'first_time' || rule.condition === 'returning_user') {\n        priority = 100; // Highest priority for user type checks\n      } else if (rule.condition === 'user_data_equals') {\n        priority = 80; // High priority for exact matches\n      } else if (rule.condition === 'user_data_contains') {\n        priority = 60; // Medium priority for contains checks\n      } else if (rule.condition === 'user_data_exists') {\n        priority = 40; // Lower priority for existence checks\n      } else if (rule.condition === 'user_data_not_exists') {\n        priority = 20; // Lowest priority for non-existence checks\n      }\n      \n      // Add bonus for multiple variables (more specific)\n      const variableCount = rule.variableNames?.length || (rule.variableName ? 1 : 0);\n      priority += variableCount * 5;\n      \n      rule.priority = priority;\n    });\n    \n    // Sort by priority (highest first)\n    rules.sort((a, b) => (b.priority || 0) - (a.priority || 0));\n    \n    onNodeUpdate(selectedNode.id, { conditionalMessages: rules });\n  };\n\n  // Валидация команды\n  const commandValidation = useMemo(() => {\n    if (selectedNode && (\n      selectedNode.type === 'start' || \n      selectedNode.type === 'command' ||\n      selectedNode.type === 'pin_message' || \n      selectedNode.type === 'unpin_message' || \n      selectedNode.type === 'delete_message' ||\n      selectedNode.type === 'ban_user' || \n      selectedNode.type === 'unban_user' || \n      selectedNode.type === 'mute_user' || \n      selectedNode.type === 'unmute_user' || \n      selectedNode.type === 'kick_user' || \n      selectedNode.type === 'promote_user' || \n      selectedNode.type === 'demote_user'\n    )) {\n      const commandValue = selectedNode.data.command || getDefaultDataForType(selectedNode.type).command || '';\n      return validateCommand(commandValue);\n    }\n    return { isValid: true, errors: [] };\n  }, [selectedNode?.data.command, selectedNode?.type]);\n\n  // Автодополнение команд\n  const commandSuggestions = useMemo(() => {\n    if (commandInput.length > 0) {\n      return getCommandSuggestions(commandInput);\n    }\n    return STANDARD_COMMANDS.slice(0, 5);\n  }, [commandInput]);\n  if (!selectedNode) {\n    return (\n      <aside className=\"w-full h-full bg-background border-l border-border flex flex-col\">\n        {/* Empty State Header */}\n        <div className=\"p-4 border-b border-border\">\n          <div className=\"flex items-center space-x-3\">\n            <div className=\"w-8 h-8 bg-muted/50 rounded-lg flex items-center justify-center\">\n              <i className=\"fas fa-sliders-h text-muted-foreground text-sm\"></i>\n            </div>\n            <div>\n              <h2 className=\"text-sm font-semibold text-foreground\">Свойства</h2>\n              <p className=\"text-xs text-muted-foreground\">Выберите элемент для настройки</p>\n            </div>\n          </div>\n        </div>\n\n        {/* Empty State Content */}\n        <div className=\"flex-1 flex items-center justify-center p-8 empty-state-container\">\n          <div className=\"text-center max-w-xs\">\n            {/* Animated Icon */}\n            <div className=\"relative mx-auto mb-6 empty-state-icon\">\n              <div className=\"w-16 h-16 empty-state-icon-bg rounded-2xl flex items-center justify-center mx-auto\">\n                <i className=\"fas fa-mouse-pointer text-muted-foreground text-xl transition-all duration-300 hover:text-primary hover:scale-110\"></i>\n              </div>\n              {/* Enhanced pulse effect */}\n              <div className=\"absolute inset-0 w-16 h-16 bg-primary/10 rounded-2xl pulse-primary\"></div>\n            </div>\n\n            {/* Content */}\n            <div className=\"space-y-3 mb-6\">\n              <h3 className=\"text-sm font-medium text-foreground gradient-text\">Выберите элемент</h3>\n              <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                Нажмите на любой элемент в редакторе, чтобы увидеть его настройки здесь\n              </p>\n            </div>\n\n            {/* Enhanced Help Tips */}\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center text-xs text-muted-foreground empty-state-tip floating-tip\">\n                <div className=\"w-5 h-5 bg-gradient-to-br from-primary/20 to-primary/30 rounded-md flex items-center justify-center mr-3 flex-shrink-0 shadow-sm\">\n                  <i className=\"fas fa-lightbulb text-primary text-xs\"></i>\n                </div>\n                <span>Перетащите компоненты из левой панели</span>\n              </div>\n              <div className=\"flex items-center text-xs text-muted-foreground empty-state-tip floating-tip\">\n                <div className=\"w-5 h-5 bg-gradient-to-br from-primary/20 to-primary/30 rounded-md flex items-center justify-center mr-3 flex-shrink-0 shadow-sm\">\n                  <i className=\"fas fa-hand-pointer text-primary text-xs\"></i>\n                </div>\n                <span>Кликните по элементу для настройки</span>\n              </div>\n              <div className=\"flex items-center text-xs text-muted-foreground empty-state-tip floating-tip\">\n                <div className=\"w-5 h-5 bg-gradient-to-br from-primary/20 to-primary/30 rounded-md flex items-center justify-center mr-3 flex-shrink-0 shadow-sm\">\n                  <i className=\"fas fa-magic text-primary text-xs\"></i>\n                </div>\n                <span>Используйте предварительный просмотр для тестирования</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </aside>\n    );\n  }\n\n  const nodeTypeNames = {\n    start: '/start команда',\n    command: 'Пользовательская команда',\n    message: 'Текстовое сообщение',\n    photo: 'Фото с текстом',\n    video: 'Видео с текстом',\n    audio: 'Аудио сообщение',\n    document: 'Документ',\n    sticker: 'Стикер',\n    voice: 'Голосовое сообщение',\n    animation: 'GIF анимация',\n    location: 'Местоположение',\n    contact: 'Контакт',\n    keyboard: 'Клавиатура',\n    pin_message: 'Закрепить сообщение',\n    unpin_message: 'Открепить сообщение',\n    delete_message: 'Удалить сообщение',\n    ban_user: 'Заблокировать пользователя',\n    unban_user: 'Разблокировать пользователя',\n    mute_user: 'Ограничить пользователя',\n    unmute_user: 'Снять ограничения',\n    kick_user: 'Исключить пользователя',\n    promote_user: 'Назначить администратором',\n    demote_user: 'Снять с администратора',\n    admin_rights: 'Права администратора'\n  };\n\n  const nodeIcons = {\n    start: 'fas fa-play',\n    command: 'fas fa-terminal',\n    message: 'fas fa-comment',\n    photo: 'fas fa-image',\n    video: 'fas fa-video',\n    audio: 'fas fa-music',\n    document: 'fas fa-file-alt',\n    sticker: 'fas fa-smile',\n    voice: 'fas fa-microphone',\n    animation: 'fas fa-film',\n    location: 'fas fa-map-marker-alt',\n    contact: 'fas fa-address-book',\n    keyboard: 'fas fa-keyboard',\n    pin_message: 'fas fa-thumbtack',\n    unpin_message: 'fas fa-times',\n    delete_message: 'fas fa-trash',\n    ban_user: 'fas fa-user-slash',\n    unban_user: 'fas fa-user-check',\n    mute_user: 'fas fa-volume-mute',\n    unmute_user: 'fas fa-volume-up',\n    kick_user: 'fas fa-door-open',\n    promote_user: 'fas fa-user-shield',\n    demote_user: 'fas fa-user-minus',\n    admin_rights: 'fas fa-crown'\n  };\n\n  const nodeColors = {\n    start: 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400',\n    command: 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400',\n    message: 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400',\n    photo: 'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400',\n    video: 'bg-rose-100 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400',\n    audio: 'bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400',\n    document: 'bg-teal-100 text-teal-600 dark:bg-teal-900/30 dark:text-teal-400',\n    sticker: 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400',\n    voice: 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400',\n    animation: 'bg-pink-100 text-pink-600 dark:bg-pink-900/30 dark:text-pink-400',\n    location: 'bg-sky-100 text-sky-600 dark:bg-sky-900/30 dark:text-sky-400',\n    contact: 'bg-violet-100 text-violet-600 dark:bg-violet-900/30 dark:text-violet-400',\n    keyboard: 'bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400',\n    pin_message: 'bg-cyan-100 text-cyan-600 dark:bg-cyan-900/30 dark:text-cyan-400',\n    unpin_message: 'bg-cyan-100 text-cyan-600 dark:bg-cyan-900/30 dark:text-cyan-400',\n    delete_message: 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400',\n    ban_user: 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400',\n    unban_user: 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400',\n    mute_user: 'bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400',\n    unmute_user: 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400',\n    kick_user: 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400',\n    promote_user: 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400',\n    demote_user: 'bg-gray-100 text-gray-600 dark:bg-gray-900/30 dark:text-gray-400',\n    admin_rights: 'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400'\n  };\n\n  const handleAddButton = () => {\n    const newButton: Button = {\n      id: nanoid(),\n      text: 'Новая кнопка',\n      action: 'goto',\n      target: '',\n      buttonType: 'normal',\n      skipDataCollection: false\n    };\n    onButtonAdd(selectedNode.id, newButton);\n  };\n\n  return (\n    <aside className=\"w-full h-full bg-background border-l border-border flex flex-col\">\n      {/* Properties Header */}\n      <div className=\"p-4 border-b border-border\">\n        <div className=\"flex items-center mb-3\">\n          <div className={`w-8 h-8 rounded-lg flex items-center justify-center mr-3 ${nodeColors[selectedNode.type]}`}>\n            <i className={`${nodeIcons[selectedNode.type]} text-sm`}></i>\n          </div>\n          <div className=\"flex-1\">\n            <h2 className=\"text-sm font-semibold text-foreground\">{nodeTypeNames[selectedNode.type]}</h2>\n            <div className=\"flex items-center mt-1\">\n              <span className=\"text-xs text-muted-foreground\">ID:</span>\n              <code className=\"ml-1 px-2 py-0.5 bg-muted rounded text-xs font-mono text-muted-foreground cursor-pointer hover:bg-muted/80 transition-colors\"\n                    onClick={() => {\n                      navigator.clipboard.writeText(selectedNode.id);\n                      toast({\n                        title: \"ID скопирован!\",\n                        description: `ID \"${selectedNode.id}\" скопирован в буфер обмена`,\n                      });\n                    }}\n                    title=\"Нажмите, чтобы скопировать\">\n                {selectedNode.id}\n              </code>\n            </div>\n          </div>\n        </div>\n        <p className=\"text-xs text-muted-foreground\">Настройте параметры выбранного элемента</p>\n      </div>\n\n      {/* Properties Content */}\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-6\">\n        \n        {/* Basic Settings */}\n        <div>\n          <h3 className=\"text-sm font-medium text-foreground mb-3\">Основные настройки</h3>\n          <div className=\"space-y-4\">\n            {/* Node Type Selector */}\n            <div>\n              <Label className=\"text-xs font-medium text-muted-foreground\">Тип элемента</Label>\n              <Select\n                value={selectedNode.type}\n                onValueChange={(value) => {\n                  if (onNodeTypeChange) {\n                    // Создаем новые данные для узла в зависимости от типа\n                    const newData = getDefaultDataForType(value as Node['type']);\n                    // Сохраняем некоторые общие поля\n                    const preservedData = {\n                      messageText: selectedNode.data.messageText,\n                      keyboardType: selectedNode.data.keyboardType,\n                      buttons: selectedNode.data.buttons,\n                      markdown: selectedNode.data.markdown,\n                      oneTimeKeyboard: selectedNode.data.oneTimeKeyboard,\n                      resizeKeyboard: selectedNode.data.resizeKeyboard\n                    };\n                    \n                    // Объединяем данные\n                    const finalData = { ...newData, ...preservedData };\n                    \n                    // Вызываем функцию обновления типа\n                    onNodeTypeChange(selectedNode.id, value as Node['type'], finalData);\n                  }\n                }}\n              >\n                <SelectTrigger className=\"mt-2\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"message\">📝 Текстовое сообщение</SelectItem>\n                  <SelectItem value=\"photo\">🖼️ Фото с текстом</SelectItem>\n                  <SelectItem value=\"video\">🎬 Видео сообщение</SelectItem>\n                  <SelectItem value=\"audio\">🎵 Аудио сообщение</SelectItem>\n                  <SelectItem value=\"document\">📄 Документ</SelectItem>\n                  <SelectItem value=\"sticker\">😀 Стикер</SelectItem>\n                  <SelectItem value=\"voice\">🎤 Голосовое сообщение</SelectItem>\n                  <SelectItem value=\"animation\">🎞️ GIF анимация</SelectItem>\n                  <SelectItem value=\"location\">📍 Геолокация</SelectItem>\n                  <SelectItem value=\"contact\">📞 Контакт</SelectItem>\n                  <SelectItem value=\"keyboard\">⌨️ Клавиатура</SelectItem>\n                  <SelectItem value=\"start\">▶️ /start команда</SelectItem>\n                  <SelectItem value=\"command\">🔧 Пользовательская команда</SelectItem>\n                  <SelectItem value=\"pin_message\">📌 Закрепить сообщение</SelectItem>\n                  <SelectItem value=\"unpin_message\">📌❌ Открепить сообщение</SelectItem>\n                  <SelectItem value=\"delete_message\">🗑️ Удалить сообщение</SelectItem>\n                  <SelectItem value=\"ban_user\">🚫 Заблокировать пользователя</SelectItem>\n                  <SelectItem value=\"unban_user\">✅ Разблокировать пользователя</SelectItem>\n                  <SelectItem value=\"mute_user\">🔇 Ограничить пользователя</SelectItem>\n                  <SelectItem value=\"unmute_user\">🔊 Снять ограничения</SelectItem>\n                  <SelectItem value=\"kick_user\">👢 Исключить пользователя</SelectItem>\n                  <SelectItem value=\"promote_user\">👑 Назначить администратором</SelectItem>\n                  <SelectItem value=\"demote_user\">👤 Снять с администратора</SelectItem>\n                  <SelectItem value=\"admin_rights\">⚡ Права администратора</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            \n            {(selectedNode.type === 'start' || selectedNode.type === 'command') && (\n              <>\n                <div className=\"relative\">\n                  <Label className=\"text-xs font-medium text-muted-foreground\">Команда</Label>\n                  <div className=\"relative\">\n                    <Input\n                      value={selectedNode.data.command || getDefaultDataForType(selectedNode.type).command || ''}\n                      onChange={(e) => {\n                        onNodeUpdate(selectedNode.id, { command: e.target.value });\n                        setCommandInput(e.target.value);\n                        setShowCommandSuggestions(e.target.value.length > 0);\n                      }}\n                      onFocus={() => setShowCommandSuggestions(true)}\n                      onBlur={() => setTimeout(() => setShowCommandSuggestions(false), 200)}\n                      className={`mt-2 ${!commandValidation.isValid ? 'border-red-500' : ''}`}\n                      placeholder=\"/start\"\n                    />\n                    \n                    {/* Автодополнение команд */}\n                    {showCommandSuggestions && commandSuggestions.length > 0 && (\n                      <div className=\"absolute top-full left-0 right-0 bg-background border border-border rounded-md shadow-lg z-50 max-h-48 overflow-y-auto\">\n                        {commandSuggestions.map((suggestion, index) => (\n                          <button\n                            key={index}\n                            className=\"w-full text-left px-3 py-2 hover:bg-muted text-sm border-b border-border last:border-b-0\"\n                            onClick={() => {\n                              onNodeUpdate(selectedNode.id, { \n                                command: suggestion.command,\n                                description: suggestion.description \n                              });\n                              setShowCommandSuggestions(false);\n                            }}\n                          >\n                            <div className=\"font-medium text-foreground\">{suggestion.command}</div>\n                            <div className=\"text-xs text-muted-foreground\">{suggestion.description}</div>\n                          </button>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                  \n                  {/* Ошибки валидации */}\n                  {!commandValidation.isValid && commandValidation.errors.length > 0 && (\n                    <div className=\"mt-1 space-y-1\">\n                      {commandValidation.errors.map((error, index) => (\n                        <div key={index} className=\"flex items-center text-xs text-red-600\">\n                          <i className=\"fas fa-exclamation-circle mr-1\"></i>\n                          {error}\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n                \n                <div>\n                  <Label className=\"text-xs font-medium text-muted-foreground\">Описание</Label>\n                  <Input\n                    value={selectedNode.data.description || getDefaultDataForType(selectedNode.type).description || ''}\n                    onChange={(e) => onNodeUpdate(selectedNode.id, { description: e.target.value })}\n                    placeholder=\"Описание команды\"\n                    className=\"text-xs\"\n                  />\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    Используется для меню команд в @BotFather\n                  </div>\n                </div>\n                \n                {/* Синонимы команд */}\n                <SynonymEditor\n                  synonyms={selectedNode.data.synonyms || []}\n                  onUpdate={(synonyms) => onNodeUpdate(selectedNode.id, { synonyms })}\n                  title=\"Синонимы команды\"\n                  description=\"Текстовые сообщения, которые будут вызывать эту команду. Например: старт вместо /start\"\n                  placeholder=\"Например: старт, привет, начать\"\n                />\n              </>\n            )}\n\n            {/* Command for Content Management and User Management */}\n            {(selectedNode.type === 'pin_message' || selectedNode.type === 'unpin_message' || selectedNode.type === 'delete_message' ||\n              selectedNode.type === 'ban_user' || selectedNode.type === 'unban_user' || selectedNode.type === 'mute_user' || \n              selectedNode.type === 'unmute_user' || selectedNode.type === 'kick_user' || selectedNode.type === 'promote_user' || \n              selectedNode.type === 'demote_user' || selectedNode.type === 'admin_rights') && (\n              <div>\n                <Label className=\"text-xs font-medium text-muted-foreground\">Команда</Label>\n                <Input\n                  value={selectedNode.data.command || getDefaultDataForType(selectedNode.type).command || ''}\n                  onChange={(e) => onNodeUpdate(selectedNode.id, { command: e.target.value })}\n                  className=\"mt-2\"\n                  placeholder={\n                    selectedNode.type === 'pin_message' ? '/pin_message' :\n                    selectedNode.type === 'unpin_message' ? '/unpin_message' :\n                    selectedNode.type === 'delete_message' ? '/delete_message' :\n                    selectedNode.type === 'ban_user' ? '/ban_user' :\n                    selectedNode.type === 'unban_user' ? '/unban_user' :\n                    selectedNode.type === 'mute_user' ? '/mute_user' :\n                    selectedNode.type === 'unmute_user' ? '/unmute_user' :\n                    selectedNode.type === 'kick_user' ? '/kick_user' :\n                    selectedNode.type === 'promote_user' ? '/promote_user' :\n                    selectedNode.type === 'demote_user' ? '/demote_user' :\n                    selectedNode.type === 'admin_rights' ? '/admin_rights' : '/command'\n                  }\n                />\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  Основная команда для вызова этого действия\n                </div>\n              </div>\n            )}\n\n            {/* Enhanced Media Settings */}\n            {selectedNode.type === 'photo' && (\n              <div className=\"space-y-6\">\n                {/* Media URL Section */}\n                <div className=\"bg-gradient-to-br from-blue-50/50 to-indigo-50/30 dark:from-blue-950/20 dark:to-indigo-950/10 border border-blue-200/30 dark:border-blue-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-image text-blue-600 dark:text-blue-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-blue-900 dark:text-blue-100\">Источник изображения</Label>\n                  </div>\n                  \n                  <MediaSelector\n                    projectId={projectId}\n                    value={selectedNode.data.imageUrl || ''}\n                    onChange={(url) => onNodeUpdate(selectedNode.id, { imageUrl: url })}\n                    fileType=\"photo\"\n                    placeholder=\"https://example.com/beautiful-image.jpg\"\n                    label=\"Источник изображения\"\n                  />\n                  \n                  <div className=\"flex items-center space-x-2 text-xs text-blue-600 dark:text-blue-400 mt-3\">\n                    <i className=\"fas fa-check-circle\"></i>\n                    <span>JPG, PNG, GIF, WebP • Макс. 20MB</span>\n                  </div>\n                </div>\n\n                {/* Caption Section */}\n                <div className=\"bg-gradient-to-br from-green-50/50 to-emerald-50/30 dark:from-green-950/20 dark:to-emerald-950/10 border border-green-200/30 dark:border-green-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-comment-alt text-green-600 dark:text-green-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-green-900 dark:text-green-100\">Подпись к изображению</Label>\n                  </div>\n                  \n                  <Textarea\n                    value={selectedNode.data.mediaCaption || ''}\n                    onChange={(e) => onNodeUpdate(selectedNode.id, { mediaCaption: e.target.value })}\n                    className=\"resize-none border-green-200 dark:border-green-700 focus:border-green-500 focus:ring-green-200 transition-all duration-200\"\n                    rows={3}\n                    placeholder=\"Опишите изображение для пользователей...\"\n                  />\n                  \n                  <div className=\"flex items-center space-x-2 text-xs text-green-600 dark:text-green-400 mt-2\">\n                    <i className=\"fas fa-info-circle\"></i>\n                    <span>Если не указана, будет использоваться основной текст сообщения</span>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {selectedNode.type === 'video' && (\n              <div className=\"space-y-6\">\n                {/* Video URL Section */}\n                <div className=\"bg-gradient-to-br from-purple-50/50 to-violet-50/30 dark:from-purple-950/20 dark:to-violet-950/10 border border-purple-200/30 dark:border-purple-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-video text-purple-600 dark:text-purple-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-purple-900 dark:text-purple-100\">Источник видео</Label>\n                  </div>\n                  \n                  <div className=\"space-y-3\">\n                    <MediaSelector\n                      projectId={projectId}\n                      value={selectedNode.data.videoUrl || ''}\n                      onChange={(url) => onNodeUpdate(selectedNode.id, { videoUrl: url })}\n                      fileType=\"video\"\n                      placeholder=\"https://example.com/awesome-video.mp4\"\n                      label=\"Источник видео\"\n                    />\n                    \n                    <div className=\"flex items-center space-x-2 text-xs text-purple-600 dark:text-purple-400 mt-3\">\n                      <i className=\"fas fa-check-circle\"></i>\n                      <span>MP4, AVI, MOV, WebM • Макс. 50MB</span>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Caption Section */}\n                <div className=\"bg-gradient-to-br from-green-50/50 to-emerald-50/30 dark:from-green-950/20 dark:to-emerald-950/10 border border-green-200/30 dark:border-green-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-comment-alt text-green-600 dark:text-green-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-green-900 dark:text-green-100\">Подпись к видео</Label>\n                  </div>\n                  \n                  <Textarea\n                    value={selectedNode.data.mediaCaption || ''}\n                    onChange={(e) => onNodeUpdate(selectedNode.id, { mediaCaption: e.target.value })}\n                    className=\"resize-none border-green-200 dark:border-green-700 focus:border-green-500 focus:ring-green-200 transition-all duration-200\"\n                    rows={3}\n                    placeholder=\"Опишите видеоконтент для пользователей...\"\n                  />\n                </div>\n\n                {/* Metadata Section */}\n                <div className=\"bg-gradient-to-br from-orange-50/50 to-amber-50/30 dark:from-orange-950/20 dark:to-amber-950/10 border border-orange-200/30 dark:border-orange-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-orange-100 dark:bg-orange-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-info-circle text-orange-600 dark:text-orange-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-orange-900 dark:text-orange-100\">Метаданные видео</Label>\n                  </div>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        <i className=\"fas fa-clock mr-1\"></i>\n                        Длительность (сек)\n                      </Label>\n                      <Input\n                        type=\"number\"\n                        value={selectedNode.data.muteDuration || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { muteDuration: parseInt(e.target.value) || 0 })}\n                        className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                        placeholder=\"120\"\n                        min=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        <i className=\"fas fa-hdd mr-1\"></i>\n                        Размер (МБ)\n                      </Label>\n                      <Input\n                        type=\"number\"\n                        value={selectedNode.data.fileSize || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { fileSize: parseInt(e.target.value) || 0 })}\n                        className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                        placeholder=\"25\"\n                        min=\"0\"\n                        max=\"50\"\n                      />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {selectedNode.type === 'audio' && (\n              <div className=\"space-y-6\">\n                {/* Audio URL Section */}\n                <div className=\"bg-gradient-to-br from-rose-50/50 to-pink-50/30 dark:from-rose-950/20 dark:to-pink-950/10 border border-rose-200/30 dark:border-rose-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-rose-100 dark:bg-rose-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-music text-rose-600 dark:text-rose-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-rose-900 dark:text-rose-100\">Источник аудио</Label>\n                  </div>\n                  \n                  <div className=\"space-y-3\">\n                    <MediaSelector\n                      projectId={projectId}\n                      value={selectedNode.data.audioUrl || ''}\n                      onChange={(url) => onNodeUpdate(selectedNode.id, { audioUrl: url })}\n                      fileType=\"audio\"\n                      placeholder=\"https://example.com/beautiful-music.mp3\"\n                      label=\"Источник аудио\"\n                    />\n                    \n                    <div className=\"flex items-center space-x-2 text-xs text-rose-600 dark:text-rose-400 mt-3\">\n                      <i className=\"fas fa-check-circle\"></i>\n                      <span>MP3, WAV, OGG, AAC • Макс. 50MB</span>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Caption Section */}\n                <div className=\"bg-gradient-to-br from-green-50/50 to-emerald-50/30 dark:from-green-950/20 dark:to-emerald-950/10 border border-green-200/30 dark:border-green-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-comment-alt text-green-600 dark:text-green-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-green-900 dark:text-green-100\">Подпись к аудио</Label>\n                  </div>\n                  \n                  <Textarea\n                    value={selectedNode.data.mediaCaption || ''}\n                    onChange={(e) => onNodeUpdate(selectedNode.id, { mediaCaption: e.target.value })}\n                    className=\"resize-none border-green-200 dark:border-green-700 focus:border-green-500 focus:ring-green-200 transition-all duration-200\"\n                    rows={3}\n                    placeholder=\"Опишите аудиоконтент для пользователей...\"\n                  />\n                </div>\n\n                {/* Audio Metadata Section */}\n                <div className=\"bg-gradient-to-br from-cyan-50/50 to-sky-50/30 dark:from-cyan-950/20 dark:to-sky-950/10 border border-cyan-200/30 dark:border-cyan-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-cyan-100 dark:bg-cyan-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-compact-disc text-cyan-600 dark:text-cyan-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-cyan-900 dark:text-cyan-100\">Метаданные трека</Label>\n                  </div>\n                  \n                  <div className=\"space-y-4\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label className=\"text-xs font-medium text-cyan-700 dark:text-cyan-300 mb-2 block\">\n                          <i className=\"fas fa-clock mr-1\"></i>\n                          Длительность (сек)\n                        </Label>\n                        <Input\n                          type=\"number\"\n                          value={selectedNode.data.muteDuration || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { muteDuration: parseInt(e.target.value) || 0 })}\n                          className=\"border-cyan-200 dark:border-cyan-700 focus:border-cyan-500 focus:ring-cyan-200\"\n                          placeholder=\"180\"\n                          min=\"0\"\n                        />\n                      </div>\n                      <div>\n                        <Label className=\"text-xs font-medium text-cyan-700 dark:text-cyan-300 mb-2 block\">\n                          <i className=\"fas fa-user mr-1\"></i>\n                          Исполнитель\n                        </Label>\n                        <Input\n                          value={selectedNode.data.performer || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { performer: e.target.value })}\n                          className=\"border-cyan-200 dark:border-cyan-700 focus:border-cyan-500 focus:ring-cyan-200\"\n                          placeholder=\"Имя артиста\"\n                        />\n                      </div>\n                    </div>\n                    \n                    <div>\n                      <Label className=\"text-xs font-medium text-cyan-700 dark:text-cyan-300 mb-2 block\">\n                        <i className=\"fas fa-heading mr-1\"></i>\n                        Название трека\n                      </Label>\n                      <Input\n                        value={selectedNode.data.title || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { title: e.target.value })}\n                        className=\"border-cyan-200 dark:border-cyan-700 focus:border-cyan-500 focus:ring-cyan-200\"\n                        placeholder=\"Название композиции\"\n                      />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {selectedNode.type === 'document' && (\n              <div className=\"space-y-6\">\n                {/* Document URL Section */}\n                <div className=\"bg-gradient-to-br from-teal-50/50 to-cyan-50/30 dark:from-teal-950/20 dark:to-cyan-950/10 border border-teal-200/30 dark:border-teal-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-file-alt text-teal-600 dark:text-teal-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-teal-900 dark:text-teal-100\">Источник документа</Label>\n                  </div>\n                  \n                  <div className=\"space-y-3\">\n                    <MediaSelector\n                      projectId={projectId}\n                      value={selectedNode.data.documentUrl || ''}\n                      onChange={(url) => onNodeUpdate(selectedNode.id, { documentUrl: url })}\n                      fileType=\"document\"\n                      placeholder=\"https://example.com/important-document.pdf\"\n                      label=\"Источник документа\"\n                    />\n                    \n                    <div className=\"flex items-center space-x-2 text-xs text-teal-600 dark:text-teal-400 mt-3\">\n                      <i className=\"fas fa-check-circle\"></i>\n                      <span>Любые файлы • Макс. 50MB</span>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Caption Section */}\n                <div className=\"bg-gradient-to-br from-green-50/50 to-emerald-50/30 dark:from-green-950/20 dark:to-emerald-950/10 border border-green-200/30 dark:border-green-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-comment-alt text-green-600 dark:text-green-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-green-900 dark:text-green-100\">Подпись к документу</Label>\n                  </div>\n                  \n                  <Textarea\n                    value={selectedNode.data.mediaCaption || ''}\n                    onChange={(e) => onNodeUpdate(selectedNode.id, { mediaCaption: e.target.value })}\n                    className=\"resize-none border-green-200 dark:border-green-700 focus:border-green-500 focus:ring-green-200 transition-all duration-200\"\n                    rows={3}\n                    placeholder=\"Опишите документ для пользователей...\"\n                  />\n                </div>\n\n                {/* Document Details Section */}\n                <div className=\"bg-gradient-to-br from-slate-50/50 to-gray-50/30 dark:from-slate-950/20 dark:to-gray-950/10 border border-slate-200/30 dark:border-slate-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-tags text-slate-600 dark:text-slate-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-slate-900 dark:text-slate-100\">Метаданные документа</Label>\n                  </div>\n                  \n                  <div className=\"space-y-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-2 block\">\n                        <i className=\"fas fa-file-signature mr-1\"></i>\n                        Имя файла\n                      </Label>\n                      <Input\n                        value={selectedNode.data.documentName || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { documentName: e.target.value })}\n                        className=\"border-slate-200 dark:border-slate-700 focus:border-slate-500 focus:ring-slate-200\"\n                        placeholder=\"important-document.pdf\"\n                      />\n                      <div className=\"text-xs text-slate-500 dark:text-slate-400 mt-1\">\n                        Имя файла с расширением, которое увидит пользователь\n                      </div>\n                    </div>\n                    \n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-2 block\">\n                          <i className=\"fas fa-hdd mr-1\"></i>\n                          Размер (МБ)\n                        </Label>\n                        <Input\n                          type=\"number\"\n                          value={selectedNode.data.fileSize || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { fileSize: parseInt(e.target.value) || 0 })}\n                          className=\"border-slate-200 dark:border-slate-700 focus:border-slate-500 focus:ring-slate-200\"\n                          placeholder=\"5\"\n                          min=\"0\"\n                          max=\"50\"\n                        />\n                      </div>\n                      <div>\n                        <Label className=\"text-xs font-medium text-slate-700 dark:text-slate-300 mb-2 block\">\n                          <i className=\"fas fa-file-code mr-1\"></i>\n                          Тип файла\n                        </Label>\n                        <Input\n                          value={selectedNode.data.mimeType || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { mimeType: e.target.value })}\n                          className=\"border-slate-200 dark:border-slate-700 focus:border-slate-500 focus:ring-slate-200\"\n                          placeholder=\"application/pdf\"\n                        />\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Sticker Configuration */}\n            {selectedNode.type === 'sticker' && (\n              <div className=\"space-y-6\">\n                {/* Sticker URL Section */}\n                <div className=\"bg-gradient-to-br from-yellow-50/50 to-orange-50/30 dark:from-yellow-950/20 dark:to-orange-950/10 border border-yellow-200/30 dark:border-yellow-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-yellow-100 dark:bg-yellow-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-smile text-yellow-600 dark:text-yellow-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-yellow-900 dark:text-yellow-100\">Настройки стикера</Label>\n                  </div>\n                  \n                  <div className=\"space-y-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-yellow-700 dark:text-yellow-300 mb-2 block\">\n                        <i className=\"fas fa-link mr-1\"></i>\n                        URL стикера или file_id\n                      </Label>\n                      <Input\n                        value={selectedNode.data.stickerUrl || selectedNode.data.stickerFileId || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { stickerUrl: e.target.value })}\n                        className=\"border-yellow-200 dark:border-yellow-700 focus:border-yellow-500 focus:ring-yellow-200\"\n                        placeholder=\"CAACAgIAAxkBAAICGGXm2KvQAAG2X8cxTmZHJkRnYwYlAAJGAANWnb0KmgiEKEZDKVQeBA\"\n                      />\n                      <div className=\"text-xs text-yellow-600 dark:text-yellow-400 mt-2\">\n                        Можно указать file_id стикера из Telegram или URL с прямой ссылкой\n                      </div>\n                    </div>\n\n                    <div>\n                      <Label className=\"text-xs font-medium text-yellow-700 dark:text-yellow-300 mb-2 block\">\n                        <i className=\"fas fa-tag mr-1\"></i>\n                        Набор стикеров\n                      </Label>\n                      <Input\n                        value={selectedNode.data.stickerSetName || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { stickerSetName: e.target.value })}\n                        className=\"border-yellow-200 dark:border-yellow-700 focus:border-yellow-500 focus:ring-yellow-200\"\n                        placeholder=\"mystickerpack_by_mybot\"\n                      />\n                      <div className=\"text-xs text-yellow-600 dark:text-yellow-400 mt-2\">\n                        Название набора стикеров (опционально)\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Voice Message Configuration */}\n            {selectedNode.type === 'voice' && (\n              <div className=\"space-y-6\">\n                {/* Voice URL Section */}\n                <div className=\"bg-gradient-to-br from-teal-50/50 to-cyan-50/30 dark:from-teal-950/20 dark:to-cyan-950/10 border border-teal-200/30 dark:border-teal-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-microphone text-teal-600 dark:text-teal-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-teal-900 dark:text-teal-100\">Источник голосового сообщения</Label>\n                  </div>\n                  \n                  <MediaSelector\n                    projectId={projectId}\n                    value={selectedNode.data.voiceUrl || ''}\n                    onChange={(url) => onNodeUpdate(selectedNode.id, { voiceUrl: url })}\n                    fileType=\"audio\"\n                    placeholder=\"https://example.com/voice-message.ogg\"\n                    label=\"Источник голосового сообщения\"\n                  />\n                  \n                  <div className=\"flex items-center space-x-2 text-xs text-teal-600 dark:text-teal-400 mt-3\">\n                    <i className=\"fas fa-check-circle\"></i>\n                    <span>OGG с OPUS кодеком • Макс. 20MB</span>\n                  </div>\n                </div>\n\n                {/* Voice Metadata Section */}\n                <div className=\"bg-gradient-to-br from-purple-50/50 to-indigo-50/30 dark:from-purple-950/20 dark:to-indigo-950/10 border border-purple-200/30 dark:border-purple-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-info-circle text-purple-600 dark:text-purple-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-purple-900 dark:text-purple-100\">Метаданные голосового сообщения</Label>\n                  </div>\n                  \n                  <div>\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                      <i className=\"fas fa-clock mr-1\"></i>\n                      Длительность (секунды)\n                    </Label>\n                    <Input\n                      type=\"number\"\n                      value={selectedNode.data.duration || ''}\n                      onChange={(e) => onNodeUpdate(selectedNode.id, { duration: parseInt(e.target.value) || 0 })}\n                      className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                      placeholder=\"30\"\n                      min=\"0\"\n                      max=\"3600\"\n                    />\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Animation (GIF) Configuration */}\n            {selectedNode.type === 'animation' && (\n              <div className=\"space-y-6\">\n                {/* Animation URL Section */}\n                <div className=\"bg-gradient-to-br from-pink-50/50 to-rose-50/30 dark:from-pink-950/20 dark:to-rose-950/10 border border-pink-200/30 dark:border-pink-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-pink-100 dark:bg-pink-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-film text-pink-600 dark:text-pink-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-pink-900 dark:text-pink-100\">Источник GIF анимации</Label>\n                  </div>\n                  \n                  <MediaSelector\n                    projectId={projectId}\n                    value={selectedNode.data.animationUrl || ''}\n                    onChange={(url) => onNodeUpdate(selectedNode.id, { animationUrl: url })}\n                    fileType=\"video\"\n                    placeholder=\"https://example.com/awesome-animation.gif\"\n                    label=\"Источник анимации\"\n                  />\n                  \n                  <div className=\"flex items-center space-x-2 text-xs text-pink-600 dark:text-pink-400 mt-3\">\n                    <i className=\"fas fa-check-circle\"></i>\n                    <span>GIF, MP4 (анимация) • Макс. 50MB</span>\n                  </div>\n                </div>\n\n                {/* Caption Section */}\n                <div className=\"bg-gradient-to-br from-green-50/50 to-emerald-50/30 dark:from-green-950/20 dark:to-emerald-950/10 border border-green-200/30 dark:border-green-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-comment-alt text-green-600 dark:text-green-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-green-900 dark:text-green-100\">Подпись к анимации</Label>\n                  </div>\n                  \n                  <Textarea\n                    value={selectedNode.data.mediaCaption || ''}\n                    onChange={(e) => onNodeUpdate(selectedNode.id, { mediaCaption: e.target.value })}\n                    className=\"resize-none border-green-200 dark:border-green-700 focus:border-green-500 focus:ring-green-200 transition-all duration-200\"\n                    rows={3}\n                    placeholder=\"Описание анимации для пользователей...\"\n                  />\n                </div>\n\n                {/* Animation Metadata Section */}\n                <div className=\"bg-gradient-to-br from-orange-50/50 to-amber-50/30 dark:from-orange-950/20 dark:to-amber-950/10 border border-orange-200/30 dark:border-orange-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-orange-100 dark:bg-orange-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-cog text-orange-600 dark:text-orange-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-orange-900 dark:text-orange-100\">Параметры анимации</Label>\n                  </div>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        <i className=\"fas fa-arrows-alt-h mr-1\"></i>\n                        Ширина (px)\n                      </Label>\n                      <Input\n                        type=\"number\"\n                        value={selectedNode.data.width || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { width: parseInt(e.target.value) || 0 })}\n                        className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                        placeholder=\"480\"\n                        min=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        <i className=\"fas fa-arrows-alt-v mr-1\"></i>\n                        Высота (px)\n                      </Label>\n                      <Input\n                        type=\"number\"\n                        value={selectedNode.data.height || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { height: parseInt(e.target.value) || 0 })}\n                        className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                        placeholder=\"320\"\n                        min=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        <i className=\"fas fa-clock mr-1\"></i>\n                        Длительность (сек)\n                      </Label>\n                      <Input\n                        type=\"number\"\n                        value={selectedNode.data.muteDuration || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { muteDuration: parseInt(e.target.value) || 0 })}\n                        className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                        placeholder=\"5\"\n                        min=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        <i className=\"fas fa-file mr-1\"></i>\n                        Название файла\n                      </Label>\n                      <Input\n                        value={selectedNode.data.fileName || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { fileName: e.target.value })}\n                        className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                        placeholder=\"animation.gif\"\n                      />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Location Configuration */}\n            {selectedNode.type === 'location' && (\n              <div className=\"space-y-6\">\n                {/* Coordinates Section */}\n                <div className=\"bg-gradient-to-br from-emerald-50/50 to-green-50/30 dark:from-emerald-950/20 dark:to-green-950/10 border border-emerald-200/30 dark:border-emerald-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-map-marker-alt text-emerald-600 dark:text-emerald-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-emerald-900 dark:text-emerald-100\">Координаты местоположения</Label>\n                  </div>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-emerald-700 dark:text-emerald-300 mb-2 block\">\n                        <i className=\"fas fa-globe mr-1\"></i>\n                        Широта\n                      </Label>\n                      <Input\n                        type=\"number\"\n                        step=\"any\"\n                        value={selectedNode.data.latitude || ''}\n                        onChange={(e) => {\n                          const lat = parseFloat(e.target.value) || 0;\n                          onNodeUpdate(selectedNode.id, { latitude: lat });\n                          \n                          // Автоматически получаем информацию о местоположении если есть обе координаты\n                          if (lat && selectedNode.data.longitude) {\n                            getLocationInfo(lat, selectedNode.data.longitude)\n                              .then(locationInfo => {\n                                if (locationInfo) {\n                                  onNodeUpdate(selectedNode.id, {\n                                    title: locationInfo.title || selectedNode.data.title || 'Местоположение',\n                                    address: locationInfo.address || selectedNode.data.address,\n                                    city: locationInfo.city || selectedNode.data.city,\n                                    country: locationInfo.country || selectedNode.data.country\n                                  });\n                                  toast({\n                                    title: \"Информация обновлена\",\n                                    description: `Автоматически определены: ${locationInfo.city || 'город'}, ${locationInfo.country || 'страна'}`\n                                  });\n                                }\n                              })\n                              .catch(console.error);\n                          }\n                        }}\n                        className=\"border-emerald-200 dark:border-emerald-700 focus:border-emerald-500 focus:ring-emerald-200\"\n                        placeholder=\"55.7558\"\n                      />\n                    </div>\n                    <div>\n                      <Label className=\"text-xs font-medium text-emerald-700 dark:text-emerald-300 mb-2 block\">\n                        <i className=\"fas fa-globe mr-1\"></i>\n                        Долгота\n                      </Label>\n                      <Input\n                        type=\"number\"\n                        step=\"any\"\n                        value={selectedNode.data.longitude || ''}\n                        onChange={(e) => {\n                          const lng = parseFloat(e.target.value) || 0;\n                          onNodeUpdate(selectedNode.id, { longitude: lng });\n                          \n                          // Автоматически получаем информацию о местоположении если есть обе координаты\n                          if (lng && selectedNode.data.latitude) {\n                            getLocationInfo(selectedNode.data.latitude, lng)\n                              .then(locationInfo => {\n                                if (locationInfo) {\n                                  onNodeUpdate(selectedNode.id, {\n                                    title: locationInfo.title || selectedNode.data.title || 'Местоположение',\n                                    address: locationInfo.address || selectedNode.data.address,\n                                    city: locationInfo.city || selectedNode.data.city,\n                                    country: locationInfo.country || selectedNode.data.country\n                                  });\n                                  toast({\n                                    title: \"Информация обновлена\",\n                                    description: `Автоматически определены: ${locationInfo.city || 'город'}, ${locationInfo.country || 'страна'}`\n                                  });\n                                }\n                              })\n                              .catch(console.error);\n                          }\n                        }}\n                        className=\"border-emerald-200 dark:border-emerald-700 focus:border-emerald-500 focus:ring-emerald-200\"\n                        placeholder=\"37.6176\"\n                      />\n                    </div>\n                  </div>\n                  \n                  <div className=\"text-xs text-emerald-600 dark:text-emerald-400 mt-2\">\n                    Основные координаты точки на карте (обязательно)\n                  </div>\n                </div>\n\n                {/* Location Details Section */}\n                <div className=\"bg-gradient-to-br from-blue-50/50 to-indigo-50/30 dark:from-blue-950/20 dark:to-indigo-950/10 border border-blue-200/30 dark:border-blue-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-info-circle text-blue-600 dark:text-blue-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-blue-900 dark:text-blue-100\">Описание местоположения</Label>\n                  </div>\n                  \n                  <div className=\"space-y-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                        <i className=\"fas fa-tag mr-1\"></i>\n                        Название места\n                      </Label>\n                      <Input\n                        value={selectedNode.data.title || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { title: e.target.value })}\n                        className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                        placeholder=\"Красная площадь\"\n                      />\n                    </div>\n                    \n                    <div>\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                        <i className=\"fas fa-map-signs mr-1\"></i>\n                        Адрес\n                      </Label>\n                      <Input\n                        value={selectedNode.data.address || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { address: e.target.value })}\n                        className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                        placeholder=\"Красная площадь, дом 1\"\n                      />\n                    </div>\n                    \n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                          <i className=\"fas fa-city mr-1\"></i>\n                          Город\n                        </Label>\n                        <Input\n                          value={selectedNode.data.city || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { city: e.target.value })}\n                          className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                          placeholder=\"Москва\"\n                        />\n                      </div>\n                      <div>\n                        <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                          <i className=\"fas fa-flag mr-1\"></i>\n                          Страна\n                        </Label>\n                        <Input\n                          value={selectedNode.data.country || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { country: e.target.value })}\n                          className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                          placeholder=\"Россия\"\n                        />\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Foursquare Integration Section */}\n                <div className=\"bg-gradient-to-br from-purple-50/50 to-violet-50/30 dark:from-purple-950/20 dark:to-violet-950/10 border border-purple-200/30 dark:border-purple-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-map text-purple-600 dark:text-purple-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-purple-900 dark:text-purple-100\">Foursquare (опционально)</Label>\n                  </div>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                        <i className=\"fas fa-hashtag mr-1\"></i>\n                        Foursquare ID\n                      </Label>\n                      <Input\n                        value={selectedNode.data.foursquareId || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { foursquareId: e.target.value })}\n                        className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                        placeholder=\"4b0588f1f964a52079c525e3\"\n                      />\n                    </div>\n                    <div>\n                      <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                        <i className=\"fas fa-layer-group mr-1\"></i>\n                        Тип места\n                      </Label>\n                      <Input\n                        value={selectedNode.data.foursquareType || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { foursquareType: e.target.value })}\n                        className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                        placeholder=\"arts_entertainment/default\"\n                      />\n                    </div>\n                  </div>\n                  \n                  <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-2\">\n                    Интеграция с Foursquare для дополнительной информации о месте\n                  </div>\n                </div>\n\n                {/* Map Services Section */}\n                <div className=\"bg-gradient-to-br from-orange-50/50 to-red-50/30 dark:from-orange-950/20 dark:to-red-950/10 border border-orange-200/30 dark:border-orange-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-orange-100 dark:bg-orange-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-route text-orange-600 dark:text-orange-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-orange-900 dark:text-orange-100\">Картографические сервисы</Label>\n                  </div>\n                  \n                  <div className=\"space-y-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        <i className=\"fas fa-layer-group mr-1\"></i>\n                        Сервис карт\n                      </Label>\n                      <select\n                        value={selectedNode.data.mapService || 'custom'}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { mapService: e.target.value as 'custom' | 'yandex' | 'google' | '2gis' })}\n                        className=\"w-full px-3 py-2 border border-orange-200 dark:border-orange-700 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm focus:border-orange-500 focus:ring-orange-200\"\n                      >\n                        <option value=\"custom\">Пользовательские координаты</option>\n                        <option value=\"yandex\">Яндекс Карты</option>\n                        <option value=\"google\">Google Maps</option>\n                        <option value=\"2gis\">2ГИС</option>\n                      </select>\n                    </div>\n\n                    {selectedNode.data.mapService === 'yandex' && (\n                      <div>\n                        <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                          <i className=\"fas fa-link mr-1\"></i>\n                          Ссылка на Яндекс Карты\n                        </Label>\n                        <Input\n                          type=\"url\"\n                          value={selectedNode.data.yandexMapUrl || ''}\n                          onChange={(e) => {\n                            const url = e.target.value;\n                            onNodeUpdate(selectedNode.id, { yandexMapUrl: url });\n                            \n                            // Автоматически извлекаем координаты из URL\n                            if (url) {\n                              const { coordinates, service } = extractCoordinatesFromUrl(url);\n                              if (coordinates) {\n                                const updates: any = {\n                                  latitude: coordinates.latitude,\n                                  longitude: coordinates.longitude,\n                                  mapService: service\n                                };\n                                \n                                onNodeUpdate(selectedNode.id, updates);\n                                \n                                // Получаем информацию о местоположении\n                                getLocationInfo(coordinates.latitude, coordinates.longitude)\n                                  .then(locationInfo => {\n                                    if (locationInfo) {\n                                      onNodeUpdate(selectedNode.id, {\n                                        title: locationInfo.title || selectedNode.data.title || 'Местоположение',\n                                        address: locationInfo.address || selectedNode.data.address,\n                                        city: locationInfo.city || selectedNode.data.city,\n                                        country: locationInfo.country || selectedNode.data.country\n                                      });\n                                      toast({\n                                        title: \"Координаты обновлены\",\n                                        description: `Из Яндекс.Карт: ${locationInfo.city || 'город'}, ${locationInfo.country || 'страна'}`\n                                      });\n                                    }\n                                  })\n                                  .catch(console.error);\n                              }\n                            }\n                          }}\n                          className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                          placeholder=\"https://yandex.ru/maps/...\"\n                        />\n                        <p className=\"text-xs text-orange-600 dark:text-orange-400 mt-1\">\n                          Скопируйте ссылку из Яндекс.Карт - координаты извлекутся автоматически\n                        </p>\n                        {selectedNode.data.yandexMapUrl && selectedNode.data.latitude && selectedNode.data.longitude && (\n                          <div className=\"mt-2 text-xs text-green-600 dark:text-green-400 flex items-center\">\n                            <i className=\"fas fa-check-circle mr-1\"></i>\n                            Координаты: {formatCoordinates(selectedNode.data.latitude, selectedNode.data.longitude)}\n                          </div>\n                        )}\n                      </div>\n                    )}\n\n                    {selectedNode.data.mapService === 'google' && (\n                      <div>\n                        <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                          <i className=\"fas fa-link mr-1\"></i>\n                          Ссылка на Google Maps\n                        </Label>\n                        <Input\n                          type=\"url\"\n                          value={selectedNode.data.googleMapUrl || ''}\n                          onChange={(e) => {\n                            const url = e.target.value;\n                            onNodeUpdate(selectedNode.id, { googleMapUrl: url });\n                            \n                            // Автоматически извлекаем координаты из URL\n                            if (url) {\n                              const { coordinates, service } = extractCoordinatesFromUrl(url);\n                              if (coordinates) {\n                                const updates: any = {\n                                  latitude: coordinates.latitude,\n                                  longitude: coordinates.longitude,\n                                  mapService: service\n                                };\n                                \n                                onNodeUpdate(selectedNode.id, updates);\n                                \n                                // Получаем информацию о местоположении\n                                getLocationInfo(coordinates.latitude, coordinates.longitude)\n                                  .then(locationInfo => {\n                                    if (locationInfo) {\n                                      onNodeUpdate(selectedNode.id, {\n                                        title: locationInfo.title || selectedNode.data.title || 'Местоположение',\n                                        address: locationInfo.address || selectedNode.data.address,\n                                        city: locationInfo.city || selectedNode.data.city,\n                                        country: locationInfo.country || selectedNode.data.country\n                                      });\n                                      toast({\n                                        title: \"Координаты обновлены\",\n                                        description: `Из Google Maps: ${locationInfo.city || 'город'}, ${locationInfo.country || 'страна'}`\n                                      });\n                                    }\n                                  })\n                                  .catch(console.error);\n                              }\n                            }\n                          }}\n                          className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                          placeholder=\"https://maps.google.com/...\"\n                        />\n                        <p className=\"text-xs text-orange-600 dark:text-orange-400 mt-1\">\n                          Скопируйте ссылку из Google Maps - координаты извлекутся автоматически\n                        </p>\n                        {selectedNode.data.googleMapUrl && selectedNode.data.latitude && selectedNode.data.longitude && (\n                          <div className=\"mt-2 text-xs text-green-600 dark:text-green-400 flex items-center\">\n                            <i className=\"fas fa-check-circle mr-1\"></i>\n                            Координаты: {formatCoordinates(selectedNode.data.latitude, selectedNode.data.longitude)}\n                          </div>\n                        )}\n                      </div>\n                    )}\n\n                    {selectedNode.data.mapService === '2gis' && (\n                      <div>\n                        <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                          <i className=\"fas fa-link mr-1\"></i>\n                          Ссылка на 2ГИС\n                        </Label>\n                        <Input\n                          type=\"url\"\n                          value={selectedNode.data.gisMapUrl || ''}\n                          onChange={(e) => {\n                            const url = e.target.value;\n                            onNodeUpdate(selectedNode.id, { gisMapUrl: url });\n                            \n                            // Автоматически извлекаем координаты из URL\n                            if (url) {\n                              const { coordinates, service } = extractCoordinatesFromUrl(url);\n                              if (coordinates) {\n                                const updates: any = {\n                                  latitude: coordinates.latitude,\n                                  longitude: coordinates.longitude,\n                                  mapService: service\n                                };\n                                \n                                onNodeUpdate(selectedNode.id, updates);\n                                \n                                // Получаем информацию о местоположении\n                                getLocationInfo(coordinates.latitude, coordinates.longitude)\n                                  .then(locationInfo => {\n                                    if (locationInfo) {\n                                      onNodeUpdate(selectedNode.id, {\n                                        title: locationInfo.title || selectedNode.data.title || 'Местоположение',\n                                        address: locationInfo.address || selectedNode.data.address,\n                                        city: locationInfo.city || selectedNode.data.city,\n                                        country: locationInfo.country || selectedNode.data.country\n                                      });\n                                      toast({\n                                        title: \"Координаты обновлены\",\n                                        description: `Из 2ГИС: ${locationInfo.city || 'город'}, ${locationInfo.country || 'страна'}`\n                                      });\n                                    }\n                                  })\n                                  .catch(console.error);\n                              }\n                            }\n                          }}\n                          className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                          placeholder=\"https://2gis.ru/...\"\n                        />\n                        <p className=\"text-xs text-orange-600 dark:text-orange-400 mt-1\">\n                          Скопируйте ссылку из 2ГИС - координаты извлекутся автоматически\n                        </p>\n                        {selectedNode.data.gisMapUrl && selectedNode.data.latitude && selectedNode.data.longitude && (\n                          <div className=\"mt-2 text-xs text-green-600 dark:text-green-400 flex items-center\">\n                            <i className=\"fas fa-check-circle mr-1\"></i>\n                            Координаты: {formatCoordinates(selectedNode.data.latitude, selectedNode.data.longitude)}\n                          </div>\n                        )}\n                      </div>\n                    )}\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                          <i className=\"fas fa-search-plus mr-1\"></i>\n                          Масштаб карты\n                        </Label>\n                        <Input\n                          type=\"number\"\n                          min=\"1\"\n                          max=\"20\"\n                          value={selectedNode.data.mapZoom || 15}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { mapZoom: parseInt(e.target.value) || 15 })}\n                          className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                          placeholder=\"15\"\n                        />\n                      </div>\n                      <div className=\"flex flex-col justify-end\">\n                        <div className=\"flex items-center space-x-2\">\n                          <input\n                            type=\"checkbox\"\n                            id=\"showDirections\"\n                            checked={selectedNode.data.showDirections || false}\n                            onChange={(e) => onNodeUpdate(selectedNode.id, { showDirections: e.target.checked })}\n                            className=\"w-4 h-4 text-orange-600 bg-gray-100 border-gray-300 rounded focus:ring-orange-500 dark:focus:ring-orange-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600\"\n                          />\n                          <Label htmlFor=\"showDirections\" className=\"text-xs font-medium text-orange-700 dark:text-orange-300\">\n                            Показать маршрут\n                          </Label>\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"flex items-center space-x-2\">\n                      <input\n                        type=\"checkbox\"\n                        id=\"generateMapPreview\"\n                        checked={selectedNode.data.generateMapPreview !== false}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { generateMapPreview: e.target.checked })}\n                        className=\"w-4 h-4 text-orange-600 bg-gray-100 border-gray-300 rounded focus:ring-orange-500 dark:focus:ring-orange-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600\"\n                      />\n                      <Label htmlFor=\"generateMapPreview\" className=\"text-xs font-medium text-orange-700 dark:text-orange-300\">\n                        Генерировать превью карты с кнопками сервисов\n                      </Label>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Contact Configuration */}\n            {selectedNode.type === 'contact' && (\n              <div className=\"space-y-6\">\n                {/* Contact Info Section */}\n                <div className=\"bg-gradient-to-br from-cyan-50/50 to-blue-50/30 dark:from-cyan-950/20 dark:to-blue-950/10 border border-cyan-200/30 dark:border-cyan-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-cyan-100 dark:bg-cyan-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-address-book text-cyan-600 dark:text-cyan-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-cyan-900 dark:text-cyan-100\">Контактная информация</Label>\n                  </div>\n                  \n                  <div className=\"space-y-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-cyan-700 dark:text-cyan-300 mb-2 block\">\n                        <i className=\"fas fa-phone mr-1\"></i>\n                        Номер телефона (обязательно)\n                      </Label>\n                      <Input\n                        value={selectedNode.data.phoneNumber || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { phoneNumber: e.target.value })}\n                        className=\"border-cyan-200 dark:border-cyan-700 focus:border-cyan-500 focus:ring-cyan-200\"\n                        placeholder=\"+7 (999) 123-45-67\"\n                      />\n                    </div>\n                    \n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label className=\"text-xs font-medium text-cyan-700 dark:text-cyan-300 mb-2 block\">\n                          <i className=\"fas fa-user mr-1\"></i>\n                          Имя (обязательно)\n                        </Label>\n                        <Input\n                          value={selectedNode.data.firstName || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { firstName: e.target.value })}\n                          className=\"border-cyan-200 dark:border-cyan-700 focus:border-cyan-500 focus:ring-cyan-200\"\n                          placeholder=\"Иван\"\n                        />\n                      </div>\n                      <div>\n                        <Label className=\"text-xs font-medium text-cyan-700 dark:text-cyan-300 mb-2 block\">\n                          <i className=\"fas fa-user mr-1\"></i>\n                          Фамилия\n                        </Label>\n                        <Input\n                          value={selectedNode.data.lastName || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { lastName: e.target.value })}\n                          className=\"border-cyan-200 dark:border-cyan-700 focus:border-cyan-500 focus:ring-cyan-200\"\n                          placeholder=\"Петров\"\n                        />\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Additional Contact Details Section */}\n                <div className=\"bg-gradient-to-br from-indigo-50/50 to-purple-50/30 dark:from-indigo-950/20 dark:to-purple-950/10 border border-indigo-200/30 dark:border-indigo-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-id-card text-indigo-600 dark:text-indigo-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-indigo-900 dark:text-indigo-100\">Дополнительные данные</Label>\n                  </div>\n                  \n                  <div className=\"space-y-4\">\n                    <div>\n                      <Label className=\"text-xs font-medium text-indigo-700 dark:text-indigo-300 mb-2 block\">\n                        <i className=\"fas fa-at mr-1\"></i>\n                        User ID Telegram\n                      </Label>\n                      <Input\n                        type=\"number\"\n                        value={selectedNode.data.userId || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { userId: parseInt(e.target.value) || 0 })}\n                        className=\"border-indigo-200 dark:border-indigo-700 focus:border-indigo-500 focus:ring-indigo-200\"\n                        placeholder=\"123456789\"\n                      />\n                      <div className=\"text-xs text-indigo-600 dark:text-indigo-400 mt-1\">\n                        ID пользователя в Telegram (если известен)\n                      </div>\n                    </div>\n                    \n                    <div>\n                      <Label className=\"text-xs font-medium text-indigo-700 dark:text-indigo-300 mb-2 block\">\n                        <i className=\"fas fa-address-card mr-1\"></i>\n                        vCard данные\n                      </Label>\n                      <Textarea\n                        value={selectedNode.data.vcard || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { vcard: e.target.value })}\n                        className=\"resize-none border-indigo-200 dark:border-indigo-700 focus:border-indigo-500 focus:ring-indigo-200 transition-all duration-200\"\n                        rows={4}\n                        placeholder=\"BEGIN:VCARD&#10;VERSION:3.0&#10;FN:Иван Петров&#10;TEL:+79991234567&#10;END:VCARD\"\n                      />\n                      <div className=\"text-xs text-indigo-600 dark:text-indigo-400 mt-1\">\n                        Дополнительная контактная информация в формате vCard (опционально)\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Content Management Configuration */}\n            {(selectedNode.type === 'pin_message' || selectedNode.type === 'unpin_message' || selectedNode.type === 'delete_message') && (\n              <div className=\"space-y-6\">\n                {/* Automatic Message Handling Info */}\n                <div className=\"bg-gradient-to-br from-blue-50/50 to-indigo-50/30 dark:from-blue-950/20 dark:to-indigo-950/10 border border-blue-200/30 dark:border-blue-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-reply text-blue-600 dark:text-blue-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-blue-900 dark:text-blue-100\">Автоматическое управление</Label>\n                  </div>\n                  \n                  <div className=\"bg-blue-50/50 dark:bg-blue-950/20 rounded-lg p-3 border border-blue-200/30 dark:border-blue-800/30\">\n                    <div className=\"text-xs text-blue-700 dark:text-blue-300 leading-relaxed\">\n                      <i className=\"fas fa-info-circle mr-1\"></i>\n                      Команда будет применена к сообщению, на которое отвечает пользователь. \n                      {selectedNode.type === 'pin_message' && ' Пользователь отвечает на сообщение со словом \"закрепить\" - сообщение закрепляется.'}\n                      {selectedNode.type === 'unpin_message' && ' Пользователь отвечает на сообщение со словом \"открепить\" - сообщение открепляется.'}\n                      {selectedNode.type === 'delete_message' && ' Пользователь отвечает на сообщение со словом \"удалить\" - сообщение удаляется.'}\n                    </div>\n                  </div>\n\n                  {selectedNode.type === 'pin_message' && (\n                    <div className=\"mt-4\">\n                      <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-blue-200/30 dark:border-blue-800/30 hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-200\">\n                        <div className=\"flex-1\">\n                          <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300\">\n                            <i className=\"fas fa-bell-slash mr-1\"></i>\n                            Тихое закрепление\n                          </Label>\n                          <div className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                            Закрепить без уведомления участников\n                          </div>\n                        </div>\n                        <div className=\"ml-4\">\n                          <Switch\n                            checked={selectedNode.data.disableNotification ?? false}\n                            onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { disableNotification: checked })}\n                          />\n                        </div>\n                      </div>\n                    </div>\n                  )}\n                </div>\n\n                {/* Synonyms Section for Content Management */}\n                <div className=\"bg-gradient-to-br from-green-50/50 to-emerald-50/30 dark:from-green-950/20 dark:to-emerald-950/10 border border-green-200/30 dark:border-green-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-tags text-green-600 dark:text-green-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-green-900 dark:text-green-100\">Синонимы команды</Label>\n                  </div>\n                  \n                  <SynonymEditor\n                    synonyms={(() => {\n                      if (!selectedNode.data.synonyms || selectedNode.data.synonyms.length === 0) {\n                        const defaultSynonyms = selectedNode.type === 'pin_message' ? ['закрепить', 'прикрепить', 'зафиксировать'] :\n                                                selectedNode.type === 'unpin_message' ? ['открепить', 'отцепить', 'убрать закрепление'] :\n                                                selectedNode.type === 'delete_message' ? ['удалить', 'стереть', 'убрать сообщение'] : [];\n                        if (defaultSynonyms.length > 0) {\n                          setTimeout(() => onNodeUpdate(selectedNode.id, { synonyms: defaultSynonyms }), 0);\n                          return defaultSynonyms;\n                        }\n                      }\n                      return selectedNode.data.synonyms || [];\n                    })()} \n                    onUpdate={(synonyms) => onNodeUpdate(selectedNode.id, { synonyms })}\n                    title=\"Альтернативные команды\"\n                    description={\n                      selectedNode.type === 'pin_message' ? \"Команды для закрепления сообщения\" :\n                      selectedNode.type === 'unpin_message' ? \"Команды для открепления сообщения\" :\n                      selectedNode.type === 'delete_message' ? \"Команды для удаления сообщения\" : \n                      \"Альтернативные команды для этого действия\"\n                    }\n                    placeholder={\n                      selectedNode.type === 'pin_message' ? \"закрепить, прикрепить, зафиксировать\" :\n                      selectedNode.type === 'unpin_message' ? \"открепить, отцепить, убрать\" :\n                      selectedNode.type === 'delete_message' ? \"удалить, стереть, убрать\" : \n                      \"команда1, команда2, команда3\"\n                    }\n                  />\n                </div>\n              </div>\n            )}\n\n            {/* User Management Configuration */}\n            {(selectedNode.type === 'ban_user' || selectedNode.type === 'unban_user' || selectedNode.type === 'mute_user' || \n              selectedNode.type === 'unmute_user' || selectedNode.type === 'kick_user' || selectedNode.type === 'promote_user' || \n              selectedNode.type === 'demote_user' || selectedNode.type === 'admin_rights') && (\n              <div className=\"space-y-6\">\n\n                {/* Reason Section (for ban, mute, kick) */}\n                {(selectedNode.type === 'ban_user' || selectedNode.type === 'mute_user' || selectedNode.type === 'kick_user') && (\n                  <div className=\"bg-gradient-to-br from-orange-50/50 to-yellow-50/30 dark:from-orange-950/20 dark:to-yellow-950/10 border border-orange-200/30 dark:border-orange-800/30 rounded-lg p-4\">\n                    <div className=\"flex items-center space-x-2 mb-3\">\n                      <div className=\"w-6 h-6 rounded-full bg-orange-100 dark:bg-orange-900/50 flex items-center justify-center\">\n                        <i className=\"fas fa-clipboard text-orange-600 dark:text-orange-400 text-xs\"></i>\n                      </div>\n                      <Label className=\"text-sm font-semibold text-orange-900 dark:text-orange-100\">Причина действия</Label>\n                    </div>\n                    \n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        <i className=\"fas fa-comment mr-1\"></i>\n                        Причина\n                      </Label>\n                      <Input\n                        value={selectedNode.data.reason || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { reason: e.target.value })}\n                        className=\"border-orange-200 dark:border-orange-700 focus:border-orange-500 focus:ring-orange-200\"\n                        placeholder=\"Нарушение правил группы\"\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {/* Ban Duration Section (for ban_user) */}\n                {selectedNode.type === 'ban_user' && (\n                  <div className=\"bg-gradient-to-br from-purple-50/50 to-indigo-50/30 dark:from-purple-950/20 dark:to-indigo-950/10 border border-purple-200/30 dark:border-purple-800/30 rounded-lg p-4\">\n                    <div className=\"flex items-center space-x-2 mb-3\">\n                      <div className=\"w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center\">\n                        <i className=\"fas fa-clock text-purple-600 dark:text-purple-400 text-xs\"></i>\n                      </div>\n                      <Label className=\"text-sm font-semibold text-purple-900 dark:text-purple-100\">Длительность бана</Label>\n                    </div>\n                    \n                    <div>\n                      <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                        <i className=\"fas fa-calendar mr-1\"></i>\n                        Дата окончания (Unix timestamp)\n                      </Label>\n                      <Input\n                        type=\"number\"\n                        value={selectedNode.data.untilDate || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { untilDate: parseInt(e.target.value) || 0 })}\n                        className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                        placeholder=\"0 (навсегда)\"\n                      />\n                      <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                        0 = постоянный бан, или Unix timestamp даты окончания\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* Mute Settings Section (for mute_user) */}\n                {selectedNode.type === 'mute_user' && (\n                  <div className=\"space-y-6\">\n                    {/* Duration */}\n                    <div className=\"bg-gradient-to-br from-indigo-50/50 to-purple-50/30 dark:from-indigo-950/20 dark:to-purple-950/10 border border-indigo-200/30 dark:border-indigo-800/30 rounded-lg p-4\">\n                      <div className=\"flex items-center space-x-2 mb-3\">\n                        <div className=\"w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center\">\n                          <i className=\"fas fa-hourglass text-indigo-600 dark:text-indigo-400 text-xs\"></i>\n                        </div>\n                        <Label className=\"text-sm font-semibold text-indigo-900 dark:text-indigo-100\">Длительность</Label>\n                      </div>\n                      \n                      <div>\n                        <Label className=\"text-xs font-medium text-indigo-700 dark:text-indigo-300 mb-2 block\">\n                          <i className=\"fas fa-timer mr-1\"></i>\n                          Длительность (секунды)\n                        </Label>\n                        <Input\n                          type=\"number\"\n                          value={selectedNode.data.muteDuration || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { muteDuration: parseInt(e.target.value) || 3600 })}\n                          className=\"border-indigo-200 dark:border-indigo-700 focus:border-indigo-500 focus:ring-indigo-200\"\n                          placeholder=\"3600\"\n                        />\n                        <div className=\"text-xs text-indigo-600 dark:text-indigo-400 mt-1\">\n                          Количество секунд (3600 = 1 час)\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Permissions */}\n                    <div className=\"bg-gradient-to-br from-slate-50/50 to-gray-50/30 dark:from-slate-950/20 dark:to-gray-950/10 border border-slate-200/30 dark:border-slate-800/30 rounded-lg p-4\">\n                      <div className=\"flex items-center space-x-2 mb-3\">\n                        <div className=\"w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-900/50 flex items-center justify-center\">\n                          <i className=\"fas fa-ban text-slate-600 dark:text-slate-400 text-xs\"></i>\n                        </div>\n                        <Label className=\"text-sm font-semibold text-slate-900 dark:text-slate-100\">Ограничения</Label>\n                      </div>\n                      \n                      <div className=\"grid grid-cols-1 gap-3\">\n                        {[\n                          { key: 'canSendMessages', label: 'Отправлять сообщения', icon: 'fas fa-comment' },\n                          { key: 'canSendMediaMessages', label: 'Отправлять медиа', icon: 'fas fa-image' },\n                          { key: 'canSendPolls', label: 'Создавать опросы', icon: 'fas fa-poll' },\n                          { key: 'canSendOtherMessages', label: 'Отправлять стикеры/GIF', icon: 'fas fa-laugh' },\n                          { key: 'canAddWebPagePreviews', label: 'Добавлять превью ссылок', icon: 'fas fa-link' },\n                          { key: 'canChangeGroupInfo', label: 'Изменять информацию группы', icon: 'fas fa-edit' },\n                          { key: 'canInviteUsers2', label: 'Приглашать пользователей', icon: 'fas fa-user-plus' },\n                          { key: 'canPinMessages2', label: 'Закреплять сообщения', icon: 'fas fa-thumbtack' }\n                        ].map(({ key, label, icon }) => (\n                          <div key={key} className=\"flex items-center justify-between p-2 rounded-lg bg-card/50 border border-slate-200/30 dark:border-slate-800/30\">\n                            <div className=\"flex items-center space-x-2\">\n                              <i className={`${icon} text-slate-600 dark:text-slate-400 text-xs`}></i>\n                              <Label className=\"text-xs text-slate-700 dark:text-slate-300\">{label}</Label>\n                            </div>\n                            <Switch\n                              checked={(selectedNode.data as any)[key] ?? false}\n                              onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { [key]: checked } as any)}\n                            />\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* Promote Settings Section (for promote_user) */}\n                {selectedNode.type === 'promote_user' && (\n                  <div className=\"bg-gradient-to-br from-yellow-50/50 to-amber-50/30 dark:from-yellow-950/20 dark:to-amber-950/10 border border-yellow-200/30 dark:border-yellow-800/30 rounded-lg p-4\">\n                    <div className=\"flex items-center space-x-2 mb-3\">\n                      <div className=\"w-6 h-6 rounded-full bg-yellow-100 dark:bg-yellow-900/50 flex items-center justify-center\">\n                        <i className=\"fas fa-crown text-yellow-600 dark:text-yellow-400 text-xs\"></i>\n                      </div>\n                      <Label className=\"text-sm font-semibold text-yellow-900 dark:text-yellow-100\">Права администратора</Label>\n                    </div>\n                    \n                    <div className=\"grid grid-cols-1 gap-3\">\n                      {[\n                        { key: 'canChangeInfo', label: 'Изменять информацию группы', icon: 'fas fa-edit' },\n                        { key: 'canDeleteMessages', label: 'Удалять сообщения', icon: 'fas fa-trash' },\n                        { key: 'canBanUsers', label: 'Блокировать пользователей', icon: 'fas fa-ban' },\n                        { key: 'canInviteUsers', label: 'Приглашать пользователей', icon: 'fas fa-user-plus' },\n                        { key: 'canPinMessages', label: 'Закреплять сообщения', icon: 'fas fa-thumbtack' },\n                        { key: 'canAddAdmins', label: 'Добавлять администраторов', icon: 'fas fa-user-shield' },\n                        { key: 'canRestrictMembers', label: 'Ограничивать участников', icon: 'fas fa-user-lock' },\n                        { key: 'canPromoteMembers', label: 'Повышать участников', icon: 'fas fa-arrow-up' },\n                        { key: 'canManageVideoChats', label: 'Управлять видеозвонками', icon: 'fas fa-video' },\n                        // { key: 'canManageTopics', label: 'Управлять темами', icon: 'fas fa-tags' }, // Архивировано - не используется в обычных группах\n                        { key: 'isAnonymous', label: 'Анонимный админ', icon: 'fas fa-user-secret' }\n                      ].map(({ key, label, icon }) => (\n                        <div key={key} className=\"flex items-center justify-between p-2 rounded-lg bg-card/50 border border-yellow-200/30 dark:border-yellow-800/30\">\n                          <div className=\"flex items-center space-x-2\">\n                            <i className={`${icon} text-yellow-600 dark:text-yellow-400 text-xs`}></i>\n                            <Label className=\"text-xs text-yellow-700 dark:text-yellow-300\">{label}</Label>\n                          </div>\n                          <Switch\n                            checked={(selectedNode.data as any)[key] ?? (key === 'canDeleteMessages' || key === 'canInviteUsers' || key === 'canPinMessages' ? true : false)}\n                            onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { [key]: checked } as any)}\n                          />\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* Synonyms Section for User Management */}\n                <div className=\"bg-gradient-to-br from-green-50/50 to-emerald-50/30 dark:from-green-950/20 dark:to-emerald-950/10 border border-green-200/30 dark:border-green-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-tags text-green-600 dark:text-green-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-green-900 dark:text-green-100\">Синонимы команды</Label>\n                  </div>\n                  \n                  <SynonymEditor\n                    synonyms={(() => {\n                      if (!selectedNode.data.synonyms || selectedNode.data.synonyms.length === 0) {\n                        const defaultSynonyms = selectedNode.type === 'ban_user' ? ['забанить', 'заблокировать', 'бан'] :\n                                                selectedNode.type === 'unban_user' ? ['разбанить', 'разблокировать', 'unbан'] :\n                                                selectedNode.type === 'mute_user' ? ['замутить', 'заглушить', 'мут'] :\n                                                selectedNode.type === 'unmute_user' ? ['размутить', 'разглушить', 'анмут'] :\n                                                selectedNode.type === 'kick_user' ? ['кикнуть', 'исключить', 'выгнать'] :\n                                                selectedNode.type === 'promote_user' ? ['повысить', 'назначить админом', 'промоут'] :\n                                                selectedNode.type === 'demote_user' ? ['понизить', 'снять с админки', 'демоут'] :\n                                                selectedNode.type === 'admin_rights' ? ['права админа', 'изменить права', 'админ права', 'тг права', 'права'] : [];\n                        if (defaultSynonyms.length > 0) {\n                          setTimeout(() => onNodeUpdate(selectedNode.id, { synonyms: defaultSynonyms }), 0);\n                          return defaultSynonyms;\n                        }\n                      }\n                      return selectedNode.data.synonyms || [];\n                    })()} \n                    onUpdate={(synonyms) => onNodeUpdate(selectedNode.id, { synonyms })}\n                    title=\"Альтернативные команды\"\n                    description={\n                      selectedNode.type === 'ban_user' ? \"Команды для блокировки пользователя\" :\n                      selectedNode.type === 'unban_user' ? \"Команды для разблокировки пользователя\" :\n                      selectedNode.type === 'mute_user' ? \"Команды для ограничения пользователя\" :\n                      selectedNode.type === 'unmute_user' ? \"Команды для снятия ограничений\" :\n                      selectedNode.type === 'kick_user' ? \"Команды для исключения пользователя\" :\n                      selectedNode.type === 'promote_user' ? \"Команды для назначения администратором\" :\n                      selectedNode.type === 'demote_user' ? \"Команды для снятия с должности администратора\" :\n                      selectedNode.type === 'admin_rights' ? \"Команды для управления правами администратора\" : \n                      \"Альтернативные команды для этого действия\"\n                    }\n                    placeholder={\n                      selectedNode.type === 'ban_user' ? \"забанить, заблокировать, бан\" :\n                      selectedNode.type === 'unban_user' ? \"разбанить, разблокировать, unbан\" :\n                      selectedNode.type === 'mute_user' ? \"замутить, заглушить, мут\" :\n                      selectedNode.type === 'unmute_user' ? \"размутить, разглушить, анмут\" :\n                      selectedNode.type === 'kick_user' ? \"кикнуть, исключить, выгнать\" :\n                      selectedNode.type === 'promote_user' ? \"повысить, назначить админом, промоут\" :\n                      selectedNode.type === 'demote_user' ? \"понизить, снять с админки, демоут\" :\n                      selectedNode.type === 'admin_rights' ? \"права админа, изменить права, админ права, тг права, права\" : \n                      \"команда1, команда2, команда3\"\n                    }\n                  />\n                </div>\n              </div>\n            )}\n\n            {/* Admin Rights Configuration */}\n            {selectedNode.type === 'admin_rights' && (\n              <div className=\"space-y-6\">\n                {/* Информация о функционале */}\n                <div className=\"bg-gradient-to-br from-violet-50/50 to-purple-50/30 dark:from-violet-950/20 dark:to-purple-950/10 border border-violet-200/30 dark:border-violet-800/30 rounded-lg p-4\">\n                  <div className=\"flex items-center space-x-2 mb-3\">\n                    <div className=\"w-6 h-6 rounded-full bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center\">\n                      <i className=\"fas fa-user-shield text-violet-600 dark:text-violet-400 text-xs\"></i>\n                    </div>\n                    <Label className=\"text-sm font-semibold text-violet-900 dark:text-violet-100\">Права администратора</Label>\n                  </div>\n                  \n                  <div className=\"space-y-3\">\n                    <div className=\"text-sm text-violet-800 dark:text-violet-200\">\n                      При вызове команды автоматически отправляется сообщение с 11 инлайн кнопками, показывающими текущие права администратора:\n                    </div>\n                    \n                    <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 🏷️ Изменение профиля</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 🗑️ Удаление сообщений</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 🚫 Блокировка участников</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 📨 Приглашение участников</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 📌 Закрепление сообщений</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 🎥 Управление видеочатами</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 📰 Публикация историй</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• ✏️ Редактирование историй</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 🗑️ Удаление историй</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 🔒 Анонимность</div>\n                      <div className=\"text-violet-600 dark:text-violet-400\">• 👑 Назначение администраторов</div>\n                    </div>\n                    \n                    <div className=\"mt-3 p-3 bg-violet-100/50 dark:bg-violet-900/20 rounded-lg border border-violet-200 dark:border-violet-700\">\n                      <div className=\"text-xs text-violet-700 dark:text-violet-300 font-medium mb-1\">\n                        💡 Автоматическое определение участника:\n                      </div>\n                      <div className=\"text-xs text-violet-600 dark:text-violet-400\">\n                        • При ответе на сообщение — права того, кто отправил сообщение<br/>\n                        • При упоминании (@username) — права упомянутого пользователя<br/>\n                        • При добавлении ID в команду — права указанного участника\n                      </div>\n                    </div>\n                  </div>\n                </div>\n                \n              </div>\n            )}\n\n          </div>\n        </div>\n\n        {/* Message Content */}\n        <div>\n          <div className=\"space-y-4\">\n            {/* Media Variables Section */}\n            {attachedMediaVariables.length > 0 && (\n              <div className=\"space-y-2\">\n                <Label className=\"text-xs font-medium text-muted-foreground\">Прикрепленные медиа</Label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {attachedMediaVariables.map((variable) => {\n                    const getMediaIcon = () => {\n                      switch (variable.mediaType) {\n                        case 'photo': return <Image className=\"h-3 w-3\" />;\n                        case 'video': return <Video className=\"h-3 w-3\" />;\n                        case 'audio': return <Music className=\"h-3 w-3\" />;\n                        case 'document': return <FileText className=\"h-3 w-3\" />;\n                        default: return null;\n                      }\n                    };\n\n                    const getMediaColor = () => {\n                      switch (variable.mediaType) {\n                        case 'photo': return 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-700';\n                        case 'video': return 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 border-purple-200 dark:border-purple-700';\n                        case 'audio': return 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border-green-200 dark:border-green-700';\n                        case 'document': return 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 border-orange-200 dark:border-orange-700';\n                        default: return 'bg-gray-100 dark:bg-gray-900/30 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-700';\n                      }\n                    };\n\n                    return (\n                      <div\n                        key={`${variable.nodeId}-${variable.name}`}\n                        className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-md border text-xs font-medium ${getMediaColor()}`}\n                      >\n                        {getMediaIcon()}\n                        <code className=\"font-mono\">{`{${variable.name}}`}</code>\n                        <span className=\"text-[10px] opacity-70\">{variable.description}</span>\n                        <button\n                          onClick={() => handleMediaVariableRemove(variable.name)}\n                          className=\"ml-1 text-xs opacity-50 hover:opacity-100 transition-opacity\"\n                          title=\"Удалить медиафайл\"\n                        >\n                          ✕\n                        </button>\n                      </div>\n                    );\n                  })}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  Эти переменные содержат file_id медиафайлов, полученных от пользователей\n                </div>\n              </div>\n            )}\n\n            {/* Inline Rich Text Editor */}\n            <div className=\"space-y-3\">\n              <div>\n                <Label className=\"text-xs font-medium text-muted-foreground mb-2 block\">Текст сообщения</Label>\n                <InlineRichEditor\n                  value={selectedNode.data.messageText || ''}\n                  onChange={(value) => onNodeUpdate(selectedNode.id, { messageText: value })}\n                  placeholder=\"Введите текст сообщения...\"\n                  enableMarkdown={selectedNode.data.markdown}\n                  onMarkdownToggle={(enabled) => onNodeUpdate(selectedNode.id, { markdown: enabled })}\n                  onFormatModeChange={(formatMode) => onNodeUpdate(selectedNode.id, { formatMode })}\n                  availableVariables={[...textVariables, ...mediaVariables]}\n                  onMediaVariableSelect={handleMediaVariableSelect}\n                />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Synonyms - только для узлов кроме команд, управления контентом и управления пользователями */}\n        {selectedNode.type !== 'start' && selectedNode.type !== 'command' && \n         selectedNode.type !== 'pin_message' && selectedNode.type !== 'unpin_message' && selectedNode.type !== 'delete_message' &&\n         selectedNode.type !== 'ban_user' && selectedNode.type !== 'unban_user' && selectedNode.type !== 'mute_user' && \n         selectedNode.type !== 'unmute_user' && selectedNode.type !== 'kick_user' && selectedNode.type !== 'promote_user' && \n         selectedNode.type !== 'demote_user' && selectedNode.type !== 'admin_rights' && (\n          <div>\n            <h3 className=\"text-sm font-medium text-foreground mb-3\">Синонимы</h3>\n            <div className=\"space-y-4\">\n              <SynonymEditor\n                synonyms={selectedNode.data.synonyms || []}\n                onUpdate={(synonyms) => onNodeUpdate(selectedNode.id, { synonyms })}\n                title=\"Альтернативные фразы\"\n                description=\"Добавьте слова или фразы, при написании которых будет срабатывать этот узел\"\n                placeholder=\"имя, профиль, анкета...\"\n              />\n            </div>\n          </div>\n        )}\n\n        {/* Keyboard Settings */}\n        <div>\n          <h3 className=\"text-sm font-medium text-foreground mb-3\">Клавиатура</h3>\n          <div className=\"space-y-4\">\n            <div>\n              <Label className=\"text-xs font-medium text-muted-foreground\">Тип клавиатуры</Label>\n              <Select\n                value={selectedNode.data.keyboardType}\n                onValueChange={(value: 'reply' | 'inline' | 'none') => \n                  onNodeUpdate(selectedNode.id, { keyboardType: value })\n                }\n              >\n                <SelectTrigger className=\"mt-2\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"reply\">Reply клавиатура</SelectItem>\n                  <SelectItem value=\"inline\">Inline кнопки</SelectItem>\n                  <SelectItem value=\"none\">Без клавиатуры</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Multiple Selection Setting */}\n            {selectedNode.data.keyboardType !== 'none' && (\n              <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-primary/30 hover:bg-card/80 transition-all duration-200\">\n                <div className=\"flex-1\">\n                  <Label className=\"text-xs font-medium text-foreground\">\n                    Множественный выбор\n                  </Label>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {selectedNode.data.keyboardType === 'inline' \n                      ? 'Кнопки не переходят к другому узлу, а отмечаются галочкой'\n                      : 'После каждого выбора показывается новое сообщение с обновленной клавиатурой'\n                    }\n                  </div>\n                </div>\n                <div className=\"ml-4\">\n                  <Switch\n                    checked={selectedNode.data.allowMultipleSelection ?? false}\n                    onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { allowMultipleSelection: checked })}\n                  />\n                </div>\n              </div>\n            )}\n\n            {/* Multiple Selection Settings */}\n            {selectedNode.data.keyboardType !== 'none' && selectedNode.data.allowMultipleSelection && (\n              <div className=\"space-y-4\">\n                {/* Variable Name for Saving Multiple Selection */}\n                <div className=\"space-y-2\">\n                  <Label className=\"text-xs font-medium text-muted-foreground\">Имя переменной для сохранения множественного выбора</Label>\n                  <Input\n                    value={selectedNode.data.multiSelectVariable || ''}\n                    onChange={(e) => onNodeUpdate(selectedNode.id, { multiSelectVariable: e.target.value })}\n                    className=\"text-xs\"\n                    placeholder=\"выбранные_опции\"\n                  />\n                  <div className=\"text-xs text-muted-foreground\">\n                    Выбранные опции будут сохранены в эту переменную через запятую.\n                    <br />\n                    <span className=\"text-amber-600 dark:text-amber-400\">⚠️ Убедитесь, что имя не совпадает с переменными из \"✨ Дополнительный сбор ответов\"</span>\n                  </div>\n                </div>\n                \n\n              </div>\n            )}\n\n            {/* Buttons List */}\n            {selectedNode.data.keyboardType !== 'none' && (\n              <div>\n                <div className=\"flex items-center justify-between mb-2\">\n                  <Label className=\"text-xs font-medium text-muted-foreground\">\n                    Кнопки\n                  </Label>\n                  <div className=\"flex gap-2\">\n                    <UIButton\n                      size=\"sm\"\n                      variant=\"ghost\"\n                      onClick={handleAddButton}\n                      className=\"text-xs text-primary hover:text-primary/80 font-medium h-auto p-1\"\n                    >\n                      + Добавить кнопку\n                    </UIButton>\n                    {selectedNode.data.allowMultipleSelection && (\n                      <>\n                        <UIButton\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => {\n                            const newButton = {\n                              id: Date.now().toString(),\n                              text: 'Новая опция',\n                              action: 'selection' as const,\n                              target: '',\n                              buttonType: 'option' as const,\n                              skipDataCollection: false\n                            };\n                            \n                            const currentButtons = selectedNode.data.buttons || [];\n                            const updatedButtons = [...currentButtons, newButton];\n                            onNodeUpdate(selectedNode.id, { buttons: updatedButtons });\n                          }}\n                          className=\"text-xs text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 font-medium h-auto p-1\"\n                        >\n                          + Опция\n                        </UIButton>\n                        <UIButton\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => {\n                            const newButton = {\n                              id: Date.now().toString(),\n                              text: 'Готово',\n                              action: 'goto' as const,\n                              target: '',\n                              buttonType: 'complete' as const,\n                              skipDataCollection: false\n                            };\n                            \n                            const currentButtons = selectedNode.data.buttons || [];\n                            const updatedButtons = [...currentButtons, newButton];\n                            onNodeUpdate(selectedNode.id, { buttons: updatedButtons });\n                          }}\n                          className=\"text-xs text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300 font-medium h-auto p-1\"\n                        >\n                          + Завершение\n                        </UIButton>\n                      </>\n                    )}\n                  </div>\n                </div>\n                \n                <div className=\"space-y-2\">\n                  {/* Show Continue Button for Multiple Selection */}\n                  {selectedNode.data.allowMultipleSelection && (\n                    <div className=\"bg-muted/50 rounded-lg p-3\">\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <Input\n                          value={selectedNode.data.continueButtonText || 'Готово'}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { continueButtonText: e.target.value })}\n                          className=\"flex-1 text-sm font-medium bg-transparent border-none focus:outline-none focus:ring-2 focus:ring-primary\"\n                          placeholder=\"Готово\"\n                        />\n                        <div className=\"flex items-center gap-2\">\n                          {/* Button Type Indicator */}\n                          <div className=\"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-2 py-1 rounded text-xs font-medium\">\n                            Завершение\n                          </div>\n                          <button\n                            onClick={() => {\n                              // No delete action for auto-generated button, just show info\n                              toast({\n                                title: \"Автоматическая кнопка\",\n                                description: \"Эта кнопка генерируется автоматически для завершения выбора\",\n                              });\n                            }}\n                            className=\"text-xs text-muted-foreground hover:text-destructive p-1\"\n                          >\n                            <i className=\"fas fa-info-circle\"></i>\n                          </button>\n                        </div>\n                      </div>\n\n                      {/* Button Type Selection - Disabled for continue button */}\n                      <div className=\"mb-2\">\n                        <Label className=\"text-xs font-medium text-muted-foreground mb-1\">Тип кнопки</Label>\n                        <Select value=\"complete\" disabled>\n                          <SelectTrigger className=\"text-xs opacity-60\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"complete\">Кнопка завершения</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <div className=\"text-xs text-muted-foreground mt-1\">\n                          Сохраняет выбранные опции и переходит к следующему экрану\n                        </div>\n                      </div>\n\n                      {/* Continue Button Target */}\n                      <div className=\"space-y-2\">\n                        <Label className=\"text-xs font-medium text-muted-foreground\">Выберите экран</Label>\n                        <Select\n                          value={selectedNode.data.continueButtonTarget || 'none'}\n                          onValueChange={(value) => onNodeUpdate(selectedNode.id, { continueButtonTarget: value === 'none' ? '' : value })}\n                        >\n                          <SelectTrigger className=\"text-xs\">\n                            <SelectValue placeholder=\"Или введите ID вручную\" />\n                          </SelectTrigger>\n                          <SelectContent className=\"max-h-48 overflow-y-auto\">\n                            <SelectItem value=\"none\">Не выбрано</SelectItem>\n                            {getAllNodesFromAllSheets\n                              .filter(n => n.node.id !== selectedNode.id)\n                              .map(({node, sheetName}) => (\n                                <SelectItem key={node.id} value={node.id}>\n                                  <div className=\"flex items-center space-x-2\">\n                                    <i className={`${nodeIcons[node.type]} text-xs`}></i>\n                                    <span className=\"truncate\">{node.id}</span>\n                                    <span className=\"text-muted-foreground text-xs\">({nodeTypeNames[node.type]})</span>\n                                    <span className=\"text-xs text-blue-600 dark:text-blue-400\">({sheetName})</span>\n                                  </div>\n                                </SelectItem>\n                              ))\n                            }\n                          </SelectContent>\n                        </Select>\n                        <Input\n                          value={selectedNode.data.continueButtonTarget || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { continueButtonTarget: e.target.value })}\n                          className=\"text-xs\"\n                          placeholder=\"Или введите ID вручную\"\n                        />\n                      </div>\n                    </div>\n                  )}\n                  \n                  {(selectedNode.data.buttons || []).map((button) => (\n                    <div key={button.id} className=\"bg-muted/50 rounded-lg p-3\">\n                      <div className=\"mb-2\">\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          <Input\n                            value={button.text}\n                            onChange={(e) => onButtonUpdate(selectedNode.id, button.id, { text: e.target.value })}\n                            className=\"flex-1 text-sm font-medium\"\n                            placeholder=\"Текст кнопки\"\n                          />\n                          <DropdownMenu>\n                            <DropdownMenuTrigger asChild>\n                              <UIButton\n                                size=\"sm\"\n                                variant=\"outline\"\n                                className=\"px-2 py-1 h-8 text-xs shrink-0 gap-1\"\n                                title=\"Вставить переменную\"\n                              >\n                                <Plus className=\"h-3 w-3\" />\n                                <span>Переменная</span>\n                              </UIButton>\n                            </DropdownMenuTrigger>\n                            <DropdownMenuContent align=\"end\" className=\"w-56\">\n                              <DropdownMenuLabel className=\"text-xs\">\n                                Доступные переменные\n                              </DropdownMenuLabel>\n                              <DropdownMenuSeparator />\n                              {textVariables.map((variable, index) => {\n                                const getBadgeText = () => {\n                                  if (variable.nodeType === 'user-input') return 'Ввод';\n                                  if (variable.nodeType === 'start') return 'Команда';\n                                  if (variable.nodeType === 'command') return 'Команда';\n                                  if (variable.nodeType === 'system') return 'Система';\n                                  if (variable.nodeType === 'conditional') return 'Условие';\n                                  return 'Другое';\n                                };\n                                \n                                return (\n                                  <DropdownMenuItem\n                                    key={`${variable.nodeId}-${variable.name}-${index}`}\n                                    onClick={() => {\n                                      const currentText = button.text || '';\n                                      const newText = currentText + `{${variable.name}}`;\n                                      onButtonUpdate(selectedNode.id, button.id, { text: newText });\n                                    }}\n                                    className=\"cursor-pointer\"\n                                  >\n                                    <div className=\"flex flex-col gap-1 w-full\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <code className=\"text-xs bg-muted px-1 py-0.5 rounded\">\n                                          {`{${variable.name}}`}\n                                        </code>\n                                        <Badge variant=\"outline\" className=\"text-xs h-4\">\n                                          {getBadgeText()}\n                                        </Badge>\n                                      </div>\n                                      {variable.description && (\n                                        <div className=\"text-xs text-muted-foreground\">\n                                          {variable.description}\n                                        </div>\n                                      )}\n                                    </div>\n                                  </DropdownMenuItem>\n                                );\n                              })}\n                              {textVariables.length === 0 && (\n                                <DropdownMenuItem disabled>\n                                  <span className=\"text-xs text-muted-foreground\">\n                                    Нет доступных переменных\n                                  </span>\n                                </DropdownMenuItem>\n                              )}\n                            </DropdownMenuContent>\n                          </DropdownMenu>\n                        </div>\n                        <div className=\"flex items-center justify-end gap-2\">\n                          {/* Button Type Indicator */}\n                          {selectedNode.data.allowMultipleSelection && (\n                            <>\n                              {button.buttonType === 'option' && (\n                                <div className=\"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-2 py-1 rounded text-xs font-medium\">\n                                  Опция\n                                </div>\n                              )}\n                              {button.buttonType === 'complete' && (\n                                <div className=\"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-2 py-1 rounded text-xs font-medium\">\n                                  Завершение\n                                </div>\n                              )}\n                              {button.buttonType === 'normal' && (\n                                <div className=\"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-1 rounded text-xs font-medium\">\n                                  Обычная\n                                </div>\n                              )}\n                            </>\n                          )}\n                          <UIButton\n                            size=\"sm\"\n                            variant=\"ghost\"\n                            onClick={() => onButtonDelete(selectedNode.id, button.id)}\n                            className=\"text-muted-foreground hover:text-destructive dark:text-muted-foreground dark:hover:text-destructive h-auto p-1 transition-colors duration-200\"\n                          >\n                            <svg className=\"w-3 h-3\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                              <path fillRule=\"evenodd\" d=\"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z\" clipRule=\"evenodd\" />\n                            </svg>\n                          </UIButton>\n                        </div>\n                        <div className=\"text-xs text-muted-foreground px-1 mt-1\">\n                          Переменные в тексте заменятся на значения: {'{возраст}'} → \"25\"\n                        </div>\n                      </div>\n                      \n                      {/* Button Type Selection - Show for Multiple Selection Mode */}\n                      {selectedNode.data.allowMultipleSelection && (\n                        <div className=\"mb-3\">\n                          <Label className=\"text-xs font-medium text-muted-foreground mb-2 block\">Тип кнопки</Label>\n                          <Select\n                            value={button.buttonType || 'normal'}\n                            onValueChange={(value: 'normal' | 'option' | 'complete') => {\n                              if (value === 'option') {\n                                onButtonUpdate(selectedNode.id, button.id, { \n                                  buttonType: 'option', \n                                  action: 'selection', \n                                  target: '' \n                                });\n                              } else if (value === 'complete') {\n                                onButtonUpdate(selectedNode.id, button.id, { \n                                  buttonType: 'complete', \n                                  action: 'goto', \n                                  target: selectedNode.data.continueButtonTarget || '' \n                                });\n                              } else {\n                                onButtonUpdate(selectedNode.id, button.id, { \n                                  buttonType: 'normal', \n                                  action: 'goto', \n                                  target: '' \n                                });\n                              }\n                            }}\n                          >\n                            <SelectTrigger className=\"w-full text-xs\">\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"normal\">\n                                <div className=\"flex items-center gap-2\">\n                                  <div className=\"w-2 h-2 rounded-full bg-blue-500\"></div>\n                                  <span>Обычная кнопка</span>\n                                </div>\n                              </SelectItem>\n                              <SelectItem value=\"option\">\n                                <div className=\"flex items-center gap-2\">\n                                  <div className=\"w-2 h-2 rounded-full bg-green-500\"></div>\n                                  <span>Опция для выбора</span>\n                                </div>\n                              </SelectItem>\n                              <SelectItem value=\"complete\">\n                                <div className=\"flex items-center gap-2\">\n                                  <div className=\"w-2 h-2 rounded-full bg-purple-500\"></div>\n                                  <span>Кнопка завершения</span>\n                                </div>\n                              </SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n                      )}\n                      {/* Action Selection - Show for normal buttons or non-multiple-selection modes */}\n                      {(!selectedNode.data.allowMultipleSelection || (button.buttonType !== 'option' && button.buttonType !== 'complete')) && (\n                        <Select\n                          value={button.action}\n                          onValueChange={(value: 'goto' | 'command' | 'url' | 'selection') =>\n                            onButtonUpdate(selectedNode.id, button.id, { action: value })\n                          }\n                        >\n                          <SelectTrigger className=\"w-full text-xs\">\n                            <SelectValue placeholder=\"Выберите действие\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"goto\">Перейти к экрану</SelectItem>\n                            <SelectItem value=\"command\">Выполнить команду</SelectItem>\n                            <SelectItem value=\"url\">Открыть ссылку</SelectItem>\n                            <SelectItem value=\"selection\">Выбор опции</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      )}\n\n                      {/* Skip Data Collection Toggle - Only show when collectUserInput is enabled */}\n                      {selectedNode.data.collectUserInput && (\n                        <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-primary/30 hover:bg-card/80 transition-all duration-200 mt-3\">\n                          <div className=\"flex-1\">\n                            <Label className=\"text-xs font-medium text-foreground\">\n                              Не сохранять ответы\n                            </Label>\n                            <div className=\"text-xs text-muted-foreground mt-1\">\n                              Кнопка будет работать только для навигации, без сбора данных пользователя\n                            </div>\n                          </div>\n                          <div className=\"ml-4\">\n                            <Switch\n                              checked={button.skipDataCollection ?? false}\n                              onCheckedChange={(checked) => \n                                onButtonUpdate(selectedNode.id, button.id, { skipDataCollection: checked })\n                              }\n                            />\n                          </div>\n                        </div>\n                      )}\n                      \n                      {/* Button Type Info Blocks */}\n                      {selectedNode.data.allowMultipleSelection && (\n                        <>\n                          {/* Option Button Info */}\n                          {button.buttonType === 'option' && (\n                            <div className=\"bg-green-50/50 dark:bg-green-950/20 border border-green-200/40 dark:border-green-800/40 rounded-lg p-2 mt-2 space-y-2\">\n                              <div className=\"text-xs text-green-700 dark:text-green-300 font-medium\">\n                                Опция для выбора\n                              </div>\n                              <div className=\"text-xs text-green-600 dark:text-green-400\">\n                                {selectedNode.data.keyboardType === 'inline' \n                                  ? `При нажатии появится отметка ${selectedNode.data.checkmarkSymbol || '✅'}`\n                                  : 'После выбора покажется обновленная клавиатура'\n                                }\n                              </div>\n                              \n                              {/* Checkmark Symbol Input */}\n                              {selectedNode.data.keyboardType === 'inline' && (\n                                <div className=\"space-y-1\">\n                                  <Label className=\"text-xs font-medium text-green-700 dark:text-green-300\">Символ отметки</Label>\n                                  <Input\n                                    value={selectedNode.data.checkmarkSymbol || '✅'}\n                                    onChange={(e) => onNodeUpdate(selectedNode.id, { checkmarkSymbol: e.target.value })}\n                                    className=\"text-xs bg-white dark:bg-green-950/30 border-green-300 dark:border-green-700\"\n                                    placeholder=\"✅\"\n                                    maxLength={3}\n                                  />\n                                </div>\n                              )}\n                            </div>\n                          )}\n                          \n                          {/* Complete Button Info */}\n                          {button.buttonType === 'complete' && (\n                            <div className=\"bg-purple-50/50 dark:bg-purple-950/20 border border-purple-200/40 dark:border-purple-800/40 rounded-lg p-2 mt-2\">\n                              <div className=\"text-xs text-purple-700 dark:text-purple-300 font-medium\">\n                                Кнопка завершения\n                              </div>\n                              <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                                Сохраняет выбранные опции и переходит к следующему экрану\n                              </div>\n                            </div>\n                          )}\n                          \n                          {/* Normal Button Info */}\n                          {button.buttonType === 'normal' && (\n                            <div className=\"bg-blue-50/50 dark:bg-blue-950/20 border border-blue-200/40 dark:border-blue-800/40 rounded-lg p-2 mt-2\">\n                              <div className=\"text-xs text-blue-700 dark:text-blue-300 font-medium\">\n                                Обычная кнопка\n                              </div>\n                              <div className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                                Работает как обычная кнопка навигации или команда\n                              </div>\n                            </div>\n                          )}\n                        </>\n                      )}\n                      \n                      {(!selectedNode.data.allowMultipleSelection || button.action !== 'selection') && button.action === 'url' && (\n                        <Input\n                          value={button.url || ''}\n                          onChange={(e) => onButtonUpdate(selectedNode.id, button.id, { url: e.target.value })}\n                          className=\"mt-2 text-xs\"\n                          placeholder=\"https://example.com\"\n                        />\n                      )}\n                      \n                      {(!selectedNode.data.allowMultipleSelection || button.action !== 'selection') && button.action === 'command' && (\n                        <div className=\"mt-2 space-y-2\">\n                          <Select\n                            value={button.target || ''}\n                            onValueChange={(value) => onButtonUpdate(selectedNode.id, button.id, { target: value })}\n                          >\n                            <SelectTrigger className=\"text-xs\">\n                              <SelectValue placeholder=\"Выберите команду\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {allNodes\n                                .filter(node => (node.type === 'start' || node.type === 'command') && node.data.command)\n                                .map((node) => (\n                                  <SelectItem key={node.id} value={node.data.command!}>\n                                    <div className=\"flex items-center space-x-2\">\n                                      <i className={`${node.type === 'start' ? 'fas fa-play' : 'fas fa-terminal'} text-xs`}></i>\n                                      <span>{node.data.command}</span>\n                                      {node.data.description && (\n                                        <span className=\"text-gray-500\">- {node.data.description}</span>\n                                      )}\n                                    </div>\n                                  </SelectItem>\n                                ))}\n                              {STANDARD_COMMANDS.map((cmd) => (\n                                <SelectItem key={cmd.command} value={cmd.command}>\n                                  <div className=\"flex items-center space-x-2\">\n                                    <i className=\"fas fa-lightbulb text-yellow-500 text-xs\"></i>\n                                    <span>{cmd.command}</span>\n                                    <span className=\"text-gray-500\">- {cmd.description}</span>\n                                  </div>\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          \n                          <Input\n                            value={button.target || ''}\n                            onChange={(e) => onButtonUpdate(selectedNode.id, button.id, { target: e.target.value })}\n                            className=\"text-xs\"\n                            placeholder=\"Или введите команду вручную (например: /help)\"\n                          />\n                          \n                          {button.target && !button.target.startsWith('/') && (\n                            <div className=\"flex items-center text-xs text-warning-foreground bg-warning/10 dark:bg-warning/5 border border-warning/20 dark:border-warning/10 p-2 rounded-md\">\n                              <svg className=\"w-3 h-3 mr-2 text-warning\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                                <path fillRule=\"evenodd\" d=\"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z\" clipRule=\"evenodd\" />\n                              </svg>\n                              <span>Команда должна начинаться с символа \"/\"</span>\n                            </div>\n                          )}\n                        </div>\n                      )}\n\n                      {(!selectedNode.data.allowMultipleSelection || button.action !== 'selection') && button.action === 'goto' && (\n                        <div className=\"mt-2 space-y-2\">\n                          <Select\n                            value={button.target || ''}\n                            onValueChange={(value) => onButtonUpdate(selectedNode.id, button.id, { target: value })}\n                          >\n                            <SelectTrigger className=\"text-xs\">\n                              <SelectValue placeholder=\"Выберите экран\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {getAllNodesFromAllSheets\n                                .filter(n => n.node.id !== selectedNode.id)\n                                .map(({node, sheetName}) => {\n                                  const nodeName = \n                                    node.type === 'start' ? node.data.command :\n                                    node.type === 'command' ? node.data.command :\n                                    node.type === 'message' ? 'Сообщение' :\n                                    node.type === 'photo' ? 'Фото' :\n                                    node.type === 'keyboard' ? 'Клавиатура' :\n                                    node.type === 'condition' ? 'Условие' :\n                                    'Узел';\n                                  \n                                  return (\n                                    <SelectItem key={node.id} value={node.id}>\n                                      <div className=\"flex items-center gap-2\">\n                                        <span>{nodeName} ({node.id})</span>\n                                        <span className=\"text-xs text-blue-600 dark:text-blue-400\">({sheetName})</span>\n                                      </div>\n                                    </SelectItem>\n                                  );\n                                })}\n                              {getAllNodesFromAllSheets.filter(n => n.node.id !== selectedNode.id).length === 0 && (\n                                <SelectItem value=\"no-nodes\" disabled>\n                                  Создайте другие экраны для выбора\n                                </SelectItem>\n                              )}\n                            </SelectContent>\n                          </Select>\n                          \n                          <Input\n                            value={button.target || ''}\n                            onChange={(e) => onButtonUpdate(selectedNode.id, button.id, { target: e.target.value })}\n                            className=\"text-xs\"\n                            placeholder=\"Или введите ID вручную\"\n                          />\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n\n        {/* Conditional Messages */}\n        {(selectedNode.type === 'start' || selectedNode.type === 'command' || selectedNode.type === 'message' || selectedNode.type === 'keyboard') && (\n          <div>\n            <h3 className=\"text-sm font-medium text-foreground mb-3\">🔄 Условные сообщения</h3>\n            <div className=\"space-y-4\">\n              {/* Enable Conditional Messages */}\n              <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-primary/30 hover:bg-card/80 transition-all duration-200\">\n                <div className=\"flex-1\">\n                  <Label className=\"text-xs font-medium text-foreground\">\n                    Включить условные сообщения\n                  </Label>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    Разные сообщения в зависимости от того, отвечал ли пользователь на вопросы\n                  </div>\n                </div>\n                <div className=\"ml-4\">\n                  <Switch\n                    checked={selectedNode.data.enableConditionalMessages ?? false}\n                    onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableConditionalMessages: checked })}\n                  />\n                </div>\n              </div>\n\n              {/* Conditional Messages Settings */}\n              {selectedNode.data.enableConditionalMessages && (\n                <div className=\"space-y-4 bg-gradient-to-br from-purple-50/50 to-indigo-50/30 dark:from-purple-950/20 dark:to-indigo-950/10 border border-purple-200/30 dark:border-purple-800/30 rounded-lg p-4\">\n                  \n                  {/* Information Block */}\n                  <div className=\"bg-blue-50/70 dark:bg-blue-950/30 border border-blue-200/40 dark:border-blue-800/40 rounded-lg p-3\">\n                    <div className=\"flex items-start space-x-2\">\n                      <div className=\"w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5\">\n                        <i className=\"fas fa-info text-white text-xs\"></i>\n                      </div>\n                      <div>\n                        <div className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-1\">\n                          Как это работает?\n                        </div>\n                        <div className=\"text-xs text-blue-600 dark:text-blue-400 leading-relaxed\">\n                          <div className=\"space-y-1\">\n                            <div>📝 Бот запомнит ответы пользователей на вопросы</div>\n                            <div>🎯 Покажет разные сообщения в зависимости от этих ответов</div>\n                            <div>⚡ Например: новым - \"Добро пожаловать!\", старым - \"С возвращением!\"</div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Rule Conflicts and Validation */}\n                  {detectRuleConflicts.length > 0 && (\n                    <div className=\"bg-red-50/50 dark:bg-red-950/20 border border-red-200/40 dark:border-red-800/40 rounded-lg p-3 mb-4\">\n                      <div className=\"flex items-start space-x-2\">\n                        <div className=\"w-4 h-4 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5\">\n                          <i className=\"fas fa-exclamation text-white text-xs\"></i>\n                        </div>\n                        <div className=\"flex-1\">\n                          <div className=\"text-xs font-medium text-red-700 dark:text-red-300 mb-2\">\n                            Обнаружены проблемы с правилами ({detectRuleConflicts.length}):\n                          </div>\n                          <div className=\"space-y-1\">\n                            {detectRuleConflicts.map((conflict, idx) => (\n                              <div key={idx} className={`text-xs p-2 rounded ${\n                                conflict.severity === 'error' \n                                  ? 'bg-red-100/50 dark:bg-red-900/20 text-red-700 dark:text-red-300' \n                                  : 'bg-yellow-100/50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300'\n                              }`}>\n                                <div className=\"font-medium flex items-center space-x-1\">\n                                  <i className={`fas ${conflict.severity === 'error' ? 'fa-times-circle' : 'fa-exclamation-triangle'} text-xs`}></i>\n                                  <span>{conflict.description}</span>\n                                </div>\n                                <div className=\"text-xs opacity-75 mt-1\">{conflict.suggestion}</div>\n                              </div>\n                            ))}\n                          </div>\n                          <div className=\"flex space-x-2 mt-3\">\n                            <UIButton\n                              size=\"sm\"\n                              variant=\"ghost\"\n                              onClick={autoFixPriorities}\n                              className=\"text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300\"\n                            >\n                              <i className=\"fas fa-magic mr-1\"></i>\n                              Автоисправление приоритетов\n                            </UIButton>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Conditional Messages List */}\n                  <div>\n                    <div className=\"flex items-center justify-between mb-3\">\n                      <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300\">\n                        Настройка правил для показа сообщений\n                      </Label>\n                      <div className=\"flex space-x-2\">\n                        <UIButton\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={autoFixPriorities}\n                          className=\"text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300\"\n                          title=\"Автоматически расставить приоритеты для избежания конфликтов\"\n                        >\n                          <i className=\"fas fa-sort-amount-down mr-1\"></i>\n                          Приоритеты\n                        </UIButton>\n                        <UIButton\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => {\n                            const currentConditions = selectedNode.data.conditionalMessages || [];\n                            const nextPriority = Math.max(0, ...currentConditions.map(c => c.priority || 0)) + 10;\n                            \n                            const newCondition = {\n                              id: `condition-${Date.now()}`,\n                              condition: 'user_data_exists' as const,\n                              variableName: '',\n                              variableNames: [],\n                              logicOperator: 'AND' as const,\n                              messageText: 'Добро пожаловать обратно!',\n                              formatMode: 'text' as const,\n                              keyboardType: 'none' as const,\n                              buttons: [],\n                              waitForTextInput: false,\n                              priority: nextPriority\n                            };\n                            onNodeUpdate(selectedNode.id, { \n                              conditionalMessages: [...currentConditions, newCondition] \n                            });\n                          }}\n                          className=\"text-xs\"\n                        >\n                          <i className=\"fas fa-plus mr-1\"></i>\n                          Добавить правило\n                        </UIButton>\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-3\">\n                      {(selectedNode.data.conditionalMessages || [])\n                        .sort((a, b) => (b.priority || 0) - (a.priority || 0))\n                        .map((condition, index) => {\n                          // Check if this rule has conflicts\n                          const ruleConflicts = detectRuleConflicts.filter(c => c.ruleIndex === index);\n                          const hasErrors = ruleConflicts.some(c => c.severity === 'error');\n                          const hasWarnings = ruleConflicts.some(c => c.severity === 'warning');\n                          \n                          return (\n                            <div key={condition.id} className={`bg-white/50 dark:bg-gray-900/30 border rounded-lg p-3 ${\n                              hasErrors \n                                ? 'border-red-300 dark:border-red-700 bg-red-50/20 dark:bg-red-950/10' \n                                : hasWarnings \n                                  ? 'border-yellow-300 dark:border-yellow-700 bg-yellow-50/20 dark:bg-yellow-950/10'\n                                  : 'border-purple-200/30 dark:border-purple-800/30'\n                            }`}>\n                              <div className=\"flex items-center justify-between mb-3\">\n                                <div className=\"flex items-center space-x-2\">\n                                  <div className=\"text-xs font-medium text-purple-700 dark:text-purple-300\">\n                                    Правило #{index + 1}\n                                  </div>\n                                  {hasErrors && (\n                                    <div className=\"w-4 h-4 bg-red-500 rounded-full flex items-center justify-center\">\n                                      <i className=\"fas fa-times text-white text-xs\"></i>\n                                    </div>\n                                  )}\n                                  {hasWarnings && !hasErrors && (\n                                    <div className=\"w-4 h-4 bg-yellow-500 rounded-full flex items-center justify-center\">\n                                      <i className=\"fas fa-exclamation text-white text-xs\"></i>\n                                    </div>\n                                  )}\n                                  <div className=\"text-xs text-muted-foreground\">\n                                    Приоритет: {condition.priority || 0}\n                                  </div>\n                                </div>\n                                <div className=\"flex items-center space-x-1\">\n                                  {/* Priority controls */}\n                                  <UIButton\n                                    size=\"sm\"\n                                    variant=\"ghost\"\n                                    onClick={() => {\n                                      const currentConditions = selectedNode.data.conditionalMessages || [];\n                                      const updatedConditions = currentConditions.map(c => \n                                        c.id === condition.id \n                                          ? { ...c, priority: (c.priority || 0) + 10 } \n                                          : c\n                                      );\n                                      onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                    }}\n                                    className=\"text-muted-foreground hover:text-blue-600 h-auto p-1\"\n                                    title=\"Повысить приоритет\"\n                                  >\n                                    <i className=\"fas fa-arrow-up text-xs\"></i>\n                                  </UIButton>\n                                  <UIButton\n                                    size=\"sm\"\n                                    variant=\"ghost\"\n                                    onClick={() => {\n                                      const currentConditions = selectedNode.data.conditionalMessages || [];\n                                      const updatedConditions = currentConditions.map(c => \n                                        c.id === condition.id \n                                          ? { ...c, priority: Math.max(0, (c.priority || 0) - 10) } \n                                          : c\n                                      );\n                                      onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                    }}\n                                    className=\"text-muted-foreground hover:text-blue-600 h-auto p-1\"\n                                    title=\"Понизить приоритет\"\n                                  >\n                                    <i className=\"fas fa-arrow-down text-xs\"></i>\n                                  </UIButton>\n                                  <UIButton\n                                    size=\"sm\"\n                                    variant=\"ghost\"\n                                    onClick={() => {\n                                      const currentConditions = selectedNode.data.conditionalMessages || [];\n                                      const newConditions = currentConditions.filter(c => c.id !== condition.id);\n                                      onNodeUpdate(selectedNode.id, { conditionalMessages: newConditions });\n                                    }}\n                                    className=\"text-muted-foreground hover:text-destructive h-auto p-1\"\n                                  >\n                                    <i className=\"fas fa-trash text-xs\"></i>\n                                  </UIButton>\n                                </div>\n                              </div>\n\n                              {/* Show conflicts for this rule */}\n                              {ruleConflicts.length > 0 && (\n                                <div className=\"mb-3 p-2 bg-red-50/50 dark:bg-red-950/20 border border-red-200/40 dark:border-red-800/40 rounded text-xs\">\n                                  {ruleConflicts.map((conflict, idx) => (\n                                    <div key={idx} className=\"text-red-700 dark:text-red-300\">\n                                      <i className={`fas ${conflict.severity === 'error' ? 'fa-times-circle' : 'fa-exclamation-triangle'} mr-1`}></i>\n                                      {conflict.description}\n                                    </div>\n                                  ))}\n                                </div>\n                              )}\n\n                              <div className=\"space-y-3\">\n                            {/* Condition Type */}\n                            <div>\n                              <Label className=\"text-xs font-medium text-muted-foreground mb-1 block\">\n                                Тип условия\n                              </Label>\n                              <Select\n                                value={condition.condition}\n                                onValueChange={(value) => {\n                                  const currentConditions = selectedNode.data.conditionalMessages || [];\n                                  const updatedConditions = currentConditions.map(c => \n                                    c.id === condition.id ? { ...c, condition: value as any } : c\n                                  );\n                                  onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                }}\n                              >\n                                <SelectTrigger className=\"text-xs\">\n                                  <SelectValue />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  <SelectItem value=\"user_data_exists\">Пользователь уже отвечал на вопрос</SelectItem>\n                                  <SelectItem value=\"user_data_not_exists\">Пользователь НЕ отвечал на вопрос</SelectItem>\n                                  <SelectItem value=\"user_data_equals\">Ответ пользователя равен определенному значению</SelectItem>\n                                  <SelectItem value=\"user_data_contains\">Ответ пользователя содержит определенный текст</SelectItem>\n                                  <SelectItem value=\"first_time\">Пользователь заходит впервые</SelectItem>\n                                  <SelectItem value=\"returning_user\">Пользователь уже заходил ранее</SelectItem>\n                                </SelectContent>\n                              </Select>\n                            </div>\n\n                            {/* Variable Names - Multiple Question Selection */}\n                            {(condition.condition === 'user_data_exists' || \n                              condition.condition === 'user_data_not_exists' || \n                              condition.condition === 'user_data_equals' || \n                              condition.condition === 'user_data_contains') && (\n                              <div>\n                                <Label className=\"text-xs font-medium text-muted-foreground mb-2 block\">\n                                  На какие вопросы должен был ответить пользователь?\n                                </Label>\n                                \n                                {/* Multiple Question Selection with Checkboxes */}\n                                {availableQuestions.length > 0 ? (\n                                  <div className=\"space-y-3\">\n                                    <div className=\"bg-muted/30 rounded-lg p-3 border border-border/50\">\n                                      <div className=\"text-xs font-medium text-muted-foreground mb-2\">\n                                        Выберите вопросы из списка:\n                                      </div>\n                                      <div className=\"space-y-2 max-h-32 overflow-y-auto\">\n                                        {availableQuestions.map((question) => {\n                                          const currentVariableNames = condition.variableNames || [];\n                                          const isSelected = currentVariableNames.includes(question.name);\n                                          \n                                          return (\n                                            <div key={`${question.nodeId}-${question.name}`} className=\"flex items-center space-x-2\">\n                                              <input\n                                                type=\"checkbox\"\n                                                id={`question-${condition.id}-${question.name}`}\n                                                checked={isSelected}\n                                                onChange={(e) => {\n                                                  const currentConditions = selectedNode.data.conditionalMessages || [];\n                                                  const currentVariableNames = condition.variableNames || [];\n                                                  \n                                                  let updatedVariableNames;\n                                                  if (e.target.checked) {\n                                                    updatedVariableNames = [...currentVariableNames, question.name];\n                                                  } else {\n                                                    updatedVariableNames = currentVariableNames.filter(name => name !== question.name);\n                                                  }\n                                                  \n                                                  const updatedConditions = currentConditions.map(c => \n                                                    c.id === condition.id ? { \n                                                      ...c, \n                                                      variableNames: updatedVariableNames,\n                                                      // Update legacy variableName for backward compatibility\n                                                      variableName: updatedVariableNames.length > 0 ? updatedVariableNames[0] : ''\n                                                    } : c\n                                                  );\n                                                  onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                                }}\n                                                className=\"w-3 h-3 text-primary focus:ring-primary border-border rounded\"\n                                              />\n                                              <label \n                                                htmlFor={`question-${condition.id}-${question.name}`}\n                                                className=\"flex items-center space-x-2 cursor-pointer flex-1\"\n                                              >\n                                                {question.mediaType ? (\n                                                  <span className=\"text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-1.5 py-0.5 rounded flex items-center gap-1\">\n                                                    {question.mediaType === 'photo' && '📷'}\n                                                    {question.mediaType === 'video' && '🎥'}\n                                                    {question.mediaType === 'audio' && '🎵'}\n                                                    {question.mediaType === 'document' && '📄'}\n                                                    {question.mediaType}\n                                                  </span>\n                                                ) : (\n                                                  <span className=\"text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-1.5 py-0.5 rounded\">\n                                                    {question.nodeType}\n                                                  </span>\n                                                )}\n                                                <span className=\"text-xs\">{question.name}</span>\n                                              </label>\n                                            </div>\n                                          );\n                                        })}\n                                      </div>\n                                    </div>\n                                    \n                                    {/* Logic Operator Selection for Multiple Questions */}\n                                    {(condition.variableNames?.length || 0) > 1 && (\n                                      <div>\n                                        <Label className=\"text-xs font-medium text-muted-foreground mb-1 block\">\n                                          Логика проверки нескольких вопросов:\n                                        </Label>\n                                        <Select\n                                          value={condition.logicOperator || 'AND'}\n                                          onValueChange={(value: 'AND' | 'OR') => {\n                                            const currentConditions = selectedNode.data.conditionalMessages || [];\n                                            const updatedConditions = currentConditions.map(c => \n                                              c.id === condition.id ? { ...c, logicOperator: value } : c\n                                            );\n                                            onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                          }}\n                                        >\n                                          <SelectTrigger className=\"text-xs\">\n                                            <SelectValue />\n                                          </SelectTrigger>\n                                          <SelectContent>\n                                            <SelectItem value=\"AND\">И (AND) - все выбранные вопросы</SelectItem>\n                                            <SelectItem value=\"OR\">ИЛИ (OR) - любой из выбранных вопросов</SelectItem>\n                                          </SelectContent>\n                                        </Select>\n                                        <div className=\"text-xs text-muted-foreground mt-1\">\n                                          {condition.logicOperator === 'AND' \n                                            ? 'Пользователь должен ответить на ВСЕ выбранные вопросы'\n                                            : 'Пользователь должен ответить на ЛЮБОЙ из выбранных вопросов'\n                                          }\n                                        </div>\n                                      </div>\n                                    )}\n                                    \n                                    {/* Manual Input for Additional Questions */}\n                                    <div>\n                                      <Label className=\"text-xs font-medium text-muted-foreground mb-1 block\">\n                                        Или добавьте вопросы вручную:\n                                      </Label>\n                                      <Input\n                                        value={(condition.variableNames || []).join(', ')}\n                                        onChange={(e) => {\n                                          const currentConditions = selectedNode.data.conditionalMessages || [];\n                                          const variableNames = e.target.value.split(',').map(name => name.trim()).filter(name => name);\n                                          const updatedConditions = currentConditions.map(c => \n                                            c.id === condition.id ? { \n                                              ...c, \n                                              variableNames: variableNames,\n                                              variableName: variableNames.length > 0 ? variableNames[0] : ''\n                                            } : c\n                                          );\n                                          onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                        }}\n                                        className=\"text-xs\"\n                                        placeholder=\"имя, пол, возраст (через запятую)\"\n                                      />\n                                      <div className=\"text-xs text-muted-foreground mt-1\">\n                                        Введите названия вопросов через запятую\n                                      </div>\n                                    </div>\n                                  </div>\n                                ) : (\n                                  <div className=\"text-center py-4 text-muted-foreground bg-muted/30 rounded-lg border border-border/50\">\n                                    <i className=\"fas fa-question-circle text-lg mb-2\"></i>\n                                    <div className=\"text-xs\">\n                                      Нет доступных вопросов. Создайте узлы с пользовательским вводом.\n                                    </div>\n                                  </div>\n                                )}\n                                \n                                {/* Display Selected Questions */}\n                                {(condition.variableNames?.length || 0) > 0 && (\n                                  <div className=\"bg-green-50/50 dark:bg-green-950/20 border border-green-200/40 dark:border-green-800/40 rounded-lg p-2\">\n                                    <div className=\"text-xs font-medium text-green-700 dark:text-green-300 mb-1\">\n                                      Выбранные вопросы ({condition.variableNames?.length || 0}):\n                                    </div>\n                                    <div className=\"flex flex-wrap gap-1\">\n                                      {(condition.variableNames || []).map((name, idx) => (\n                                        <span key={idx} className=\"text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-2 py-0.5 rounded-full\">\n                                          {name}\n                                        </span>\n                                      ))}\n                                    </div>\n                                  </div>\n                                )}\n                              </div>\n                            )}\n\n                            {/* Expected Value */}\n                            {(condition.condition === 'user_data_equals' || \n                              condition.condition === 'user_data_contains') && (\n                              <div>\n                                <Label className=\"text-xs font-medium text-muted-foreground mb-1 block\">\n                                  {condition.condition === 'user_data_equals' \n                                    ? 'Какой должен быть точный ответ пользователя?' \n                                    : 'Какой текст должен содержаться в ответе?'}\n                                </Label>\n                                <Input\n                                  value={condition.expectedValue || ''}\n                                  onChange={(e) => {\n                                    const currentConditions = selectedNode.data.conditionalMessages || [];\n                                    const updatedConditions = currentConditions.map(c => \n                                      c.id === condition.id ? { ...c, expectedValue: e.target.value } : c\n                                    );\n                                    onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                  }}\n                                  className=\"text-xs\"\n                                  placeholder={condition.condition === 'user_data_equals' ? 'Реклама' : 'рекл'}\n                                />\n                                <div className=\"text-xs text-muted-foreground mt-1\">\n                                  {condition.condition === 'user_data_equals' \n                                    ? 'Например: \"Реклама\", \"Мужской\", \"25\"' \n                                    : 'Например: \"рекл\" найдет \"Реклама\", \"реклама в интернете\"'}\n                                </div>\n                              </div>\n                            )}\n\n\n\n                            {/* Message Text with Formatting */}\n                            <div>\n                              <Label className=\"text-xs font-medium text-muted-foreground mb-1 block\">\n                                Что показать пользователю, если условие выполнится?\n                              </Label>\n                              \n                              {/* Format Mode Selection */}\n                              <div className=\"mb-2\">\n                                <Select\n                                  value={condition.formatMode || 'text'}\n                                  onValueChange={(value: 'text' | 'markdown' | 'html') => {\n                                    const currentConditions = selectedNode.data.conditionalMessages || [];\n                                    const updatedConditions = currentConditions.map(c => \n                                      c.id === condition.id ? { ...c, formatMode: value } : c\n                                    );\n                                    onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                  }}\n                                >\n                                  <SelectTrigger className=\"text-xs h-7\">\n                                    <SelectValue />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value=\"text\">Обычный текст</SelectItem>\n                                    <SelectItem value=\"markdown\">Markdown форматирование</SelectItem>\n                                    <SelectItem value=\"html\">HTML форматирование</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </div>\n\n                              {/* Rich Text Editor for conditional message */}\n                              <InlineRichEditor\n                                value={condition.messageText}\n                                onChange={(value) => {\n                                  const currentConditions = selectedNode.data.conditionalMessages || [];\n                                  const updatedConditions = currentConditions.map(c => \n                                    c.id === condition.id ? { ...c, messageText: value } : c\n                                  );\n                                  onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                }}\n                                placeholder=\"Добро пожаловать обратно! Рады вас снова видеть.\"\n                                enableMarkdown={condition.formatMode === 'markdown'}\n                                onMarkdownToggle={(enabled) => {\n                                  const currentConditions = selectedNode.data.conditionalMessages || [];\n                                  const updatedConditions = currentConditions.map(c => \n                                    c.id === condition.id ? { ...c, formatMode: (enabled ? 'markdown' : 'text') as 'text' | 'markdown' | 'html' } : c\n                                  );\n                                  onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                }}\n                                availableVariables={textVariables}\n                              />\n                              \n\n                              \n                              <div className=\"text-xs text-muted-foreground mt-1\">\n                                Если не указано, будет использоваться основной текст узла\n                              </div>\n                            </div>\n\n                            {/* Text Input Configuration */}\n                            <div className=\"border border-blue-200/50 dark:border-blue-800/50 rounded-lg p-3 bg-blue-50/30 dark:bg-blue-950/20\">\n                              <div className=\"flex items-center justify-between mb-2\">\n                                <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 flex items-center\">\n                                  <i className=\"fas fa-keyboard mr-1\"></i>\n                                  Ожидание текстового ввода\n                                </Label>\n                                <Switch\n                                  checked={condition.waitForTextInput ?? false}\n                                  onCheckedChange={(checked) => {\n                                    const currentConditions = selectedNode.data.conditionalMessages || [];\n                                    const updatedConditions = currentConditions.map(c => \n                                      c.id === condition.id ? { ...c, waitForTextInput: checked } : c\n                                    );\n                                    onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                  }}\n                                />\n                              </div>\n                              {condition.waitForTextInput && (\n                                <div className=\"space-y-2\">\n                                  <div className=\"text-xs text-blue-600 dark:text-blue-400\">\n                                    После показа этого сообщения бот будет ждать текстовый ответ от пользователя\n                                  </div>\n                                  <div>\n                                    <Label className=\"text-xs font-medium text-muted-foreground mb-1 block\">\n                                      Переменная для сохранения ответа (необязательно)\n                                    </Label>\n                                    <Input\n                                      value={condition.textInputVariable || ''}\n                                      onChange={(e) => {\n                                        const currentConditions = selectedNode.data.conditionalMessages || [];\n                                        const updatedConditions = currentConditions.map(c => \n                                          c.id === condition.id ? { ...c, textInputVariable: e.target.value } : c\n                                        );\n                                        onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                      }}\n                                      className=\"text-xs\"\n                                      placeholder=\"conditional_answer\"\n                                    />\n                                    <div className=\"text-xs text-muted-foreground mt-1\">\n                                      Если не указать, будет использовано автоматическое имя переменной\n                                    </div>\n                                  </div>\n                                  <div>\n                                    <Label className=\"text-xs font-medium text-muted-foreground mb-2 block\">\n                                      Куда перейти после ответа\n                                    </Label>\n                                    <div className=\"space-y-2\">\n                                      <Select\n                                        value={condition.nextNodeAfterInput || 'no-transition'}\n                                        onValueChange={(value) => {\n                                          const currentConditions = selectedNode.data.conditionalMessages || [];\n                                          const updatedConditions = currentConditions.map(c => \n                                            c.id === condition.id ? { ...c, nextNodeAfterInput: value === 'no-transition' ? undefined : value } : c\n                                          );\n                                          onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                        }}\n                                      >\n                                        <SelectTrigger className=\"text-xs h-8\">\n                                          <SelectValue placeholder=\"Выберите следующий шаг\" />\n                                        </SelectTrigger>\n                                        <SelectContent>\n                                          <SelectItem value=\"no-transition\">Не переходить</SelectItem>\n                                          {getAllNodesFromAllSheets.filter(n => n.node.id !== selectedNode.id).map(({node, sheetName}) => {\n                                            const nodeLabel = node.data.label || \n                                              (node.type === 'command' ? `Команда: ${node.data.command}` : \n                                               node.type === 'message' ? `Сообщение: ${(node.data.messageText || '').slice(0, 30)}...` :\n                                               `${node.type} (${node.id.slice(-8)})`);\n                                            return (\n                                              <SelectItem key={node.id} value={node.id}>\n                                                <div className=\"flex items-center gap-2\">\n                                                  <span className=\"text-xs text-muted-foreground\">{node.type}</span>\n                                                  <span>{nodeLabel}</span>\n                                                  <span className=\"text-xs text-blue-600 dark:text-blue-400\">({sheetName})</span>\n                                                </div>\n                                              </SelectItem>\n                                            );\n                                          })}\n                                        </SelectContent>\n                                      </Select>\n                                      \n                                      <div className=\"text-xs text-muted-foreground mb-1\">\n                                        Или введите ID узла вручную (например: ylObKToWFsIl-opIcowPZ)\n                                      </div>\n                                      <Input\n                                        value={condition.nextNodeAfterInput && condition.nextNodeAfterInput !== 'no-transition' ? condition.nextNodeAfterInput : ''}\n                                        onChange={(e) => {\n                                          const currentConditions = selectedNode.data.conditionalMessages || [];\n                                          const updatedConditions = currentConditions.map(c => \n                                            c.id === condition.id ? { ...c, nextNodeAfterInput: e.target.value || undefined } : c\n                                          );\n                                          onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                        }}\n                                        className=\"text-xs h-8\"\n                                        placeholder=\"Введите ID узла вручную\"\n                                      />\n                                    </div>\n                                    <div className=\"text-xs text-muted-foreground mt-2\">\n                                      Узел, к которому перейти после получения ответа пользователя\n                                    </div>\n                                  </div>\n                                </div>\n                              )}\n                            </div>\n\n                            {/* Keyboard Configuration for Conditional Messages */}\n                            <div className=\"space-y-3 border-t border-purple-200/30 dark:border-purple-800/30 pt-3\">\n                              <div className=\"flex items-center justify-between\">\n                                <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300\">\n                                  <i className=\"fas fa-keyboard mr-1\"></i>\n                                  Кнопки для условного сообщения\n                                </Label>\n                                <Select\n                                  value={condition.keyboardType || 'none'}\n                                  onValueChange={(value: 'none' | 'inline' | 'reply') => {\n                                    const currentConditions = selectedNode.data.conditionalMessages || [];\n                                    const updatedConditions = currentConditions.map(c => \n                                      c.id === condition.id ? { ...c, keyboardType: value } : c\n                                    );\n                                    onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                  }}\n                                >\n                                  <SelectTrigger className=\"text-xs h-7 w-32\">\n                                    <SelectValue />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value=\"none\">Без кнопок</SelectItem>\n                                    <SelectItem value=\"inline\">Inline кнопки</SelectItem>\n                                    <SelectItem value=\"reply\">Reply кнопки</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </div>\n\n                              {/* Buttons Configuration */}\n                              {condition.keyboardType && condition.keyboardType !== 'none' && (\n                                <div className=\"space-y-3\">\n                                  <div className=\"flex items-center justify-between\">\n                                    <span className=\"text-sm font-medium text-purple-700 dark:text-purple-300\">\n                                      Кнопки ({(condition.buttons || []).length})\n                                    </span>\n                                    <UIButton\n                                      size=\"sm\"\n                                      variant=\"outline\"\n                                      onClick={() => {\n                                        const newButton = {\n                                          id: nanoid(),\n                                          text: 'Новая кнопка',\n                                          action: 'goto' as const,\n                                          target: '',\n                                          url: '',\n                                          buttonType: 'normal' as const,\n                                          skipDataCollection: false\n                                        };\n                                        const currentConditions = selectedNode.data.conditionalMessages || [];\n                                        const updatedConditions = currentConditions.map(c => \n                                          c.id === condition.id ? { \n                                            ...c, \n                                            buttons: [...(c.buttons || []), newButton] \n                                          } : c\n                                        );\n                                        onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                      }}\n                                      className=\"text-sm\"\n                                    >\n                                      <i className=\"fas fa-plus mr-2\"></i>\n                                      Добавить кнопку\n                                    </UIButton>\n                                  </div>\n\n                                  {/* Buttons List */}\n                                  <div className=\"space-y-3\">\n                                    {(condition.buttons || []).map((button, buttonIndex) => (\n                                      <div key={button.id} className=\"bg-white dark:bg-gray-900/50 rounded-lg p-4 border-2 border-purple-200/40 dark:border-purple-800/40 shadow-sm\">\n                                        <div className=\"space-y-3\">\n                                          <div className=\"space-y-2\">\n                                            <div className=\"flex items-center justify-between gap-2\">\n                                              <Label className=\"text-sm font-medium text-foreground\">\n                                                Текст кнопки\n                                              </Label>\n                                              <div className=\"flex items-center gap-1\">\n                                                <DropdownMenu>\n                                                  <DropdownMenuTrigger asChild>\n                                                    <UIButton\n                                                      size=\"sm\"\n                                                      variant=\"outline\"\n                                                      className=\"h-7 text-xs gap-1\"\n                                                      title=\"Вставить переменную\"\n                                                    >\n                                                      <Plus className=\"h-3 w-3\" />\n                                                      <span className=\"hidden sm:inline\">Переменная</span>\n                                                    </UIButton>\n                                                  </DropdownMenuTrigger>\n                                              <DropdownMenuContent align=\"end\" className=\"w-56\">\n                                                <DropdownMenuLabel className=\"text-xs\">\n                                                  Доступные переменные\n                                                </DropdownMenuLabel>\n                                                <DropdownMenuSeparator />\n                                                {textVariables.map((variable, index) => {\n                                                  const getBadgeText = () => {\n                                                    if (variable.nodeType === 'user-input') return 'Ввод';\n                                                    if (variable.nodeType === 'start') return 'Команда';\n                                                    if (variable.nodeType === 'command') return 'Команда';\n                                                    if (variable.nodeType === 'system') return 'Система';\n                                                    if (variable.nodeType === 'conditional') return 'Условие';\n                                                    return 'Другое';\n                                                  };\n                                                  \n                                                  return (\n                                                    <DropdownMenuItem\n                                                      key={`${variable.nodeId}-${variable.name}-${index}`}\n                                                      onClick={() => {\n                                                        const currentConditions = selectedNode.data.conditionalMessages || [];\n                                                        const currentText = button.text || '';\n                                                        const newText = currentText + `{${variable.name}}`;\n                                                        const updatedConditions = currentConditions.map(c => \n                                                          c.id === condition.id ? {\n                                                            ...c,\n                                                            buttons: (c.buttons || []).map((b, i) => \n                                                              i === buttonIndex ? { ...b, text: newText } : b\n                                                            )\n                                                          } : c\n                                                        );\n                                                        onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                                      }}\n                                                      className=\"cursor-pointer\"\n                                                    >\n                                                      <div className=\"flex flex-col gap-1 w-full\">\n                                                        <div className=\"flex items-center gap-2\">\n                                                          <code className=\"text-xs bg-muted px-1 py-0.5 rounded\">\n                                                            {`{${variable.name}}`}\n                                                          </code>\n                                                          <Badge variant=\"outline\" className=\"text-xs h-4\">\n                                                            {getBadgeText()}\n                                                          </Badge>\n                                                        </div>\n                                                        {variable.description && (\n                                                          <div className=\"text-xs text-muted-foreground\">\n                                                            {variable.description}\n                                                          </div>\n                                                        )}\n                                                      </div>\n                                                    </DropdownMenuItem>\n                                                  );\n                                                })}\n                                                {textVariables.length === 0 && (\n                                                  <DropdownMenuItem disabled>\n                                                    <span className=\"text-xs text-muted-foreground\">\n                                                      Нет доступных переменных\n                                                    </span>\n                                                  </DropdownMenuItem>\n                                                )}\n                                              </DropdownMenuContent>\n                                                </DropdownMenu>\n                                                <UIButton\n                                                  size=\"sm\"\n                                                  variant=\"ghost\"\n                                                  onClick={() => {\n                                                    const currentConditions = selectedNode.data.conditionalMessages || [];\n                                                    const updatedConditions = currentConditions.map(c => \n                                                      c.id === condition.id ? {\n                                                        ...c,\n                                                        buttons: (c.buttons || []).filter((_, i) => i !== buttonIndex)\n                                                      } : c\n                                                    );\n                                                    onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                                  }}\n                                                  className=\"h-7 text-destructive hover:text-destructive/80\"\n                                                  title=\"Удалить кнопку\"\n                                                >\n                                                  <i className=\"fas fa-trash text-xs\"></i>\n                                                </UIButton>\n                                              </div>\n                                            </div>\n                                            <Input\n                                              value={button.text}\n                                              onChange={(e) => {\n                                                const currentConditions = selectedNode.data.conditionalMessages || [];\n                                                const updatedConditions = currentConditions.map(c => \n                                                  c.id === condition.id ? {\n                                                    ...c,\n                                                    buttons: (c.buttons || []).map((b, i) => \n                                                      i === buttonIndex ? { ...b, text: e.target.value } : b\n                                                    )\n                                                  } : c\n                                                );\n                                                onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                              }}\n                                              className=\"h-10\"\n                                              placeholder=\"Введите текст кнопки\"\n                                            />\n                                            <div className=\"text-sm text-muted-foreground\">\n                                              Переменные в тексте заменятся на значения: {'{возраст}'} → \"25\"\n                                            </div>\n                                          </div>\n\n                                          {/* Button Action Configuration */}\n                                          <div className=\"space-y-2\">\n                                            <Label className=\"text-sm font-medium text-foreground\">\n                                              Действие кнопки\n                                            </Label>\n                                            <Select\n                                              value={button.action || 'goto'}\n                                              onValueChange={(value: 'goto' | 'url' | 'command' | 'selection') => {\n                                                const currentConditions = selectedNode.data.conditionalMessages || [];\n                                                const updatedConditions = currentConditions.map(c => \n                                                  c.id === condition.id ? {\n                                                    ...c,\n                                                    buttons: (c.buttons || []).map((b, i) => \n                                                      i === buttonIndex ? { ...b, action: value } : b\n                                                    )\n                                                  } : c\n                                                );\n                                                onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                              }}\n                                            >\n                                              <SelectTrigger className=\"h-10\">\n                                                <SelectValue />\n                                              </SelectTrigger>\n                                              <SelectContent>\n                                                <SelectItem value=\"goto\">Перейти к узлу</SelectItem>\n                                                <SelectItem value=\"url\">Открыть ссылку</SelectItem>\n                                                <SelectItem value=\"command\">Выполнить команду</SelectItem>\n                                                <SelectItem value=\"selection\">Выбор опции</SelectItem>\n                                              </SelectContent>\n                                            </Select>\n\n                                            {button.action === 'goto' && (\n                                              <Select\n                                                value={button.target || ''}\n                                                onValueChange={(value) => {\n                                                  const currentConditions = selectedNode.data.conditionalMessages || [];\n                                                  const updatedConditions = currentConditions.map(c => \n                                                    c.id === condition.id ? {\n                                                      ...c,\n                                                      buttons: (c.buttons || []).map((b, i) => \n                                                        i === buttonIndex ? { ...b, target: value } : b\n                                                      )\n                                                    } : c\n                                                  );\n                                                  onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                                }}\n                                              >\n                                                <SelectTrigger className=\"h-10\">\n                                                  <SelectValue placeholder=\"Выберите узел\" />\n                                                </SelectTrigger>\n                                              <SelectContent>\n                                                {getAllNodesFromAllSheets\n                                                  .filter(n => n.node.id !== selectedNode.id)\n                                                  .map(({node, sheetName}) => {\n                                                    const nodeName = \n                                                      node.type === 'start' ? node.data.command :\n                                                      node.type === 'command' ? node.data.command :\n                                                      node.data.messageText?.slice(0, 30) + '...' || `${node.type} ${node.id}`;\n                                                    return (\n                                                      <SelectItem key={node.id} value={node.id}>\n                                                        <div className=\"flex items-center gap-2\">\n                                                          <span>{nodeName}</span>\n                                                          <span className=\"text-xs text-blue-600 dark:text-blue-400\">({sheetName})</span>\n                                                        </div>\n                                                      </SelectItem>\n                                                    );\n                                                  })}\n                                              </SelectContent>\n                                            </Select>\n                                          )}\n\n                                            {button.action === 'url' && (\n                                              <Input\n                                                value={button.url || ''}\n                                                onChange={(e) => {\n                                                  const currentConditions = selectedNode.data.conditionalMessages || [];\n                                                  const updatedConditions = currentConditions.map(c => \n                                                    c.id === condition.id ? {\n                                                      ...c,\n                                                      buttons: (c.buttons || []).map((b, i) => \n                                                        i === buttonIndex ? { ...b, url: e.target.value } : b\n                                                      )\n                                                    } : c\n                                                  );\n                                                  onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                                }}\n                                                className=\"h-10\"\n                                                placeholder=\"https://example.com\"\n                                              />\n                                            )}\n\n                                            {button.action === 'command' && (\n                                              <Input\n                                                value={button.target || ''}\n                                                onChange={(e) => {\n                                                  const currentConditions = selectedNode.data.conditionalMessages || [];\n                                                  const updatedConditions = currentConditions.map(c => \n                                                    c.id === condition.id ? {\n                                                      ...c,\n                                                      buttons: (c.buttons || []).map((b, i) => \n                                                        i === buttonIndex ? { ...b, target: e.target.value } : b\n                                                      )\n                                                    } : c\n                                                  );\n                                                  onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                                }}\n                                                className=\"h-10\"\n                                                placeholder=\"/help\"\n                                              />\n                                            )}\n                                          </div>\n                                        </div>\n                                      </div>\n                                    ))}\n                                  </div>\n\n                                  {/* Reply Keyboard Settings */}\n                                  {condition.keyboardType === 'reply' && (\n                                    <div className=\"grid grid-cols-2 gap-3 pt-2 border-t border-purple-200/20 dark:border-purple-800/20\">\n                                      <div className=\"flex items-center space-x-2\">\n                                        <Switch\n                                          checked={condition.resizeKeyboard ?? true}\n                                          onCheckedChange={(checked) => {\n                                            const currentConditions = selectedNode.data.conditionalMessages || [];\n                                            const updatedConditions = currentConditions.map(c => \n                                              c.id === condition.id ? { ...c, resizeKeyboard: checked } : c\n                                            );\n                                            onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                          }}\n                                        />\n                                        <Label className=\"text-xs text-purple-600 dark:text-purple-400\">Авто-размер</Label>\n                                      </div>\n                                      <div className=\"flex items-center space-x-2\">\n                                        <Switch\n                                          checked={condition.oneTimeKeyboard ?? false}\n                                          onCheckedChange={(checked) => {\n                                            const currentConditions = selectedNode.data.conditionalMessages || [];\n                                            const updatedConditions = currentConditions.map(c => \n                                              c.id === condition.id ? { ...c, oneTimeKeyboard: checked } : c\n                                            );\n                                            onNodeUpdate(selectedNode.id, { conditionalMessages: updatedConditions });\n                                          }}\n                                        />\n                                        <Label className=\"text-xs text-purple-600 dark:text-purple-400\">Скрыть после использования</Label>\n                                      </div>\n                                    </div>\n                                  )}\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n                          );\n                        }\n                      )}\n\n                      {(selectedNode.data.conditionalMessages || []).length === 0 && (\n                        <div className=\"text-center py-6 text-muted-foreground\">\n                          <i className=\"fas fa-plus-circle text-2xl mb-2\"></i>\n                          <div className=\"text-xs\">\n                            Нажмите \"Добавить условие\" чтобы создать первое условное сообщение\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Fallback Message */}\n                  <div>\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                      Что показать, если ни одно правило не подошло?\n                    </Label>\n                    <Textarea\n                      value={selectedNode.data.fallbackMessage || ''}\n                      onChange={(e) => onNodeUpdate(selectedNode.id, { fallbackMessage: e.target.value })}\n                      className=\"text-xs resize-none border-purple-200 dark:border-purple-700\"\n                      rows={3}\n                      placeholder=\"Оставьте пустым, чтобы показать основной текст узла\"\n                    />\n                    <div className=\"text-xs text-muted-foreground mt-1\">\n                      Если не заполнить, покажется обычный текст сообщения\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* User Input Configuration */}\n        {selectedNode.data.collectUserInput && (\n          <div className=\"space-y-6\">\n            {/* Input Configuration Section */}\n            <div className=\"bg-gradient-to-br from-purple-50/50 to-violet-50/30 dark:from-purple-950/20 dark:to-violet-950/10 border border-purple-200/30 dark:border-purple-800/30 rounded-lg p-4\">\n              <div className=\"flex items-center space-x-2 mb-3\">\n                <div className=\"w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center\">\n                  <i className=\"fas fa-comments text-purple-600 dark:text-purple-400 text-xs\"></i>\n                </div>\n                <Label className=\"text-sm font-semibold text-purple-900 dark:text-purple-100\">Настройки сбора ввода</Label>\n              </div>\n              \n              <div className=\"space-y-4\">\n                {/* Enable/Disable Input Collection Toggle */}\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-purple-200/30 dark:border-purple-800/30 hover:border-purple-300 dark:hover:border-purple-700 transition-all duration-200\">\n                  <div className=\"flex-1\">\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300\">\n                      Дополнительный сбор ответов\n                    </Label>\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      Обычные кнопки работают как прежде + дополнительно сохраняются ответы пользователей\n                    </div>\n                  </div>\n                  <div className=\"ml-4\">\n                    <Switch\n                      checked={selectedNode.data.collectUserInput ?? false}\n                      onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { collectUserInput: checked })}\n                    />\n                  </div>\n                </div>\n\n                {/* Text Input Toggle */}\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-purple-200/30 dark:border-purple-800/30 hover:border-purple-300 dark:hover:border-purple-700 transition-all duration-200\">\n                  <div className=\"flex-1\">\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300\">\n                      <i className=\"fas fa-keyboard mr-1\"></i>\n                      Текстовый ввод\n                    </Label>\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      Если выбран текстовый ввод, то как варианты ответа воспринимаются и кнопки и текстовой ввод\n                    </div>\n                  </div>\n                  <div className=\"ml-4\">\n                    <Switch\n                      checked={selectedNode.data.enableTextInput ?? false}\n                      onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableTextInput: checked })}\n                    />\n                  </div>\n                </div>\n\n                {/* Photo Input Toggle */}\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-purple-200/30 dark:border-purple-800/30 hover:border-purple-300 dark:hover:border-purple-700 transition-all duration-200\">\n                  <div className=\"flex-1\">\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300\">\n                      <i className=\"fas fa-image mr-1\"></i>\n                      Ввод фото\n                    </Label>\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      Бот будет ожидать фото от пользователя и сохранит file_id в переменную\n                    </div>\n                  </div>\n                  <div className=\"ml-4\">\n                    <Switch\n                      checked={selectedNode.data.enablePhotoInput ?? false}\n                      onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enablePhotoInput: checked })}\n                    />\n                  </div>\n                </div>\n\n                {/* Photo Input Variable */}\n                {selectedNode.data.enablePhotoInput && (\n                  <div>\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                      <i className=\"fas fa-tag mr-1\"></i>\n                      Переменная для фото\n                    </Label>\n                    <Input\n                      value={selectedNode.data.photoInputVariable || ''}\n                      onChange={(e) => onNodeUpdate(selectedNode.id, { photoInputVariable: e.target.value })}\n                      className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                      placeholder=\"user_photo\"\n                    />\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      В эту переменную сохранится file_id фото для использования в последующих сообщениях\n                    </div>\n                  </div>\n                )}\n\n                {/* Video Input Toggle */}\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-purple-200/30 dark:border-purple-800/30 hover:border-purple-300 dark:hover:border-purple-700 transition-all duration-200\">\n                  <div className=\"flex-1\">\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300\">\n                      <i className=\"fas fa-video mr-1\"></i>\n                      Ввод видео\n                    </Label>\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      Бот будет ожидать видео от пользователя и сохранит file_id в переменную\n                    </div>\n                  </div>\n                  <div className=\"ml-4\">\n                    <Switch\n                      checked={selectedNode.data.enableVideoInput ?? false}\n                      onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableVideoInput: checked })}\n                    />\n                  </div>\n                </div>\n\n                {/* Video Input Variable */}\n                {selectedNode.data.enableVideoInput && (\n                  <div>\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                      <i className=\"fas fa-tag mr-1\"></i>\n                      Переменная для видео\n                    </Label>\n                    <Input\n                      value={selectedNode.data.videoInputVariable || ''}\n                      onChange={(e) => onNodeUpdate(selectedNode.id, { videoInputVariable: e.target.value })}\n                      className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                      placeholder=\"user_video\"\n                    />\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      В эту переменную сохранится file_id видео для использования в последующих сообщениях\n                    </div>\n                  </div>\n                )}\n\n                {/* Audio Input Toggle */}\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-purple-200/30 dark:border-purple-800/30 hover:border-purple-300 dark:hover:border-purple-700 transition-all duration-200\">\n                  <div className=\"flex-1\">\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300\">\n                      <i className=\"fas fa-music mr-1\"></i>\n                      Ввод аудио\n                    </Label>\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      Бот будет ожидать аудио от пользователя и сохранит file_id в переменную\n                    </div>\n                  </div>\n                  <div className=\"ml-4\">\n                    <Switch\n                      checked={selectedNode.data.enableAudioInput ?? false}\n                      onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableAudioInput: checked })}\n                    />\n                  </div>\n                </div>\n\n                {/* Audio Input Variable */}\n                {selectedNode.data.enableAudioInput && (\n                  <div>\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                      <i className=\"fas fa-tag mr-1\"></i>\n                      Переменная для аудио\n                    </Label>\n                    <Input\n                      value={selectedNode.data.audioInputVariable || ''}\n                      onChange={(e) => onNodeUpdate(selectedNode.id, { audioInputVariable: e.target.value })}\n                      className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                      placeholder=\"user_audio\"\n                    />\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      В эту переменную сохранится file_id аудио для использования в последующих сообщениях\n                    </div>\n                  </div>\n                )}\n\n                {/* Document Input Toggle */}\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-purple-200/30 dark:border-purple-800/30 hover:border-purple-300 dark:hover:border-purple-700 transition-all duration-200\">\n                  <div className=\"flex-1\">\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300\">\n                      <i className=\"fas fa-file mr-1\"></i>\n                      Ввод документа\n                    </Label>\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      Бот будет ожидать документ от пользователя и сохранит file_id в переменную\n                    </div>\n                  </div>\n                  <div className=\"ml-4\">\n                    <Switch\n                      checked={selectedNode.data.enableDocumentInput ?? false}\n                      onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableDocumentInput: checked })}\n                    />\n                  </div>\n                </div>\n\n                {/* Document Input Variable */}\n                {selectedNode.data.enableDocumentInput && (\n                  <div>\n                    <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                      <i className=\"fas fa-tag mr-1\"></i>\n                      Переменная для документа\n                    </Label>\n                    <Input\n                      value={selectedNode.data.documentInputVariable || ''}\n                      onChange={(e) => onNodeUpdate(selectedNode.id, { documentInputVariable: e.target.value })}\n                      className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                      placeholder=\"user_document\"\n                    />\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\n                      В эту переменную сохранится file_id документа для использования в последующих сообщениях\n                    </div>\n                  </div>\n                )}\n\n                <div>\n                  <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                    <i className=\"fas fa-code mr-1\"></i>\n                    Имя переменной\n                  </Label>\n                  <Input\n                    value={selectedNode.data.inputVariable || ''}\n                    onChange={(e) => onNodeUpdate(selectedNode.id, { inputVariable: e.target.value })}\n                    className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                    placeholder=\"user_response\"\n                  />\n                </div>\n\n                {/* Target Node */}\n                <div>\n                  <Label className=\"text-xs font-medium text-purple-700 dark:text-purple-300 mb-2 block\">\n                    <i className=\"fas fa-arrow-right mr-1\"></i>\n                    Куда перейти после ответа\n                  </Label>\n                  <Select\n                    value={selectedNode.data.inputTargetNodeId || ''}\n                    onValueChange={(value) => onNodeUpdate(selectedNode.id, { inputTargetNodeId: value })}\n                  >\n                    <SelectTrigger className=\"border-purple-200 dark:border-purple-700 focus:border-purple-500\">\n                      <SelectValue placeholder=\"Выберите следующий шаг\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {/* Команды из всех листов */}\n                      {getAllNodesFromAllSheets\n                        .filter(({ node }) => node.id !== selectedNode.id && (node.type === 'start' || node.type === 'command'))\n                        .map(({ node, sheetId, sheetName }) => (\n                          <SelectItem key={`${sheetId}-${node.id}`} value={node.id}>\n                            <div className=\"flex items-center gap-2\">\n                              <i className=\"fas fa-terminal text-xs text-purple-500\"></i>\n                              <span>{node.data.command}</span>\n                              {sheetId !== currentSheetId && (\n                                <span className=\"text-xs text-muted-foreground bg-purple-100 dark:bg-purple-900/30 px-1 rounded\">\n                                  📋 {sheetName}\n                                </span>\n                              )}\n                            </div>\n                          </SelectItem>\n                        ))}\n                      \n                      {/* Другие узлы из всех листов */}\n                      {getAllNodesFromAllSheets\n                        .filter(({ node }) => node.id !== selectedNode.id && node.type !== 'start' && node.type !== 'command')\n                        .map(({ node, sheetId, sheetName }) => {\n                          const nodeName = \n                            node.type === 'message' ? 'Сообщение' :\n                            node.type === 'photo' ? 'Фото' :\n                            node.type === 'video' ? 'Видео' :\n                            node.type === 'audio' ? 'Аудио' :\n                            node.type === 'document' ? 'Документ' :\n                            node.type === 'keyboard' ? 'Клавиатура' :\n                            node.type === 'condition' ? 'Условие' :\n                            node.type === 'input' ? 'Ввод' :\n                            node.data?.collectUserInput ? 'Сбор данных' :\n                            node.type === 'location' ? 'Геолокация' :\n                            node.type === 'contact' ? 'Контакт' :\n                            node.type === 'sticker' ? 'Стикер' :\n                            node.type === 'voice' ? 'Голосовое' :\n                            node.type === 'animation' ? 'Анимация' : 'Узел';\n                          \n                          const iconClass = \n                            node.type === 'message' ? 'fas fa-comment text-purple-500' :\n                            node.type === 'photo' ? 'fas fa-image text-purple-500' :\n                            node.type === 'video' ? 'fas fa-video text-purple-500' :\n                            node.type === 'audio' ? 'fas fa-music text-purple-500' :\n                            node.type === 'document' ? 'fas fa-file text-purple-500' :\n                            node.type === 'keyboard' ? 'fas fa-keyboard text-purple-500' :\n                            node.type === 'condition' ? 'fas fa-code-branch text-purple-500' :\n                            node.type === 'input' ? 'fas fa-edit text-purple-500' :\n                            node.data?.collectUserInput ? 'fas fa-user-edit text-purple-500' :\n                            node.type === 'location' ? 'fas fa-map-marker-alt text-purple-500' :\n                            node.type === 'contact' ? 'fas fa-address-book text-purple-500' :\n                            node.type === 'sticker' ? 'fas fa-smile text-purple-500' :\n                            node.type === 'voice' ? 'fas fa-microphone text-purple-500' :\n                            node.type === 'animation' ? 'fas fa-play-circle text-purple-500' : 'fas fa-cube text-purple-500';\n                          \n                          return (\n                            <SelectItem key={`${sheetId}-${node.id}`} value={node.id}>\n                              <div className=\"flex items-center gap-1\">\n                                <span>{nodeName} ({node.id})</span>\n                                <span className=\"text-xs text-blue-600 dark:text-blue-400\">({sheetName})</span>\n                              </div>\n                            </SelectItem>\n                          );\n                        })}\n                      \n                      {(!getAllNodesFromAllSheets || getAllNodesFromAllSheets.filter(({ node }) => node.id !== selectedNode.id).length === 0) && (\n                        <SelectItem value=\"no-nodes\" disabled>\n                          Создайте другие части бота для выбора\n                        </SelectItem>\n                      )}\n                    </SelectContent>\n                  </Select>\n                  \n                  <Input\n                    value={selectedNode.data.inputTargetNodeId || ''}\n                    onChange={(e) => onNodeUpdate(selectedNode.id, { inputTargetNodeId: e.target.value })}\n                    className=\"mt-2 text-xs border-purple-200 dark:border-purple-700 focus:border-purple-500 focus:ring-purple-200\"\n                    placeholder=\"Или введите ID узла вручную (например: ylObKToWFsIl-opIcowPZ)\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Auto Transition Section - показывать только когда нет кнопок и нет сбора данных */}\n        {selectedNode.type !== 'input' && \n         !selectedNode.data.collectUserInput && \n         (!selectedNode.data.buttons || selectedNode.data.buttons.length === 0) &&\n         selectedNode.data.keyboardType === 'none' && (\n          <div>\n            <h3 className=\"text-sm font-medium text-foreground mb-3\">⚡ Автопереход</h3>\n            <div className=\"space-y-4 bg-gradient-to-br from-emerald-50/50 to-teal-50/30 dark:from-emerald-950/20 dark:to-teal-950/10 border border-emerald-200/30 dark:border-emerald-800/30 rounded-lg p-4\">\n              <div className=\"text-xs text-muted-foreground mb-3\">\n                Сообщение будет отправлено, и бот автоматически перейдёт к следующему узлу без ожидания ответа от пользователя.\n              </div>\n              \n              <div>\n                <Label className=\"text-xs font-medium text-emerald-700 dark:text-emerald-300 mb-2 block\">\n                  <i className=\"fas fa-arrow-right mr-1\"></i>\n                  Следующий узел\n                </Label>\n                <Select\n                  value={selectedNode.data.autoTransitionTo || ''}\n                  onValueChange={(value) => onNodeUpdate(selectedNode.id, { autoTransitionTo: value })}\n                >\n                  <SelectTrigger className=\"border-emerald-200 dark:border-emerald-700 focus:border-emerald-500\">\n                    <SelectValue placeholder=\"Выберите узел для перехода\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {getAllNodesFromAllSheets\n                      .filter(({ node }) => node.id !== selectedNode.id)\n                      .map(({ node, sheetId, sheetName }) => {\n                        const nodeName = \n                          node.type === 'start' ? node.data.command :\n                          node.type === 'command' ? node.data.command :\n                          node.type === 'message' ? 'Сообщение' :\n                          node.type === 'photo' ? 'Фото' :\n                          node.type === 'video' ? 'Видео' :\n                          node.type === 'audio' ? 'Аудио' :\n                          node.type === 'document' ? 'Документ' : 'Узел';\n                        \n                        return (\n                          <SelectItem key={`${sheetId}-${node.id}`} value={node.id}>\n                            <div className=\"flex items-center gap-1\">\n                              <span>{nodeName} ({node.id})</span>\n                              {sheetId !== currentSheetId && (\n                                <span className=\"text-xs text-emerald-600 dark:text-emerald-400\">({sheetName})</span>\n                              )}\n                            </div>\n                          </SelectItem>\n                        );\n                      })}\n                    \n                    {(!getAllNodesFromAllSheets || getAllNodesFromAllSheets.filter(({ node }) => node.id !== selectedNode.id).length === 0) && (\n                      <SelectItem value=\"no-nodes\" disabled>\n                        Создайте другие части бота для выбора\n                      </SelectItem>\n                    )}\n                  </SelectContent>\n                </Select>\n                \n                <Input\n                  value={selectedNode.data.autoTransitionTo || ''}\n                  onChange={(e) => onNodeUpdate(selectedNode.id, { autoTransitionTo: e.target.value })}\n                  className=\"mt-2 text-xs border-emerald-200 dark:border-emerald-700 focus:border-emerald-500 focus:ring-emerald-200\"\n                  placeholder=\"Или введите ID узла вручную\"\n                />\n                \n                {selectedNode.data.autoTransitionTo && (\n                  <div className=\"mt-2 p-2 bg-emerald-100/50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded text-xs text-emerald-700 dark:text-emerald-300\">\n                    <i className=\"fas fa-info-circle mr-1\"></i>\n                    Бот автоматически перейдёт к узлу <strong>{selectedNode.data.autoTransitionTo}</strong> сразу после отправки этого сообщения\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Universal User Input Collection */}\n        {selectedNode.type !== 'input' && !selectedNode.data.collectUserInput && (\n          <div>\n            <h3 className=\"text-sm font-medium text-foreground mb-3\">✨ Дополнительный сбор ответов</h3>\n            <div className=\"space-y-4\">\n              {/* Enable Input Collection */}\n              <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-primary/30 hover:bg-card/80 transition-all duration-200\">\n                <div className=\"flex-1\">\n                  <Label className=\"text-xs font-medium text-foreground\">\n                    Дополнительный сбор ответов\n                  </Label>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    Обычные кнопки работают как прежде + дополнительно сохраняются ответы пользователей\n                  </div>\n                </div>\n                <div className=\"ml-4\">\n                  <Switch\n                    checked={selectedNode.data.collectUserInput ?? false}\n                    onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { collectUserInput: checked })}\n                  />\n                </div>\n              </div>\n\n              {/* Input Collection Settings */}\n              {selectedNode.data.collectUserInput && (\n                <div className=\"space-y-4 bg-gradient-to-br from-blue-50/50 to-indigo-50/30 dark:from-blue-950/20 dark:to-indigo-950/10 border border-blue-200/30 dark:border-blue-800/30 rounded-lg p-4\">\n                  \n\n                  \n                  {/* Text Input Toggle */}\n                  <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-blue-200/30 dark:border-blue-800/30 hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-200\">\n                    <div className=\"flex-1\">\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300\">\n                        <i className=\"fas fa-keyboard mr-1\"></i>\n                        Текстовый ввод\n                      </Label>\n                      <div className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                        Если выбран текстовый ввод, то как варианты ответа воспринимаются и кнопки и текстовой ввод\n                      </div>\n                    </div>\n                    <div className=\"ml-4\">\n                      <Switch\n                        checked={selectedNode.data.enableTextInput ?? false}\n                        onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableTextInput: checked })}\n                      />\n                    </div>\n                  </div>\n\n                  {/* Photo Input Toggle */}\n                  <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-blue-200/30 dark:border-blue-800/30 hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-200\">\n                    <div className=\"flex-1\">\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300\">\n                        <i className=\"fas fa-image mr-1\"></i>\n                        Ввод фото\n                      </Label>\n                      <div className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                        Бот будет ожидать фото от пользователя и сохранит file_id в переменную\n                      </div>\n                    </div>\n                    <div className=\"ml-4\">\n                      <Switch\n                        checked={selectedNode.data.enablePhotoInput ?? false}\n                        onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enablePhotoInput: checked })}\n                      />\n                    </div>\n                  </div>\n\n                  {selectedNode.data.enablePhotoInput && (\n                    <div>\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                        <i className=\"fas fa-tag mr-1\"></i>\n                        Переменная для фото\n                      </Label>\n                      <Input\n                        value={selectedNode.data.photoInputVariable || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { photoInputVariable: e.target.value })}\n                        className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                        placeholder=\"user_photo\"\n                      />\n                    </div>\n                  )}\n\n                  {/* Video Input Toggle */}\n                  <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-blue-200/30 dark:border-blue-800/30 hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-200\">\n                    <div className=\"flex-1\">\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300\">\n                        <i className=\"fas fa-video mr-1\"></i>\n                        Ввод видео\n                      </Label>\n                      <div className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                        Бот будет ожидать видео от пользователя и сохранит file_id в переменную\n                      </div>\n                    </div>\n                    <div className=\"ml-4\">\n                      <Switch\n                        checked={selectedNode.data.enableVideoInput ?? false}\n                        onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableVideoInput: checked })}\n                      />\n                    </div>\n                  </div>\n\n                  {selectedNode.data.enableVideoInput && (\n                    <div>\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                        <i className=\"fas fa-tag mr-1\"></i>\n                        Переменная для видео\n                      </Label>\n                      <Input\n                        value={selectedNode.data.videoInputVariable || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { videoInputVariable: e.target.value })}\n                        className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                        placeholder=\"user_video\"\n                      />\n                    </div>\n                  )}\n\n                  {/* Audio Input Toggle */}\n                  <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-blue-200/30 dark:border-blue-800/30 hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-200\">\n                    <div className=\"flex-1\">\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300\">\n                        <i className=\"fas fa-music mr-1\"></i>\n                        Ввод аудио\n                      </Label>\n                      <div className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                        Бот будет ожидать аудио от пользователя и сохранит file_id в переменную\n                      </div>\n                    </div>\n                    <div className=\"ml-4\">\n                      <Switch\n                        checked={selectedNode.data.enableAudioInput ?? false}\n                        onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableAudioInput: checked })}\n                      />\n                    </div>\n                  </div>\n\n                  {selectedNode.data.enableAudioInput && (\n                    <div>\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                        <i className=\"fas fa-tag mr-1\"></i>\n                        Переменная для аудио\n                      </Label>\n                      <Input\n                        value={selectedNode.data.audioInputVariable || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { audioInputVariable: e.target.value })}\n                        className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                        placeholder=\"user_audio\"\n                      />\n                    </div>\n                  )}\n\n                  {/* Document Input Toggle */}\n                  <div className=\"flex items-center justify-between p-3 rounded-lg bg-card/50 border border-blue-200/30 dark:border-blue-800/30 hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-200\">\n                    <div className=\"flex-1\">\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300\">\n                        <i className=\"fas fa-file mr-1\"></i>\n                        Ввод документа\n                      </Label>\n                      <div className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                        Бот будет ожидать документ от пользователя и сохранит file_id в переменную\n                      </div>\n                    </div>\n                    <div className=\"ml-4\">\n                      <Switch\n                        checked={selectedNode.data.enableDocumentInput ?? false}\n                        onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableDocumentInput: checked })}\n                      />\n                    </div>\n                  </div>\n\n                  {selectedNode.data.enableDocumentInput && (\n                    <div>\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                        <i className=\"fas fa-tag mr-1\"></i>\n                        Переменная для документа\n                      </Label>\n                      <Input\n                        value={selectedNode.data.documentInputVariable || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { documentInputVariable: e.target.value })}\n                        className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                        placeholder=\"user_document\"\n                      />\n                    </div>\n                  )}\n\n                  {/* Button Type for button responses */}\n                  {selectedNode.data.responseType === 'buttons' && (\n                    <div>\n                      <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                        <i className=\"fas fa-mouse mr-1\"></i>\n                        Тип кнопок\n                      </Label>\n                      <Select\n                        value={selectedNode.data.inputButtonType || 'inline'}\n                        onValueChange={(value: 'inline' | 'reply') => onNodeUpdate(selectedNode.id, { inputButtonType: value })}\n                      >\n                        <SelectTrigger className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"inline\">Inline кнопки</SelectItem>\n                          <SelectItem value=\"reply\">Reply кнопки</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  )}\n\n                  {/* Response Options for buttons */}\n                  {selectedNode.data.responseType === 'buttons' && (\n                    <div>\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300\">\n                          <i className=\"fas fa-list-ul mr-1\"></i>\n                          Варианты ответов\n                        </Label>\n                        <UIButton\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => {\n                            const newOption = {\n                              id: nanoid(),\n                              text: 'Новый вариант',\n                              value: '',\n                              action: 'goto' as const,\n                              target: ''\n                            };\n                            const updatedOptions = [...(selectedNode.data.responseOptions || []), newOption];\n                            onNodeUpdate(selectedNode.id, { responseOptions: updatedOptions });\n                          }}\n                          className=\"text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200\"\n                        >\n                          + Добавить\n                        </UIButton>\n                      </div>\n                      \n                      <div className=\"space-y-3\">\n                        {(selectedNode.data.responseOptions || []).map((option, index) => (\n                          <div key={option.id} className=\"bg-card/50 rounded-lg p-3 border border-border/50\">\n                            <div className=\"flex items-center justify-between mb-2\">\n                              <Input\n                                value={option.text}\n                                onChange={(e) => {\n                                  const updatedOptions = [...(selectedNode.data.responseOptions || [])];\n                                  updatedOptions[index] = { ...option, text: e.target.value };\n                                  onNodeUpdate(selectedNode.id, { responseOptions: updatedOptions });\n                                }}\n                                className=\"flex-1 text-sm font-medium bg-transparent border-none focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                                placeholder=\"Текст кнопки\"\n                              />\n                              <UIButton\n                                size=\"sm\"\n                                variant=\"ghost\"\n                                onClick={() => {\n                                  const updatedOptions = (selectedNode.data.responseOptions || []).filter((_, i) => i !== index);\n                                  onNodeUpdate(selectedNode.id, { responseOptions: updatedOptions });\n                                }}\n                                className=\"text-muted-foreground hover:text-destructive h-auto p-1\"\n                              >\n                                <svg className=\"w-3 h-3\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                                  <path fillRule=\"evenodd\" d=\"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z\" clipRule=\"evenodd\" />\n                                </svg>\n                              </UIButton>\n                            </div>\n                            \n                            <div className=\"space-y-2\">\n                              <div>\n                                <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-1 block\">\n                                  Значение для сохранения\n                                </Label>\n                                <Input\n                                  value={option.value || ''}\n                                  onChange={(e) => {\n                                    const updatedOptions = [...(selectedNode.data.responseOptions || [])];\n                                    updatedOptions[index] = { ...option, value: e.target.value };\n                                    onNodeUpdate(selectedNode.id, { responseOptions: updatedOptions });\n                                  }}\n                                  className=\"text-xs border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                                  placeholder=\"Значение (если пусто - используется текст кнопки)\"\n                                />\n                              </div>\n                              \n                              {/* Navigation settings for each button */}\n                              <div>\n                                <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-1 block\">\n                                  Действие кнопки\n                                </Label>\n                                <Select\n                                  value={option.action || 'goto'}\n                                  onValueChange={(value: 'goto' | 'command' | 'url' | 'selection') => {\n                                    const updatedOptions = [...(selectedNode.data.responseOptions || [])];\n                                    updatedOptions[index] = { ...option, action: value };\n                                    onNodeUpdate(selectedNode.id, { responseOptions: updatedOptions });\n                                  }}\n                                >\n                                  <SelectTrigger className=\"text-xs border-blue-200 dark:border-blue-700 focus:border-blue-500\">\n                                    <SelectValue />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value=\"goto\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <i className=\"fas fa-arrow-right text-xs text-blue-500\"></i>\n                                        <span>Перейти к экрану</span>\n                                      </div>\n                                    </SelectItem>\n                                    <SelectItem value=\"command\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <i className=\"fas fa-terminal text-xs text-purple-500\"></i>\n                                        <span>Выполнить команду</span>\n                                      </div>\n                                    </SelectItem>\n                                    <SelectItem value=\"url\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <i className=\"fas fa-external-link-alt text-xs text-green-500\"></i>\n                                        <span>Открыть ссылку</span>\n                                      </div>\n                                    </SelectItem>\n                                    <SelectItem value=\"selection\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <i className=\"fas fa-check-square text-xs text-purple-500\"></i>\n                                        <span>Выбор опции</span>\n                                      </div>\n                                    </SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </div>\n\n                              {/* Target selection based on action type */}\n                              {option.action === 'goto' && (\n                                <div>\n                                  <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-1 block\">\n                                    Выберите экран\n                                  </Label>\n                                  <Select\n                                    value={option.target || ''}\n                                    onValueChange={(value) => {\n                                      const updatedOptions = [...(selectedNode.data.responseOptions || [])];\n                                      updatedOptions[index] = { ...option, target: value };\n                                      onNodeUpdate(selectedNode.id, { responseOptions: updatedOptions });\n                                    }}\n                                  >\n                                    <SelectTrigger className=\"text-xs border-blue-200 dark:border-blue-700 focus:border-blue-500\">\n                                      <SelectValue placeholder=\"Выберите экран или введите ID вручную\" />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                      {/* Команды */}\n                                      {getAllNodesFromAllSheets\n                                        ?.filter(n => n.node.id !== selectedNode.id && (n.node.type === 'start' || n.node.type === 'command'))\n                                        .map(({node, sheetName}) => (\n                                          <SelectItem key={node.id} value={node.id}>\n                                            <div className=\"flex items-center gap-2\">\n                                              <i className=\"fas fa-terminal text-xs text-purple-500\"></i>\n                                              <span>{node.data.command}</span>\n                                              <span className=\"text-xs text-blue-600 dark:text-blue-400\">({sheetName})</span>\n                                            </div>\n                                          </SelectItem>\n                                        ))}\n                                      \n                                      {/* Другие узлы */}\n                                      {getAllNodesFromAllSheets\n                                        ?.filter(n => n.node.id !== selectedNode.id && n.node.type !== 'start' && n.node.type !== 'command')\n                                        .map(({node, sheetName}) => {\n                                          const nodeName = \n                                            node.type === 'message' ? 'Сообщение' :\n                                            node.type === 'photo' ? 'Фото' :\n                                            node.type === 'video' ? 'Видео' :\n                                            node.type === 'audio' ? 'Аудио' :\n                                            node.type === 'document' ? 'Документ' :\n                                            node.type === 'keyboard' ? 'Клавиатура' :\n                                            node.type === 'condition' ? 'Условие' :\n                                            node.data?.collectUserInput ? 'Сбор данных' :\n                                            node.data?.collectUserInput ? 'Сбор данных' :\n                                            node.type === 'location' ? 'Геолокация' :\n                                            node.type === 'contact' ? 'Контакт' :\n                                            node.type === 'sticker' ? 'Стикер' :\n                                            node.type === 'voice' ? 'Голосовое' :\n                                            node.type === 'animation' ? 'Анимация' : 'Узел';\n                                          \n                                          const iconClass = \n                                            node.type === 'message' ? 'fas fa-comment text-blue-500' :\n                                            node.type === 'photo' ? 'fas fa-image text-green-500' :\n                                            node.type === 'video' ? 'fas fa-video text-red-500' :\n                                            node.type === 'audio' ? 'fas fa-music text-orange-500' :\n                                            node.type === 'document' ? 'fas fa-file text-gray-500' :\n                                            node.type === 'keyboard' ? 'fas fa-keyboard text-yellow-500' :\n                                            node.type === 'condition' ? 'fas fa-code-branch text-purple-500' :\n                                            node.data?.collectUserInput ? 'fas fa-user-edit text-indigo-500' :\n                                            node.data?.collectUserInput ? 'fas fa-user-edit text-indigo-500' :\n                                            node.type === 'location' ? 'fas fa-map-marker-alt text-pink-500' :\n                                            node.type === 'contact' ? 'fas fa-address-book text-teal-500' :\n                                            node.type === 'sticker' ? 'fas fa-smile text-yellow-400' :\n                                            node.type === 'voice' ? 'fas fa-microphone text-blue-400' :\n                                            node.type === 'animation' ? 'fas fa-play-circle text-green-400' : 'fas fa-cube text-gray-400';\n                                          \n                                          return (\n                                            <SelectItem key={node.id} value={node.id}>\n                                              <div className=\"flex items-center gap-2\">\n                                                <i className={`${iconClass} text-xs`}></i>\n                                                <span>{nodeName}</span>\n                                                <span className=\"text-xs text-blue-600 dark:text-blue-400\">({sheetName})</span>\n                                              </div>\n                                            </SelectItem>\n                                          );\n                                        })}\n                                    </SelectContent>\n                                  </Select>\n                                  \n                                  {/* Manual ID input */}\n                                  <Input\n                                    value={option.target || ''}\n                                    onChange={(e) => {\n                                      const updatedOptions = [...(selectedNode.data.responseOptions || [])];\n                                      updatedOptions[index] = { ...option, target: e.target.value };\n                                      onNodeUpdate(selectedNode.id, { responseOptions: updatedOptions });\n                                    }}\n                                    className=\"text-xs border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200 mt-1\"\n                                    placeholder=\"или введите ID экрана вручную\"\n                                  />\n                                </div>\n                              )}\n\n                              {option.action === 'command' && (\n                                <div>\n                                  <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-1 block\">\n                                    Команда для выполнения\n                                  </Label>\n                                  <Input\n                                    value={option.target || ''}\n                                    onChange={(e) => {\n                                      const updatedOptions = [...(selectedNode.data.responseOptions || [])];\n                                      updatedOptions[index] = { ...option, target: e.target.value };\n                                      onNodeUpdate(selectedNode.id, { responseOptions: updatedOptions });\n                                    }}\n                                    className=\"text-xs border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                                    placeholder=\"например: /start, /help, /menu\"\n                                  />\n                                </div>\n                              )}\n\n                              {option.action === 'url' && (\n                                <div>\n                                  <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-1 block\">\n                                    Ссылка для открытия\n                                  </Label>\n                                  <Input\n                                    value={option.url || ''}\n                                    onChange={(e) => {\n                                      const updatedOptions = [...(selectedNode.data.responseOptions || [])];\n                                      updatedOptions[index] = { ...option, url: e.target.value };\n                                      onNodeUpdate(selectedNode.id, { responseOptions: updatedOptions });\n                                    }}\n                                    className=\"text-xs border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                                    placeholder=\"https://example.com\"\n                                  />\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Variable Name */}\n                  <div>\n                    <Label className=\"text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 block\">\n                      <i className=\"fas fa-tag mr-1\"></i>\n                      Название для ответа\n                    </Label>\n                    <Input\n                      value={selectedNode.data.inputVariable || ''}\n                      onChange={(e) => onNodeUpdate(selectedNode.id, { inputVariable: e.target.value })}\n                      className=\"border-blue-200 dark:border-blue-700 focus:border-blue-500 focus:ring-blue-200\"\n                      placeholder=\"например: имя_пользователя, почта, телефон\"\n                    />\n                    <div className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                      Под этим названием будет сохранен ответ пользователя\n                    </div>\n                  </div>\n\n\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* Command Advanced Settings */}\n        {(selectedNode.type === 'start' || selectedNode.type === 'command') && (\n          <Accordion type=\"single\" collapsible className=\"w-full\">\n            <AccordionItem value=\"advanced-settings\" className=\"border-border\">\n              <AccordionTrigger className=\"text-sm font-medium text-foreground hover:no-underline hover:text-foreground/90 transition-colors duration-200\">\n                <div className=\"flex items-center space-x-2\">\n                  <div className=\"w-4 h-4 rounded-full bg-gradient-to-r from-primary/20 to-primary/10 flex items-center justify-center\">\n                    <svg className=\"w-2.5 h-2.5 text-primary\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                      <path fillRule=\"evenodd\" d=\"M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z\" clipRule=\"evenodd\" />\n                    </svg>\n                  </div>\n                  <span className=\"bg-gradient-to-r from-foreground to-muted-foreground bg-clip-text text-transparent\">\n                    Расширенные настройки команды\n                  </span>\n                </div>\n              </AccordionTrigger>\n              <AccordionContent className=\"bg-gradient-to-br from-background to-muted/20 dark:from-background dark:to-muted/10 border border-border/50 rounded-lg mt-2 overflow-hidden\">\n                <div className=\"space-y-4 p-4\">\n                  {/* Show in Menu Setting */}\n                  <div className=\"group flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-primary/30 hover:bg-card/80 transition-all duration-200\">\n                    <div className=\"flex-1\">\n                      <Label className=\"text-xs font-medium text-foreground group-hover:text-primary transition-colors duration-200\">\n                        Показать в меню\n                      </Label>\n                      <div className=\"text-xs text-muted-foreground mt-1 leading-relaxed\">\n                        Команда появится в меню @BotFather\n                      </div>\n                    </div>\n                    <div className=\"ml-4\">\n                      <Switch\n                        checked={selectedNode.data.showInMenu ?? true}\n                        onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { showInMenu: checked })}\n                        className=\"data-[state=checked]:bg-primary\"\n                      />\n                    </div>\n                  </div>\n                  \n                  {/* Private Only Setting */}\n                  <div className=\"group flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-warning/30 hover:bg-card/80 transition-all duration-200\">\n                    <div className=\"flex-1\">\n                      <Label className=\"text-xs font-medium text-foreground group-hover:text-warning transition-colors duration-200\">\n                        Только в приватных чатах\n                      </Label>\n                      <div className=\"text-xs text-muted-foreground mt-1 leading-relaxed\">\n                        Команда работает только в диалоге с ботом\n                      </div>\n                    </div>\n                    <div className=\"ml-4\">\n                      <Switch\n                        checked={selectedNode.data.isPrivateOnly ?? false}\n                        onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { isPrivateOnly: checked })}\n                        className=\"data-[state=checked]:bg-warning\"\n                      />\n                    </div>\n                  </div>\n                  \n\n                  \n                  {/* Admin Only Setting */}\n                  <div className=\"group flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-destructive/30 hover:bg-card/80 transition-all duration-200\">\n                    <div className=\"flex-1\">\n                      <Label className=\"text-xs font-medium text-foreground group-hover:text-destructive transition-colors duration-200\">\n                        Только для администраторов\n                      </Label>\n                      <div className=\"text-xs text-muted-foreground mt-1 leading-relaxed\">\n                        Команда доступна только админам\n                      </div>\n                    </div>\n                    <div className=\"ml-4\">\n                      <Switch\n                        checked={selectedNode.data.adminOnly ?? false}\n                        onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { adminOnly: checked })}\n                        className=\"data-[state=checked]:bg-destructive\"\n                      />\n                    </div>\n                  </div>\n                </div>\n              </AccordionContent>\n            </AccordionItem>\n          </Accordion>\n        )}\n\n        <Separator />\n\n        {/* User Management Actions */}\n        <Accordion type=\"single\" collapsible className=\"w-full\">\n          <AccordionItem value=\"user-management\" className=\"border-border\">\n            <AccordionTrigger className=\"text-sm font-medium text-foreground hover:no-underline hover:text-foreground/90 transition-colors duration-200\">\n              <div className=\"flex items-center space-x-2\">\n                <div className=\"w-4 h-4 rounded-full bg-gradient-to-r from-orange-500/20 to-red-500/10 flex items-center justify-center\">\n                  <svg className=\"w-2.5 h-2.5 text-orange-600\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                    <path fillRule=\"evenodd\" d=\"M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z\" clipRule=\"evenodd\" />\n                  </svg>\n                </div>\n                <span className=\"bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent\">\n                  Действия с пользователями\n                </span>\n              </div>\n            </AccordionTrigger>\n            <AccordionContent className=\"bg-gradient-to-br from-orange-50/20 to-red-50/10 dark:from-orange-950/10 dark:to-red-950/5 border border-orange-200/30 dark:border-orange-800/20 rounded-lg mt-2 overflow-hidden\">\n              <div className=\"space-y-4 p-4\">\n                \n                {/* Enable User Actions */}\n                <div className=\"group flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-orange-300 hover:bg-card/80 transition-all duration-200\">\n                  <div className=\"flex-1\">\n                    <Label className=\"text-xs font-medium text-foreground group-hover:text-orange-600 transition-colors duration-200\">\n                      Включить действия с пользователями\n                    </Label>\n                    <div className=\"text-xs text-muted-foreground mt-1 leading-relaxed\">\n                      Автоматические действия при получении ответа\n                    </div>\n                  </div>\n                  <div className=\"ml-4\">\n                    <Switch\n                      checked={selectedNode.data.enableUserActions ?? false}\n                      onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { enableUserActions: checked })}\n                      className=\"data-[state=checked]:bg-orange-500\"\n                    />\n                  </div>\n                </div>\n\n                {/* User Actions Configuration */}\n                {selectedNode.data.enableUserActions && (\n                  <div className=\"space-y-4 border-t border-border/50 pt-4\">\n                    \n                    {/* Action Trigger */}\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        Условие срабатывания\n                      </Label>\n                      <Select\n                        value={selectedNode.data.actionTrigger || 'on_any_response'}\n                        onValueChange={(value) => onNodeUpdate(selectedNode.id, { actionTrigger: value })}\n                      >\n                        <SelectTrigger className=\"border-orange-200 dark:border-orange-700\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"on_any_response\">При любом ответе</SelectItem>\n                          <SelectItem value=\"on_button_click\">При нажатии кнопки</SelectItem>\n                          <SelectItem value=\"on_text_input\">При вводе текста</SelectItem>\n                          <SelectItem value=\"on_specific_text\">При конкретном тексте</SelectItem>\n                          <SelectItem value=\"on_first_interaction\">При первом взаимодействии</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    {/* Specific Text Trigger */}\n                    {selectedNode.data.actionTrigger === 'on_specific_text' && (\n                      <div>\n                        <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                          Триггерный текст\n                        </Label>\n                        <Input\n                          value={selectedNode.data.triggerText || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { triggerText: e.target.value })}\n                          className=\"border-orange-200 dark:border-orange-700\"\n                          placeholder=\"например: стоп, блок, админ\"\n                        />\n                      </div>\n                    )}\n\n                    {/* User Action Type */}\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        Действие с пользователем\n                      </Label>\n                      <Select\n                        value={selectedNode.data.userActionType || 'none'}\n                        onValueChange={(value) => onNodeUpdate(selectedNode.id, { userActionType: value })}\n                      >\n                        <SelectTrigger className=\"border-orange-200 dark:border-orange-700\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"none\">Нет действия</SelectItem>\n                          <SelectItem value=\"block_user\">🚫 Заблокировать пользователя</SelectItem>\n                          <SelectItem value=\"unblock_user\">✅ Разблокировать пользователя</SelectItem>\n                          <SelectItem value=\"give_premium\">👑 Дать Premium статус</SelectItem>\n                          <SelectItem value=\"remove_premium\">❌ Убрать Premium статус</SelectItem>\n                          <SelectItem value=\"mark_active\">🟢 Отметить как активного</SelectItem>\n                          <SelectItem value=\"mark_inactive\">🟡 Отметить как неактивного</SelectItem>\n                          <SelectItem value=\"add_tag\">🏷️ Добавить тег</SelectItem>\n                          <SelectItem value=\"remove_tag\">🗑️ Удалить тег</SelectItem>\n                          <SelectItem value=\"kick_user\">🚪 Кикнуть из группы</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    {/* Tag Input for Add/Remove Tag Actions */}\n                    {(selectedNode.data.userActionType === 'add_tag' || selectedNode.data.userActionType === 'remove_tag') && (\n                      <div>\n                        <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                          Название тега\n                        </Label>\n                        <Input\n                          value={selectedNode.data.actionTag || ''}\n                          onChange={(e) => onNodeUpdate(selectedNode.id, { actionTag: e.target.value })}\n                          className=\"border-orange-200 dark:border-orange-700\"\n                          placeholder=\"например: vip, problem_user, new_customer\"\n                        />\n                      </div>\n                    )}\n\n                    {/* Action Message */}\n                    <div>\n                      <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300 mb-2 block\">\n                        Сообщение после действия (опционально)\n                      </Label>\n                      <Textarea\n                        value={selectedNode.data.actionMessage || ''}\n                        onChange={(e) => onNodeUpdate(selectedNode.id, { actionMessage: e.target.value })}\n                        className=\"border-orange-200 dark:border-orange-700\"\n                        placeholder=\"Например: Ваш статус был изменен администратором\"\n                        rows={2}\n                      />\n                    </div>\n\n                    {/* Silent Action */}\n                    <div className=\"group flex items-center justify-between p-3 rounded-lg bg-card/50 border border-orange-200/30 dark:border-orange-800/30 hover:border-orange-300 dark:hover:border-orange-700 transition-all duration-200\">\n                      <div className=\"flex-1\">\n                        <Label className=\"text-xs font-medium text-orange-700 dark:text-orange-300\">\n                          Тихое действие\n                        </Label>\n                        <div className=\"text-xs text-orange-600 dark:text-orange-400 mt-1\">\n                          Не отправлять уведомление пользователю\n                        </div>\n                      </div>\n                      <div className=\"ml-4\">\n                        <Switch\n                          checked={selectedNode.data.silentAction ?? false}\n                          onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { silentAction: checked })}\n                          className=\"data-[state=checked]:bg-orange-500\"\n                        />\n                      </div>\n                    </div>\n\n                  </div>\n                )}\n              </div>\n            </AccordionContent>\n          </AccordionItem>\n        </Accordion>\n\n        <Separator />\n\n        {/* Keyboard Advanced Settings */}\n        {selectedNode.data.keyboardType === 'reply' && (\n          <div className=\"bg-gradient-to-br from-background to-muted/20 dark:from-background dark:to-muted/10 border border-border/50 rounded-lg p-4\">\n            <div className=\"flex items-center space-x-2 mb-4\">\n              <div className=\"w-4 h-4 rounded-full bg-gradient-to-r from-secondary/20 to-secondary/10 flex items-center justify-center\">\n                <svg className=\"w-2.5 h-2.5 text-secondary-foreground\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                  <path fillRule=\"evenodd\" d=\"M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z\" clipRule=\"evenodd\" />\n                </svg>\n              </div>\n              <h3 className=\"text-sm font-medium text-foreground bg-gradient-to-r from-foreground to-muted-foreground bg-clip-text\">\n                Настройки клавиатуры\n              </h3>\n            </div>\n            \n            <div className=\"space-y-4\">\n              <div className=\"group flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-secondary/30 hover:bg-card/80 transition-all duration-200\">\n                <div className=\"flex-1\">\n                  <Label className=\"text-xs font-medium text-foreground group-hover:text-secondary transition-colors duration-200\">\n                    Одноразовая клавиатура\n                  </Label>\n                  <div className=\"text-xs text-muted-foreground mt-1 leading-relaxed\">\n                    Скрыть после нажатия\n                  </div>\n                </div>\n                <div className=\"ml-4\">\n                  <Switch\n                    checked={selectedNode.data.oneTimeKeyboard}\n                    onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { oneTimeKeyboard: checked })}\n                    className=\"data-[state=checked]:bg-secondary\"\n                  />\n                </div>\n              </div>\n              \n              <div className=\"group flex items-center justify-between p-3 rounded-lg bg-card/50 border border-border/50 hover:border-secondary/30 hover:bg-card/80 transition-all duration-200\">\n                <div className=\"flex-1\">\n                  <Label className=\"text-xs font-medium text-foreground group-hover:text-secondary transition-colors duration-200\">\n                    Изменить размер клавиатуры\n                  </Label>\n                  <div className=\"text-xs text-muted-foreground mt-1 leading-relaxed\">\n                    Подогнать под содержимое\n                  </div>\n                </div>\n                <div className=\"ml-4\">\n                  <Switch\n                    checked={selectedNode.data.resizeKeyboard}\n                    onCheckedChange={(checked) => onNodeUpdate(selectedNode.id, { resizeKeyboard: checked })}\n                    className=\"data-[state=checked]:bg-secondary\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Properties Footer */}\n      <div className=\"p-4 border-t border-border bg-gradient-to-r from-background to-muted/10 dark:from-background dark:to-muted/5\">\n        <div className=\"flex space-x-2\">\n          <UIButton \n            variant=\"outline\" \n            className=\"flex-1 hover:bg-muted/80 dark:hover:bg-muted/60 transition-all duration-200\"\n            onClick={() => {\n              // Reset to default values\n              onNodeUpdate(selectedNode.id, {\n                messageText: '',\n                keyboardType: 'none',\n                buttons: [],\n                markdown: false,\n                oneTimeKeyboard: false,\n                resizeKeyboard: true\n              });\n            }}\n          >\n            Сбросить\n          </UIButton>\n          <UIButton className=\"flex-1 bg-primary hover:bg-primary/90 dark:bg-primary dark:hover:bg-primary/80 transition-all duration-200\">\n            Применить\n          </UIButton>\n        </div>\n      </div>\n    </aside>\n  );\n}\n","size_bytes":335419},"force_recreate_templates.ts":{"content":"import { seedDefaultTemplates } from './server/seed-templates';\nimport { createPostgreSQLStorage } from './server/storage';\n\nasync function main() {\n  console.log('🔄 Принудительное пересоздание шаблонов...');\n  \n  const storage = createPostgreSQLStorage();\n  \n  try {\n    await seedDefaultTemplates(storage, true);\n    console.log('✅ Шаблоны успешно пересозданы!');\n  } catch (error) {\n    console.error('❌ Ошибка:', error);\n  }\n  \n  process.exit(0);\n}\n\nmain();","size_bytes":533},"update_next_node_fix.js":{"content":"import { updateTemplatesWithFixedVariables } from './server/seed-templates.js';\n\nconsole.log('🔄 Обновляем шаблоны с исправленными nextNodeId...');\nupdateTemplatesWithFixedVariables()\n  .then(() => {\n    console.log('✅ Шаблоны обновлены с правильными переходами');\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error('❌ Ошибка при обновлении:', error);\n    process.exit(1);\n  });","size_bytes":486},"server/db-backup.ts":{"content":"import { db, pool } from './db';\nimport { sql } from 'drizzle-orm';\nimport { writeFileSync, readFileSync, existsSync } from 'fs';\nimport { join } from 'path';\nimport { botProjects, botInstances, botTemplates, botTokens, mediaFiles, userBotData } from '@shared/schema';\n\ninterface BackupData {\n  metadata: {\n    version: string;\n    timestamp: string;\n    description?: string;\n    tables: string[];\n  };\n  data: {\n    botProjects: any[];\n    botInstances: any[];\n    botTemplates: any[];\n    botTokens: any[];\n    mediaFiles: any[];\n    userBotData: any[];\n  };\n}\n\nexport class DatabaseBackup {\n  private static instance: DatabaseBackup;\n  private backupDir = './backups';\n\n  private constructor() {}\n\n  static getInstance(): DatabaseBackup {\n    if (!DatabaseBackup.instance) {\n      DatabaseBackup.instance = new DatabaseBackup();\n    }\n    return DatabaseBackup.instance;\n  }\n\n  // Создать полный дамп базы данных\n  async createFullBackup(description?: string): Promise<string> {\n    try {\n      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n      const filename = `backup_${timestamp}.json`;\n      const filepath = join(this.backupDir, filename);\n\n      // Создать директорию для резервных копий если не существует\n      const fs = await import('fs');\n      if (!fs.existsSync(this.backupDir)) {\n        fs.mkdirSync(this.backupDir, { recursive: true });\n      }\n\n      // Получить все данные из таблиц\n      const [\n        projectsData,\n        instancesData,\n        templatesData,\n        tokensData,\n        mediaData,\n        userBotDataResult\n      ] = await Promise.all([\n        db.select().from(botProjects),\n        db.select().from(botInstances),\n        db.select().from(botTemplates),\n        db.select().from(botTokens),\n        db.select().from(mediaFiles),\n        db.select().from(userBotData)\n      ]);\n\n      const backupData: BackupData = {\n        metadata: {\n          version: '1.0.0',\n          timestamp: new Date().toISOString(),\n          description: description || 'Полный дамп базы данных',\n          tables: ['botProjects', 'botInstances', 'botTemplates', 'botTokens', 'mediaFiles', 'userBotData']\n        },\n        data: {\n          botProjects: projectsData,\n          botInstances: instancesData,\n          botTemplates: templatesData,\n          botTokens: tokensData,\n          mediaFiles: mediaData,\n          userBotData: userBotDataResult\n        }\n      };\n\n      // Сохранить в файл\n      writeFileSync(filepath, JSON.stringify(backupData, null, 2), 'utf-8');\n\n      console.log(`Backup created successfully: ${filepath}`);\n      return filepath;\n    } catch (error) {\n      console.error('Failed to create backup:', error);\n      throw error;\n    }\n  }\n\n  // Восстановить базу данных из файла\n  async restoreFromBackup(filepath: string, options?: {\n    clearExisting?: boolean;\n    skipTables?: string[];\n    onlyTables?: string[];\n  }): Promise<void> {\n    try {\n      if (!existsSync(filepath)) {\n        throw new Error(`Backup file not found: ${filepath}`);\n      }\n\n      const backupData: BackupData = JSON.parse(readFileSync(filepath, 'utf-8'));\n      \n      // Валидация структуры файла\n      if (!backupData.metadata || !backupData.data) {\n        throw new Error('Invalid backup file structure');\n      }\n\n      console.log(`Restoring backup from ${backupData.metadata.timestamp}`);\n      console.log(`Description: ${backupData.metadata.description}`);\n\n      // Очистить существующие данные если указано\n      if (options?.clearExisting) {\n        await this.clearAllTables(options.skipTables);\n      }\n\n      // Определить какие таблицы восстанавливать\n      const tablesToRestore = options?.onlyTables || backupData.metadata.tables;\n      \n      // Восстановить данные в правильном порядке (чтобы избежать проблем с внешними ключами)\n      const restoreOrder = [\n        'botProjects',\n        'botTemplates', \n        'botTokens',\n        'mediaFiles',\n        'botInstances',\n        'userBotData'\n      ];\n\n      for (const tableName of restoreOrder) {\n        if (!tablesToRestore.includes(tableName)) continue;\n        if (options?.skipTables?.includes(tableName)) continue;\n\n        const tableData = backupData.data[tableName as keyof typeof backupData.data];\n        if (!tableData || !Array.isArray(tableData) || tableData.length === 0) {\n          console.log(`Skipping ${tableName} - no data`);\n          continue;\n        }\n\n        await this.restoreTable(tableName, tableData);\n        console.log(`Restored ${tableData.length} records to ${tableName}`);\n      }\n\n      console.log('Database restore completed successfully');\n    } catch (error) {\n      console.error('Failed to restore backup:', error);\n      throw error;\n    }\n  }\n\n  // Восстановить конкретную таблицу\n  private async restoreTable(tableName: string, data: any[]): Promise<void> {\n    try {\n      switch (tableName) {\n        case 'botProjects':\n          if (data.length > 0) {\n            await db.insert(botProjects).values(data).onConflictDoNothing();\n          }\n          break;\n        case 'botInstances':\n          if (data.length > 0) {\n            await db.insert(botInstances).values(data).onConflictDoNothing();\n          }\n          break;\n        case 'botTemplates':\n          if (data.length > 0) {\n            await db.insert(botTemplates).values(data).onConflictDoNothing();\n          }\n          break;\n        case 'botTokens':\n          if (data.length > 0) {\n            await db.insert(botTokens).values(data).onConflictDoNothing();\n          }\n          break;\n        case 'mediaFiles':\n          if (data.length > 0) {\n            await db.insert(mediaFiles).values(data).onConflictDoNothing();\n          }\n          break;\n        case 'userBotData':\n          if (data.length > 0) {\n            await db.insert(userBotData).values(data).onConflictDoNothing();\n          }\n          break;\n        default:\n          console.warn(`Unknown table: ${tableName}`);\n      }\n    } catch (error) {\n      console.error(`Failed to restore table ${tableName}:`, error);\n      throw error;\n    }\n  }\n\n  // Очистить все таблицы\n  private async clearAllTables(skipTables?: string[]): Promise<void> {\n    const tablesToClear = [\n      'userBotData',\n      'botInstances', \n      'mediaFiles',\n      'botTokens',\n      'botTemplates',\n      'botProjects'\n    ];\n\n    for (const tableName of tablesToClear) {\n      if (skipTables?.includes(tableName)) continue;\n\n      try {\n        switch (tableName) {\n          case 'botProjects':\n            await db.delete(botProjects);\n            break;\n          case 'botInstances':\n            await db.delete(botInstances);\n            break;\n          case 'botTemplates':\n            await db.delete(botTemplates);\n            break;\n          case 'botTokens':\n            await db.delete(botTokens);\n            break;\n          case 'mediaFiles':\n            await db.delete(mediaFiles);\n            break;\n          case 'userBotData':\n            await db.delete(userBotData);\n            break;\n        }\n        console.log(`Cleared table: ${tableName}`);\n      } catch (error) {\n        console.error(`Failed to clear table ${tableName}:`, error);\n      }\n    }\n  }\n\n  // Получить список доступных резервных копий\n  async listBackups(): Promise<Array<{\n    filename: string;\n    filepath: string;\n    size: number;\n    created: Date;\n    metadata?: BackupData['metadata'];\n  }>> {\n    try {\n      const fs = await import('fs');\n      if (!fs.existsSync(this.backupDir)) {\n        return [];\n      }\n\n      const files = fs.readdirSync(this.backupDir)\n        .filter(file => file.endsWith('.json'))\n        .map(file => {\n          const filepath = join(this.backupDir, file);\n          const stats = fs.statSync(filepath);\n          \n          let metadata: BackupData['metadata'] | undefined;\n          try {\n            const backupData: BackupData = JSON.parse(fs.readFileSync(filepath, 'utf-8'));\n            metadata = backupData.metadata;\n          } catch (error) {\n            console.warn(`Failed to read metadata from ${file}:`, error);\n          }\n\n          return {\n            filename: file,\n            filepath,\n            size: stats.size,\n            created: stats.birthtime,\n            metadata\n          };\n        })\n        .sort((a, b) => b.created.getTime() - a.created.getTime());\n\n      return files;\n    } catch (error) {\n      console.error('Failed to list backups:', error);\n      return [];\n    }\n  }\n\n  // Удалить резервную копию\n  async deleteBackup(filename: string): Promise<void> {\n    try {\n      const filepath = join(this.backupDir, filename);\n      if (!existsSync(filepath)) {\n        throw new Error(`Backup file not found: ${filename}`);\n      }\n\n      const fs = await import('fs');\n      fs.unlinkSync(filepath);\n      console.log(`Deleted backup: ${filename}`);\n    } catch (error) {\n      console.error('Failed to delete backup:', error);\n      throw error;\n    }\n  }\n\n  // Получить статистику базы данных\n  async getDatabaseStats(): Promise<{\n    tables: Array<{\n      name: string;\n      count: number;\n      size: string;\n    }>;\n    totalRecords: number;\n    estimatedSize: string;\n  }> {\n    try {\n      const [\n        projectsCount,\n        instancesCount,\n        templatesCount,\n        tokensCount,\n        mediaCount,\n        userDataCount\n      ] = await Promise.all([\n        db.execute(sql`SELECT COUNT(*) as count FROM bot_projects`),\n        db.execute(sql`SELECT COUNT(*) as count FROM bot_instances`),\n        db.execute(sql`SELECT COUNT(*) as count FROM bot_templates`),\n        db.execute(sql`SELECT COUNT(*) as count FROM bot_tokens`),\n        db.execute(sql`SELECT COUNT(*) as count FROM media_files`),\n        db.execute(sql`SELECT COUNT(*) as count FROM user_bot_data`)\n      ]);\n\n      const tables = [\n        {\n          name: 'botProjects',\n          count: Number(projectsCount.rows[0]?.count || 0),\n          size: 'N/A'\n        },\n        {\n          name: 'botInstances',\n          count: Number(instancesCount.rows[0]?.count || 0),\n          size: 'N/A'\n        },\n        {\n          name: 'botTemplates',\n          count: Number(templatesCount.rows[0]?.count || 0),\n          size: 'N/A'\n        },\n        {\n          name: 'botTokens',\n          count: Number(tokensCount.rows[0]?.count || 0),\n          size: 'N/A'\n        },\n        {\n          name: 'mediaFiles',\n          count: Number(mediaCount.rows[0]?.count || 0),\n          size: 'N/A'\n        },\n        {\n          name: 'userBotData',\n          count: Number(userDataCount.rows[0]?.count || 0),\n          size: 'N/A'\n        }\n      ];\n\n      const totalRecords = tables.reduce((sum, table) => sum + table.count, 0);\n\n      return {\n        tables,\n        totalRecords,\n        estimatedSize: 'N/A'\n      };\n    } catch (error) {\n      console.error('Failed to get database stats:', error);\n      throw error;\n    }\n  }\n}\n\n// Экспорт singleton instance\nexport const dbBackup = DatabaseBackup.getInstance();","size_bytes":11463},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"client/src/components/editor/components-sidebar.tsx":{"content":"import { ComponentDefinition, BotProject } from '@shared/schema';\nimport { cn } from '@/lib/utils';\nimport { useState, useEffect } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { SheetsManager } from '@/utils/sheets-manager';\n\nimport QuickLayoutSwitcher from '@/components/layout/quick-layout-switcher';\nimport DragLayoutManager from '@/components/layout/drag-layout-manager';\nimport { Button } from '@/components/ui/button';\nimport { Separator } from '@/components/ui/separator';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\n\nimport { Layout, Settings, Grid, Home, Plus, Edit, Trash2, Calendar, User, GripVertical, FileText, Copy, MoreHorizontal, ChevronDown, ChevronRight, Menu, X } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport { LayoutButtons } from '@/components/layout/layout-buttons';\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '@/components/ui/dropdown-menu';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from '@/components/ui/sheet';\nimport { useIsMobile } from '@/hooks/use-mobile';\n\n\n\ninterface ComponentsSidebarProps {\n  onComponentDrag: (component: ComponentDefinition) => void;\n  onComponentAdd?: (component: ComponentDefinition) => void;\n  onLoadTemplate?: () => void;\n  onOpenLayoutCustomizer?: () => void;\n  onLayoutChange?: (config: any) => void;\n  onGoToProjects?: () => void;\n  onProjectSelect?: (projectId: number) => void;\n  currentProjectId?: number;\n  activeSheetId?: string;\n  headerContent?: React.ReactNode;\n  sidebarContent?: React.ReactNode;\n  canvasContent?: React.ReactNode;\n  propertiesContent?: React.ReactNode;\n  // Новые пропсы для управления макетом\n  onToggleCanvas?: () => void;\n  onToggleHeader?: () => void;\n  onToggleProperties?: () => void;\n  onShowFullLayout?: () => void;\n  canvasVisible?: boolean;\n  headerVisible?: boolean;\n  propertiesVisible?: boolean;\n  showLayoutButtons?: boolean;\n  // Пропсы для управления листами\n  onSheetAdd?: (name: string) => void;\n  onSheetDelete?: (sheetId: string) => void;\n  onSheetRename?: (sheetId: string, name: string) => void;\n  onSheetDuplicate?: (sheetId: string) => void;\n  onSheetSelect?: (sheetId: string) => void;\n  // Мобильный режим\n  isMobile?: boolean;\n}\n\nconst components: ComponentDefinition[] = [\n  {\n    id: 'text-message',\n    name: 'Текстовое сообщение',\n    description: 'Обычный текст или Markdown',\n    icon: 'fas fa-comment',\n    color: 'bg-blue-100 text-blue-600',\n    type: 'message',\n    defaultData: {\n      messageText: 'Новое сообщение',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'photo-message',\n    name: 'Фото с текстом',\n    description: 'Изображение + описание',\n    icon: 'fas fa-image',\n    color: 'bg-green-100 text-green-600',\n    type: 'photo',\n    defaultData: {\n      messageText: 'Описание изображения',\n      imageUrl: '',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'video-message',\n    name: 'Видео сообщение',\n    description: 'Видео файл с подписью',\n    icon: 'fas fa-video',\n    color: 'bg-red-100 text-red-600',\n    type: 'video',\n    defaultData: {\n      messageText: 'Описание видео',\n      videoUrl: '',\n      mediaCaption: '',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'audio-message',\n    name: 'Аудио сообщение',\n    description: 'Аудио файл с подписью',\n    icon: 'fas fa-music',\n    color: 'bg-yellow-100 text-yellow-600',\n    type: 'audio',\n    defaultData: {\n      messageText: 'Описание аудио',\n      audioUrl: '',\n      mediaCaption: '',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'document-message',\n    name: 'Документ',\n    description: 'Файл документа',\n    icon: 'fas fa-file',\n    color: 'bg-gray-100 text-gray-600',\n    type: 'document',\n    defaultData: {\n      messageText: 'Описание документа',\n      documentUrl: '',\n      documentName: 'document.pdf',\n      mediaCaption: '',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'sticker-message',\n    name: 'Стикер',\n    description: 'Анимированный стикер',\n    icon: 'fas fa-laugh',\n    color: 'bg-pink-100 text-pink-600',\n    type: 'sticker',\n    defaultData: {\n      messageText: 'Стикер',\n      stickerUrl: '',\n      stickerFileId: '',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'voice-message',\n    name: 'Голосовое сообщение',\n    description: 'Голосовое сообщение',\n    icon: 'fas fa-microphone',\n    color: 'bg-teal-100 text-teal-600',\n    type: 'voice',\n    defaultData: {\n      messageText: 'Голосовое сообщение',\n      voiceUrl: '',\n      duration: 0,\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'animation-message',\n    name: 'GIF анимация',\n    description: 'Анимированное изображение',\n    icon: 'fas fa-film',\n    color: 'bg-orange-100 text-orange-600',\n    type: 'animation',\n    defaultData: {\n      messageText: 'GIF анимация',\n      animationUrl: '',\n      duration: 0,\n      width: 0,\n      height: 0,\n      mediaCaption: '',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'location-message',\n    name: 'Геолокация',\n    description: 'Отправка координат',\n    icon: 'fas fa-map-marker',\n    color: 'bg-green-100 text-green-600',\n    type: 'location',\n    defaultData: {\n      messageText: 'Местоположение',\n      latitude: 55.7558,\n      longitude: 37.6176,\n      title: 'Москва',\n      address: 'Москва, Россия',\n      foursquareId: '',\n      foursquareType: '',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'contact-message',\n    name: 'Контакт',\n    description: 'Поделиться контактом',\n    icon: 'fas fa-address-book',\n    color: 'bg-blue-100 text-blue-600',\n    type: 'contact',\n    defaultData: {\n      messageText: 'Контакт',\n      phoneNumber: '+7 (999) 123-45-67',\n      firstName: 'Имя',\n      lastName: 'Фамилия',\n      userId: 0,\n      vcard: '',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n\n  {\n    id: 'reply-keyboard',\n    name: 'Reply клавиатура',\n    description: 'Кнопки внизу экрана',\n    icon: 'fas fa-keyboard',\n    color: 'bg-purple-100 text-purple-600',\n    type: 'keyboard',\n    defaultData: {\n      messageText: 'Выберите действие:',\n      keyboardType: 'reply',\n      buttons: [\n        { id: 'btn-1', text: 'Кнопка 1', action: 'goto', target: '' },\n        { id: 'btn-2', text: 'Кнопка 2', action: 'goto', target: '' }\n      ],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n  {\n    id: 'inline-keyboard',\n    name: 'Inline кнопки',\n    description: 'Кнопки под сообщением',\n    icon: 'fas fa-mouse',\n    color: 'bg-amber-100 text-amber-600',\n    type: 'keyboard',\n    defaultData: {\n      messageText: 'Выберите действие:',\n      keyboardType: 'inline',\n      buttons: [\n        { id: 'btn-1', text: 'Кнопка 1', action: 'goto', target: '' },\n        { id: 'btn-2', text: 'Кнопка 2', action: 'goto', target: '' }\n      ],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true\n    }\n  },\n\n  {\n    id: 'start-command',\n    name: '/start команда',\n    description: 'Точка входа в бота',\n    icon: 'fas fa-play',\n    color: 'bg-green-100 text-green-600',\n    type: 'start',\n    defaultData: {\n      command: '/start',\n      description: 'Запустить бота',\n      messageText: 'Привет! Добро пожаловать!',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true,\n      showInMenu: true,\n      isPrivateOnly: false,\n      requiresAuth: false,\n      adminOnly: false\n    }\n  },\n  {\n    id: 'help-command',\n    name: '/help команда',\n    description: 'Справка по боту',\n    icon: 'fas fa-question-circle',\n    color: 'bg-blue-100 text-blue-600',\n    type: 'command',\n    defaultData: {\n      command: '/help',\n      description: 'Справка по боту',\n      messageText: '🤖 Доступные команды:\\n\\n/start - Начать работу\\n/help - Эта справка\\n/settings - Настройки',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: true,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true,\n      showInMenu: true,\n      isPrivateOnly: false,\n      requiresAuth: false,\n      adminOnly: false\n    }\n  },\n  {\n    id: 'settings-command',\n    name: '/settings команда',\n    description: 'Настройки бота',\n    icon: 'fas fa-cog',\n    color: 'bg-gray-100 text-gray-600',\n    type: 'command',\n    defaultData: {\n      command: '/settings',\n      description: 'Настройки бота',\n      messageText: '⚙️ Настройки бота:',\n      keyboardType: 'inline',\n      buttons: [\n        { id: 'btn-1', text: '📋 Язык', action: 'command', target: '/language' },\n        { id: 'btn-2', text: '🔔 Уведомления', action: 'command', target: '/notifications' }\n      ],\n      markdown: true,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true,\n      showInMenu: true,\n      isPrivateOnly: false,\n      requiresAuth: false,\n      adminOnly: false\n    }\n  },\n  {\n    id: 'menu-command',\n    name: '/menu команда',\n    description: 'Главное меню',\n    icon: 'fas fa-bars',\n    color: 'bg-purple-100 text-purple-600',\n    type: 'command',\n    defaultData: {\n      command: '/menu',\n      description: 'Главное меню',\n      messageText: '📋 Главное меню:',\n      keyboardType: 'reply',\n      buttons: [\n        { id: 'btn-1', text: '📖 Информация', action: 'command', target: '/info' },\n        { id: 'btn-2', text: '⚙️ Настройки', action: 'command', target: '/settings' },\n        { id: 'btn-3', text: '❓ Помощь', action: 'command', target: '/help' },\n        { id: 'btn-4', text: '📞 Поддержка', action: 'command', target: '/support' }\n      ],\n      markdown: true,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true,\n      showInMenu: true,\n      isPrivateOnly: false,\n      requiresAuth: false,\n      adminOnly: false\n    }\n  },\n  {\n    id: 'custom-command',\n    name: 'Пользовательская команда',\n    description: 'Настраиваемая команда',\n    icon: 'fas fa-terminal',\n    color: 'bg-indigo-100 text-indigo-600',\n    type: 'command',\n    defaultData: {\n      command: '/custom',\n      description: 'Новая команда',\n      messageText: 'Команда выполнена',\n      keyboardType: 'none',\n      buttons: [],\n      markdown: false,\n      oneTimeKeyboard: false,\n      resizeKeyboard: true,\n      showInMenu: true,\n      isPrivateOnly: false,\n      requiresAuth: false,\n      adminOnly: false\n    }\n  },\n  {\n    id: 'pin-message',\n    name: 'Закрепить сообщение',\n    description: 'Закрепление сообщения в группе',\n    icon: 'fas fa-thumbtack',\n    color: 'bg-cyan-100 text-cyan-600',\n    type: 'pin_message',\n    defaultData: {\n      command: '/pin_message',\n      targetMessageId: '',\n      messageIdSource: 'last_message',\n      variableName: '',\n      disableNotification: false\n    }\n  },\n  {\n    id: 'unpin-message',\n    name: 'Открепить сообщение',\n    description: 'Снятие закрепления сообщения',\n    icon: 'fas fa-times',\n    color: 'bg-slate-100 text-slate-600',\n    type: 'unpin_message',\n    defaultData: {\n      command: '/unpin_message',\n      targetMessageId: '',\n      messageIdSource: 'last_message',\n      variableName: ''\n    }\n  },\n  {\n    id: 'delete-message',\n    name: 'Удалить сообщение',\n    description: 'Удаление сообщения в группе',\n    icon: 'fas fa-trash',\n    color: 'bg-red-100 text-red-600',\n    type: 'delete_message',\n    defaultData: {\n      command: '/delete_message',\n      targetMessageId: '',\n      messageIdSource: 'last_message',\n      variableName: ''\n    }\n  },\n  {\n    id: 'ban-user',\n    name: 'Заблокировать пользователя',\n    description: 'Забанить участника группы',\n    icon: 'fas fa-ban',\n    color: 'bg-red-100 text-red-600',\n    type: 'ban_user',\n    defaultData: {\n      command: '/ban_user',\n      targetUserId: '',\n      userIdSource: 'last_message',\n      userVariableName: '',\n      reason: 'Нарушение правил группы',\n      untilDate: 0\n    }\n  },\n  {\n    id: 'unban-user',\n    name: 'Разблокировать пользователя',\n    description: 'Снять бан с участника группы',\n    icon: 'fas fa-user-check',\n    color: 'bg-green-100 text-green-600',\n    type: 'unban_user',\n    defaultData: {\n      command: '/unban_user',\n      targetUserId: '',\n      userIdSource: 'last_message',\n      userVariableName: ''\n    }\n  },\n  {\n    id: 'mute-user',\n    name: 'Заглушить пользователя',\n    description: 'Ограничить права участника',\n    icon: 'fas fa-volume-mute',\n    color: 'bg-orange-100 text-orange-600',\n    type: 'mute_user',\n    defaultData: {\n      command: '/mute_user',\n      targetUserId: '',\n      userIdSource: 'last_message',\n      userVariableName: '',\n      duration: 3600,\n      reason: 'Нарушение правил группы',\n      canSendMessages: false,\n      canSendMediaMessages: false,\n      canSendPolls: false,\n      canSendOtherMessages: false,\n      canAddWebPagePreviews: false,\n      canChangeGroupInfo: false,\n      canInviteUsers2: false,\n      canPinMessages2: false\n    }\n  },\n  {\n    id: 'unmute-user',\n    name: 'Снять ограничения',\n    description: 'Восстановить права участника',\n    icon: 'fas fa-volume-up',\n    color: 'bg-green-100 text-green-600',\n    type: 'unmute_user',\n    defaultData: {\n      command: '/unmute_user',\n      targetUserId: '',\n      userIdSource: 'last_message',\n      userVariableName: ''\n    }\n  },\n  {\n    id: 'kick-user',\n    name: 'Исключить пользователя',\n    description: 'Удалить участника из группы',\n    icon: 'fas fa-user-times',\n    color: 'bg-red-100 text-red-600',\n    type: 'kick_user',\n    defaultData: {\n      targetUserId: '',\n      userIdSource: 'last_message',\n      userVariableName: '',\n      reason: 'Нарушение правил группы'\n    }\n  },\n  {\n    id: 'promote-user',\n    name: 'Назначить администратором',\n    description: 'Дать права администратора',\n    icon: 'fas fa-crown',\n    color: 'bg-yellow-100 text-yellow-600',\n    type: 'promote_user',\n    defaultData: {\n      targetUserId: '',\n      userIdSource: 'last_message',\n      userVariableName: '',\n      canChangeInfo: false,\n      canDeleteMessages: true,\n      canBanUsers: false,\n      canInviteUsers: true,\n      canPinMessages: true,\n      canAddAdmins: false,\n      canRestrictMembers: false,\n      canPromoteMembers: false,\n      canManageVideoChats: false,\n      canManageTopics: false,\n      isAnonymous: false\n    }\n  },\n  {\n    id: 'demote-user',\n    name: 'Снять с администратора',\n    description: 'Убрать права администратора',\n    icon: 'fas fa-user-minus',\n    color: 'bg-gray-100 text-gray-600',\n    type: 'demote_user',\n    defaultData: {\n      targetUserId: '',\n      userIdSource: 'last_message',\n      userVariableName: ''\n    }\n  },\n  {\n    id: 'admin-rights',\n    name: 'Тг права',\n    description: 'Панель редактирования прав администратора',\n    icon: 'fas fa-user-cog',\n    color: 'bg-purple-100 text-purple-600',\n    type: 'admin_rights',\n    defaultData: {\n      command: '/admin_rights',\n      description: 'Управление правами администратора',\n      synonyms: ['права админа', 'изменить права', 'админ права', 'тг права', 'права'],\n      adminUserIdSource: 'last_message',\n      adminChatIdSource: 'current_chat',\n      // Права администратора согласно Telegram Bot API\n      can_manage_chat: false,\n      can_post_messages: false,\n      can_edit_messages: false,\n      can_delete_messages: true,\n      can_post_stories: false,\n      can_edit_stories: false,\n      can_delete_stories: false,\n      can_manage_video_chats: false,\n      can_restrict_members: false,\n      can_promote_members: false,\n      can_change_info: false,\n      can_invite_users: true,\n      can_pin_messages: true,\n      can_manage_topics: false,\n      is_anonymous: false\n    }\n  }\n];\n\nconst componentCategories = [\n  {\n    title: 'Сообщения',\n    components: components.filter(c => ['message', 'photo', 'video', 'audio', 'document', 'sticker', 'voice', 'animation', 'location', 'contact'].includes(c.type))\n  },\n  {\n    title: 'Кнопки',\n    components: components.filter(c => c.type === 'keyboard')\n  },\n  {\n    title: 'Команды',\n    components: components.filter(c => ['start', 'command'].includes(c.type))\n  },\n  {\n    title: 'Управление контентом',\n    components: components.filter(c => ['pin_message', 'unpin_message', 'delete_message'].includes(c.type))\n  },\n  {\n    title: 'Управление пользователями',\n    components: components.filter(c => ['ban_user', 'unban_user', 'mute_user', 'unmute_user', 'kick_user', 'promote_user', 'demote_user', 'admin_rights'].includes(c.type))\n  }\n];\n\nexport function ComponentsSidebar({ \n  onComponentDrag, \n  onComponentAdd,\n  onLoadTemplate, \n  onOpenLayoutCustomizer, \n  onLayoutChange,\n  onGoToProjects,\n  onProjectSelect,\n  currentProjectId,\n  activeSheetId,\n  headerContent,\n  sidebarContent,\n  canvasContent,\n  propertiesContent,\n  onToggleCanvas,\n  onToggleHeader,\n  onToggleProperties,\n  onShowFullLayout,\n  canvasVisible = false,\n  headerVisible = false,\n  propertiesVisible = false,\n  showLayoutButtons = false,\n  onSheetAdd,\n  onSheetDelete,\n  onSheetRename,\n  onSheetDuplicate,\n  onSheetSelect,\n  isMobile = false\n}: ComponentsSidebarProps) {\n  const [currentTab, setCurrentTab] = useState<'elements' | 'projects'>('elements');\n  const [draggedProject, setDraggedProject] = useState<BotProject | null>(null);\n  const [dragOverProject, setDragOverProject] = useState<number | null>(null);\n  const [selectedSheetId, setSelectedSheetId] = useState<string | null>(null);\n  // Состояние для inline редактирования листов\n  const [editingSheetId, setEditingSheetId] = useState<string | null>(null);\n  const [editingSheetName, setEditingSheetName] = useState('');\n  // Состояние для сворачивания/раскрытия категорий\n  const [collapsedCategories, setCollapsedCategories] = useState<Set<string>>(new Set());\n  // Мобильное меню\n  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);\n  const isActuallyMobile = useIsMobile();\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  \n  // Функция для переключения видимости категории\n  const toggleCategory = (categoryTitle: string) => {\n    setCollapsedCategories(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(categoryTitle)) {\n        newSet.delete(categoryTitle);\n      } else {\n        newSet.add(categoryTitle);\n      }\n      return newSet;\n    });\n  };\n  \n  const handleDragStart = (e: React.DragEvent, component: ComponentDefinition) => {\n    e.dataTransfer.setData('application/json', JSON.stringify(component));\n    onComponentDrag(component);\n  };\n\n  // Touch события для мобильных устройств\n  const [touchedComponent, setTouchedComponent] = useState<ComponentDefinition | null>(null);\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });\n  const [touchStartElement, setTouchStartElement] = useState<HTMLElement | null>(null);\n\n  const handleTouchStart = (e: React.TouchEvent, component: ComponentDefinition) => {\n    console.log('Touch start on component:', component.name);\n    e.preventDefault();\n    e.stopPropagation();\n    \n    const touch = e.touches[0];\n    const element = e.currentTarget as HTMLElement;\n    \n    setTouchedComponent(component);\n    setIsDragging(true);\n    setTouchStartElement(element);\n    \n    const rect = element.getBoundingClientRect();\n    setDragOffset({\n      x: touch.clientX - rect.left,\n      y: touch.clientY - rect.top\n    });\n    onComponentDrag(component);\n    \n    // Добавляем визуальную обратную связь\n    element.style.opacity = '0.7';\n    element.style.transform = 'scale(0.95)';\n    element.style.transition = 'all 0.2s ease';\n    \n    console.log('Touch drag started for:', component.name, {\n      touchPos: { x: touch.clientX, y: touch.clientY },\n      elementRect: rect\n    });\n  };\n\n  const handleTouchMove = (e: React.TouchEvent) => {\n    if (!isDragging || !touchedComponent) return;\n    e.preventDefault();\n    e.stopPropagation();\n    console.log('Touch move:', { x: e.touches[0].clientX, y: e.touches[0].clientY });\n  };\n\n  const handleTouchEnd = (e: React.TouchEvent) => {\n    if (!isDragging || !touchedComponent) {\n      console.log('Touch end ignored - not dragging or no component');\n      return;\n    }\n    \n    console.log('Touch end for component:', touchedComponent.name);\n    const touch = e.changedTouches[0];\n    const element = document.elementFromPoint(touch.clientX, touch.clientY);\n    \n    console.log('Touch end position:', { x: touch.clientX, y: touch.clientY });\n    console.log('Element at touch point:', element);\n    \n    // Возвращаем стили элемента\n    const currentTarget = e.currentTarget as HTMLElement;\n    currentTarget.style.opacity = '';\n    currentTarget.style.transform = '';\n    \n    // Проверяем, попали ли мы на холст или в область холста\n    const canvas = document.querySelector('[data-canvas-drop-zone]');\n    console.log('Canvas element found:', canvas);\n    \n    if (canvas && element) {\n      // Проверяем если элемент находится внутри canvas или является самим canvas\n      const isInCanvas = canvas.contains(element) || element === canvas || \n                        element.closest('[data-canvas-drop-zone]') === canvas;\n      \n      console.log('Is in canvas:', isInCanvas);\n      \n      if (isInCanvas) {\n        const canvasRect = canvas.getBoundingClientRect();\n        const dropPosition = {\n          x: touch.clientX - canvasRect.left,\n          y: touch.clientY - canvasRect.top\n        };\n        \n        // Dispatching canvas-drop event\n        \n        // Создаем синтетическое событие drop\n        const dropEvent = new CustomEvent('canvas-drop', {\n          detail: {\n            component: touchedComponent,\n            position: dropPosition\n          }\n        });\n        canvas.dispatchEvent(dropEvent);\n      } else {\n        // Touch ended outside canvas\n      }\n    } else {\n      // Canvas not found\n    }\n    \n    setTouchedComponent(null);\n    setIsDragging(false);\n    setDragOffset({ x: 0, y: 0 });\n    setTouchStartElement(null);\n  };\n\n  // Глобальные touch обработчики для лучшей поддержки мобильных устройств\n  useEffect(() => {\n    const handleGlobalTouchMove = (e: TouchEvent) => {\n      if (isDragging && touchedComponent) {\n        e.preventDefault();\n        // Global touch move\n      }\n    };\n\n    const handleGlobalTouchEnd = (e: TouchEvent) => {\n      if (!isDragging || !touchedComponent) return;\n      \n      // Global touch end\n      const touch = e.changedTouches[0];\n      const element = document.elementFromPoint(touch.clientX, touch.clientY);\n      \n      // Global touch end position\n      \n      // Восстанавливаем стили элемента\n      if (touchStartElement) {\n        touchStartElement.style.opacity = '';\n        touchStartElement.style.transform = '';\n        touchStartElement.style.transition = '';\n      }\n      \n      // Проверяем, попали ли мы на холст\n      const canvas = document.querySelector('[data-canvas-drop-zone]');\n      // Canvas element check\n      \n      if (canvas && element) {\n        const isInCanvas = canvas.contains(element) || element === canvas || \n                          element.closest('[data-canvas-drop-zone]') === canvas;\n        \n        // Is in canvas check\n        \n        if (isInCanvas) {\n          const canvasRect = canvas.getBoundingClientRect();\n          const dropPosition = {\n            x: touch.clientX - canvasRect.left,\n            y: touch.clientY - canvasRect.top\n          };\n          \n          // Dispatching global canvas-drop event\n          \n          const dropEvent = new CustomEvent('canvas-drop', {\n            detail: {\n              component: touchedComponent,\n              position: dropPosition\n            }\n          });\n          canvas.dispatchEvent(dropEvent);\n        }\n      }\n      \n      setTouchedComponent(null);\n      setIsDragging(false);\n      setDragOffset({ x: 0, y: 0 });\n      setTouchStartElement(null);\n    };\n\n    if (isDragging) {\n      document.addEventListener('touchmove', handleGlobalTouchMove, { passive: false });\n      document.addEventListener('touchend', handleGlobalTouchEnd, { passive: false });\n    }\n\n    return () => {\n      document.removeEventListener('touchmove', handleGlobalTouchMove);\n      document.removeEventListener('touchend', handleGlobalTouchEnd);\n    };\n  }, [isDragging, touchedComponent, touchStartElement]);\n\n  // Загрузка списка проектов\n  const { data: projects = [], isLoading } = useQuery<BotProject[]>({\n    queryKey: ['/api/projects'],\n  });\n\n  // Создание нового проекта\n  const createProjectMutation = useMutation({\n    mutationFn: () => {\n      const projectCount = projects.length;\n      return apiRequest('POST', '/api/projects', {\n        name: `Новый бот ${projectCount + 1}`,\n        description: '',\n        data: {\n          nodes: [{\n            id: 'start',\n            type: 'start',\n            position: { x: 400, y: 300 }, // Центральная позиция для нового проекта\n            data: {\n              messageText: 'Привет! Я ваш новый бот. Нажмите /help для получения помощи.',\n              keyboardType: 'none',\n              buttons: [],\n              command: '/start',\n              description: 'Запустить бота',\n              showInMenu: true,\n              isPrivateOnly: false,\n              requiresAuth: false,\n              adminOnly: false\n            }\n          }],\n          connections: []\n        }\n      });\n    },\n    onSuccess: (newProject: BotProject) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      toast({\n        title: \"Проект создан\",\n        description: `Проект \"${newProject.name}\" успешно создан`,\n      });\n      // Переключаемся на новый проект\n      if (onProjectSelect) {\n        onProjectSelect(newProject.id);\n      }\n    },\n    onError: () => {\n      toast({\n        title: \"Ошибка создания\",\n        description: \"Не удалось создать проект\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Удаление проекта\n  const deleteProjectMutation = useMutation({\n    mutationFn: (projectId: number) => apiRequest('DELETE', `/api/projects/${projectId}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      toast({\n        title: \"Проект удален\",\n        description: \"Проект успешно удален\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Ошибка удаления\",\n        description: \"Не удалось удалить проект\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n\n\n  const handleCreateProject = () => {\n    createProjectMutation.mutate();\n  };\n\n  const handleDeleteProject = (projectId: number) => {\n    const project = projects.find(p => p.id === projectId);\n    if (project && confirm(`Вы уверены, что хотите удалить проект \"${project.name}\"? Это действие нельзя отменить.`)) {\n      deleteProjectMutation.mutate(project.id);\n    }\n  };\n\n  // Обработчики inline редактирования листов\n  const handleStartEditingSheet = (sheetId: string, currentName: string) => {\n    setEditingSheetId(sheetId);\n    setEditingSheetName(currentName);\n  };\n\n  const handleSaveSheetName = () => {\n    if (editingSheetId && editingSheetName.trim() && onSheetRename) {\n      onSheetRename(editingSheetId, editingSheetName.trim());\n    }\n    setEditingSheetId(null);\n    setEditingSheetName('');\n  };\n\n  const handleCancelEditingSheet = () => {\n    setEditingSheetId(null);\n    setEditingSheetName('');\n  };\n\n  // Обработчики drag-and-drop для проектов\n  const handleProjectDragStart = (e: React.DragEvent, project: BotProject) => {\n    e.stopPropagation();\n    setDraggedProject(project);\n    e.dataTransfer.effectAllowed = 'move';\n    e.dataTransfer.setData('text/plain', project.id.toString());\n  };\n\n  const handleProjectDragOver = (e: React.DragEvent, projectId: number) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = 'move';\n    setDragOverProject(projectId);\n  };\n\n  const handleProjectDragLeave = () => {\n    setDragOverProject(null);\n  };\n\n  const handleProjectDrop = (e: React.DragEvent, targetProject: BotProject) => {\n    e.preventDefault();\n    setDragOverProject(null);\n    \n    if (!draggedProject || draggedProject.id === targetProject.id) {\n      setDraggedProject(null);\n      return;\n    }\n\n    // Здесь можно добавить логику изменения порядка проектов\n    // Пока просто показываем уведомление\n    toast({\n      title: \"Перемещение проектов\",\n      description: `Проект \"${draggedProject.name}\" перемещен`,\n    });\n    \n    setDraggedProject(null);\n  };\n\n  const handleProjectDragEnd = () => {\n    setDraggedProject(null);\n    setDragOverProject(null);\n  };\n\n  const formatDate = (dateString: string | Date | null) => {\n    if (!dateString) return 'Неизвестно';\n    const date = typeof dateString === 'string' ? new Date(dateString) : dateString;\n    return date.toLocaleDateString('ru-RU', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  const getNodeCount = (project: BotProject) => {\n    if (!project.data || typeof project.data !== 'object') return 0;\n    \n    try {\n      // Проверяем, новый формат с листами или старый\n      if (SheetsManager.isNewFormat(project.data)) {\n        const sheets = (project.data as any).sheets || [];\n        const nodeCount = sheets.reduce((total: number, sheet: any) => total + (sheet.nodes?.length || 0), 0);\n        console.log(`[${project.name}] Формат с листами. Листов: ${sheets.length}, Узлов: ${nodeCount}`);\n        return nodeCount;\n      } else {\n        const data = project.data as { nodes?: any[] };\n        const nodeCount = data.nodes?.length || 0;\n        console.log(`[${project.name}] Старый формат. Узлов: ${nodeCount}`);\n        return nodeCount;\n      }\n    } catch (error) {\n      console.error('Ошибка подсчета узлов:', error);\n      // Попытка получить узлы напрямую из данных\n      const fallbackData = project.data as any;\n      if (fallbackData.nodes && Array.isArray(fallbackData.nodes)) {\n        return fallbackData.nodes.length;\n      }\n      if (fallbackData.sheets && Array.isArray(fallbackData.sheets)) {\n        return fallbackData.sheets.reduce((total: number, sheet: any) => \n          total + (sheet.nodes ? sheet.nodes.length : 0), 0);\n      }\n      return 0;\n    }\n  };\n\n  const getSheetsInfo = (project: BotProject) => {\n    if (!project.data || typeof project.data !== 'object') return { count: 0, names: [] };\n    \n    try {\n      // Проверяем, новый формат с листами или старый\n      if (SheetsManager.isNewFormat(project.data)) {\n        const sheets = (project.data as any).sheets || [];\n        const sheetsInfo = {\n          count: sheets.length,\n          names: sheets.map((sheet: any) => sheet.name || 'Лист без названия')\n        };\n        console.log(`[${project.name}] Информация о листах:`, sheetsInfo);\n        return sheetsInfo;\n      } else {\n        // Старый формат - один лист\n        console.log(`[${project.name}] Старый формат - один основной лист`);\n        return {\n          count: 1,\n          names: ['Основной поток']\n        };\n      }\n    } catch (error) {\n      console.error('Ошибка получения информации о листах:', error);\n      return {\n        count: 1,\n        names: ['Основной поток']\n      };\n    }\n  };\n\n  // Создаем контент панели\n  const SidebarContent = () => (\n    <div className=\"h-full flex flex-col overflow-hidden\">\n      {/* Sidebar Header */}\n      <div className=\"p-4 border-b border-border\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <h2 className=\"text-sm font-semibold text-foreground\">Компоненты</h2>\n          {/* Кнопки макета отображаются когда только панель компонентов видна */}\n          {showLayoutButtons && (\n            <LayoutButtons\n              onToggleCanvas={onToggleCanvas}\n              onToggleHeader={onToggleHeader}\n              onToggleProperties={onToggleProperties}\n              onShowFullLayout={onShowFullLayout}\n              canvasVisible={canvasVisible}\n              headerVisible={headerVisible}\n              propertiesVisible={propertiesVisible}\n              className=\"scale-75 -mr-2\"\n            />\n          )}\n        </div>\n        <div className=\"flex space-x-1 bg-muted rounded-lg p-1\">\n          <button \n            onClick={() => setCurrentTab('elements')}\n            className={`flex-1 px-1 py-1.5 text-xs font-medium rounded-md transition-colors ${\n              currentTab === 'elements' \n                ? 'bg-background text-foreground shadow-sm' \n                : 'text-muted-foreground hover:text-foreground'\n            }`}\n          >\n            Элементы\n          </button>\n          <button \n            onClick={() => setCurrentTab('projects')}\n            className={`flex-1 px-1 py-1.5 text-xs font-medium rounded-md transition-colors ${\n              currentTab === 'projects' \n                ? 'bg-background text-foreground shadow-sm' \n                : 'text-muted-foreground hover:text-foreground'\n            }`}\n          >\n            Проекты\n          </button>\n        </div>\n      </div>\n      \n      {/* Components List */}\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-4\">\n        {currentTab === 'projects' && (\n          <div className=\"space-y-4\">\n            {/* Заголовок и кнопки управления */}\n            <div className=\"space-y-3 mb-4\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-sm font-semibold text-foreground\">\n                  Проекты ({projects.length})\n                </h3>\n                <Button \n                  size=\"default\" \n                  variant=\"outline\" \n                  className=\"h-8 px-3 flex items-center gap-1\"\n                  onClick={handleCreateProject}\n                  disabled={createProjectMutation.isPending}\n                >\n                  <Plus className=\"h-4 w-4\" />\n                  <span className=\"text-sm\">Новый</span>\n                </Button>\n              </div>\n              \n            </div>\n\n            {/* Список проектов */}\n            {isLoading ? (\n              <div className=\"text-center py-4\">\n                <div className=\"w-6 h-6 bg-muted rounded-lg flex items-center justify-center mx-auto mb-2\">\n                  <i className=\"fas fa-spinner fa-spin text-muted-foreground text-xs\"></i>\n                </div>\n                <p className=\"text-xs text-muted-foreground\">Загрузка...</p>\n              </div>\n            ) : projects.length === 0 ? (\n              <div className=\"text-center py-8\">\n                <div className=\"bg-muted/30 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4\">\n                  <Home className=\"h-8 w-8 text-muted-foreground\" />\n                </div>\n                <h4 className=\"text-sm font-medium text-foreground mb-2\">Нет проектов</h4>\n                <p className=\"text-xs text-muted-foreground mb-4\">Создайте первый проект для начала работы</p>\n                <Button size=\"default\" onClick={handleCreateProject} disabled={createProjectMutation.isPending} className=\"h-10 px-6\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  {createProjectMutation.isPending ? 'Создание...' : 'Создать проект'}\n                </Button>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {projects.map((project: BotProject) => (\n                  <div\n                    key={project.id}\n                    draggable\n                    onDragStart={(e) => handleProjectDragStart(e, project)}\n                    onDragOver={(e) => handleProjectDragOver(e, project.id)}\n                    onDragLeave={handleProjectDragLeave}\n                    onDrop={(e) => handleProjectDrop(e, project)}\n                    onDragEnd={handleProjectDragEnd}\n                    className={`group p-4 rounded-xl cursor-pointer transition-all duration-200 border-2 hover:shadow-lg ${\n                      currentProjectId === project.id \n                        ? 'bg-primary/10 border-primary/30 shadow-md' \n                        : 'bg-background border-border/50 hover:bg-muted/30 hover:border-border'\n                    } ${\n                      dragOverProject === project.id ? 'border-primary border-2 scale-105 shadow-lg' : ''\n                    } ${\n                      draggedProject?.id === project.id ? 'opacity-50 scale-95' : ''\n                    }`}\n                    onClick={() => onProjectSelect && onProjectSelect(project.id)}\n                  >\n                    <div className=\"flex items-start justify-between mb-3\">\n                      <div className=\"flex items-center flex-1 min-w-0\">\n                        <div className=\"cursor-grab active:cursor-grabbing mr-3 opacity-0 group-hover:opacity-100 transition-opacity\">\n                          <GripVertical className=\"h-5 w-5 text-muted-foreground\" />\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <h4 className=\"text-base font-semibold text-foreground truncate mb-1\">\n                            {project.name}\n                          </h4>\n                          {project.description && (\n                            <p className=\"text-sm text-muted-foreground truncate\">\n                              {project.description}\n                            </p>\n                          )}\n                        </div>\n                      </div>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          handleDeleteProject(project.id);\n                        }}\n                        className=\"h-8 w-8 p-0 text-muted-foreground hover:text-destructive opacity-0 group-hover:opacity-100 transition-opacity hover:bg-destructive/10\"\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                    \n                    <div className=\"space-y-3 text-sm text-muted-foreground\">\n                      <div className=\"flex items-center justify-between gap-3\">\n                        <span className=\"flex items-center bg-muted/50 px-2 py-1 rounded-md\">\n                          <User className=\"h-4 w-4 mr-2\" />\n                          <span className=\"font-medium\">{getNodeCount(project)}</span>\n                          <span className=\"ml-1\">узлов</span>\n                        </span>\n                        <span className=\"flex items-center text-xs\">\n                          <Calendar className=\"h-3 w-3 mr-1\" />\n                          {formatDate(project.updatedAt)}\n                        </span>\n                      </div>\n                      \n                      {/* Информация о листах */}\n                      {(() => {\n                        const sheetsInfo = getSheetsInfo(project);\n                        return (\n                          <div className=\"space-y-1\">\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center text-sm text-muted-foreground\">\n                                <FileText className=\"h-4 w-4 mr-2\" />\n                                <span className=\"font-medium\">{sheetsInfo.count}</span>\n                                <span className=\"ml-1\">{sheetsInfo.count === 1 ? 'лист' : sheetsInfo.count < 5 ? 'листа' : 'листов'}</span>\n                              </div>\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                className=\"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-muted\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  if (currentProjectId === project.id && onSheetAdd) {\n                                    const sheetsInfo = getSheetsInfo(project);\n                                    const newSheetName = `Лист ${sheetsInfo.count + 1}`;\n                                    onSheetAdd(newSheetName);\n                                  }\n                                }}\n                                title=\"Добавить лист\"\n                              >\n                                <Plus className=\"h-3 w-3\" />\n                              </Button>\n                            </div>\n                            {sheetsInfo.names.length > 0 && (\n                              <div className=\"space-y-1.5 mt-2\">\n                                {sheetsInfo.names.map((name: string, index: number) => {\n                                const projectData = project.data as any;\n                                const sheetId = SheetsManager.isNewFormat(projectData) ? projectData.sheets[index]?.id : null;\n                                const isActive = currentProjectId === project.id && sheetId === activeSheetId;\n                                const isEditing = editingSheetId === sheetId;\n                                \n                                return (\n                                  <div key={index} className=\"flex items-center gap-2 group/sheet\">\n                                    {isEditing ? (\n                                      <Input\n                                        value={editingSheetName}\n                                        onChange={(e) => setEditingSheetName(e.target.value)}\n                                        onKeyDown={(e) => {\n                                          if (e.key === 'Enter') {\n                                            handleSaveSheetName();\n                                          } else if (e.key === 'Escape') {\n                                            handleCancelEditingSheet();\n                                          }\n                                        }}\n                                        onBlur={handleSaveSheetName}\n                                        autoFocus\n                                        className=\"text-xs px-3 py-1.5 h-7 flex-1 font-medium\"\n                                      />\n                                    ) : (\n                                      <Badge \n                                        variant={isActive ? \"default\" : \"secondary\"} \n                                        className={`text-xs px-3 py-1.5 h-7 cursor-pointer hover:opacity-80 transition-all flex-1 font-medium ${\n                                          isActive ? 'bg-primary text-primary-foreground shadow-sm' : ''\n                                        }`}\n                                        onClick={() => {\n                                          if (currentProjectId === project.id && onSheetSelect && SheetsManager.isNewFormat(projectData)) {\n                                            const sheetId = projectData.sheets[index]?.id;\n                                            if (sheetId) {\n                                              onSheetSelect(sheetId);\n                                            }\n                                          }\n                                        }}\n                                        onDoubleClick={() => {\n                                          // Включаем inline редактирование\n                                          if (currentProjectId === project.id && SheetsManager.isNewFormat(projectData)) {\n                                            const sheetId = projectData.sheets[index]?.id;\n                                            if (sheetId) {\n                                              handleStartEditingSheet(sheetId, name);\n                                            }\n                                          }\n                                        }}\n                                        title={name}\n                                      >\n                                        <span className=\"block text-center w-full truncate\">{name}</span>\n                                      </Badge>\n                                    )}\n                                    \n                                    {/* Кнопки управления листом */}\n                                    {currentProjectId === project.id && (\n                                      <div className=\"flex gap-1 opacity-0 group-hover/sheet:opacity-100 transition-opacity\">\n                                        <Button\n                                          variant=\"ghost\"\n                                          size=\"sm\"\n                                          className=\"h-6 w-6 p-0 hover:bg-muted\"\n                                          onClick={(e) => {\n                                            e.stopPropagation();\n                                            if (SheetsManager.isNewFormat(projectData)) {\n                                              const sheetId = projectData.sheets[index]?.id;\n                                              if (sheetId && onSheetDuplicate) {\n                                                onSheetDuplicate(sheetId);\n                                              }\n                                            }\n                                          }}\n                                          title=\"Дублировать лист\"\n                                        >\n                                          <Copy className=\"h-3 w-3\" />\n                                        </Button>\n                                        {sheetsInfo.count > 1 && (\n                                          <Button\n                                            variant=\"ghost\"\n                                            size=\"sm\"\n                                            className=\"h-6 w-6 p-0 text-destructive hover:text-destructive hover:bg-muted\"\n                                            onClick={(e) => {\n                                              e.stopPropagation();\n                                              if (SheetsManager.isNewFormat(projectData)) {\n                                                const sheetId = projectData.sheets[index]?.id;\n                                                if (sheetId && onSheetDelete) {\n                                                  onSheetDelete(sheetId);\n                                                }\n                                              }\n                                            }}\n                                            title=\"Удалить лист\"\n                                          >\n                                            <Trash2 className=\"h-3 w-3\" />\n                                          </Button>\n                                        )}\n                                      </div>\n                                    )}\n                                  </div>\n                                );\n                              })}\n                              </div>\n                            )}\n                          </div>\n                        );\n                      })()}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        )}\n        \n        {currentTab === 'elements' && componentCategories.map((category) => {\n          const isCollapsed = collapsedCategories.has(category.title);\n          \n          return (\n            <div key={category.title}>\n              <button\n                onClick={() => toggleCategory(category.title)}\n                className=\"w-full flex items-center justify-between text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2 hover:text-foreground transition-colors group\"\n              >\n                <span>{category.title}</span>\n                <div className=\"flex items-center gap-1\">\n                  <span className=\"text-xs normal-case bg-muted/50 px-2 py-0.5 rounded-full\">\n                    {category.components.length}\n                  </span>\n                  {isCollapsed ? (\n                    <ChevronRight className=\"h-3 w-3 group-hover:text-foreground transition-colors\" />\n                  ) : (\n                    <ChevronDown className=\"h-3 w-3 group-hover:text-foreground transition-colors\" />\n                  )}\n                </div>\n              </button>\n              \n              {!isCollapsed && (\n                <div className=\"space-y-2 transition-all duration-200 ease-in-out\">\n                  {category.components.map((component) => (\n                    <div\n                      key={component.id}\n                      draggable\n                      onDragStart={(e) => handleDragStart(e, component)}\n                      onTouchStart={(e) => handleTouchStart(e, component)}\n                      onTouchMove={handleTouchMove}\n                      onTouchEnd={handleTouchEnd}\n                      className={`component-item group flex items-center p-3 bg-muted/50 hover:bg-muted rounded-lg cursor-move transition-colors touch-action-none no-select ${\n                        touchedComponent?.id === component.id && isDragging ? 'opacity-50 scale-95' : ''\n                      }`}\n                    >\n                      <div className={cn(\"w-8 h-8 rounded-lg flex items-center justify-center mr-3\", component.color)}>\n                        <i className={`${component.icon} text-sm`}></i>\n                      </div>\n                      <div className=\"flex-1\">\n                        <p className=\"text-sm font-medium text-foreground\">{component.name}</p>\n                        <p className=\"text-xs text-muted-foreground\">{component.description}</p>\n                      </div>\n                      {onComponentAdd && (\n                        <button\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            onComponentAdd(component);\n                          }}\n                          className=\"ml-2 w-6 h-6 rounded-full bg-primary/10 hover:bg-primary/20 text-primary flex items-center justify-center transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100\"\n                          title={`Добавить ${component.name} на холст`}\n                        >\n                          <Plus className=\"h-3 w-3\" />\n                        </button>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n\n  // На мобильных устройствах возвращаем содержимое для использования в Sheet из editor.tsx\n  if (isActuallyMobile || isMobile) {\n    return <SidebarContent />;\n  }\n\n  // Десктопная версия\n  return (\n    <aside className=\"w-full bg-background h-full flex flex-col overflow-hidden\">\n      <SidebarContent />\n    </aside>\n  );\n}\n","size_bytes":55411},"client/src/components/layout/simple-layout-customizer.tsx":{"content":"import React, { useState, useCallback } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Switch } from '@/components/ui/switch';\nimport { Label } from '@/components/ui/label';\nimport { Slider } from '@/components/ui/slider';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Separator } from '@/components/ui/separator';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { \n  Layout, \n  Settings, \n  RotateCcw, \n  ArrowUp,\n  ArrowDown,\n  ArrowLeft,\n  ArrowRight,\n  Navigation,\n  Sidebar,\n  Monitor,\n  Sliders,\n  Grid,\n  Save,\n  Eye,\n  EyeOff,\n  Palette,\n  Zap,\n  Download,\n  Upload,\n  Maximize2,\n  Minimize2,\n  Move,\n  ArrowUpDown,\n  ArrowLeftRight,\n  LayoutDashboard,\n  Smartphone,\n  Tablet\n} from 'lucide-react';\n\nexport interface SimpleLayoutElement {\n  id: string;\n  type: 'header' | 'sidebar' | 'canvas' | 'properties' | 'code';\n  name: string;\n  position: 'top' | 'bottom' | 'left' | 'right' | 'center';\n  size: number;\n  visible: boolean;\n}\n\nexport interface SimpleLayoutConfig {\n  elements: SimpleLayoutElement[];\n  compactMode: boolean;\n  showGrid: boolean;\n}\n\ninterface SimpleLayoutCustomizerProps {\n  config: SimpleLayoutConfig;\n  onConfigChange: (config: SimpleLayoutConfig) => void;\n  children?: React.ReactNode;\n}\n\nconst DEFAULT_CONFIG: SimpleLayoutConfig = {\n  elements: [\n    {\n      id: 'header',\n      type: 'header',\n      name: 'Шапка',\n      position: 'top',\n      size: 64,\n      visible: true\n    },\n    {\n      id: 'sidebar',\n      type: 'sidebar',\n      name: 'Боковая панель',\n      position: 'left',\n      size: 20,\n      visible: true\n    },\n    {\n      id: 'canvas',\n      type: 'canvas',\n      name: 'Холст',\n      position: 'center',\n      size: 55,\n      visible: true\n    },\n    {\n      id: 'properties',\n      type: 'properties',\n      name: 'Свойства',\n      position: 'right',\n      size: 25,\n      visible: true\n    }\n  ],\n  compactMode: false,\n  showGrid: true\n};\n\nexport const SimpleLayoutCustomizer: React.FC<SimpleLayoutCustomizerProps> = ({\n  config,\n  onConfigChange,\n  children\n}) => {\n  const [isOpen, setIsOpen] = useState(false);\n  const [tempConfig, setTempConfig] = useState<SimpleLayoutConfig>(config);\n\n  const handleElementUpdate = useCallback((elementId: string, updates: Partial<SimpleLayoutElement>) => {\n    setTempConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(element =>\n        element.id === elementId\n          ? { ...element, ...updates }\n          : element\n      )\n    }));\n  }, []);\n\n  const handleApply = useCallback(() => {\n    onConfigChange(tempConfig);\n    setIsOpen(false);\n  }, [tempConfig, onConfigChange]);\n\n  const handleCancel = useCallback(() => {\n    setTempConfig(config);\n    setIsOpen(false);\n  }, [config]);\n\n  const handleReset = useCallback(() => {\n    setTempConfig(DEFAULT_CONFIG);\n  }, []);\n\n\n\n  const getIcon = (type: string) => {\n    switch (type) {\n      case 'header':\n        return <Navigation className=\"w-4 h-4\" />;\n      case 'sidebar':\n        return <Sidebar className=\"w-4 h-4\" />;\n      case 'canvas':\n        return <Monitor className=\"w-4 h-4\" />;\n      case 'properties':\n        return <Sliders className=\"w-4 h-4\" />;\n      default:\n        return <Layout className=\"w-4 h-4\" />;\n    }\n  };\n\n  const getPositionIcon = (position: string) => {\n    switch (position) {\n      case 'top':\n        return <ArrowUp className=\"w-3 h-3\" />;\n      case 'bottom':\n        return <ArrowDown className=\"w-3 h-3\" />;\n      case 'left':\n        return <ArrowLeft className=\"w-3 h-3\" />;\n      case 'right':\n        return <ArrowRight className=\"w-3 h-3\" />;\n      case 'center':\n        return <Grid className=\"w-3 h-3\" />;\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <div className=\"relative\">\n      {/* Диалог настроек - скрыт, доступен только программно */}\n      <div className=\"hidden\">\n        <Dialog open={isOpen} onOpenChange={setIsOpen}>\n          <DialogTrigger asChild>\n            <div />\n          </DialogTrigger>\n          <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-hidden\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <LayoutDashboard className=\"w-5 h-5\" />\n                Настройка макета интерфейса\n              </DialogTitle>\n            </DialogHeader>\n            \n            <div className=\"flex h-[700px] gap-6\">\n              {/* Панель настроек */}\n              <div className=\"w-96 flex flex-col\">\n                <Tabs defaultValue=\"elements\" className=\"flex-1 flex flex-col\">\n                  <TabsList className=\"grid w-full grid-cols-3\">\n                    <TabsTrigger value=\"elements\" className=\"flex items-center gap-1\">\n                      <Layout className=\"w-4 h-4\" />\n                      Элементы\n                    </TabsTrigger>\n                    <TabsTrigger value=\"presets\" className=\"flex items-center gap-1\">\n                      <Zap className=\"w-4 h-4\" />\n                      Пресеты\n                    </TabsTrigger>\n                    <TabsTrigger value=\"advanced\" className=\"flex items-center gap-1\">\n                      <Settings className=\"w-4 h-4\" />\n                      Продвинутые\n                    </TabsTrigger>\n                  </TabsList>\n\n                  <TabsContent value=\"elements\" className=\"flex-1 overflow-auto space-y-4 mt-4\">\n                    {/* Элементы интерфейса */}\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <LayoutDashboard className=\"w-4 h-4\" />\n                        <h3 className=\"font-semibold\">Элементы интерфейса</h3>\n                      </div>\n                      {tempConfig.elements.map(element => (\n                      <Card key={element.id} className=\"p-3\">\n                        <div className=\"space-y-3\">\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center space-x-2\">\n                              {getIcon(element.type)}\n                              <span className=\"font-medium\">{element.name}</span>\n                            </div>\n                            <Switch\n                              checked={element.visible}\n                              onCheckedChange={(checked) => \n                                handleElementUpdate(element.id, { visible: checked })\n                              }\n                            />\n                          </div>\n                          \n                          {element.visible && (\n                            <div className=\"space-y-2\">\n                              <div>\n                                <Label className=\"text-sm\">Позиция</Label>\n                                <Select\n                                  value={element.position}\n                                  onValueChange={(value) => \n                                    handleElementUpdate(element.id, { position: value as any })\n                                  }\n                                >\n                                  <SelectTrigger className=\"w-full\">\n                                    <SelectValue />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value=\"top\">Сверху</SelectItem>\n                                    <SelectItem value=\"bottom\">Снизу</SelectItem>\n                                    <SelectItem value=\"left\">Слева</SelectItem>\n                                    <SelectItem value=\"right\">Справа</SelectItem>\n                                    <SelectItem value=\"center\">Центр</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </div>\n                              \n                              <div>\n                                <Label className=\"text-sm\">Размер: {element.size}%</Label>\n                                <Slider\n                                  value={[element.size]}\n                                  onValueChange={(value) => \n                                    handleElementUpdate(element.id, { size: value[0] })\n                                  }\n                                  max={80}\n                                  min={5}\n                                  step={5}\n                                  className=\"w-full\"\n                                />\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      </Card>\n                    ))}\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"presets\" className=\"flex-1 overflow-auto space-y-4 mt-4\">\n                    {/* Быстрые пресеты */}\n                    <div className=\"space-y-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <Zap className=\"w-4 h-4\" />\n                        <h3 className=\"font-semibold\">Быстрые пресеты</h3>\n                      </div>\n                      <div className=\"grid grid-cols-1 gap-3\">\n                        <Card className=\"p-4 cursor-pointer hover:bg-accent transition-colors\" onClick={() => {\n                          const preset = {\n                            ...tempConfig,\n                            elements: tempConfig.elements.map(el => ({\n                              ...el,\n                              position: (el.type === 'header' ? 'bottom' : el.position) as SimpleLayoutElement['position']\n                            }))\n                          };\n                          setTempConfig(preset);\n                        }}>\n                          <div className=\"flex items-center gap-3\">\n                            <ArrowDown className=\"w-5 h-5 text-blue-500\" />\n                            <div>\n                              <h4 className=\"font-medium\">Шапка снизу</h4>\n                              <p className=\"text-sm text-muted-foreground\">Переместить заголовок в нижнюю часть</p>\n                            </div>\n                          </div>\n                        </Card>\n\n                        <Card className=\"p-4 cursor-pointer hover:bg-accent transition-colors\" onClick={() => {\n                          const preset = {\n                            ...tempConfig,\n                            elements: tempConfig.elements.map(el => ({\n                              ...el,\n                              visible: el.type === 'canvas' || el.type === 'header'\n                            }))\n                          };\n                          setTempConfig(preset);\n                        }}>\n                          <div className=\"flex items-center gap-3\">\n                            <Minimize2 className=\"w-5 h-5 text-green-500\" />\n                            <div>\n                              <h4 className=\"font-medium\">Минимальный режим</h4>\n                              <p className=\"text-sm text-muted-foreground\">Только холст и заголовок</p>\n                            </div>\n                          </div>\n                        </Card>\n\n                        <Card className=\"p-4 cursor-pointer hover:bg-accent transition-colors\" onClick={() => {\n                          const preset = {\n                            ...tempConfig,\n                            elements: tempConfig.elements.map(el => ({\n                              ...el,\n                              visible: true,\n                              position: (el.type === 'header' ? 'top' : \n                                       el.type === 'sidebar' ? 'left' :\n                                       el.type === 'properties' ? 'right' : 'center') as SimpleLayoutElement['position']\n                            }))\n                          };\n                          setTempConfig(preset);\n                        }}>\n                          <div className=\"flex items-center gap-3\">\n                            <Maximize2 className=\"w-5 h-5 text-purple-500\" />\n                            <div>\n                              <h4 className=\"font-medium\">Полный режим</h4>\n                              <p className=\"text-sm text-muted-foreground\">Показать все панели</p>\n                            </div>\n                          </div>\n                        </Card>\n                      </div>\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"advanced\" className=\"flex-1 overflow-auto space-y-4 mt-4\">\n                    {/* Продвинутые настройки */}\n                    <div className=\"space-y-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <Settings className=\"w-4 h-4\" />\n                        <h3 className=\"font-semibold\">Продвинутые настройки</h3>\n                      </div>\n\n                      <div className=\"space-y-3\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Switch\n                            id=\"compact\"\n                            checked={tempConfig.compactMode}\n                            onCheckedChange={(checked) => \n                              setTempConfig(prev => ({ ...prev, compactMode: checked }))\n                            }\n                          />\n                          <Label htmlFor=\"compact\">Компактный режим</Label>\n                        </div>\n                        \n                        <div className=\"flex items-center space-x-2\">\n                          <Switch\n                            id=\"grid\"\n                            checked={tempConfig.showGrid}\n                            onCheckedChange={(checked) => \n                              setTempConfig(prev => ({ ...prev, showGrid: checked }))\n                            }\n                          />\n                          <Label htmlFor=\"grid\">Показывать сетку</Label>\n                        </div>\n                      </div>\n\n                      <Separator />\n\n                      <div className=\"space-y-3\">\n                        <h4 className=\"font-medium flex items-center gap-2\">\n                          <Palette className=\"w-4 h-4\" />\n                          Экспорт и импорт\n                        </h4>\n                        <div className=\"flex gap-2\">\n                          <Button variant=\"outline\" size=\"sm\" className=\"flex-1\">\n                            <Download className=\"w-4 h-4 mr-2\" />\n                            Экспорт\n                          </Button>\n                          <Button variant=\"outline\" size=\"sm\" className=\"flex-1\">\n                            <Upload className=\"w-4 h-4 mr-2\" />\n                            Импорт\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  </TabsContent>\n                  {/* Кнопки действий */}\n                  <div className=\"flex items-center justify-between border-t pt-4 mt-4\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={handleReset}\n                  >\n                    <RotateCcw className=\"w-4 h-4 mr-2\" />\n                    Сброс\n                  </Button>\n                  <div className=\"flex items-center space-x-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={handleCancel}\n                    >\n                      Отмена\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      onClick={handleApply}\n                    >\n                      <Save className=\"w-4 h-4 mr-2\" />\n                      Применить\n                    </Button>\n                  </div>\n                  </div>\n                </Tabs>\n              </div>\n              \n              {/* Предварительный просмотр */}\n              <div className=\"flex-1 bg-gray-50 dark:bg-gray-900 rounded-lg p-4\">\n                <div className=\"h-full border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg relative\">\n                  <div className=\"absolute top-2 left-2 bg-white dark:bg-gray-800 px-2 py-1 rounded text-xs font-medium\">\n                    Предварительный просмотр\n                  </div>\n                  <div className=\"h-full p-6 pt-10\">\n                    <div className=\"h-full grid gap-2\" style={{\n                      gridTemplateAreas: `\n                        \"${tempConfig.elements.find(e => e.position === 'top' && e.visible)?.id || '.'}\"\n                        \"${tempConfig.elements.find(e => e.position === 'left' && e.visible)?.id || '.'} ${tempConfig.elements.find(e => e.position === 'center' && e.visible)?.id || '.'} ${tempConfig.elements.find(e => e.position === 'right' && e.visible)?.id || '.'}\"\n                        \"${tempConfig.elements.find(e => e.position === 'bottom' && e.visible)?.id || '.'}\"\n                      `,\n                      gridTemplateRows: `${tempConfig.elements.find(e => e.position === 'top' && e.visible)?.size || 0}px 1fr ${tempConfig.elements.find(e => e.position === 'bottom' && e.visible)?.size || 0}px`,\n                      gridTemplateColumns: `${tempConfig.elements.find(e => e.position === 'left' && e.visible)?.size || 0}px 1fr ${tempConfig.elements.find(e => e.position === 'right' && e.visible)?.size || 0}px`,\n                    }}>\n                      {tempConfig.elements.filter(e => e.visible).map(element => (\n                        <div\n                          key={element.id}\n                          style={{ gridArea: element.id }}\n                          className=\"border border-gray-200 dark:border-gray-700 rounded flex items-center justify-center bg-white dark:bg-gray-800\"\n                        >\n                          <div className=\"text-center\">\n                            {getIcon(element.type)}\n                            <p className=\"text-xs font-medium mt-1\">{element.name}</p>\n                            <div className=\"flex items-center justify-center mt-1\">\n                              {getPositionIcon(element.position)}\n                              <span className=\"text-xs ml-1\">{element.size}%</span>\n                            </div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n\n\n      {/* Основной контент */}\n      <div className=\"h-screen\">\n        {children}\n      </div>\n    </div>\n  );\n};\n\nexport default SimpleLayoutCustomizer;","size_bytes":19763},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5742},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"server/db-utils.ts":{"content":"import { db, pool } from './db';\nimport { sql } from 'drizzle-orm';\n\n// Database connection monitoring and optimization utilities\nexport class DatabaseManager {\n  private static instance: DatabaseManager;\n  private healthCheckInterval: NodeJS.Timeout | null = null;\n  private connectionStats = {\n    totalConnections: 0,\n    activeConnections: 0,\n    idleConnections: 0,\n    errors: 0,\n    lastHealthCheck: new Date()\n  };\n\n  private constructor() {}\n\n  static getInstance(): DatabaseManager {\n    if (!DatabaseManager.instance) {\n      DatabaseManager.instance = new DatabaseManager();\n    }\n    return DatabaseManager.instance;\n  }\n\n  // Start monitoring database health\n  startHealthMonitoring(intervalMs: number = 30000): void {\n    if (this.healthCheckInterval) {\n      clearInterval(this.healthCheckInterval);\n    }\n\n    this.healthCheckInterval = setInterval(async () => {\n      try {\n        await this.performHealthCheck();\n      } catch (error) {\n        console.error('Database health check failed:', error);\n        this.connectionStats.errors++;\n      }\n    }, intervalMs);\n\n    console.log('Database health monitoring started');\n  }\n\n  // Stop monitoring\n  stopHealthMonitoring(): void {\n    if (this.healthCheckInterval) {\n      clearInterval(this.healthCheckInterval);\n      this.healthCheckInterval = null;\n    }\n    console.log('Database health monitoring stopped');\n  }\n\n  // Perform health check\n  async performHealthCheck(): Promise<boolean> {\n    try {\n      // Test connection with a simple query\n      const result = await db.execute(sql`SELECT 1 as health`);\n      \n      // Update connection stats\n      this.connectionStats.totalConnections = pool.totalCount;\n      this.connectionStats.activeConnections = pool.totalCount - pool.idleCount;\n      this.connectionStats.idleConnections = pool.idleCount;\n      this.connectionStats.lastHealthCheck = new Date();\n\n      return true;\n    } catch (error) {\n      console.error('Health check failed:', error);\n      this.connectionStats.errors++;\n      return false;\n    }\n  }\n\n  // Get connection statistics\n  getConnectionStats() {\n    return {\n      ...this.connectionStats,\n      poolInfo: {\n        totalCount: pool.totalCount,\n        idleCount: pool.idleCount,\n        waitingCount: pool.waitingCount,\n        maxSize: 'N/A',\n        minSize: 'N/A'\n      }\n    };\n  }\n\n  // Optimize database connections\n  async optimizeConnections(): Promise<void> {\n    try {\n      // Close idle connections if there are too many\n      if (this.connectionStats.idleConnections > 5) {\n        console.log('Optimizing database connections...');\n        // Force garbage collection on idle connections\n        await pool.query('SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE state = \\'idle\\' AND query_start < NOW() - INTERVAL \\'5 minutes\\'');\n      }\n\n      // Analyze database performance\n      const slowQueries = await db.execute(sql`\n        SELECT query, calls, total_time, mean_time\n        FROM pg_stat_statements \n        WHERE mean_time > 1000 \n        ORDER BY mean_time DESC \n        LIMIT 10\n      `);\n\n      if (slowQueries.rows.length > 0) {\n        console.log('Found slow queries:', slowQueries.rows);\n      }\n    } catch (error) {\n      console.warn('Could not optimize connections:', error);\n    }\n  }\n\n  // Execute query with retry logic\n  async executeWithRetry<T>(\n    operation: () => Promise<T>,\n    maxRetries: number = 3,\n    retryDelay: number = 1000\n  ): Promise<T> {\n    let lastError: Error | null = null;\n\n    for (let attempt = 1; attempt <= maxRetries; attempt++) {\n      try {\n        return await operation();\n      } catch (error) {\n        lastError = error as Error;\n        console.warn(`Database operation failed (attempt ${attempt}/${maxRetries}):`, error);\n\n        if (attempt === maxRetries) {\n          break;\n        }\n\n        // Wait before retry\n        await new Promise(resolve => setTimeout(resolve, retryDelay * attempt));\n      }\n    }\n\n    throw lastError;\n  }\n\n  // Transaction wrapper with automatic rollback\n  async transaction<T>(\n    operation: (txDb: any) => Promise<T>\n  ): Promise<T> {\n    return await db.transaction(async (tx) => {\n      try {\n        const result = await operation(tx);\n        return result;\n      } catch (error) {\n        console.error('Transaction failed, rolling back:', error);\n        throw error;\n      }\n    });\n  }\n\n  // Backup database (basic implementation)\n  async createBackup(): Promise<string> {\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n    const backupName = `backup_${timestamp}`;\n    \n    try {\n      // This is a simplified backup - in production you'd use pg_dump\n      await db.execute(sql`\n        SELECT pg_terminate_backend(pid)\n        FROM pg_stat_activity\n        WHERE datname = current_database() AND pid <> pg_backend_pid()\n      `);\n      \n      console.log(`Backup created: ${backupName}`);\n      return backupName;\n    } catch (error) {\n      console.error('Backup failed:', error);\n      throw error;\n    }\n  }\n\n  // Clean up old data\n  async cleanupOldData(daysToKeep: number = 30): Promise<void> {\n    const cutoffDate = new Date();\n    cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);\n\n    try {\n      // Clean up old bot instances\n      const cleanupResult = await db.execute(sql`\n        DELETE FROM bot_instances \n        WHERE status = 'stopped' AND stopped_at < ${cutoffDate}\n      `);\n\n      console.log(`Cleaned up ${cleanupResult.rowCount} old bot instances`);\n\n      // Clean up old user interactions (optional)\n      await db.execute(sql`\n        DELETE FROM user_bot_data \n        WHERE is_active = 0 AND updated_at < ${cutoffDate}\n      `);\n\n    } catch (error) {\n      console.error('Cleanup failed:', error);\n      throw error;\n    }\n  }\n\n  // Get database metrics\n  async getDatabaseMetrics() {\n    try {\n      const metrics = await db.execute(sql`\n        SELECT \n          schemaname,\n          tablename,\n          n_tup_ins as inserts,\n          n_tup_upd as updates,\n          n_tup_del as deletes,\n          n_live_tup as live_rows,\n          n_dead_tup as dead_rows\n        FROM pg_stat_user_tables\n        ORDER BY n_live_tup DESC\n      `);\n\n      return metrics.rows;\n    } catch (error) {\n      console.error('Failed to get database metrics:', error);\n      return [];\n    }\n  }\n}\n\n// Export singleton instance\nexport const dbManager = DatabaseManager.getInstance();\n\n// Auto-start monitoring when module is imported\ndbManager.startHealthMonitoring();\n\n// Graceful shutdown\nprocess.on('SIGTERM', () => {\n  dbManager.stopHealthMonitoring();\n  pool.end();\n});\n\nprocess.on('SIGINT', () => {\n  dbManager.stopHealthMonitoring();\n  pool.end();\n});","size_bytes":6695},"client/src/utils/sheets-manager.ts":{"content":"import { nanoid } from 'nanoid';\nimport { CanvasSheet, BotDataWithSheets, BotData, Node, Connection } from '@shared/schema';\n\nexport class SheetsManager {\n  \n  // Миграция старых данных к новому формату с листами\n  static migrateLegacyData(legacyData: BotData): BotDataWithSheets {\n    const defaultSheet: CanvasSheet = {\n      id: nanoid(),\n      name: 'Основной поток',\n      nodes: legacyData.nodes || [],\n      connections: legacyData.connections || [],\n      viewState: {\n        pan: { x: 0, y: 0 },\n        zoom: 100\n      },\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n\n    return {\n      sheets: [defaultSheet],\n      activeSheetId: defaultSheet.id,\n      version: 2\n    };\n  }\n\n  // Проверка, является ли данные новым форматом с листами\n  static isNewFormat(data: any): data is BotDataWithSheets {\n    return data && data.version === 2 && Array.isArray(data.sheets);\n  }\n\n  // Создание нового листа\n  static createSheet(name: string, nodes: Node[] = [], connections: Connection[] = []): CanvasSheet {\n    // Если узлы не переданы, создаем стартовый узел по умолчанию\n    const defaultNodes = nodes.length === 0 ? [{\n      id: 'start',\n      type: 'start' as const,\n      position: { x: 100, y: 100 },\n      data: {\n        messageText: 'Привет! Я ваш новый бот. Нажмите /help для получения помощи.',\n        keyboardType: 'none' as const,\n        buttons: [],\n        resizeKeyboard: true,\n        oneTimeKeyboard: false,\n        markdown: false,\n        formatMode: 'none' as const,\n        synonyms: [],\n        isPrivateOnly: false,\n        adminOnly: false,\n        requiresAuth: false,\n        showInMenu: true,\n        enableStatistics: true,\n        customParameters: [],\n        options: [],\n        command: '/start',\n        description: 'Запустить бота'\n      }\n    }] : nodes;\n\n    return {\n      id: nanoid(),\n      name,\n      nodes: defaultNodes,\n      connections,\n      viewState: {\n        pan: { x: 0, y: 0 },\n        zoom: 100\n      },\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n  }\n\n  // Дублирование листа\n  static duplicateSheet(originalSheet: CanvasSheet): CanvasSheet {\n    const duplicatedNodes = originalSheet.nodes.map(node => ({\n      ...node,\n      id: nanoid(),\n      position: {\n        x: node.position.x + 50, // Смещение для видимости\n        y: node.position.y + 50\n      }\n    }));\n\n    // Обновляем ID в соединениях\n    const nodeIdMap = new Map(\n      originalSheet.nodes.map((node, index) => [node.id, duplicatedNodes[index].id])\n    );\n\n    const duplicatedConnections = originalSheet.connections.map(conn => ({\n      ...conn,\n      id: nanoid(),\n      source: nodeIdMap.get(conn.source) || conn.source,\n      target: nodeIdMap.get(conn.target) || conn.target\n    }));\n\n    return {\n      id: nanoid(),\n      name: `${originalSheet.name} (копия)`,\n      nodes: duplicatedNodes,\n      connections: duplicatedConnections,\n      viewState: { ...originalSheet.viewState },\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n  }\n\n  // Добавление нового листа в проект\n  static addSheet(data: BotDataWithSheets, name: string): BotDataWithSheets {\n    const newSheet = this.createSheet(name);\n    return {\n      ...data,\n      sheets: [...data.sheets, newSheet],\n      activeSheetId: newSheet.id\n    };\n  }\n\n  // Удаление листа\n  static deleteSheet(data: BotDataWithSheets, sheetId: string): BotDataWithSheets {\n    if (data.sheets.length <= 1) {\n      throw new Error('Нельзя удалить последний лист');\n    }\n\n    const filteredSheets = data.sheets.filter(sheet => sheet.id !== sheetId);\n    const newActiveSheetId = data.activeSheetId === sheetId \n      ? filteredSheets[0].id \n      : data.activeSheetId;\n\n    return {\n      ...data,\n      sheets: filteredSheets,\n      activeSheetId: newActiveSheetId\n    };\n  }\n\n  // Переименование листа\n  static renameSheet(data: BotDataWithSheets, sheetId: string, newName: string): BotDataWithSheets {\n    return {\n      ...data,\n      sheets: data.sheets.map(sheet => \n        sheet.id === sheetId \n          ? { ...sheet, name: newName, updatedAt: new Date() }\n          : sheet\n      )\n    };\n  }\n\n  // Дублирование листа в проекте\n  static duplicateSheetInProject(data: BotDataWithSheets, sheetId: string): BotDataWithSheets {\n    const originalSheet = data.sheets.find(sheet => sheet.id === sheetId);\n    if (!originalSheet) {\n      throw new Error('Лист не найден');\n    }\n\n    const duplicatedSheet = this.duplicateSheet(originalSheet);\n    return {\n      ...data,\n      sheets: [...data.sheets, duplicatedSheet],\n      activeSheetId: duplicatedSheet.id\n    };\n  }\n\n  // Обновление активного листа\n  static setActiveSheet(data: BotDataWithSheets, sheetId: string): BotDataWithSheets {\n    const sheetExists = data.sheets.some(sheet => sheet.id === sheetId);\n    if (!sheetExists) {\n      throw new Error('Лист не найден');\n    }\n\n    return {\n      ...data,\n      activeSheetId: sheetId\n    };\n  }\n\n  // Обновление узлов в листе\n  static updateSheetNodes(data: BotDataWithSheets, sheetId: string, nodes: Node[]): BotDataWithSheets {\n    return {\n      ...data,\n      sheets: data.sheets.map(sheet => \n        sheet.id === sheetId \n          ? { ...sheet, nodes, updatedAt: new Date() }\n          : sheet\n      )\n    };\n  }\n\n  // Обновление соединений в листе\n  static updateSheetConnections(data: BotDataWithSheets, sheetId: string, connections: Connection[]): BotDataWithSheets {\n    return {\n      ...data,\n      sheets: data.sheets.map(sheet => \n        sheet.id === sheetId \n          ? { ...sheet, connections, updatedAt: new Date() }\n          : sheet\n      )\n    };\n  }\n\n  // Обновление узлов и соединений в листе одновременно\n  static updateSheetData(data: BotDataWithSheets, sheetId: string, nodes: Node[], connections: Connection[]): BotDataWithSheets {\n    return {\n      ...data,\n      sheets: data.sheets.map(sheet => \n        sheet.id === sheetId \n          ? { ...sheet, nodes, connections, updatedAt: new Date() }\n          : sheet\n      )\n    };\n  }\n\n  // Обновление состояния вида листа (зум, панорамирование)\n  static updateSheetViewState(data: BotDataWithSheets, sheetId: string, viewState: { pan: { x: number; y: number }; zoom: number }): BotDataWithSheets {\n    return {\n      ...data,\n      sheets: data.sheets.map(sheet => \n        sheet.id === sheetId \n          ? { ...sheet, viewState, updatedAt: new Date() }\n          : sheet\n      )\n    };\n  }\n\n  // Получение активного листа\n  static getActiveSheet(data: BotDataWithSheets): CanvasSheet | null {\n    if (!data.activeSheetId) {\n      return data.sheets[0] || null;\n    }\n    return data.sheets.find(sheet => sheet.id === data.activeSheetId) || null;\n  }\n\n  // Валидация структуры данных\n  static validateData(data: BotDataWithSheets): string[] {\n    const errors: string[] = [];\n\n    if (!Array.isArray(data.sheets)) {\n      errors.push('Некорректная структура листов');\n    }\n\n    if (data.sheets.length === 0) {\n      errors.push('Проект должен содержать хотя бы один лист');\n    }\n\n    const activeSheet = this.getActiveSheet(data);\n    if (!activeSheet) {\n      errors.push('Активный лист не найден');\n    }\n\n    // Проверка уникальности ID листов\n    const sheetIds = data.sheets.map(sheet => sheet.id);\n    const uniqueIds = new Set(sheetIds);\n    if (sheetIds.length !== uniqueIds.size) {\n      errors.push('Обнаружены дублирующиеся ID листов');\n    }\n\n    return errors;\n  }\n\n  // Конвертация обратно в старый формат для совместимости\n  static toLegacyFormat(data: BotDataWithSheets): BotData {\n    const activeSheet = this.getActiveSheet(data);\n    if (!activeSheet) {\n      return { nodes: [], connections: [] };\n    }\n\n    return {\n      nodes: activeSheet.nodes,\n      connections: activeSheet.connections\n    };\n  }\n}","size_bytes":8571},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/media/media-selector.tsx":{"content":"import React, { useState } from 'react';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { MediaManager } from \"./media-manager\";\nimport { UrlDownloader } from \"./url-downloader\";\nimport type { MediaFile } from \"@shared/schema\";\nimport { Upload, X, Eye, FileText, Image, Play, Volume2, LinkIcon, Download } from \"lucide-react\";\n\ninterface MediaSelectorProps {\n  projectId: number;\n  value?: string;\n  onChange: (url: string, fileName?: string) => void;\n  fileType?: 'photo' | 'video' | 'audio' | 'document';\n  placeholder?: string;\n  label?: string;\n}\n\nexport function MediaSelector({ \n  projectId, \n  value, \n  onChange, \n  fileType, \n  placeholder = \"Выберите файл или введите URL\",\n  label = \"Медиафайл\"\n}: MediaSelectorProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<MediaFile | null>(null);\n\n  const handleSelectFile = (file: MediaFile) => {\n    setSelectedFile(file);\n    onChange(file.url, file.fileName);\n    setIsOpen(false);\n  };\n\n  const handleClearSelection = () => {\n    setSelectedFile(null);\n    onChange('');\n  };\n\n  const getFileIcon = (fileType: string) => {\n    switch (fileType) {\n      case 'photo': return <Image className=\"w-4 h-4\" />;\n      case 'video': return <Play className=\"w-4 h-4\" />;\n      case 'audio': return <Volume2 className=\"w-4 h-4\" />;\n      case 'document': return <FileText className=\"w-4 h-4\" />;\n      default: return <FileText className=\"w-4 h-4\" />;\n    }\n  };\n\n  const isUsingUploadedFile = selectedFile && value === selectedFile.url;\n\n  return (\n    <div className=\"space-y-3\">\n      <label className=\"text-sm font-medium block\">{label}</label>\n      \n      {isUsingUploadedFile ? (\n        <div className=\"flex items-center justify-between p-3 border rounded-lg bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800\">\n          <div className=\"flex items-center gap-2\">\n            {getFileIcon(selectedFile.fileType)}\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium truncate\">{selectedFile.fileName}</p>\n              <p className=\"text-xs text-gray-500 truncate\">{selectedFile.url}</p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-1\">\n            {selectedFile.fileType === 'photo' && (\n              <Button\n                size=\"sm\"\n                variant=\"ghost\"\n                onClick={() => window.open(selectedFile.url, '_blank')}\n                className=\"h-7 w-7 p-0\"\n              >\n                <Eye className=\"w-3 h-3\" />\n              </Button>\n            )}\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              onClick={handleClearSelection}\n              className=\"h-7 w-7 p-0 text-red-600 hover:text-red-700\"\n            >\n              <X className=\"w-3 h-3\" />\n            </Button>\n          </div>\n        </div>\n      ) : (\n        <div className=\"space-y-2\">\n          <Input\n            value={value || ''}\n            onChange={(e) => onChange(e.target.value)}\n            placeholder={placeholder}\n            className=\"mb-2\"\n          />\n          \n          <Dialog open={isOpen} onOpenChange={setIsOpen}>\n            <DialogTrigger asChild>\n              <Button variant=\"outline\" size=\"sm\" className=\"w-full\">\n                <Upload className=\"w-4 h-4 mr-2\" />\n                Выбрать или загрузить файл\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-5xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Управление медиафайлами</DialogTitle>\n              </DialogHeader>\n              \n              <Tabs defaultValue=\"library\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-3\">\n                  <TabsTrigger value=\"library\" className=\"flex items-center gap-2\">\n                    <Image className=\"w-4 h-4\" />\n                    Библиотека файлов\n                  </TabsTrigger>\n                  <TabsTrigger value=\"upload\" className=\"flex items-center gap-2\">\n                    <Upload className=\"w-4 h-4\" />\n                    Загрузить файлы\n                  </TabsTrigger>\n                  <TabsTrigger value=\"url\" className=\"flex items-center gap-2\">\n                    <LinkIcon className=\"w-4 h-4\" />\n                    Загрузить по URL\n                  </TabsTrigger>\n                </TabsList>\n                \n                <TabsContent value=\"library\" className=\"mt-4\">\n                  <MediaManager \n                    projectId={projectId}\n                    onSelectFile={handleSelectFile}\n                    selectedType={fileType}\n                  />\n                </TabsContent>\n                \n                <TabsContent value=\"upload\" className=\"mt-4\">\n                  <MediaManager \n                    projectId={projectId}\n                    onSelectFile={handleSelectFile}\n                    selectedType={fileType}\n                    showUploader={true}\n                  />\n                </TabsContent>\n                \n                <TabsContent value=\"url\" className=\"mt-4\">\n                  <UrlDownloader\n                    projectId={projectId}\n                    onDownloadComplete={(files) => {\n                      if (files.length > 0) {\n                        handleSelectFile(files[0]);\n                      }\n                      setIsOpen(false);\n                    }}\n                    onClose={() => setIsOpen(false)}\n                  />\n                </TabsContent>\n              </Tabs>\n            </DialogContent>\n          </Dialog>\n        </div>\n      )}\n\n      {selectedFile && (\n        <div className=\"space-y-2\">\n          {selectedFile.description && (\n            <p className=\"text-xs text-gray-600 dark:text-gray-400\">\n              {selectedFile.description}\n            </p>\n          )}\n          {selectedFile.tags && selectedFile.tags.length > 0 && (\n            <div className=\"flex flex-wrap gap-1\">\n              {selectedFile.tags.map((tag, index) => (\n                <Badge key={index} variant=\"secondary\" className=\"text-xs\">\n                  {tag}\n                </Badge>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}","size_bytes":6698},"client/src/types/bot.ts":{"content":"// Re-export all types from shared schema for compatibility\nexport * from '@shared/schema';","size_bytes":91},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\n// Функция для определения мобильного устройства\nexport function getIsMobile() {\n  if (typeof window === 'undefined') return false;\n  \n  // Используем минимальное значение из innerWidth и clientWidth\n  // Это поможет корректно работать в режиме эмуляции DevTools\n  const effectiveWidth = Math.min(window.innerWidth, document.documentElement.clientWidth);\n  return effectiveWidth < MOBILE_BREAKPOINT;\n}\n\nexport function useIsMobile() {\n  // Сразу устанавливаем правильное значение, если window доступен\n  const [isMobile, setIsMobile] = React.useState<boolean>(() => getIsMobile())\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(getIsMobile());\n    }\n    \n    // Устанавливаем текущее значение при монтировании\n    setIsMobile(getIsMobile());\n    \n    mql.addEventListener(\"change\", onChange)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return isMobile\n}\n","size_bytes":1256},"client/src/components/editor/header.tsx":{"content":"import { Button } from '@/components/ui/button';\nimport { ThemeToggle } from '@/components/theme-toggle';\nimport { FolderOpen, Bookmark, Save, Download, User, Send } from 'lucide-react';\nimport { useState } from 'react';\n\ninterface HeaderProps {\n  projectName: string;\n  currentTab: 'editor' | 'preview' | 'export' | 'bot';\n  onTabChange: (tab: 'editor' | 'preview' | 'export' | 'bot') => void;\n  onSave: () => void;\n  onExport: () => void;\n  onSaveAsTemplate?: () => void;\n  onLoadTemplate?: () => void;\n  isSaving?: boolean;\n}\n\nexport function Header({ projectName, currentTab, onTabChange, onSave, onExport, onSaveAsTemplate, onLoadTemplate, isSaving }: HeaderProps) {\n  return (\n    <header className=\"bg-background border-b border-border h-16 flex items-center justify-between px-6 relative z-50\">\n      <div className=\"flex items-center space-x-4\">\n        <div className=\"flex items-center space-x-3\">\n          <div className=\"w-8 h-8 bg-primary rounded-lg flex items-center justify-center\">\n            <i className=\"fab fa-telegram-plane text-primary-foreground text-lg\"></i>\n          </div>\n          <div>\n            <h1 className=\"text-lg font-semibold text-foreground\">BotCraft Studio</h1>\n            <p className=\"text-xs text-muted-foreground\">{projectName}</p>\n          </div>\n        </div>\n        \n        <div className=\"h-6 w-px bg-border\"></div>\n        \n        <nav className=\"flex flex-wrap items-center gap-1 max-sm:grid max-sm:grid-cols-2 max-sm:gap-x-2 max-sm:gap-y-1\">\n          {[\n            { key: 'editor', label: 'Редактор' },\n            { key: 'preview', label: 'Превью' },\n            { key: 'export', label: 'Экспорт' },\n            { key: 'bot', label: 'Бот' }\n          ].map((tab) => (\n            <button \n              key={tab.key}\n              onClick={() => onTabChange(tab.key as any)}\n              className={`px-3 py-1.5 text-sm max-sm:text-xs max-sm:px-2 max-sm:py-1 font-medium rounded-md transition-colors whitespace-nowrap ${\n                currentTab === tab.key \n                  ? 'text-primary bg-primary/10' \n                  : 'text-muted-foreground hover:bg-muted'\n              }`}\n            >\n              {tab.label}\n            </button>\n          ))}\n        </nav>\n      </div>\n      \n      <div className=\"flex flex-wrap items-center gap-2 max-sm:grid max-sm:grid-cols-3 max-sm:gap-x-1 max-sm:gap-y-1 max-sm:text-xs\">\n        {onLoadTemplate && (\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            onClick={() => {\n              console.log('Templates button clicked in header');\n              onLoadTemplate();\n            }}\n            className=\"flex items-center justify-center px-1 py-0.5 text-xs max-sm:px-1 max-sm:py-0.5 max-sm:min-w-0 max-sm:w-full\"\n          >\n            <FolderOpen className=\"h-2.5 w-2.5 max-sm:mx-auto text-muted-foreground\" />\n            <span className=\"max-sm:hidden ml-1\">Шаблон</span>\n          </Button>\n        )}\n        \n        {onSaveAsTemplate && (\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            onClick={onSaveAsTemplate}\n            className=\"flex items-center justify-center px-1 py-0.5 text-xs max-sm:px-1 max-sm:py-0.5 max-sm:min-w-0 max-sm:w-full\"\n          >\n            <Bookmark className=\"h-2.5 w-2.5 max-sm:mx-auto text-muted-foreground\" />\n            <span className=\"max-sm:hidden ml-1\">Создать</span>\n          </Button>\n        )}\n        \n        <Button \n          variant=\"outline\" \n          size=\"sm\"\n          onClick={onSave}\n          disabled={isSaving}\n          className=\"flex items-center justify-center px-1 py-0.5 text-xs max-sm:px-1 max-sm:py-0.5 max-sm:min-w-0 max-sm:w-full\"\n        >\n          <Save className={`h-2.5 w-2.5 max-sm:mx-auto text-muted-foreground ${isSaving ? 'animate-spin' : ''}`} />\n          <span className=\"max-sm:hidden ml-1\">{isSaving ? 'Сохр...' : 'Сохр'}</span>\n        </Button>\n        \n        <Button \n          size=\"sm\"\n          onClick={onExport}\n          className=\"flex items-center justify-center px-1 py-0.5 text-xs max-sm:px-1 max-sm:py-0.5 max-sm:min-w-0 max-sm:w-full max-sm:col-span-2\"\n        >\n          <i className=\"fas fa-download text-2xs max-sm:mx-auto\"></i>\n          <span className=\"max-sm:hidden ml-1\">Экспорт</span>\n        </Button>\n        \n        <div className=\"h-6 w-px bg-border max-sm:hidden\"></div>\n        \n        <div className=\"max-sm:col-span-1 max-sm:flex max-sm:justify-center\">\n          <ThemeToggle />\n        </div>\n      </div>\n    </header>\n  );\n}\n","size_bytes":4605},"server/init-db.ts":{"content":"import { sql } from 'drizzle-orm';\nimport { db } from './db';\n\nasync function executeWithRetry(db: any, query: any, description: string, maxRetries = 3) {\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      await db.execute(query);\n      console.log(`✅ ${description} - успешно`);\n      return;\n    } catch (error) {\n      console.warn(`⚠️ ${description} - попытка ${attempt}/${maxRetries} не удалась:`, error);\n      if (attempt === maxRetries) {\n        throw error;\n      }\n      // Wait before retry (reduced wait time)\n      await new Promise(resolve => setTimeout(resolve, 500 * attempt));\n    }\n  }\n}\n\nexport async function initializeDatabaseTables() {\n  console.log('🔧 Initializing database tables...');\n  \n  try {\n    // Use imported db directly\n    \n    // First, test the connection with timeout\n    console.log('Testing database connection...');\n    const healthCheckPromise = db.execute(sql`SELECT 1 as health`);\n    const timeoutPromise = new Promise((_, reject) => \n      setTimeout(() => reject(new Error('Database connection timeout')), 60000)\n    );\n    \n    await Promise.race([healthCheckPromise, timeoutPromise]);\n    console.log('✅ Database connection successful!');\n    \n    // Создаем таблицы если их нет (с поддержкой IF NOT EXISTS)\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS bot_projects (\n        id SERIAL PRIMARY KEY,\n        name TEXT NOT NULL,\n        description TEXT,\n        data JSONB NOT NULL,\n        bot_token TEXT,\n        user_database_enabled INTEGER DEFAULT 1,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы bot_projects\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS bot_tokens (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) ON DELETE CASCADE NOT NULL,\n        name TEXT NOT NULL,\n        token TEXT NOT NULL,\n        is_default INTEGER DEFAULT 0,\n        is_active INTEGER DEFAULT 1,\n        description TEXT,\n        bot_first_name TEXT,\n        bot_username TEXT,\n        bot_description TEXT,\n        bot_short_description TEXT,\n        bot_photo_url TEXT,\n        bot_can_join_groups INTEGER,\n        bot_can_read_all_group_messages INTEGER,\n        bot_supports_inline_queries INTEGER,\n        bot_has_main_web_app INTEGER,\n        last_used_at TIMESTAMP,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы bot_tokens\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS bot_instances (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) NOT NULL,\n        token_id INTEGER REFERENCES bot_tokens(id) ON DELETE CASCADE NOT NULL,\n        status TEXT NOT NULL,\n        token TEXT NOT NULL,\n        process_id TEXT,\n        started_at TIMESTAMP DEFAULT NOW(),\n        stopped_at TIMESTAMP,\n        error_message TEXT\n      );\n    `, \"Создание таблицы bot_instances\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS bot_templates (\n        id SERIAL PRIMARY KEY,\n        name TEXT NOT NULL,\n        description TEXT,\n        data JSONB NOT NULL,\n        category TEXT DEFAULT 'custom',\n        tags TEXT[],\n        is_public INTEGER DEFAULT 0,\n        difficulty TEXT DEFAULT 'easy',\n        author_id TEXT,\n        author_name TEXT,\n        use_count INTEGER NOT NULL DEFAULT 0,\n        rating INTEGER NOT NULL DEFAULT 0,\n        rating_count INTEGER NOT NULL DEFAULT 0,\n        featured INTEGER NOT NULL DEFAULT 0,\n        version TEXT DEFAULT '1.0.0',\n        preview_image TEXT,\n        last_used_at TIMESTAMP,\n        download_count INTEGER NOT NULL DEFAULT 0,\n        like_count INTEGER NOT NULL DEFAULT 0,\n        bookmark_count INTEGER NOT NULL DEFAULT 0,\n        view_count INTEGER NOT NULL DEFAULT 0,\n        language TEXT DEFAULT 'ru',\n        requires_token INTEGER NOT NULL DEFAULT 0,\n        complexity INTEGER NOT NULL DEFAULT 1,\n        estimated_time INTEGER NOT NULL DEFAULT 5,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы bot_templates\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS media_files (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) ON DELETE CASCADE NOT NULL,\n        file_name TEXT NOT NULL,\n        file_type TEXT NOT NULL,\n        file_path TEXT NOT NULL,\n        file_size INTEGER NOT NULL,\n        mime_type TEXT NOT NULL,\n        url TEXT NOT NULL,\n        description TEXT,\n        tags TEXT[] DEFAULT '{}',\n        is_public INTEGER DEFAULT 0,\n        usage_count INTEGER DEFAULT 0,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы media_files\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS user_bot_data (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) ON DELETE CASCADE NOT NULL,\n        user_id TEXT NOT NULL,\n        user_name TEXT,\n        first_name TEXT,\n        last_name TEXT,\n        language_code TEXT,\n        is_bot INTEGER DEFAULT 0,\n        is_premium INTEGER DEFAULT 0,\n        last_interaction TIMESTAMP DEFAULT NOW(),\n        interaction_count INTEGER DEFAULT 0,\n        user_data JSONB DEFAULT '{}',\n        current_state TEXT,\n        preferences JSONB DEFAULT '{}',\n        commands_used JSONB DEFAULT '{}',\n        sessions_count INTEGER DEFAULT 1,\n        total_messages_sent INTEGER DEFAULT 0,\n        total_messages_received INTEGER DEFAULT 0,\n        device_info TEXT,\n        location_data JSONB,\n        contact_data JSONB,\n        is_blocked INTEGER DEFAULT 0,\n        is_active INTEGER DEFAULT 1,\n        tags TEXT[] DEFAULT '{}',\n        notes TEXT,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы user_bot_data\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS bot_groups (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) ON DELETE CASCADE NOT NULL,\n        group_id TEXT,\n        name TEXT NOT NULL,\n        url TEXT NOT NULL,\n        is_admin INTEGER DEFAULT 0,\n        member_count INTEGER,\n        is_active INTEGER DEFAULT 1,\n        description TEXT,\n        settings JSONB DEFAULT '{}',\n        avatar_url TEXT,\n        chat_type TEXT DEFAULT 'group',\n        invite_link TEXT,\n        admin_rights JSONB DEFAULT '{\"can_manage_chat\": false, \"can_change_info\": false, \"can_delete_messages\": false, \"can_invite_users\": false, \"can_restrict_members\": false, \"can_pin_messages\": false, \"can_promote_members\": false, \"can_manage_video_chats\": false}',\n        messages_count INTEGER DEFAULT 0,\n        active_users INTEGER DEFAULT 0,\n        last_activity TIMESTAMP,\n        is_public INTEGER DEFAULT 0,\n        language TEXT DEFAULT 'ru',\n        timezone TEXT,\n        tags TEXT[] DEFAULT '{}',\n        notes TEXT,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы bot_groups\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS group_members (\n        id SERIAL PRIMARY KEY,\n        group_id INTEGER REFERENCES bot_groups(id) ON DELETE CASCADE NOT NULL,\n        user_id BIGINT NOT NULL,\n        username TEXT,\n        first_name TEXT,\n        last_name TEXT,\n        status TEXT DEFAULT 'member',\n        is_bot INTEGER DEFAULT 0,\n        admin_rights JSONB DEFAULT '{}',\n        custom_title TEXT,\n        restrictions JSONB DEFAULT '{}',\n        restricted_until TIMESTAMP,\n        joined_at TIMESTAMP DEFAULT NOW(),\n        last_seen TIMESTAMP,\n        message_count INTEGER DEFAULT 0,\n        is_active INTEGER DEFAULT 1,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы group_members\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS bot_users (\n        user_id BIGINT PRIMARY KEY,\n        username TEXT,\n        first_name TEXT,\n        last_name TEXT,\n        registered_at TIMESTAMP DEFAULT NOW(),\n        last_interaction TIMESTAMP DEFAULT NOW(),\n        interaction_count INTEGER DEFAULT 0,\n        user_data JSONB DEFAULT '{}',\n        is_active INTEGER DEFAULT 1\n      );\n    `, \"Создание таблицы bot_users\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS user_telegram_settings (\n        id SERIAL PRIMARY KEY,\n        user_id TEXT NOT NULL UNIQUE,\n        api_id TEXT,\n        api_hash TEXT,\n        phone_number TEXT,\n        session_string TEXT,\n        is_active INTEGER DEFAULT 1,\n        last_login TIMESTAMP,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы user_telegram_settings\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS bot_messages (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) ON DELETE CASCADE NOT NULL,\n        user_id TEXT NOT NULL,\n        message_type TEXT NOT NULL,\n        message_text TEXT,\n        message_data JSONB,\n        node_id TEXT,\n        primary_media_id INTEGER REFERENCES media_files(id) ON DELETE SET NULL,\n        created_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы bot_messages\");\n\n    await executeWithRetry(db, sql`\n      CREATE TABLE IF NOT EXISTS bot_message_media (\n        id SERIAL PRIMARY KEY,\n        message_id INTEGER REFERENCES bot_messages(id) ON DELETE CASCADE NOT NULL,\n        media_file_id INTEGER REFERENCES media_files(id) ON DELETE CASCADE NOT NULL,\n        media_kind TEXT NOT NULL,\n        order_index INTEGER DEFAULT 0,\n        created_at TIMESTAMP DEFAULT NOW()\n      );\n    `, \"Создание таблицы bot_message_media\");\n\n    // Миграция: добавление primary_media_id в bot_messages если его нет\n    try {\n      const columnCheck = await db.execute(sql`\n        SELECT column_name \n        FROM information_schema.columns \n        WHERE table_name = 'bot_messages' \n        AND column_name = 'primary_media_id';\n      `);\n      \n      if (columnCheck.rows.length === 0) {\n        console.log('🔄 Добавляем колонку primary_media_id в таблицу bot_messages...');\n        await executeWithRetry(db, sql`\n          ALTER TABLE bot_messages \n          ADD COLUMN primary_media_id INTEGER REFERENCES media_files(id) ON DELETE SET NULL;\n        `, \"Миграция: добавление primary_media_id\");\n        console.log('✅ Колонка primary_media_id успешно добавлена');\n      }\n    } catch (error) {\n      console.log('⚠️ Ошибка при проверке/добавлении колонки primary_media_id:', error);\n    }\n\n    console.log('✅ Database tables initialized successfully!');\n    return true;\n  } catch (error) {\n    console.error('❌ Database initialization failed:', error);\n    return false;\n  }\n}","size_bytes":11362},"client/src/components/media/url-downloader.tsx":{"content":"import React, { useState } from 'react';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { MediaFile } from \"@shared/schema\";\nimport { \n  Download, \n  LinkIcon, \n  CheckCircle, \n  XCircle, \n  AlertTriangle, \n  FileText, \n  Image, \n  Play, \n  Volume2,\n  Loader2,\n  Info,\n  ExternalLink,\n  Copy,\n  Trash2,\n  Plus\n} from \"lucide-react\";\n\ninterface UrlDownloaderProps {\n  projectId: number;\n  onDownloadComplete?: (files: MediaFile[]) => void;\n  onClose?: () => void;\n  maxUrls?: number;\n}\n\ninterface UrlData {\n  id: string;\n  url: string;\n  fileName?: string;\n  description?: string;\n  status: 'pending' | 'checking' | 'valid' | 'invalid' | 'downloading' | 'success' | 'error';\n  fileInfo?: {\n    mimeType?: string;\n    size?: number;\n    fileName?: string;\n    fileType?: string;\n    category?: string;\n    sizeMB?: number;\n  };\n  error?: string;\n  progress?: number;\n}\n\nexport function UrlDownloader({ \n  projectId, \n  onDownloadComplete, \n  onClose,\n  maxUrls = 10\n}: UrlDownloaderProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [urls, setUrls] = useState<UrlData[]>([{\n    id: Math.random().toString(36).substr(2, 9),\n    url: '',\n    status: 'pending'\n  }]);\n  const [isPublic, setIsPublic] = useState(false);\n  const [defaultDescription, setDefaultDescription] = useState('');\n  const [isProcessing, setIsProcessing] = useState(false);\n\n  // Мутация для проверки URL\n  const checkUrlMutation = useMutation({\n    mutationFn: async (url: string) => {\n      const response = await apiRequest('POST', '/api/media/check-url', { url });\n      return response;\n    }\n  });\n\n  // Мутация для загрузки одного файла\n  const downloadUrlMutation = useMutation({\n    mutationFn: async ({ url, description, customFileName }: { \n      url: string; \n      description?: string; \n      customFileName?: string; \n    }) => {\n      const response = await apiRequest('POST', `/api/media/download-url/${projectId}`, { \n        url, \n        description, \n        customFileName,\n        isPublic \n      });\n      return response;\n    }\n  });\n\n  // Мутация для пакетной загрузки\n  const downloadUrlsMutation = useMutation({\n    mutationFn: async (urlsData: { url: string; fileName?: string; description?: string }[]) => {\n      const response = await apiRequest('POST', `/api/media/download-urls/${projectId}`, { \n        urls: urlsData,\n        isPublic,\n        defaultDescription \n      });\n      return response;\n    }\n  });\n\n  const getFileIcon = (fileType?: string) => {\n    switch (fileType) {\n      case 'photo': return <Image className=\"w-4 h-4 text-blue-500\" />;\n      case 'video': return <Play className=\"w-4 h-4 text-purple-500\" />;\n      case 'audio': return <Volume2 className=\"w-4 h-4 text-green-500\" />;\n      case 'document': return <FileText className=\"w-4 h-4 text-orange-500\" />;\n      default: return <FileText className=\"w-4 h-4 text-gray-500\" />;\n    }\n  };\n\n  const addUrlField = () => {\n    if (urls.length < maxUrls) {\n      setUrls(prev => [...prev, {\n        id: Math.random().toString(36).substr(2, 9),\n        url: '',\n        status: 'pending'\n      }]);\n    }\n  };\n\n  const removeUrlField = (id: string) => {\n    if (urls.length > 1) {\n      setUrls(prev => prev.filter(u => u.id !== id));\n    }\n  };\n\n  const updateUrl = (id: string, url: string) => {\n    setUrls(prev => prev.map(u => \n      u.id === id \n        ? { ...u, url, status: 'pending' as const, fileInfo: undefined, error: undefined }\n        : u\n    ));\n  };\n\n  const updateUrlField = (id: string, field: keyof UrlData, value: any) => {\n    setUrls(prev => prev.map(u => \n      u.id === id \n        ? { ...u, [field]: value }\n        : u\n    ));\n  };\n\n  const checkUrl = async (id: string, url: string) => {\n    if (!url.trim()) return;\n\n    updateUrlField(id, 'status', 'checking');\n\n    try {\n      const result = await checkUrlMutation.mutateAsync(url);\n      \n      if (result.accessible) {\n        updateUrlField(id, 'status', 'valid');\n        updateUrlField(id, 'fileInfo', result.fileInfo);\n        \n        // Автоматически заполняем имя файла если оно не задано\n        if (result.fileInfo?.fileName && !urls.find(u => u.id === id)?.fileName) {\n          updateUrlField(id, 'fileName', result.fileInfo.fileName);\n        }\n      } else {\n        updateUrlField(id, 'status', 'invalid');\n        updateUrlField(id, 'error', result.error);\n      }\n    } catch (error) {\n      updateUrlField(id, 'status', 'invalid');\n      updateUrlField(id, 'error', error instanceof Error ? error.message : 'Ошибка проверки URL');\n    }\n  };\n\n  const downloadSingle = async (urlData: UrlData) => {\n    if (!urlData.url.trim() || urlData.status !== 'valid') return;\n\n    updateUrlField(urlData.id, 'status', 'downloading');\n    updateUrlField(urlData.id, 'progress', 0);\n\n    try {\n      const result = await downloadUrlMutation.mutateAsync({\n        url: urlData.url,\n        description: urlData.description || defaultDescription,\n        customFileName: urlData.fileName\n      });\n\n      updateUrlField(urlData.id, 'status', 'success');\n      updateUrlField(urlData.id, 'progress', 100);\n\n      toast({\n        title: \"Файл загружен\",\n        description: `${result.fileName} успешно загружен`,\n      });\n\n      // Обновляем кэш медиафайлов\n      queryClient.invalidateQueries({ queryKey: ['/api/media/project', projectId] });\n\n      onDownloadComplete?.([result]);\n\n    } catch (error) {\n      updateUrlField(urlData.id, 'status', 'error');\n      updateUrlField(urlData.id, 'error', error instanceof Error ? error.message : 'Ошибка загрузки');\n      \n      toast({\n        title: \"Ошибка загрузки\",\n        description: error instanceof Error ? error.message : 'Неизвестная ошибка',\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const downloadAll = async () => {\n    const validUrls = urls.filter(u => u.status === 'valid' && u.url.trim());\n    \n    if (validUrls.length === 0) {\n      toast({\n        title: \"Нет валидных URL\",\n        description: \"Добавьте и проверьте URL для загрузки\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsProcessing(true);\n\n    try {\n      // Обновляем статус всех URL\n      validUrls.forEach(urlData => {\n        updateUrlField(urlData.id, 'status', 'downloading');\n        updateUrlField(urlData.id, 'progress', 0);\n      });\n\n      const urlsData = validUrls.map(u => ({\n        url: u.url,\n        fileName: u.fileName,\n        description: u.description\n      }));\n\n      const result = await downloadUrlsMutation.mutateAsync(urlsData);\n\n      // Обновляем статусы на основе результата\n      validUrls.forEach((urlData, index) => {\n        const wasSuccessful = result.downloadedFiles.some((f: any) => f.sourceUrl === urlData.url);\n        const error = result.errorDetails.find((e: any) => e.url === urlData.url);\n        \n        if (wasSuccessful) {\n          updateUrlField(urlData.id, 'status', 'success');\n          updateUrlField(urlData.id, 'progress', 100);\n        } else {\n          updateUrlField(urlData.id, 'status', 'error');\n          updateUrlField(urlData.id, 'error', error?.error || 'Неизвестная ошибка');\n        }\n      });\n\n      toast({\n        title: \"Пакетная загрузка завершена\",\n        description: `Успешно: ${result.success}, Ошибок: ${result.errors}`,\n      });\n\n      // Обновляем кэш медиафайлов\n      queryClient.invalidateQueries({ queryKey: ['/api/media/project', projectId] });\n\n      if (result.downloadedFiles.length > 0) {\n        onDownloadComplete?.(result.downloadedFiles);\n      }\n\n      // Закрываем через 3 секунды если все успешно\n      if (result.errors === 0) {\n        setTimeout(() => {\n          onClose?.();\n        }, 3000);\n      }\n\n    } catch (error) {\n      validUrls.forEach(urlData => {\n        updateUrlField(urlData.id, 'status', 'error');\n        updateUrlField(urlData.id, 'error', 'Ошибка пакетной загрузки');\n      });\n\n      toast({\n        title: \"Ошибка пакетной загрузки\",\n        description: error instanceof Error ? error.message : 'Неизвестная ошибка',\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const pasteFromClipboard = async (id: string) => {\n    try {\n      const text = await navigator.clipboard.readText();\n      if (text) {\n        updateUrl(id, text);\n        // Автоматически проверяем URL после вставки\n        setTimeout(() => checkUrl(id, text), 100);\n      }\n    } catch (error) {\n      toast({\n        title: \"Ошибка вставки\",\n        description: \"Не удалось получить текст из буфера обмена\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const validUrlsCount = urls.filter(u => u.status === 'valid').length;\n  const totalUrlsCount = urls.filter(u => u.url.trim()).length;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Заголовок */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n            <LinkIcon className=\"w-5 h-5\" />\n            Загрузка файлов по ссылкам\n          </h3>\n          <p className=\"text-sm text-muted-foreground\">\n            Загружайте файлы напрямую из интернета по URL\n          </p>\n        </div>\n        <Badge variant=\"outline\">\n          {validUrlsCount}/{totalUrlsCount} готово\n        </Badge>\n      </div>\n\n      {/* Общие настройки */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">Общие настройки</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"defaultDescription\">Описание по умолчанию</Label>\n            <Textarea\n              id=\"defaultDescription\"\n              placeholder=\"Описание для всех загружаемых файлов...\"\n              value={defaultDescription}\n              onChange={(e) => setDefaultDescription(e.target.value)}\n              rows={2}\n            />\n          </div>\n          \n          <div className=\"flex items-center space-x-2\">\n            <Switch\n              id=\"isPublic\"\n              checked={isPublic}\n              onCheckedChange={setIsPublic}\n            />\n            <Label htmlFor=\"isPublic\">Публичные файлы</Label>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* URL поля */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center justify-between\">\n            URL для загрузки\n            <Button\n              onClick={addUrlField}\n              size=\"sm\"\n              variant=\"outline\"\n              disabled={urls.length >= maxUrls}\n            >\n              <Plus className=\"w-4 h-4 mr-1\" />\n              Добавить URL\n            </Button>\n          </CardTitle>\n          <CardDescription>\n            Поддерживаются изображения, видео, аудио и документы до 200МБ\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {urls.map((urlData, index) => (\n            <div key={urlData.id} className=\"space-y-3 p-4 border rounded-lg\">\n              {/* URL ввод */}\n              <div className=\"flex gap-2\">\n                <div className=\"flex-1\">\n                  <Input\n                    placeholder=\"https://example.com/file.jpg\"\n                    value={urlData.url}\n                    onChange={(e) => updateUrl(urlData.id, e.target.value)}\n                    onBlur={() => urlData.url.trim() && checkUrl(urlData.id, urlData.url)}\n                  />\n                </div>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => pasteFromClipboard(urlData.id)}\n                >\n                  <Copy className=\"w-4 h-4\" />\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => urlData.url.trim() && checkUrl(urlData.id, urlData.url)}\n                  disabled={!urlData.url.trim() || urlData.status === 'checking'}\n                >\n                  {urlData.status === 'checking' ? (\n                    <Loader2 className=\"w-4 h-4 animate-spin\" />\n                  ) : (\n                    <ExternalLink className=\"w-4 h-4\" />\n                  )}\n                </Button>\n                {urls.length > 1 && (\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={() => removeUrlField(urlData.id)}\n                  >\n                    <Trash2 className=\"w-4 h-4\" />\n                  </Button>\n                )}\n              </div>\n\n              {/* Статус */}\n              {urlData.status !== 'pending' && (\n                <div className=\"flex items-center gap-2\">\n                  {urlData.status === 'checking' && (\n                    <div className=\"flex items-center gap-2 text-blue-600\">\n                      <Loader2 className=\"w-4 h-4 animate-spin\" />\n                      <span className=\"text-sm\">Проверка...</span>\n                    </div>\n                  )}\n                  \n                  {urlData.status === 'valid' && (\n                    <div className=\"flex items-center gap-2 text-green-600\">\n                      <CheckCircle className=\"w-4 h-4\" />\n                      <span className=\"text-sm\">URL валиден</span>\n                    </div>\n                  )}\n                  \n                  {urlData.status === 'invalid' && (\n                    <div className=\"flex items-center gap-2 text-red-600\">\n                      <XCircle className=\"w-4 h-4\" />\n                      <span className=\"text-sm\">Ошибка: {urlData.error}</span>\n                    </div>\n                  )}\n                  \n                  {urlData.status === 'downloading' && (\n                    <div className=\"flex items-center gap-2 text-blue-600\">\n                      <Download className=\"w-4 h-4\" />\n                      <span className=\"text-sm\">Загрузка... {urlData.progress || 0}%</span>\n                      <Progress value={urlData.progress || 0} className=\"w-20\" />\n                    </div>\n                  )}\n                  \n                  {urlData.status === 'success' && (\n                    <div className=\"flex items-center gap-2 text-green-600\">\n                      <CheckCircle className=\"w-4 h-4\" />\n                      <span className=\"text-sm\">Загружено успешно</span>\n                    </div>\n                  )}\n                  \n                  {urlData.status === 'error' && (\n                    <div className=\"flex items-center gap-2 text-red-600\">\n                      <XCircle className=\"w-4 h-4\" />\n                      <span className=\"text-sm\">Ошибка: {urlData.error}</span>\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Информация о файле */}\n              {urlData.fileInfo && (\n                <div className=\"flex items-center gap-3 p-2 bg-muted rounded text-sm\">\n                  {getFileIcon(urlData.fileInfo.fileType)}\n                  <div className=\"flex-1\">\n                    <div className=\"font-medium\">{urlData.fileInfo.fileName}</div>\n                    <div className=\"text-muted-foreground\">\n                      {urlData.fileInfo.category} • {urlData.fileInfo.sizeMB}МБ\n                    </div>\n                  </div>\n                  <Badge variant=\"secondary\">{urlData.fileInfo.fileType}</Badge>\n                </div>\n              )}\n\n              {/* Дополнительные поля для валидных URL */}\n              {urlData.status === 'valid' && (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                  <div className=\"space-y-1\">\n                    <Label htmlFor={`fileName-${urlData.id}`}>Имя файла</Label>\n                    <Input\n                      id={`fileName-${urlData.id}`}\n                      placeholder=\"Оставьте пустым для автоопределения\"\n                      value={urlData.fileName || ''}\n                      onChange={(e) => updateUrlField(urlData.id, 'fileName', e.target.value)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label htmlFor={`description-${urlData.id}`}>Описание</Label>\n                    <Input\n                      id={`description-${urlData.id}`}\n                      placeholder=\"Индивидуальное описание файла\"\n                      value={urlData.description || ''}\n                      onChange={(e) => updateUrlField(urlData.id, 'description', e.target.value)}\n                    />\n                  </div>\n                </div>\n              )}\n\n              {/* Кнопка индивидуальной загрузки */}\n              {urlData.status === 'valid' && (\n                <Button\n                  onClick={() => downloadSingle(urlData)}\n                  size=\"sm\"\n                  className=\"w-full\"\n                  disabled={urlData.status === 'downloading'}\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Загрузить этот файл\n                </Button>\n              )}\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n\n      {/* Информационное сообщение */}\n      <Alert>\n        <Info className=\"h-4 w-4\" />\n        <AlertDescription>\n          <strong>Совет:</strong> Сначала добавьте все URL и дождитесь их проверки, \n          затем используйте \"Загрузить все файлы\" для эффективной пакетной загрузки.\n        </AlertDescription>\n      </Alert>\n\n      {/* Кнопки действий */}\n      <div className=\"flex gap-2\">\n        <Button\n          onClick={downloadAll}\n          disabled={validUrlsCount === 0 || isProcessing}\n          className=\"flex-1\"\n        >\n          {isProcessing ? (\n            <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n          ) : (\n            <Download className=\"w-4 h-4 mr-2\" />\n          )}\n          Загрузить все файлы ({validUrlsCount})\n        </Button>\n        \n        {onClose && (\n          <Button variant=\"outline\" onClick={onClose}>\n            Закрыть\n          </Button>\n        )}\n      </div>\n    </div>\n  );\n}","size_bytes":20001},"server/storage.ts":{"content":"import { \n  botProjects, \n  botInstances,\n  botTemplates,\n  botTokens,\n  mediaFiles,\n  userBotData,\n  botGroups,\n  groupMembers,\n  botUsers,\n  botMessages,\n  botMessageMedia,\n  type BotProject, \n  type InsertBotProject,\n  type BotInstance,\n  type InsertBotInstance,\n  type BotTemplate,\n  type InsertBotTemplate,\n  type BotToken,\n  type InsertBotToken,\n  type MediaFile,\n  type InsertMediaFile,\n  type UserBotData,\n  type InsertUserBotData,\n  type BotGroup,\n  type InsertBotGroup,\n  type GroupMember,\n  type InsertGroupMember,\n  type BotUser,\n  type BotMessage,\n  type InsertBotMessage,\n  type BotMessageMedia,\n  type InsertBotMessageMedia\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, asc, and, like, or, ilike, sql } from \"drizzle-orm\";\nimport { dbManager } from \"./db-utils\";\nimport { cachedOps } from \"./db-cache\";\n\nexport interface IStorage {\n  getBotProject(id: number): Promise<BotProject | undefined>;\n  getAllBotProjects(): Promise<BotProject[]>;\n  createBotProject(project: InsertBotProject): Promise<BotProject>;\n  updateBotProject(id: number, project: Partial<InsertBotProject>): Promise<BotProject | undefined>;\n  deleteBotProject(id: number): Promise<boolean>;\n  \n  // Bot instances\n  getBotInstance(projectId: number): Promise<BotInstance | undefined>;\n  getBotInstanceByToken(tokenId: number): Promise<BotInstance | undefined>;\n  getBotInstancesByProject(projectId: number): Promise<BotInstance[]>;\n  getAllBotInstances(): Promise<BotInstance[]>;\n  createBotInstance(instance: InsertBotInstance): Promise<BotInstance>;\n  updateBotInstance(id: number, instance: Partial<InsertBotInstance>): Promise<BotInstance | undefined>;\n  deleteBotInstance(id: number): Promise<boolean>;\n  stopBotInstance(projectId: number): Promise<boolean>;\n  stopBotInstanceByToken(tokenId: number): Promise<boolean>;\n  \n  // Bot templates\n  getBotTemplate(id: number): Promise<BotTemplate | undefined>;\n  getAllBotTemplates(): Promise<BotTemplate[]>;\n  createBotTemplate(template: InsertBotTemplate): Promise<BotTemplate>;\n  updateBotTemplate(id: number, template: Partial<InsertBotTemplate>): Promise<BotTemplate | undefined>;\n  deleteBotTemplate(id: number): Promise<boolean>;\n  incrementTemplateUseCount(id: number): Promise<boolean>;\n  incrementTemplateViewCount(id: number): Promise<boolean>;\n  incrementTemplateDownloadCount(id: number): Promise<boolean>;\n  toggleTemplateLike(id: number, liked: boolean): Promise<boolean>;\n  toggleTemplateBookmark(id: number, bookmarked: boolean): Promise<boolean>;\n  rateTemplate(id: number, rating: number): Promise<boolean>;\n  getFeaturedTemplates(): Promise<BotTemplate[]>;\n  getTemplatesByCategory(category: string): Promise<BotTemplate[]>;\n  searchTemplates(query: string): Promise<BotTemplate[]>;\n  \n  // Bot tokens\n  getBotToken(id: number): Promise<BotToken | undefined>;\n  getBotTokensByProject(projectId: number): Promise<BotToken[]>;\n  getDefaultBotToken(projectId: number): Promise<BotToken | undefined>;\n  createBotToken(token: InsertBotToken): Promise<BotToken>;\n  updateBotToken(id: number, token: Partial<InsertBotToken>): Promise<BotToken | undefined>;\n  deleteBotToken(id: number): Promise<boolean>;\n  setDefaultBotToken(projectId: number, tokenId: number): Promise<boolean>;\n  markTokenAsUsed(id: number): Promise<boolean>;\n  \n  // Media files\n  getMediaFile(id: number): Promise<MediaFile | undefined>;\n  getMediaFilesByProject(projectId: number): Promise<MediaFile[]>;\n  getMediaFilesByType(projectId: number, fileType: string): Promise<MediaFile[]>;\n  createMediaFile(file: InsertMediaFile): Promise<MediaFile>;\n  updateMediaFile(id: number, file: Partial<InsertMediaFile>): Promise<MediaFile | undefined>;\n  deleteMediaFile(id: number): Promise<boolean>;\n  incrementMediaFileUsage(id: number): Promise<boolean>;\n  searchMediaFiles(projectId: number, query: string): Promise<MediaFile[]>;\n  \n  // User bot data\n  getUserBotData(id: number): Promise<UserBotData | undefined>;\n  getUserBotDataByProjectAndUser(projectId: number, userId: string): Promise<UserBotData | undefined>;\n  getUserBotDataByProject(projectId: number): Promise<UserBotData[]>;\n  getAllUserBotData(): Promise<UserBotData[]>;\n  createUserBotData(userData: InsertUserBotData): Promise<UserBotData>;\n  updateUserBotData(id: number, userData: Partial<InsertUserBotData>): Promise<UserBotData | undefined>;\n  deleteUserBotData(id: number): Promise<boolean>;\n  deleteUserBotDataByProject(projectId: number): Promise<boolean>;\n  incrementUserInteraction(id: number): Promise<boolean>;\n  updateUserState(id: number, state: string): Promise<boolean>;\n  searchUserBotData(projectId: number, query: string): Promise<UserBotData[]>;\n  getUserBotDataStats(projectId: number): Promise<{\n    totalUsers: number;\n    activeUsers: number;\n    blockedUsers: number;\n    premiumUsers: number;\n    totalInteractions: number;\n    avgInteractionsPerUser: number;\n  }>;\n  \n  // Bot groups\n  getBotGroup(id: number): Promise<BotGroup | undefined>;\n  getBotGroupsByProject(projectId: number): Promise<BotGroup[]>;\n  getBotGroupByProjectAndGroupId(projectId: number, groupId: string): Promise<BotGroup | undefined>;\n  createBotGroup(group: InsertBotGroup): Promise<BotGroup>;\n  updateBotGroup(id: number, group: Partial<InsertBotGroup>): Promise<BotGroup | undefined>;\n  deleteBotGroup(id: number): Promise<boolean>;\n  \n  // Group members\n  getGroupMembers(groupId: number): Promise<GroupMember[]>;\n  createGroupMember(member: InsertGroupMember): Promise<GroupMember>;\n  updateGroupMember(id: number, member: Partial<InsertGroupMember>): Promise<GroupMember | undefined>;\n  deleteGroupMember(id: number): Promise<boolean>;\n  \n  // Bot messages\n  createBotMessage(message: InsertBotMessage): Promise<BotMessage>;\n  getBotMessages(projectId: number, userId: string, limit?: number): Promise<BotMessage[]>;\n  getBotMessagesWithMedia(projectId: number, userId: string, limit?: number): Promise<(BotMessage & { media?: Array<MediaFile & { mediaKind: string; orderIndex: number }> })[]>;\n  deleteBotMessages(projectId: number, userId: string): Promise<boolean>;\n  deleteAllBotMessages(projectId: number): Promise<boolean>;\n  \n  // Bot message media\n  createBotMessageMedia(data: InsertBotMessageMedia): Promise<BotMessageMedia>;\n  getMessageMedia(messageId: number): Promise<Array<MediaFile & { mediaKind: string; orderIndex: number }>>;\n}\n\n// Legacy Memory Storage - kept for reference\nclass MemStorage implements IStorage {\n  private projects: Map<number, BotProject>;\n  private instances: Map<number, BotInstance>;\n  private templates: Map<number, BotTemplate>;\n  currentId: number;\n  currentInstanceId: number;\n  currentTemplateId: number;\n\n  constructor() {\n    this.projects = new Map();\n    this.instances = new Map();\n    this.templates = new Map();\n    this.currentId = 1;\n    this.currentInstanceId = 1;\n    this.currentTemplateId = 1;\n    \n    // Add a default project\n    const defaultProject: BotProject = {\n      id: 1,\n      name: \"Мой первый бот\",\n      description: \"Пример бота для знакомства с конструктором\",\n      data: {\n        nodes: [\n          {\n            id: \"start-1\",\n            type: \"start\",\n            position: { x: 100, y: 100 },\n            data: {\n              command: \"/start\",\n              description: \"Запустить бота\",\n              messageText: \"Привет! 👋 Добро пожаловать в наш бот!\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-1\",\n                  text: \"📋 Главное меню\",\n                  action: \"goto\",\n                  target: \"menu-1\"\n                },\n                {\n                  id: \"btn-2\", \n                  text: \"ℹ️ О нас\",\n                  action: \"goto\",\n                  target: \"about-1\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          }\n        ],\n        connections: []\n      },\n      botToken: null,\n      userDatabaseEnabled: 1,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    \n    this.projects.set(1, defaultProject);\n    this.currentId = 2;\n  }\n\n  async getBotProject(id: number): Promise<BotProject | undefined> {\n    return this.projects.get(id);\n  }\n\n  async getAllBotProjects(): Promise<BotProject[]> {\n    return Array.from(this.projects.values());\n  }\n\n  async createBotProject(insertProject: InsertBotProject): Promise<BotProject> {\n    const id = this.currentId++;\n    const project: BotProject = {\n      ...insertProject,\n      id,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n      description: insertProject.description || null,\n      botToken: insertProject.botToken ?? null,\n    };\n    this.projects.set(id, project);\n    return project;\n  }\n\n  async updateBotProject(id: number, updateData: Partial<InsertBotProject>): Promise<BotProject | undefined> {\n    const project = this.projects.get(id);\n    if (!project) return undefined;\n\n    const updatedProject: BotProject = {\n      ...project,\n      ...updateData,\n      updatedAt: new Date(),\n    };\n    \n    this.projects.set(id, updatedProject);\n    return updatedProject;\n  }\n\n  async deleteBotProject(id: number): Promise<boolean> {\n    return this.projects.delete(id);\n  }\n\n  // Bot instances methods\n  async getBotInstance(projectId: number): Promise<BotInstance | undefined> {\n    return Array.from(this.instances.values()).find(instance => instance.projectId === projectId);\n  }\n\n  async getBotInstanceByToken(tokenId: number): Promise<BotInstance | undefined> {\n    return Array.from(this.instances.values()).find(instance => instance.tokenId === tokenId);\n  }\n\n  async getBotInstancesByProject(projectId: number): Promise<BotInstance[]> {\n    return Array.from(this.instances.values()).filter(instance => instance.projectId === projectId);\n  }\n\n  async getAllBotInstances(): Promise<BotInstance[]> {\n    return Array.from(this.instances.values());\n  }\n\n  async createBotInstance(insertInstance: InsertBotInstance): Promise<BotInstance> {\n    // Теперь удаляем существующий экземпляр только для этого же токена\n    const existingInstance = await this.getBotInstanceByToken(insertInstance.tokenId);\n    if (existingInstance) {\n      await this.deleteBotInstance(existingInstance.id);\n    }\n\n    const id = this.currentInstanceId++;\n    const instance: BotInstance = {\n      ...insertInstance,\n      id,\n      startedAt: new Date(),\n      stoppedAt: null,\n      errorMessage: insertInstance.errorMessage || null,\n      processId: insertInstance.processId || null,\n    };\n    this.instances.set(id, instance);\n    return instance;\n  }\n\n  async updateBotInstance(id: number, updateData: Partial<InsertBotInstance>): Promise<BotInstance | undefined> {\n    const instance = this.instances.get(id);\n    if (!instance) return undefined;\n\n    const updatedInstance: BotInstance = {\n      ...instance,\n      ...updateData,\n      stoppedAt: updateData.status === 'stopped' ? new Date() : instance.stoppedAt,\n    };\n    \n    this.instances.set(id, updatedInstance);\n    return updatedInstance;\n  }\n\n  async deleteBotInstance(id: number): Promise<boolean> {\n    return this.instances.delete(id);\n  }\n\n  async stopBotInstance(projectId: number): Promise<boolean> {\n    const instance = await this.getBotInstance(projectId);\n    if (!instance) return false;\n    \n    const updated = await this.updateBotInstance(instance.id, { \n      status: 'stopped'\n    });\n    return !!updated;\n  }\n\n  async stopBotInstanceByToken(tokenId: number): Promise<boolean> {\n    const instance = await this.getBotInstanceByToken(tokenId);\n    if (!instance) return false;\n    \n    const updated = await this.updateBotInstance(instance.id, { \n      status: 'stopped'\n    });\n    return !!updated;\n  }\n\n  // Bot templates methods\n  async getBotTemplate(id: number): Promise<BotTemplate | undefined> {\n    return this.templates.get(id);\n  }\n\n  async getAllBotTemplates(): Promise<BotTemplate[]> {\n    return Array.from(this.templates.values());\n  }\n\n  async createBotTemplate(insertTemplate: InsertBotTemplate): Promise<BotTemplate> {\n    const id = this.currentTemplateId++;\n    const template: BotTemplate = {\n      ...insertTemplate,\n      id,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n      category: insertTemplate.category || \"custom\",\n      tags: insertTemplate.tags || [],\n      isPublic: insertTemplate.isPublic || 0,\n      description: insertTemplate.description || null,\n      difficulty: insertTemplate.difficulty || \"easy\",\n      authorId: insertTemplate.authorId || null,\n      authorName: insertTemplate.authorName || null,\n      useCount: 0,\n      rating: 0,\n      ratingCount: 0,\n      featured: 0,\n      version: insertTemplate.version || \"1.0.0\",\n      previewImage: insertTemplate.previewImage || null,\n      lastUsedAt: null,\n      downloadCount: 0,\n      likeCount: 0,\n      bookmarkCount: 0,\n      viewCount: 0,\n      language: insertTemplate.language || \"ru\",\n      requiresToken: insertTemplate.requiresToken || 0,\n      complexity: insertTemplate.complexity || 1,\n      estimatedTime: insertTemplate.estimatedTime || 5,\n    };\n    this.templates.set(id, template);\n    return template;\n  }\n\n  async updateBotTemplate(id: number, updateData: Partial<InsertBotTemplate>): Promise<BotTemplate | undefined> {\n    const template = this.templates.get(id);\n    if (!template) return undefined;\n\n    const updatedTemplate: BotTemplate = {\n      ...template,\n      ...updateData,\n      updatedAt: new Date(),\n    };\n    \n    this.templates.set(id, updatedTemplate);\n    return updatedTemplate;\n  }\n\n  async deleteBotTemplate(id: number): Promise<boolean> {\n    return this.templates.delete(id);\n  }\n\n  async incrementTemplateUseCount(id: number): Promise<boolean> {\n    const template = this.templates.get(id);\n    if (!template) return false;\n\n    const updatedTemplate = {\n      ...template,\n      useCount: (template.useCount || 0) + 1,\n      lastUsedAt: new Date(),\n      updatedAt: new Date(),\n    };\n    \n    this.templates.set(id, updatedTemplate);\n    return true;\n  }\n\n  async incrementTemplateViewCount(id: number): Promise<boolean> {\n    const template = this.templates.get(id);\n    if (!template) return false;\n\n    const updatedTemplate = {\n      ...template,\n      viewCount: (template.viewCount || 0) + 1,\n      updatedAt: new Date(),\n    };\n    \n    this.templates.set(id, updatedTemplate);\n    return true;\n  }\n\n  async incrementTemplateDownloadCount(id: number): Promise<boolean> {\n    const template = this.templates.get(id);\n    if (!template) return false;\n\n    const updatedTemplate = {\n      ...template,\n      downloadCount: (template.downloadCount || 0) + 1,\n      updatedAt: new Date(),\n    };\n    \n    this.templates.set(id, updatedTemplate);\n    return true;\n  }\n\n  async toggleTemplateLike(id: number, liked: boolean): Promise<boolean> {\n    const template = this.templates.get(id);\n    if (!template) return false;\n\n    const updatedTemplate = {\n      ...template,\n      likeCount: Math.max(0, (template.likeCount || 0) + (liked ? 1 : -1)),\n      updatedAt: new Date(),\n    };\n    \n    this.templates.set(id, updatedTemplate);\n    return true;\n  }\n\n  async toggleTemplateBookmark(id: number, bookmarked: boolean): Promise<boolean> {\n    const template = this.templates.get(id);\n    if (!template) return false;\n\n    const updatedTemplate = {\n      ...template,\n      bookmarkCount: Math.max(0, (template.bookmarkCount || 0) + (bookmarked ? 1 : -1)),\n      updatedAt: new Date(),\n    };\n    \n    this.templates.set(id, updatedTemplate);\n    return true;\n  }\n\n  async rateTemplate(id: number, rating: number): Promise<boolean> {\n    const template = this.templates.get(id);\n    if (!template) return false;\n\n    // Обновляем рейтинг\n    const currentRatingCount = template.ratingCount || 0;\n    const currentRating = template.rating || 0;\n    const newRatingCount = currentRatingCount + 1;\n    const newRating = Math.round(((currentRating * currentRatingCount) + rating) / newRatingCount);\n\n    const updatedTemplate = {\n      ...template,\n      rating: newRating,\n      ratingCount: newRatingCount,\n      updatedAt: new Date(),\n    };\n    \n    this.templates.set(id, updatedTemplate);\n    return true;\n  }\n\n  async getFeaturedTemplates(): Promise<BotTemplate[]> {\n    return Array.from(this.templates.values()).filter(template => template.featured === 1);\n  }\n\n  async getTemplatesByCategory(category: string): Promise<BotTemplate[]> {\n    return Array.from(this.templates.values()).filter(template => template.category === category);\n  }\n\n  async searchTemplates(query: string): Promise<BotTemplate[]> {\n    const searchTerm = query.toLowerCase();\n    return Array.from(this.templates.values()).filter(template => \n      template.name.toLowerCase().includes(searchTerm) ||\n      (template.description && template.description.toLowerCase().includes(searchTerm)) ||\n      (template.tags && template.tags.some(tag => tag.toLowerCase().includes(searchTerm)))\n    );\n  }\n\n  // Bot Tokens (Memory implementation)\n  async getBotToken(id: number): Promise<BotToken | undefined> {\n    // In memory implementation - tokens are not stored\n    return undefined;\n  }\n\n  async getBotTokensByProject(projectId: number): Promise<BotToken[]> {\n    // In memory implementation - tokens are not stored\n    return [];\n  }\n\n  async getDefaultBotToken(projectId: number): Promise<BotToken | undefined> {\n    // In memory implementation - tokens are not stored\n    return undefined;\n  }\n\n  async createBotToken(insertToken: InsertBotToken): Promise<BotToken> {\n    // In memory implementation - create temporary token\n    const token: BotToken = {\n      ...insertToken,\n      id: this.currentTemplateId++, // Reuse template ID counter\n      description: insertToken.description || null,\n      lastUsedAt: null,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n      // Добавляем значения по умолчанию для новых полей\n      botFirstName: insertToken.botFirstName || null,\n      botUsername: insertToken.botUsername || null,\n      botDescription: insertToken.botDescription || null,\n      botShortDescription: insertToken.botShortDescription || null,\n      botPhotoUrl: insertToken.botPhotoUrl || null,\n      botCanJoinGroups: insertToken.botCanJoinGroups || null,\n      botCanReadAllGroupMessages: insertToken.botCanReadAllGroupMessages || null,\n      botSupportsInlineQueries: insertToken.botSupportsInlineQueries || null,\n      botHasMainWebApp: insertToken.botHasMainWebApp || null,\n    };\n    return token;\n  }\n\n  async updateBotToken(id: number, updateData: Partial<InsertBotToken>): Promise<BotToken | undefined> {\n    // In memory implementation - not supported\n    return undefined;\n  }\n\n  async deleteBotToken(id: number): Promise<boolean> {\n    // In memory implementation - not supported\n    return false;\n  }\n\n  async setDefaultBotToken(projectId: number, tokenId: number): Promise<boolean> {\n    // In memory implementation - not supported\n    return false;\n  }\n\n  async markTokenAsUsed(id: number): Promise<boolean> {\n    // In memory implementation - not supported\n    return false;\n  }\n\n  // Media Files (Memory implementation - not supported)\n  async getMediaFile(id: number): Promise<MediaFile | undefined> {\n    return undefined;\n  }\n\n  async getMediaFilesByProject(projectId: number): Promise<MediaFile[]> {\n    return [];\n  }\n\n  async getMediaFilesByType(projectId: number, fileType: string): Promise<MediaFile[]> {\n    return [];\n  }\n\n  async createMediaFile(insertFile: InsertMediaFile): Promise<MediaFile> {\n    const file: MediaFile = {\n      ...insertFile,\n      id: this.currentTemplateId++,\n      description: insertFile.description || null,\n      usageCount: 0,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    return file;\n  }\n\n  async updateMediaFile(id: number, updateData: Partial<InsertMediaFile>): Promise<MediaFile | undefined> {\n    return undefined;\n  }\n\n  async deleteMediaFile(id: number): Promise<boolean> {\n    return false;\n  }\n\n  async incrementMediaFileUsage(id: number): Promise<boolean> {\n    return false;\n  }\n\n  async searchMediaFiles(projectId: number, query: string): Promise<MediaFile[]> {\n    return [];\n  }\n\n  // User Bot Data (Memory implementation - not supported)\n  async getUserBotData(id: number): Promise<UserBotData | undefined> {\n    return undefined;\n  }\n\n  async getUserBotDataByProjectAndUser(projectId: number, userId: string): Promise<UserBotData | undefined> {\n    return undefined;\n  }\n\n  async getUserBotDataByProject(projectId: number): Promise<UserBotData[]> {\n    return [];\n  }\n\n  async getAllUserBotData(): Promise<UserBotData[]> {\n    return [];\n  }\n\n  async createUserBotData(insertUserData: InsertUserBotData): Promise<UserBotData> {\n    const userData: UserBotData = {\n      ...insertUserData,\n      id: this.currentTemplateId++,\n      userName: insertUserData.userName || null,\n      firstName: insertUserData.firstName || null,\n      lastName: insertUserData.lastName || null,\n      languageCode: insertUserData.languageCode || null,\n      lastInteraction: new Date(),\n      interactionCount: insertUserData.interactionCount || 0,\n      userData: insertUserData.userData || {},\n      currentState: insertUserData.currentState || null,\n      preferences: insertUserData.preferences || {},\n      commandsUsed: insertUserData.commandsUsed || {},\n      sessionsCount: insertUserData.sessionsCount || 1,\n      totalMessagesSent: insertUserData.totalMessagesSent || 0,\n      totalMessagesReceived: insertUserData.totalMessagesReceived || 0,\n      deviceInfo: insertUserData.deviceInfo || null,\n      locationData: insertUserData.locationData || null,\n      contactData: insertUserData.contactData || null,\n      isBot: insertUserData.isBot || 0,\n      isPremium: insertUserData.isPremium || 0,\n      isBlocked: insertUserData.isBlocked || 0,\n      isActive: insertUserData.isActive || 1,\n      tags: insertUserData.tags || [],\n      notes: insertUserData.notes || null,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    return userData;\n  }\n\n  async updateUserBotData(id: number, updateData: Partial<InsertUserBotData>): Promise<UserBotData | undefined> {\n    return undefined;\n  }\n\n  async deleteUserBotData(id: number): Promise<boolean> {\n    return false;\n  }\n\n  async deleteUserBotDataByProject(projectId: number): Promise<boolean> {\n    return false;\n  }\n\n  async incrementUserInteraction(id: number): Promise<boolean> {\n    return false;\n  }\n\n  async updateUserState(id: number, state: string): Promise<boolean> {\n    return false;\n  }\n\n  async searchUserBotData(projectId: number, query: string): Promise<UserBotData[]> {\n    return [];\n  }\n\n  async getUserBotDataStats(projectId: number): Promise<{\n    totalUsers: number;\n    activeUsers: number;\n    blockedUsers: number;\n    premiumUsers: number;\n    totalInteractions: number;\n    avgInteractionsPerUser: number;\n  }> {\n    return {\n      totalUsers: 0,\n      activeUsers: 0,\n      blockedUsers: 0,\n      premiumUsers: 0,\n      totalInteractions: 0,\n      avgInteractionsPerUser: 0\n    };\n  }\n  \n  // Bot Groups stubs\n  async getBotGroup(id: number): Promise<BotGroup | undefined> {\n    return undefined;\n  }\n\n  async getBotGroupsByProject(projectId: number): Promise<BotGroup[]> {\n    return [];\n  }\n\n  async getBotGroupByProjectAndGroupId(projectId: number, groupId: string): Promise<BotGroup | undefined> {\n    return undefined;\n  }\n\n  async createBotGroup(group: InsertBotGroup): Promise<BotGroup> {\n    throw new Error(\"MemStorage does not support groups\");\n  }\n\n  async updateBotGroup(id: number, group: Partial<InsertBotGroup>): Promise<BotGroup | undefined> {\n    return undefined;\n  }\n\n  async deleteBotGroup(id: number): Promise<boolean> {\n    return false;\n  }\n\n  // Group members stubs\n  async getGroupMembers(groupId: number): Promise<GroupMember[]> {\n    return [];\n  }\n\n  async createGroupMember(member: InsertGroupMember): Promise<GroupMember> {\n    throw new Error(\"MemStorage does not support group members\");\n  }\n\n  async updateGroupMember(id: number, member: Partial<InsertGroupMember>): Promise<GroupMember | undefined> {\n    return undefined;\n  }\n\n  async deleteGroupMember(id: number): Promise<boolean> {\n    return false;\n  }\n\n  // Bot messages stubs\n  async createBotMessage(message: InsertBotMessage): Promise<BotMessage> {\n    throw new Error(\"MemStorage does not support bot messages\");\n  }\n\n  async getBotMessages(projectId: number, userId: string, limit?: number): Promise<BotMessage[]> {\n    return [];\n  }\n\n  async getBotMessagesWithMedia(projectId: number, userId: string, limit?: number): Promise<(BotMessage & { media?: Array<MediaFile & { mediaKind: string; orderIndex: number }> })[]> {\n    return [];\n  }\n\n  async deleteBotMessages(projectId: number, userId: string): Promise<boolean> {\n    return false;\n  }\n\n  async deleteAllBotMessages(projectId: number): Promise<boolean> {\n    return false;\n  }\n\n  async createBotMessageMedia(data: InsertBotMessageMedia): Promise<BotMessageMedia> {\n    throw new Error(\"MemStorage does not support bot message media\");\n  }\n\n  async getMessageMedia(messageId: number): Promise<Array<MediaFile & { mediaKind: string; orderIndex: number }>> {\n    return [];\n  }\n}\n\n// Database Storage Implementation\nexport class DatabaseStorage implements IStorage {\n  protected db = db;\n  \n  // Bot Projects\n  async getBotProject(id: number): Promise<BotProject | undefined> {\n    const [project] = await this.db.select().from(botProjects).where(eq(botProjects.id, id));\n    return project || undefined;\n  }\n\n  async getAllBotProjects(): Promise<BotProject[]> {\n    return await this.db.select().from(botProjects).orderBy(desc(botProjects.updatedAt));\n  }\n\n  async createBotProject(insertProject: InsertBotProject): Promise<BotProject> {\n    const [project] = await this.db\n      .insert(botProjects)\n      .values(insertProject)\n      .returning();\n    return project;\n  }\n\n  async updateBotProject(id: number, updateData: Partial<InsertBotProject>): Promise<BotProject | undefined> {\n    const [project] = await this.db\n      .update(botProjects)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(botProjects.id, id))\n      .returning();\n    return project || undefined;\n  }\n\n  async deleteBotProject(id: number): Promise<boolean> {\n    const result = await this.db.delete(botProjects).where(eq(botProjects.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Bot Instances\n  async getBotInstance(projectId: number): Promise<BotInstance | undefined> {\n    const [instance] = await this.db.select().from(botInstances).where(eq(botInstances.projectId, projectId));\n    return instance || undefined;\n  }\n\n  async getBotInstanceByToken(tokenId: number): Promise<BotInstance | undefined> {\n    const [instance] = await this.db.select().from(botInstances).where(eq(botInstances.tokenId, tokenId));\n    return instance || undefined;\n  }\n\n  async getBotInstancesByProject(projectId: number): Promise<BotInstance[]> {\n    return await this.db.select().from(botInstances).where(eq(botInstances.projectId, projectId));\n  }\n\n  async getAllBotInstances(): Promise<BotInstance[]> {\n    return await this.db.select().from(botInstances).orderBy(desc(botInstances.startedAt));\n  }\n\n  async createBotInstance(insertInstance: InsertBotInstance): Promise<BotInstance> {\n    const [instance] = await this.db\n      .insert(botInstances)\n      .values(insertInstance)\n      .returning();\n    return instance;\n  }\n\n  async updateBotInstance(id: number, updateData: Partial<InsertBotInstance>): Promise<BotInstance | undefined> {\n    const [instance] = await this.db\n      .update(botInstances)\n      .set(updateData)\n      .where(eq(botInstances.id, id))\n      .returning();\n    return instance || undefined;\n  }\n\n  async deleteBotInstance(id: number): Promise<boolean> {\n    const result = await this.db.delete(botInstances).where(eq(botInstances.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async stopBotInstance(projectId: number): Promise<boolean> {\n    const result = await this.db\n      .update(botInstances)\n      .set({ status: 'stopped', stoppedAt: new Date() })\n      .where(eq(botInstances.projectId, projectId));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async stopBotInstanceByToken(tokenId: number): Promise<boolean> {\n    const result = await this.db\n      .update(botInstances)\n      .set({ status: 'stopped', stoppedAt: new Date() })\n      .where(eq(botInstances.tokenId, tokenId));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Bot Templates\n  async getBotTemplate(id: number): Promise<BotTemplate | undefined> {\n    const [template] = await this.db.select().from(botTemplates).where(eq(botTemplates.id, id));\n    return template || undefined;\n  }\n\n  async getAllBotTemplates(): Promise<BotTemplate[]> {\n    return await this.db.select().from(botTemplates).orderBy(desc(botTemplates.createdAt));\n  }\n\n  async createBotTemplate(insertTemplate: InsertBotTemplate): Promise<BotTemplate> {\n    const [template] = await this.db\n      .insert(botTemplates)\n      .values(insertTemplate)\n      .returning();\n    return template;\n  }\n\n  async updateBotTemplate(id: number, updateData: Partial<InsertBotTemplate>): Promise<BotTemplate | undefined> {\n    const [template] = await this.db\n      .update(botTemplates)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(botTemplates.id, id))\n      .returning();\n    return template || undefined;\n  }\n\n  async deleteBotTemplate(id: number): Promise<boolean> {\n    const result = await this.db.delete(botTemplates).where(eq(botTemplates.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async incrementTemplateUseCount(id: number): Promise<boolean> {\n    const [template] = await this.db.select().from(botTemplates).where(eq(botTemplates.id, id));\n    if (!template) return false;\n    \n    const result = await this.db\n      .update(botTemplates)\n      .set({ \n        useCount: (template.useCount || 0) + 1,\n        lastUsedAt: new Date()\n      })\n      .where(eq(botTemplates.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async incrementTemplateViewCount(id: number): Promise<boolean> {\n    const [template] = await this.db.select().from(botTemplates).where(eq(botTemplates.id, id));\n    if (!template) return false;\n    \n    const result = await this.db\n      .update(botTemplates)\n      .set({ \n        viewCount: (template.viewCount || 0) + 1\n      })\n      .where(eq(botTemplates.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async incrementTemplateDownloadCount(id: number): Promise<boolean> {\n    const [template] = await this.db.select().from(botTemplates).where(eq(botTemplates.id, id));\n    if (!template) return false;\n    \n    const result = await this.db\n      .update(botTemplates)\n      .set({ \n        downloadCount: (template.downloadCount || 0) + 1\n      })\n      .where(eq(botTemplates.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async toggleTemplateLike(id: number, liked: boolean): Promise<boolean> {\n    const [template] = await this.db.select().from(botTemplates).where(eq(botTemplates.id, id));\n    if (!template) return false;\n    \n    const current = template.likeCount || 0;\n    const newCount = liked ? current + 1 : Math.max(0, current - 1);\n    \n    const result = await this.db\n      .update(botTemplates)\n      .set({ \n        likeCount: newCount\n      })\n      .where(eq(botTemplates.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async toggleTemplateBookmark(id: number, bookmarked: boolean): Promise<boolean> {\n    const [template] = await this.db.select().from(botTemplates).where(eq(botTemplates.id, id));\n    if (!template) return false;\n    \n    const current = template.bookmarkCount || 0;\n    const newCount = bookmarked ? current + 1 : Math.max(0, current - 1);\n    \n    const result = await this.db\n      .update(botTemplates)\n      .set({ \n        bookmarkCount: newCount\n      })\n      .where(eq(botTemplates.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async rateTemplate(id: number, rating: number): Promise<boolean> {\n    const [template] = await this.db.select().from(botTemplates).where(eq(botTemplates.id, id));\n    if (!template) return false;\n\n    const currentRating = template.rating || 0;\n    const currentRatingCount = template.ratingCount || 0;\n    const newRatingCount = currentRatingCount + 1;\n    const newRating = Math.round(((currentRating * currentRatingCount) + rating) / newRatingCount);\n\n    const result = await this.db\n      .update(botTemplates)\n      .set({ \n        rating: newRating,\n        ratingCount: newRatingCount,\n        updatedAt: new Date()\n      })\n      .where(eq(botTemplates.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getFeaturedTemplates(): Promise<BotTemplate[]> {\n    return await this.db.select().from(botTemplates).where(eq(botTemplates.featured, 1)).orderBy(desc(botTemplates.rating));\n  }\n\n  async getTemplatesByCategory(category: string): Promise<BotTemplate[]> {\n    return await this.db.select().from(botTemplates).where(eq(botTemplates.category, category)).orderBy(desc(botTemplates.createdAt));\n  }\n\n  async searchTemplates(query: string): Promise<BotTemplate[]> {\n    const searchTerm = `%${query.toLowerCase()}%`;\n    return await this.db.select().from(botTemplates).where(\n      or(\n        ilike(botTemplates.name, searchTerm),\n        ilike(botTemplates.description, searchTerm)\n      )\n    ).orderBy(desc(botTemplates.rating));\n  }\n\n  // Bot Tokens\n  async getBotToken(id: number): Promise<BotToken | undefined> {\n    const [token] = await this.db.select().from(botTokens).where(eq(botTokens.id, id));\n    return token || undefined;\n  }\n\n  async getBotTokensByProject(projectId: number): Promise<BotToken[]> {\n    return await this.db.select().from(botTokens)\n      .where(eq(botTokens.projectId, projectId))\n      .orderBy(desc(botTokens.isDefault), desc(botTokens.createdAt));\n  }\n\n  async getDefaultBotToken(projectId: number): Promise<BotToken | undefined> {\n    const [token] = await this.db.select().from(botTokens)\n      .where(and(eq(botTokens.projectId, projectId), eq(botTokens.isDefault, 1)))\n      .orderBy(desc(botTokens.createdAt));\n    return token || undefined;\n  }\n\n  async createBotToken(insertToken: InsertBotToken): Promise<BotToken> {\n    if (insertToken.isDefault === 1) {\n      await this.db.update(botTokens)\n        .set({ isDefault: 0 })\n        .where(eq(botTokens.projectId, insertToken.projectId));\n    }\n\n    const [token] = await this.db\n      .insert(botTokens)\n      .values(insertToken)\n      .returning();\n    return token;\n  }\n\n  async updateBotToken(id: number, updateData: Partial<InsertBotToken>): Promise<BotToken | undefined> {\n    if (updateData.isDefault === 1) {\n      const [currentToken] = await this.db.select().from(botTokens).where(eq(botTokens.id, id));\n      if (currentToken) {\n        await this.db.update(botTokens)\n          .set({ isDefault: 0 })\n          .where(eq(botTokens.projectId, currentToken.projectId));\n      }\n    }\n\n    const [token] = await this.db\n      .update(botTokens)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(botTokens.id, id))\n      .returning();\n    return token || undefined;\n  }\n\n  async deleteBotToken(id: number): Promise<boolean> {\n    const result = await this.db.delete(botTokens).where(eq(botTokens.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async setDefaultBotToken(projectId: number, tokenId: number): Promise<boolean> {\n    await this.db.update(botTokens)\n      .set({ isDefault: 0 })\n      .where(eq(botTokens.projectId, projectId));\n\n    const result = await this.db.update(botTokens)\n      .set({ isDefault: 1 })\n      .where(eq(botTokens.id, tokenId));\n    \n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async markTokenAsUsed(id: number): Promise<boolean> {\n    const result = await this.db.update(botTokens)\n      .set({ lastUsedAt: new Date() })\n      .where(eq(botTokens.id, id));\n    \n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Media Files\n  async getMediaFile(id: number): Promise<MediaFile | undefined> {\n    const [file] = await this.db.select().from(mediaFiles).where(eq(mediaFiles.id, id));\n    return file || undefined;\n  }\n\n  async getMediaFilesByProject(projectId: number): Promise<MediaFile[]> {\n    return await this.db.select().from(mediaFiles)\n      .where(eq(mediaFiles.projectId, projectId))\n      .orderBy(desc(mediaFiles.createdAt));\n  }\n\n  async getMediaFilesByType(projectId: number, fileType: string): Promise<MediaFile[]> {\n    return await this.db.select().from(mediaFiles)\n      .where(and(eq(mediaFiles.projectId, projectId), eq(mediaFiles.fileType, fileType)))\n      .orderBy(desc(mediaFiles.createdAt));\n  }\n\n  async createMediaFile(insertFile: InsertMediaFile): Promise<MediaFile> {\n    const [file] = await this.db\n      .insert(mediaFiles)\n      .values(insertFile)\n      .returning();\n    return file;\n  }\n\n  async updateMediaFile(id: number, updateData: Partial<InsertMediaFile>): Promise<MediaFile | undefined> {\n    const [file] = await this.db\n      .update(mediaFiles)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(mediaFiles.id, id))\n      .returning();\n    return file || undefined;\n  }\n\n  async deleteMediaFile(id: number): Promise<boolean> {\n    const result = await this.db.delete(mediaFiles).where(eq(mediaFiles.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async incrementMediaFileUsage(id: number): Promise<boolean> {\n    const [file] = await this.db.select().from(mediaFiles).where(eq(mediaFiles.id, id));\n    if (!file) return false;\n    \n    const result = await this.db\n      .update(mediaFiles)\n      .set({ \n        usageCount: (file.usageCount || 0) + 1,\n        updatedAt: new Date()\n      })\n      .where(eq(mediaFiles.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async searchMediaFiles(projectId: number, query: string): Promise<MediaFile[]> {\n    const searchTerm = `%${query.toLowerCase()}%`;\n    return await this.db.select().from(mediaFiles)\n      .where(\n        and(\n          eq(mediaFiles.projectId, projectId),\n          or(\n            ilike(mediaFiles.fileName, searchTerm),\n            ilike(mediaFiles.description, searchTerm)\n          )\n        )\n      )\n      .orderBy(desc(mediaFiles.usageCount), desc(mediaFiles.createdAt));\n  }\n\n  // User Bot Data\n  async getUserBotData(id: number): Promise<UserBotData | undefined> {\n    const [userData] = await this.db.select().from(userBotData).where(eq(userBotData.id, id));\n    return userData || undefined;\n  }\n\n  async getUserBotDataByProjectAndUser(projectId: number, userId: string): Promise<UserBotData | undefined> {\n    const [userData] = await this.db.select().from(userBotData)\n      .where(and(eq(userBotData.projectId, projectId), eq(userBotData.userId, userId)));\n    return userData || undefined;\n  }\n\n  async getUserBotDataByProject(projectId: number): Promise<UserBotData[]> {\n    return await this.db.select().from(userBotData)\n      .where(eq(userBotData.projectId, projectId))\n      .orderBy(desc(userBotData.lastInteraction));\n  }\n\n  async getAllUserBotData(): Promise<UserBotData[]> {\n    return await this.db.select().from(userBotData).orderBy(desc(userBotData.lastInteraction));\n  }\n\n  async createUserBotData(insertUserData: InsertUserBotData): Promise<UserBotData> {\n    const [userData] = await this.db\n      .insert(userBotData)\n      .values(insertUserData)\n      .returning();\n    return userData;\n  }\n\n  async updateUserBotData(id: number, updateData: Partial<InsertUserBotData>): Promise<UserBotData | undefined> {\n    const [userData] = await this.db\n      .update(userBotData)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(userBotData.id, id))\n      .returning();\n    return userData || undefined;\n  }\n\n  async deleteUserBotData(id: number): Promise<boolean> {\n    const result = await this.db.delete(userBotData).where(eq(userBotData.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async deleteUserBotDataByProject(projectId: number): Promise<boolean> {\n    const result = await this.db.delete(userBotData).where(eq(userBotData.projectId, projectId));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async incrementUserInteraction(id: number): Promise<boolean> {\n    const [userData] = await this.db.select().from(userBotData).where(eq(userBotData.id, id));\n    if (!userData) return false;\n    \n    const result = await this.db\n      .update(userBotData)\n      .set({ \n        interactionCount: (userData.interactionCount || 0) + 1,\n        lastInteraction: new Date(),\n        updatedAt: new Date()\n      })\n      .where(eq(userBotData.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async updateUserState(id: number, state: string): Promise<boolean> {\n    const result = await this.db\n      .update(userBotData)\n      .set({ \n        currentState: state,\n        updatedAt: new Date()\n      })\n      .where(eq(userBotData.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async searchUserBotData(projectId: number, query: string): Promise<UserBotData[]> {\n    const searchTerm = `%${query.toLowerCase()}%`;\n    return await this.db.select().from(userBotData)\n      .where(\n        and(\n          eq(userBotData.projectId, projectId),\n          or(\n            ilike(userBotData.userName, searchTerm),\n            ilike(userBotData.firstName, searchTerm),\n            ilike(userBotData.lastName, searchTerm),\n            ilike(userBotData.notes, searchTerm)\n          )\n        )\n      )\n      .orderBy(desc(userBotData.lastInteraction));\n  }\n\n  async searchBotUsers(query: string): Promise<BotUser[]> {\n    // Убираем @ символ если есть\n    const cleanQuery = query.startsWith('@') ? query.slice(1) : query;\n    const searchTerm = `%${cleanQuery.toLowerCase()}%`;\n    const numericQuery = parseInt(cleanQuery);\n    \n    return await this.db.select().from(botUsers)\n      .where(\n        or(\n          ilike(botUsers.username, searchTerm),\n          ilike(botUsers.firstName, searchTerm),\n          ilike(botUsers.lastName, searchTerm),\n          isNaN(numericQuery) ? sql`false` : eq(botUsers.userId, numericQuery)\n        )\n      )\n      .orderBy(desc(botUsers.lastInteraction));\n  }\n\n  async getUserBotDataStats(projectId: number): Promise<{\n    totalUsers: number;\n    activeUsers: number;\n    blockedUsers: number;\n    premiumUsers: number;\n    totalInteractions: number;\n    avgInteractionsPerUser: number;\n  }> {\n    const users = await this.db.select().from(userBotData).where(eq(userBotData.projectId, projectId));\n    \n    const totalUsers = users.length;\n    const activeUsers = users.filter(u => u.isActive === 1).length;\n    const blockedUsers = users.filter(u => u.isBlocked === 1).length;\n    const premiumUsers = users.filter(u => u.isPremium === 1).length;\n    const totalInteractions = users.reduce((sum, u) => sum + (u.interactionCount || 0), 0);\n    const avgInteractionsPerUser = totalUsers > 0 ? totalInteractions / totalUsers : 0;\n\n    return {\n      totalUsers,\n      activeUsers,\n      blockedUsers,\n      premiumUsers,\n      totalInteractions,\n      avgInteractionsPerUser\n    };\n  }\n\n  // Bot Groups\n  async getBotGroup(id: number): Promise<BotGroup | undefined> {\n    const [group] = await this.db.select().from(botGroups).where(eq(botGroups.id, id));\n    return group || undefined;\n  }\n\n  async getBotGroupsByProject(projectId: number): Promise<BotGroup[]> {\n    return await this.db.select().from(botGroups)\n      .where(eq(botGroups.projectId, projectId))\n      .orderBy(desc(botGroups.createdAt));\n  }\n\n  async getBotGroupByProjectAndGroupId(projectId: number, groupId: string): Promise<BotGroup | undefined> {\n    const [group] = await this.db.select().from(botGroups)\n      .where(and(eq(botGroups.projectId, projectId), eq(botGroups.groupId, groupId)));\n    return group || undefined;\n  }\n\n  async createBotGroup(insertGroup: InsertBotGroup): Promise<BotGroup> {\n    const [group] = await this.db\n      .insert(botGroups)\n      .values(insertGroup)\n      .returning();\n    return group;\n  }\n\n  async updateBotGroup(id: number, updateData: Partial<InsertBotGroup>): Promise<BotGroup | undefined> {\n    const [group] = await this.db\n      .update(botGroups)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(botGroups.id, id))\n      .returning();\n    return group || undefined;\n  }\n\n  async deleteBotGroup(id: number): Promise<boolean> {\n    const result = await this.db.delete(botGroups).where(eq(botGroups.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Group members\n  async getGroupMembers(groupId: number): Promise<GroupMember[]> {\n    return await this.db.select().from(groupMembers)\n      .where(eq(groupMembers.groupId, groupId))\n      .orderBy(desc(groupMembers.joinedAt));\n  }\n\n  async createGroupMember(insertMember: InsertGroupMember): Promise<GroupMember> {\n    const [member] = await this.db\n      .insert(groupMembers)\n      .values(insertMember)\n      .returning();\n    return member;\n  }\n\n  async updateGroupMember(id: number, updateData: Partial<InsertGroupMember>): Promise<GroupMember | undefined> {\n    const [member] = await this.db\n      .update(groupMembers)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(groupMembers.id, id))\n      .returning();\n    return member || undefined;\n  }\n\n  async deleteGroupMember(id: number): Promise<boolean> {\n    const result = await this.db.delete(groupMembers).where(eq(groupMembers.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Bot messages\n  async createBotMessage(insertMessage: InsertBotMessage): Promise<BotMessage> {\n    const [message] = await this.db\n      .insert(botMessages)\n      .values(insertMessage)\n      .returning();\n    return message;\n  }\n\n  async getBotMessages(projectId: number, userId: string, limit: number = 100): Promise<BotMessage[]> {\n    return await this.db\n      .select()\n      .from(botMessages)\n      .where(and(\n        eq(botMessages.projectId, projectId),\n        eq(botMessages.userId, userId)\n      ))\n      .orderBy(asc(botMessages.createdAt))\n      .limit(limit);\n  }\n\n  async deleteBotMessages(projectId: number, userId: string): Promise<boolean> {\n    const result = await this.db\n      .delete(botMessages)\n      .where(and(\n        eq(botMessages.projectId, projectId),\n        eq(botMessages.userId, userId)\n      ));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async deleteAllBotMessages(projectId: number): Promise<boolean> {\n    const result = await this.db\n      .delete(botMessages)\n      .where(eq(botMessages.projectId, projectId));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Bot message media\n  async createBotMessageMedia(data: InsertBotMessageMedia): Promise<BotMessageMedia> {\n    const [media] = await this.db\n      .insert(botMessageMedia)\n      .values(data)\n      .returning();\n    return media;\n  }\n\n  async getMessageMedia(messageId: number): Promise<Array<MediaFile & { mediaKind: string; orderIndex: number }>> {\n    const result = await this.db\n      .select({\n        id: mediaFiles.id,\n        projectId: mediaFiles.projectId,\n        fileName: mediaFiles.fileName,\n        fileType: mediaFiles.fileType,\n        filePath: mediaFiles.filePath,\n        fileSize: mediaFiles.fileSize,\n        mimeType: mediaFiles.mimeType,\n        url: mediaFiles.url,\n        description: mediaFiles.description,\n        tags: mediaFiles.tags,\n        isPublic: mediaFiles.isPublic,\n        usageCount: mediaFiles.usageCount,\n        createdAt: mediaFiles.createdAt,\n        updatedAt: mediaFiles.updatedAt,\n        mediaKind: botMessageMedia.mediaKind,\n        orderIndex: botMessageMedia.orderIndex,\n      })\n      .from(botMessageMedia)\n      .innerJoin(mediaFiles, eq(botMessageMedia.mediaFileId, mediaFiles.id))\n      .where(eq(botMessageMedia.messageId, messageId))\n      .orderBy(asc(botMessageMedia.orderIndex));\n    \n    return result;\n  }\n\n  async getBotMessagesWithMedia(\n    projectId: number, \n    userId: string, \n    limit: number = 100\n  ): Promise<(BotMessage & { media?: Array<MediaFile & { mediaKind: string; orderIndex: number }> })[]> {\n    const messages = await this.db\n      .select()\n      .from(botMessages)\n      .where(and(\n        eq(botMessages.projectId, projectId),\n        eq(botMessages.userId, userId)\n      ))\n      .orderBy(asc(botMessages.createdAt))\n      .limit(limit);\n\n    const messagesWithMedia = await Promise.all(\n      messages.map(async (message) => {\n        const media = await this.getMessageMedia(message.id);\n        return {\n          ...message,\n          media: media.length > 0 ? media : undefined,\n        };\n      })\n    );\n\n    return messagesWithMedia;\n  }\n}\n\n// Оптимизированная версия с кэшированием\nexport class OptimizedDatabaseStorage extends DatabaseStorage {\n  private templateCache: Map<number, BotTemplate> = new Map();\n  private projectCache: Map<number, BotProject> = new Map();\n  private cacheTimeout = 5 * 60 * 1000; // 5 минут\n  \n  // Bot Projects (с кэшированием)\n  async getBotProject(id: number): Promise<BotProject | undefined> {\n    const cached = this.projectCache.get(id);\n    if (cached) return cached;\n    \n    const [project] = await this.db.select().from(botProjects).where(eq(botProjects.id, id));\n    if (project) {\n      this.projectCache.set(id, project);\n      // Автоматически очищаем кэш через timeout\n      setTimeout(() => this.projectCache.delete(id), this.cacheTimeout);\n    }\n    return project || undefined;\n  }\n\n  async getAllBotProjects(): Promise<BotProject[]> {\n    return await this.db.select().from(botProjects).orderBy(desc(botProjects.updatedAt));\n  }\n\n  async createBotProject(insertProject: InsertBotProject): Promise<BotProject> {\n    const [project] = await this.db\n      .insert(botProjects)\n      .values(insertProject)\n      .returning();\n    this.projectCache.set(project.id, project);\n    return project;\n  }\n\n  async updateBotProject(id: number, updateData: Partial<InsertBotProject>): Promise<BotProject | undefined> {\n    const [project] = await this.db\n      .update(botProjects)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(botProjects.id, id))\n      .returning();\n    if (project) {\n      this.projectCache.set(id, project);\n    }\n    return project || undefined;\n  }\n\n  async deleteBotProject(id: number): Promise<boolean> {\n    const result = await this.db.delete(botProjects).where(eq(botProjects.id, id));\n    this.projectCache.delete(id);\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Bot Instances (простая реализация)\n  async getBotInstance(projectId: number): Promise<BotInstance | undefined> {\n    const [instance] = await this.db.select().from(botInstances).where(eq(botInstances.projectId, projectId));\n    return instance || undefined;\n  }\n\n  async getAllBotInstances(): Promise<BotInstance[]> {\n    return await this.db.select().from(botInstances).orderBy(desc(botInstances.startedAt));\n  }\n\n  async createBotInstance(insertInstance: InsertBotInstance): Promise<BotInstance> {\n    const [instance] = await this.db\n      .insert(botInstances)\n      .values(insertInstance)\n      .returning();\n    return instance;\n  }\n\n  async updateBotInstance(id: number, updateData: Partial<InsertBotInstance>): Promise<BotInstance | undefined> {\n    const [instance] = await this.db\n      .update(botInstances)\n      .set(updateData)\n      .where(eq(botInstances.id, id))\n      .returning();\n    return instance || undefined;\n  }\n\n  async deleteBotInstance(id: number): Promise<boolean> {\n    const result = await this.db.delete(botInstances).where(eq(botInstances.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async stopBotInstance(projectId: number): Promise<boolean> {\n    const result = await this.db\n      .update(botInstances)\n      .set({ status: 'stopped', stoppedAt: new Date() })\n      .where(eq(botInstances.projectId, projectId));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async stopBotInstanceByToken(tokenId: number): Promise<boolean> {\n    const result = await this.db\n      .update(botInstances)\n      .set({ status: 'stopped', stoppedAt: new Date() })\n      .where(eq(botInstances.tokenId, tokenId));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Bot Templates (с кэшированием)\n  async getBotTemplate(id: number): Promise<BotTemplate | undefined> {\n    const cached = this.templateCache.get(id);\n    if (cached) return cached;\n    \n    const [template] = await this.db.select().from(botTemplates).where(eq(botTemplates.id, id));\n    if (template) {\n      this.templateCache.set(id, template);\n      setTimeout(() => this.templateCache.delete(id), this.cacheTimeout);\n    }\n    return template || undefined;\n  }\n\n  async getAllBotTemplates(): Promise<BotTemplate[]> {\n    return await this.db.select().from(botTemplates).orderBy(desc(botTemplates.createdAt));\n  }\n\n  async createBotTemplate(insertTemplate: InsertBotTemplate): Promise<BotTemplate> {\n    const [template] = await this.db\n      .insert(botTemplates)\n      .values(insertTemplate)\n      .returning();\n    this.templateCache.set(template.id, template);\n    return template;\n  }\n\n  async updateBotTemplate(id: number, updateData: Partial<InsertBotTemplate>): Promise<BotTemplate | undefined> {\n    const [template] = await this.db\n      .update(botTemplates)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(botTemplates.id, id))\n      .returning();\n    if (template) {\n      this.templateCache.set(id, template);\n    }\n    return template || undefined;\n  }\n\n  async deleteBotTemplate(id: number): Promise<boolean> {\n    const result = await this.db.delete(botTemplates).where(eq(botTemplates.id, id));\n    this.templateCache.delete(id);\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Упрощенные методы для счетчиков\n  async incrementTemplateUseCount(id: number): Promise<boolean> {\n    const result = await this.db\n      .update(botTemplates)\n      .set({ lastUsedAt: new Date() })\n      .where(eq(botTemplates.id, id));\n    this.templateCache.delete(id); // Очищаем кэш\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async incrementTemplateViewCount(id: number): Promise<boolean> {\n    const result = await this.db\n      .update(botTemplates)\n      .set({}) // Пустое обновление для простоты\n      .where(eq(botTemplates.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async incrementTemplateDownloadCount(id: number): Promise<boolean> {\n    const result = await this.db\n      .update(botTemplates)\n      .set({}) // Пустое обновление для простоты\n      .where(eq(botTemplates.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async toggleTemplateLike(id: number, liked: boolean): Promise<boolean> {\n    this.templateCache.delete(id);\n    return true;\n  }\n\n  async toggleTemplateBookmark(id: number, bookmarked: boolean): Promise<boolean> {\n    this.templateCache.delete(id);\n    return true;\n  }\n\n  async rateTemplate(id: number, rating: number): Promise<boolean> {\n    this.templateCache.delete(id);\n    return true;\n  }\n\n  async getFeaturedTemplates(): Promise<BotTemplate[]> {\n    return await this.db.select().from(botTemplates).where(eq(botTemplates.featured, 1)).orderBy(desc(botTemplates.rating));\n  }\n\n  async getTemplatesByCategory(category: string): Promise<BotTemplate[]> {\n    return await this.db.select().from(botTemplates).where(eq(botTemplates.category, category)).orderBy(desc(botTemplates.createdAt));\n  }\n\n  async searchTemplates(query: string): Promise<BotTemplate[]> {\n    const searchTerm = `%${query.toLowerCase()}%`;\n    return await this.db.select().from(botTemplates).where(\n      or(\n        ilike(botTemplates.name, searchTerm),\n        ilike(botTemplates.description, searchTerm)\n      )\n    ).orderBy(desc(botTemplates.rating));\n  }\n\n  // Bot Tokens\n  async getBotToken(id: number): Promise<BotToken | undefined> {\n    const [token] = await this.db.select().from(botTokens).where(eq(botTokens.id, id));\n    return token || undefined;\n  }\n\n  async getBotTokensByProject(projectId: number): Promise<BotToken[]> {\n    return await this.db.select().from(botTokens)\n      .where(eq(botTokens.projectId, projectId))\n      .orderBy(desc(botTokens.isDefault), desc(botTokens.createdAt));\n  }\n\n  async getDefaultBotToken(projectId: number): Promise<BotToken | undefined> {\n    const [token] = await this.db.select().from(botTokens)\n      .where(and(eq(botTokens.projectId, projectId), eq(botTokens.isDefault, 1)))\n      .orderBy(desc(botTokens.createdAt));\n    return token || undefined;\n  }\n\n  async createBotToken(insertToken: InsertBotToken): Promise<BotToken> {\n    // Если создаем токен по умолчанию, убираем флаг с других токенов\n    if (insertToken.isDefault === 1) {\n      await this.db.update(botTokens)\n        .set({ isDefault: 0 })\n        .where(eq(botTokens.projectId, insertToken.projectId));\n    }\n\n    const [token] = await this.db\n      .insert(botTokens)\n      .values(insertToken)\n      .returning();\n    return token;\n  }\n\n  async updateBotToken(id: number, updateData: Partial<InsertBotToken>): Promise<BotToken | undefined> {\n    // Если делаем токен по умолчанию, убираем флаг с других токенов\n    if (updateData.isDefault === 1) {\n      const [currentToken] = await this.db.select().from(botTokens).where(eq(botTokens.id, id));\n      if (currentToken) {\n        await this.db.update(botTokens)\n          .set({ isDefault: 0 })\n          .where(eq(botTokens.projectId, currentToken.projectId));\n      }\n    }\n\n    const [token] = await this.db\n      .update(botTokens)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(botTokens.id, id))\n      .returning();\n    return token || undefined;\n  }\n\n  async deleteBotToken(id: number): Promise<boolean> {\n    const result = await this.db.delete(botTokens).where(eq(botTokens.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async setDefaultBotToken(projectId: number, tokenId: number): Promise<boolean> {\n    // Убираем флаг по умолчанию со всех токенов проекта\n    await this.db.update(botTokens)\n      .set({ isDefault: 0 })\n      .where(eq(botTokens.projectId, projectId));\n\n    // Устанавливаем флаг по умолчанию для указанного токена\n    const result = await this.db.update(botTokens)\n      .set({ isDefault: 1 })\n      .where(eq(botTokens.id, tokenId));\n    \n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async markTokenAsUsed(id: number): Promise<boolean> {\n    const result = await this.db.update(botTokens)\n      .set({ lastUsedAt: new Date() })\n      .where(eq(botTokens.id, id));\n    \n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  // Media Files (simplified implementation)\n  async getMediaFile(id: number): Promise<MediaFile | undefined> {\n    const [file] = await this.db.select().from(mediaFiles).where(eq(mediaFiles.id, id));\n    return file || undefined;\n  }\n\n  async getMediaFilesByProject(projectId: number): Promise<MediaFile[]> {\n    return await this.db.select().from(mediaFiles)\n      .where(eq(mediaFiles.projectId, projectId))\n      .orderBy(desc(mediaFiles.createdAt));\n  }\n\n  async getMediaFilesByType(projectId: number, fileType: string): Promise<MediaFile[]> {\n    return await this.db.select().from(mediaFiles)\n      .where(and(eq(mediaFiles.projectId, projectId), eq(mediaFiles.fileType, fileType)))\n      .orderBy(desc(mediaFiles.createdAt));\n  }\n\n  async createMediaFile(insertFile: InsertMediaFile): Promise<MediaFile> {\n    const [file] = await this.db\n      .insert(mediaFiles)\n      .values(insertFile)\n      .returning();\n    return file;\n  }\n\n  async updateMediaFile(id: number, updateData: Partial<InsertMediaFile>): Promise<MediaFile | undefined> {\n    const [file] = await this.db\n      .update(mediaFiles)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(mediaFiles.id, id))\n      .returning();\n    return file || undefined;\n  }\n\n  async deleteMediaFile(id: number): Promise<boolean> {\n    const result = await this.db.delete(mediaFiles).where(eq(mediaFiles.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async incrementMediaFileUsage(id: number): Promise<boolean> {\n    const [file] = await this.db.select().from(mediaFiles).where(eq(mediaFiles.id, id));\n    if (!file) return false;\n    \n    const result = await this.db\n      .update(mediaFiles)\n      .set({ usageCount: (file.usageCount || 0) + 1 })\n      .where(eq(mediaFiles.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async searchMediaFiles(projectId: number, query: string): Promise<MediaFile[]> {\n    const searchTerm = `%${query.toLowerCase()}%`;\n    return await this.db.select().from(mediaFiles)\n      .where(\n        and(\n          eq(mediaFiles.projectId, projectId),\n          or(\n            ilike(mediaFiles.fileName, searchTerm),\n            ilike(mediaFiles.description, searchTerm)\n          )\n        )\n      )\n      .orderBy(desc(mediaFiles.createdAt));\n  }\n\n  // User Bot Data\n  async getUserBotData(id: number): Promise<UserBotData | undefined> {\n    const [userData] = await this.db.select().from(userBotData).where(eq(userBotData.id, id));\n    return userData || undefined;\n  }\n\n  async getUserBotDataByProjectAndUser(projectId: number, userId: string): Promise<UserBotData | undefined> {\n    const [userData] = await this.db.select().from(userBotData)\n      .where(and(eq(userBotData.projectId, projectId), eq(userBotData.userId, userId)));\n    return userData || undefined;\n  }\n\n  async getUserBotDataByProject(projectId: number): Promise<UserBotData[]> {\n    return await this.db.select().from(userBotData)\n      .where(eq(userBotData.projectId, projectId))\n      .orderBy(desc(userBotData.lastInteraction));\n  }\n\n  async getAllUserBotData(): Promise<UserBotData[]> {\n    return await this.db.select().from(userBotData)\n      .orderBy(desc(userBotData.lastInteraction));\n  }\n\n  async createUserBotData(insertUserData: InsertUserBotData): Promise<UserBotData> {\n    const [userData] = await this.db\n      .insert(userBotData)\n      .values(insertUserData)\n      .returning();\n    return userData;\n  }\n\n  async updateUserBotData(id: number, updateData: Partial<InsertUserBotData>): Promise<UserBotData | undefined> {\n    const [userData] = await this.db\n      .update(userBotData)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(userBotData.id, id))\n      .returning();\n    return userData || undefined;\n  }\n\n  async deleteUserBotData(id: number): Promise<boolean> {\n    const result = await this.db.delete(userBotData).where(eq(userBotData.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async deleteUserBotDataByProject(projectId: number): Promise<boolean> {\n    const result = await this.db.delete(userBotData).where(eq(userBotData.projectId, projectId));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async incrementUserInteraction(id: number): Promise<boolean> {\n    const [userData] = await this.db.select().from(userBotData).where(eq(userBotData.id, id));\n    if (!userData) return false;\n    \n    const result = await this.db\n      .update(userBotData)\n      .set({ \n        interactionCount: (userData.interactionCount || 0) + 1,\n        lastInteraction: new Date()\n      })\n      .where(eq(userBotData.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async updateUserState(id: number, state: string): Promise<boolean> {\n    const result = await this.db\n      .update(userBotData)\n      .set({ currentState: state, updatedAt: new Date() })\n      .where(eq(userBotData.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async searchUserBotData(projectId: number, query: string): Promise<UserBotData[]> {\n    const searchTerm = `%${query.toLowerCase()}%`;\n    return await this.db.select().from(userBotData)\n      .where(\n        and(\n          eq(userBotData.projectId, projectId),\n          or(\n            ilike(userBotData.firstName, searchTerm),\n            ilike(userBotData.lastName, searchTerm),\n            ilike(userBotData.userName, searchTerm),\n            ilike(userBotData.userId, searchTerm)\n          )\n        )\n      )\n      .orderBy(desc(userBotData.lastInteraction));\n  }\n\n  async getUserBotDataStats(projectId: number): Promise<{\n    totalUsers: number;\n    activeUsers: number;\n    blockedUsers: number;\n    premiumUsers: number;\n    totalInteractions: number;\n    avgInteractionsPerUser: number;\n  }> {\n    const users = await this.db.select().from(userBotData)\n      .where(eq(userBotData.projectId, projectId));\n    \n    const totalUsers = users.length;\n    const activeUsers = users.filter(u => u.isActive === 1).length;\n    const blockedUsers = users.filter(u => u.isBlocked === 1).length;\n    const premiumUsers = users.filter(u => u.isPremium === 1).length;\n    const totalInteractions = users.reduce((sum, u) => sum + (u.interactionCount || 0), 0);\n    const avgInteractionsPerUser = totalUsers > 0 ? Math.round(totalInteractions / totalUsers) : 0;\n\n    return {\n      totalUsers,\n      activeUsers,\n      blockedUsers,\n      premiumUsers,\n      totalInteractions,\n      avgInteractionsPerUser\n    };\n  }\n  \n  // Bot Groups\n  async getBotGroup(id: number): Promise<BotGroup | undefined> {\n    const [group] = await this.db.select().from(botGroups).where(eq(botGroups.id, id));\n    return group || undefined;\n  }\n\n  async getBotGroupsByProject(projectId: number): Promise<BotGroup[]> {\n    return await this.db.select().from(botGroups)\n      .where(eq(botGroups.projectId, projectId))\n      .orderBy(desc(botGroups.createdAt));\n  }\n\n  async getBotGroupByProjectAndGroupId(projectId: number, groupId: string): Promise<BotGroup | undefined> {\n    const [group] = await this.db.select().from(botGroups)\n      .where(and(eq(botGroups.projectId, projectId), eq(botGroups.groupId, groupId)));\n    return group || undefined;\n  }\n\n  async createBotGroup(insertGroup: InsertBotGroup): Promise<BotGroup> {\n    const [group] = await this.db\n      .insert(botGroups)\n      .values(insertGroup)\n      .returning();\n    return group;\n  }\n\n  async updateBotGroup(id: number, updateData: Partial<InsertBotGroup>): Promise<BotGroup | undefined> {\n    const [group] = await this.db\n      .update(botGroups)\n      .set({ ...updateData, updatedAt: new Date() })\n      .where(eq(botGroups.id, id))\n      .returning();\n    return group || undefined;\n  }\n\n  async deleteBotGroup(id: number): Promise<boolean> {\n    const result = await this.db.delete(botGroups).where(eq(botGroups.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n}\n\n// Enhanced Database Storage with caching and monitoring\nexport class EnhancedDatabaseStorage extends DatabaseStorage {\n  // Override methods to add caching and monitoring\n  \n  async getBotProject(id: number): Promise<BotProject | undefined> {\n    return await cachedOps.getProjectCached(id, () => super.getBotProject(id));\n  }\n\n  async getBotTemplate(id: number): Promise<BotTemplate | undefined> {\n    return await cachedOps.getTemplateCached(id, () => super.getBotTemplate(id));\n  }\n\n  async getTemplatesByCategory(category: string): Promise<BotTemplate[]> {\n    return await cachedOps.getTemplateListCached(category, () => super.getTemplatesByCategory(category));\n  }\n\n  async createBotProject(insertProject: InsertBotProject): Promise<BotProject> {\n    return await dbManager.executeWithRetry(async () => {\n      const project = await super.createBotProject(insertProject);\n      cachedOps.invalidateProject(project.id);\n      return project;\n    });\n  }\n\n  async updateBotProject(id: number, updateData: Partial<InsertBotProject>): Promise<BotProject | undefined> {\n    return await dbManager.executeWithRetry(async () => {\n      const project = await super.updateBotProject(id, updateData);\n      cachedOps.invalidateProject(id);\n      return project;\n    });\n  }\n\n  async createBotTemplate(insertTemplate: InsertBotTemplate): Promise<BotTemplate> {\n    return await dbManager.executeWithRetry(async () => {\n      const template = await super.createBotTemplate(insertTemplate);\n      cachedOps.invalidateAllTemplates();\n      return template;\n    });\n  }\n\n  async updateBotTemplate(id: number, updateData: Partial<InsertBotTemplate>): Promise<BotTemplate | undefined> {\n    return await dbManager.executeWithRetry(async () => {\n      const template = await super.updateBotTemplate(id, updateData);\n      cachedOps.invalidateTemplate(id);\n      return template;\n    });\n  }\n\n  // Transaction support for complex operations\n  async createProjectWithTemplate(projectData: InsertBotProject, templateData: InsertBotTemplate): Promise<{ project: BotProject; template: BotTemplate }> {\n    return await dbManager.transaction(async (tx) => {\n      const project = await super.createBotProject(projectData);\n      const template = await super.createBotTemplate({ ...templateData, authorId: project.id.toString() });\n      \n      cachedOps.invalidateProject(project.id);\n      cachedOps.invalidateAllTemplates();\n      \n      return { project, template };\n    });\n  }\n\n  // Bulk operations with better performance\n  async bulkCreateTemplates(templates: InsertBotTemplate[]): Promise<BotTemplate[]> {\n    return await dbManager.executeWithRetry(async () => {\n      const results = await Promise.all(\n        templates.map(template => super.createBotTemplate(template))\n      );\n      cachedOps.invalidateAllTemplates();\n      return results;\n    });\n  }\n\n  // Enhanced statistics with caching\n  async getDetailedStats(): Promise<{\n    projects: number;\n    templates: number;\n    activeInstances: number;\n    totalUsers: number;\n    systemHealth: any;\n    cacheStats: any;\n  }> {\n    const [projects, templates, instances, users] = await Promise.all([\n      this.getAllBotProjects(),\n      this.getAllBotTemplates(),\n      this.getAllBotInstances(),\n      this.getAllUserBotData()\n    ]);\n\n    return {\n      projects: projects.length,\n      templates: templates.length,\n      activeInstances: instances.filter(i => i.status === 'running').length,\n      totalUsers: users.length,\n      systemHealth: dbManager.getConnectionStats(),\n      cacheStats: cachedOps.getStats()\n    };\n  }\n\n  // Database maintenance operations\n  async performMaintenance(): Promise<void> {\n    console.log('Starting database maintenance...');\n    \n    // Optimize connections\n    await dbManager.optimizeConnections();\n    \n    // Clean up old data (older than 30 days)\n    await dbManager.cleanupOldData(30);\n    \n    // Clear expired cache entries\n    cachedOps.cleanup();\n    \n    console.log('Database maintenance completed');\n  }\n\n  // Backup operations\n  async createBackup(): Promise<string> {\n    return await dbManager.createBackup();\n  }\n\n  // Health check\n  async healthCheck(): Promise<boolean> {\n    return await dbManager.performHealthCheck();\n  }\n\n  // Bot groups methods - use parent implementation directly\n  async getBotGroup(id: number): Promise<BotGroup | undefined> {\n    const [group] = await this.db.select().from(botGroups).where(eq(botGroups.id, id));\n    return group || undefined;\n  }\n\n  async getBotGroupsByProject(projectId: number): Promise<BotGroup[]> {\n    return await this.db.select().from(botGroups)\n      .where(eq(botGroups.projectId, projectId))\n      .orderBy(desc(botGroups.createdAt));\n  }\n\n  async getBotGroupByProjectAndGroupId(projectId: number, groupId: string): Promise<BotGroup | undefined> {\n    const [group] = await this.db.select().from(botGroups)\n      .where(and(eq(botGroups.projectId, projectId), eq(botGroups.groupId, groupId)));\n    return group || undefined;\n  }\n\n  async createBotGroup(group: InsertBotGroup): Promise<BotGroup> {\n    const [newGroup] = await this.db\n      .insert(botGroups)\n      .values(group)\n      .returning();\n    return newGroup;\n  }\n\n  async updateBotGroup(id: number, group: Partial<InsertBotGroup>): Promise<BotGroup | undefined> {\n    const [updatedGroup] = await this.db\n      .update(botGroups)\n      .set({ ...group, updatedAt: new Date() })\n      .where(eq(botGroups.id, id))\n      .returning();\n    return updatedGroup || undefined;\n  }\n\n  async deleteBotGroup(id: number): Promise<boolean> {\n    const result = await this.db.delete(botGroups).where(eq(botGroups.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getBotMessagesWithMedia(\n    projectId: number, \n    userId: string, \n    limit: number = 100\n  ): Promise<(BotMessage & { media?: Array<MediaFile & { mediaKind: string; orderIndex: number }> })[]> {\n    const results = await this.db\n      .select({\n        message: botMessages,\n        mediaFile: mediaFiles,\n        mediaKind: botMessageMedia.mediaKind,\n        orderIndex: botMessageMedia.orderIndex,\n      })\n      .from(botMessages)\n      .leftJoin(botMessageMedia, eq(botMessages.id, botMessageMedia.messageId))\n      .leftJoin(mediaFiles, eq(botMessageMedia.mediaFileId, mediaFiles.id))\n      .where(and(\n        eq(botMessages.projectId, projectId),\n        eq(botMessages.userId, userId)\n      ))\n      .orderBy(asc(botMessages.createdAt), asc(botMessageMedia.orderIndex))\n      .limit(limit * 10);\n\n    const messagesMap = new Map<number, BotMessage & { media?: Array<MediaFile & { mediaKind: string; orderIndex: number }> }>();\n\n    for (const row of results) {\n      const messageId = row.message.id;\n      \n      if (!messagesMap.has(messageId)) {\n        messagesMap.set(messageId, {\n          ...row.message,\n          media: []\n        });\n      }\n\n      if (row.mediaFile && row.mediaKind !== null && row.orderIndex !== null) {\n        const message = messagesMap.get(messageId)!;\n        message.media!.push({\n          ...row.mediaFile,\n          mediaKind: row.mediaKind,\n          orderIndex: row.orderIndex\n        });\n      }\n    }\n\n    const messagesArray = Array.from(messagesMap.values())\n      .slice(0, limit)\n      .map(msg => ({\n        ...msg,\n        media: msg.media && msg.media.length > 0 ? msg.media : undefined\n      }));\n\n    return messagesArray;\n  }\n}\n\n// Используем EnhancedDatabaseStorage для продвинутого управления базой данных\nlet storageInstance: EnhancedDatabaseStorage | null = null;\n\nfunction initStorage(): EnhancedDatabaseStorage {\n  if (!storageInstance) {\n    storageInstance = new EnhancedDatabaseStorage();\n  }\n  return storageInstance;\n}\n\n// Export storage instance directly\nexport const storage = new EnhancedDatabaseStorage();\n","size_bytes":75532},"client/src/components/editor/responses-panel.tsx":{"content":"import React, { useState, useMemo } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { apiRequest } from '@/lib/queryClient';\nimport { \n  MessageSquare, \n  Search, \n  Filter, \n  Download, \n  Eye, \n  Calendar,\n  RefreshCw,\n  User,\n  FileText,\n  Clock,\n  Hash,\n  MessageCircle,\n  Settings\n} from 'lucide-react';\n\ninterface ResponsesData {\n  user_id: string;\n  username: string;\n  first_name: string;\n  last_name: string;\n  registered_at: string;\n  last_interaction: string;\n  responses: Array<{\n    key: string;\n    value: string;\n    type: string;\n    timestamp: string;\n    nodeId?: string;\n    prompt?: string;\n    variable?: string;\n  }>;\n  responseCount: number;\n}\n\ninterface ResponsesPanelProps {\n  projectId: number;\n  projectName: string;\n}\n\ntype SortField = 'last_interaction' | 'responseCount' | 'registered_at' | 'first_name';\ntype SortDirection = 'asc' | 'desc';\n\nexport function ResponsesPanel({ projectId, projectName }: ResponsesPanelProps) {\n  const [searchQuery, setSearchQuery] = useState('');\n  const [selectedUser, setSelectedUser] = useState<ResponsesData | null>(null);\n  const [showResponseDetails, setShowResponseDetails] = useState(false);\n  const [sortField, setSortField] = useState<SortField>('last_interaction');\n  const [sortDirection, setSortDirection] = useState<SortDirection>('desc');\n  const [filterResponseType, setFilterResponseType] = useState<string>('all');\n  const [showTechnicalDetails, setShowTechnicalDetails] = useState<boolean>(false);\n\n  // Fetch responses data\n  const { data: responsesData = [], isLoading, refetch } = useQuery<ResponsesData[]>({\n    queryKey: [`/api/projects/${projectId}/responses`],\n    staleTime: 10000, // Кешируем данные на 10 секунд\n    refetchInterval: 30000, // Обновляем каждые 30 секунд вместо 5\n    refetchIntervalInBackground: false, // Не опрашиваем в фоне\n  });\n\n  // Debug logging\n  React.useEffect(() => {\n    console.log('Responses data updated:', responsesData);\n  }, [responsesData]);\n\n  // Filter and sort responses\n  const filteredAndSortedResponses = useMemo(() => {\n    let result = responsesData;\n\n    // Apply search filter\n    if (searchQuery.length > 0) {\n      const query = searchQuery.toLowerCase();\n      result = result.filter(user => \n        (user.first_name?.toLowerCase().includes(query)) ||\n        (user.last_name?.toLowerCase().includes(query)) ||\n        (user.username?.toLowerCase().includes(query)) ||\n        (user.user_id?.includes(query)) ||\n        user.responses.some(response => response.value?.toLowerCase().includes(query))\n      );\n    }\n\n    // Apply response type filter\n    if (filterResponseType !== 'all') {\n      result = result.filter(user => \n        user.responses.some(response => response.type === filterResponseType)\n      );\n    }\n\n    // Sort\n    result = [...result].sort((a, b) => {\n      let aValue: any, bValue: any;\n      \n      switch (sortField) {\n        case 'last_interaction':\n          aValue = new Date(a.last_interaction || 0).getTime();\n          bValue = new Date(b.last_interaction || 0).getTime();\n          break;\n        case 'registered_at':\n          aValue = new Date(a.registered_at || 0).getTime();\n          bValue = new Date(b.registered_at || 0).getTime();\n          break;\n        case 'responseCount':\n          aValue = a.responseCount;\n          bValue = b.responseCount;\n          break;\n        case 'first_name':\n          aValue = (a.first_name || '').toLowerCase();\n          bValue = (b.first_name || '').toLowerCase();\n          break;\n        default:\n          aValue = a[sortField];\n          bValue = b[sortField];\n      }\n\n      if (sortDirection === 'asc') {\n        return aValue > bValue ? 1 : -1;\n      } else {\n        return aValue < bValue ? 1 : -1;\n      }\n    });\n\n    return result;\n  }, [responsesData, searchQuery, filterResponseType, sortField, sortDirection]);\n\n  const formatDate = (date: string | null) => {\n    if (!date) return 'Никогда';\n    return new Date(date).toLocaleString('ru-RU', {\n      timeZone: 'Europe/Moscow',\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  const formatUserName = (user: ResponsesData) => {\n    const parts = [user.first_name, user.last_name].filter(Boolean);\n    if (parts.length > 0) return parts.join(' ');\n    if (user.username) return `@${user.username}`;\n    return `ID: ${user.user_id}`;\n  };\n\n  const getResponseTypeColor = (type: string) => {\n    switch (type) {\n      case 'text': return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';\n      case 'button': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';\n      case 'number': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';\n      case 'email': return 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';\n      case 'phone': return 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';\n      case 'inline_button': return 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200';\n      case 'reply_button': return 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200';\n      case 'button_choice': return 'bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-200';\n      default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';\n    }\n  };\n\n  const formatResponseKey = (key: string, type?: string) => {\n    if (key === 'button_click') return 'Действие';\n    if (key.startsWith('response_')) return key.replace('response_', 'Ответ ');\n    if (type === 'inline_button' || type === 'button') return 'Выбор';\n    if (key === 'источник') return 'Источник информации';\n    if (key === 'желание') return 'Желание продолжить';\n    if (key === 'пол') return 'Пол';\n    if (key === 'имя') return 'Имя';\n    if (key === 'возраст') return 'Возраст';\n    return key;\n  };\n\n  const formatResponseValue = (value: string, type?: string, key?: string) => {\n    // Если это похоже на node ID, заменяем на понятное значение\n    if (typeof value === 'string') {\n      if (value.match(/^--[a-zA-Z0-9_-]{10,}$/) ||\n          value.match(/^[a-zA-Z0-9_-]{15,}$/) ||\n          value.match(/^[a-zA-Z0-9-]{20,}$/)) {\n        return 'Продолжил диалог';\n      }\n      // Улучшаем отображение для специфических значений\n      if ((value === 'Нажатие кнопки' || value === 'Переход к следующему шагу') && key === 'button_click') {\n        return 'Продолжил диалог';\n      }\n    }\n    return value;\n  };\n\n  // Get unique response types for filter\n  const responseTypes = useMemo(() => {\n    const types = new Set<string>();\n    responsesData.forEach(user => {\n      user.responses.forEach(response => {\n        if (response.type) types.add(response.type);\n      });\n    });\n    return Array.from(types);\n  }, [responsesData]);\n\n  const exportResponses = () => {\n    const csvContent = [\n      ['User ID', 'Name', 'Username', 'Response Key', 'Response', 'Type', 'Timestamp', 'Node ID'].join(','),\n      ...filteredAndSortedResponses.flatMap(user =>\n        user.responses.map(response => [\n          user.user_id,\n          `\"${formatUserName(user)}\"`,\n          user.username || '',\n          formatResponseKey(response.key, response.type),\n          `\"${response.value}\"`,\n          response.type,\n          response.timestamp || '',\n          response.nodeId || ''\n        ].join(','))\n      )\n    ].join('\\n');\n\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n    const link = document.createElement('a');\n    link.href = URL.createObjectURL(blob);\n    link.download = `responses_${projectName}_${new Date().toISOString().split('T')[0]}.csv`;\n    link.click();\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"h-full flex items-center justify-center\">\n        <div className=\"text-center\">\n          <RefreshCw className=\"w-8 h-8 animate-spin text-muted-foreground mx-auto mb-2\" />\n          <p className=\"text-muted-foreground\">Загрузка ответов...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full flex flex-col bg-background\">\n      <div className=\"border-b bg-card\">\n        <div className=\"p-4\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <div>\n              <h2 className=\"text-xl font-semibold flex items-center gap-2\">\n                <MessageSquare className=\"w-5 h-5\" />\n                Ответы пользователей\n              </h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Просмотр всех ответов пользователей для бота \"{projectName}\"\n              </p>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Button onClick={() => refetch()} variant=\"outline\" size=\"sm\">\n                <RefreshCw className=\"w-4 h-4 mr-1\" />\n                Обновить\n              </Button>\n              <Button onClick={exportResponses} variant=\"outline\" size=\"sm\">\n                <Download className=\"w-4 h-4 mr-1\" />\n                Экспорт CSV\n              </Button>\n              <Button \n                onClick={() => setShowTechnicalDetails(!showTechnicalDetails)} \n                variant={showTechnicalDetails ? \"default\" : \"outline\"} \n                size=\"sm\"\n              >\n                <Settings className=\"w-4 h-4 mr-1\" />\n                {showTechnicalDetails ? 'Скрыть детали' : 'Показать детали'}\n              </Button>\n            </div>\n          </div>\n\n          {/* Stats */}\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 mb-4\">\n            <Card className=\"p-3\">\n              <div className=\"flex items-center gap-2\">\n                <User className=\"w-4 h-4 text-blue-500\" />\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Пользователей</p>\n                  <p className=\"text-sm font-semibold\">{responsesData.length}</p>\n                </div>\n              </div>\n            </Card>\n            <Card className=\"p-3\">\n              <div className=\"flex items-center gap-2\">\n                <MessageCircle className=\"w-4 h-4 text-green-500\" />\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Всего ответов</p>\n                  <p className=\"text-sm font-semibold\">\n                    {responsesData.reduce((sum, user) => sum + user.responseCount, 0)}\n                  </p>\n                </div>\n              </div>\n            </Card>\n            <Card className=\"p-3\">\n              <div className=\"flex items-center gap-2\">\n                <Hash className=\"w-4 h-4 text-purple-500\" />\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Типов ответов</p>\n                  <p className=\"text-sm font-semibold\">{responseTypes.length}</p>\n                </div>\n              </div>\n            </Card>\n            <Card className=\"p-3\">\n              <div className=\"flex items-center gap-2\">\n                <Clock className=\"w-4 h-4 text-orange-500\" />\n                <div>\n                  <p className=\"text-xs text-muted-foreground\">Сред. ответов</p>\n                  <p className=\"text-sm font-semibold\">\n                    {responsesData.length > 0 \n                      ? Math.round(responsesData.reduce((sum, user) => sum + user.responseCount, 0) / responsesData.length)\n                      : 0}\n                  </p>\n                </div>\n              </div>\n            </Card>\n          </div>\n\n          {/* Search and Filters */}\n          <div className=\"flex flex-col sm:flex-row gap-3\">\n            <div className=\"flex-1 relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Поиск по имени, username, ID или тексту ответа...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <Select value={filterResponseType} onValueChange={setFilterResponseType}>\n                <SelectTrigger className=\"w-40\">\n                  <SelectValue placeholder=\"Тип ответа\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Все типы</SelectItem>\n                  {responseTypes.map(type => (\n                    <SelectItem key={type} value={type}>\n                      {type === 'text' ? 'Текст' : \n                       type === 'button' ? 'Кнопка' :\n                       type === 'number' ? 'Число' :\n                       type === 'email' ? 'Email' :\n                       type === 'phone' ? 'Телефон' :\n                       type === 'inline_button' ? 'Инлайн кнопка' :\n                       type === 'reply_button' ? 'Reply кнопка' :\n                       type === 'button_choice' ? 'Выбор кнопки' :\n                       type}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n\n              <Select value={`${sortField}-${sortDirection}`} onValueChange={(value) => {\n                const [field, direction] = value.split('-') as [SortField, SortDirection];\n                setSortField(field);\n                setSortDirection(direction);\n              }}>\n                <SelectTrigger className=\"w-48\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"last_interaction-desc\">Последняя активность ↓</SelectItem>\n                  <SelectItem value=\"last_interaction-asc\">Последняя активность ↑</SelectItem>\n                  <SelectItem value=\"responseCount-desc\">Больше ответов ↓</SelectItem>\n                  <SelectItem value=\"responseCount-asc\">Меньше ответов ↑</SelectItem>\n                  <SelectItem value=\"registered_at-desc\">Дата регистрации ↓</SelectItem>\n                  <SelectItem value=\"registered_at-asc\">Дата регистрации ↑</SelectItem>\n                  <SelectItem value=\"first_name-asc\">По имени ↑</SelectItem>\n                  <SelectItem value=\"first_name-desc\">По имени ↓</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"flex-1 overflow-hidden\">\n        <ScrollArea className=\"h-full\">\n          <div className=\"p-4\">\n            {filteredAndSortedResponses.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <MessageSquare className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                <h3 className=\"text-lg font-medium text-muted-foreground mb-2\">\n                  {searchQuery ? 'Ответы не найдены' : 'Пока нет ответов'}\n                </h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  {searchQuery \n                    ? 'Попробуйте изменить критерии поиска' \n                    : 'Ответы пользователей появятся здесь, когда они начнут взаимодействовать с ботом'}\n                </p>\n              </div>\n            ) : (\n              <div className=\"grid gap-4\">\n                {filteredAndSortedResponses.map((user) => (\n                  <Card key={user.user_id} className=\"hover:shadow-md transition-shadow\">\n                    <CardHeader className=\"pb-3\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                            <User className=\"w-5 h-5 text-primary\" />\n                          </div>\n                          <div>\n                            <CardTitle className=\"text-base\">{formatUserName(user)}</CardTitle>\n                            <CardDescription className=\"text-sm\">\n                              ID: {user.user_id} • {user.responseCount} ответов\n                            </CardDescription>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            {formatDate(user.last_interaction)}\n                          </Badge>\n                          <Dialog>\n                            <DialogTrigger asChild>\n                              <Button \n                                variant=\"outline\" \n                                size=\"sm\"\n                                onClick={() => setSelectedUser(user)}\n                              >\n                                <Eye className=\"w-3 h-3 mr-1\" />\n                                Детали\n                              </Button>\n                            </DialogTrigger>\n                            <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-auto\">\n                              <DialogHeader>\n                                <DialogTitle>Ответы пользователя {formatUserName(user)}</DialogTitle>\n                                <DialogDescription>\n                                  Подробный просмотр всех ответов пользователя\n                                </DialogDescription>\n                              </DialogHeader>\n                              \n                              <div className=\"space-y-4\">\n                                {user.responses.map((response, index) => (\n                                  <Card key={index} className=\"border-l-4 border-l-primary\">\n                                    <CardHeader className=\"pb-2\">\n                                      <div className=\"flex items-center justify-between\">\n                                        <div className=\"flex items-center gap-2\">\n                                          <span className=\"font-medium\">\n                                            {formatResponseKey(response.key, response.type)}\n                                          </span>\n                                          <Badge \n                                            variant=\"outline\" \n                                            className={`text-xs ${getResponseTypeColor(response.type)}`}\n                                          >\n                                            {response.type === 'text' ? 'Текст' : \n                                             response.type === 'button' ? 'Кнопка' :\n                                             response.type === 'number' ? 'Число' :\n                                             response.type === 'email' ? 'Email' :\n                                             response.type === 'phone' ? 'Телефон' :\n                                             response.type === 'inline_button' ? 'Инлайн кнопка' :\n                                             response.type === 'reply_button' ? 'Reply кнопка' :\n                                             response.type === 'button_choice' ? 'Выбор кнопки' :\n                                             response.type}\n                                          </Badge>\n                                        </div>\n                                        <span className=\"text-xs text-muted-foreground\">\n                                          {formatDate(response.timestamp)}\n                                        </span>\n                                      </div>\n                                    </CardHeader>\n                                    <CardContent>\n                                      <div className=\"bg-muted/50 rounded p-3 mb-2\">\n                                        <p className=\"text-sm font-medium mb-1\">Ответ:</p>\n                                        <p className=\"text-foreground\">{formatResponseValue(response.value, response.type, response.key)}</p>\n                                      </div>\n                                      {response.prompt && (\n                                        <div className=\"text-xs text-muted-foreground\">\n                                          <strong>Вопрос:</strong> {response.prompt}\n                                        </div>\n                                      )}\n                                      {showTechnicalDetails && (\n                                        <div className=\"text-xs text-muted-foreground mt-2 p-2 bg-muted/30 rounded border-l-2 border-primary/50\">\n                                          <div className=\"space-y-1\">\n                                            <div><strong>Ключ переменной:</strong> {response.key}</div>\n                                            <div><strong>Тип ответа:</strong> {response.type}</div>\n                                            {response.nodeId && <div><strong>ID узла:</strong> {response.nodeId}</div>}\n                                            {response.variable && <div><strong>Переменная:</strong> {response.variable}</div>}\n                                            <div><strong>Исходное значение:</strong> {response.value}</div>\n                                          </div>\n                                        </div>\n                                      )}\n                                    </CardContent>\n                                  </Card>\n                                ))}\n                              </div>\n                            </DialogContent>\n                          </Dialog>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"space-y-2\">\n                        {user.responses.slice(0, 2).map((response, index) => (\n                          <div key={index} className=\"flex items-center justify-between p-2 bg-muted/50 rounded\">\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"text-sm font-medium\">\n                                {formatResponseKey(response.key, response.type)}:\n                              </span>\n                              <span className=\"text-sm text-muted-foreground truncate max-w-xs\">\n                                {formatResponseValue(response.value, response.type, response.key)}\n                              </span>\n                            </div>\n                            <Badge \n                              variant=\"outline\" \n                              className={`text-xs ${getResponseTypeColor(response.type)}`}\n                            >\n                              {response.type}\n                            </Badge>\n                          </div>\n                        ))}\n                        {user.responses.length > 2 && (\n                          <div className=\"text-xs text-muted-foreground text-center pt-1\">\n                            И еще {user.responses.length - 2} ответов...\n                          </div>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </div>\n        </ScrollArea>\n      </div>\n    </div>\n  );\n}","size_bytes":24816},"client/src/components/editor/groups-panel.tsx":{"content":"import React, { useState, useEffect, useCallback } from 'react';\nimport { Users, Plus, UserPlus, X, Settings, Upload, Shield, UserCheck, MessageSquare, Globe, Clock, Tag, Search, Filter, Send, BarChart3, TrendingUp, Edit, Pin, PinOff, Trash, Crown, Bot, Ban, Volume2, VolumeX, UserMinus, MoreHorizontal } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Switch } from '@/components/ui/switch';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Badge } from '@/components/ui/badge';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Separator } from '@/components/ui/separator';\nimport { DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator, DropdownMenuSub, DropdownMenuSubTrigger, DropdownMenuSubContent } from '@/components/ui/dropdown-menu';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { TelegramAuth } from '@/components/telegram-auth';\nimport type { BotGroup, InsertBotGroup } from '@shared/schema';\n\ninterface GroupsPanelProps {\n  projectId: number;\n  projectName: string;\n}\n\n// Using BotGroup type from schema instead of local interface\n\n// Компонент аватарки группы с fallback\nfunction GroupAvatar({ \n  avatarUrl, \n  groupName, \n  size = 40, \n  className = \"\" \n}: { \n  avatarUrl?: string | null; \n  groupName: string; \n  size?: number; \n  className?: string; \n}) {\n  const [imageError, setImageError] = useState(false);\n  \n  // Получаем первые буквы названия группы для fallback\n  const initials = groupName\n    .split(' ')\n    .map(word => word.charAt(0))\n    .join('')\n    .toUpperCase()\n    .slice(0, 2);\n  \n  const handleImageError = () => {\n    setImageError(true);\n  };\n  \n  // Если есть аватарка и она не содержит <TOKEN>, показываем её\n  const showImage = avatarUrl && !imageError && !avatarUrl.includes('<TOKEN>');\n  \n  if (showImage) {\n    return (\n      <div \n        className={`relative rounded-lg overflow-hidden flex-shrink-0 ${className}`}\n        style={{ width: size, height: size }}\n      >\n        <img \n          src={avatarUrl}\n          alt={`${groupName} avatar`}\n          className=\"w-full h-full object-cover\"\n          onError={handleImageError}\n        />\n      </div>\n    );\n  }\n  \n  // Fallback: показываем инициалы или иконку\n  return (\n    <div \n      className={`bg-gradient-to-br from-blue-500 to-purple-600 dark:from-blue-600 dark:to-purple-700 rounded-lg flex items-center justify-center flex-shrink-0 ${className}`}\n      style={{ width: size, height: size }}\n    >\n      {initials ? (\n        <span \n          className=\"text-white font-semibold\"\n          style={{ fontSize: size * 0.4 }}\n        >\n          {initials}\n        </span>\n      ) : (\n        <Users \n          className=\"text-white\" \n          size={size * 0.5} \n        />\n      )}\n    </div>\n  );\n}\n\nexport function GroupsPanel({ projectId, projectName }: GroupsPanelProps) {\n  const [showAddGroup, setShowAddGroup] = useState(false);\n  const [showGroupSettings, setShowGroupSettings] = useState(false);\n  const [selectedGroup, setSelectedGroup] = useState<BotGroup | null>(null);\n  const [groupUrl, setGroupUrl] = useState('');\n  const [groupName, setGroupName] = useState('');\n  const [groupId, setGroupId] = useState('');\n  const [isParsingGroup, setIsParsingGroup] = useState(false);\n  const [groupDescription, setGroupDescription] = useState('');\n  const [groupAvatarUrl, setGroupAvatarUrl] = useState('');\n  const [groupLanguage, setGroupLanguage] = useState('ru');\n  const [groupTimezone, setGroupTimezone] = useState('');\n  const [groupTags, setGroupTags] = useState<string[]>([]);\n  const [groupNotes, setGroupNotes] = useState('');\n  const [makeAdmin, setMakeAdmin] = useState(false);\n  const [isPublicGroup, setIsPublicGroup] = useState(false);\n  const [publicUsername, setPublicUsername] = useState('');\n  const [adminRights, setAdminRights] = useState({\n    can_manage_chat: false,\n    can_change_info: false,\n    can_delete_messages: false,\n    can_invite_users: false,\n    can_restrict_members: false,\n    can_pin_messages: false,\n    can_promote_members: false,\n    can_manage_video_chats: false,\n    can_be_anonymous: false,\n    can_manage_stories: false\n  });\n  const [searchQuery, setSearchQuery] = useState('');\n  const [filterType, setFilterType] = useState<'all' | 'admin' | 'member'>('all');\n  const [showSendMessage, setShowSendMessage] = useState(false);\n  const [messageToSend, setMessageToSend] = useState('');\n  const [selectedGroupForMessage, setSelectedGroupForMessage] = useState<BotGroup | null>(null);\n  \n  // Состояние для поиска пользователя\n  const [showUserSearch, setShowUserSearch] = useState(false);\n  const [userSearchQuery, setUserSearchQuery] = useState('');\n  const [selectedGroupForPromotion, setSelectedGroupForPromotion] = useState<BotGroup | null>(null);\n  const [userToFind, setUserToFind] = useState(''); // Для универсального поиска участников\n  const [showAdminSearch, setShowAdminSearch] = useState(false); // Для поиска с назначением админом\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Load groups from database\n  const { data: groups = [], isLoading, error, refetch } = useQuery({\n    queryKey: ['/api/projects', projectId, 'groups'],\n    queryFn: () => fetch(`/api/projects/${projectId}/groups`).then(res => res.json()) as Promise<BotGroup[]>\n  });\n\n  // Ensure groups is always an array\n  const safeGroups = Array.isArray(groups) ? groups : [];\n  \n  // Auto-update existing groups with missing info\n  useEffect(() => {\n    if (safeGroups.length > 0) {\n      safeGroups.forEach(group => {\n        // Обновляем группы где название = ID (значит не спарсилось)\n        if (group.name === group.groupId && group.groupId) {\n          console.log('Auto-updating group info for:', group.groupId);\n          // Задержка для избежания слишком частых запросов\n          setTimeout(() => {\n            parseGroupInfoMutation.mutate(group.groupId!);\n          }, Math.random() * 2000 + 1000); // Случайная задержка 1-3 секунды\n        }\n      });\n    }\n  }, [safeGroups.length]); // Запускаем при изменении количества групп\n\n  // Create group mutation\n  const createGroupMutation = useMutation({\n    mutationFn: async (groupData: Omit<InsertBotGroup, 'projectId'>) => {\n      return apiRequest('POST', `/api/projects/${projectId}/groups`, groupData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects', projectId, 'groups'] });\n      toast({ title: 'Группа успешно добавлена' });\n    },\n    onError: () => {\n      toast({ title: 'Ошибка при добавлении группы', variant: 'destructive' });\n    }\n  });\n\n  // Delete group mutation\n  const deleteGroupMutation = useMutation({\n    mutationFn: async (groupId: number) => {\n      return apiRequest('DELETE', `/api/projects/${projectId}/groups/${groupId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects', projectId, 'groups'] });\n      toast({ title: 'Группа удалена' });\n    },\n    onError: () => {\n      toast({ title: 'Ошибка при удалении группы', variant: 'destructive' });\n    }\n  });\n\n  // Update group mutation\n  const updateGroupMutation = useMutation({\n    mutationFn: async ({ groupId, data, showSuccessMessage = true }: { groupId: number, data: Partial<InsertBotGroup>, showSuccessMessage?: boolean }) => {\n      return apiRequest('PUT', `/api/projects/${projectId}/groups/${groupId}`, data);\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects', projectId, 'groups'] });\n      if (variables.showSuccessMessage) {\n        toast({ title: 'Настройки группы обновлены' });\n      }\n      setShowGroupSettings(false);\n      setSelectedGroup(null);\n    },\n    onError: () => {\n      toast({ title: 'Ошибка при обновлении настроек', variant: 'destructive' });\n    }\n  });\n\n  // Send message to group mutation\n  const sendMessageMutation = useMutation({\n    mutationFn: async ({ groupId, message }: { groupId: string | null; message: string }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/send-group-message`, {\n        groupId,\n        message\n      });\n    },\n    onSuccess: () => {\n      toast({ title: 'Сообщение отправлено в группу' });\n      setShowSendMessage(false);\n      setMessageToSend('');\n      setSelectedGroupForMessage(null);\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при отправке сообщения', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Get group info mutation\n  const getGroupInfoMutation = useMutation({\n    mutationFn: async (groupId: string | null) => {\n      // Get both group info and member count\n      const [groupInfo, memberCount] = await Promise.all([\n        apiRequest('GET', `/api/projects/${projectId}/bot/group-info/${groupId}`),\n        apiRequest('GET', `/api/projects/${projectId}/bot/group-members-count/${groupId}`)\n      ]);\n      return { ...groupInfo, memberCount: memberCount.count };\n    },\n    onSuccess: (data) => {\n      // Обновляем информацию о группе в базе данных\n      const groupToUpdate = safeGroups.find(g => g.groupId === data.id?.toString());\n      if (groupToUpdate) {\n        updateGroupMutation.mutate({\n          groupId: groupToUpdate.id,\n          data: { \n            memberCount: data.memberCount,\n            chatType: data.type,\n            name: data.title || groupToUpdate.name\n          }\n        });\n      }\n      toast({ \n        title: `Информация о группе получена`, \n        description: `Название: ${data.title}, Участников: ${data.memberCount}, Тип: ${data.type === 'supergroup' ? 'Супергруппа' : data.type === 'group' ? 'Группа' : 'Канал'}`\n      });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при получении информации', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Auto-parse group info mutation\n  const parseGroupInfoMutation = useMutation({\n    mutationFn: async (groupIdentifier: string) => {\n      setIsParsingGroup(true);\n      try {\n        // Get group info, admin status, and member count\n        const [groupInfo, adminStatus, memberCountData] = await Promise.all([\n          apiRequest('GET', `/api/projects/${projectId}/bot/group-info/${groupIdentifier}`),\n          apiRequest('GET', `/api/projects/${projectId}/bot/admin-status/${groupIdentifier}`),\n          apiRequest('GET', `/api/projects/${projectId}/bot/group-members-count/${groupIdentifier}`).catch(() => ({ count: null }))\n        ]);\n        return { \n          ...groupInfo, \n          isAdmin: adminStatus.isAdmin,\n          memberCount: memberCountData?.count || null\n        };\n      } finally {\n        setIsParsingGroup(false);\n      }\n    },\n    onSuccess: (data) => {\n      // Отладочная информация - что пришло от Telegram API\n      console.log('TELEGRAM API RESPONSE:', JSON.stringify(data, null, 2));\n      console.log('Available fields:', Object.keys(data));\n      console.log('Description field:', data.description);\n      console.log('Bio field:', data.bio);\n      console.log('About field:', data.about);\n      \n      // Автоматически заполняем название группы\n      if (data.title && !groupName) {\n        setGroupName(data.title);\n      }\n      \n      // Генерируем ссылку автоматически и определяем публичность\n      let generatedUrl = '';\n      let isGroupPublic = false;\n      \n      if (data.username) {\n        // Группа публичная, есть username\n        generatedUrl = `https://t.me/${data.username}`;\n        isGroupPublic = true;\n        setGroupUrl(generatedUrl);\n        setIsPublicGroup(true);\n        setPublicUsername(`@${data.username}`);\n      } else if (data.invite_link) {\n        // Группа приватная, есть только invite link\n        generatedUrl = data.invite_link;\n        isGroupPublic = false;\n        setGroupUrl(generatedUrl);\n        setIsPublicGroup(false);\n        setPublicUsername('');\n      } else {\n        // Для числовых ID не создаем публичную ссылку\n        setGroupUrl('');\n        setIsPublicGroup(false);\n        setPublicUsername('');\n      }\n      \n      // Устанавливаем статус администратора\n      setMakeAdmin(data.isAdmin || false);\n      \n      // Обновляем уже существующую группу в базе данных\n      const existingGroup = safeGroups.find(g => g.groupId === data.id?.toString());\n      if (existingGroup && data.title) {\n        // Подготавливаем данные для обновления\n        const updateData: any = {\n          name: data.title,\n          url: generatedUrl,\n          isAdmin: data.isAdmin ? 1 : 0,\n          isPublic: isGroupPublic ? 1 : 0,\n          chatType: data.type || 'group'\n        };\n        \n        // Добавляем описание если есть\n        if (data.description) {\n          updateData.description = data.description;\n        }\n        \n        // Добавляем аватарку если есть\n        if (data.avatarUrl) {\n          updateData.avatarUrl = data.avatarUrl;\n        }\n        \n        // Добавляем количество участников если есть\n        if (data.memberCount !== null && data.memberCount !== undefined) {\n          updateData.memberCount = data.memberCount;\n        }\n        \n        updateGroupMutation.mutate({\n          groupId: existingGroup.id,\n          data: updateData\n        });\n      }\n      \n      // Создаем информативное уведомление\n      const infoLines = [\n        `${data.title || data.id}`,\n        `${data.username ? '@' + data.username : 'ID: ' + data.id}`,\n        `${data.isAdmin ? 'Админ' : 'Участник'}`,\n      ];\n      \n      if (data.memberCount) {\n        infoLines.push(`${data.memberCount} участников`);\n      }\n      \n      if (data.description && data.description.length > 0) {\n        const shortDescription = data.description.length > 50 \n          ? data.description.substring(0, 50) + '...' \n          : data.description;\n        infoLines.push(`Описание: ${shortDescription}`);\n      }\n      \n      toast({ \n        title: 'Информация о группе обновлена', \n        description: infoLines.join(' • ')\n      });\n    },\n    onError: (error: any) => {\n      setIsParsingGroup(false);\n      // Не показываем ошибку, так как это автоматический парсинг\n    }\n  });\n\n  // Auto-parse when groupId changes\n  useEffect(() => {\n    const timeoutId = setTimeout(() => {\n      const identifier = groupId.trim();\n      if (identifier && (identifier.startsWith('-') || identifier.startsWith('@') || identifier.includes('t.me'))) {\n        let groupIdentifier = identifier;\n        \n        // Извлекаем ID из разных форматов ссылок\n        if (identifier.includes('t.me/')) {\n          const match = identifier.match(/t.me\\/([^?\\/]+)/);\n          if (match) {\n            groupIdentifier = match[1].startsWith('+') ? match[1] : '@' + match[1];\n          }\n        }\n        \n        parseGroupInfoMutation.mutate(groupIdentifier);\n      }\n    }, 1500); // Задержка 1.5 секунды после ввода\n\n    return () => clearTimeout(timeoutId);\n  }, [groupId, projectId]);\n\n  // Get group members count mutation\n  const getMembersCountMutation = useMutation({\n    mutationFn: async (groupId: string | null) => {\n      return apiRequest('GET', `/api/projects/${projectId}/bot/group-members-count/${groupId}`);\n    },\n    onSuccess: (data) => {\n      // Обновляем количество участников в базе данных\n      const groupToUpdate = safeGroups.find(g => g.groupId === data.groupId);\n      if (groupToUpdate) {\n        updateGroupMutation.mutate({\n          groupId: groupToUpdate.id,\n          data: { memberCount: data.count }\n        });\n      }\n      toast({ title: `Участников в группе: ${data.count}` });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при получении количества участников', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Get admin status mutation\n  const getAdminStatusMutation = useMutation({\n    mutationFn: async (groupId: string | null) => {\n      return apiRequest('GET', `/api/projects/${projectId}/bot/admin-status/${groupId}`);\n    },\n    onSuccess: (data) => {\n      toast({ \n        title: `Статус бота в группе: ${data.isAdmin ? 'Администратор' : 'Участник'}`, \n        description: `Права: ${data.status}`\n      });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при проверке статуса', \n        description: error.error || 'Бот не найден в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Get group administrators mutation\n  const [administrators, setAdministrators] = React.useState<any[]>([]);\n  const [isLoadingMembers, setIsLoadingMembers] = useState(false);\n  const [clientApiMembers, setClientApiMembers] = React.useState<any[]>([]);\n  const [showTelegramAuth, setShowTelegramAuth] = useState(false);\n  const [selectedMember, setSelectedMember] = useState<any>(null);\n  const [showPermissionsDialog, setShowPermissionsDialog] = useState(false);\n  const [memberPermissions, setMemberPermissions] = useState({\n    // Основные разрешения участника\n    can_send_messages: true,\n    can_send_media_messages: true,\n    can_send_polls: true,\n    can_send_other_messages: true,\n    can_add_web_page_previews: true,\n    \n    // Административные разрешения\n    can_change_info: false,\n    can_delete_messages: false,\n    can_restrict_members: false,\n    can_invite_users: false,\n    can_pin_messages: false,\n    can_manage_video_chats: false,\n    can_be_anonymous: false,\n    can_promote_members: false\n  });\n  \n  const getAdminsMutation = useMutation({\n    mutationFn: async (groupId: string | null) => {\n      return apiRequest('GET', `/api/projects/${projectId}/bot/group-admins/${groupId}`);\n    },\n    onSuccess: (data) => {\n      setAdministrators(data.administrators || []);\n      toast({ title: `Получено администраторов: ${data.administrators?.length || 0}` });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при получении администраторов', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Get all group members mutation\n  const getAllMembersMutation = useMutation({\n    mutationFn: async (groupId: string | null) => {\n      return apiRequest('GET', `/api/projects/${projectId}/bot/group-members/${groupId}`);\n    },\n    onSuccess: (data) => {\n      setClientApiMembers(data.members || []);\n      toast({ \n        title: data.isPartialList ? `Показаны администраторы: ${data.totalCount || 0}` : `Все участники: ${data.totalCount || 0}`,\n        description: data.message || data.explanation || (data.isPartialList ? \"Telegram API не предоставляет полный список\" : \"Полный список участников\")\n      });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при получении участников', \n        description: error.error || 'Список участников доступен только для небольших групп',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Get saved members from database\n  const [savedMembers, setSavedMembers] = React.useState<any[]>([]);\n  \n  const getSavedMembersMutation = useMutation({\n    mutationFn: async (groupId: string | null) => {\n      return apiRequest('GET', `/api/projects/${projectId}/groups/${groupId}/saved-members`);\n    },\n    onSuccess: (data) => {\n      setSavedMembers(data.members || []);\n      console.log(`✅ Загружено ${data.members?.length || 0} сохраненных участников из базы данных`);\n    },\n    onError: (error: any) => {\n      console.error('Ошибка загрузки сохраненных участников:', error);\n      // Не показываем toast для этой ошибки, так как это фоновая операция\n    }\n  });\n\n  // Автоматически загружаем сохраненных участников когда выбрана группа\n  useEffect(() => {\n    if (selectedGroup?.groupId) {\n      getSavedMembersMutation.mutate(selectedGroup.groupId);\n    }\n  }, [selectedGroup?.groupId]);\n\n  // Mute member mutation\n  const muteMemberMutation = useMutation({\n    mutationFn: async ({ groupId, userId, untilDate }: { groupId: string | null; userId: string; untilDate?: number }) => {\n      try {\n        // Сначала пробуем Bot API\n        return await apiRequest('POST', `/api/projects/${projectId}/bot/restrict-member`, {\n          groupId,\n          userId,\n          permissions: {\n            can_send_messages: false,\n            can_send_media_messages: false,\n            can_send_polls: false,\n            can_send_other_messages: false,\n            can_add_web_page_previews: false\n          },\n          untilDate\n        });\n      } catch (botApiError: any) {\n        console.log('Bot API failed, trying Client API:', botApiError);\n        // Если Bot API не работает, пробуем Client API\n        return await apiRequest('POST', `/api/projects/${projectId}/telegram-client/restrict-member`, {\n          groupId,\n          userId,\n          untilDate: untilDate || Math.floor(Date.now() / 1000) + 3600\n        });\n      }\n    },\n    onSuccess: (data: any) => {\n      toast({ \n        title: 'Пользователь замучен',\n        description: data.message || 'Операция выполнена успешно'\n      });\n      setUserIdToBan('');\n      // Обновляем список участников\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/telegram-client/group-members/${selectedGroup?.groupId}`] });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/group-admins/${selectedGroup?.groupId}`] });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при муте', \n        description: error.error || 'Не удалось замутить участника',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Kick member mutation - пробуем сначала Bot API, потом Client API\n  const kickMemberMutation = useMutation({\n    mutationFn: async ({ groupId, userId }: { groupId: string | null; userId: string }) => {\n      try {\n        // Сначала пробуем Bot API\n        return await apiRequest('POST', `/api/projects/${projectId}/bot/kick-member`, {\n          groupId,\n          userId\n        });\n      } catch (botApiError: any) {\n        console.log('Bot API failed, trying Client API:', botApiError);\n        // Если Bot API не работает, пробуем Client API\n        return await apiRequest('POST', `/api/projects/${projectId}/telegram-client/kick-member`, {\n          groupId,\n          userId\n        });\n      }\n    },\n    onSuccess: (data: any) => {\n      toast({ \n        title: 'Пользователь исключен из группы',\n        description: data.message || 'Операция выполнена успешно'\n      });\n      // Обновляем список участников\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/telegram-client/group-members/${selectedGroup?.groupId}`] });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/group-admins/${selectedGroup?.groupId}`] });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при исключении', \n        description: error.error || 'Не удалось исключить участника',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Load member permissions when dialog opens\n  const loadMemberPermissionsMutation = useMutation({\n    mutationFn: async ({ groupId, userId }: { groupId: string; userId: string }) => {\n      console.log('🔍 Loading member permissions for:', { groupId, userId });\n      return await apiRequest('GET', `/api/projects/${projectId}/bot/check-member/${groupId}/${userId}`);\n    },\n    onSuccess: (data: any) => {\n      console.log('✅ loadMemberPermissionsMutation success:', data);\n      const member = data?.member;\n      if (member) {\n        // Устанавливаем текущие разрешения участника\n        setMemberPermissions({\n          // Основные разрешения участника (по умолчанию true для обычных участников)\n          can_send_messages: true,\n          can_send_media_messages: true,\n          can_send_polls: true,\n          can_send_other_messages: true,\n          can_add_web_page_previews: true,\n          \n          // Административные разрешения (берем из текущих прав)\n          can_change_info: member.can_change_info || false,\n          can_delete_messages: member.can_delete_messages || false,\n          can_restrict_members: member.can_restrict_members || false,\n          can_invite_users: member.can_invite_users || false,\n          can_pin_messages: member.can_pin_messages || false,\n          can_manage_video_chats: member.can_manage_video_chats || false,\n          can_be_anonymous: member.is_anonymous || member.can_be_anonymous || false,\n          can_promote_members: member.can_promote_members || false\n        });\n        \n        console.log('Loaded member permissions from API:', {\n          member,\n          mappedPermissions: {\n            can_change_info: member.can_change_info,\n            can_delete_messages: member.can_delete_messages,\n            can_restrict_members: member.can_restrict_members,\n            can_invite_users: member.can_invite_users,\n            can_pin_messages: member.can_pin_messages,\n            can_manage_video_chats: member.can_manage_video_chats,\n            can_be_anonymous: member.is_anonymous || member.can_be_anonymous,\n            can_promote_members: member.can_promote_members\n          }\n        });\n      }\n    },\n    onError: (error: any) => {\n      console.log('Failed to load member permissions:', error);\n      // Оставляем разрешения по умолчанию\n    }\n  });\n\n  // Update member permissions mutation\n  const updatePermissionsMutation = useMutation({\n    mutationFn: async ({ groupId, userId, permissions }: { groupId: string | null; userId: string; permissions: any }) => {\n      // Проверяем, есть ли административные права\n      const hasAdminRights = permissions.can_delete_messages || permissions.can_restrict_members || \n                            permissions.can_promote_members || permissions.can_manage_video_chats ||\n                            permissions.can_be_anonymous || permissions.can_change_info || \n                            permissions.can_pin_messages || permissions.can_invite_users;\n      \n      console.log('💾 Сохраняем разрешения:', {\n        selectedMember: selectedMember,\n        userId: userId,\n        groupId: groupId,\n        currentPermissions: memberPermissions,\n        newPermissions: permissions,\n        hasAdminRights: hasAdminRights\n      });\n      \n      if (hasAdminRights) {\n        // Если есть административные права, используем promote-member\n        try {\n          return await apiRequest('POST', `/api/projects/${projectId}/bot/promote-member`, {\n            groupId,\n            userId,\n            can_change_info: permissions.can_change_info,\n            can_delete_messages: permissions.can_delete_messages,\n            can_invite_users: permissions.can_invite_users,\n            can_restrict_members: permissions.can_restrict_members,\n            can_pin_messages: permissions.can_pin_messages,\n            can_promote_members: permissions.can_promote_members,\n            can_manage_video_chats: permissions.can_manage_video_chats,\n            can_be_anonymous: permissions.can_be_anonymous,\n            can_manage_topics: false\n          });\n        } catch (botApiError: any) {\n          console.log('Bot API failed for promotion, trying Client API:', botApiError);\n          // Если Bot API не работает, пробуем Client API\n          return await apiRequest('POST', `/api/projects/${projectId}/telegram-client/promote-member`, {\n            groupId,\n            userId,\n            adminRights: {\n              can_change_info: permissions.can_change_info,\n              can_delete_messages: permissions.can_delete_messages,\n              can_invite_users: permissions.can_invite_users,\n              can_restrict_members: permissions.can_restrict_members,\n              can_pin_messages: permissions.can_pin_messages,\n              can_promote_members: permissions.can_promote_members,\n              can_manage_video_chats: permissions.can_manage_video_chats,\n              can_be_anonymous: permissions.can_be_anonymous,\n              can_manage_topics: false\n            }\n          });\n        }\n      } else if (selectedMember?.status === 'administrator' || selectedMember?.friendlyStatus === 'Администратор') {\n        // Если пользователь является администратором, но у него нет административных прав, демотируем его\n        try {\n          return await apiRequest('POST', `/api/projects/${projectId}/bot/demote-member`, {\n            groupId,\n            userId\n          });\n        } catch (botApiError: any) {\n          console.log('Bot API failed for demotion, trying Client API:', botApiError);\n          // Если Bot API не работает, пробуем Client API\n          return await apiRequest('POST', `/api/projects/${projectId}/telegram-client/demote-member`, {\n            groupId,\n            userId\n          });\n        }\n      } else {\n        // Если только обычные права, используем restrict-member\n        try {\n          return await apiRequest('POST', `/api/projects/${projectId}/bot/restrict-member`, {\n            groupId,\n            userId,\n            permissions: {\n              can_send_messages: permissions.can_send_messages,\n              can_send_media_messages: permissions.can_send_media_messages,\n              can_send_polls: permissions.can_send_polls,\n              can_send_other_messages: permissions.can_send_other_messages,\n              can_add_web_page_previews: permissions.can_add_web_page_previews\n            }\n          });\n        } catch (botApiError: any) {\n          console.log('Bot API failed, trying Client API:', botApiError);\n          // Если Bot API не работает, пробуем Client API\n          return await apiRequest('POST', `/api/projects/${projectId}/telegram-client/restrict-member`, {\n            groupId,\n            userId,\n            untilDate: Math.floor(Date.now() / 1000) + 3600 // 1 час по умолчанию\n          });\n        }\n      }\n    },\n    onSuccess: () => {\n      toast({ title: 'Разрешения участника обновлены' });\n      setShowPermissionsDialog(false);\n      refetch();\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при обновлении разрешений', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Отслеживаем смену группы для сброса данных\n  const [lastSelectedGroupId, setLastSelectedGroupId] = React.useState<string | null>(null);\n  \n  React.useEffect(() => {\n    if (selectedGroup) {\n      // Если сменилась группа, сбрасываем все данные\n      if (lastSelectedGroupId !== selectedGroup.groupId) {\n        setAdministrators([]);\n        setClientApiMembers([]);\n        setLastSelectedGroupId(selectedGroup.groupId);\n      }\n    }\n  }, [selectedGroup]);\n\n  // Автоматически загружаем администраторов при выборе группы\n  React.useEffect(() => {\n    if (selectedGroup && showGroupSettings) {\n      // Загружаем данные только если список пуст\n      if (administrators.length === 0) {\n        getAdminsMutation.mutate(selectedGroup.groupId);\n      }\n    }\n  }, [selectedGroup, showGroupSettings]);\n\n  // Ban member mutation\n  const [userIdToBan, setUserIdToBan] = React.useState('');\n  const [userIdToUnban, setUserIdToUnban] = React.useState('');\n  const banMemberMutation = useMutation({\n    mutationFn: async ({ groupId, userId, untilDate }: { groupId: string | null; userId: string; untilDate?: number }) => {\n      try {\n        // Сначала пробуем Bot API\n        return await apiRequest('POST', `/api/projects/${projectId}/bot/ban-member`, {\n          groupId,\n          userId,\n          untilDate\n        });\n      } catch (botApiError: any) {\n        console.log('Bot API failed, trying Client API:', botApiError);\n        // Если Bot API не работает, пробуем Client API\n        return await apiRequest('POST', `/api/projects/${projectId}/telegram-client/ban-member`, {\n          groupId,\n          userId,\n          untilDate\n        });\n      }\n    },\n    onSuccess: (data: any) => {\n      toast({ \n        title: 'Пользователь заблокирован',\n        description: data.message || 'Операция выполнена успешно'\n      });\n      setUserIdToBan('');\n      // Обновляем список участников\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/telegram-client/group-members/${selectedGroup?.groupId}`] });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/group-admins/${selectedGroup?.groupId}`] });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при блокировке', \n        description: error.error || 'Не удалось заблокировать участника',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Unban member mutation\n  const unbanMemberMutation = useMutation({\n    mutationFn: async ({ groupId, userId }: { groupId: string | null; userId: string }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/unban-member`, {\n        groupId,\n        userId\n      });\n    },\n    onSuccess: () => {\n      toast({ title: 'Пользователь разблокирован' });\n      setUserIdToUnban('');\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при разблокировке', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Group settings mutations\n  const [newGroupTitle, setNewGroupTitle] = React.useState('');\n  const [newGroupDescription, setNewGroupDescription] = React.useState('');\n  const [messageIdToPin, setMessageIdToPin] = React.useState('');\n  const [messageIdToUnpin, setMessageIdToUnpin] = React.useState('');\n  const [messageIdToDelete, setMessageIdToDelete] = React.useState('');\n  const [inviteLinkName, setInviteLinkName] = React.useState('');\n  const [inviteLinkLimit, setInviteLinkLimit] = React.useState('');\n\n  const setGroupTitleMutation = useMutation({\n    mutationFn: async ({ groupId, title }: { groupId: string | null; title: string }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/set-group-title`, {\n        groupId,\n        title\n      });\n    },\n    onSuccess: () => {\n      toast({ title: 'Название группы изменено' });\n      setNewGroupTitle('');\n      // Refresh group data\n      refetch();\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при изменении названия', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  const setGroupDescriptionMutation = useMutation({\n    mutationFn: async ({ groupId, description }: { groupId: string | null; description: string }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/set-group-description`, {\n        groupId,\n        description\n      });\n    },\n    onSuccess: () => {\n      toast({ title: 'Описание группы изменено' });\n      setNewGroupDescription('');\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при изменении описания', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  const setGroupUsernameMutation = useMutation({\n    mutationFn: async ({ groupId, username }: { groupId: string | null; username: string }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/set-group-username`, {\n        groupId,\n        username\n      });\n    }\n  });\n\n  const setGroupPhotoMutation = useMutation({\n    mutationFn: async ({ groupId, photoPath }: { groupId: string | null; photoPath: string }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/set-group-photo`, {\n        groupId,\n        photoPath\n      });\n    },\n    onSuccess: () => {\n      toast({ title: 'Аватарка группы обновлена' });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при обновлении аватарки', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  const updateBotAdminRightsMutation = useMutation({\n    mutationFn: async ({ groupId, adminRights }: { groupId: string | null; adminRights: any }) => {\n      // Сначала пробуем Bot API, но он не сработает для изменения собственных прав\n      try {\n        return await apiRequest('POST', `/api/projects/${projectId}/bot/update-admin-rights`, {\n          groupId,\n          adminRights\n        });\n      } catch (botApiError: any) {\n        console.log('Bot API не может изменить собственные права, используем Client API:', botApiError);\n        // Используем Client API который работает от имени пользователя\n        return await apiRequest('POST', `/api/projects/${projectId}/telegram-client/update-bot-admin-rights`, {\n          groupId,\n          adminRights\n        });\n      }\n    },\n    onSuccess: () => {\n      toast({ title: 'Права администратора обновлены в Telegram' });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при обновлении прав в Telegram', \n        description: error.error || 'Для изменения прав бота нужны права владельца группы или администратора с правом назначения администраторов',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  const pinMessageMutation = useMutation({\n    mutationFn: async ({ groupId, messageId }: { groupId: string | null; messageId: string }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/pin-message`, {\n        groupId,\n        messageId,\n        disableNotification: false\n      });\n    },\n    onSuccess: () => {\n      toast({ title: 'Сообщение закреплено' });\n      setMessageIdToPin('');\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при закреплении сообщения', \n        description: error.error || 'Проверьте права бота и ID сообщения',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  const unpinMessageMutation = useMutation({\n    mutationFn: async ({ groupId, messageId }: { groupId: string | null; messageId?: string }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/unpin-message`, {\n        groupId,\n        messageId\n      });\n    },\n    onSuccess: (_, variables) => {\n      toast({ title: variables.messageId ? 'Сообщение откреплено' : 'Все сообщения откреплены' });\n      setMessageIdToUnpin('');\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при откреплении сообщения', \n        description: error.error || 'Проверьте права бота',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  const deleteMessageMutation = useMutation({\n    mutationFn: async ({ groupId, messageId }: { groupId: string | null; messageId: string }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/delete-message`, {\n        groupId,\n        messageId\n      });\n    },\n    onSuccess: () => {\n      toast({ title: 'Сообщение удалено' });\n      setMessageIdToDelete('');\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при удалении сообщения', \n        description: error.error || 'Проверьте права бота и ID сообщения',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  const createInviteLinkMutation = useMutation({\n    mutationFn: async ({ groupId, name, memberLimit, createsJoinRequest }: { \n      groupId: string | null; \n      name?: string; \n      memberLimit?: number; \n      createsJoinRequest: boolean \n    }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/create-invite-link`, {\n        groupId,\n        name,\n        memberLimit,\n        createsJoinRequest\n      });\n    },\n    onSuccess: (data) => {\n      toast({ \n        title: 'Ссылка-приглашение создана',\n        description: `Новая ссылка: ${data.inviteLink.invite_link}`\n      });\n      setInviteLinkName('');\n      setInviteLinkLimit('');\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при создании ссылки', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Restrict member mutation (mute)\n  const [userIdToMute, setUserIdToMute] = React.useState('');\n  const [muteMinutes, setMuteMinutes] = React.useState('');\n  \n  const restrictMemberMutation = useMutation({\n    mutationFn: async ({ groupId, userId, untilDate }: { groupId: string | null; userId: string; untilDate?: number }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/restrict-member`, {\n        groupId,\n        userId,\n        permissions: {\n          can_send_messages: false,\n          can_send_audios: false,\n          can_send_documents: false,\n          can_send_photos: false,\n          can_send_videos: false,\n          can_send_video_notes: false,\n          can_send_voice_notes: false,\n          can_send_polls: false,\n          can_send_other_messages: false,\n          can_add_web_page_previews: false,\n          can_change_info: false,\n          can_invite_users: false,\n          can_pin_messages: false,\n          can_manage_topics: false\n        },\n        untilDate\n      });\n    },\n    onSuccess: () => {\n      toast({ title: 'Пользователь заглушен' });\n      setUserIdToMute('');\n      setMuteMinutes('');\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при заглушении пользователя', \n        description: error.error || 'Проверьте права бота в группе',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Promote member mutation - используем только Bot API\n  const promoteMemberMutation = useMutation({\n    mutationFn: async ({ groupId, userId, adminRights }: { groupId: string | null; userId: string; adminRights: any }) => {\n      return await apiRequest('POST', `/api/projects/${projectId}/bot/promote-member`, {\n        groupId,\n        userId,\n        ...adminRights  // Передаем права напрямую, без вложенности в permissions\n      });\n    },\n    onSuccess: (data: any) => {\n      toast({ \n        title: 'Участник назначен администратором',\n        description: data.message || 'Операция выполнена успешно'\n      });\n      // Обновляем список участников\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/telegram-client/group-members/${selectedGroup?.groupId}`] });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/group-admins/${selectedGroup?.groupId}`] });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при назначении администратора', \n        description: error.error || 'Не удалось назначить администратора',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Demote member mutation - сначала Bot API, потом Client API\n  const demoteMemberMutation = useMutation({\n    mutationFn: async ({ groupId, userId }: { groupId: string | null; userId: string }) => {\n      try {\n        // Сначала пробуем Bot API\n        return await apiRequest('POST', `/api/projects/${projectId}/bot/demote-member`, {\n          groupId,\n          userId\n        });\n      } catch (botApiError: any) {\n        console.log('Bot API failed, trying Client API:', botApiError);\n        // Если Bot API не работает, пробуем Client API\n        return await apiRequest('POST', `/api/projects/${projectId}/telegram-client/demote-member`, {\n          groupId,\n          userId\n        });\n      }\n    },\n    onSuccess: (data: any) => {\n      toast({ \n        title: 'Администраторские права сняты',\n        description: data.message || 'Операция выполнена успешно'\n      });\n      // Обновляем список участников\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/telegram-client/group-members/${selectedGroup?.groupId}`] });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/group-admins/${selectedGroup?.groupId}`] });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Ошибка при снятии прав администратора', \n        description: error.error || 'Не удалось снять права администратора',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Check member status mutation\n  const checkMemberMutation = useMutation({\n    mutationFn: async ({ groupId, userId }: { groupId: string; userId: string }) => {\n      return await apiRequest('GET', `/api/projects/${projectId}/bot/check-member/${groupId}/${userId}`);\n    },\n    onSuccess: (data: any) => {\n      console.log('checkMemberMutation success:', data);\n      const member = data?.member;\n      if (member) {\n        // Показываем уведомление\n        toast({ \n          title: '✅ Статус участника найден', \n          description: `${member.user?.first_name || 'Пользователь'} (@${member.user?.username || 'без username'}) - ${member.friendlyStatus}`,\n          duration: 5000\n        });\n\n        // Добавляем участника в список, если его там еще нет\n        setAdministrators(prevAdmins => {\n          const existingMember = prevAdmins.find(admin => admin.user?.id === member.user?.id);\n          if (!existingMember) {\n            // Добавляем найденного участника с пометкой\n            const newMember = {\n              ...member,\n              foundViaSearch: true, // Пометка что найден через поиск\n              can_be_edited: false,\n              can_manage_chat: false,\n              can_change_info: false,\n              can_delete_messages: false,\n              can_invite_users: false,\n              can_restrict_members: false,\n              can_pin_messages: false,\n              can_promote_members: false,\n              can_manage_video_chats: false,\n              can_manage_voice_chats: false,\n              can_post_stories: false,\n              can_edit_stories: false,\n              can_delete_stories: false,\n              is_anonymous: false\n            };\n            return [...prevAdmins, newMember];\n          }\n          return prevAdmins;\n        });\n\n        // Очищаем поле поиска после успешного нахождения\n        setUserToFind('');\n        \n        // Обновляем список сохраненных участников после добавления нового\n        if (selectedGroup?.groupId) {\n          getSavedMembersMutation.mutate(selectedGroup.groupId);\n        }\n      } else {\n        toast({ \n          title: '❌ Участник не найден', \n          description: 'Пользователь не является участником этой группы',\n          variant: 'destructive',\n          duration: 5000\n        });\n      }\n    },\n    onError: (error: any) => {\n      console.error('checkMemberMutation error:', error);\n      toast({ \n        title: 'Ошибка проверки статуса', \n        description: error.message || 'Не удалось проверить статус участника',\n        variant: 'destructive',\n        duration: 5000\n      });\n    }\n  });\n\n  // Simple search user mutation - только для поиска и добавления в список  \n  const simpleSearchUserMutation = useMutation({\n    mutationFn: async (query: string) => {\n      return await apiRequest('GET', `/api/projects/${projectId}/bot/search-user/${encodeURIComponent(query)}`);\n    },\n    onSuccess: (data: any) => {\n      if (data.user && selectedGroup && selectedGroup.groupId) {\n        // Используем checkMemberMutation для добавления найденного пользователя в список\n        checkMemberMutation.mutate({\n          groupId: selectedGroup.groupId,\n          userId: data.userId\n        });\n      }\n      setShowUserSearch(false);\n      setUserSearchQuery('');\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Пользователь не найден', \n        description: error.error || 'Не удалось найти пользователя по указанному username или ID',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Search user mutation (старая версия для назначения админом)\n  const searchUserMutation = useMutation({\n    mutationFn: async (query: string) => {\n      return await apiRequest('GET', `/api/projects/${projectId}/bot/search-user/${encodeURIComponent(query)}`);\n    },\n    onSuccess: (data: any) => {\n      if (data.user && selectedGroupForPromotion) {\n        // Показываем диалог с подтверждением назначения\n        const user = data.user;\n        const confirmMessage = `Назначить ${user.first_name || user.username || 'пользователя'} (@${user.username || 'без username'}) администратором группы \"${selectedGroupForPromotion.name}\"?`;\n        \n        if (confirm(confirmMessage)) {\n          promoteMemberMutation.mutate({\n            groupId: selectedGroupForPromotion.groupId,\n            userId: data.userId,\n            adminRights: {\n              can_manage_chat: true,\n              can_change_info: true,\n              can_delete_messages: true,\n              can_invite_users: true,\n              can_restrict_members: true,\n              can_pin_messages: true,\n              can_promote_members: true,\n              can_manage_video_chats: true\n            }\n          });\n        }\n      }\n      setShowUserSearch(false);\n      setUserSearchQuery('');\n    },\n    onError: (error: any) => {\n      toast({ \n        title: 'Пользователь не найден', \n        description: error.error || 'Не удалось найти пользователя по указанному username или ID',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  const handleAddGroup = () => {\n    const identifier = groupId.trim();\n    if (!identifier) {\n      toast({ title: 'Пожалуйста, укажите ID группы или @username', variant: 'destructive' });\n      return;\n    }\n    \n    // Используем автоматически полученное название или ID по умолчанию\n    const finalGroupName = groupName.trim() || identifier.replace('@', '').replace('https://t.me/', '') || 'New Group';\n    \n    // Генерируем ссылку только для username или используем автоматически полученную\n    let finalGroupUrl = groupUrl.trim();\n    if (!finalGroupUrl) {\n      if (identifier.startsWith('@') || (!identifier.startsWith('-') && !identifier.includes('t.me'))) {\n        // Для username создаем ссылку\n        finalGroupUrl = `https://t.me/${identifier.replace('@', '')}`;\n      } else {\n        // Для числовых ID оставляем пустым - ссылка будет получена из API\n        finalGroupUrl = '';\n      }\n    }\n\n    createGroupMutation.mutate({\n      groupId: identifier,\n      name: finalGroupName,\n      url: finalGroupUrl || '',\n      isAdmin: makeAdmin ? 1 : 0,\n      memberCount: null,\n      isActive: 1,\n      description: null,\n      settings: {},\n      chatType: 'group' as const,\n      adminRights: {\n        can_manage_chat: false,\n        can_change_info: false,\n        can_delete_messages: false,\n        can_invite_users: false,\n        can_restrict_members: false,\n        can_pin_messages: false,\n        can_promote_members: false,\n        can_manage_video_chats: false,\n        can_be_anonymous: false,\n        can_manage_stories: false\n      },\n      messagesCount: 0,\n      activeUsers: 0,\n      isPublic: 0,\n      language: 'ru' as const,\n      tags: []\n    });\n    \n    // Закрываем модалка и очищаем форму\n    setShowAddGroup(false);\n    setGroupUrl('');\n    setGroupName('');\n    setGroupId('');\n    setMakeAdmin(false);\n  };\n\n  return (\n    <div className=\"h-full w-full p-6 bg-background\">\n      <div className=\"max-w-6xl mx-auto\">\n        <div className=\"mb-6\">\n          <h1 className=\"text-2xl font-bold text-foreground mb-2\">Управление группами</h1>\n          <p className=\"text-muted-foreground\">\n            Администрирование Telegram групп для проекта \"{projectName}\"\n          </p>\n        </div>\n        \n        {isLoading ? (\n          <div className=\"text-center py-12\">\n            <div className=\"animate-spin w-8 h-8 border-2 border-primary border-t-transparent rounded-full mx-auto mb-4\"></div>\n            <p className=\"text-muted-foreground\">Загружаем группы...</p>\n          </div>\n        ) : safeGroups.length === 0 ? (\n          <div className=\"text-center py-12\">\n            <div className=\"w-16 h-16 bg-muted rounded-lg flex items-center justify-center mx-auto mb-4\">\n              <Users className=\"w-8 h-8 text-muted-foreground\" />\n            </div>\n            <h3 className=\"text-lg font-medium text-muted-foreground mb-2\">\n              Нет подключенных групп\n            </h3>\n            <p className=\"text-sm text-muted-foreground mb-6\">\n              Добавьте первую группу для управления участниками и контентом\n            </p>\n            <Button onClick={() => setShowAddGroup(true)}>\n              <UserPlus className=\"w-4 h-4 mr-2\" />\n              Подключить группу\n            </Button>\n          </div>\n        ) : (\n          <div>\n            <div className=\"flex justify-between items-center mb-6\">\n              <div>\n                <h2 className=\"text-lg font-semibold\">Подключенные группы ({safeGroups.length})</h2>\n                <p className=\"text-sm text-muted-foreground\">Управление вашими Telegram группами</p>\n              </div>\n              <Button onClick={() => setShowAddGroup(true)}>\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Добавить группу\n              </Button>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              {safeGroups.map((group) => (\n                <Card key={group.id} className=\"p-6\">\n                  <div className=\"flex items-start justify-between mb-4\">\n                    <div className=\"flex items-center gap-4\">\n                      <GroupAvatar \n                        avatarUrl={group.avatarUrl}\n                        groupName={group.name}\n                        size={56}\n                      />\n                      <div className=\"flex-1\">\n                        <h3 className=\"font-semibold text-lg leading-tight mb-1\">{group.name}</h3>\n                        <div className=\"flex items-center gap-2\">\n                          <Badge variant={group.isAdmin ? \"default\" : \"secondary\"} className=\"text-xs\">\n                            {group.isAdmin ? 'Администратор' : 'Участник'}\n                          </Badge>\n                          {group.chatType && (\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {group.chatType === 'supergroup' ? 'Супергруппа' : \n                               group.chatType === 'channel' ? 'Канал' : 'Группа'}\n                            </Badge>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        console.log('🔄 Принудительное обновление информации о группе:', group.groupId);\n                        parseGroupInfoMutation.mutate(group.groupId!);\n                      }}\n                      disabled={parseGroupInfoMutation.isPending}\n                      title=\"Обновить информацию о группе\"\n                    >\n                      {parseGroupInfoMutation.isPending ? '⏳' : '🔄'}\n                    </Button>\n                  </div>\n                  \n                  <div className=\"space-y-3 mb-4\">\n                    {/* Описание группы */}\n                    {group.description && (\n                      <div className=\"space-y-1\">\n                        <p className=\"text-sm text-muted-foreground leading-relaxed\">\n                          {group.description.length > 140 ? group.description.substring(0, 140) + '...' : group.description}\n                        </p>\n                      </div>\n                    )}\n                    \n                    {/* Основная информация */}\n                    <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <Users className=\"w-4 h-4 text-muted-foreground\" />\n                          <span className=\"font-medium\">\n                            {group.memberCount || 'N/A'} участников\n                          </span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Clock className=\"w-4 h-4 text-muted-foreground\" />\n                          <span className=\"text-muted-foreground\">\n                            {group.createdAt ? new Date(group.createdAt).toLocaleDateString() : 'N/A'}\n                          </span>\n                        </div>\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-start gap-2\">\n                          <Globe className=\"w-4 h-4 text-muted-foreground mt-0.5\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <a \n                              href={group.url} \n                              target=\"_blank\" \n                              rel=\"noopener noreferrer\"\n                              className=\"text-blue-600 dark:text-blue-400 hover:underline text-xs break-all font-mono\"\n                              title={group.url}\n                            >\n                              {group.url.length > 35 ? group.url.substring(0, 35) + '...' : group.url}\n                            </a>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                  \n                  <div className=\"border-t pt-4 space-y-3\">\n                    {/* Основные действия */}\n                    <div className=\"grid grid-cols-2 gap-3\">\n                      <Button \n                        variant=\"default\" \n                        size=\"sm\" \n                        className=\"h-10\"\n                        onClick={() => {\n                          setSelectedGroup(group);\n                          setGroupName(group.name);\n                          setGroupUrl(group.url);\n                          setGroupDescription(group.description || '');\n                          setGroupAvatarUrl(group.avatarUrl || '');\n                          setGroupLanguage(group.language || 'ru');\n                          setGroupTimezone(group.timezone || '');\n                          setGroupTags(group.tags || []);\n                          setGroupNotes(group.notes || '');\n                          setMakeAdmin(group.isAdmin === 1);\n                          setIsPublicGroup(Boolean(group.isPublic));\n                          \n                          // Инициализируем публичный username если группа публичная\n                          if (group.isPublic && group.url && !group.url.includes('+')) {\n                            // Извлекаем username из публичной ссылки\n                            if (group.url.includes('t.me/')) {\n                              const username = group.url.replace('https://t.me/', '').replace('http://t.me/', '');\n                              setPublicUsername(username.startsWith('@') ? username : `@${username}`);\n                            } else if (group.url.startsWith('@')) {\n                              setPublicUsername(group.url);\n                            } else {\n                              setPublicUsername('');\n                            }\n                          } else {\n                            setPublicUsername('');\n                          }\n                          \n                          // Получаем актуальные права администратора из Telegram API\n                          if (group.isAdmin === 1 && group.groupId) {\n                            fetch(`/api/projects/${projectId}/bot/group-admins/${group.groupId}`)\n                              .then(res => res.json())\n                              .then(data => {\n                                // Создаем базовую структуру с полным набором прав\n                                const baseRights = {\n                                  can_manage_chat: false,\n                                  can_change_info: false,\n                                  can_delete_messages: false,\n                                  can_invite_users: false,\n                                  can_restrict_members: false,\n                                  can_pin_messages: false,\n                                  can_promote_members: false,\n                                  can_manage_video_chats: false,\n                                  can_be_anonymous: false,\n                                  can_manage_stories: false\n                                };\n                                \n                                // Объединяем с данными из API и базы данных\n                                const finalRights = {\n                                  ...baseRights,\n                                  ...((group.adminRights as any) || {}),\n                                  ...(data.botAdminRights || {})\n                                };\n                                \n                                setAdminRights(finalRights);\n                              })\n                              .catch(() => {\n                                // Fallback при ошибке - также используем базовую структуру\n                                const baseRights = {\n                                  can_manage_chat: false,\n                                  can_change_info: false,\n                                  can_delete_messages: false,\n                                  can_invite_users: false,\n                                  can_restrict_members: false,\n                                  can_pin_messages: false,\n                                  can_promote_members: false,\n                                  can_manage_video_chats: false,\n                                  can_be_anonymous: false,\n                                  can_manage_stories: false\n                                };\n                                \n                                const finalRights = {\n                                  ...baseRights,\n                                  ...((group.adminRights as any) || {})\n                                };\n                                \n                                setAdminRights(finalRights);\n                              });\n                          } else {\n                            // Если не админ, используем базовые права\n                            setAdminRights({\n                              can_manage_chat: false,\n                              can_change_info: false,\n                              can_delete_messages: false,\n                              can_invite_users: false,\n                              can_restrict_members: false,\n                              can_pin_messages: false,\n                              can_promote_members: false,\n                              can_manage_video_chats: false,\n                              can_be_anonymous: false,\n                              can_manage_stories: false\n                            });\n                          }\n                          \n                          setShowGroupSettings(true);\n                        }}\n                      >\n                        <Settings className=\"w-4 h-4 mr-2\" />\n                        Настройки\n                      </Button>\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\" \n                        className=\"h-10\"\n                        onClick={() => {\n                          setSelectedGroupForMessage(group);\n                          setShowSendMessage(true);\n                        }}\n                      >\n                        <Send className=\"w-4 h-4 mr-2\" />\n                        Сообщение\n                      </Button>\n                    </div>\n                    \n                    {/* Информационные действия */}\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"h-9 text-xs\"\n                        onClick={() => getGroupInfoMutation.mutate(group.groupId)}\n                        disabled={getGroupInfoMutation.isPending}\n                      >\n                        <BarChart3 className=\"w-3 h-3 mr-1\" />\n                        Инфо\n                      </Button>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"h-9 text-xs\"\n                        onClick={() => getMembersCountMutation.mutate(group.groupId)}\n                        disabled={getMembersCountMutation.isPending}\n                      >\n                        <Users className=\"w-3 h-3 mr-1\" />\n                        Участники\n                      </Button>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\" \n                        className=\"h-9 text-xs\"\n                        onClick={() => getAdminStatusMutation.mutate(group.groupId)}\n                        disabled={getAdminStatusMutation.isPending}\n                      >\n                        <Shield className=\"w-3 h-3 mr-1\" />\n                        Статус\n                      </Button>\n                    </div>\n                    \n                    {/* Опасное действие */}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      className=\"w-full h-8 text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950 text-xs\"\n                      onClick={() => deleteGroupMutation.mutate(group.id)}\n                      disabled={deleteGroupMutation.isPending}\n                    >\n                      <X className=\"w-3 h-3 mr-1\" />\n                      Удалить группу\n                    </Button>\n                  </div>\n                </Card>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Модальное окно подключения группы */}\n        <Dialog open={showAddGroup} onOpenChange={setShowAddGroup}>\n          <DialogContent className=\"sm:max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Подключить группу</DialogTitle>\n              <DialogDescription>\n                Введите данные Telegram группы для подключения к боту\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"group-id\">ID группы или @username</Label>\n                <div className=\"relative\">\n                  <Input\n                    id=\"group-id\"\n                    placeholder=\"-1002726444678 или @groupname или https://t.me/group\"\n                    value={groupId}\n                    onChange={(e) => setGroupId(e.target.value)}\n                    disabled={isParsingGroup}\n                  />\n                  {isParsingGroup && (\n                    <div className=\"absolute right-2 top-2\">\n                      <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600\"></div>\n                    </div>\n                  )}\n                </div>\n                <p className=\"text-sm text-gray-500\">\n                  Информация о группе и ссылка получатся автоматически\n                </p>\n              </div>\n            </div>\n            \n            <div className=\"flex gap-2 pt-4\">\n              <Button \n                variant=\"outline\" \n                onClick={() => setShowAddGroup(false)} \n                className=\"flex-1\"\n              >\n                Отмена\n              </Button>\n              <Button onClick={handleAddGroup} className=\"flex-1\">\n                Подключить группу\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Модальное окно настроек группы */}\n        <Dialog open={showGroupSettings} onOpenChange={setShowGroupSettings}>\n          <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-hidden\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-3\">\n                <Settings className=\"h-5 w-5\" />\n                <div className=\"flex items-center gap-2\">\n                  <GroupAvatar \n                    avatarUrl={selectedGroup?.avatarUrl}\n                    groupName={selectedGroup?.name || 'Группа'}\n                    size={32}\n                  />\n                  <span>Настройки группы: {selectedGroup?.name}</span>\n                </div>\n              </DialogTitle>\n              <DialogDescription>\n                Комплексное управление группой и её участниками\n              </DialogDescription>\n            </DialogHeader>\n            \n            {selectedGroup && (\n              <Tabs defaultValue=\"general\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-4\">\n                  <TabsTrigger value=\"general\" className=\"flex items-center gap-2\">\n                    <Globe className=\"h-4 w-4\" />\n                    Общие\n                  </TabsTrigger>\n                  <TabsTrigger value=\"admin\" className=\"flex items-center gap-2\">\n                    <Shield className=\"h-4 w-4\" />\n                    Права\n                  </TabsTrigger>\n                  <TabsTrigger value=\"members\" className=\"flex items-center gap-2\">\n                    <UserCheck className=\"h-4 w-4\" />\n                    Участники\n                  </TabsTrigger>\n                  <TabsTrigger value=\"analytics\" className=\"flex items-center gap-2\">\n                    <MessageSquare className=\"h-4 w-4\" />\n                    Аналитика\n                  </TabsTrigger>\n                </TabsList>\n\n                <div className=\"mt-4 max-h-[60vh] overflow-y-auto\">\n                  <TabsContent value=\"general\" className=\"space-y-4 mt-0\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"edit-group-name\">Название группы</Label>\n                        <Input\n                          id=\"edit-group-name\"\n                          placeholder=\"Введите название группы\"\n                          value={groupName}\n                          onChange={(e) => setGroupName(e.target.value)}\n                        />\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"edit-group-url\">Ссылка на группу</Label>\n                        <Input\n                          id=\"edit-group-url\"\n                          placeholder=\"https://t.me/group\"\n                          value={groupUrl}\n                          onChange={(e) => setGroupUrl(e.target.value)}\n                        />\n                      </div>\n                    </div>\n                    \n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"edit-group-chat-id\">\n                        Chat ID группы\n                        <span className=\"text-xs text-muted-foreground ml-2\">\n                          (для приватных групп обязательно)\n                        </span>\n                      </Label>\n                      <Input\n                        id=\"edit-group-chat-id\"\n                        placeholder=\"-1001234567890\"\n                        value={selectedGroup?.groupId || ''}\n                        onChange={(e) => {\n                          if (selectedGroup) {\n                            setSelectedGroup({\n                              ...selectedGroup,\n                              groupId: e.target.value\n                            });\n                          }\n                        }}\n                      />\n                      <p className=\"text-xs text-muted-foreground\">\n                        Для получения chat_id: отправьте любое сообщение в группу, затем переслайте его в @userinfobot\n                      </p>\n                    </div>\n                    \n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"edit-group-desc\">Описание группы</Label>\n                      <Textarea\n                        id=\"edit-group-desc\"\n                        placeholder=\"Краткое описание группы...\"\n                        value={groupDescription}\n                        onChange={(e) => setGroupDescription(e.target.value)}\n                        rows={3}\n                      />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"chat-type\">Тип чата</Label>\n                        <Input\n                          id=\"chat-type\"\n                          value={selectedGroup?.chatType === 'group' ? 'Группа' : selectedGroup?.chatType === 'supergroup' ? 'Супергруппа' : selectedGroup?.chatType === 'channel' ? 'Канал' : 'Неизвестно'}\n                          readOnly\n                          className=\"bg-muted cursor-not-allowed\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\">\n                          Тип чата определяется Telegram автоматически и не может быть изменен\n                        </p>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"group-avatar\">Аватарка группы</Label>\n                        <div className=\"flex gap-2\">\n                          <Input\n                            id=\"group-avatar\"\n                            placeholder=\"https://example.com/avatar.jpg\"\n                            value={groupAvatarUrl}\n                            onChange={(e) => setGroupAvatarUrl(e.target.value)}\n                          />\n                          <input\n                            type=\"file\"\n                            accept=\"image/*\"\n                            className=\"hidden\"\n                            id=\"avatar-upload\"\n                            onChange={async (e) => {\n                              const file = e.target.files?.[0];\n                              if (file) {\n                                try {\n                                  // Загружаем файл на сервер\n                                  const formData = new FormData();\n                                  formData.append('file', file);\n                                  \n                                  const response = await fetch(`/api/media/upload/${projectId}`, {\n                                    method: 'POST',\n                                    body: formData\n                                  });\n                                  \n                                  if (response.ok) {\n                                    const result = await response.json();\n                                    // Устанавливаем путь к загруженному файлу\n                                    const serverUrl = result.url || `/uploads/${result.filename}`;\n                                    setGroupAvatarUrl(serverUrl);\n                                    toast({\n                                      title: \"Изображение загружено\",\n                                      description: \"Аватарка готова к установке\"\n                                    });\n                                  } else {\n                                    throw new Error('Ошибка загрузки файла');\n                                  }\n                                } catch (error) {\n                                  console.error('Upload error:', error);\n                                  toast({\n                                    title: \"Ошибка загрузки\",\n                                    description: \"Не удалось загрузить изображение\",\n                                    variant: \"destructive\"\n                                  });\n                                }\n                              }\n                            }}\n                          />\n                          <Button \n                            variant=\"outline\" \n                            size=\"icon\"\n                            onClick={() => {\n                              document.getElementById('avatar-upload')?.click();\n                            }}\n                          >\n                            <Upload className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                        {groupAvatarUrl && (\n                          <div className=\"mt-2\">\n                            <div className=\"w-16 h-16 border rounded-lg overflow-hidden\">\n                              <img \n                                src={groupAvatarUrl} \n                                alt=\"Предпросмотр аватарки\" \n                                className=\"w-full h-full object-cover\"\n                                onError={() => {\n                                  toast({\n                                    title: \"Ошибка загрузки изображения\",\n                                    description: \"Проверьте правильность URL\",\n                                    variant: \"destructive\"\n                                  });\n                                }}\n                              />\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Switch \n                          id=\"public-group\"\n                          checked={isPublicGroup}\n                          onCheckedChange={(checked) => {\n                            setIsPublicGroup(checked);\n                            // Если переключаем на приватную, очищаем публичный username\n                            if (!checked) {\n                              setPublicUsername('');\n                            }\n                          }}\n                        />\n                        <Label htmlFor=\"public-group\">\n                          Публичная группа\n                        </Label>\n                      </div>\n                      \n                      {isPublicGroup && (\n                        <div className=\"space-y-2 pl-6 border-l-2 border-primary/20\">\n                          <Label htmlFor=\"public-username\" className=\"text-sm font-medium\">\n                            Публичная ссылка\n                            <span className=\"text-xs text-muted-foreground ml-2\">\n                              (обязательно для публичных групп)\n                            </span>\n                          </Label>\n                          <div className=\"space-y-2\">\n                            <Input\n                              id=\"public-username\"\n                              placeholder=\"@username или t.me/username\"\n                              value={publicUsername}\n                              onChange={(e) => setPublicUsername(e.target.value)}\n                              className=\"text-sm\"\n                            />\n                            <p className=\"text-xs text-muted-foreground\">\n                              Введите @username группы или полную ссылку t.me/username. \n                              Это заменит приватную ссылку-приглашение на публичную.\n                            </p>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"group-notes\">Заметки администратора</Label>\n                      <Textarea\n                        id=\"group-notes\"\n                        placeholder=\"Внутренние заметки о группе...\"\n                        value={groupNotes}\n                        onChange={(e) => setGroupNotes(e.target.value)}\n                        rows={2}\n                      />\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"admin\" className=\"space-y-4 mt-0\">\n                    <div className=\"space-y-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <h4 className=\"font-medium\">Статус администратора</h4>\n                          <p className=\"text-sm text-muted-foreground\">\n                            Является ли бот администратором группы\n                          </p>\n                        </div>\n                        <Switch \n                          checked={makeAdmin}\n                          onCheckedChange={setMakeAdmin}\n                        />\n                      </div>\n                      \n                      {makeAdmin && (\n                        <div className=\"space-y-3\">\n                          <h5 className=\"font-medium text-sm\">Права администратора</h5>\n                          <div className=\"grid grid-cols-2 gap-3\">\n                            {Object.entries(adminRights).map(([key, value]) => (\n                              <div key={key} className=\"flex items-center space-x-2\">\n                                <Switch\n                                  checked={value}\n                                  onCheckedChange={(checked) => \n                                    setAdminRights(prev => ({ ...prev, [key]: checked }))\n                                  }\n                                />\n                                <Label className=\"text-xs\">\n                                  {key === 'can_manage_chat' && 'Управление чатом'}\n                                  {key === 'can_change_info' && 'Изменение информации'}\n                                  {key === 'can_delete_messages' && 'Удаление сообщений'}\n                                  {key === 'can_invite_users' && 'Приглашение пользователей'}\n                                  {key === 'can_restrict_members' && 'Ограничение участников'}\n                                  {key === 'can_pin_messages' && 'Закрепление сообщений'}\n                                  {key === 'can_promote_members' && 'Назначение администраторов'}\n                                  {key === 'can_manage_video_chats' && 'Управление видеочатами'}\n                                  {key === 'can_be_anonymous' && 'Анонимность администратора'}\n                                  {key === 'can_manage_stories' && 'Управление историями'}\n                                </Label>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"members\" className=\"space-y-4 mt-0\">\n                    <div className=\"space-y-4\">\n                      \n                      {/* Список администраторов */}\n                      <div className=\"space-y-3\">\n                        <div className=\"flex items-center justify-between\">\n                          <h5 className=\"font-medium text-sm\">Участники группы</h5>\n                          <div className=\"flex items-center gap-2\">\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\"\n                              onClick={() => {\n                                setShowUserSearch(true);\n                              }}\n                            >\n                              <Search className=\"h-4 w-4 mr-2\" />\n                              Найти пользователя\n                            </Button>\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\"\n                              onClick={() => {\n                                setSelectedGroupForPromotion(selectedGroup);\n                                setShowAdminSearch(true);\n                              }}\n                            >\n                              <Crown className=\"h-4 w-4 mr-2\" />\n                              Назначить админом\n                            </Button>\n                            {isLoadingMembers && (\n                              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                                <div className=\"animate-spin h-4 w-4 border-2 border-current border-t-transparent rounded-full\" />\n                                Загрузка...\n                              </div>\n                            )}\n                            <Badge variant=\"outline\">\n                              {(() => {\n                                const totalSavedMembers = savedMembers.length;\n                                const totalApiMembers = clientApiMembers.length || administrators.length;\n                                const totalMembers = totalSavedMembers + totalApiMembers;\n                                \n                                if (totalMembers > 0) {\n                                  if (totalSavedMembers > 0 && totalApiMembers > 0) {\n                                    return `${totalMembers} участников (${totalSavedMembers} сохр. + ${totalApiMembers} API)`;\n                                  } else if (totalSavedMembers > 0) {\n                                    return `${totalSavedMembers} сохраненных участников`;\n                                  } else {\n                                    return `${totalApiMembers} участников`;\n                                  }\n                                } else if (selectedGroup.memberCount) {\n                                  return `${selectedGroup.memberCount} участников`;\n                                } else {\n                                  return 'Загрузка...';\n                                }\n                              })()}\n                            </Badge>\n                            {clientApiMembers.length === 0 && savedMembers.length === 0 && (\n                              <Button \n                                variant=\"outline\" \n                                size=\"sm\"\n                                onClick={() => setShowTelegramAuth(true)}\n                              >\n                                <Shield className=\"h-4 w-4 mr-2\" />\n                                Загрузить всех участников\n                              </Button>\n                            )}\n                            {savedMembers.length > 0 && clientApiMembers.length === 0 && (\n                              <Button \n                                variant=\"outline\" \n                                size=\"sm\"\n                                onClick={() => setShowTelegramAuth(true)}\n                              >\n                                <Shield className=\"h-4 w-4 mr-2\" />\n                                Загрузить еще участников\n                              </Button>\n                            )}\n                          </div>\n                        </div>\n                        \n                        {(() => {\n                          // Создаем объединенный список: сначала сохраненные участники, затем API участники\n                          const allMembers = [];\n                          \n                          // Добавляем сохраненных участников из базы данных\n                          if (savedMembers.length > 0) {\n                            allMembers.push(...savedMembers.map(member => ({ ...member, sourceType: 'database' })));\n                          }\n                          \n                          // Добавляем участников из Client API (если нет дубликатов)\n                          if (clientApiMembers.length > 0) {\n                            const uniqueApiMembers = clientApiMembers.filter(apiMember => {\n                              const apiUserId = apiMember.id?.toString() || apiMember.user?.id?.toString() || apiMember.userId?.toString();\n                              return !savedMembers.some(savedMember => \n                                savedMember.user?.id?.toString() === apiUserId\n                              );\n                            });\n                            allMembers.push(...uniqueApiMembers.map(member => ({ ...member, sourceType: 'api' })));\n                          }\n                          \n                          // Добавляем найденных через поиск администраторов (если нет Client API данных и нет дубликатов)\n                          if (clientApiMembers.length === 0 && administrators.length > 0) {\n                            const uniqueAdmins = administrators.filter(admin => {\n                              const adminUserId = admin.id?.toString() || admin.user?.id?.toString() || admin.userId?.toString();\n                              return !savedMembers.some(savedMember => \n                                savedMember.user?.id?.toString() === adminUserId\n                              );\n                            });\n                            allMembers.push(...uniqueAdmins.map(admin => ({ ...admin, sourceType: 'admin_api' })));\n                          }\n                          \n                          // Показываем объединенный список если есть участники\n                          if (allMembers.length > 0) {\n                            return (\n                              <div className=\"space-y-2 max-h-60 overflow-y-auto\">\n                                {allMembers.map((member, index) => (\n                                  <div key={`${member.sourceType}-${index}`} className={`flex items-center justify-between p-3 border rounded-lg ${\n                                    member.sourceType === 'database' ? 'border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950' :\n                                    member.foundViaSearch ? 'border-purple-200 dark:border-purple-800 bg-purple-50 dark:bg-purple-950' : ''\n                                  }`}>\n                                    <div className=\"flex items-center space-x-3\">\n                                      <div className={`w-8 h-8 rounded-full flex items-center justify-center ${\n                                        member.status === 'creator' ? 'bg-yellow-100 dark:bg-yellow-900' :\n                                        member.status === 'administrator' ? 'bg-blue-100 dark:bg-blue-900' :\n                                        member.isBot ? 'bg-gray-100 dark:bg-gray-900' :\n                                        'bg-green-100 dark:bg-green-900'\n                                      }`}>\n                                        {member.status === 'creator' ? (\n                                          <Crown className={`h-4 w-4 text-yellow-600 dark:text-yellow-400`} />\n                                        ) : member.status === 'administrator' ? (\n                                          <Shield className={`h-4 w-4 text-blue-600 dark:text-blue-400`} />\n                                        ) : member.isBot ? (\n                                          <Bot className={`h-4 w-4 text-gray-600 dark:text-gray-400`} />\n                                        ) : (\n                                          <Users className={`h-4 w-4 text-green-600 dark:text-green-400`} />\n                                        )}\n                                      </div>\n                                      <div>\n                                        <div className=\"flex items-center gap-2\">\n                                          <p className=\"font-medium text-sm\">\n                                            {member?.firstName || member?.user?.first_name || member?.first_name || 'Неизвестно'} {member?.lastName || member?.user?.last_name || member?.last_name || ''}\n                                          </p>\n                                          {member?.isBot && <Badge variant=\"outline\" className=\"text-xs\">Бот</Badge>}\n                                          {member.sourceType === 'database' && <Badge variant=\"outline\" className=\"text-xs bg-green-50 text-green-600 border-green-200\">💾 Сохранен</Badge>}\n                                        </div>\n                                        <p className=\"text-xs text-muted-foreground\">\n                                          @{member?.username || member?.user?.username || 'Без username'} • ID: {member?.id || member?.user?.id || 'Неизвестно'}\n                                        </p>\n                                      </div>\n                                    </div>\n                                    <div className=\"flex items-center gap-2\">\n                                      <Badge variant={\n                                        member.status === 'creator' ? 'default' : \n                                        member.status === 'administrator' ? 'secondary' : \n                                        'outline'\n                                      }>\n                                        {member.status === 'creator' ? 'Создатель' : \n                                         member.status === 'administrator' ? 'Админ' : \n                                         member.isBot ? 'Бот' :\n                                         'Участник'}\n                                      </Badge>\n                                      \n                                      {/* Кнопки управления участником - показываем для всех кроме создателя */}\n                                      {member.status !== 'creator' && (\n                                        <DropdownMenu>\n                                          <DropdownMenuTrigger asChild>\n                                            <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\">\n                                              <MoreHorizontal className=\"h-4 w-4\" />\n                                            </Button>\n                                          </DropdownMenuTrigger>\n                                          <DropdownMenuContent align=\"end\">\n                                            {/* Показываем разрешения и назначение администратором для всех участников */}\n                                            <>\n                                              <DropdownMenuItem \n                                                onClick={() => {\n                                                  setSelectedMember(member);\n                                                  const userId = member.id?.toString() || member.user?.id?.toString() || member.userId?.toString();\n                                                  if (userId && selectedGroup?.groupId) {\n                                                    // Загружаем текущие разрешения участника\n                                                    loadMemberPermissionsMutation.mutate({ \n                                                      groupId: selectedGroup.groupId, \n                                                      userId \n                                                    });\n                                                  } else {\n                                                    // Если не удалось получить ID, используем разрешения по умолчанию\n                                                    setMemberPermissions({\n                                                      // Основные разрешения участника\n                                                      can_send_messages: true,\n                                                      can_send_media_messages: true,\n                                                      can_send_polls: true,\n                                                      can_send_other_messages: true,\n                                                      can_add_web_page_previews: true,\n                                                      \n                                                      // Административные разрешения\n                                                      can_change_info: false,\n                                                      can_delete_messages: false,\n                                                      can_restrict_members: false,\n                                                      can_invite_users: false,\n                                                      can_pin_messages: false,\n                                                      can_manage_video_chats: false,\n                                                      can_be_anonymous: false,\n                                                      can_promote_members: false\n                                                    });\n                                                  }\n                                                  setShowPermissionsDialog(true);\n                                                }}\n                                              >\n                                                <Settings className=\"h-4 w-4 mr-2\" />\n                                                Разрешения\n                                              </DropdownMenuItem>\n                                              <DropdownMenuItem \n                                                onClick={() => {\n                                                  const userId = member.id?.toString() || member.user?.id?.toString() || member.userId?.toString();\n                                                  if (!userId) {\n                                                    toast({\n                                                      title: 'Ошибка',\n                                                      description: 'Не удалось получить ID пользователя',\n                                                      variant: 'destructive'\n                                                    });\n                                                    return;\n                                                  }\n                                                  // Назначаем с базовыми правами администратора\n                                                  promoteMemberMutation.mutate({ \n                                                    groupId: selectedGroup.groupId, \n                                                    userId,\n                                                    adminRights: {\n                                                      can_change_info: false,\n                                                      can_delete_messages: true,\n                                                      can_invite_users: true,\n                                                      can_restrict_members: true,\n                                                      can_pin_messages: true,\n                                                      can_promote_members: false,\n                                                      can_manage_video_chats: false,\n                                                      can_be_anonymous: false,\n                                                      can_manage_topics: false\n                                                    }\n                                                  });\n                                                }}\n                                              >\n                                                <Crown className=\"h-4 w-4 mr-2\" />\n                                                Назначить администратором\n                                              </DropdownMenuItem>\n                                              <DropdownMenuSeparator />\n                                            </>\n                                            \n                                            {/* Основные действия - для всех кроме создателя */}\n                                            <DropdownMenuItem \n                                              onClick={() => {\n                                                const userId = member.id?.toString() || member.user?.id?.toString() || member.userId?.toString();\n                                                if (!userId) {\n                                                  toast({\n                                                    title: 'Ошибка',\n                                                    description: 'Не удалось получить ID пользователя',\n                                                    variant: 'destructive'\n                                                  });\n                                                  return;\n                                                }\n                                                muteMemberMutation.mutate({ \n                                                  groupId: selectedGroup.groupId, \n                                                  userId \n                                                });\n                                              }}\n                                            >\n                                              <VolumeX className=\"h-4 w-4 mr-2\" />\n                                              {member.isBot ? 'Отключить бота' : 'Замутить'}\n                                            </DropdownMenuItem>\n                                            <DropdownMenuItem \n                                              onClick={() => {\n                                                const userId = member.id?.toString() || member.user?.id?.toString() || member.userId?.toString();\n                                                if (!userId) {\n                                                  toast({\n                                                    title: 'Ошибка',\n                                                    description: 'Не удалось получить ID пользователя',\n                                                    variant: 'destructive'\n                                                  });\n                                                  return;\n                                                }\n                                                kickMemberMutation.mutate({ \n                                                  groupId: selectedGroup.groupId, \n                                                  userId \n                                                });\n                                              }}\n                                            >\n                                              <UserMinus className=\"h-4 w-4 mr-2\" />\n                                              {member.isBot ? 'Удалить бота' : 'Исключить'}\n                                            </DropdownMenuItem>\n                                            <DropdownMenuItem \n                                              onClick={() => banMemberMutation.mutate({ \n                                                groupId: selectedGroup.groupId, \n                                                userId: member.id?.toString() || member.user?.id?.toString() \n                                              })}\n                                              className=\"text-destructive\"\n                                            >\n                                              <Ban className=\"h-4 w-4 mr-2\" />\n                                              {member.isBot ? 'Заблокировать бота' : 'Заблокировать'}\n                                            </DropdownMenuItem>\n                                            <DropdownMenuItem \n                                              onClick={() => {\n                                                const userId = member.id?.toString() || member.user?.id?.toString() || member.userId?.toString();\n                                                if (!userId) {\n                                                  toast({\n                                                    title: 'Ошибка',\n                                                    description: 'Не удалось получить ID пользователя',\n                                                    variant: 'destructive'\n                                                  });\n                                                  return;\n                                                }\n                                                unbanMemberMutation.mutate({ \n                                                  groupId: selectedGroup.groupId, \n                                                  userId \n                                                });\n                                              }}\n                                            >\n                                              <UserPlus className=\"h-4 w-4 mr-2\" />\n                                              {member.isBot ? 'Разблокировать бота' : 'Разблокировать'}\n                                            </DropdownMenuItem>\n                                          </DropdownMenuContent>\n                                        </DropdownMenu>\n                                      )}\n                                    </div>\n                                  </div>\n                                ))}\n                              </div>\n                            );\n                          }\n                          \n                          // Если нет Client API данных, показываем администраторов от Bot API\n                          if (administrators.length > 0) {\n                            return (\n                              <div className=\"space-y-2 max-h-60 overflow-y-auto\">\n                                {administrators.map((admin, index) => (\n                                  <div key={`bot-${index}`} className={`flex items-center justify-between p-3 border rounded-lg ${admin.foundViaSearch ? 'border-purple-200 dark:border-purple-800 bg-purple-50 dark:bg-purple-950' : ''}`}>\n                                    <div className=\"flex items-center space-x-3\">\n                                      <div className={`w-8 h-8 rounded-full flex items-center justify-center ${\n                                        admin.foundViaSearch ? 'bg-purple-100 dark:bg-purple-900' :\n                                        admin.status === 'creator' ? 'bg-yellow-100 dark:bg-yellow-900' :\n                                        'bg-blue-100 dark:bg-blue-900'\n                                      }`}>\n                                        {admin.foundViaSearch ? (\n                                          <Search className=\"h-4 w-4 text-purple-600 dark:text-purple-400\" />\n                                        ) : admin.status === 'creator' ? (\n                                          <Crown className=\"h-4 w-4 text-yellow-600 dark:text-yellow-400\" />\n                                        ) : (\n                                          <Shield className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                                        )}\n                                      </div>\n                                      <div>\n                                        <div className=\"flex items-center gap-2\">\n                                          <p className=\"font-medium text-sm\">\n                                            {admin?.user?.first_name || admin?.first_name || admin?.firstName || 'Неизвестно'} {admin?.user?.last_name || admin?.last_name || admin?.lastName || ''}\n                                          </p>\n                                          {admin.foundViaSearch && <Badge variant=\"outline\" className=\"text-xs text-purple-600 dark:text-purple-400\">Найден поиском</Badge>}\n                                        </div>\n                                        <p className=\"text-xs text-muted-foreground\">\n                                          @{admin?.user?.username || admin?.username || 'Без username'} • ID: {admin?.user?.id || admin?.id || 'Неизвестно'}\n                                        </p>\n                                      </div>\n                                    </div>\n                                    <div className=\"flex items-center gap-2\">\n                                      <Badge variant={\n                                        admin.status === 'creator' ? 'default' : \n                                        admin.foundViaSearch ? 'outline' : \n                                        'secondary'\n                                      }>\n                                        {admin.status === 'creator' ? 'Создатель' : \n                                         admin.foundViaSearch ? admin.friendlyStatus || 'Участник' : \n                                         'Админ'}\n                                      </Badge>\n                                      \n                                      {/* Кнопки управления участником - показываем для всех кроме создателя */}\n                                      {admin.status !== 'creator' && (\n                                        <DropdownMenu>\n                                          <DropdownMenuTrigger asChild>\n                                            <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\">\n                                              <MoreHorizontal className=\"h-4 w-4\" />\n                                            </Button>\n                                          </DropdownMenuTrigger>\n                                          <DropdownMenuContent align=\"end\">\n                                            {/* Показываем разрешения для всех участников */}\n                                            <>\n                                              <DropdownMenuItem \n                                                onClick={() => {\n                                                  setSelectedMember(admin);\n                                                  const userId = admin?.user?.id?.toString() || admin?.id?.toString();\n                                                  if (userId && selectedGroup?.groupId) {\n                                                    // Загружаем актуальные разрешения через API\n                                                    console.log('🔍 Загружаем права через API для:', { userId, groupId: selectedGroup.groupId });\n                                                    loadMemberPermissionsMutation.mutate({ \n                                                      groupId: selectedGroup.groupId, \n                                                      userId \n                                                    });\n                                                  } else {\n                                                    // Fallback - используем данные по умолчанию\n                                                    setMemberPermissions({\n                                                      can_send_messages: true,\n                                                      can_send_media_messages: true,\n                                                      can_send_polls: true,\n                                                      can_send_other_messages: true,\n                                                      can_add_web_page_previews: true,\n                                                      can_change_info: false,\n                                                      can_delete_messages: false,\n                                                      can_restrict_members: false,\n                                                      can_invite_users: false,\n                                                      can_pin_messages: false,\n                                                      can_manage_video_chats: false,\n                                                      can_be_anonymous: false,\n                                                      can_promote_members: false\n                                                    });\n                                                  }\n                                                  setShowPermissionsDialog(true);\n                                                }}\n                                              >\n                                                <Settings className=\"h-4 w-4 mr-2\" />\n                                                Разрешения\n                                              </DropdownMenuItem>\n                                              \n                                              {/* Кнопка назначения администратором для найденных через поиск участников */}\n                                              {admin.foundViaSearch && admin.status !== 'administrator' && (\n                                                <DropdownMenuItem \n                                                  onClick={() => {\n                                                    const userId = admin?.user?.id?.toString() || admin?.id?.toString();\n                                                    if (!userId) {\n                                                      toast({\n                                                        title: 'Ошибка',\n                                                        description: 'Не удалось получить ID пользователя',\n                                                        variant: 'destructive'\n                                                      });\n                                                      return;\n                                                    }\n                                                    // Назначаем с базовыми правами администратора\n                                                    promoteMemberMutation.mutate({ \n                                                      groupId: selectedGroup.groupId, \n                                                      userId,\n                                                      adminRights: {\n                                                        can_change_info: false,\n                                                        can_delete_messages: true,\n                                                        can_invite_users: true,\n                                                        can_restrict_members: true,\n                                                        can_pin_messages: true,\n                                                        can_promote_members: false,\n                                                        can_manage_video_chats: false,\n                                                        can_be_anonymous: false,\n                                                        can_manage_topics: false\n                                                      }\n                                                    });\n                                                  }}\n                                                >\n                                                  <Crown className=\"h-4 w-4 mr-2\" />\n                                                  Назначить администратором\n                                                </DropdownMenuItem>\n                                              )}\n                                              <DropdownMenuSeparator />\n                                            </>\n                                            \n                                            {/* Основные действия - для всех кроме создателя */}\n                                            <DropdownMenuItem \n                                              onClick={() => {\n                                                const userId = admin?.user?.id?.toString() || admin?.id?.toString();\n                                                if (!userId) {\n                                                  toast({\n                                                    title: 'Ошибка',\n                                                    description: 'Не удалось получить ID пользователя',\n                                                    variant: 'destructive'\n                                                  });\n                                                  return;\n                                                }\n                                                demoteMemberMutation.mutate({ \n                                                  groupId: selectedGroup.groupId, \n                                                  userId \n                                                });\n                                              }}\n                                              className=\"text-orange-600\"\n                                            >\n                                              <Crown className=\"h-4 w-4 mr-2\" />\n                                              Снять права администратора\n                                            </DropdownMenuItem>\n                                            <DropdownMenuSeparator />\n                                            <DropdownMenuItem \n                                              onClick={() => muteMemberMutation.mutate({ \n                                                groupId: selectedGroup.groupId, \n                                                userId: admin?.user?.id?.toString() || admin?.id?.toString() \n                                              })}\n                                            >\n                                              <VolumeX className=\"h-4 w-4 mr-2\" />\n                                              {admin.user?.is_bot || admin.is_bot ? 'Отключить бота' : 'Замутить'}\n                                            </DropdownMenuItem>\n                                            <DropdownMenuItem \n                                              onClick={() => kickMemberMutation.mutate({ \n                                                groupId: selectedGroup.groupId, \n                                                userId: admin?.user?.id?.toString() || admin?.id?.toString() \n                                              })}\n                                            >\n                                              <UserMinus className=\"h-4 w-4 mr-2\" />\n                                              {admin.user?.is_bot || admin.is_bot ? 'Удалить бота' : 'Исключить'}\n                                            </DropdownMenuItem>\n                                            <DropdownMenuItem \n                                              onClick={() => banMemberMutation.mutate({ \n                                                groupId: selectedGroup.groupId, \n                                                userId: admin?.user?.id?.toString() || admin?.id?.toString() \n                                              })}\n                                              className=\"text-destructive\"\n                                            >\n                                              <Ban className=\"h-4 w-4 mr-2\" />\n                                              {admin.user?.is_bot || admin.is_bot ? 'Заблокировать бота' : 'Заблокировать'}\n                                            </DropdownMenuItem>\n                                            <DropdownMenuItem \n                                              onClick={() => {\n                                                const userId = admin?.user?.id?.toString() || admin?.id?.toString();\n                                                if (!userId) {\n                                                  toast({\n                                                    title: 'Ошибка',\n                                                    description: 'Не удалось получить ID пользователя',\n                                                    variant: 'destructive'\n                                                  });\n                                                  return;\n                                                }\n                                                unbanMemberMutation.mutate({ \n                                                  groupId: selectedGroup.groupId, \n                                                  userId \n                                                });\n                                              }}\n                                            >\n                                              <UserPlus className=\"h-4 w-4 mr-2\" />\n                                              {admin.user?.is_bot || admin.is_bot ? 'Разблокировать бота' : 'Разблокировать'}\n                                            </DropdownMenuItem>\n                                          </DropdownMenuContent>\n                                        </DropdownMenu>\n                                      )}\n                                    </div>\n                                  </div>\n                                ))}\n                              </div>\n                            );\n                          }\n                          \n                          // Если ничего нет, показываем улучшенную подсказку\n                          return (\n                            <div className=\"space-y-3 py-4\">\n                              <div className=\"text-center\">\n                                <p className=\"text-sm text-muted-foreground\">\n                                  📝 Показаны только администраторы\n                                </p>\n                                <p className=\"text-xs text-muted-foreground mt-1\">\n                                  Обычные участники скрыты из-за ограничений Telegram Bot API\n                                </p>\n                                <p className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                                  💡 Проверьте конкретного участника кнопкой ниже\n                                </p>\n                              </div>\n                              \n                              <div className=\"space-y-2\">\n                                <div className=\"flex gap-2\">\n                                  <Input\n                                    placeholder=\"@username или ID пользователя\"\n                                    value={userToFind}\n                                    onChange={(e) => setUserToFind(e.target.value)}\n                                    onKeyDown={(e) => {\n                                      if (e.key === 'Enter' && userToFind.trim() && selectedGroup?.groupId) {\n                                        // Извлекаем ID из строки (может быть @username или просто ID)\n                                        let userId = userToFind.trim().replace('@', '');\n                                        checkMemberMutation.mutate({\n                                          groupId: selectedGroup.groupId,\n                                          userId: userId\n                                        });\n                                      }\n                                    }}\n                                    className=\"flex-1\"\n                                  />\n                                  <Button\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    onClick={() => {\n                                      if (userToFind.trim() && selectedGroup?.groupId) {\n                                        // Извлекаем ID из строки (может быть @username или просто ID)\n                                        let userId = userToFind.trim().replace('@', '');\n                                        checkMemberMutation.mutate({\n                                          groupId: selectedGroup.groupId,\n                                          userId: userId\n                                        });\n                                      }\n                                    }}\n                                    disabled={checkMemberMutation.isPending || !userToFind.trim()}\n                                  >\n                                    {checkMemberMutation.isPending ? '⏳' : '🔍'}\n                                  </Button>\n                                </div>\n                                \n                                <p className=\"text-xs text-muted-foreground text-center\">\n                                  Введите @username или ID для поиска • Загрузите всех участников кнопкой выше\n                                </p>\n                              </div>\n                            </div>\n                          );\n                        })()}\n                      </div>\n\n\n\n\n                      <div className=\"border-t my-4\" />\n\n                      {/* Управление сообщениями */}\n                      <div className=\"space-y-3\">\n                        <h5 className=\"font-medium text-sm\">Управление сообщениями</h5>\n                        \n                        {/* Закрепление сообщения */}\n                        <div className=\"space-y-2\">\n                          <Label htmlFor=\"pin-message\" className=\"text-xs\">Закрепить сообщение (ID)</Label>\n                          <div className=\"flex gap-2\">\n                            <Input\n                              id=\"pin-message\"\n                              value={messageIdToPin}\n                              onChange={(e) => setMessageIdToPin(e.target.value)}\n                              placeholder=\"ID сообщения для закрепления...\"\n                              className=\"flex-1\"\n                            />\n                            <Button \n                              onClick={() => pinMessageMutation.mutate({ \n                                groupId: selectedGroup.groupId, \n                                messageId: messageIdToPin \n                              })}\n                              disabled={!messageIdToPin.trim() || pinMessageMutation.isPending}\n                              size=\"sm\"\n                            >\n                              {pinMessageMutation.isPending ? (\n                                <div className=\"animate-spin h-4 w-4 border-2 border-current border-t-transparent rounded-full\" />\n                              ) : (\n                                <Pin className=\"h-4 w-4\" />\n                              )}\n                            </Button>\n                          </div>\n                        </div>\n\n                        {/* Открепление сообщения */}\n                        <div className=\"space-y-2\">\n                          <Label htmlFor=\"unpin-message\" className=\"text-xs\">Открепить сообщение (ID)</Label>\n                          <div className=\"flex gap-2\">\n                            <Input\n                              id=\"unpin-message\"\n                              value={messageIdToUnpin}\n                              onChange={(e) => setMessageIdToUnpin(e.target.value)}\n                              placeholder=\"ID сообщения или оставьте пустым для всех...\"\n                              className=\"flex-1\"\n                            />\n                            <Button \n                              onClick={() => unpinMessageMutation.mutate({ \n                                groupId: selectedGroup.groupId, \n                                messageId: messageIdToUnpin || undefined \n                              })}\n                              disabled={unpinMessageMutation.isPending}\n                              size=\"sm\"\n                            >\n                              {unpinMessageMutation.isPending ? (\n                                <div className=\"animate-spin h-4 w-4 border-2 border-current border-t-transparent rounded-full\" />\n                              ) : (\n                                <PinOff className=\"h-4 w-4\" />\n                              )}\n                            </Button>\n                          </div>\n                        </div>\n\n                        {/* Удаление сообщения */}\n                        <div className=\"space-y-2\">\n                          <Label htmlFor=\"delete-message\" className=\"text-xs\">Удалить сообщение (ID)</Label>\n                          <div className=\"flex gap-2\">\n                            <Input\n                              id=\"delete-message\"\n                              value={messageIdToDelete}\n                              onChange={(e) => setMessageIdToDelete(e.target.value)}\n                              placeholder=\"ID сообщения для удаления...\"\n                              className=\"flex-1\"\n                            />\n                            <Button \n                              onClick={() => deleteMessageMutation.mutate({ \n                                groupId: selectedGroup.groupId, \n                                messageId: messageIdToDelete \n                              })}\n                              disabled={!messageIdToDelete.trim() || deleteMessageMutation.isPending}\n                              size=\"sm\"\n                              variant=\"destructive\"\n                            >\n                              {deleteMessageMutation.isPending ? (\n                                <div className=\"animate-spin h-4 w-4 border-2 border-current border-t-transparent rounded-full\" />\n                              ) : (\n                                <Trash className=\"h-4 w-4\" />\n                              )}\n                            </Button>\n                          </div>\n                        </div>\n                      </div>\n\n                      <div className=\"border-t my-4\" />\n\n                      {/* Создание ссылок-приглашений */}\n                      <div className=\"space-y-3\">\n                        <h5 className=\"font-medium text-sm\">Ссылки-приглашения</h5>\n                        \n                        <div className=\"space-y-2\">\n                          <Label className=\"text-xs\">Создать новую ссылку-приглашение</Label>\n                          <div className=\"grid grid-cols-2 gap-2\">\n                            <Input\n                              placeholder=\"Название ссылки (опционально)\"\n                              value={inviteLinkName}\n                              onChange={(e) => setInviteLinkName(e.target.value)}\n                            />\n                            <Input\n                              type=\"number\"\n                              placeholder=\"Лимит участников\"\n                              value={inviteLinkLimit}\n                              onChange={(e) => setInviteLinkLimit(e.target.value)}\n                            />\n                          </div>\n                          \n                          <Button \n                            onClick={() => createInviteLinkMutation.mutate({ \n                              groupId: selectedGroup.groupId,\n                              name: inviteLinkName || undefined,\n                              memberLimit: inviteLinkLimit ? parseInt(inviteLinkLimit) : undefined,\n                              createsJoinRequest: false\n                            })}\n                            disabled={createInviteLinkMutation.isPending}\n                            size=\"sm\"\n                            className=\"w-full\"\n                          >\n                            {createInviteLinkMutation.isPending ? (\n                              <div className=\"animate-spin h-4 w-4 border-2 border-current border-t-transparent rounded-full mr-2\" />\n                            ) : (\n                              <UserPlus className=\"h-4 w-4 mr-2\" />\n                            )}\n                            Создать ссылку-приглашение\n                          </Button>\n                        </div>\n                      </div>\n\n\n                      <div className=\"mt-4 p-3 bg-muted/50 rounded-lg\">\n                        <p className=\"text-xs text-muted-foreground\">\n                          💡 <strong>Как получить User ID:</strong> Попросите пользователя написать /start боту @userinfobot или найти ID в настройках Telegram.\n                        </p>\n                      </div>\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"analytics\" className=\"space-y-4 mt-0\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <Card className=\"p-4\">\n                        <div className=\"flex items-center gap-2\">\n                          <MessageSquare className=\"h-5 w-5 text-blue-500\" />\n                          <div>\n                            <p className=\"text-sm font-medium\">Сообщений</p>\n                            <p className=\"text-2xl font-bold\">{selectedGroup.messagesCount || 0}</p>\n                          </div>\n                        </div>\n                      </Card>\n                      \n                      <Card className=\"p-4\">\n                        <div className=\"flex items-center gap-2\">\n                          <Users className=\"h-5 w-5 text-green-500\" />\n                          <div>\n                            <p className=\"text-sm font-medium\">Активные пользователи</p>\n                            <p className=\"text-2xl font-bold\">{selectedGroup.activeUsers || 0}</p>\n                          </div>\n                        </div>\n                      </Card>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Последняя активность</Label>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {selectedGroup.lastActivity \n                          ? new Date(selectedGroup.lastActivity).toLocaleString('ru-RU')\n                          : 'Нет данных'\n                        }\n                      </p>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Теги группы</Label>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {groupTags.map((tag, index) => (\n                          <Badge key={index} variant=\"outline\" className=\"flex items-center gap-1\">\n                            <Tag className=\"h-3 w-3\" />\n                            {tag}\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"h-4 w-4 p-0 ml-1\"\n                              onClick={() => setGroupTags(prev => prev.filter((_, i) => i !== index))}\n                            >\n                              <X className=\"h-3 w-3\" />\n                            </Button>\n                          </Badge>\n                        ))}\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => {\n                            const newTag = prompt('Введите новый тег:');\n                            if (newTag) setGroupTags(prev => [...prev, newTag]);\n                          }}\n                        >\n                          <Plus className=\"h-3 w-3 mr-1\" />\n                          Добавить тег\n                        </Button>\n                      </div>\n                    </div>\n                  </TabsContent>\n                </div>\n              </Tabs>\n            )}\n            \n            <div className=\"flex gap-2 pt-4\">\n              <Button \n                variant=\"outline\" \n                onClick={() => {\n                  setShowGroupSettings(false);\n                  setSelectedGroup(null);\n                }} \n                className=\"flex-1\"\n              >\n                Отмена\n              </Button>\n              <Button \n                onClick={() => {\n                  if (selectedGroup) {\n                    // Валидация для публичных групп\n                    if (isPublicGroup) {\n                      if (!publicUsername.trim()) {\n                        toast({\n                          title: \"Ошибка валидации\",\n                          description: \"Для публичной группы необходимо указать публичную ссылку (@username)\",\n                          variant: \"destructive\"\n                        });\n                        return;\n                      }\n                      \n                      // Проверяем формат username\n                      const cleanUsername = publicUsername.trim();\n                      if (!cleanUsername.startsWith('@') && !cleanUsername.includes('t.me/')) {\n                        toast({\n                          title: \"Неверный формат\",\n                          description: \"Публичная ссылка должна быть в формате @username или t.me/username\",\n                          variant: \"destructive\"\n                        });\n                        return;\n                      }\n                    }\n                    \n                    // Определяем итоговую ссылку на основе типа группы\n                    let finalUrl = groupUrl || selectedGroup.url;\n                    if (isPublicGroup && publicUsername.trim()) {\n                      const cleanUsername = publicUsername.trim();\n                      if (cleanUsername.startsWith('@')) {\n                        finalUrl = `https://t.me/${cleanUsername.substring(1)}`;\n                      } else if (cleanUsername.includes('t.me/')) {\n                        finalUrl = cleanUsername.startsWith('http') ? cleanUsername : `https://${cleanUsername}`;\n                      }\n                    } else if (!isPublicGroup && selectedGroup.inviteLink) {\n                      // Для приватных групп используем приватную ссылку-приглашение\n                      finalUrl = selectedGroup.inviteLink;\n                    }\n                    \n                    // Функция для сохранения настроек в базе данных\n                    const saveToDatabase = (showSuccess = true) => {\n                      // Используем текущий тип чата из группы (не изменяем его)\n                      const finalChatType = selectedGroup.chatType || 'group';\n\n                      // Проверяем, изменились ли название, описание и аватарка группы\n                      const nameChanged = (groupName || selectedGroup.name) !== selectedGroup.name;\n                      const descriptionChanged = groupDescription !== selectedGroup.description;\n                      const avatarChanged = groupAvatarUrl !== selectedGroup.avatarUrl;\n                      \n                      if ((nameChanged || descriptionChanged || avatarChanged) && (groupName?.trim() || groupDescription.trim() || groupAvatarUrl?.trim())) {\n                        // Функция для сохранения в базу данных после успешных обновлений в Telegram\n                        const saveToDBAfterTelegram = () => {\n                          updateGroupMutation.mutate({\n                            groupId: selectedGroup.id,\n                            data: {\n                              name: groupName || selectedGroup.name,\n                              url: finalUrl,\n                              groupId: selectedGroup.groupId,\n                              description: groupDescription,\n                              avatarUrl: groupAvatarUrl,\n                              language: groupLanguage as 'ru' | 'en' | 'es' | 'fr' | 'de' | 'it' | 'pt' | 'zh' | 'ja' | 'ko',\n                              timezone: groupTimezone,\n                              tags: groupTags,\n                              notes: groupNotes,\n                              isAdmin: makeAdmin ? 1 : 0,\n                              isPublic: isPublicGroup ? 1 : 0,\n                              chatType: finalChatType as 'group' | 'supergroup' | 'channel',\n                              adminRights\n                            },\n                            showSuccessMessage: showSuccess\n                          });\n                        };\n\n                        // Функция для последовательного обновления в Telegram\n                        const updateTelegramSequentially = () => {\n                          // Сначала обновляем название\n                          if (nameChanged && groupName?.trim()) {\n                            setGroupTitleMutation.mutate({\n                              groupId: selectedGroup.groupId,\n                              title: groupName\n                            }, {\n                              onSuccess: () => updateDescriptionOrAvatar(),\n                              onError: updateDescriptionOrAvatar\n                            });\n                          } else {\n                            updateDescriptionOrAvatar();\n                          }\n                        };\n\n                        // Функция для обновления описания или аватарки\n                        const updateDescriptionOrAvatar = () => {\n                          if (descriptionChanged && groupDescription.trim()) {\n                            setGroupDescriptionMutation.mutate({\n                              groupId: selectedGroup.groupId,\n                              description: groupDescription\n                            }, {\n                              onSuccess: () => updateAvatarIfNeeded(),\n                              onError: updateAvatarIfNeeded\n                            });\n                          } else {\n                            updateAvatarIfNeeded();\n                          }\n                        };\n\n                        // Функция для обновления аватарки если нужно\n                        const updateAvatarIfNeeded = () => {\n                          if (avatarChanged && groupAvatarUrl?.trim() && groupAvatarUrl.startsWith('/uploads/')) {\n                            // Преобразуем относительный путь в абсолютный путь файла\n                            const photoPath = groupAvatarUrl.replace('/uploads/', 'uploads/');\n                            setGroupPhotoMutation.mutate({\n                              groupId: selectedGroup.groupId,\n                              photoPath: photoPath\n                            }, {\n                              onSuccess: () => updateAdminRightsIfNeeded(),\n                              onError: () => updateAdminRightsIfNeeded()\n                            });\n                          } else {\n                            updateAdminRightsIfNeeded();\n                          }\n                        };\n\n                        // Функция для обновления прав администратора в Telegram если они изменились\n                        const updateAdminRightsIfNeeded = () => {\n                          // Проверяем, изменились ли права администратора\n                          const currentRights = selectedGroup.adminRights || {};\n                          const rightsChanged = Object.keys(adminRights).some(key => \n                            adminRights[key as keyof typeof adminRights] !== currentRights[key as keyof typeof currentRights]\n                          );\n                          \n                          if (rightsChanged && selectedGroup.isAdmin === 1) {\n                            updateBotAdminRightsMutation.mutate({\n                              groupId: selectedGroup.groupId,\n                              adminRights: adminRights\n                            }, {\n                              onSuccess: saveToDBAfterTelegram,\n                              onError: saveToDBAfterTelegram // Сохраняем в БД даже если обновление в Telegram не удалось\n                            });\n                          } else {\n                            saveToDBAfterTelegram();\n                          }\n                        };\n\n                        // Запускаем последовательное обновление\n                        updateTelegramSequentially();\n                      } else {\n                        // Если ничего не изменилось, просто сохраняем в базе данных\n                        updateGroupMutation.mutate({\n                          groupId: selectedGroup.id,\n                          data: {\n                            name: groupName || selectedGroup.name,\n                            url: finalUrl,\n                            groupId: selectedGroup.groupId,\n                            description: groupDescription,\n                            avatarUrl: groupAvatarUrl,\n                            language: groupLanguage as 'ru' | 'en' | 'es' | 'fr' | 'de' | 'it' | 'pt' | 'zh' | 'ja' | 'ko',\n                            timezone: groupTimezone,\n                            tags: groupTags,\n                            notes: groupNotes,\n                            isAdmin: makeAdmin ? 1 : 0,\n                            isPublic: isPublicGroup ? 1 : 0,\n                            chatType: finalChatType as 'group' | 'supergroup' | 'channel',\n                            adminRights\n                          },\n                          showSuccessMessage: showSuccess\n                        });\n                      }\n                    };\n\n                    // Если изменяется публичность группы, сначала изменяем в Telegram\n                    const wasPublic = Boolean(selectedGroup.isPublic);\n                    const willBePublic = isPublicGroup;\n                    \n                    if (wasPublic !== willBePublic) {\n                      // Изменяем username в Telegram перед сохранением в базе\n                      let usernameToSet = '';\n                      if (willBePublic && publicUsername.trim()) {\n                        const cleanUsername = publicUsername.trim().replace('@', '').replace('t.me/', '').replace('https://', '').replace('http://', '');\n                        usernameToSet = cleanUsername;\n                      }\n                      \n                      // Сначала пытаемся изменить в Telegram, потом сохраняем в базе\n                      setGroupUsernameMutation.mutate({\n                        groupId: selectedGroup.groupId,\n                        username: usernameToSet\n                      }, {\n                        onSuccess: () => {\n                          // Только если изменение в Telegram удалось - сохраняем в базе с успешным сообщением\n                          saveToDatabase(true);\n                          toast({\n                            title: \"Настройки группы обновлены\",\n                            description: \"Публичность группы успешно изменена\",\n                          });\n                        },\n                        onError: (error: any) => {\n                          // Показываем ошибку и НЕ сохраняем в базе\n                          toast({\n                            title: \"Не удалось изменить публичность группы\",\n                            description: error.requiresClientApi \n                              ? \"Требуется авторизация через Telegram Client API для изменения публичных настроек группы\"\n                              : error.error || error.message || \"Проверьте права бота в группе\",\n                            variant: \"destructive\"\n                          });\n                        }\n                      });\n                    } else {\n                      // Если публичность не изменяется - сразу сохраняем с обычным сообщением\n                      saveToDatabase(true);\n                    }\n                  }\n                }}\n                disabled={updateGroupMutation.isPending}\n                className=\"flex-1\"\n              >\n                Сохранить\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Модальное окно отправки сообщения в группу */}\n        <Dialog open={showSendMessage} onOpenChange={setShowSendMessage}>\n          <DialogContent className=\"sm:max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Отправить сообщение в группу</DialogTitle>\n              <DialogDescription>\n                Отправка сообщения в группу \"{selectedGroupForMessage?.name}\" через Telegram Bot API\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"message-text\">Текст сообщения</Label>\n                <Textarea\n                  id=\"message-text\"\n                  placeholder=\"Введите текст сообщения...\"\n                  value={messageToSend}\n                  onChange={(e) => setMessageToSend(e.target.value)}\n                  rows={4}\n                />\n              </div>\n            </div>\n            \n            <div className=\"flex gap-2 pt-4\">\n              <Button \n                variant=\"outline\" \n                onClick={() => {\n                  setShowSendMessage(false);\n                  setMessageToSend('');\n                  setSelectedGroupForMessage(null);\n                }} \n                className=\"flex-1\"\n              >\n                Отмена\n              </Button>\n              <Button \n                onClick={() => {\n                  if (selectedGroupForMessage && messageToSend.trim()) {\n                    sendMessageMutation.mutate({\n                      groupId: selectedGroupForMessage.groupId,\n                      message: messageToSend.trim()\n                    });\n                  }\n                }}\n                disabled={sendMessageMutation.isPending || !messageToSend.trim()}\n                className=\"flex-1\"\n              >\n                {sendMessageMutation.isPending ? 'Отправляется...' : 'Отправить'}\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Telegram Auth Dialog */}\n        <TelegramAuth\n          open={showTelegramAuth}\n          onOpenChange={setShowTelegramAuth}\n          onSuccess={async () => {\n            // После успешной авторизации попробуем получить участников\n            if (selectedGroup) {\n              setIsLoadingMembers(true);\n              try {\n                const response = await fetch(`/api/projects/${projectId}/telegram-client/group-members/${selectedGroup.groupId}`);\n                const data = await response.json();\n                \n                if (response.ok && data.success) {\n                  setClientApiMembers(data.members || []);\n                  toast({\n                    title: data.message,\n                    description: `Получено ${data.memberCount} участников через Client API`,\n                  });\n                } else {\n                  toast({\n                    title: data.message || \"Ошибка\",\n                    description: data.explanation || \"Не удалось получить данные\",\n                    variant: \"destructive\"\n                  });\n                }\n              } catch (error) {\n                toast({\n                  title: \"Ошибка подключения\",\n                  description: \"Не удалось подключиться к Client API\",\n                  variant: \"destructive\"\n                });\n              } finally {\n                setIsLoadingMembers(false);\n              }\n            }\n          }}\n        />\n\n        {/* Диалог управления разрешениями участника */}\n        <Dialog open={showPermissionsDialog} onOpenChange={setShowPermissionsDialog}>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>Управление разрешениями участника</DialogTitle>\n              <DialogDescription>\n                {selectedMember && (\n                  <span>\n                    Настройте разрешения для {selectedMember.firstName || selectedMember.user?.first_name || 'пользователя'} \n                    (@{selectedMember.username || selectedMember.user?.username || 'без username'})\n                    {loadMemberPermissionsMutation.isPending && (\n                      <span className=\"text-blue-600 ml-2\">• Загружаем текущие права...</span>\n                    )}\n                  </span>\n                )}\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                {/* Основные разрешения */}\n                <div className=\"space-y-3\">\n                  <h4 className=\"font-medium text-sm\">Основные разрешения</h4>\n                  {Object.entries({\n                    can_send_messages: 'Отправка сообщений',\n                    can_send_media_messages: 'Отправка медиа',\n                    can_send_polls: 'Создание опросов',\n                    can_send_other_messages: 'Стикеры и GIF',\n                    can_add_web_page_previews: 'Предварительный просмотр ссылок'\n                  }).map(([key, label]) => (\n                    <div key={key} className=\"flex items-center space-x-2\">\n                      <Switch\n                        checked={memberPermissions[key as keyof typeof memberPermissions]}\n                        onCheckedChange={(checked) => \n                          setMemberPermissions(prev => ({ ...prev, [key]: checked }))\n                        }\n                      />\n                      <Label className=\"text-sm\">{label}</Label>\n                    </div>\n                  ))}\n                </div>\n\n                {/* Административные разрешения */}\n                <div className=\"space-y-3\">\n                  <h4 className=\"font-medium text-sm\">Административные разрешения</h4>\n                  {Object.entries({\n                    can_change_info: 'Изменение профиля группы',\n                    can_delete_messages: 'Удаление сообщений',\n                    can_restrict_members: 'Блокировка пользователей',\n                    can_invite_users: 'Пригласительные ссылки',\n                    can_pin_messages: 'Закрепление сообщений',\n                    can_manage_video_chats: 'Управление видеочатами',\n                    can_be_anonymous: 'Анонимность',\n                    can_promote_members: 'Добавление администраторов'\n                  }).map(([key, label]) => (\n                    <div key={key} className=\"flex items-center space-x-2\">\n                      <Switch\n                        checked={memberPermissions[key as keyof typeof memberPermissions]}\n                        onCheckedChange={(checked) => \n                          setMemberPermissions(prev => ({ ...prev, [key]: checked }))\n                        }\n                      />\n                      <Label className=\"text-sm\">{label}</Label>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              <div className=\"flex justify-end gap-2 pt-4\">\n                <Button variant=\"outline\" onClick={() => setShowPermissionsDialog(false)}>\n                  Отмена\n                </Button>\n                <Button \n                  onClick={() => {\n                    if (selectedMember && selectedGroup) {\n                      // Расширенная логика извлечения userId для разных форматов API\n                      const userId = \n                        selectedMember.id?.toString() || \n                        selectedMember.user?.id?.toString() || \n                        selectedMember.userId?.toString() ||\n                        selectedMember.from?.id?.toString() ||\n                        selectedMember.from_user?.id?.toString() ||\n                        (selectedMember as any).user_id?.toString();\n                      \n                      const groupId = selectedGroup.groupId;\n                      \n                      // Добавляем отладочную информацию\n                      console.log('💾 Сохраняем разрешения:', {\n                        selectedMember,\n                        extractedUserId: userId,\n                        groupId,\n                        currentPermissions: memberPermissions,\n                        availableKeys: Object.keys(selectedMember)\n                      });\n                      \n                      if (!userId || !groupId) {\n                        toast({\n                          title: 'Ошибка',\n                          description: `Не удалось получить ID пользователя (${userId}) или группы (${groupId}). Проверьте консоль для отладки.`,\n                          variant: 'destructive'\n                        });\n                        return;\n                      }\n                      \n                      updatePermissionsMutation.mutate({\n                        groupId,\n                        userId,\n                        permissions: memberPermissions\n                      });\n                    }\n                  }}\n                  disabled={updatePermissionsMutation.isPending}\n                >\n                  {updatePermissionsMutation.isPending ? 'Сохранение...' : 'Сохранить разрешения'}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Диалог поиска пользователя для добавления в список */}\n        <Dialog open={showUserSearch} onOpenChange={setShowUserSearch}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Найти пользователя</DialogTitle>\n              <DialogDescription>\n                Введите username (без @) или ID пользователя для добавления в список участников\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"user-search\">Username или ID</Label>\n                <Input\n                  id=\"user-search\"\n                  placeholder=\"Sonofbog2 или 123456789\"\n                  value={userSearchQuery}\n                  onChange={(e) => setUserSearchQuery(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && userSearchQuery.trim()) {\n                      simpleSearchUserMutation.mutate(userSearchQuery.trim());\n                    }\n                  }}\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Например: <code>Sonofbog2</code> или <code>@Sonofbog2</code> или <code>123456789</code>\n                </p>\n              </div>\n\n              <div className=\"flex justify-end gap-2\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => {\n                    setShowUserSearch(false);\n                    setUserSearchQuery('');\n                  }}\n                >\n                  Отмена\n                </Button>\n                <Button \n                  onClick={() => {\n                    if (userSearchQuery.trim()) {\n                      simpleSearchUserMutation.mutate(userSearchQuery.trim());\n                    }\n                  }}\n                  disabled={simpleSearchUserMutation.isPending || !userSearchQuery.trim()}\n                >\n                  {simpleSearchUserMutation.isPending ? 'Поиск...' : 'Найти и добавить'}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Диалог для назначения администратором */}\n        <Dialog open={showAdminSearch} onOpenChange={setShowAdminSearch}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Назначить администратором</DialogTitle>\n              <DialogDescription>\n                Введите username (без @) или ID пользователя для назначения администратором\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"admin-search\">Username или ID</Label>\n                <Input\n                  id=\"admin-search\"\n                  placeholder=\"Sonofbog2 или 123456789\"\n                  value={userSearchQuery}\n                  onChange={(e) => setUserSearchQuery(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && userSearchQuery.trim()) {\n                      searchUserMutation.mutate(userSearchQuery.trim());\n                    }\n                  }}\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Например: <code>Sonofbog2</code> или <code>@Sonofbog2</code> или <code>123456789</code>\n                </p>\n              </div>\n\n              <div className=\"flex justify-end gap-2\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => {\n                    setShowAdminSearch(false);\n                    setUserSearchQuery('');\n                  }}\n                >\n                  Отмена\n                </Button>\n                <Button \n                  onClick={() => {\n                    if (userSearchQuery.trim()) {\n                      searchUserMutation.mutate(userSearchQuery.trim());\n                    }\n                  }}\n                  disabled={searchUserMutation.isPending || !userSearchQuery.trim()}\n                >\n                  {searchUserMutation.isPending ? 'Поиск...' : 'Найти и назначить админом'}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}","size_bytes":173817},"client/src/utils/auto-connection.ts":{"content":"import { Node, Connection } from '@shared/schema';\n\nexport interface ConnectionSuggestion {\n  source: string;\n  target: string;\n  confidence: number;\n  reason: string;\n}\n\n// Логика автоматических соединений на основе типов узлов\nexport function generateAutoConnections(nodes: Node[], existingConnections: Connection[]): ConnectionSuggestion[] {\n  const suggestions: ConnectionSuggestion[] = [];\n  const existingPairs = new Set(existingConnections.map(c => `${c.source}-${c.target}`));\n\n  // Типы узлов, которые должны быть соединены в определенном порядке\n  const flowPatterns = [\n    { from: 'start', to: 'message', confidence: 0.9, reason: 'Стартовый узел обычно ведет к сообщению' },\n    { from: 'start', to: 'keyboard', confidence: 0.8, reason: 'Стартовый узел может показать клавиатуру' },\n    { from: 'command', to: 'message', confidence: 0.9, reason: 'Команда обычно отправляет сообщение' },\n    { from: 'command', to: 'keyboard', confidence: 0.8, reason: 'Команда может показать клавиатуру' },\n    { from: 'message', to: 'keyboard', confidence: 0.7, reason: 'Сообщение может содержать клавиатуру' },\n    { from: 'keyboard', to: 'message', confidence: 0.6, reason: 'Клавиатура может вести к сообщению' },\n    { from: 'input', to: 'message', confidence: 0.8, reason: 'Ввод данных обычно ведет к сообщению' },\n    { from: 'condition', to: 'message', confidence: 0.7, reason: 'Условие может вести к сообщению' },\n    { from: 'photo', to: 'keyboard', confidence: 0.6, reason: 'Фото может содержать клавиатуру' },\n  ];\n\n  // Найти узлы по типам\n  const nodesByType = nodes.reduce((acc, node) => {\n    if (!acc[node.type]) acc[node.type] = [];\n    acc[node.type].push(node);\n    return acc;\n  }, {} as Record<string, Node[]>);\n\n  // Генерация предложений на основе шаблонов\n  for (const pattern of flowPatterns) {\n    const sourceNodes = nodesByType[pattern.from] || [];\n    const targetNodes = nodesByType[pattern.to] || [];\n\n    for (const sourceNode of sourceNodes) {\n      for (const targetNode of targetNodes) {\n        const pairKey = `${sourceNode.id}-${targetNode.id}`;\n        if (!existingPairs.has(pairKey) && sourceNode.id !== targetNode.id) {\n          // Проверяем расстояние между узлами для улучшения релевантности\n          const distance = Math.sqrt(\n            Math.pow(targetNode.position.x - sourceNode.position.x, 2) +\n            Math.pow(targetNode.position.y - sourceNode.position.y, 2)\n          );\n          \n          // Уменьшаем confidence для удаленных узлов\n          const distanceModifier = Math.max(0.5, 1 - distance / 1000);\n          \n          suggestions.push({\n            source: sourceNode.id,\n            target: targetNode.id,\n            confidence: pattern.confidence * distanceModifier,\n            reason: pattern.reason\n          });\n        }\n      }\n    }\n  }\n\n  // Поиск изолированных узлов\n  const connectedNodes = new Set([\n    ...existingConnections.map(c => c.source),\n    ...existingConnections.map(c => c.target)\n  ]);\n\n  const isolatedNodes = nodes.filter(node => !connectedNodes.has(node.id));\n\n  // Предложения для изолированных узлов\n  for (const isolated of isolatedNodes) {\n    const nearbyNodes = nodes\n      .filter(node => node.id !== isolated.id && !existingPairs.has(`${isolated.id}-${node.id}`))\n      .map(node => ({\n        node,\n        distance: Math.sqrt(\n          Math.pow(node.position.x - isolated.position.x, 2) +\n          Math.pow(node.position.y - isolated.position.y, 2)\n        )\n      }))\n      .sort((a, b) => a.distance - b.distance)\n      .slice(0, 3); // Берем 3 ближайших\n\n    for (const { node: nearbyNode, distance } of nearbyNodes) {\n      const confidence = Math.max(0.3, 0.8 - distance / 500);\n      suggestions.push({\n        source: isolated.id,\n        target: nearbyNode.id,\n        confidence,\n        reason: 'Изолированный узел рядом с другими'\n      });\n    }\n  }\n\n  // Сортировка по уверенности\n  return suggestions.sort((a, b) => b.confidence - a.confidence);\n}\n\n// Проверка валидности соединения\nexport function isValidConnection(\n  sourceNode: Node,\n  targetNode: Node,\n  existingConnections: Connection[]\n): { valid: boolean; reason?: string } {\n  // Проверяем, что не соединяем узел сам с собой\n  if (sourceNode.id === targetNode.id) {\n    return { valid: false, reason: 'Нельзя соединить узел сам с собой' };\n  }\n\n  // Проверяем, что соединение не существует\n  const existingConnection = existingConnections.find(\n    c => c.source === sourceNode.id && c.target === targetNode.id\n  );\n  if (existingConnection) {\n    return { valid: false, reason: 'Соединение уже существует' };\n  }\n\n  // Проверяем обратное соединение (чтобы избежать циклов)\n  const reverseConnection = existingConnections.find(\n    c => c.source === targetNode.id && c.target === sourceNode.id\n  );\n  if (reverseConnection) {\n    return { valid: false, reason: 'Обратное соединение уже существует' };\n  }\n\n  return { valid: true };\n}\n\n// Получение рекомендаций для конкретного узла\nexport function getNodeConnectionSuggestions(\n  node: Node,\n  allNodes: Node[],\n  existingConnections: Connection[]\n): ConnectionSuggestion[] {\n  const allSuggestions = generateAutoConnections(allNodes, existingConnections);\n  return allSuggestions.filter(s => s.source === node.id || s.target === node.id);\n}","size_bytes":6177},"client/src/components/editor/connection-manager-panel.tsx":{"content":"import React, { useState, useCallback, useMemo } from 'react';\nimport { Node, Connection, Button } from '@shared/schema';\nimport { Badge } from '@/components/ui/badge';\nimport { Button as UIButton } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Switch } from '@/components/ui/switch';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Separator } from '@/components/ui/separator';\nimport { \n  ArrowRight, \n  Plus, \n  Trash2, \n  Edit3, \n  Zap, \n  Target, \n  Link, \n  AlertTriangle,\n  CheckCircle,\n  XCircle,\n  Network,\n  Settings,\n  Lightbulb,\n  Eye,\n  EyeOff,\n  RefreshCw,\n  Filter,\n  Search\n} from 'lucide-react';\nimport { ConnectionManager, ConnectionSuggestion } from '@/utils/connection-manager';\nimport { cn } from '@/lib/utils';\n\ninterface ConnectionManagerPanelProps {\n  nodes: Node[];\n  connections: Connection[];\n  onConnectionsChange: (connections: Connection[]) => void;\n  onNodesChange: (nodes: Node[]) => void;\n  autoButtonCreation: boolean;\n  onAutoButtonCreationChange: (enabled: boolean) => void;\n  selectedConnectionId?: string;\n  onConnectionSelect?: (connectionId: string | null) => void;\n}\n\nexport function ConnectionManagerPanel({\n  nodes,\n  connections,\n  onConnectionsChange,\n  onNodesChange,\n  autoButtonCreation,\n  onAutoButtonCreationChange,\n  selectedConnectionId,\n  onConnectionSelect\n}: ConnectionManagerPanelProps) {\n  const [suggestions, setSuggestions] = useState<ConnectionSuggestion[]>([]);\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [showAdvanced, setShowAdvanced] = useState(false);\n  const [filterType, setFilterType] = useState<'all' | 'button' | 'direct'>('all');\n  const [searchTerm, setSearchTerm] = useState('');\n\n  const connectionManager = useMemo(() => \n    new ConnectionManager({\n      nodes,\n      connections,\n      autoButtonCreation\n    }),\n    [nodes, connections, autoButtonCreation]\n  );\n\n  const connectionStats = useMemo(() => {\n    const total = connections.length;\n    const withButtons = connections.filter(conn => {\n      const sourceNode = nodes.find(n => n.id === conn.source);\n      return sourceNode?.data.buttons.some(b => b.action === 'goto' && b.target === conn.target);\n    }).length;\n    const orphaned = connections.filter(conn => {\n      const sourceNode = nodes.find(n => n.id === conn.source);\n      const targetNode = nodes.find(n => n.id === conn.target);\n      return !sourceNode || !targetNode;\n    }).length;\n\n    return { total, withButtons, direct: total - withButtons, orphaned };\n  }, [connections, nodes]);\n\n  const filteredConnections = useMemo(() => {\n    return connections.filter(conn => {\n      const sourceNode = nodes.find(n => n.id === conn.source);\n      const targetNode = nodes.find(n => n.id === conn.target);\n      \n      if (!sourceNode || !targetNode) return false;\n      \n      const hasButton = sourceNode.data.buttons.some(b => \n        b.action === 'goto' && b.target === conn.target\n      );\n      \n      if (filterType === 'button' && !hasButton) return false;\n      if (filterType === 'direct' && hasButton) return false;\n      \n      if (searchTerm) {\n        const sourceType = sourceNode.type;\n        const targetType = targetNode.type;\n        const searchLower = searchTerm.toLowerCase();\n        return sourceType.includes(searchLower) || targetType.includes(searchLower);\n      }\n      \n      return true;\n    });\n  }, [connections, nodes, filterType, searchTerm]);\n\n  const generateSuggestions = useCallback(async () => {\n    setIsGenerating(true);\n    try {\n      connectionManager.updateState({ nodes, connections });\n      const newSuggestions = connectionManager.generateConnectionSuggestions();\n      setSuggestions(newSuggestions);\n    } finally {\n      setIsGenerating(false);\n    }\n  }, [connectionManager, nodes, connections]);\n\n  const applySuggestion = useCallback((suggestion: ConnectionSuggestion) => {\n    try {\n      const { connection, updatedNodes } = connectionManager.createConnection(\n        suggestion.connection.source,\n        suggestion.connection.target,\n        {\n          autoCreateButton: autoButtonCreation,\n          buttonText: suggestion.suggestedButton.text,\n          buttonAction: suggestion.suggestedButton.action\n        }\n      );\n\n      onConnectionsChange([...connections, connection]);\n      onNodesChange(updatedNodes);\n      \n      // Удаляем примененное предложение\n      setSuggestions(prev => prev.filter(s => s.id !== suggestion.id));\n    } catch (error) {\n      console.error('Ошибка при применении предложения:', error);\n    }\n  }, [connectionManager, connections, onConnectionsChange, onNodesChange, autoButtonCreation]);\n\n  const deleteConnection = useCallback((connectionId: string) => {\n    connectionManager.updateState({ nodes, connections });\n    const { removedConnection, updatedNodes } = connectionManager.removeConnection(connectionId);\n    \n    if (removedConnection) {\n      onConnectionsChange(connections.filter(c => c.id !== connectionId));\n      onNodesChange(updatedNodes);\n      \n      if (selectedConnectionId === connectionId) {\n        onConnectionSelect?.(null);\n      }\n    }\n  }, [connectionManager, nodes, connections, onConnectionsChange, onNodesChange, selectedConnectionId, onConnectionSelect]);\n\n  const syncButtonsWithConnections = useCallback(() => {\n    connectionManager.updateState({ nodes, connections });\n    const updatedNodes = connectionManager.syncButtonsWithConnections();\n    onNodesChange(updatedNodes);\n  }, [connectionManager, nodes, connections, onNodesChange]);\n\n  const cleanupOrphanedButtons = useCallback(() => {\n    connectionManager.updateState({ nodes, connections });\n    const updatedNodes = connectionManager.cleanupOrphanedButtons();\n    onNodesChange(updatedNodes);\n  }, [connectionManager, nodes, connections, onNodesChange]);\n\n  const getNodeName = useCallback((nodeId: string) => {\n    const node = nodes.find(n => n.id === nodeId);\n    if (!node) return 'Неизвестный узел';\n    \n    const typeNames = {\n      start: 'Старт',\n      command: node.data.command || 'Команда',\n      message: 'Сообщение',\n      keyboard: 'Клавиатура',\n      photo: 'Фото',\n      condition: 'Условие',\n      input: 'Ввод'\n    };\n    \n    return typeNames[node.type] || node.type;\n  }, [nodes]);\n\n  const getConnectionTypeIcon = useCallback((connection: Connection) => {\n    const sourceNode = nodes.find(n => n.id === connection.source);\n    const hasButton = sourceNode?.data.buttons.some(b => \n      b.action === 'goto' && b.target === connection.target\n    );\n    \n    return hasButton ? <Link className=\"h-4 w-4 text-green-500\" /> : <ArrowRight className=\"h-4 w-4 text-blue-500\" />;\n  }, [nodes]);\n\n  const getConfidenceColor = useCallback((confidence: number) => {\n    if (confidence >= 0.8) return 'text-green-600 bg-green-50 border-green-200';\n    if (confidence >= 0.6) return 'text-yellow-600 bg-yellow-50 border-yellow-200';\n    return 'text-red-600 bg-red-50 border-red-200';\n  }, []);\n\n  return (\n    <div className=\"w-full h-full bg-background\">\n      <Tabs defaultValue=\"connections\" className=\"w-full h-full\">\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"connections\">Связи</TabsTrigger>\n          <TabsTrigger value=\"suggestions\">Предложения</TabsTrigger>\n          <TabsTrigger value=\"settings\">Настройки</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"connections\" className=\"flex-1 mt-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Network className=\"h-5 w-5\" />\n                Управление связями\n              </CardTitle>\n              <CardDescription>\n                Всего связей: {connectionStats.total} | С кнопками: {connectionStats.withButtons} | Прямые: {connectionStats.direct}\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {/* Фильтры */}\n                <div className=\"flex flex-wrap gap-2\">\n                  <Select value={filterType} onValueChange={(value: typeof filterType) => setFilterType(value)}>\n                    <SelectTrigger className=\"w-32\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Все</SelectItem>\n                      <SelectItem value=\"button\">С кнопками</SelectItem>\n                      <SelectItem value=\"direct\">Прямые</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  \n                  <Input\n                    placeholder=\"Поиск...\"\n                    value={searchTerm}\n                    onChange={(e) => setSearchTerm(e.target.value)}\n                    className=\"flex-1 min-w-0\"\n                  />\n                </div>\n\n                {/* Статистика */}\n                <div className=\"grid grid-cols-2 gap-2\">\n                  <div className=\"flex items-center gap-2 p-2 bg-green-50 dark:bg-green-900/20 rounded\">\n                    <CheckCircle className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                    <span className=\"text-sm\">С кнопками: {connectionStats.withButtons}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded\">\n                    <ArrowRight className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                    <span className=\"text-sm\">Прямые: {connectionStats.direct}</span>\n                  </div>\n                </div>\n\n                {/* Список связей */}\n                <ScrollArea className=\"h-64\">\n                  <div className=\"space-y-2\">\n                    {filteredConnections.map((connection) => (\n                      <div\n                        key={connection.id}\n                        className={cn(\n                          \"flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all hover:bg-accent\",\n                          selectedConnectionId === connection.id && \"bg-accent border-primary\"\n                        )}\n                        onClick={() => onConnectionSelect?.(connection.id)}\n                      >\n                        <div className=\"flex items-center gap-3\">\n                          {getConnectionTypeIcon(connection)}\n                          <div className=\"flex flex-col\">\n                            <span className=\"text-sm font-medium\">\n                              {getNodeName(connection.source)} → {getNodeName(connection.target)}\n                            </span>\n                            <span className=\"text-xs text-muted-foreground\">\n                              {connection.id}\n                            </span>\n                          </div>\n                        </div>\n                        \n                        <UIButton\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            deleteConnection(connection.id);\n                          }}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </UIButton>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n\n                {/* Инструменты */}\n                <div className=\"flex flex-wrap gap-2\">\n                  <UIButton\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={syncButtonsWithConnections}\n                  >\n                    <Zap className=\"h-4 w-4 mr-2\" />\n                    Синхронизировать кнопки\n                  </UIButton>\n                  <UIButton\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={cleanupOrphanedButtons}\n                  >\n                    <Trash2 className=\"h-4 w-4 mr-2\" />\n                    Очистить лишние кнопки\n                  </UIButton>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"suggestions\" className=\"flex-1 mt-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Lightbulb className=\"h-5 w-5\" />\n                Предложения связей\n              </CardTitle>\n              <CardDescription>\n                Автоматические предложения для улучшения структуры бота\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <UIButton\n                  onClick={generateSuggestions}\n                  disabled={isGenerating}\n                  className=\"w-full\"\n                >\n                  {isGenerating ? 'Генерация...' : 'Создать предложения'}\n                </UIButton>\n\n                <ScrollArea className=\"h-64\">\n                  <div className=\"space-y-3\">\n                    {suggestions.map((suggestion) => (\n                      <div\n                        key={suggestion.id}\n                        className=\"p-3 border rounded-lg space-y-2\"\n                      >\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center gap-2\">\n                            <Target className=\"h-4 w-4\" />\n                            <span className=\"font-medium text-sm\">\n                              {getNodeName(suggestion.connection.source)} → {getNodeName(suggestion.connection.target)}\n                            </span>\n                          </div>\n                          <Badge className={cn(\"text-xs\", getConfidenceColor(suggestion.confidence))}>\n                            {Math.round(suggestion.confidence * 100)}%\n                          </Badge>\n                        </div>\n                        \n                        <p className=\"text-xs text-muted-foreground\">\n                          {suggestion.reason}\n                        </p>\n                        \n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center gap-2\">\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {suggestion.suggestedButton.text}\n                            </Badge>\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              {suggestion.suggestedButton.action}\n                            </Badge>\n                          </div>\n                          \n                          <UIButton\n                            size=\"sm\"\n                            onClick={() => applySuggestion(suggestion)}\n                            disabled={suggestion.confidence < 0.5}\n                          >\n                            <Plus className=\"h-3 w-3 mr-1\" />\n                            Применить\n                          </UIButton>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"settings\" className=\"flex-1 mt-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Settings className=\"h-5 w-5\" />\n                Настройки связей\n              </CardTitle>\n              <CardDescription>\n                Конфигурация поведения системы связей\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"space-y-1\">\n                    <Label htmlFor=\"auto-button-creation\">Автоматическое создание кнопок</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Автоматически создавать кнопки при добавлении новых связей\n                    </p>\n                  </div>\n                  <Switch\n                    id=\"auto-button-creation\"\n                    checked={autoButtonCreation}\n                    onCheckedChange={onAutoButtonCreationChange}\n                  />\n                </div>\n\n                <Separator />\n\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"space-y-1\">\n                    <Label htmlFor=\"show-advanced\">Расширенные настройки</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Показать дополнительные опции управления\n                    </p>\n                  </div>\n                  <Switch\n                    id=\"show-advanced\"\n                    checked={showAdvanced}\n                    onCheckedChange={setShowAdvanced}\n                  />\n                </div>\n\n                {showAdvanced && (\n                  <div className=\"space-y-4 p-4 bg-muted/50 rounded-lg\">\n                    <h4 className=\"font-medium\">Расширенные настройки</h4>\n                    \n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center justify-between\">\n                        <Label htmlFor=\"validate-connections\">Валидация связей</Label>\n                        <Switch id=\"validate-connections\" />\n                      </div>\n                      \n                      <div className=\"flex items-center justify-between\">\n                        <Label htmlFor=\"auto-cleanup\">Автоочистка</Label>\n                        <Switch id=\"auto-cleanup\" />\n                      </div>\n                      \n                      <div className=\"flex items-center justify-between\">\n                        <Label htmlFor=\"smart-suggestions\">Умные предложения</Label>\n                        <Switch id=\"smart-suggestions\" defaultChecked />\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                <Separator />\n\n                {/* Диагностика */}\n                <div className=\"space-y-4\">\n                  <h4 className=\"font-medium\">Диагностика</h4>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"p-3 bg-card border rounded-lg\">\n                      <div className=\"flex items-center gap-2\">\n                        <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                        <span className=\"text-sm\">Активные связи</span>\n                      </div>\n                      <p className=\"text-2xl font-bold text-green-600\">\n                        {connectionStats.total - connectionStats.orphaned}\n                      </p>\n                    </div>\n                    \n                    <div className=\"p-3 bg-card border rounded-lg\">\n                      <div className=\"flex items-center gap-2\">\n                        <XCircle className=\"h-4 w-4 text-red-500\" />\n                        <span className=\"text-sm\">Поврежденные</span>\n                      </div>\n                      <p className=\"text-2xl font-bold text-red-600\">\n                        {connectionStats.orphaned}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}","size_bytes":20700},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1419},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":971},"client/src/components/layout/flexible-layout.tsx":{"content":"import React, { useMemo } from 'react';\nimport { SimpleLayoutConfig } from './simple-layout-customizer';\nimport { ResizableHandle, ResizablePanel, ResizablePanelGroup } from '@/components/ui/resizable';\nimport { Navigation, Sidebar, Sliders, Monitor } from 'lucide-react';\nimport { useMediaQuery } from '@/hooks/use-media-query';\nimport { useIsMobile } from '@/hooks/use-mobile';\n\ninterface FlexibleLayoutProps {\n  config: SimpleLayoutConfig;\n  headerContent: React.ReactNode;\n  sidebarContent: React.ReactNode;\n  canvasContent: React.ReactNode;\n  propertiesContent: React.ReactNode;\n  codeContent?: React.ReactNode;\n  onConfigChange?: (newConfig: SimpleLayoutConfig) => void;\n  hideOnMobile?: boolean; // Скрывать боковые панели на маленьких устройствах\n  currentTab?: string; // Текущая активная вкладка\n}\n\nexport const FlexibleLayout: React.FC<FlexibleLayoutProps> = ({\n  config,\n  headerContent,\n  sidebarContent,\n  canvasContent,\n  propertiesContent,\n  codeContent,\n  onConfigChange,\n  hideOnMobile = false,\n  currentTab\n}) => {\n  // Определяем мобильное устройство (экраны меньше 1200px для тестирования)\n  const isMobile = useMediaQuery('(max-width: 1200px)');\n  const isSmallMobile = useIsMobile();\n  \n  const layoutStyles = useMemo(() => {\n    const visibleElements = config.elements.filter(el => {\n      if (!el.visible) return false;\n      \n      // Скрываем боковые панели на мобильных устройствах, если включен режим hideOnMobile\n      if (hideOnMobile && isMobile && (el.type === 'sidebar' || el.type === 'properties')) {\n        return false;\n      }\n      \n      // На очень маленьких экранах скрываем боковые панели всегда\n      if (isSmallMobile && (el.type === 'sidebar' || el.type === 'properties')) {\n        return false;\n      }\n      \n      return true;\n    });\n    \n    // Определяем элементы по позициям\n    const topElements = visibleElements.filter(el => el.position === 'top');\n    const bottomElements = visibleElements.filter(el => el.position === 'bottom');\n    const leftElements = visibleElements.filter(el => el.position === 'left');\n    const rightElements = visibleElements.filter(el => el.position === 'right');\n    const centerElements = visibleElements.filter(el => el.position === 'center');\n    \n    // Вычисляем размеры\n    const topSize = topElements.reduce((sum, el) => sum + el.size, 0);\n    const bottomSize = bottomElements.reduce((sum, el) => sum + el.size, 0);\n    const leftSize = leftElements.reduce((sum, el) => sum + el.size, 0);\n    const rightSize = rightElements.reduce((sum, el) => sum + el.size, 0);\n    \n    return {\n      container: {\n        display: 'grid',\n        height: '100vh',\n        gridTemplateRows: `${topSize > 0 ? `${topSize}rem` : ''} 1fr ${bottomSize > 0 ? `${bottomSize}rem` : ''}`.trim(),\n        gridTemplateColumns: `${leftSize > 0 ? `${leftSize}%` : ''} 1fr ${rightSize > 0 ? `${rightSize}%` : ''}`.trim(),\n        gridTemplateAreas: `\n          ${topSize > 0 ? `\"${leftSize > 0 ? 'top-left' : ''} top ${rightSize > 0 ? 'top-right' : ''}\"` : ''}\n          \"${leftSize > 0 ? 'left' : ''} center ${rightSize > 0 ? 'right' : ''}\"\n          ${bottomSize > 0 ? `\"${leftSize > 0 ? 'bottom-left' : ''} bottom ${rightSize > 0 ? 'bottom-right' : ''}\"` : ''}\n        `.trim()\n      },\n      elements: {\n        top: topSize > 0 ? { gridArea: 'top' } : undefined,\n        bottom: bottomSize > 0 ? { gridArea: 'bottom' } : undefined,\n        left: leftSize > 0 ? { gridArea: 'left' } : undefined,\n        right: rightSize > 0 ? { gridArea: 'right' } : undefined,\n        center: { gridArea: 'center' }\n      }\n    };\n  }, [config, hideOnMobile, isMobile]);\n\n  const getElementContent = (type: string) => {\n    switch (type) {\n      case 'header':\n        return headerContent;\n      case 'sidebar':\n        return sidebarContent;\n      case 'canvas':\n        return canvasContent;\n      case 'properties':\n        return propertiesContent;\n      case 'code':\n        return codeContent;\n      default:\n        return null;\n    }\n  };\n\n  const renderElement = (element: any) => {\n    const content = getElementContent(element.type);\n    if (!content) return null;\n\n    const gridArea = element.position === 'center' ? 'center' : \n                    element.position === 'top' ? 'top' :\n                    element.position === 'bottom' ? 'bottom' :\n                    element.position === 'left' ? 'left' :\n                    element.position === 'right' ? 'right' : 'center';\n\n    return (\n      <div\n        key={element.id}\n        className={`\n          ${element.type === 'header' ? 'border-b' : ''}\n          ${element.type === 'sidebar' ? 'border-r' : ''}\n          ${element.type === 'properties' ? 'border-l' : ''}\n          ${element.type === 'code' ? 'border-l' : ''}\n          ${config.compactMode ? 'text-sm' : ''}\n          border-border bg-background\n          ${config.showGrid ? 'relative' : ''}\n        `}\n        style={{\n          gridArea: gridArea,\n          minHeight: element.type === 'header' ? 'auto' : '200px',\n          overflow: 'hidden'\n        }}\n      >\n        {config.showGrid && (\n          <div className=\"absolute inset-0 opacity-5 pointer-events-none\" style={{\n            backgroundImage: `\n              linear-gradient(to right, hsl(var(--border)) 1px, transparent 1px),\n              linear-gradient(to bottom, hsl(var(--border)) 1px, transparent 1px)\n            `,\n            backgroundSize: '20px 20px'\n          }} />\n        )}\n        <div className=\"relative z-10 h-full\">\n          {content}\n        </div>\n      </div>\n    );\n  };\n\n  // Создаем упрощенный CSS Grid layout\n  const createSimpleLayout = () => {\n    const visibleElements = config.elements.filter(el => {\n      if (!el.visible) return false;\n      \n      // Скрываем боковые панели на мобильных устройствах, если включен режим hideOnMobile\n      if (hideOnMobile && isMobile && (el.type === 'sidebar' || el.type === 'properties')) {\n        return false;\n      }\n      \n      return true;\n    });\n    \n    if (visibleElements.length === 0) {\n      return (\n        <div className=\"h-full w-full flex flex-col items-center justify-center text-muted-foreground bg-background relative\">\n          <div className=\"text-center mb-8\">\n            <h3 className=\"text-lg font-medium mb-2\">\n              {hideOnMobile && isMobile ? 'Мобильный режим' : 'Все панели скрыты'}\n            </h3>\n            <p className=\"text-sm\">\n              {hideOnMobile && isMobile \n                ? 'На мобильных устройствах боковые панели скрыты для экономии места' \n                : 'Используйте кнопки ниже для показа панелей'\n              }\n            </p>\n          </div>\n          \n          {/* Кнопки управления макетом */}\n          <div className=\"flex items-center space-x-2 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 p-3\">\n            <button\n              onClick={() => {\n                if (onConfigChange) {\n                  const newConfig = { ...config };\n                  const headerElement = newConfig.elements.find(el => el.id === 'header');\n                  if (headerElement) {\n                    headerElement.visible = true;\n                    onConfigChange(newConfig);\n                  }\n                }\n              }}\n              className=\"p-3 rounded-md transition-all duration-200 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700 hover:text-blue-600 dark:hover:text-blue-400\"\n              title=\"Показать шапку\"\n            >\n              <Navigation className=\"w-5 h-5\" />\n            </button>\n            \n            <button\n              onClick={() => {\n                if (onConfigChange) {\n                  const newConfig = { ...config };\n                  const sidebarElement = newConfig.elements.find(el => el.id === 'sidebar');\n                  if (sidebarElement) {\n                    sidebarElement.visible = true;\n                    onConfigChange(newConfig);\n                  }\n                }\n              }}\n              className=\"p-3 rounded-md transition-all duration-200 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700 hover:text-blue-600 dark:hover:text-blue-400\"\n              title=\"Показать боковую панель\"\n            >\n              <Sidebar className=\"w-5 h-5\" />\n            </button>\n            \n            <button\n              onClick={() => {\n                if (onConfigChange) {\n                  const newConfig = { ...config };\n                  const canvasElement = newConfig.elements.find(el => el.id === 'canvas');\n                  if (canvasElement) {\n                    canvasElement.visible = true;\n                    onConfigChange(newConfig);\n                  }\n                }\n              }}\n              className=\"p-3 rounded-md transition-all duration-200 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700 hover:text-blue-600 dark:hover:text-blue-400\"\n              title=\"Показать холст\"\n            >\n              <Monitor className=\"w-5 h-5\" />\n            </button>\n            \n            <button\n              onClick={() => {\n                if (onConfigChange) {\n                  const newConfig = { ...config };\n                  const propertiesElement = newConfig.elements.find(el => el.id === 'properties');\n                  if (propertiesElement) {\n                    propertiesElement.visible = true;\n                    onConfigChange(newConfig);\n                  }\n                }\n              }}\n              className=\"p-3 rounded-md transition-all duration-200 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700 hover:text-blue-600 dark:hover:text-blue-400\"\n              title=\"Показать панель свойств\"\n            >\n              <Sliders className=\"w-5 h-5\" />\n            </button>\n          </div>\n        </div>\n      );\n    }\n\n    // Если есть только один элемент\n    if (visibleElements.length === 1) {\n      const singleElement = visibleElements[0];\n      return (\n        <div className=\"h-full w-full overflow-hidden bg-background\">\n          <div className=\"h-full w-full\">\n            {getElementContent(singleElement.type)}\n          </div>\n        </div>\n      );\n    }\n\n    // Определяем элементы по позициям\n    const topEl = visibleElements.find(el => el.position === 'top');\n    const bottomEl = visibleElements.find(el => el.position === 'bottom');\n    const leftEl = visibleElements.find(el => el.position === 'left');\n    const rightElements = visibleElements.filter(el => el.position === 'right');\n    const centerEl = visibleElements.find(el => el.position === 'center');\n\n    // Простая структура: top / middle / bottom\n    const rows = [];\n    const areas = [];\n    \n    // Верхняя строка\n    if (topEl) {\n      rows.push(`${topEl.size}px`);\n      areas.push('\"header header header\"');\n    }\n    \n    // Средняя строка\n    rows.push('1fr');\n    let middleArea = '\"';\n    if (leftEl) middleArea += 'sidebar ';\n    else middleArea += '. ';\n    \n    if (centerEl) middleArea += 'main ';\n    else middleArea += '. ';\n    \n    if (rightElements.length > 0) middleArea += 'properties';\n    else middleArea += '.';\n    \n    middleArea += '\"';\n    areas.push(middleArea);\n    \n    // Нижняя строка  \n    if (bottomEl) {\n      rows.push(`${bottomEl.size}px`);\n      areas.push('\"footer footer footer\"');\n    }\n\n    // Колонки\n    const columns = [];\n    if (leftEl) columns.push(`${leftEl.size}%`);\n    else columns.push('0px');\n    \n    columns.push('1fr');\n    \n    const totalRightSize = rightElements.reduce((sum, el) => sum + el.size, 0);\n    if (totalRightSize > 0) columns.push(`${totalRightSize}%`);\n    else columns.push('0px');\n\n    // Если есть только верхняя/нижняя панель и основной контент\n    if (topEl && !leftEl && rightElements.length === 0 && (centerEl || bottomEl)) {\n      // Скрываем ResizableHandle на мобильных устройствах для вкладки \"Бот\"\n      const hideResizeHandle = isMobile && currentTab === 'bot';\n      \n      return (\n        <ResizablePanelGroup direction=\"vertical\" className=\"h-full\">\n          <ResizablePanel defaultSize={isMobile ? 7 : topEl.size} minSize={isMobile ? 7 : 15} maxSize={30}>\n            <div className=\"h-full bg-background overflow-auto\">\n              {getElementContent(topEl.type)}\n            </div>\n          </ResizablePanel>\n          <ResizableHandle className=\"opacity-0 pointer-events-none h-0\" />\n          <ResizablePanel defaultSize={isMobile ? 93 : (100 - topEl.size)}>\n            <div className=\"h-full bg-background overflow-auto\">\n              {centerEl ? getElementContent(centerEl.type) : (bottomEl ? getElementContent(bottomEl.type) : null)}\n            </div>\n          </ResizablePanel>\n        </ResizablePanelGroup>\n      );\n    }\n\n    // Если есть боковые панели и основной контент\n    if ((leftEl || rightElements.length > 0) && centerEl && !topEl && !bottomEl) {\n      const leftSize = leftEl?.size || 0;\n      const totalRightSize = rightElements.reduce((sum, el) => sum + el.size, 0);\n      \n      return (\n        <ResizablePanelGroup direction=\"horizontal\" className=\"h-full\">\n          {leftEl && (\n            <>\n              <ResizablePanel \n                defaultSize={leftSize} \n                minSize={15} \n                maxSize={40}\n              >\n                <div className=\"h-full border-r border-border bg-background overflow-hidden\">\n                  {getElementContent(leftEl.type)}\n                </div>\n              </ResizablePanel>\n              <ResizableHandle withHandle />\n            </>\n          )}\n          <ResizablePanel \n            minSize={30}\n          >\n            <div className=\"h-full bg-background overflow-hidden\">\n              {getElementContent(centerEl.type)}\n            </div>\n          </ResizablePanel>\n          {rightElements.length > 0 && (\n            <>\n              <ResizableHandle withHandle />\n              <ResizablePanel \n                defaultSize={totalRightSize} \n                minSize={15} \n                maxSize={40}\n              >\n                <ResizablePanelGroup direction=\"horizontal\" className=\"h-full\">\n                  {rightElements.flatMap((rightEl, index) => [\n                    ...(index > 0 ? [<ResizableHandle key={`handle-${rightEl.id}`} withHandle />] : []),\n                    <ResizablePanel \n                      key={`panel-${rightEl.id}`}\n                      defaultSize={totalRightSize > 0 ? (rightEl.size / totalRightSize) * 100 : 50}\n                      minSize={10}\n                      maxSize={100}\n                    >\n                      <div className=\"h-full border-l border-border bg-background overflow-hidden\">\n                        {getElementContent(rightEl.type)}\n                      </div>\n                    </ResizablePanel>\n                  ])}\n                </ResizablePanelGroup>\n              </ResizablePanel>\n            </>\n          )}\n        </ResizablePanelGroup>\n      );\n    }\n\n    // Комбинированный макет (верх + боковые панели)\n    return (\n      <div className=\"h-full flex flex-col\">\n        {topEl && (\n          <div className=\"border-b border-border bg-background\" style={{ minHeight: `${topEl.size}rem` }}>\n            {getElementContent(topEl.type)}\n          </div>\n        )}\n        <div className=\"flex-1 min-h-0\">\n          <ResizablePanelGroup direction=\"horizontal\" className=\"h-full\">\n            {leftEl && (\n              <>\n                <ResizablePanel \n                  defaultSize={leftEl.size} \n                  minSize={15} \n                  maxSize={40}\n                >\n                  <div className=\"h-full border-r border-border bg-background overflow-hidden\">\n                    {getElementContent(leftEl.type)}\n                  </div>\n                </ResizablePanel>\n                <ResizableHandle withHandle />\n              </>\n            )}\n            <ResizablePanel \n              minSize={30}\n            >\n              <div className=\"h-full bg-background overflow-hidden\">\n                {centerEl ? getElementContent(centerEl.type) : null}\n              </div>\n            </ResizablePanel>\n            {rightElements.length > 0 && (\n              <>\n                <ResizableHandle withHandle />\n                <ResizablePanel \n                  defaultSize={totalRightSize} \n                  minSize={15} \n                  maxSize={60}\n                >\n                  <ResizablePanelGroup direction=\"horizontal\" className=\"h-full\">\n                    {rightElements.flatMap((rightEl, index) => [\n                      ...(index > 0 ? [<ResizableHandle key={`handle-${rightEl.id}`} withHandle />] : []),\n                      <ResizablePanel \n                        key={`panel-${rightEl.id}`}\n                        defaultSize={totalRightSize > 0 ? (rightEl.size / totalRightSize) * 100 : 50}\n                        minSize={10}\n                        maxSize={100}\n                      >\n                        <div className=\"h-full border-l border-border bg-background overflow-hidden\">\n                          {getElementContent(rightEl.type)}\n                        </div>\n                      </ResizablePanel>\n                    ])}\n                  </ResizablePanelGroup>\n                </ResizablePanel>\n              </>\n            )}\n          </ResizablePanelGroup>\n        </div>\n        {bottomEl && (\n          <div className=\"border-t border-border bg-background\" style={{ minHeight: `${bottomEl.size}px` }}>\n            {getElementContent(bottomEl.type)}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"h-screen overflow-hidden\">\n      {createSimpleLayout()}\n    </div>\n  );\n};\n\nexport default FlexibleLayout;","size_bytes":18657},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"recreate_fixed_template.js":{"content":"const { seedDefaultTemplates } = require('./server/seed-templates.ts');\nconst { createPostgreSQLStorage } = require('./server/storage.ts');\n\nasync function recreateTemplates() {\n  try {\n    console.log('Создаем подключение к базе данных...');\n    const storage = createPostgreSQLStorage();\n    \n    console.log('Удаляем старые шаблоны VProgulke Bot...');\n    await storage.db.delete(storage.botTemplatesTable).where(\n      storage.sql`name LIKE '%VProgulke Bot%'`\n    );\n    \n    console.log('Пересоздаем шаблоны с исправленными полями...');\n    await seedDefaultTemplates(storage, true);\n    \n    console.log('✅ Шаблоны успешно пересозданы!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Ошибка при пересоздании шаблонов:', error);\n    process.exit(1);\n  }\n}\n\nrecreateTemplates();","size_bytes":944},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"client/src/hooks/use-bot-editor.tsx":{"content":"import { useState, useCallback, useEffect, useRef } from 'react';\nimport { Node, Connection, Button, BotData } from '@shared/schema';\nimport { applyTemplateLayout } from '@/utils/hierarchical-layout';\n\ninterface HistoryState {\n  nodes: Node[];\n  connections: Connection[];\n}\n\nexport function useBotEditor(initialData?: BotData) {\n  const [nodes, setNodes] = useState<Node[]>(initialData?.nodes || []);\n  const [connections, setConnections] = useState<Connection[]>(initialData?.connections || []);\n  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);\n  \n  // Состояние для отслеживания перетаскивания узлов\n  const [isNodeBeingDragged, setIsNodeBeingDragged] = useState(false);\n  \n  // История для undo/redo\n  const [history, setHistory] = useState<HistoryState[]>([]);\n  const [historyIndex, setHistoryIndex] = useState(-1);\n  const isRedoUndoActionRef = useRef(false);\n\n  const selectedNode = nodes.find(node => node.id === selectedNodeId) || null;\n\n  // Сохранить текущее состояние в историю\n  const saveToHistory = useCallback(() => {\n    if (isRedoUndoActionRef.current) {\n      return; // Не сохраняем состояние при undo/redo операциях\n    }\n    \n    const currentState: HistoryState = {\n      nodes: JSON.parse(JSON.stringify(nodes)),\n      connections: JSON.parse(JSON.stringify(connections))\n    };\n    \n    setHistory(prev => {\n      // Если мы не в конце истории, удаляем все состояния после текущего индекса\n      const newHistory = prev.slice(0, historyIndex + 1);\n      newHistory.push(currentState);\n      \n      // Ограничиваем размер истории (максимум 50 состояний)\n      if (newHistory.length > 50) {\n        return newHistory.slice(-50);\n      }\n      \n      return newHistory;\n    });\n    \n    setHistoryIndex(prev => Math.min(prev + 1, 49));\n  }, [nodes, connections, historyIndex, history.length]);\n\n  // Отменить последнее действие\n  const undo = useCallback(() => {\n    if (historyIndex > 0) {\n      const prevIndex = historyIndex - 1;\n      const prevState = history[prevIndex];\n      \n      isRedoUndoActionRef.current = true;\n      setHistoryIndex(prevIndex);\n      setSelectedNodeId(null);\n      \n      // Обновляем nodes и connections в следующем тике, чтобы избежать срабатывания useEffect\n      setTimeout(() => {\n        setNodes(prevState.nodes);\n        setConnections(prevState.connections);\n        // Сбрасываем флаг после обновления состояния\n        setTimeout(() => { isRedoUndoActionRef.current = false; }, 100);\n      }, 0);\n    }\n  }, [history, historyIndex]);\n\n  // Повторить отмененное действие\n  const redo = useCallback(() => {\n    if (historyIndex < history.length - 1) {\n      const nextIndex = historyIndex + 1;\n      const nextState = history[nextIndex];\n      \n      isRedoUndoActionRef.current = true;\n      setHistoryIndex(nextIndex);\n      setSelectedNodeId(null);\n      \n      // Обновляем nodes и connections в следующем тике, чтобы избежать срабатывания useEffect\n      setTimeout(() => {\n        setNodes(nextState.nodes);\n        setConnections(nextState.connections);\n        // Сбрасываем флаг после обновления состояния\n        setTimeout(() => { isRedoUndoActionRef.current = false; }, 100);\n      }, 0);\n    }\n  }, [history, historyIndex]);\n\n  // Проверяем, доступны ли операции undo/redo\n  const canUndo = historyIndex > 0;\n  const canRedo = historyIndex < history.length - 1;\n\n  // Инициализируем историю при первой загрузке\n  useEffect(() => {\n    if (history.length === 0 && (nodes.length > 0 || connections.length > 0)) {\n      const initialState: HistoryState = {\n        nodes: JSON.parse(JSON.stringify(nodes)),\n        connections: JSON.parse(JSON.stringify(connections))\n      };\n      setHistory([initialState]);\n      setHistoryIndex(0);\n    }\n  }, [nodes, connections, history.length]);\n\n  // Сохраняем состояние в историю при изменении nodes или connections\n  useEffect(() => {\n    if (!isRedoUndoActionRef.current && history.length > 0) {\n      const timeoutId = setTimeout(saveToHistory, 300); // Увеличен дебаунс для избежания частых сохранений\n      return () => clearTimeout(timeoutId);\n    }\n  }, [nodes, connections, saveToHistory, history.length]);\n\n  const addNode = useCallback((node: Node) => {\n    setNodes(prev => [...prev, node]);\n  }, []);\n\n  const updateNode = useCallback((nodeId: string, updates: Partial<Node>) => {\n    setNodes(prev => prev.map(node => \n      node.id === nodeId ? { ...node, ...updates } : node\n    ));\n  }, []);\n\n  const deleteNode = useCallback((nodeId: string) => {\n    setNodes(prev => prev.filter(node => node.id !== nodeId));\n    setConnections(prev => prev.filter(conn => \n      conn.source !== nodeId && conn.target !== nodeId\n    ));\n    if (selectedNodeId === nodeId) {\n      setSelectedNodeId(null);\n    }\n  }, [selectedNodeId]);\n\n  const addConnection = useCallback((connection: Connection) => {\n    setConnections(prev => [...prev, connection]);\n  }, []);\n\n  const deleteConnection = useCallback((connectionId: string) => {\n    setConnections(prev => prev.filter(conn => conn.id !== connectionId));\n  }, []);\n\n  const updateConnection = useCallback((connectionId: string, updates: Partial<Connection>) => {\n    setConnections(prev => prev.map(conn => \n      conn.id === connectionId ? { ...conn, ...updates } : conn\n    ));\n  }, []);\n\n  const updateNodeData = useCallback((nodeId: string, data: Partial<Node['data']>) => {\n    setNodes(prev => prev.map(node => \n      node.id === nodeId \n        ? { ...node, data: { ...node.data, ...data } }\n        : node\n    ));\n  }, []);\n\n  const addButton = useCallback((nodeId: string, button: Button) => {\n    setNodes(prev => prev.map(node => \n      node.id === nodeId \n        ? { \n            ...node, \n            data: { \n              ...node.data, \n              buttons: [...(node.data.buttons || []), button] \n            } \n          }\n        : node\n    ));\n  }, []);\n\n  const updateButton = useCallback((nodeId: string, buttonId: string, updates: Partial<Button>) => {\n    setNodes(prev => prev.map(node => \n      node.id === nodeId \n        ? { \n            ...node, \n            data: { \n              ...node.data, \n              buttons: (node.data.buttons || []).map(btn => \n                btn.id === buttonId ? { ...btn, ...updates } : btn\n              )\n            } \n          }\n        : node\n    ));\n  }, []);\n\n  const deleteButton = useCallback((nodeId: string, buttonId: string) => {\n    setNodes(prev => prev.map(node => \n      node.id === nodeId \n        ? { \n            ...node, \n            data: { \n              ...node.data, \n              buttons: (node.data.buttons || []).filter(btn => btn.id !== buttonId)\n            } \n          }\n        : node\n    ));\n  }, []);\n\n  const updateNodes = useCallback((newNodes: Node[]) => {\n    setNodes(newNodes);\n  }, []);\n\n  // Функция нормализации данных узла (клиентская версия серверной нормализации)\n  const normalizeNodeData = useCallback((node: Node): Node => {\n    if (!node || !node.type) return node;\n\n    const normalizedData = { ...node.data };\n\n    // Дефолтные поля для всех узлов\n    const defaultFields = {\n      buttons: [],\n      messageText: '',\n      keyboardType: 'none',\n      oneTimeKeyboard: false,\n      resizeKeyboard: true,\n      markdown: false,\n      isPrivateOnly: false,\n      adminOnly: false,\n      requiresAuth: false,\n      showInMenu: true,\n      enableStatistics: true\n    };\n\n    // Применяем дефолтные поля\n    for (const [key, value] of Object.entries(defaultFields)) {\n      if ((normalizedData as any)[key] === undefined) {\n        (normalizedData as any)[key] = value;\n      }\n    }\n\n    // Специфичные поля для команд start и command\n    if (node.type === 'start' || node.type === 'command') {\n      if (!normalizedData.command) {\n        normalizedData.command = node.type === 'start' ? '/start' : '/command';\n      }\n      if (!normalizedData.description) {\n        normalizedData.description = node.type === 'start' ? 'Запустить бота' : 'Команда бота';\n      }\n    }\n\n    return {\n      ...node,\n      data: normalizedData\n    };\n  }, []);\n\n  const setBotData = useCallback((\n    botData: BotData, \n    templateName?: string, \n    nodeSizes?: Map<string, { width: number; height: number }>,\n    skipLayout?: boolean // Новый параметр для отключения автоматического layout\n  ) => {\n    // Устанавливаем данные бота\n    \n    // Нормализуем узлы перед применением компоновки\n    const normalizedNodes = (botData.nodes || []).map(normalizeNodeData);\n    \n    // Применяем иерархическую компоновку только если не отключена\n    const finalNodes = skipLayout \n      ? normalizedNodes \n      : applyTemplateLayout(normalizedNodes, botData.connections || [], templateName, nodeSizes);\n    \n    setNodes(finalNodes);\n    setConnections(botData.connections || []);\n    setSelectedNodeId(null); // Сбрасываем выбранный узел\n    \n    // setBotData завершен\n  }, [normalizeNodeData]);\n\n  const duplicateNode = useCallback((nodeId: string) => {\n    const nodeToDuplicate = nodes.find(node => node.id === nodeId);\n    if (!nodeToDuplicate) return;\n\n    // Создаем копию узла с новым ID и смещенной позицией\n    const duplicatedNode: Node = {\n      ...JSON.parse(JSON.stringify(nodeToDuplicate)), // Глубокое копирование\n      id: `${nodeId}_copy_${Date.now()}`, // Новый уникальный ID\n      position: {\n        x: nodeToDuplicate.position.x + 50, // Смещение вправо\n        y: nodeToDuplicate.position.y + 50  // Смещение вниз\n      }\n    };\n\n    setNodes(prev => [...prev, duplicatedNode]);\n    setSelectedNodeId(duplicatedNode.id); // Выбираем скопированный узел\n  }, [nodes]);\n\n  const duplicateNodes = useCallback((nodeIds: string[]) => {\n    const nodesToDuplicate = nodes.filter(node => nodeIds.includes(node.id));\n    if (nodesToDuplicate.length === 0) return;\n\n    const idMapping: { [oldId: string]: string } = {};\n    const duplicatedNodes: Node[] = [];\n\n    // Создаем копии узлов с новыми ID\n    nodesToDuplicate.forEach(node => {\n      const newId = `${node.id}_copy_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n      idMapping[node.id] = newId;\n\n      const duplicatedNode: Node = {\n        ...JSON.parse(JSON.stringify(node)), // Глубокое копирование\n        id: newId,\n        position: {\n          x: node.position.x + 50, // Смещение вправо\n          y: node.position.y + 50  // Смещение вниз\n        }\n      };\n\n      duplicatedNodes.push(duplicatedNode);\n    });\n\n    // Копируем связи между дублированными узлами\n    const duplicatedConnections: Connection[] = [];\n    connections.forEach(connection => {\n      const sourceId = idMapping[connection.source];\n      const targetId = idMapping[connection.target];\n      \n      // Создаем связь только если оба узла были скопированы\n      if (sourceId && targetId) {\n        const duplicatedConnection: Connection = {\n          ...JSON.parse(JSON.stringify(connection)), // Глубокое копирование\n          id: `${connection.id}_copy_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n          source: sourceId,\n          target: targetId\n        };\n        duplicatedConnections.push(duplicatedConnection);\n      }\n    });\n\n    setNodes(prev => [...prev, ...duplicatedNodes]);\n    setConnections(prev => [...prev, ...duplicatedConnections]);\n    \n    // Выбираем первый скопированный узел\n    if (duplicatedNodes.length > 0) {\n      setSelectedNodeId(duplicatedNodes[0].id);\n    }\n  }, [nodes, connections]);\n\n  const getBotData = useCallback((): BotData => ({\n    nodes,\n    connections\n  }), [nodes, connections]);\n\n  // Копирование элементов в буфер обмена для вставки в другие проекты\n  const copyToClipboard = useCallback((nodeIds: string[]) => {\n    const nodesToCopy = nodes.filter(node => nodeIds.includes(node.id));\n    const connectionsToCopy = connections.filter(conn => \n      nodeIds.includes(conn.source) && nodeIds.includes(conn.target)\n    );\n\n    const clipboardData = {\n      nodes: nodesToCopy,\n      connections: connectionsToCopy,\n      timestamp: Date.now(),\n      projectType: 'telegram-bot'\n    };\n\n    // Сохраняем в localStorage для межпроектного буфера обмена\n    localStorage.setItem('bot-clipboard', JSON.stringify(clipboardData));\n    \n    return clipboardData;\n  }, [nodes, connections]);\n\n  // Вставка элементов из буфера обмена\n  const pasteFromClipboard = useCallback((offsetX: number = 100, offsetY: number = 100) => {\n    try {\n      const clipboardDataStr = localStorage.getItem('bot-clipboard');\n      if (!clipboardDataStr) return false;\n\n      const clipboardData = JSON.parse(clipboardDataStr);\n      \n      // Проверяем что данные корректны и не слишком старые (24 часа)\n      if (!clipboardData.nodes || !Array.isArray(clipboardData.nodes) || \n          !clipboardData.timestamp || Date.now() - clipboardData.timestamp > 24 * 60 * 60 * 1000) {\n        return false;\n      }\n\n      const idMapping: { [oldId: string]: string } = {};\n      const pastedNodes: Node[] = [];\n\n      // Создаем новые ID для всех узлов\n      clipboardData.nodes.forEach((node: Node) => {\n        const newId = `${node.id}_paste_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n        idMapping[node.id] = newId;\n\n        const pastedNode: Node = {\n          ...JSON.parse(JSON.stringify(node)),\n          id: newId,\n          position: {\n            x: node.position.x + offsetX,\n            y: node.position.y + offsetY\n          }\n        };\n\n        pastedNodes.push(pastedNode);\n      });\n\n      // Создаем новые связи с обновленными ID\n      const pastedConnections: Connection[] = [];\n      clipboardData.connections.forEach((connection: Connection) => {\n        const sourceId = idMapping[connection.source];\n        const targetId = idMapping[connection.target];\n        \n        if (sourceId && targetId) {\n          const pastedConnection: Connection = {\n            ...JSON.parse(JSON.stringify(connection)),\n            id: `${connection.id}_paste_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n            source: sourceId,\n            target: targetId\n          };\n          pastedConnections.push(pastedConnection);\n        }\n      });\n\n      // Добавляем элементы на холст\n      setNodes(prev => [...prev, ...pastedNodes]);\n      setConnections(prev => [...prev, ...pastedConnections]);\n\n      // Выбираем первый вставленный узел\n      if (pastedNodes.length > 0) {\n        setSelectedNodeId(pastedNodes[0].id);\n      }\n\n      return true;\n    } catch (error) {\n      console.error('Ошибка при вставке из буфера обмена:', error);\n      return false;\n    }\n  }, []);\n\n  // Проверка наличия данных в буфере обмена\n  const hasClipboardData = useCallback(() => {\n    try {\n      const clipboardDataStr = localStorage.getItem('bot-clipboard');\n      if (!clipboardDataStr) return false;\n\n      const clipboardData = JSON.parse(clipboardDataStr);\n      return !!(clipboardData.nodes && Array.isArray(clipboardData.nodes) && \n               clipboardData.nodes.length > 0 && clipboardData.timestamp &&\n               Date.now() - clipboardData.timestamp <= 24 * 60 * 60 * 1000);\n    } catch {\n      return false;\n    }\n  }, []);\n\n  return {\n    nodes,\n    connections,\n    selectedNode,\n    selectedNodeId,\n    setSelectedNodeId,\n    addNode,\n    updateNode,\n    deleteNode,\n    duplicateNode,\n    duplicateNodes,\n    addConnection,\n    deleteConnection,\n    updateConnection,\n    updateNodeData,\n    addButton,\n    updateButton,\n    deleteButton,\n    updateNodes,\n    setBotData,\n    getBotData,\n    undo,\n    redo,\n    canUndo,\n    canRedo,\n    copyToClipboard,\n    pasteFromClipboard,\n    hasClipboardData,\n    isNodeBeingDragged,\n    setIsNodeBeingDragged\n  };\n}\n","size_bytes":17221},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/components/ui/canvas-node.tsx":{"content":"import { Node } from '@/types/bot';\nimport { cn } from '@/lib/utils';\nimport { useState, useRef, useEffect } from 'react';\n\n// Function to parse and render formatted text\nfunction parseFormattedText(text: string, formatMode?: string, markdown?: boolean): JSX.Element {\n  if (!text) return <span>{text}</span>;\n  \n  // Убрали debug логи для улучшения производительности\n  \n  // Remove HTML tags and replace with styled spans\n  const parseHTML = (htmlText: string): JSX.Element[] => {\n    const parts: JSX.Element[] = [];\n    let remaining = htmlText;\n    let key = 0;\n    \n    while (remaining.length > 0) {\n      // Bold text (both <b> and <strong> tags)\n      const boldMatch = remaining.match(/^(.*?)<(?:b|strong)>(.*?)<\\/(?:b|strong)>(.*)/);\n      if (boldMatch) {\n        if (boldMatch[1]) parts.push(<span key={key++}>{boldMatch[1]}</span>);\n        parts.push(<strong key={key++} className=\"font-bold\">{boldMatch[2]}</strong>);\n        remaining = boldMatch[3];\n        continue;\n      }\n      \n      // Italic text (both <i> and <em> tags)\n      const italicMatch = remaining.match(/^(.*?)<(?:i|em)>(.*?)<\\/(?:i|em)>(.*)/);\n      if (italicMatch) {\n        if (italicMatch[1]) parts.push(<span key={key++}>{italicMatch[1]}</span>);\n        parts.push(<em key={key++} className=\"italic\">{italicMatch[2]}</em>);\n        remaining = italicMatch[3];\n        continue;\n      }\n      \n      // Underline text\n      const underlineMatch = remaining.match(/^(.*?)<u>(.*?)<\\/u>(.*)/);\n      if (underlineMatch) {\n        if (underlineMatch[1]) parts.push(<span key={key++}>{underlineMatch[1]}</span>);\n        parts.push(<span key={key++} className=\"underline\">{underlineMatch[2]}</span>);\n        remaining = underlineMatch[3];\n        continue;\n      }\n      \n      // Strikethrough text\n      const strikeMatch = remaining.match(/^(.*?)<s>(.*?)<\\/s>(.*)/);\n      if (strikeMatch) {\n        if (strikeMatch[1]) parts.push(<span key={key++}>{strikeMatch[1]}</span>);\n        parts.push(<span key={key++} className=\"line-through\">{strikeMatch[2]}</span>);\n        remaining = strikeMatch[3];\n        continue;\n      }\n      \n      // Code text\n      const codeMatch = remaining.match(/^(.*?)<code>(.*?)<\\/code>(.*)/);\n      if (codeMatch) {\n        if (codeMatch[1]) parts.push(<span key={key++}>{codeMatch[1]}</span>);\n        parts.push(<code key={key++} className=\"bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-xs font-mono\">{codeMatch[2]}</code>);\n        remaining = codeMatch[3];\n        continue;\n      }\n      \n      // No more matches, add remaining text\n      parts.push(<span key={key++}>{remaining}</span>);\n      break;\n    }\n    \n    return parts;\n  };\n  \n  // Parse Markdown format\n  const parseMarkdown = (mdText: string): JSX.Element[] => {\n    const parts: JSX.Element[] = [];\n    let remaining = mdText;\n    let key = 0;\n    \n    while (remaining.length > 0) {\n      // Bold text\n      const boldMatch = remaining.match(/^(.*?)\\*\\*(.*?)\\*\\*(.*)/);\n      if (boldMatch) {\n        if (boldMatch[1]) parts.push(<span key={key++}>{boldMatch[1]}</span>);\n        parts.push(<strong key={key++} className=\"font-bold\">{boldMatch[2]}</strong>);\n        remaining = boldMatch[3];\n        continue;\n      }\n      \n      // Italic text\n      const italicMatch = remaining.match(/^(.*?)\\*(.*?)\\*(.*)/);\n      if (italicMatch) {\n        if (italicMatch[1]) parts.push(<span key={key++}>{italicMatch[1]}</span>);\n        parts.push(<em key={key++} className=\"italic\">{italicMatch[2]}</em>);\n        remaining = italicMatch[3];\n        continue;\n      }\n      \n      // Underline text\n      const underlineMatch = remaining.match(/^(.*?)__(.*?)__(.*)/);\n      if (underlineMatch) {\n        if (underlineMatch[1]) parts.push(<span key={key++}>{underlineMatch[1]}</span>);\n        parts.push(<span key={key++} className=\"underline\">{underlineMatch[2]}</span>);\n        remaining = underlineMatch[3];\n        continue;\n      }\n      \n      // Strikethrough text\n      const strikeMatch = remaining.match(/^(.*?)~~(.*?)~~(.*)/);\n      if (strikeMatch) {\n        if (strikeMatch[1]) parts.push(<span key={key++}>{strikeMatch[1]}</span>);\n        parts.push(<span key={key++} className=\"line-through\">{strikeMatch[2]}</span>);\n        remaining = strikeMatch[3];\n        continue;\n      }\n      \n      // Code text\n      const codeMatch = remaining.match(/^(.*?)`(.*?)`(.*)/);\n      if (codeMatch) {\n        if (codeMatch[1]) parts.push(<span key={key++}>{codeMatch[1]}</span>);\n        parts.push(<code key={key++} className=\"bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-xs font-mono\">{codeMatch[2]}</code>);\n        remaining = codeMatch[3];\n        continue;\n      }\n      \n      // No more matches, add remaining text\n      parts.push(<span key={key++}>{remaining}</span>);\n      break;\n    }\n    \n    return parts;\n  };\n  \n  // Determine formatting mode based on node properties\n  let shouldUseHTML = false;\n  \n  if (formatMode === 'html') {\n    shouldUseHTML = true;\n  } else if (formatMode === 'markdown') {\n    shouldUseHTML = false;\n  } else if (formatMode === 'none') {\n    // For 'none' mode, check if text contains HTML tags and parse them\n    // Look for common HTML tags used in formatting\n    const hasHTMLTags = text.includes('<b>') || text.includes('<i>') || text.includes('<u>') || \n                       text.includes('<s>') || text.includes('<code>') || text.includes('<strong>') || \n                       text.includes('<em>') || text.includes('<a href');\n    shouldUseHTML = hasHTMLTags;\n  } else if (markdown === true) {\n    // Legacy support for 'markdown' property\n    shouldUseHTML = false;\n  } else {\n    // Auto-detect: if text contains HTML formatting tags, use HTML parser\n    const hasHTMLTags = text.includes('<b>') || text.includes('<i>') || text.includes('<u>') || \n                       text.includes('<s>') || text.includes('<code>') || text.includes('<strong>') || \n                       text.includes('<em>') || text.includes('<a href');\n    shouldUseHTML = hasHTMLTags;\n  }\n  \n  \n  const parsedParts = shouldUseHTML ? parseHTML(text) : parseMarkdown(text);\n  \n  return <span>{parsedParts}</span>;\n}\n\ninterface CanvasNodeProps {\n  node: Node;\n  isSelected?: boolean;\n  onClick?: () => void;\n  onDelete?: () => void;\n  onDuplicate?: () => void;\n  onMove?: (position: { x: number; y: number }) => void;\n  onConnectionStart?: (nodeId: string, handle: 'source' | 'target') => void;\n  connectionStart?: {\n    nodeId: string;\n    handle: 'source' | 'target';\n  } | null;\n  zoom?: number;\n  pan?: { x: number; y: number };\n  setIsNodeBeingDragged?: (isDragging: boolean) => void;\n  onSizeChange?: (nodeId: string, size: { width: number; height: number }) => void;\n}\n\nconst nodeIcons = {\n  start: 'fas fa-play',\n  message: 'fas fa-comment',\n  photo: 'fas fa-image',\n  video: 'fas fa-video',\n  audio: 'fas fa-music',\n  document: 'fas fa-file-alt',\n  keyboard: 'fas fa-keyboard',\n  command: 'fas fa-terminal',\n  sticker: 'fas fa-laugh',\n  voice: 'fas fa-microphone',\n  animation: 'fas fa-film',\n  location: 'fas fa-map-marker-alt',\n  contact: 'fas fa-address-book',\n  pin_message: 'fas fa-thumbtack',\n  unpin_message: 'fas fa-times',\n  delete_message: 'fas fa-trash',\n  ban_user: 'fas fa-ban',\n  unban_user: 'fas fa-user-check',\n  mute_user: 'fas fa-volume-mute',\n  unmute_user: 'fas fa-volume-up',\n  kick_user: 'fas fa-user-times',\n  promote_user: 'fas fa-crown',\n  demote_user: 'fas fa-user-minus',\n  admin_rights: 'fas fa-user-shield'\n};\n\nconst nodeColors = {\n  start: 'bg-gradient-to-br from-emerald-50 to-green-100 dark:from-emerald-900/30 dark:to-green-900/30 text-emerald-600 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800',\n  message: 'bg-gradient-to-br from-blue-50 to-sky-100 dark:from-blue-900/30 dark:to-sky-900/30 text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-800',\n  photo: 'bg-gradient-to-br from-purple-50 to-violet-100 dark:from-purple-900/30 dark:to-violet-900/30 text-purple-600 dark:text-purple-400 border border-purple-200 dark:border-purple-800',\n  video: 'bg-gradient-to-br from-rose-50 to-pink-100 dark:from-rose-900/30 dark:to-pink-900/30 text-rose-600 dark:text-rose-400 border border-rose-200 dark:border-rose-800',\n  audio: 'bg-gradient-to-br from-orange-50 to-amber-100 dark:from-orange-900/30 dark:to-amber-900/30 text-orange-600 dark:text-orange-400 border border-orange-200 dark:border-orange-800',\n  document: 'bg-gradient-to-br from-teal-50 to-cyan-100 dark:from-teal-900/30 dark:to-cyan-900/30 text-teal-600 dark:text-teal-400 border border-teal-200 dark:border-teal-800',\n  keyboard: 'bg-gradient-to-br from-amber-50 to-yellow-100 dark:from-amber-900/30 dark:to-yellow-900/30 text-amber-600 dark:text-amber-400 border border-amber-200 dark:border-amber-800',\n  command: 'bg-gradient-to-br from-indigo-50 to-blue-100 dark:from-indigo-900/30 dark:to-blue-900/30 text-indigo-600 dark:text-indigo-400 border border-indigo-200 dark:border-indigo-800',\n  sticker: 'bg-gradient-to-br from-pink-50 to-fuchsia-100 dark:from-pink-900/30 dark:to-fuchsia-900/30 text-pink-600 dark:text-pink-400 border border-pink-200 dark:border-pink-800',\n  voice: 'bg-gradient-to-br from-emerald-50 to-teal-100 dark:from-emerald-900/30 dark:to-teal-900/30 text-emerald-600 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800',\n  animation: 'bg-gradient-to-br from-yellow-50 to-orange-100 dark:from-yellow-900/30 dark:to-orange-900/30 text-yellow-600 dark:text-yellow-400 border border-yellow-200 dark:border-yellow-800',\n  location: 'bg-gradient-to-br from-green-50 to-lime-100 dark:from-green-900/30 dark:to-lime-900/30 text-green-600 dark:text-green-400 border border-green-200 dark:border-green-800',\n  contact: 'bg-gradient-to-br from-sky-50 to-blue-100 dark:from-sky-900/30 dark:to-blue-900/30 text-sky-600 dark:text-sky-400 border border-sky-200 dark:border-sky-800',\n  pin_message: 'bg-gradient-to-br from-cyan-100 to-blue-200 dark:from-cyan-900/40 dark:to-blue-800/40 text-cyan-700 dark:text-cyan-300 border-2 border-cyan-300 dark:border-cyan-700/50 shadow-lg shadow-cyan-500/20',\n  unpin_message: 'bg-gradient-to-br from-slate-100 to-gray-200 dark:from-slate-900/40 dark:to-gray-800/40 text-slate-700 dark:text-slate-300 border-2 border-slate-300 dark:border-slate-700/50 shadow-lg shadow-slate-500/20',\n  delete_message: 'bg-gradient-to-br from-red-100 to-rose-200 dark:from-red-900/40 dark:to-rose-800/40 text-red-700 dark:text-red-300 border-2 border-red-300 dark:border-red-700/50 shadow-lg shadow-red-500/20',\n  ban_user: 'bg-gradient-to-br from-red-100 to-red-200 dark:from-red-900/40 dark:to-red-800/40 text-red-700 dark:text-red-300 border-2 border-red-300 dark:border-red-700/50 shadow-lg shadow-red-500/20',\n  unban_user: 'bg-gradient-to-br from-emerald-100 to-green-200 dark:from-emerald-900/40 dark:to-green-800/40 text-emerald-700 dark:text-emerald-300 border-2 border-emerald-300 dark:border-emerald-700/50 shadow-lg shadow-emerald-500/20',\n  mute_user: 'bg-gradient-to-br from-orange-100 to-amber-200 dark:from-orange-900/40 dark:to-amber-800/40 text-orange-700 dark:text-orange-300 border-2 border-orange-300 dark:border-orange-700/50 shadow-lg shadow-orange-500/20',\n  unmute_user: 'bg-gradient-to-br from-sky-100 to-blue-200 dark:from-sky-900/40 dark:to-blue-800/40 text-sky-700 dark:text-sky-300 border-2 border-sky-300 dark:border-sky-700/50 shadow-lg shadow-sky-500/20',\n  kick_user: 'bg-gradient-to-br from-rose-100 to-pink-200 dark:from-rose-900/40 dark:to-pink-800/40 text-rose-700 dark:text-rose-300 border-2 border-rose-300 dark:border-rose-700/50 shadow-lg shadow-rose-500/20',\n  promote_user: 'bg-gradient-to-br from-yellow-100 to-amber-200 dark:from-yellow-900/40 dark:to-amber-800/40 text-yellow-700 dark:text-yellow-300 border-2 border-yellow-300 dark:border-yellow-700/50 shadow-lg shadow-yellow-500/20',\n  demote_user: 'bg-gradient-to-br from-slate-100 to-gray-200 dark:from-slate-900/40 dark:to-gray-800/40 text-slate-700 dark:text-slate-300 border-2 border-slate-300 dark:border-slate-700/50 shadow-lg shadow-slate-500/20',\n  admin_rights: 'bg-gradient-to-br from-violet-100 to-purple-200 dark:from-violet-900/40 dark:to-purple-800/40 text-violet-800 dark:text-violet-200 border-2 border-violet-300 dark:border-violet-700/50 shadow-xl shadow-violet-500/25 ring-1 ring-violet-400/30 dark:ring-violet-600/30'\n};\n\nexport function CanvasNode({ node, isSelected, onClick, onDelete, onDuplicate, onMove, onConnectionStart, connectionStart, zoom = 100, pan = { x: 0, y: 0 }, setIsNodeBeingDragged, onSizeChange }: CanvasNodeProps) {\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });\n  const nodeRef = useRef<HTMLDivElement>(null);\n  \n  // Touch состояние для мобильного перемещения элементов\n  const [isTouchDragging, setIsTouchDragging] = useState(false);\n  const [touchOffset, setTouchOffset] = useState({ x: 0, y: 0 });\n  const [touchStartTime, setTouchStartTime] = useState(0);\n  const [touchStartPos, setTouchStartPos] = useState({ x: 0, y: 0 });\n  const [touchMoved, setTouchMoved] = useState(false);\n\n  const handleMouseDown = (e: React.MouseEvent) => {\n    if (!onMove) return;\n    \n    // Не запускать драг если кликнули по кнопке удаления\n    if ((e.target as HTMLElement).closest('button')) return;\n    \n    // Находим канвас (родительский элемент трансформируемого контейнера)\n    const transformedContainer = nodeRef.current?.parentElement;\n    const canvas = transformedContainer?.parentElement;\n    \n    if (canvas) {\n      const canvasRect = canvas.getBoundingClientRect();\n      const zoomFactor = zoom / 100;\n      \n      // Рассчитываем смещение в канвасных координатах\n      const screenX = e.clientX - canvasRect.left;\n      const screenY = e.clientY - canvasRect.top;\n      \n      const canvasX = (screenX - pan.x) / zoomFactor;\n      const canvasY = (screenY - pan.y) / zoomFactor;\n      \n      setDragOffset({\n        x: canvasX - node.position.x,\n        y: canvasY - node.position.y\n      });\n      setIsDragging(true);\n      // Уведомляем глобальное состояние о начале перетаскивания\n      if (setIsNodeBeingDragged) {\n        setIsNodeBeingDragged(true);\n      }\n    }\n    \n    // Предотвращаем выделение текста при перетаскивании\n    e.preventDefault();\n  };\n\n  const handleMouseMove = (e: MouseEvent) => {\n    if (!isDragging || !onMove) return;\n    \n    // Находим канвас (родительский элемент трансформируемого контейнера)\n    const transformedContainer = nodeRef.current?.parentElement;\n    const canvas = transformedContainer?.parentElement;\n    \n    if (canvas && transformedContainer) {\n      const canvasRect = canvas.getBoundingClientRect();\n      \n      // Получаем экранные координаты мыши относительно канваса\n      const screenX = e.clientX - canvasRect.left;\n      const screenY = e.clientY - canvasRect.top;\n      \n      // Преобразуем экранные координаты в координаты канваса с учетом зума и панорамирования\n      const zoomFactor = zoom / 100;\n      const canvasX = (screenX - pan.x) / zoomFactor - dragOffset.x;\n      const canvasY = (screenY - pan.y) / zoomFactor - dragOffset.y;\n      \n      // Привязка к сетке (20px grid в канвасных координатах)\n      const gridSize = 20;\n      const snappedX = Math.round(canvasX / gridSize) * gridSize;\n      const snappedY = Math.round(canvasY / gridSize) * gridSize;\n      \n      // Ограничиваем позицию в пределах canvas с отступами (в канвасных координатах)\n      const minX = 20;\n      const minY = 20;\n      const maxX = Math.max(minX, (canvas.clientWidth / zoomFactor) - 340);\n      const maxY = Math.max(minY, Math.min(snappedY, (canvas.clientHeight / zoomFactor) - 220));\n      \n      const boundedX = Math.max(minX, Math.min(snappedX, maxX));\n      const boundedY = Math.max(minY, Math.min(snappedY, maxY));\n      \n      // Отладочный вывод убран для улучшения производительности\n      \n      onMove({ x: boundedX, y: boundedY });\n    }\n  };\n\n  const handleMouseUp = () => {\n    setIsDragging(false);\n    // Уведомляем глобальное состояние об окончании перетаскивания\n    if (setIsNodeBeingDragged) {\n      setIsNodeBeingDragged(false);\n    }\n  };\n\n  // Touch обработчики для мобильного перемещения элементов\n  const handleTouchStart = (e: React.TouchEvent) => {\n    // Не запускать события если кликнули по кнопке\n    if ((e.target as HTMLElement).closest('button')) return;\n    \n    // Предотвращаем стандартное поведение браузера\n    e.preventDefault();\n    e.stopPropagation(); // Останавливаем всплытие, чтобы не конфликтовать с панорамированием холста\n    \n    const touch = e.touches[0];\n    if (!touch) return;\n    \n    // Записываем информацию о начале касания\n    setTouchStartTime(Date.now());\n    setTouchStartPos({ x: touch.clientX, y: touch.clientY });\n    setTouchMoved(false);\n    \n    // Подготавливаем для потенциального перетаскивания только если onMove доступен\n    if (onMove) {\n      // Находим канвас (родительский элемент трансформируемого контейнера)\n      const transformedContainer = nodeRef.current?.parentElement;\n      const canvas = transformedContainer?.parentElement;\n      \n      if (canvas) {\n        const canvasRect = canvas.getBoundingClientRect();\n        const zoomFactor = zoom / 100;\n        \n        // Рассчитываем смещение в канвасных координатах\n        const screenX = touch.clientX - canvasRect.left;\n        const screenY = touch.clientY - canvasRect.top;\n        \n        const canvasX = (screenX - pan.x) / zoomFactor;\n        const canvasY = (screenY - pan.y) / zoomFactor;\n        \n        setTouchOffset({\n          x: canvasX - node.position.x,\n          y: canvasY - node.position.y\n        });\n      }\n    }\n  };\n\n  const handleTouchMove = (e: React.TouchEvent) => {\n    const touch = e.touches[0];\n    if (!touch || !onMove) return;\n    \n    // Вычисляем расстояние от начальной точки касания\n    const deltaX = touch.clientX - touchStartPos.x;\n    const deltaY = touch.clientY - touchStartPos.y;\n    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n    \n    // Начинаем перетаскивание только если движение больше 10 пикселей\n    if (distance > 10 && !isTouchDragging) {\n      setIsTouchDragging(true);\n      setTouchMoved(true);\n      // Уведомляем глобальное состояние о начале перетаскивания\n      if (setIsNodeBeingDragged) {\n        setIsNodeBeingDragged(true);\n      }\n    }\n    \n    // Всегда предотвращаем всплытие при движении по узлу, даже если еще не началось перетаскивание\n    e.preventDefault();\n    e.stopPropagation(); // Останавливаем всплытие, чтобы не конфликтовать с панорамированием холста\n    \n    if (!isTouchDragging) return;\n    \n    // Находим канвас (родительский элемент трансформируемого контейнера)\n    const transformedContainer = nodeRef.current?.parentElement;\n    const canvas = transformedContainer?.parentElement;\n    \n    if (canvas && transformedContainer) {\n      const canvasRect = canvas.getBoundingClientRect();\n      \n      // Получаем экранные координаты touch относительно канваса\n      const screenX = touch.clientX - canvasRect.left;\n      const screenY = touch.clientY - canvasRect.top;\n      \n      // Преобразуем экранные координаты в координаты канваса с учетом зума и панорамирования\n      const zoomFactor = zoom / 100;\n      const canvasX = (screenX - pan.x) / zoomFactor - touchOffset.x;\n      const canvasY = (screenY - pan.y) / zoomFactor - touchOffset.y;\n      \n      // Привязка к сетке (20px grid в канвасных координатах)\n      const gridSize = 20;\n      const snappedX = Math.round(canvasX / gridSize) * gridSize;\n      const snappedY = Math.round(canvasY / gridSize) * gridSize;\n      \n      // Ограничиваем позицию в пределах canvas с отступами (в канвасных координатах)\n      const minX = 20;\n      const minY = 20;\n      const maxX = Math.max(minX, (canvas.clientWidth / zoomFactor) - 340);\n      const maxY = Math.max(minY, Math.min(snappedY, (canvas.clientHeight / zoomFactor) - 220));\n      \n      const boundedX = Math.max(minX, Math.min(snappedX, maxX));\n      const boundedY = Math.max(minY, Math.min(snappedY, maxY));\n      \n      onMove({ x: boundedX, y: boundedY });\n    }\n  };\n\n  const handleTouchEnd = (e: React.TouchEvent) => {\n    e.preventDefault();\n    e.stopPropagation(); // Останавливаем всплытие\n    \n    const touchEndTime = Date.now();\n    const touchDuration = touchEndTime - touchStartTime;\n    \n    // Если это было короткое касание (менее 300ms) и не было движения, обрабатываем как клик\n    if (touchDuration < 300 && !touchMoved && onClick) {\n      onClick();\n    }\n    \n    setIsTouchDragging(false);\n    setTouchMoved(false);\n    // Уведомляем глобальное состояние об окончании перетаскивания\n    if (setIsNodeBeingDragged) {\n      setIsNodeBeingDragged(false);\n    }\n  };\n\n  // Добавляем и удаляем обработчики событий для mouse\n  useEffect(() => {\n    if (isDragging) {\n      document.addEventListener('mousemove', handleMouseMove);\n      document.addEventListener('mouseup', handleMouseUp);\n      document.body.style.cursor = 'grabbing';\n      document.body.style.userSelect = 'none';\n      \n      return () => {\n        document.removeEventListener('mousemove', handleMouseMove);\n        document.removeEventListener('mouseup', handleMouseUp);\n        document.body.style.cursor = '';\n        document.body.style.userSelect = '';\n      };\n    }\n  }, [isDragging, dragOffset, onMove]);\n\n  // Touch события уже обрабатываются в handleTouchMove, не нужно добавлять глобальные слушатели\n  useEffect(() => {\n    if (isTouchDragging) {\n      document.body.style.userSelect = 'none';\n      document.body.style.touchAction = 'none'; // Предотвращаем прокрутку при перетаскивании\n      \n      return () => {\n        document.body.style.userSelect = '';\n        document.body.style.touchAction = '';\n      };\n    }\n  }, [isTouchDragging]);\n\n  // ResizeObserver для измерения реальных размеров узла\n  useEffect(() => {\n    if (!onSizeChange || !nodeRef.current) return;\n\n    const resizeObserver = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        const { width, height } = entry.contentRect;\n        onSizeChange(node.id, { width, height });\n      }\n    });\n\n    resizeObserver.observe(nodeRef.current);\n\n    return () => {\n      resizeObserver.disconnect();\n    };\n  }, [node.id, onSizeChange]);\n\n  return (\n    <div\n      ref={nodeRef}\n      data-canvas-node=\"true\"\n      className={cn(\n        \"bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm rounded-2xl shadow-xl border-2 p-6 w-80 transition-all duration-300 relative select-none group\",\n        isSelected ? \"border-blue-500 ring-4 ring-blue-500/20 shadow-2xl shadow-blue-500/10\" : \"border-gray-200 dark:border-slate-700\",\n        (isDragging || isTouchDragging) ? \"shadow-3xl scale-105 cursor-grabbing z-50 border-blue-500 bg-blue-50/50 dark:bg-blue-900/20\" : \"hover:shadow-2xl hover:border-gray-300 dark:hover:border-slate-600\",\n        onMove ? \"cursor-grab hover:cursor-grab\" : \"cursor-pointer\"\n      )}\n      onClick={!isDragging ? onClick : undefined}\n      onMouseDown={handleMouseDown}\n      onTouchStart={handleTouchStart}\n      onTouchMove={handleTouchMove}\n      onTouchEnd={handleTouchEnd}\n      style={{\n        position: 'absolute',\n        left: node.position.x,\n        top: node.position.y,\n        transform: (isDragging || isTouchDragging) ? 'rotate(2deg) scale(1.05)' : 'rotate(0deg) scale(1)',\n        zIndex: (isDragging || isTouchDragging) ? 1000 : isSelected ? 10 : 1,\n        transition: (isDragging || isTouchDragging) ? 'none' : 'all 0.2s ease'\n      }}\n    >\n      {/* Action buttons */}\n      {/* Copy button - left top */}\n      {onDuplicate && (\n        <button\n          onClick={(e) => {\n            e.stopPropagation();\n            onDuplicate();\n          }}\n          className=\"absolute -top-2 -left-2 w-7 h-7 bg-white/95 dark:bg-slate-800/95 backdrop-blur-sm text-blue-600 dark:text-blue-400 rounded-xl flex items-center justify-center hover:bg-gradient-to-br hover:from-blue-50 hover:to-indigo-50 dark:hover:from-blue-900/40 dark:hover:to-indigo-900/40 hover:text-blue-700 dark:hover:text-blue-300 focus:bg-gradient-to-br focus:from-blue-100 focus:to-indigo-100 dark:focus:from-blue-800/50 dark:focus:to-indigo-800/50 active:scale-95 transition-all duration-300 shadow-lg hover:shadow-xl focus:shadow-2xl border border-blue-200/50 dark:border-blue-700/50 hover:border-blue-300 dark:hover:border-blue-600 focus:border-blue-400 dark:focus:border-blue-500 hover:scale-110 focus:scale-105 group opacity-0 group-hover:opacity-100 focus:opacity-100\"\n          title=\"Копировать элемент\"\n        >\n          <i className=\"fas fa-copy text-xs transition-transform duration-200 group-hover:scale-110\"></i>\n        </button>\n      )}\n      \n      {/* Delete button - right top */}\n      {onDelete && (\n        <button\n          onClick={(e) => {\n            e.stopPropagation();\n            onDelete();\n          }}\n          className=\"absolute -top-2 -right-2 w-7 h-7 bg-white/95 dark:bg-slate-800/95 backdrop-blur-sm text-red-600 dark:text-red-400 rounded-xl flex items-center justify-center hover:bg-gradient-to-br hover:from-red-50 hover:to-rose-50 dark:hover:from-red-900/40 dark:hover:to-rose-900/40 hover:text-red-700 dark:hover:text-red-300 focus:bg-gradient-to-br focus:from-red-100 focus:to-rose-100 dark:focus:from-red-800/50 dark:focus:to-rose-800/50 active:scale-95 transition-all duration-300 shadow-lg hover:shadow-xl focus:shadow-2xl border border-red-200/50 dark:border-red-700/50 hover:border-red-300 dark:hover:border-red-600 focus:border-red-400 dark:focus:border-red-500 hover:scale-110 focus:scale-105 group opacity-0 group-hover:opacity-100 focus:opacity-100\"\n          title=\"Удалить элемент\"\n        >\n          <i className=\"fas fa-times text-xs transition-transform duration-200 group-hover:scale-110\"></i>\n        </button>\n      )}\n      \n\n      \n      {/* Node header */}\n      <div className=\"flex items-start mb-6 relative\">\n        <div className={cn(\"w-12 h-12 rounded-xl flex items-center justify-center mr-4 shadow-sm relative\", nodeColors[node.type])}>\n          <i className={cn(nodeIcons[node.type], \"text-lg\")}></i>\n          {/* Status indicators */}\n          <div className=\"absolute -top-1 -right-1 flex items-center space-x-1\">\n            {/* Conditional messages indicator */}\n            {node.data.enableConditionalMessages && node.data.conditionalMessages && node.data.conditionalMessages.length > 0 && (\n              <div className=\"w-4 h-4 bg-purple-500 rounded-full flex items-center justify-center border-2 border-white dark:border-slate-900\" title={`Условные сообщения: ${node.data.conditionalMessages.length}`}>\n                <i className=\"fas fa-code-branch text-white text-xs\"></i>\n              </div>\n            )}\n            \n            {/* Main status indicator */}\n            {(() => {\n              const hasRequiredFields = (() => {\n                switch (node.type) {\n                  case 'photo': return !!node.data.imageUrl;\n                  case 'video': return !!node.data.videoUrl;\n                  case 'audio': return !!node.data.audioUrl;\n                  case 'document': return !!node.data.documentUrl;\n                  case 'sticker': return !!(node.data.stickerUrl || node.data.stickerFileId);\n                  case 'voice': return !!node.data.voiceUrl;\n                  case 'animation': return !!node.data.animationUrl;\n                  case 'location': return !!(node.data.latitude && node.data.longitude);\n                  case 'contact': return !!(node.data.phoneNumber && node.data.firstName);\n                  case 'poll': return !!(node.data.question && node.data.options?.length);\n                  case 'command': return !!node.data.command;\n                  case 'admin_rights': return true;\n                  default: return !!node.data.messageText;\n                }\n              })();\n              \n              return hasRequiredFields ? (\n                <div className=\"w-4 h-4 bg-green-500 rounded-full flex items-center justify-center border-2 border-white dark:border-slate-900\">\n                  <i className=\"fas fa-check text-white text-xs\"></i>\n                </div>\n              ) : (\n                <div className=\"w-4 h-4 bg-orange-500 rounded-full flex items-center justify-center border-2 border-white dark:border-slate-900\">\n                  <i className=\"fas fa-exclamation text-white text-xs\"></i>\n                </div>\n              );\n            })()}\n          </div>\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center justify-between mb-1\">\n            <h3 className=\"font-semibold text-gray-800 dark:text-gray-200 text-base flex items-center truncate\">\n              {node.type === 'start' && (\n                <span className=\"inline-flex items-center\">\n                  <span className=\"text-emerald-600 dark:text-emerald-400 font-mono text-sm bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded-lg border border-emerald-200 dark:border-emerald-800\">\n                    {node.data.command || '/start'}\n                  </span>\n                </span>\n              )}\n              {node.type === 'command' && (\n                <span className=\"inline-flex items-center\">\n                  <span className=\"text-indigo-600 dark:text-indigo-400 font-mono text-sm bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded-lg border border-indigo-200 dark:border-indigo-800\">\n                    {node.data.command}\n                  </span>\n                </span>\n              )}\n              {node.type === 'message' && 'Сообщение'}\n              {node.type === 'photo' && 'Фото с текстом'}\n              {node.type === 'video' && 'Видео с текстом'}\n              {node.type === 'audio' && 'Аудио сообщение'}\n              {node.type === 'document' && 'Документ'}\n              {node.type === 'keyboard' && 'Клавиатура'}\n              {node.type === 'sticker' && 'Стикер'}\n              {node.type === 'voice' && 'Голосовое сообщение'}\n              {node.type === 'animation' && 'GIF анимация'}\n              {node.type === 'location' && 'Геолокация'}\n              {node.type === 'contact' && 'Контакт'}\n              {(node.type === 'pin_message' || node.type === 'unpin_message' || node.type === 'delete_message') && (\n                <span className=\"inline-flex items-center\">\n                  <span className=\"text-cyan-600 dark:text-cyan-400 font-mono text-sm bg-cyan-50 dark:bg-cyan-900/30 px-2 py-1 rounded-lg border border-cyan-200 dark:border-cyan-800 mr-2\">\n                    {node.data.command || `/${node.type}`}\n                  </span>\n                  <span>Управление контентом</span>\n                </span>\n              )}\n              {(node.type === 'ban_user' || node.type === 'unban_user' || node.type === 'mute_user' || \n                node.type === 'unmute_user' || node.type === 'kick_user' || node.type === 'promote_user' || \n                node.type === 'demote_user') && (\n                <span className=\"inline-flex items-center\">\n                  <span className=\"text-rose-600 dark:text-rose-400 font-mono text-sm bg-rose-50 dark:bg-rose-900/30 px-2 py-1 rounded-lg border border-rose-200 dark:border-rose-800 mr-2\">\n                    {node.data.command || `/${node.type}`}\n                  </span>\n                  <span>Действие с пользователем</span>\n                </span>\n              )}\n              {node.type === 'admin_rights' && (\n                <span className=\"inline-flex items-center\">\n                  <span className=\"text-violet-600 dark:text-violet-400 font-mono text-sm bg-violet-50 dark:bg-violet-900/30 px-2 py-1 rounded-lg border border-violet-200 dark:border-violet-800 mr-2\">\n                    {node.data.command || '/admin_rights'}\n                  </span>\n                  <span>Права админа</span>\n                </span>\n              )}\n            </h3>\n            {onMove && (\n              <div className=\"ml-2 opacity-40 hover:opacity-70 transition-all duration-200 cursor-grab\">\n                <i className=\"fas fa-grip-vertical text-xs text-gray-400 dark:text-gray-500\"></i>\n              </div>\n            )}\n          </div>\n          {node.data.description && (\n            <p className=\"text-xs text-gray-500 dark:text-gray-400 leading-relaxed\">\n              {parseFormattedText(node.data.description, node.data.formatMode, node.data.markdown)}\n            </p>\n          )}\n          \n          {/* Синонимы */}\n          {node.data.synonyms && node.data.synonyms.length > 0 && (\n            <div className=\"mt-2\">\n              <div className=\"flex flex-wrap gap-1\">\n                {node.data.synonyms.slice(0, 3).map((synonym, index) => (\n                  <span\n                    key={index}\n                    className=\"inline-flex items-center px-2 py-1 rounded-md bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 text-indigo-700 dark:text-indigo-300 text-xs font-medium border border-indigo-200 dark:border-indigo-700/50\"\n                    title={`Синоним: ${synonym}`}\n                  >\n                    <i className=\"fas fa-quote-left text-indigo-400 dark:text-indigo-500 mr-1\" style={{ fontSize: '8px' }}></i>\n                    {synonym}\n                  </span>\n                ))}\n                {node.data.synonyms.length > 3 && (\n                  <span\n                    className=\"inline-flex items-center px-2 py-1 rounded-md bg-gradient-to-r from-gray-50 to-slate-50 dark:from-gray-900/20 dark:to-slate-900/20 text-gray-600 dark:text-gray-400 text-xs font-medium border border-gray-200 dark:border-gray-700/50\"\n                    title={`Ещё синонимов: ${node.data.synonyms.slice(3).join(', ')}`}\n                  >\n                    +{node.data.synonyms.length - 3}\n                  </span>\n                )}\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n      {/* Message preview */}\n      {node.data.messageText && (\n        <div className=\"rounded-xl p-4 mb-4 bg-gradient-to-br from-blue-50/80 to-sky-50/80 dark:from-blue-900/20 dark:to-sky-900/20 border border-blue-100 dark:border-blue-800/30\">\n          <div className=\"flex items-start space-x-2\">\n            <div className=\"w-2 h-2 rounded-full bg-blue-500 dark:bg-blue-400 mt-1.5 flex-shrink-0\"></div>\n            <div className=\"text-sm text-blue-700 dark:text-blue-300 leading-relaxed line-clamp-3 font-medium\">\n              {parseFormattedText(node.data.messageText, node.data.formatMode, node.data.markdown)}\n            </div>\n          </div>\n        </div>\n      )}\n      {/* Media previews */}\n      {node.type === 'photo' && (\n        <div className=\"bg-gradient-to-br from-purple-100/50 to-pink-100/50 dark:from-purple-900/30 dark:to-pink-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center border-2 border-dashed border-purple-200 dark:border-purple-700 hover:border-purple-300 dark:hover:border-purple-600 transition-colors group\">\n          {node.data.imageUrl ? (\n            <div className=\"relative w-full h-full\">\n              <img src={node.data.imageUrl} alt=\"Preview\" className=\"max-h-full max-w-full object-contain rounded-md shadow-sm\" />\n              <div className=\"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 rounded-md flex items-center justify-center\">\n                <div className=\"opacity-0 group-hover:opacity-100 transition-opacity bg-white dark:bg-gray-800 rounded-full p-1 shadow-lg\">\n                  <i className=\"fas fa-edit text-purple-600 dark:text-purple-400 text-xs\"></i>\n                </div>\n              </div>\n            </div>\n          ) : (\n            <div className=\"text-center space-y-2\">\n              <i className=\"fas fa-cloud-upload-alt text-purple-400 dark:text-purple-300 text-3xl group-hover:scale-110 transition-transform\"></i>\n              <div className=\"text-xs text-purple-600 dark:text-purple-400 font-medium\">Нажмите для загрузки</div>\n            </div>\n          )}\n        </div>\n      )}\n      \n      {/* Video preview */}\n      {node.type === 'video' && (\n        <div className=\"bg-gradient-to-br from-rose-100/50 to-pink-100/50 dark:from-rose-900/30 dark:to-pink-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center border-2 border-dashed border-rose-200 dark:border-rose-700 hover:border-rose-300 dark:hover:border-rose-600 transition-colors group\">\n          <div className=\"text-center space-y-2\">\n            <i className=\"fas fa-video text-rose-400 dark:text-rose-300 text-3xl group-hover:scale-110 transition-transform\"></i>\n            {node.data.videoUrl ? (\n              <div className=\"text-xs text-rose-600 dark:text-rose-400 space-y-1\">\n                <div className=\"font-medium flex items-center justify-center space-x-1\">\n                  <i className=\"fas fa-check-circle text-green-500 text-xs\"></i>\n                  <span>Видео загружено</span>\n                </div>\n                {node.data.duration && (\n                  <div className=\"flex items-center justify-center space-x-1\">\n                    <i className=\"fas fa-clock text-xs\"></i>\n                    <span>{node.data.duration}с</span>\n                  </div>\n                )}\n              </div>\n            ) : (\n              <div className=\"text-xs text-rose-600 dark:text-rose-400 font-medium\">Нажмите для загрузки</div>\n            )}\n          </div>\n        </div>\n      )}\n      \n      {/* Audio preview */}\n      {node.type === 'audio' && (\n        <div className=\"bg-gradient-to-br from-orange-100/50 to-amber-100/50 dark:from-orange-900/30 dark:to-amber-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center border-2 border-dashed border-orange-200 dark:border-orange-700 hover:border-orange-300 dark:hover:border-orange-600 transition-colors group\">\n          <div className=\"text-center space-y-2\">\n            <i className=\"fas fa-music text-orange-400 dark:text-orange-300 text-3xl group-hover:scale-110 transition-transform\"></i>\n            {node.data.audioUrl ? (\n              <div className=\"text-xs text-orange-600 dark:text-orange-400 space-y-1\">\n                <div className=\"font-medium flex items-center justify-center space-x-1\">\n                  <i className=\"fas fa-check-circle text-green-500 text-xs\"></i>\n                  <span>{node.data.title || 'Аудио трек'}</span>\n                </div>\n                {node.data.performer && (\n                  <div className=\"flex items-center justify-center space-x-1\">\n                    <i className=\"fas fa-user text-xs\"></i>\n                    <span>{node.data.performer}</span>\n                  </div>\n                )}\n                {node.data.duration && (\n                  <div className=\"flex items-center justify-center space-x-1\">\n                    <i className=\"fas fa-clock text-xs\"></i>\n                    <span>{node.data.duration}с</span>\n                  </div>\n                )}\n              </div>\n            ) : (\n              <div className=\"text-xs text-orange-600 dark:text-orange-400 font-medium\">Нажмите для загрузки</div>\n            )}\n          </div>\n        </div>\n      )}\n      \n      {/* Document preview */}\n      {node.type === 'document' && (\n        <div className=\"bg-gradient-to-br from-teal-100/50 to-cyan-100/50 dark:from-teal-900/30 dark:to-cyan-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center border-2 border-dashed border-teal-200 dark:border-teal-700 hover:border-teal-300 dark:hover:border-teal-600 transition-colors group\">\n          <div className=\"text-center space-y-2\">\n            <i className=\"fas fa-file-alt text-teal-400 dark:text-teal-300 text-3xl group-hover:scale-110 transition-transform\"></i>\n            {node.data.documentUrl ? (\n              <div className=\"text-xs text-teal-600 dark:text-teal-400 space-y-1\">\n                <div className=\"font-medium flex items-center justify-center space-x-1\">\n                  <i className=\"fas fa-check-circle text-green-500 text-xs\"></i>\n                  <span>{node.data.filename || 'Документ'}</span>\n                </div>\n                {node.data.fileSize && (\n                  <div className=\"flex items-center justify-center space-x-1\">\n                    <i className=\"fas fa-hdd text-xs\"></i>\n                    <span>{node.data.fileSize} МБ</span>\n                  </div>\n                )}\n              </div>\n            ) : (\n              <div className=\"text-xs text-teal-600 dark:text-teal-400 font-medium\">Нажмите для загрузки</div>\n            )}\n          </div>\n        </div>\n      )}\n      \n      {/* Sticker preview */}\n      {node.type === 'sticker' && (\n        <div className=\"bg-gradient-to-br from-pink-100/50 to-fuchsia-100/50 dark:from-pink-900/30 dark:to-fuchsia-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center\">\n          <div className=\"text-center space-y-2\">\n            <i className=\"fas fa-laugh text-pink-400 dark:text-pink-300 text-3xl\"></i>\n            {node.data.stickerUrl || node.data.stickerFileId ? (\n              <div className=\"text-xs text-pink-600 dark:text-pink-400 space-y-1\">\n                <div className=\"font-medium\">Стикер загружен</div>\n                <div className=\"flex items-center justify-center space-x-1\">\n                  <i className=\"fas fa-images text-xs\"></i>\n                  <span>Анимированный</span>\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-xs text-pink-500 dark:text-pink-400\">Добавьте URL стикера</div>\n            )}\n          </div>\n        </div>\n      )}\n      \n      {/* Voice message preview */}\n      {node.type === 'voice' && (\n        <div className=\"bg-gradient-to-br from-emerald-100/50 to-teal-100/50 dark:from-emerald-900/30 dark:to-teal-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center\">\n          <div className=\"text-center space-y-2\">\n            <i className=\"fas fa-microphone text-emerald-400 dark:text-emerald-300 text-3xl\"></i>\n            {node.data.voiceUrl ? (\n              <div className=\"text-xs text-emerald-600 dark:text-emerald-400 space-y-1\">\n                <div className=\"font-medium\">Голосовое сообщение</div>\n                {node.data.duration && (\n                  <div className=\"flex items-center justify-center space-x-1\">\n                    <i className=\"fas fa-clock text-xs\"></i>\n                    <span>{node.data.duration}с</span>\n                  </div>\n                )}\n              </div>\n            ) : (\n              <div className=\"text-xs text-emerald-500 dark:text-emerald-400\">Добавьте URL голосового сообщения</div>\n            )}\n          </div>\n        </div>\n      )}\n      \n      {/* Animation preview */}\n      {node.type === 'animation' && (\n        <div className=\"bg-gradient-to-br from-yellow-100/50 to-orange-100/50 dark:from-yellow-900/30 dark:to-orange-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center\">\n          <div className=\"text-center space-y-2\">\n            <i className=\"fas fa-film text-yellow-400 dark:text-yellow-300 text-3xl\"></i>\n            {node.data.animationUrl ? (\n              <div className=\"text-xs text-yellow-600 dark:text-yellow-400 space-y-1\">\n                <div className=\"font-medium\">GIF анимация</div>\n                {node.data.duration && (\n                  <div className=\"flex items-center justify-center space-x-1\">\n                    <i className=\"fas fa-clock text-xs\"></i>\n                    <span>{node.data.duration}с</span>\n                  </div>\n                )}\n                {node.data.width && node.data.height && (\n                  <div className=\"flex items-center justify-center space-x-1\">\n                    <i className=\"fas fa-expand text-xs\"></i>\n                    <span>{node.data.width}x{node.data.height}</span>\n                  </div>\n                )}\n              </div>\n            ) : (\n              <div className=\"text-xs text-yellow-500 dark:text-yellow-400\">Добавьте URL GIF анимации</div>\n            )}\n          </div>\n        </div>\n      )}\n      \n      {/* Location preview */}\n      {node.type === 'location' && (\n        <div className=\"bg-gradient-to-br from-green-100/50 to-lime-100/50 dark:from-green-900/30 dark:to-lime-900/30 rounded-lg p-3 mb-4 flex flex-col justify-center space-y-2\">\n          <div className=\"flex items-center justify-center space-x-2\">\n            <i className=\"fas fa-map-marker-alt text-green-400 dark:text-green-300 text-2xl\"></i>\n            {node.data.mapService && node.data.mapService !== 'custom' && (\n              <div className=\"flex items-center space-x-1\">\n                {node.data.mapService === 'yandex' && (\n                  <span className=\"text-xs px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full font-medium border border-yellow-200 dark:border-yellow-800\">\n                    Яндекс\n                  </span>\n                )}\n                {node.data.mapService === 'google' && (\n                  <span className=\"text-xs px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full font-medium border border-blue-200 dark:border-blue-800\">\n                    Google\n                  </span>\n                )}\n                {node.data.mapService === '2gis' && (\n                  <span className=\"text-xs px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full font-medium border border-green-200 dark:border-green-800\">\n                    2ГИС\n                  </span>\n                )}\n              </div>\n            )}\n          </div>\n          \n          <div className=\"text-xs text-green-600 dark:text-green-400 space-y-1 text-center\">\n            <div className=\"font-medium text-sm\">{node.data.title || 'Геолокация'}</div>\n            \n            {/* Показываем координаты если они есть */}\n            {node.data.latitude && node.data.longitude && (\n              <div className=\"flex items-center justify-center space-x-1\">\n                <i className=\"fas fa-crosshairs text-xs\"></i>\n                <span className=\"font-mono text-xs\">\n                  {parseFloat(node.data.latitude as string).toFixed(4)}, {parseFloat(node.data.longitude as string).toFixed(4)}\n                </span>\n              </div>\n            )}\n            \n            {/* Показываем адрес если он есть */}\n            {node.data.address && (\n              <div className=\"flex items-center justify-center space-x-1\">\n                <i className=\"fas fa-map text-xs\"></i>\n                <span className=\"truncate max-w-32 text-xs\">{node.data.address}</span>\n              </div>\n            )}\n            \n            {/* Индикатор что URL загружен */}\n            {(node.data.yandexMapUrl || node.data.googleMapUrl || node.data.gisMapUrl) && (\n              <div className=\"flex items-center justify-center space-x-1\">\n                <i className=\"fas fa-link text-xs text-green-500\"></i>\n                <span className=\"text-xs opacity-75\">URL загружен</span>\n              </div>\n            )}\n            \n            {/* Показываем дополнительные опции */}\n            {node.data.generateMapPreview && (\n              <div className=\"flex items-center justify-center space-x-1\">\n                <i className=\"fas fa-external-link-alt text-xs text-blue-500\"></i>\n                <span className=\"text-xs opacity-75\">Кнопки карт</span>\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n      \n      {/* Contact preview */}\n      {node.type === 'contact' && (\n        <div className=\"bg-gradient-to-br from-sky-100/50 to-blue-100/50 dark:from-sky-900/30 dark:to-blue-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center\">\n          <div className=\"text-center space-y-2\">\n            <i className=\"fas fa-address-book text-sky-400 dark:text-sky-300 text-3xl\"></i>\n            <div className=\"text-xs text-sky-600 dark:text-sky-400 space-y-1\">\n              <div className=\"font-medium\">{node.data.firstName} {node.data.lastName}</div>\n              {node.data.phoneNumber && (\n                <div className=\"flex items-center justify-center space-x-1\">\n                  <i className=\"fas fa-phone text-xs\"></i>\n                  <span>{node.data.phoneNumber}</span>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* Admin Rights preview */}\n      {node.type === 'admin_rights' && (\n        <div className=\"bg-gradient-to-br from-violet-50/80 to-purple-50/80 dark:from-violet-900/25 dark:to-purple-900/25 border border-violet-200/50 dark:border-violet-800/40 rounded-xl p-4 mb-4 shadow-sm\">\n          <div className=\"flex items-center justify-between mb-3\">\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-6 h-6 rounded-full bg-violet-100 dark:bg-violet-900/60 flex items-center justify-center\">\n                <i className=\"fas fa-user-shield text-violet-600 dark:text-violet-400 text-sm\"></i>\n              </div>\n              <div className=\"text-sm font-semibold text-violet-800 dark:text-violet-200\">\n                Права администратора\n              </div>\n            </div>\n            <div className=\"text-xs text-violet-600 dark:text-violet-400 bg-violet-100 dark:bg-violet-900/50 px-2 py-1 rounded-full font-medium\">\n              11 кнопок\n            </div>\n          </div>\n          \n          <div className=\"space-y-3\">\n            <div className=\"flex items-center space-x-2 mb-3\">\n              <div className=\"w-1 h-4 bg-amber-500 dark:bg-amber-400 rounded-full\"></div>\n              <span className=\"text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide\">\n                Inline кнопки\n              </span>\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-2\">\n              {[\n                { key: 'can_change_info', name: '🏷️ Профиль' },\n                { key: 'can_delete_messages', name: '🗑️ Удаление' },\n                { key: 'can_restrict_members', name: '🚫 Блокировка' },\n                { key: 'can_invite_users', name: '📨 Приглашения' },\n                { key: 'can_pin_messages', name: '📌 Закрепление' },\n                { key: 'can_manage_video_chats', name: '🎥 Видеочаты' }\n              ].map((right, index) => (\n                <div key={right.key} className=\"group relative\">\n                  <div className=\"p-3 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-lg text-xs font-medium text-blue-700 dark:text-blue-300 text-center border border-blue-200 dark:border-blue-800 hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-200 shadow-sm\">\n                    <div className=\"flex items-center justify-center space-x-1\">\n                      <span className=\"truncate\">{right.name}</span>\n                      <i className=\"fas fa-chevron-right text-blue-500 dark:text-blue-400 text-xs opacity-70\"></i>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n            \n            {/* Показать что есть еще кнопки */}\n            <div className=\"text-xs text-gray-500 dark:text-gray-400 text-center py-1 font-medium\">\n              <span className=\"inline-flex items-center px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded-full\">\n                +5 еще\n              </span>\n            </div>\n          </div>\n          \n          {/* Additional info */}\n          <div className=\"mt-3 pt-3 border-t border-violet-200/50 dark:border-violet-700/30\">\n            <div className=\"flex items-center justify-center space-x-3 text-xs text-violet-600 dark:text-violet-400\">\n              <div className=\"flex items-center space-x-1\">\n                <i className=\"fas fa-toggle-on\"></i>\n                <span>Интерактивные переключатели</span>\n              </div>\n              <div className=\"flex items-center space-x-1\">\n                <i className=\"fas fa-sync-alt\"></i>\n                <span>Обновление в реальном времени</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* Poll preview */}\n      {node.type === 'poll' && (\n        <div className=\"bg-gradient-to-br from-violet-100/50 to-purple-100/50 dark:from-violet-900/30 dark:to-purple-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center\">\n          <div className=\"text-center space-y-2\">\n            <i className=\"fas fa-poll text-violet-400 dark:text-violet-300 text-3xl\"></i>\n            <div className=\"text-xs text-violet-600 dark:text-violet-400 space-y-1\">\n              <div className=\"font-medium\">{node.data.question || 'Опрос'}</div>\n              {node.data.options && node.data.options.length > 0 && (\n                <div className=\"flex items-center justify-center space-x-1\">\n                  <i className=\"fas fa-list text-xs\"></i>\n                  <span>{node.data.options.length} вариантов</span>\n                </div>\n              )}\n              {node.data.allowsMultipleAnswers && (\n                <div className=\"text-xs text-violet-500 dark:text-violet-400\">Множественный выбор</div>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* Dice preview */}\n      {node.type === 'dice' && (\n        <div className=\"bg-gradient-to-br from-slate-100/50 to-gray-100/50 dark:from-slate-900/30 dark:to-gray-900/30 rounded-lg p-4 mb-4 h-32 flex items-center justify-center\">\n          <div className=\"text-center space-y-2\">\n            <i className=\"fas fa-dice text-slate-400 dark:text-slate-300 text-3xl\"></i>\n            <div className=\"text-xs text-slate-600 dark:text-slate-400 space-y-1\">\n              <div className=\"font-medium\">Игральный кубик</div>\n              <div className=\"flex items-center justify-center space-x-1\">\n                <i className=\"fas fa-gamepad text-xs\"></i>\n                <span>{node.data.emoji || '🎲'} Развлечение</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* User Input preview */}\n      {false && (\n        <div className=\"bg-gradient-to-br from-purple-50/70 to-indigo-50/70 dark:from-purple-900/30 dark:to-indigo-900/30 rounded-xl p-4 mb-4 border border-purple-200 dark:border-purple-800/30\">\n          <div className=\"space-y-3\">\n            {/* Input type and variable display */}\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center space-x-2\">\n                <div className=\"w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center\">\n                  <i className=\"fas fa-edit text-purple-600 dark:text-purple-400 text-xs\"></i>\n                </div>\n                <div className=\"text-sm font-medium text-purple-800 dark:text-purple-200\">\n                  {node.data.inputType ? (\n                    <span className=\"capitalize\">\n                      {node.data.inputType === 'text' && 'Текст'}\n                      {node.data.inputType === 'number' && 'Число'}\n                      {node.data.inputType === 'email' && 'Email'}\n                      {node.data.inputType === 'phone' && 'Телефон'}\n                      {node.data.inputType === 'photo' && 'Фото'}\n                      {node.data.inputType === 'video' && 'Видео'}\n                      {node.data.inputType === 'audio' && 'Аудио'}\n                      {node.data.inputType === 'document' && 'Документ'}\n                      {node.data.inputType === 'location' && 'Местоположение'}\n                      {node.data.inputType === 'contact' && 'Контакт'}\n                      {node.data.inputType === 'any' && 'Любой тип'}\n                    </span>\n                  ) : (\n                    'Тип ввода'\n                  )}\n                </div>\n              </div>\n              {(node.data as any).variableName && (\n                <div className=\"text-xs font-mono text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-900/50 px-2 py-1 rounded\">\n                  ${(node.data as any).variableName}\n                </div>\n              )}\n            </div>\n\n            {/* Response type indicator */}\n            {node.data.responseType && (\n              <div className=\"flex items-center space-x-2\">\n                <div className=\"w-5 h-5 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center\">\n                  <i className={cn(\n                    \"text-indigo-600 dark:text-indigo-400 text-xs\",\n                    node.data.responseType === 'text' ? 'fas fa-keyboard' : 'fas fa-mouse-pointer'\n                  )}></i>\n                </div>\n                <div className=\"text-xs text-indigo-700 dark:text-indigo-300\">\n                  {node.data.responseType === 'text' ? 'Текстовый ввод' : 'Кнопочный ответ'}\n                </div>\n              </div>\n            )}\n\n            {/* Button options preview */}\n            {node.data.responseType === 'buttons' && node.data.responseOptions && node.data.responseOptions.length > 0 && (\n              <div className=\"space-y-2\">\n                <div className=\"text-xs text-gray-600 dark:text-gray-400 font-medium\">Варианты ответов:</div>\n                <div className=\"flex flex-wrap gap-1\">\n                  {node.data.responseOptions.slice(0, 3).map((option, index) => (\n                    <div key={index} className=\"text-xs bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 px-2 py-1 rounded-full\">\n                      {option.text}\n                    </div>\n                  ))}\n                  {node.data.responseOptions.length > 3 && (\n                    <div className=\"text-xs bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 px-2 py-1 rounded-full\">\n                      +{node.data.responseOptions.length - 3} еще\n                    </div>\n                  )}\n                </div>\n                {node.data.allowMultipleSelection && (\n                  <div className=\"text-xs text-indigo-600 dark:text-indigo-400 flex items-center space-x-1\">\n                    <i className=\"fas fa-check-double text-xs\"></i>\n                    <span>Множественный выбор</span>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Validation info */}\n            {((node.data as any).minLength || (node.data as any).maxLength || (node.data as any).timeout) && (\n              <div className=\"flex items-center space-x-3 text-xs text-gray-600 dark:text-gray-400\">\n                {(node.data as any).minLength && (\n                  <div className=\"flex items-center space-x-1\">\n                    <i className=\"fas fa-arrow-up text-xs\"></i>\n                    <span>Мин: {(node.data as any).minLength}</span>\n                  </div>\n                )}\n                {(node.data as any).maxLength && (\n                  <div className=\"flex items-center space-x-1\">\n                    <i className=\"fas fa-arrow-down text-xs\"></i>\n                    <span>Макс: {(node.data as any).maxLength}</span>\n                  </div>\n                )}\n                {(node.data as any).timeout && (\n                  <div className=\"flex items-center space-x-1\">\n                    <i className=\"fas fa-clock text-xs\"></i>\n                    <span>{(node.data as any).timeout}с</span>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Save to database indicator */}\n            {(node.data as any).saveToDatabase && (\n              <div className=\"flex items-center space-x-2\">\n                <div className=\"w-4 h-4 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center\">\n                  <i className=\"fas fa-database text-green-600 dark:text-green-400 text-xs\"></i>\n                </div>\n                <div className=\"text-xs text-green-700 dark:text-green-300\">Сохранение в БД</div>\n              </div>\n            )}\n\n            {/* Configuration status */}\n            {!((node.data as any).inputType && (node.data as any).variableName) && (\n              <div className=\"flex items-center space-x-2 text-orange-600 dark:text-orange-400\">\n                <i className=\"fas fa-exclamation-triangle text-xs\"></i>\n                <div className=\"text-xs\">Требуется настройка</div>\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n      \n      {/* Conditional Messages Indicator */}\n      {node.data.enableConditionalMessages && node.data.conditionalMessages && node.data.conditionalMessages.length > 0 && (\n        <div className=\"bg-gradient-to-br from-purple-50/90 to-indigo-50/90 dark:from-purple-900/25 dark:to-indigo-900/25 border border-purple-200/50 dark:border-purple-800/40 rounded-xl p-4 mb-4 shadow-sm\">\n          <div className=\"flex items-center justify-between mb-3\">\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900/60 flex items-center justify-center\">\n                <i className=\"fas fa-code-branch text-purple-600 dark:text-purple-400 text-sm\"></i>\n              </div>\n              <div className=\"text-sm font-semibold text-purple-800 dark:text-purple-200\">\n                Условные сообщения\n              </div>\n            </div>\n            <div className=\"text-xs text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-900/50 px-2 py-1 rounded-full font-medium\">\n              {node.data.conditionalMessages.length} правил{node.data.conditionalMessages.length === 1 ? 'о' : node.data.conditionalMessages.length < 5 ? 'а' : ''}\n            </div>\n          </div>\n          \n          <div className=\"space-y-2\">\n            {node.data.conditionalMessages\n              .sort((a, b) => (b.priority || 0) - (a.priority || 0))\n              .slice(0, 3)\n              .map((condition, index) => {\n                const getConditionIcon = (conditionType: string) => {\n                  switch(conditionType) {\n                    case 'user_data_equals': return 'fas fa-equals';\n                    case 'user_data_contains': return 'fas fa-search';\n                    case 'user_data_exists': return 'fas fa-check-circle';\n                    case 'user_data_not_exists': return 'fas fa-times-circle';\n                    case 'first_time': return 'fas fa-user-plus';\n                    case 'returning_user': return 'fas fa-user-check';\n                    default: return 'fas fa-filter';\n                  }\n                };\n\n                const getConditionColor = (conditionType: string) => {\n                  switch(conditionType) {\n                    case 'user_data_equals': return 'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30';\n                    case 'user_data_contains': return 'text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/30';\n                    case 'user_data_exists': return 'text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30';\n                    case 'user_data_not_exists': return 'text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30';\n                    case 'first_time': return 'text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/30';\n                    case 'returning_user': return 'text-cyan-600 dark:text-cyan-400 bg-cyan-50 dark:bg-cyan-900/30';\n                    default: return 'text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/30';\n                  }\n                };\n\n                const conditionName = {\n                  'user_data_equals': 'Точное совпадение',\n                  'user_data_contains': 'Содержит текст',\n                  'user_data_exists': 'Имя введено ранее',\n                  'user_data_not_exists': 'Имя не введено',\n                  'first_time': 'Первое посещение',\n                  'returning_user': 'Возвращающийся пользователь'\n                }[condition.condition] || 'Условие';\n\n                return (\n                  <div key={condition.id || index} className=\"bg-white/60 dark:bg-slate-900/40 rounded-lg border border-purple-100 dark:border-purple-800/30 p-3 hover:bg-white/80 dark:hover:bg-slate-900/60 transition-colors\">\n                    <div className=\"flex items-start justify-between mb-2\">\n                      <div className=\"flex items-center space-x-2 flex-1\">\n                        <div className={cn(\"w-5 h-5 rounded-full flex items-center justify-center text-xs\", getConditionColor(condition.condition))}>\n                          <i className={getConditionIcon(condition.condition)}></i>\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"text-xs font-medium text-slate-700 dark:text-slate-300 truncate\">\n                            {conditionName}\n                          </div>\n                          {(condition as any).variableName && (\n                            <div className=\"text-xs text-slate-500 dark:text-slate-400 flex items-center space-x-1 mt-1\">\n                              <i className=\"fas fa-tag text-xs\"></i>\n                              <code className=\"bg-slate-100 dark:bg-slate-800 px-1 py-0.5 rounded text-xs\">{(condition as any).variableName}</code>\n                              {(condition as any).value && (\n                                <>\n                                  <span>=</span>\n                                  <span className=\"truncate max-w-[60px]\">\"{(condition as any).value}\"</span>\n                                </>\n                              )}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center space-x-2 ml-2\">\n                        <div className=\"text-xs font-medium text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-900/50 px-2 py-1 rounded\">\n                          #{condition.priority || 0}\n                        </div>\n                      </div>\n                    </div>\n                    \n                    <div className=\"bg-slate-50/70 dark:bg-slate-800/50 rounded p-2 border border-slate-200/50 dark:border-slate-700/50\">\n                      <div className=\"text-xs text-slate-600 dark:text-slate-400 mb-1 flex items-center space-x-1\">\n                        <i className=\"fas fa-comment text-xs\"></i>\n                        <span className=\"font-medium\">Сообщение:</span>\n                      </div>\n                      <div className=\"text-xs text-slate-700 dark:text-slate-300 leading-relaxed line-clamp-2\">\n                        {condition.messageText || (\n                          <span className=\"italic text-slate-500 dark:text-slate-400\">\n                            Основной текст узла: {node.data.messageText?.slice(0, 50) || '(не указан)'}...\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                    \n                    {/* Кнопки условного сообщения */}\n                    {(condition as any).buttons && (condition as any).buttons.length > 0 && (condition as any).keyboardType !== 'none' && (\n                      <div className=\"mt-2 space-y-1\">\n                        <div className=\"flex items-center space-x-1 mb-1.5\">\n                          <i className=\"fas fa-keyboard text-xs text-amber-600 dark:text-amber-400\"></i>\n                          <span className=\"text-xs font-medium text-amber-700 dark:text-amber-300\">\n                            {(condition as any).keyboardType === 'inline' ? 'Inline' : 'Reply'} кнопки\n                          </span>\n                        </div>\n                        \n                        {(condition as any).keyboardType === 'inline' ? (\n                          <div className=\"grid grid-cols-2 gap-1\">\n                            {(condition as any).buttons.slice(0, 4).map((button: any, btnIndex: number) => (\n                              <div key={button.id || btnIndex} className=\"p-1.5 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded text-xs font-medium text-blue-700 dark:text-blue-300 text-center border border-blue-200/50 dark:border-blue-800/30 truncate\">\n                                {button.text}\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <div className=\"space-y-1\">\n                            {(condition as any).buttons.slice(0, 3).map((button: any, btnIndex: number) => (\n                              <div key={button.id || btnIndex} className=\"flex items-center justify-between p-1.5 bg-gradient-to-r from-gray-50 to-slate-50 dark:from-gray-800/30 dark:to-slate-800/30 rounded border border-gray-200/50 dark:border-gray-700/30\">\n                                <span className=\"text-xs font-medium text-gray-700 dark:text-gray-300 truncate\">{button.text}</span>\n                                {button.action === 'goto' && <i className=\"fas fa-arrow-right text-blue-600 dark:text-blue-400 text-xs opacity-70 ml-1\" title=\"Переход\"></i>}\n                                {button.action === 'command' && <i className=\"fas fa-terminal text-emerald-600 dark:text-emerald-400 text-xs opacity-70 ml-1\" title=\"Команда\"></i>}\n                                {button.action === 'url' && <i className=\"fas fa-external-link-alt text-purple-600 dark:text-purple-400 text-xs opacity-70 ml-1\" title=\"Ссылка\"></i>}\n                              </div>\n                            ))}\n                          </div>\n                        )}\n                        \n                        {(condition as any).buttons.length > ((condition as any).keyboardType === 'inline' ? 4 : 3) && (\n                          <div className=\"text-center\">\n                            <span className=\"text-xs text-slate-500 dark:text-slate-400\">\n                              +{(condition as any).buttons.length - ((condition as any).keyboardType === 'inline' ? 4 : 3)} еще\n                            </span>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                  </div>\n                );\n              })}\n            \n            {node.data.conditionalMessages.length > 3 && (\n              <div className=\"text-center py-2\">\n                <div className=\"text-xs text-purple-600 dark:text-purple-400 bg-purple-100/70 dark:bg-purple-900/30 px-3 py-2 rounded-lg border border-purple-200/30 dark:border-purple-800/30 inline-flex items-center space-x-1\">\n                  <i className=\"fas fa-ellipsis-h text-xs\"></i>\n                  <span>Еще {node.data.conditionalMessages.length - 3} условий</span>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n      \n      {/* Content Management Action Preview */}\n      {(node.type === 'pin_message' || node.type === 'unpin_message' || node.type === 'delete_message') && (\n        <div className=\"bg-gradient-to-br from-blue-50/80 to-cyan-50/80 dark:from-blue-900/30 dark:to-cyan-900/30 rounded-xl p-4 mb-4 border border-blue-200 dark:border-blue-700/50 shadow-sm\">\n          <div className=\"flex items-start space-x-3\">\n            <div className={cn(\"w-10 h-10 rounded-xl flex items-center justify-center shadow-sm\", nodeColors[node.type])}>\n              <i className={cn(nodeIcons[node.type], \"text-lg\")}></i>\n            </div>\n            <div className=\"flex-1 space-y-3\">\n              <div className=\"flex items-center space-x-2\">\n                <span className=\"text-sm font-semibold text-gray-800 dark:text-gray-200\">\n                  {node.type === 'pin_message' && 'Закрепить сообщение'}\n                  {node.type === 'unpin_message' && 'Открепить сообщение'}\n                  {node.type === 'delete_message' && 'Удалить сообщение'}\n                </span>\n                <div className=\"h-1.5 w-1.5 rounded-full bg-current opacity-30\"></div>\n                <span className=\"text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide font-medium\">\n                  Контент\n                </span>\n              </div>\n              \n              {/* Target Info */}\n              <div className=\"space-y-2\">\n                {node.data.targetGroupId && (\n                  <div className=\"flex items-center space-x-2 text-xs\">\n                    <i className=\"fas fa-users text-blue-500 dark:text-blue-400\"></i>\n                    <span className=\"text-gray-600 dark:text-gray-400\">Группа:</span>\n                    <code className=\"bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-1 rounded font-mono\">\n                      {node.data.targetGroupId}\n                    </code>\n                  </div>\n                )}\n                {node.data.targetMessageId && (\n                  <div className=\"flex items-center space-x-2 text-xs\">\n                    <i className=\"fas fa-comment text-purple-500 dark:text-purple-400\"></i>\n                    <span className=\"text-gray-600 dark:text-gray-400\">Сообщение:</span>\n                    <code className=\"bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-2 py-1 rounded font-mono\">\n                      {node.data.targetMessageId}\n                    </code>\n                  </div>\n                )}\n              </div>\n              \n              {/* Action Status */}\n              <div className=\"flex items-center space-x-2 pt-2 border-t border-blue-200/50 dark:border-blue-700/50\">\n                {(() => {\n                  // Все элементы управления контентом готовы к выполнению - ID определяется автоматически\n                  const isReady = true;\n                  \n                  return (\n                    <>\n                      <div className={cn(\n                        \"w-2 h-2 rounded-full\",\n                        \"bg-green-500\"\n                      )}></div>\n                      <span className=\"text-xs font-medium\">\n                        <span className=\"text-green-600 dark:text-green-400\">Готово к выполнению</span>\n                      </span>\n                    </>\n                  );\n                })()}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* User Management Action Preview */}\n      {(node.type === 'ban_user' || node.type === 'unban_user' || node.type === 'kick_user' || node.type === 'mute_user' || node.type === 'unmute_user' || node.type === 'promote_user' || node.type === 'demote_user') && (\n        <div className=\"bg-gradient-to-br from-gray-50/80 to-slate-50/80 dark:from-gray-900/30 dark:to-slate-900/30 rounded-xl p-4 mb-4 border border-gray-200 dark:border-gray-700/50 shadow-sm\">\n          <div className=\"flex items-start space-x-3\">\n            <div className={cn(\"w-10 h-10 rounded-xl flex items-center justify-center shadow-sm\", nodeColors[node.type])}>\n              <i className={cn(nodeIcons[node.type], \"text-lg\")}></i>\n            </div>\n            <div className=\"flex-1 space-y-3\">\n              <div className=\"flex items-center space-x-2\">\n                <span className=\"text-sm font-semibold text-gray-800 dark:text-gray-200\">\n                  {node.type === 'ban_user' && 'Заблокировать пользователя'}\n                  {node.type === 'unban_user' && 'Разблокировать пользователя'}\n                  {node.type === 'kick_user' && 'Исключить пользователя'}\n                  {node.type === 'mute_user' && 'Заглушить пользователя'}\n                  {node.type === 'unmute_user' && 'Разрешить говорить'}\n                  {node.type === 'promote_user' && 'Назначить администратором'}\n                  {node.type === 'demote_user' && 'Снять с администратора'}\n                </span>\n                <div className=\"h-1.5 w-1.5 rounded-full bg-current opacity-30\"></div>\n                <span className=\"text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide font-medium\">\n                  Действие\n                </span>\n              </div>\n              \n              {/* Target Info */}\n              <div className=\"space-y-2\">\n                {node.data.targetGroupId && (\n                  <div className=\"flex items-center space-x-2 text-xs\">\n                    <i className=\"fas fa-users text-blue-500 dark:text-blue-400\"></i>\n                    <span className=\"text-gray-600 dark:text-gray-400\">Группа:</span>\n                    <code className=\"bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-1 rounded font-mono\">\n                      {node.data.targetGroupId}\n                    </code>\n                  </div>\n                )}\n                {node.data.targetUserId && (\n                  <div className=\"flex items-center space-x-2 text-xs\">\n                    <i className=\"fas fa-user text-purple-500 dark:text-purple-400\"></i>\n                    <span className=\"text-gray-600 dark:text-gray-400\">Пользователь:</span>\n                    <code className=\"bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-2 py-1 rounded font-mono\">\n                      {node.data.targetUserId}\n                    </code>\n                  </div>\n                )}\n                {node.data.reason && (\n                  <div className=\"flex items-start space-x-2 text-xs\">\n                    <i className=\"fas fa-comment-dots text-orange-500 dark:text-orange-400 mt-0.5\"></i>\n                    <div className=\"flex-1\">\n                      <span className=\"text-gray-600 dark:text-gray-400\">Причина:</span>\n                      <div className=\"bg-orange-50 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-2 py-1 rounded mt-1 text-xs leading-relaxed\">\n                        {node.data.reason}\n                      </div>\n                    </div>\n                  </div>\n                )}\n                {(node.type === 'ban_user' || node.type === 'mute_user') && node.data.untilDate && (\n                  <div className=\"flex items-center space-x-2 text-xs\">\n                    <i className=\"fas fa-clock text-red-500 dark:text-red-400\"></i>\n                    <span className=\"text-gray-600 dark:text-gray-400\">До:</span>\n                    <span className=\"bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 px-2 py-1 rounded\">\n                      {new Date(node.data.untilDate * 1000).toLocaleString()}\n                    </span>\n                  </div>\n                )}\n              </div>\n              \n              {/* Action Status */}\n              <div className=\"flex items-center space-x-2 pt-2 border-t border-gray-200/50 dark:border-gray-700/50\">\n                {(() => {\n                  // Группа и пользователь определяются автоматически из контекста сообщения\n                  const isReady = true;\n                  \n                  return (\n                    <>\n                      <div className={cn(\n                        \"w-2 h-2 rounded-full\",\n                        \"bg-green-500\"\n                      )}></div>\n                      <span className=\"text-xs font-medium\">\n                        <span className=\"text-green-600 dark:text-green-400\">Готово к выполнению</span>\n                      </span>\n                    </>\n                  );\n                })()}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* Text Input Indicator for keyboard type 'none' */}\n      {node.type === 'keyboard' && node.data.keyboardType === 'none' && (node.data as any).enableTextInput && (\n        <div className=\"bg-gradient-to-br from-cyan-50/70 to-blue-50/70 dark:from-cyan-900/30 dark:to-blue-900/30 rounded-xl p-4 mb-4 border border-cyan-200 dark:border-cyan-800/30\">\n          <div className=\"flex items-center space-x-3\">\n            <div className=\"w-8 h-8 rounded-full bg-cyan-100 dark:bg-cyan-900/50 flex items-center justify-center\">\n              <i className=\"fas fa-keyboard text-cyan-600 dark:text-cyan-400 text-sm\"></i>\n            </div>\n            <div className=\"flex-1\">\n              <div className=\"text-sm font-medium text-cyan-800 dark:text-cyan-200 mb-1\">\n                Текстовый ввод\n              </div>\n              <div className=\"text-xs text-cyan-600 dark:text-cyan-400 space-y-1\">\n                {(node.data as any).inputVariable && (\n                  <div className=\"flex items-center space-x-1\">\n                    <i className=\"fas fa-tag text-xs\"></i>\n                    <span>Сохранить в: <code className=\"bg-cyan-100 dark:bg-cyan-900/50 px-1 py-0.5 rounded text-xs\">{(node.data as any).inputVariable}</code></span>\n                  </div>\n                )}\n                {(node.data as any).inputTargetNodeId && (\n                  <div className=\"flex items-center space-x-1\">\n                    <i className=\"fas fa-arrow-right text-xs\"></i>\n                    <span>Следующий узел: {(node.data as any).inputTargetNodeId}</span>\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* Buttons preview */}\n      {node.data.buttons && node.data.buttons.length > 0 && node.data.keyboardType !== 'none' && (\n        <div className=\"space-y-3\">\n          {(() => {\n            // Check if this is a multi-select node (has buttons with buttonType: \"option\")\n            const hasOptionButtons = node.data.buttons.some((button: any) => button.buttonType === 'option');\n            const isMultiSelect = hasOptionButtons && (node.data as any).allowMultipleSelection;\n            \n            return (\n              <>\n                <div className=\"flex items-center space-x-2 mb-3\">\n                  <div className=\"w-1 h-4 bg-amber-500 dark:bg-amber-400 rounded-full\"></div>\n                  <span className=\"text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide\">\n                    {isMultiSelect ? 'Множественный выбор' : \n                     node.data.keyboardType === 'inline' ? 'Inline кнопки' : 'Reply кнопки'}\n                  </span>\n                  {isMultiSelect && (\n                    <div className=\"text-xs text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-900/50 px-2 py-1 rounded-full\">\n                      <i className=\"fas fa-check-double text-xs mr-1\"></i>\n                      Мульти-выбор\n                    </div>\n                  )}\n                </div>\n                \n                {node.data.keyboardType === 'inline' ? (\n                  <div className=\"space-y-3\">\n                    {/* Option buttons for multi-select */}\n                    {isMultiSelect ? (\n                      <>\n                        <div className=\"grid grid-cols-2 gap-2\">\n                          {node.data.buttons.filter((button: any) => button.buttonType === 'option').map((button: any) => (\n                            <div key={button.id} className=\"group relative\">\n                              <div className=\"p-3 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 rounded-lg text-xs font-medium text-green-700 dark:text-green-300 text-center border border-green-200 dark:border-green-800 hover:border-green-300 dark:hover:border-green-700 transition-all duration-200 shadow-sm relative\">\n                              <div className=\"flex items-center justify-center space-x-1\">\n                                <i className=\"fas fa-square text-green-600 dark:text-green-400 text-xs opacity-50\" title=\"Невыбрано\"></i>\n                                <span className=\"truncate\">{button.text}</span>\n                              </div>\n                              {/* Simulated selected state */}\n                              <div className=\"absolute inset-0 bg-green-500/10 dark:bg-green-400/10 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none\"></div>\n                            </div>\n                            </div>\n                          ))}\n                        </div>\n                        \n                        {/* Show \"Done\" button for multi-select */}\n                        <div className=\"mt-3 pt-2 border-t border-gray-200 dark:border-gray-700\">\n                          <div className=\"p-3 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-lg text-xs font-medium text-blue-700 dark:text-blue-300 text-center border border-blue-200 dark:border-blue-800 shadow-sm\">\n                            <div className=\"flex items-center justify-center space-x-1\">\n                              <i className=\"fas fa-check text-blue-600 dark:text-blue-400 text-xs\"></i>\n                              <span>Готово</span>\n                            </div>\n                          </div>\n                        </div>\n                      </>\n                    ) : (\n                      /* Regular inline buttons */\n                      <div className=\"grid grid-cols-2 gap-2\">\n                        {node.data.buttons.map((button: any) => (\n                          <div key={button.id} className=\"group relative\">\n                            <div className=\"p-3 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-lg text-xs font-medium text-blue-700 dark:text-blue-300 text-center border border-blue-200 dark:border-blue-800 hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-200 shadow-sm\">\n                              <div className=\"flex items-center justify-center space-x-1\">\n                                <span className=\"truncate\">{button.text}</span>\n                                {button.action === 'command' && (\n                                  <i className=\"fas fa-terminal text-emerald-600 dark:text-emerald-400 text-xs opacity-70\" title=\"Команда\"></i>\n                                )}\n                                {button.action === 'url' && (\n                                  <i className=\"fas fa-external-link-alt text-purple-600 dark:text-purple-400 text-xs opacity-70\" title=\"Ссылка\"></i>\n                                )}\n                                {button.action === 'goto' && (\n                                  <i className=\"fas fa-arrow-right text-blue-600 dark:text-blue-400 text-xs opacity-70\" title=\"Переход\"></i>\n                                )}\n                                {button.action === 'selection' && (\n                                  <i className=\"fas fa-mouse-pointer text-purple-600 dark:text-purple-400 text-xs opacity-70\" title=\"Выбор\"></i>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                ) : (\n                  /* Reply keyboard buttons */\n                  <div className=\"space-y-2\">\n                    {node.data.buttons.map((button: any) => (\n                      <div key={button.id} className=\"flex items-center justify-between p-3 bg-gradient-to-r from-gray-50 to-slate-50 dark:from-gray-800/50 dark:to-slate-800/50 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm\">\n                        <span className=\"text-sm font-medium text-gray-700 dark:text-gray-300 truncate\">{button.text}</span>\n                        <div className=\"flex items-center space-x-1 ml-2\">\n                          {button.action === 'command' && (\n                            <i className=\"fas fa-terminal text-emerald-600 dark:text-emerald-400 text-xs opacity-70\" title=\"Команда\"></i>\n                          )}\n                          {button.action === 'url' && (\n                            <i className=\"fas fa-external-link-alt text-purple-600 dark:text-purple-400 text-xs opacity-70\" title=\"Ссылка\"></i>\n                          )}\n                          {button.action === 'goto' && (\n                            <i className=\"fas fa-arrow-right text-blue-600 dark:text-blue-400 text-xs opacity-70\" title=\"Переход\"></i>\n                          )}\n                          {button.action === 'selection' && (\n                            <i className=\"fas fa-mouse-pointer text-purple-600 dark:text-purple-400 text-xs opacity-70\" title=\"Выбор\"></i>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </>\n            );\n          })()}\n        </div>\n      )}\n      {/* Connection points */}\n      <button\n        className={cn(\n          \"absolute -left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 rounded-full border-2 border-white dark:border-slate-900 shadow-lg hover:scale-125 transition-all duration-300 opacity-0 group-hover:opacity-100 z-10\",\n          connectionStart?.nodeId === node.id && connectionStart?.handle === 'target'\n            ? \"bg-gradient-to-br from-emerald-400 to-green-500 hover:from-emerald-500 hover:to-green-600 animate-pulse shadow-2xl shadow-emerald-500/50 opacity-100\"\n            : connectionStart && connectionStart.nodeId !== node.id && connectionStart.handle === 'source'\n            ? \"bg-gradient-to-br from-emerald-300 to-green-400 hover:from-emerald-400 hover:to-green-500 animate-bounce shadow-xl shadow-emerald-400/40 opacity-100\"\n            : \"bg-gradient-to-br from-gray-400 to-gray-500 hover:from-blue-400 hover:to-blue-500 hover:shadow-blue-500/30\"\n        )}\n        onClick={(e) => {\n          e.stopPropagation();\n          onConnectionStart?.(node.id, 'target');\n        }}\n        title=\"Входящее соединение\"\n      >\n        <div className=\"absolute inset-1 rounded-full bg-white/30 dark:bg-slate-800/30 opacity-0 hover:opacity-100 transition-opacity duration-200\" />\n        <div className=\"absolute inset-0 rounded-full bg-current opacity-0 hover:opacity-10 transition-opacity duration-300 animate-ping\" />\n      </button>\n      <button\n        className={cn(\n          \"absolute -right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 rounded-full border-2 border-white dark:border-slate-900 shadow-lg hover:scale-125 transition-all duration-300 opacity-0 group-hover:opacity-100 z-10\",\n          connectionStart?.nodeId === node.id && connectionStart?.handle === 'source'\n            ? \"bg-gradient-to-br from-emerald-400 to-green-500 hover:from-emerald-500 hover:to-green-600 animate-pulse shadow-2xl shadow-emerald-500/50 opacity-100\"\n            : connectionStart && connectionStart.nodeId !== node.id && connectionStart.handle === 'target'\n            ? \"bg-gradient-to-br from-emerald-300 to-green-400 hover:from-emerald-400 hover:to-green-500 animate-bounce shadow-xl shadow-emerald-400/40 opacity-100\"\n            : \"bg-gradient-to-br from-blue-400 to-blue-500 hover:from-blue-500 hover:to-blue-600 hover:shadow-blue-500/30\"\n        )}\n        onClick={(e) => {\n          e.stopPropagation();\n          onConnectionStart?.(node.id, 'source');\n        }}\n        title=\"Исходящее соединение\"\n      >\n        <div className=\"absolute inset-1 rounded-full bg-white/30 dark:bg-slate-800/30 opacity-0 hover:opacity-100 transition-opacity duration-200\" />\n        <div className=\"absolute inset-0 rounded-full bg-current opacity-0 hover:opacity-10 transition-opacity duration-300 animate-ping\" />\n      </button>\n    </div>\n  );\n}\n","size_bytes":95596},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/pages/DatabaseManager.tsx":{"content":"import { useState, useEffect, useRef } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Switch } from '@/components/ui/switch';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { Progress } from '@/components/ui/progress';\nimport { useToast } from '@/hooks/use-toast';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useLocation } from 'wouter';\nimport { \n  Download, \n  Upload, \n  Database, \n  Shield, \n  Trash2, \n  RefreshCw, \n  FileText, \n  Calendar, \n  HardDrive, \n  BarChart3,\n  AlertTriangle,\n  CheckCircle,\n  Clock,\n  Settings,\n  Archive,\n  CloudDownload,\n  Plus,\n  ArrowLeft,\n  Home\n} from 'lucide-react';\n\ninterface BackupFile {\n  filename: string;\n  filepath: string;\n  size: number;\n  created: Date;\n  metadata?: {\n    version: string;\n    timestamp: string;\n    description?: string;\n    tables: string[];\n  };\n}\n\ninterface DatabaseStats {\n  tables: Array<{\n    name: string;\n    count: number;\n    size: string;\n  }>;\n  totalRecords: number;\n  estimatedSize: string;\n}\n\nexport default function DatabaseManager() {\n  const [, navigate] = useLocation();\n  const [newBackupDescription, setNewBackupDescription] = useState('');\n  const [uploadFile, setUploadFile] = useState<File | null>(null);\n  const [restoreImmediately, setRestoreImmediately] = useState(false);\n  const [clearExisting, setClearExisting] = useState(false);\n  const [selectedBackup, setSelectedBackup] = useState<string | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Получить список резервных копий\n  const { data: backupsData, isLoading: backupsLoading } = useQuery({\n    queryKey: ['database/backups'],\n    queryFn: () => apiRequest('GET', '/api/database/backups'),\n    staleTime: 30000\n  });\n\n  // Получить статистику базы данных\n  const { data: statsData, isLoading: statsLoading } = useQuery({\n    queryKey: ['database/stats'],\n    queryFn: () => apiRequest('GET', '/api/database/stats/detailed'),\n    staleTime: 60000\n  });\n\n  // Мутация для создания резервной копии\n  const createBackupMutation = useMutation({\n    mutationFn: (description: string) => \n      apiRequest('POST', '/api/database/backup', { description }),\n    onSuccess: () => {\n      toast({\n        title: \"Резервная копия создана\",\n        description: \"Резервная копия базы данных создана успешно\"\n      });\n      queryClient.invalidateQueries({ queryKey: ['database/backups'] });\n      setNewBackupDescription('');\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка создания резервной копии\",\n        description: error.message || \"Не удалось создать резервную копию\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Мутация для восстановления из резервной копии\n  const restoreBackupMutation = useMutation({\n    mutationFn: ({ filename, options }: { filename: string; options: any }) => \n      apiRequest('POST', '/api/database/restore', { filename, options }),\n    onSuccess: () => {\n      toast({\n        title: \"База данных восстановлена\",\n        description: \"База данных успешно восстановлена из резервной копии\"\n      });\n      queryClient.invalidateQueries({ queryKey: ['database/stats'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка восстановления\",\n        description: error.message || \"Не удалось восстановить базу данных\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Мутация для удаления резервной копии\n  const deleteBackupMutation = useMutation({\n    mutationFn: (filename: string) => \n      apiRequest('DELETE', `/api/database/backup/${filename}`),\n    onSuccess: () => {\n      toast({\n        title: \"Резервная копия удалена\",\n        description: \"Резервная копия успешно удалена\"\n      });\n      queryClient.invalidateQueries({ queryKey: ['database/backups'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка удаления\",\n        description: error.message || \"Не удалось удалить резервную копию\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Обработчик загрузки файла\n  const handleFileUpload = async () => {\n    if (!uploadFile) return;\n\n    setIsUploading(true);\n    try {\n      const formData = new FormData();\n      formData.append('backup', uploadFile);\n      formData.append('restoreImmediately', restoreImmediately.toString());\n      formData.append('clearExisting', clearExisting.toString());\n\n      const response = await fetch('/api/database/backup/upload', {\n        method: 'POST',\n        body: formData\n      });\n\n      const result = await response.json();\n      \n      if (result.success) {\n        toast({\n          title: \"Файл загружен\",\n          description: result.message\n        });\n        queryClient.invalidateQueries({ queryKey: ['database/backups'] });\n        if (result.restored) {\n          queryClient.invalidateQueries({ queryKey: ['database/stats'] });\n        }\n      } else {\n        throw new Error(result.error || 'Не удалось загрузить файл');\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Ошибка загрузки\",\n        description: error.message || \"Не удалось загрузить файл\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsUploading(false);\n      setUploadFile(null);\n    }\n  };\n\n  // Обработчик скачивания резервной копии\n  const handleDownloadBackup = (filename: string) => {\n    const downloadUrl = `/api/database/backup/${filename}`;\n    const link = document.createElement('a');\n    link.href = downloadUrl;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  };\n\n  // Форматирование размера файла\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  const backups: BackupFile[] = backupsData?.backups || [];\n  const stats: DatabaseStats = statsData?.stats || { tables: [], totalRecords: 0, estimatedSize: 'N/A' };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto p-6 space-y-6\">\n        {/* Заголовок с навигацией */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-4\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => navigate('/')}\n              className=\"flex items-center gap-2\"\n            >\n              <ArrowLeft className=\"w-4 h-4\" />\n              Назад к редактору\n            </Button>\n            <Separator orientation=\"vertical\" className=\"h-6\" />\n            <div>\n              <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n                <Database className=\"w-8 h-8\" />\n                Управление базой данных\n              </h1>\n              <p className=\"text-muted-foreground mt-1\">\n                Создание резервных копий, восстановление и мониторинг базы данных\n              </p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => queryClient.invalidateQueries()}\n              disabled={backupsLoading || statsLoading}\n            >\n              <RefreshCw className={`w-4 h-4 mr-2 ${backupsLoading || statsLoading ? 'animate-spin' : ''}`} />\n              Обновить\n            </Button>\n            <Badge variant=\"secondary\" className=\"text-sm\">\n              <Shield className=\"w-4 h-4 mr-1\" />\n              Безопасность данных\n            </Badge>\n          </div>\n        </div>\n\n        {/* Быстрые действия с базой данных */}\n        <Card className=\"border-blue-200 bg-blue-50/50 dark:border-blue-800 dark:bg-blue-950/50\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2 text-blue-700 dark:text-blue-300\">\n              <Database className=\"w-5 h-5\" />\n              Быстрые действия\n            </CardTitle>\n            <CardDescription>\n              Экспорт и импорт всей базы данных одним файлом\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-col sm:flex-row gap-4\">\n              {/* Экспорт базы данных */}\n              <Button\n                onClick={() => createBackupMutation.mutate('Быстрый экспорт базы данных')}\n                disabled={createBackupMutation.isPending}\n                className=\"flex-1\"\n                variant=\"default\"\n              >\n                {createBackupMutation.isPending ? (\n                  <RefreshCw className=\"w-4 h-4 animate-spin mr-2\" />\n                ) : (\n                  <Download className=\"w-4 h-4 mr-2\" />\n                )}\n                Экспорт всей базы данных\n              </Button>\n              \n              {/* Импорт базы данных */}\n              <div className=\"flex-1\">\n                <Input\n                  type=\"file\"\n                  accept=\".json\"\n                  ref={fileInputRef}\n                  onChange={(e) => setUploadFile(e.target.files?.[0] || null)}\n                  className=\"hidden\"\n                />\n                <Button\n                  onClick={() => fileInputRef.current?.click()}\n                  variant=\"outline\"\n                  className=\"w-full\"\n                >\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  Импорт базы данных\n                </Button>\n              </div>\n            </div>\n            \n            {/* Диалог импорта */}\n            {uploadFile && (\n              <div className=\"mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800\">\n                <div className=\"flex items-center gap-2 mb-3\">\n                  <AlertTriangle className=\"w-5 h-5 text-yellow-600 dark:text-yellow-400\" />\n                  <span className=\"font-medium text-yellow-800 dark:text-yellow-200\">\n                    Файл готов к импорту\n                  </span>\n                </div>\n                <p className=\"text-sm text-yellow-700 dark:text-yellow-300 mb-3\">\n                  Выбранный файл: <strong>{uploadFile.name}</strong>\n                </p>\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Switch\n                      id=\"restore-immediately-quick\"\n                      checked={restoreImmediately}\n                      onCheckedChange={setRestoreImmediately}\n                    />\n                    <Label htmlFor=\"restore-immediately-quick\" className=\"text-sm\">\n                      Восстановить базу данных сразу\n                    </Label>\n                  </div>\n                  \n                  {restoreImmediately && (\n                    <div className=\"flex items-center space-x-2\">\n                      <Switch\n                        id=\"clear-existing-quick\"\n                        checked={clearExisting}\n                        onCheckedChange={setClearExisting}\n                      />\n                      <Label htmlFor=\"clear-existing-quick\" className=\"text-sm\">\n                        Очистить существующие данные\n                      </Label>\n                    </div>\n                  )}\n                  \n                  <div className=\"flex gap-2\">\n                    <Button\n                      onClick={handleFileUpload}\n                      disabled={isUploading}\n                      size=\"sm\"\n                      className=\"flex-1\"\n                    >\n                      {isUploading ? (\n                        <RefreshCw className=\"w-4 h-4 animate-spin mr-2\" />\n                      ) : (\n                        <CheckCircle className=\"w-4 h-4 mr-2\" />\n                      )}\n                      Импортировать\n                    </Button>\n                    <Button\n                      onClick={() => {\n                        setUploadFile(null);\n                        if (fileInputRef.current) {\n                          fileInputRef.current.value = '';\n                        }\n                      }}\n                      size=\"sm\"\n                      variant=\"outline\"\n                      className=\"flex-1\"\n                    >\n                      Отмена\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Статистика базы данных */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <BarChart3 className=\"w-5 h-5\" />\n              Статистика базы данных\n            </CardTitle>\n            <CardDescription>\n              Текущее состояние и размер базы данных\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {statsLoading ? (\n              <div className=\"flex items-center gap-2\">\n                <RefreshCw className=\"w-4 h-4 animate-spin\" />\n                Загрузка статистики...\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div className=\"p-4 bg-muted rounded-lg\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <HardDrive className=\"w-4 h-4\" />\n                      <span className=\"font-medium\">Общие записи</span>\n                    </div>\n                    <div className=\"text-2xl font-bold\">{stats.totalRecords.toLocaleString()}</div>\n                  </div>\n                  <div className=\"p-4 bg-muted rounded-lg\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <Archive className=\"w-4 h-4\" />\n                      <span className=\"font-medium\">Таблицы</span>\n                    </div>\n                    <div className=\"text-2xl font-bold\">{stats.tables.length}</div>\n                  </div>\n                  <div className=\"p-4 bg-muted rounded-lg\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <Database className=\"w-4 h-4\" />\n                      <span className=\"font-medium\">Размер</span>\n                    </div>\n                    <div className=\"text-2xl font-bold\">{stats.estimatedSize}</div>\n                  </div>\n                </div>\n                \n                <Separator />\n                \n                <div className=\"space-y-2\">\n                  <h4 className=\"font-medium\">Детализация по таблицам:</h4>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                    {stats.tables.map((table, index) => (\n                      <div key={index} className=\"flex items-center justify-between p-3 bg-muted rounded-lg\">\n                        <div className=\"flex items-center gap-2\">\n                          <FileText className=\"w-4 h-4\" />\n                          <span className=\"font-medium\">{table.name}</span>\n                        </div>\n                        <div className=\"text-sm text-muted-foreground\">\n                          {table.count.toLocaleString()} записей\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Создание резервной копии */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Plus className=\"w-5 h-5\" />\n              Создать резервную копию\n            </CardTitle>\n            <CardDescription>\n              Создание полной резервной копии базы данных\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"backup-description\">Описание резервной копии</Label>\n              <Textarea\n                id=\"backup-description\"\n                placeholder=\"Опишите цель создания резервной копии...\"\n                value={newBackupDescription}\n                onChange={(e) => setNewBackupDescription(e.target.value)}\n                rows={3}\n              />\n            </div>\n            <Button \n              onClick={() => createBackupMutation.mutate(newBackupDescription)}\n              disabled={createBackupMutation.isPending}\n              className=\"w-full\"\n            >\n              {createBackupMutation.isPending ? (\n                <RefreshCw className=\"w-4 h-4 animate-spin mr-2\" />\n              ) : (\n                <Archive className=\"w-4 h-4 mr-2\" />\n              )}\n              Создать резервную копию\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Загрузка резервной копии */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Upload className=\"w-5 h-5\" />\n              Загрузить резервную копию\n            </CardTitle>\n            <CardDescription>\n              Загрузка резервной копии из файла\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"backup-file\">Выберите файл резервной копии</Label>\n              <Input\n                id=\"backup-file\"\n                type=\"file\"\n                accept=\".json\"\n                onChange={(e) => setUploadFile(e.target.files?.[0] || null)}\n              />\n            </div>\n            \n            <div className=\"space-y-3\">\n              <div className=\"flex items-center space-x-2\">\n                <Switch\n                  id=\"restore-immediately\"\n                  checked={restoreImmediately}\n                  onCheckedChange={setRestoreImmediately}\n                />\n                <Label htmlFor=\"restore-immediately\">Восстановить немедленно</Label>\n              </div>\n              \n              {restoreImmediately && (\n                <div className=\"flex items-center space-x-2 ml-6\">\n                  <Switch\n                    id=\"clear-existing\"\n                    checked={clearExisting}\n                    onCheckedChange={setClearExisting}\n                  />\n                  <Label htmlFor=\"clear-existing\">Очистить существующие данные</Label>\n                </div>\n              )}\n            </div>\n\n            <Button \n              onClick={handleFileUpload}\n              disabled={!uploadFile || isUploading}\n              className=\"w-full\"\n            >\n              {isUploading ? (\n                <RefreshCw className=\"w-4 h-4 animate-spin mr-2\" />\n              ) : (\n                <CloudDownload className=\"w-4 h-4 mr-2\" />\n              )}\n              Загрузить файл\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Список резервных копий */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Archive className=\"w-5 h-5\" />\n              Резервные копии\n            </CardTitle>\n            <CardDescription>\n              Список доступных резервных копий\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {backupsLoading ? (\n              <div className=\"flex items-center gap-2\">\n                <RefreshCw className=\"w-4 h-4 animate-spin\" />\n                Загрузка списка резервных копий...\n              </div>\n            ) : backups.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Archive className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                <p>Резервные копии не найдены</p>\n                <p className=\"text-sm\">Создайте первую резервную копию</p>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {backups.map((backup, index) => (\n                  <div key={index} className=\"p-4 border rounded-lg\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          <FileText className=\"w-4 h-4\" />\n                          <span className=\"font-medium\">{backup.filename}</span>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {backup.metadata?.version || 'v1.0.0'}\n                          </Badge>\n                        </div>\n                        <div className=\"text-sm text-muted-foreground space-y-1\">\n                          <div className=\"flex items-center gap-4\">\n                            <div className=\"flex items-center gap-1\">\n                              <Calendar className=\"w-3 h-3\" />\n                              {new Date(backup.created).toLocaleString()}\n                            </div>\n                            <div className=\"flex items-center gap-1\">\n                              <HardDrive className=\"w-3 h-3\" />\n                              {formatFileSize(backup.size)}\n                            </div>\n                          </div>\n                          {backup.metadata?.description && (\n                            <p className=\"text-xs\">{backup.metadata.description}</p>\n                          )}\n                          {backup.metadata?.tables && (\n                            <div className=\"flex items-center gap-1\">\n                              <Database className=\"w-3 h-3\" />\n                              <span className=\"text-xs\">\n                                Таблицы: {backup.metadata.tables.join(', ')}\n                              </span>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleDownloadBackup(backup.filename)}\n                        >\n                          <Download className=\"w-4 h-4\" />\n                        </Button>\n                        <Dialog>\n                          <DialogTrigger asChild>\n                            <Button size=\"sm\" variant=\"outline\">\n                              <RefreshCw className=\"w-4 h-4\" />\n                            </Button>\n                          </DialogTrigger>\n                          <DialogContent>\n                            <DialogHeader>\n                              <DialogTitle>Восстановить базу данных</DialogTitle>\n                              <DialogDescription>\n                                Восстановление из резервной копии {backup.filename}\n                              </DialogDescription>\n                            </DialogHeader>\n                            <div className=\"space-y-4\">\n                              <div className=\"flex items-center space-x-2\">\n                                <Switch\n                                  id=\"restore-clear\"\n                                  checked={clearExisting}\n                                  onCheckedChange={setClearExisting}\n                                />\n                                <Label htmlFor=\"restore-clear\">Очистить существующие данные</Label>\n                              </div>\n                              <div className=\"flex items-center gap-2 p-3 bg-muted rounded-lg\">\n                                <AlertTriangle className=\"w-4 h-4 text-orange-500\" />\n                                <span className=\"text-sm\">\n                                  Эта операция изменит текущие данные в базе\n                                </span>\n                              </div>\n                              <div className=\"flex gap-2\">\n                                <Button\n                                  onClick={() => restoreBackupMutation.mutate({ \n                                    filename: backup.filename, \n                                    options: { clearExisting } \n                                  })}\n                                  disabled={restoreBackupMutation.isPending}\n                                  className=\"flex-1\"\n                                >\n                                  {restoreBackupMutation.isPending ? (\n                                    <RefreshCw className=\"w-4 h-4 animate-spin mr-2\" />\n                                  ) : (\n                                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                                  )}\n                                  Восстановить\n                                </Button>\n                              </div>\n                            </div>\n                          </DialogContent>\n                        </Dialog>\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => deleteBackupMutation.mutate(backup.filename)}\n                          disabled={deleteBackupMutation.isPending}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","size_bytes":28013},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/components/editor/user-database-panel.tsx":{"content":"import { useState, useMemo, useEffect } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Badge } from '@/components/ui/badge';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Switch } from '@/components/ui/switch';\nimport { Separator } from '@/components/ui/separator';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from '@/components/ui/alert-dialog';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { \n  Users, \n  Search, \n  Filter, \n  Download, \n  Trash2, \n  Plus, \n  BarChart3, \n  Activity, \n  Shield, \n  Crown, \n  MessageSquare,\n  Calendar,\n  Settings,\n  RefreshCw,\n  Eye,\n  UserCheck,\n  UserX,\n  Edit,\n  Send,\n  Bot,\n  User,\n  Database\n} from 'lucide-react';\nimport { UserBotData, BotProject, BotMessage } from '@shared/schema';\nimport { DatabaseBackupPanel } from './database-backup-panel';\nimport { useIsMobile } from '@/hooks/use-mobile';\nimport { format } from 'date-fns';\nimport { ru } from 'date-fns/locale';\n\ntype BotMessageWithMedia = BotMessage & {\n  media?: Array<{\n    id: number;\n    url: string;\n    type: string;\n    width?: number;\n    height?: number;\n  }>;\n};\n\ninterface UserDatabasePanelProps {\n  projectId: number;\n  projectName: string;\n}\n\ntype SortField = 'lastInteraction' | 'interactionCount' | 'createdAt' | 'firstName' | 'userName';\ntype SortDirection = 'asc' | 'desc';\n\nexport function UserDatabasePanel({ projectId, projectName }: UserDatabasePanelProps) {\n  const [searchQuery, setSearchQuery] = useState('');\n  const [selectedUser, setSelectedUser] = useState<UserBotData | null>(null);\n  const [showUserDetails, setShowUserDetails] = useState(false);\n  const [showCreateUser, setShowCreateUser] = useState(false);\n  const [sortField, setSortField] = useState<SortField>('lastInteraction');\n  const [sortDirection, setSortDirection] = useState<SortDirection>('desc');\n  const [filterActive, setFilterActive] = useState<boolean | null>(null);\n  const [filterPremium, setFilterPremium] = useState<boolean | null>(null);\n  const [filterBlocked, setFilterBlocked] = useState<boolean | null>(null);\n  const [filterDateRange, setFilterDateRange] = useState<'all' | 'today' | 'week' | 'month'>('all');\n  const [selectedUsers, setSelectedUsers] = useState<number[]>([]);\n  const [showBulkActions, setShowBulkActions] = useState(false);\n  const [showDialog, setShowDialog] = useState(false);\n  const [selectedUserForDialog, setSelectedUserForDialog] = useState<UserBotData | null>(null);\n  const [messageText, setMessageText] = useState('');\n\n  const { toast } = useToast();\n  const qClient = useQueryClient();\n  const isMobile = useIsMobile();\n\n  // Fetch project data to get userDatabaseEnabled setting\n  const { data: project } = useQuery<BotProject>({\n    queryKey: [`/api/projects/${projectId}`],\n  });\n\n  // Fetch user data\n  const { data: users = [], isLoading: usersLoading, refetch: refetchUsers } = useQuery<UserBotData[]>({\n    queryKey: [`/api/projects/${projectId}/users`],\n    staleTime: 0,\n    gcTime: 0,\n  });\n\n  // Fetch user stats  \n  const { data: stats = {}, isLoading: statsLoading, refetch: refetchStats } = useQuery<{\n    totalUsers?: number;\n    activeUsers?: number;\n    blockedUsers?: number;\n    premiumUsers?: number;\n    totalInteractions?: number;\n    avgInteractionsPerUser?: number;\n    usersWithResponses?: number;\n  }>({\n    queryKey: [`/api/projects/${projectId}/users/stats`],\n    staleTime: 0,\n    gcTime: 0,\n  });\n\n  // Search users\n  const { data: searchResults = [], isFetching: searchLoading } = useQuery<UserBotData[]>({\n    queryKey: [`/api/projects/${projectId}/users/search`, searchQuery],\n    enabled: searchQuery.length > 0,\n    queryFn: () => apiRequest('GET', `/api/projects/${projectId}/users/search?q=${encodeURIComponent(searchQuery)}`),\n  });\n\n  // Fetch messages for dialog\n  const { data: messages = [], isLoading: messagesLoading, refetch: refetchMessages } = useQuery<BotMessageWithMedia[]>({\n    queryKey: [`/api/projects/${projectId}/users/${selectedUserForDialog?.userId}/messages`],\n    enabled: showDialog && !!selectedUserForDialog?.userId,\n    staleTime: 0,\n    refetchOnMount: 'always',\n    refetchOnWindowFocus: true,\n  });\n\n  // Delete user mutation\n  const deleteUserMutation = useMutation({\n    mutationFn: (userId: number) => {\n      console.log(`Attempting to delete user with ID: ${userId}`);\n      return apiRequest('DELETE', `/api/users/${userId}`);\n    },\n    onSuccess: (data) => {\n      console.log(\"User deletion successful:\", data);\n      // Force clear cache and refetch\n      qClient.removeQueries({ queryKey: [`/api/projects/${projectId}/users`] });\n      qClient.removeQueries({ queryKey: [`/api/projects/${projectId}/users/stats`] });\n      \n      // Delay refetch to ensure cache is cleared\n      setTimeout(() => {\n        refetchUsers();\n        refetchStats();\n      }, 100);\n      \n      toast({\n        title: \"Пользователь удален\",\n        description: \"Данные пользователя успешно удалены\",\n      });\n    },\n    onError: (error) => {\n      console.error(\"User deletion failed:\", error);\n      toast({\n        title: \"Ошибка удаления\",\n        description: \"Не удалось удалить пользователя. Проверьте консоль для подробностей.\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Update user mutation\n  const updateUserMutation = useMutation({\n    mutationFn: ({ userId, data }: { userId: number; data: Partial<UserBotData> }) => \n      apiRequest('PUT', `/api/users/${userId}`, data),\n    onSuccess: () => {\n      // Принудительно очищаем кэш и обновляем данные\n      qClient.removeQueries({ queryKey: [`/api/projects/${projectId}/users`] });\n      qClient.removeQueries({ queryKey: [`/api/projects/${projectId}/users/stats`] });\n      \n      // Принудительно обновляем данные\n      setTimeout(() => {\n        refetchUsers();\n        refetchStats();\n      }, 100);\n      \n      toast({\n        title: \"Статус изменен\",\n        description: \"Статус пользователя успешно обновлен\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Ошибка\",\n        description: \"Не удалось обновить статус пользователя\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Delete all users mutation\n  const deleteAllUsersMutation = useMutation({\n    mutationFn: () => {\n      console.log(`Attempting to delete all users for project: ${projectId}`);\n      return apiRequest('DELETE', `/api/projects/${projectId}/users`);\n    },\n    onSuccess: (data) => {\n      console.log(\"Bulk deletion successful:\", data);\n      // Force clear cache and refetch\n      qClient.removeQueries({ queryKey: [`/api/projects/${projectId}/users`] });\n      qClient.removeQueries({ queryKey: [`/api/projects/${projectId}/users/stats`] });\n      \n      // Delay refetch to ensure cache is cleared\n      setTimeout(() => {\n        refetchUsers();\n        refetchStats();\n      }, 100);\n      \n      const deletedCount = data?.deletedCount || 0;\n      toast({\n        title: \"База данных очищена\",\n        description: `Удалено записей: ${deletedCount}. Все пользовательские данные удалены.`,\n      });\n    },\n    onError: (error) => {\n      console.error(\"Bulk deletion failed:\", error);\n      toast({\n        title: \"Ошибка очистки базы\",\n        description: \"Не удалось очистить базу данных. Проверьте консоль для подробностей.\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Toggle user database enabled mutation\n  const toggleDatabaseMutation = useMutation({\n    mutationFn: (enabled: boolean) => \n      apiRequest('PUT', `/api/projects/${projectId}`, { userDatabaseEnabled: enabled ? 1 : 0 }),\n    onSuccess: (data, enabled) => {\n      qClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}`] });\n      toast({\n        title: enabled ? \"База данных включена\" : \"База данных выключена\",\n        description: enabled \n          ? \"Функции работы с базой данных пользователей будут генерироваться в коде бота.\" \n          : \"Функции работы с базой данных НЕ будут генерироваться в коде бота.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Ошибка\",\n        description: \"Не удалось изменить настройку базы данных\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Send message mutation\n  const sendMessageMutation = useMutation({\n    mutationFn: (data: { messageText: string }) => {\n      console.log('selectedUserForDialog:', selectedUserForDialog);\n      console.log('userId field:', selectedUserForDialog?.userId);\n      \n      const userId = selectedUserForDialog?.userId;\n      if (!userId) {\n        throw new Error('User ID is required');\n      }\n      return apiRequest('POST', `/api/projects/${projectId}/users/${userId}/send-message`, data);\n    },\n    onSuccess: () => {\n      qClient.invalidateQueries({ \n        queryKey: [`/api/projects/${projectId}/users/${selectedUserForDialog?.userId}/messages`] \n      });\n      setMessageText('');\n      toast({\n        title: \"Сообщение отправлено\",\n        description: \"Сообщение успешно отправлено пользователю\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка отправки\",\n        description: error?.message || \"Не удалось отправить сообщение\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Refetch messages when dialog opens\n  useEffect(() => {\n    if (showDialog && selectedUserForDialog?.userId) {\n      refetchMessages();\n    }\n  }, [showDialog, selectedUserForDialog?.userId, refetchMessages]);\n\n  // Filter and sort users\n  const filteredAndSortedUsers = useMemo(() => {\n    let result = searchQuery.length > 0 ? searchResults : users;\n\n    // Apply filters\n    if (filterActive !== null) {\n      result = result.filter(user => Boolean(user.isActive) === filterActive);\n    }\n    if (filterPremium !== null) {\n      result = result.filter(user => Boolean(user.isPremium) === filterPremium);\n    }\n    if (filterBlocked !== null) {\n      result = result.filter(user => Boolean(user.isBlocked) === filterBlocked);\n    }\n\n    // Sort\n    result = [...result].sort((a, b) => {\n      let aValue: any, bValue: any;\n      \n      // Get field values\n      if (sortField === 'lastInteraction') {\n        aValue = a.lastInteraction;\n        bValue = b.lastInteraction;\n      } else if (sortField === 'createdAt') {\n        aValue = a.createdAt;\n        bValue = b.createdAt;\n      } else if (sortField === 'interactionCount') {\n        aValue = a.interactionCount;\n        bValue = b.interactionCount;\n      } else if (sortField === 'firstName') {\n        aValue = a.firstName;\n        bValue = b.firstName;\n      } else if (sortField === 'userName') {\n        aValue = a.userName;\n        bValue = b.userName;\n      } else {\n        aValue = a[sortField];\n        bValue = b[sortField];\n      }\n\n      if (sortField === 'lastInteraction' || sortField === 'createdAt') {\n        aValue = new Date(aValue || 0).getTime();\n        bValue = new Date(bValue || 0).getTime();\n      } else if (typeof aValue === 'string') {\n        aValue = aValue.toLowerCase();\n        bValue = bValue?.toLowerCase() || '';\n      }\n\n      if (sortDirection === 'asc') {\n        return aValue > bValue ? 1 : -1;\n      } else {\n        return aValue < bValue ? 1 : -1;\n      }\n    });\n\n    return result;\n  }, [users, searchResults, searchQuery, filterActive, filterPremium, filterBlocked, sortField, sortDirection]);\n\n  const handleRefresh = () => {\n    refetchUsers();\n    refetchStats();\n  };\n\n  const handleUserStatusToggle = (user: UserBotData, field: 'isActive' | 'isBlocked' | 'isPremium') => {\n    const currentValue = user[field];\n    const newValue = currentValue === 1 ? 0 : 1;\n    const userId = user.id;\n    \n    if (!userId) {\n      console.error('User ID not found');\n      return;\n    }\n    \n    // Только isActive работает в базе данных\n    if (field === 'isActive') {\n      updateUserMutation.mutate({\n        userId: userId,\n        data: { [field]: newValue }\n      });\n    } else {\n      toast({\n        title: \"Функция недоступна\",\n        description: `Изменение статуса \"${field}\" пока не поддерживается`,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const formatDate = (date: string | Date | null) => {\n    if (!date) return 'Никогда';\n    return new Date(date).toLocaleString('ru-RU', {\n      timeZone: 'Europe/Moscow',\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  const formatUserName = (user: UserBotData) => {\n    const firstName = user.firstName;\n    const lastName = user.lastName;\n    const userName = user.userName;\n    const userId = user.userId;\n    \n    const parts = [firstName, lastName].filter(Boolean);\n    if (parts.length > 0) return parts.join(' ');\n    if (userName) return `@${userName}`;\n    return `ID: ${userId}`;\n  };\n\n  if (usersLoading || statsLoading) {\n    return (\n      <div className=\"h-full flex items-center justify-center\">\n        <div className=\"text-center\">\n          <RefreshCw className=\"w-8 h-8 animate-spin text-muted-foreground mx-auto mb-2\" />\n          <p className=\"text-muted-foreground\">Загрузка базы данных...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const isDatabaseEnabled = project?.userDatabaseEnabled === 1;\n\n  return (\n    <div className=\"h-full flex flex-col bg-background min-h-0\">\n      <div className=\"border-b bg-card flex-none\">\n        <div className=\"p-4\">\n          <div className={`flex ${isMobile ? 'flex-col gap-3' : 'items-center justify-between'} mb-4`}>\n            <div>\n              <h2 className={`${isMobile ? 'text-lg' : 'text-xl'} font-semibold flex items-center gap-2`}>\n                <Users className=\"w-5 h-5\" />\n                База данных пользователей\n              </h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Управление пользователями бота \"{projectName}\"\n              </p>\n            </div>\n            <div className={`flex items-center gap-2 ${isMobile ? 'self-stretch flex-wrap' : ''}`}>\n              {/* Database Toggle */}\n              <div className={`flex items-center gap-3 p-3 border-2 rounded-lg transition-all ${\n                isDatabaseEnabled \n                  ? 'bg-green-50 dark:bg-green-950 border-green-500 dark:border-green-600' \n                  : 'bg-red-50 dark:bg-red-950 border-red-500 dark:border-red-600'\n              } ${isMobile ? 'flex-1 min-w-full' : ''}`} data-testid=\"database-toggle-container\">\n                <Database className={`w-5 h-5 ${isDatabaseEnabled ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`} />\n                <Label htmlFor=\"db-toggle\" className={`text-base font-bold cursor-pointer flex-1 ${\n                  isDatabaseEnabled \n                    ? 'text-green-700 dark:text-green-300' \n                    : 'text-red-700 dark:text-red-300'\n                }`}>\n                  {isDatabaseEnabled ? 'БД включена' : 'БД выключена'}\n                </Label>\n                <Switch\n                  id=\"db-toggle\"\n                  data-testid=\"switch-database-toggle\"\n                  checked={isDatabaseEnabled}\n                  onCheckedChange={(checked) => toggleDatabaseMutation.mutate(checked)}\n                  disabled={toggleDatabaseMutation.isPending}\n                  className=\"scale-110\"\n                />\n              </div>\n              {isDatabaseEnabled && (\n                <>\n                  <Button onClick={handleRefresh} variant=\"outline\" size={isMobile ? \"sm\" : \"sm\"} className={isMobile ? 'flex-1' : ''}>\n                    <RefreshCw className=\"w-4 h-4 mr-1\" />\n                    {isMobile ? 'Обновить' : 'Обновить'}\n                  </Button>\n                  <AlertDialog>\n                    <AlertDialogTrigger asChild>\n                      <Button variant=\"destructive\" size={isMobile ? \"sm\" : \"sm\"} className={isMobile ? 'flex-1' : ''}>\n                        <Trash2 className=\"w-4 h-4 mr-1\" />\n                        {isMobile ? 'Очистить' : 'Очистить базу'}\n                      </Button>\n                    </AlertDialogTrigger>\n                    <AlertDialogContent>\n                      <AlertDialogHeader>\n                        <AlertDialogTitle>Удалить все данные пользователей?</AlertDialogTitle>\n                        <AlertDialogDescription>\n                          Это действие нельзя отменить. Все данные пользователей для этого бота будут удалены навсегда.\n                        </AlertDialogDescription>\n                      </AlertDialogHeader>\n                      <AlertDialogFooter>\n                        <AlertDialogCancel>Отмена</AlertDialogCancel>\n                        <AlertDialogAction\n                          onClick={() => deleteAllUsersMutation.mutate()}\n                          className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                        >\n                          Удалить все\n                        </AlertDialogAction>\n                      </AlertDialogFooter>\n                    </AlertDialogContent>\n                  </AlertDialog>\n                </>\n              )}\n            </div>\n          </div>\n\n          {/* Stats Cards */}\n          {isDatabaseEnabled && stats && (\n            <div className={`grid ${isMobile ? 'grid-cols-2' : 'grid-cols-2 md:grid-cols-7'} gap-3 mb-4`}>\n              <Card className=\"p-3\">\n                <div className=\"flex items-center gap-2\">\n                  <Users className=\"w-4 h-4 text-blue-500\" />\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Всего</p>\n                    <p className=\"text-sm font-semibold\">{stats.totalUsers}</p>\n                  </div>\n                </div>\n              </Card>\n              <Card className=\"p-3\">\n                <div className=\"flex items-center gap-2\">\n                  <Activity className=\"w-4 h-4 text-green-500\" />\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Активных</p>\n                    <p className=\"text-sm font-semibold\">{stats.activeUsers}</p>\n                  </div>\n                </div>\n              </Card>\n              <Card className=\"p-3\">\n                <div className=\"flex items-center gap-2\">\n                  <Shield className=\"w-4 h-4 text-red-500\" />\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Заблокировано</p>\n                    <p className=\"text-sm font-semibold\">{stats.blockedUsers}</p>\n                  </div>\n                </div>\n              </Card>\n              <Card className=\"p-3\">\n                <div className=\"flex items-center gap-2\">\n                  <Crown className=\"w-4 h-4 text-yellow-500\" />\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Premium</p>\n                    <p className=\"text-sm font-semibold\">{stats.premiumUsers}</p>\n                  </div>\n                </div>\n              </Card>\n              <Card className=\"p-3\">\n                <div className=\"flex items-center gap-2\">\n                  <MessageSquare className=\"w-4 h-4 text-purple-500\" />\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Сообщений</p>\n                    <p className=\"text-sm font-semibold\">{stats.totalInteractions}</p>\n                  </div>\n                </div>\n              </Card>\n              <Card className=\"p-3\">\n                <div className=\"flex items-center gap-2\">\n                  <BarChart3 className=\"w-4 h-4 text-indigo-500\" />\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Среднее</p>\n                    <p className=\"text-sm font-semibold\">{stats.avgInteractionsPerUser}</p>\n                  </div>\n                </div>\n              </Card>\n              <Card className=\"p-3\">\n                <div className=\"flex items-center gap-2\">\n                  <Edit className=\"w-4 h-4 text-orange-500\" />\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">С ответами</p>\n                    <p className=\"text-sm font-semibold\">{stats.usersWithResponses || 0}</p>\n                  </div>\n                </div>\n              </Card>\n            </div>\n          )}\n\n          {/* Search and Filters */}\n          {isDatabaseEnabled && (\n            <div className={`flex ${isMobile ? 'flex-col' : 'flex-col sm:flex-row'} gap-3`}>\n              <div className=\"flex-1 relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                <Input\n                  placeholder={isMobile ? \"Поиск...\" : \"Поиск по имени, username или ID...\"}\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n              <div className={`flex gap-2 ${isMobile ? 'grid grid-cols-2' : 'flex'}`}>\n                <Select value={filterActive?.toString() || 'all'} onValueChange={(value) => setFilterActive(value === 'all' ? null : value === 'true')}>\n                  <SelectTrigger className={isMobile ? 'w-full' : 'w-32'}>\n                    <SelectValue placeholder=\"Статус\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Все</SelectItem>\n                    <SelectItem value=\"true\">Активные</SelectItem>\n                    <SelectItem value=\"false\">Неактивные</SelectItem>\n                  </SelectContent>\n                </Select>\n\n                <Select value={filterPremium?.toString() || 'all'} onValueChange={(value) => setFilterPremium(value === 'all' ? null : value === 'true')}>\n                  <SelectTrigger className={isMobile ? 'w-full' : 'w-32'}>\n                    <SelectValue placeholder=\"Premium\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Все</SelectItem>\n                    <SelectItem value=\"true\">Premium</SelectItem>\n                    <SelectItem value=\"false\">Обычные</SelectItem>\n                  </SelectContent>\n                </Select>\n\n                <Select value={`${sortField}-${sortDirection}`} onValueChange={(value) => {\n                  const [field, direction] = value.split('-') as [SortField, SortDirection];\n                  setSortField(field);\n                  setSortDirection(direction);\n                }}>\n                  <SelectTrigger className={isMobile ? 'w-full col-span-2' : 'w-40'}>\n                    <SelectValue placeholder=\"Сортировка\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"lastInteraction-desc\">Последняя активность ↓</SelectItem>\n                    <SelectItem value=\"lastInteraction-asc\">Последняя активность ↑</SelectItem>\n                    <SelectItem value=\"interactionCount-desc\">Больше сообщений</SelectItem>\n                    <SelectItem value=\"interactionCount-asc\">Меньше сообщений</SelectItem>\n                    <SelectItem value=\"createdAt-desc\">Новые</SelectItem>\n                    <SelectItem value=\"createdAt-asc\">Старые</SelectItem>\n                    <SelectItem value=\"firstName-asc\">По имени A-Z</SelectItem>\n                    <SelectItem value=\"firstName-desc\">По имени Z-A</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Database Disabled Warning */}\n      {!isDatabaseEnabled && (\n        <div className=\"flex-1 flex items-center justify-center p-8\">\n          <Card className=\"max-w-md w-full border-2 border-red-200 dark:border-red-800 bg-red-50/50 dark:bg-red-950/50\">\n            <div className=\"p-8 text-center space-y-4\">\n              <div className=\"flex justify-center\">\n                <div className=\"rounded-full bg-red-100 dark:bg-red-900/50 p-4\">\n                  <Database className=\"w-12 h-12 text-red-600 dark:text-red-400\" />\n                </div>\n              </div>\n              <div>\n                <h3 className=\"text-xl font-bold text-red-900 dark:text-red-100 mb-2\">\n                  База данных выключена\n                </h3>\n                <p className=\"text-red-700 dark:text-red-300 text-sm\">\n                  Включите базу данных с помощью переключателя выше, чтобы начать сохранять данные пользователей и просматривать статистику.\n                </p>\n              </div>\n              <div className=\"pt-2\">\n                <p className=\"text-xs text-red-600/80 dark:text-red-400/80\">\n                  Пока база данных выключена, бот продолжает работать, но данные пользователей не сохраняются.\n                </p>\n              </div>\n            </div>\n          </Card>\n        </div>\n      )}\n\n      {/* Tabs */}\n      {isDatabaseEnabled && (\n        <div className=\"w-full\">\n          <Tabs defaultValue=\"users\" className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-2\">\n            <TabsTrigger value=\"users\">Пользователи</TabsTrigger>\n            <TabsTrigger value=\"backup\">Резервные копии</TabsTrigger>\n          </TabsList>\n          \n          <TabsContent value=\"users\" className=\"w-full\">\n            {isMobile ? (\n              // Mobile card layout with simple scrolling  \n              <div \n                className=\"overflow-y-scroll\" \n                style={{ \n                  height: '350px', \n                  overflowY: 'scroll', \n                  WebkitOverflowScrolling: 'touch',\n                  scrollBehavior: 'smooth'\n                }}\n              >\n                <div className=\"p-4 space-y-4\">\n                  {/* Debug info */}\n                  <div className=\"text-xs text-blue-500 bg-blue-50 p-2 rounded mb-2\" data-testid=\"debug-mobile-info\">\n                    DEBUG: isMobile={isMobile.toString()}, users={users.length}, filteredUsers={filteredAndSortedUsers.length}\n                  </div>\n                  {filteredAndSortedUsers.length === 0 ? (\n                    <div className=\"text-center py-8\">\n                      <div className=\"text-muted-foreground\">\n                        {searchQuery ? 'Пользователи не найдены' : 'Пользователи еще не взаимодействовали с ботом'}\n                      </div>\n                    </div>\n                  ) : (\n                    filteredAndSortedUsers.map((user, index) => (\n                      <Card key={user.id || index} className=\"p-4\" data-testid={`user-card-mobile-${index}`}>\n                        <div className=\"space-y-3\">\n                          {/* User Header */}\n                          <div className=\"flex items-start justify-between\">\n                            <div className=\"flex-1\">\n                              <div className=\"font-medium text-base\">{formatUserName(user)}</div>\n                              <div className=\"text-sm text-muted-foreground\">ID: {user.id}</div>\n                            </div>\n                            <div className=\"flex items-center gap-1\">\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                data-testid={`button-view-user-${index}`}\n                                onClick={() => {\n                                  setSelectedUser(user);\n                                  setShowUserDetails(true);\n                                }}\n                              >\n                                <Eye className=\"w-3 h-3\" />\n                              </Button>\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                data-testid={`button-show-dialog-${index}`}\n                                onClick={() => {\n                                  setSelectedUserForDialog(user);\n                                  setShowDialog(true);\n                                }}\n                              >\n                                <MessageSquare className=\"w-3 h-3\" />\n                              </Button>\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                data-testid={`button-toggle-active-${index}`}\n                                onClick={() => handleUserStatusToggle(user, 'isActive')}\n                                className={user.isActive ? \"text-red-600\" : \"text-green-600\"}\n                              >\n                                {user.isActive ? <UserX className=\"w-3 h-3\" /> : <UserCheck className=\"w-3 h-3\" />}\n                              </Button>\n                            </div>\n                          </div>\n\n                          {/* Status Badges */}\n                          <div className=\"flex flex-wrap gap-2\">\n                            <Badge variant={user.isActive ? \"default\" : \"secondary\"}>\n                              {user.isActive ? \"Активен\" : \"Неактивен\"}\n                            </Badge>\n                            {user.isPremium && <Badge variant=\"outline\" className=\"text-yellow-600\"><Crown className=\"w-3 h-3 mr-1\" />Premium</Badge>}\n                            {user.isBlocked && <Badge variant=\"destructive\">Заблокирован</Badge>}\n                            {user.isBot && <Badge variant=\"outline\">Бот</Badge>}\n                          </div>\n\n                          {/* Stats */}\n                          <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                            <div>\n                              <div className=\"text-muted-foreground\">Сообщений</div>\n                              <div className=\"font-medium\">{user.interactionCount || 0}</div>\n                            </div>\n                            <div>\n                              <div className=\"text-muted-foreground\">Последняя активность</div>\n                              <div className=\"font-medium text-xs\">{formatDate(user.lastInteraction)}</div>\n                            </div>\n                          </div>\n\n                          {/* Recent Responses */}\n                          {(user.userData && Object.keys(user.userData).length > 0) && (\n                            <div className=\"border-t pt-3\">\n                              <div className=\"text-sm font-medium mb-2\">Последние ответы:</div>\n                              <div className=\"space-y-2\">\n                                {Object.entries(user.userData || {}).slice(0, 1).map(([key, value]) => {\n                                  let responseData = value;\n                                  if (typeof value === 'string') {\n                                    try {\n                                      responseData = JSON.parse(value);\n                                    } catch {\n                                      responseData = { value: value, type: 'text' };\n                                    }\n                                  }\n                                  \n                                  return (\n                                    <div key={key} className=\"text-xs bg-muted/50 rounded-lg p-2\">\n                                      <div className=\"text-muted-foreground mb-1\">{key}:</div>\n                                      <div className=\"font-medium\">\n                                        {(responseData as any)?.value ? \n                                          ((responseData as any).value.length > 50 ? `${(responseData as any).value.substring(0, 50)}...` : (responseData as any).value) :\n                                          (typeof value === 'string' ? (value.length > 50 ? `${value.substring(0, 50)}...` : value) : JSON.stringify(value))\n                                        }\n                                      </div>\n                                    </div>\n                                  );\n                                })}\n                                {Object.keys(user.userData || {}).length > 1 && (\n                                  <div className=\"text-xs text-muted-foreground\">\n                                    +{Object.keys(user.userData || {}).length - 1} еще...\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      </Card>\n                    ))\n                  )}\n                </div>\n              </div>\n            ) : (\n              // Desktop table layout\n              <ScrollArea className=\"h-full\">\n                <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Пользователь</TableHead>\n                <TableHead>Статус</TableHead>\n                <TableHead>Сообщения</TableHead>\n                <TableHead>Вопросы и ответы</TableHead>\n                <TableHead>Последняя активность</TableHead>\n                <TableHead>Дата регистрации</TableHead>\n                <TableHead>Действия</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {filteredAndSortedUsers.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={7} className=\"text-center py-8\">\n                    <div className=\"text-muted-foreground\">\n                      {searchQuery ? 'Пользователи не найдены' : 'Пользователи еще не взаимодействовали с ботом'}\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ) : (\n                filteredAndSortedUsers.map((user, index) => (\n                  <TableRow key={user.id || index}>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <div>\n                          <div className=\"font-medium\">{formatUserName(user)}</div>\n                          <div className=\"text-xs text-muted-foreground\">ID: {user.id}</div>\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex flex-wrap gap-1\">\n                        <Badge variant={user.isActive ? \"default\" : \"secondary\"}>\n                          {user.isActive ? \"Активен\" : \"Неактивен\"}\n                        </Badge>\n                        {user.isPremium && <Badge variant=\"outline\" className=\"text-yellow-600\"><Crown className=\"w-3 h-3 mr-1\" />Premium</Badge>}\n                        {user.isBlocked && <Badge variant=\"destructive\">Заблокирован</Badge>}\n                        {user.isBot && <Badge variant=\"outline\">Бот</Badge>}\n                      </div>\n                    </TableCell>\n                    <TableCell>{user.interactionCount || 0}</TableCell>\n                    <TableCell>\n                      <div className=\"max-w-xs\">\n                        {(user.userData && Object.keys(user.userData).length > 0) ? (\n                          <div className=\"space-y-1\">\n                            {Object.entries(user.userData).slice(0, 2).map(([key, value]) => {\n                              // Parse value if it's a string (from PostgreSQL)\n                              let responseData = value;\n                              if (typeof value === 'string') {\n                                try {\n                                  responseData = JSON.parse(value);\n                                } catch {\n                                  responseData = { value: value, type: 'text' };\n                                }\n                              }\n                              \n                              // Format the question text\n                              const formatQuestionText = (key: string, responseData: any) => {\n                                if (responseData?.prompt && responseData.prompt.trim()) {\n                                  return responseData.prompt;\n                                }\n                                \n                                // Generate a question based on the key\n                                if (key.includes('feedback')) return 'Расскажите подробнее о своих впечатлениях. Что вам понравилось или что можно улучшить?';\n                                if (key.includes('name')) return 'Как вас зовут?';\n                                if (key.includes('age')) return 'Сколько вам лет?';\n                                if (key.includes('city')) return 'Из какого вы города?';\n                                if (key.includes('contact')) return 'Поделитесь контактом';\n                                if (key.includes('email')) return 'Укажите ваш email';\n                                if (key.includes('phone')) return 'Укажите ваш телефон';\n                                if (key.includes('rating')) return 'Оцените нашу работу';\n                                if (key.includes('review')) return 'Оставьте отзыв';\n                                if (key.includes('suggestion')) return 'Поделитесь предложением';\n                                if (key.startsWith('response_')) return `Вопрос ${key.replace('response_', '')}`;\n                                if (key.startsWith('user_')) return `Пользовательский ввод: ${key.replace('user_', '').replace('_', ' ')}`;\n                                return `Вопрос: ${key}`;\n                              };\n                              \n                              return (\n                                <div key={key} className=\"text-xs bg-gradient-to-br from-blue-50 to-green-50 dark:from-blue-900/20 dark:to-green-900/20 rounded-lg p-3 border border-blue-200 dark:border-blue-800 mb-2\">\n                                  <div className=\"mb-2\">\n                                    <div className=\"flex items-start gap-2 mb-1\">\n                                      <MessageSquare className=\"w-3 h-3 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0\" />\n                                      <div className=\"font-medium text-blue-700 dark:text-blue-300 text-xs\">\n                                        Вопрос:\n                                      </div>\n                                    </div>\n                                    <div className=\"text-xs text-gray-700 dark:text-gray-300 ml-5 leading-relaxed\">\n                                      {formatQuestionText(key, responseData)}\n                                    </div>\n                                  </div>\n                                  <div>\n                                    <div className=\"flex items-start gap-2 mb-1\">\n                                      <Edit className=\"w-3 h-3 text-green-600 dark:text-green-400 mt-0.5 flex-shrink-0\" />\n                                      <div className=\"font-medium text-green-700 dark:text-green-300 text-xs\">\n                                        Ответ:\n                                      </div>\n                                    </div>\n                                    <div className=\"text-xs text-foreground font-medium ml-5 leading-relaxed\">\n                                      {responseData?.value ? \n                                        (responseData.value.length > 50 ? `${responseData.value.substring(0, 50)}...` : responseData.value) :\n                                        (typeof value === 'string' ? (value.length > 50 ? `${value.substring(0, 50)}...` : value) : JSON.stringify(value))\n                                      }\n                                    </div>\n                                  </div>\n                                </div>\n                              );\n                            })}\n                            {Object.keys(user.userData).length > 2 && (\n                              <div className=\"text-xs text-muted-foreground\">\n                                +{Object.keys(user.userData).length - 2} еще...\n                              </div>\n                            )}\n                          </div>\n                        ) : (\n                          <span className=\"text-xs text-muted-foreground\">Нет ответов</span>\n                        )}\n                      </div>\n                    </TableCell>\n                    <TableCell className=\"text-sm\">{formatDate(user.lastInteraction)}</TableCell>\n                    <TableCell className=\"text-sm\">{formatDate(user.createdAt)}</TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-1\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          data-testid={`button-view-user-${index}`}\n                          onClick={() => {\n                            setSelectedUser(user);\n                            setShowUserDetails(true);\n                          }}\n                        >\n                          <Eye className=\"w-3 h-3\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          data-testid={`button-show-dialog-${index}`}\n                          onClick={() => {\n                            setSelectedUserForDialog(user);\n                            setShowDialog(true);\n                          }}\n                        >\n                          <MessageSquare className=\"w-3 h-3\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          data-testid={`button-toggle-active-${index}`}\n                          onClick={() => handleUserStatusToggle(user, 'isActive')}\n                          className={user.isActive ? \"text-red-600\" : \"text-green-600\"}\n                        >\n                          {user.isActive ? <UserX className=\"w-3 h-3\" /> : <UserCheck className=\"w-3 h-3\" />}\n                        </Button>\n                        <AlertDialog>\n                          <AlertDialogTrigger asChild>\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\" \n                              className=\"text-red-600\"\n                              data-testid={`button-delete-user-${index}`}\n                            >\n                              <Trash2 className=\"w-3 h-3\" />\n                            </Button>\n                          </AlertDialogTrigger>\n                          <AlertDialogContent>\n                            <AlertDialogHeader>\n                              <AlertDialogTitle>Удалить пользователя?</AlertDialogTitle>\n                              <AlertDialogDescription>\n                                Это действие нельзя отменить. Все данные пользователя \"{formatUserName(user)}\" будут удалены.\n                              </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                              <AlertDialogCancel>Отмена</AlertDialogCancel>\n                              <AlertDialogAction onClick={() => deleteUserMutation.mutate(user.id)}>\n                                Удалить\n                              </AlertDialogAction>\n                            </AlertDialogFooter>\n                          </AlertDialogContent>\n                        </AlertDialog>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n              </Table>\n              </ScrollArea>\n            )}\n          </TabsContent>\n          \n          <TabsContent value=\"backup\" className=\"flex-1 overflow-hidden\">\n            <ScrollArea className=\"h-full\">\n              <div className=\"p-4\">\n                <DatabaseBackupPanel />\n              </div>\n            </ScrollArea>\n          </TabsContent>\n        </Tabs>\n        </div>\n      )}\n\n      {/* User Details Dialog */}\n      <Dialog open={showUserDetails} onOpenChange={setShowUserDetails}>\n        <DialogContent className={`${isMobile ? 'max-w-[95vw] max-h-[90vh]' : 'max-w-3xl max-h-[80vh]'} overflow-auto`}>\n          <DialogHeader>\n            <DialogTitle>Детали пользователя</DialogTitle>\n            <DialogDescription>\n              Подробная информация о пользователе\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedUser && (\n            <div className=\"space-y-6\">\n              <div className={`grid ${isMobile ? 'grid-cols-1' : 'grid-cols-2'} gap-4`}>\n                <div>\n                  <Label className=\"text-sm font-medium\">Основная информация</Label>\n                  <div className=\"mt-2 space-y-2\">\n                    <div><span className=\"text-sm text-muted-foreground\">Имя:</span> {selectedUser.firstName || 'Не указано'}</div>\n                    <div><span className=\"text-sm text-muted-foreground\">Фамилия:</span> {selectedUser.lastName || 'Не указано'}</div>\n                    <div><span className=\"text-sm text-muted-foreground\">Username:</span> {selectedUser.userName ? `@${selectedUser.userName}` : 'Не указано'}</div>\n                    <div><span className=\"text-sm text-muted-foreground\">Telegram ID:</span> {selectedUser.userId}</div>\n                    <div><span className=\"text-sm text-muted-foreground\">Язык:</span> {selectedUser.languageCode || 'Не указано'}</div>\n                  </div>\n                </div>\n                \n                <div>\n                  <Label className=\"text-sm font-medium\">Статистика</Label>\n                  <div className=\"mt-2 space-y-2\">\n                    <div><span className=\"text-sm text-muted-foreground\">Сообщений:</span> {selectedUser.interactionCount || 0}</div>\n                    <div><span className=\"text-sm text-muted-foreground\">Сессий:</span> {selectedUser.sessionsCount || 0}</div>\n                    <div><span className=\"text-sm text-muted-foreground\">Отправлено:</span> {selectedUser.totalMessagesSent || 0}</div>\n                    <div><span className=\"text-sm text-muted-foreground\">Получено:</span> {selectedUser.totalMessagesReceived || 0}</div>\n                    <div><span className=\"text-sm text-muted-foreground\">Состояние:</span> {selectedUser.currentState || 'Не установлено'}</div>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <Label className=\"text-sm font-medium\">Статус пользователя</Label>\n                <div className=\"mt-2\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Switch\n                      checked={Boolean(selectedUser.isActive)}\n                      onCheckedChange={(checked) => handleUserStatusToggle(selectedUser, 'isActive')}\n                    />\n                    <Label>Активен</Label>\n                    <span className=\"text-xs text-muted-foreground ml-2\">\n                      (пользователь может взаимодействовать с ботом)\n                    </span>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    Вы можете деактивировать пользователя, если нужно временно ограничить его доступ к боту.\n                  </p>\n                </div>\n              </div>\n\n              <div>\n                <Label className=\"text-sm font-medium\">Даты</Label>\n                <div className=\"mt-2 space-y-2\">\n                  <div><span className=\"text-sm text-muted-foreground\">Регистрация:</span> {formatDate(selectedUser.createdAt)}</div>\n                  <div><span className=\"text-sm text-muted-foreground\">Последнее обновление:</span> {formatDate(selectedUser.updatedAt)}</div>\n                  <div><span className=\"text-sm text-muted-foreground\">Последняя активность:</span> {formatDate(selectedUser.lastInteraction)}</div>\n                </div>\n              </div>\n\n              {selectedUser.tags && selectedUser.tags.length > 0 && (\n                <div>\n                  <Label className=\"text-sm font-medium\">Теги</Label>\n                  <div className=\"mt-2 flex flex-wrap gap-1\">\n                    {selectedUser.tags.map((tag, index) => (\n                      <Badge key={index} variant=\"secondary\">{tag}</Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Enhanced user responses section */}\n              {(selectedUser.userData && Object.keys(selectedUser.userData).length > 0) && (\n                <div>\n                  <div className=\"flex items-center gap-2 mb-4\">\n                    <MessageSquare className=\"w-5 h-5 text-primary\" />\n                    <Label className=\"text-base font-semibold\">Ответы пользователя</Label>\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      {Object.keys(selectedUser.userData).length}\n                    </Badge>\n                  </div>\n                  <div className=\"space-y-4\">\n                    {Object.entries(selectedUser.userData).map(([key, value]) => {\n                      // Parse value if it's a string (from PostgreSQL)\n                      let responseData = value;\n                      if (typeof value === 'string') {\n                        try {\n                          responseData = JSON.parse(value);\n                        } catch {\n                          responseData = { value: value, type: 'text' };\n                        }\n                      }\n                      \n                      return (\n                        <div key={key} className=\"border rounded-lg p-4 bg-gradient-to-br from-muted/30 to-muted/60 hover:from-muted/50 hover:to-muted/80 transition-all duration-200 shadow-sm hover:shadow-md\">\n                          <div className=\"flex items-center justify-between mb-3\">\n                            <div className=\"flex items-center gap-2\">\n                              <div className=\"flex items-center gap-2\">\n                                <div className=\"w-3 h-3 rounded-full bg-gradient-to-r from-blue-500 to-green-500\"></div>\n                                <span className=\"text-sm font-medium text-foreground\">\n                                  {key.startsWith('response_') ? key.replace('response_', 'Ответ ') : key}\n                                </span>\n                              </div>\n                              {responseData?.type && (\n                                <Badge variant=\"outline\" className=\"text-xs border-primary/20 text-primary\">\n                                  {responseData.type === 'text' ? '📝 Текст' : \n                                   responseData.type === 'number' ? '🔢 Число' :\n                                   responseData.type === 'email' ? '📧 Email' :\n                                   responseData.type === 'phone' ? '📞 Телефон' :\n                                   responseData.type}\n                                </Badge>\n                              )}\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <Calendar className=\"w-3 h-3 text-muted-foreground\" />\n                              <span className=\"text-xs text-muted-foreground font-medium\">\n                                {responseData?.timestamp \n                                  ? formatDate(responseData.timestamp) \n                                  : 'Недавно'}\n                              </span>\n                            </div>\n                          </div>\n                          \n                          <div className=\"text-sm\">\n                            {responseData?.value ? (\n                              <div className=\"bg-background rounded-lg p-4 border border-border shadow-sm\">\n                                {/* Показываем вопрос если есть */}\n                                {responseData.prompt ? (\n                                  <div className=\"mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800\">\n                                    <div className=\"flex items-center gap-2 mb-2\">\n                                      <MessageSquare className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n                                      <span className=\"font-medium text-blue-900 dark:text-blue-100\">Вопрос:</span>\n                                    </div>\n                                    <div className=\"text-blue-800 dark:text-blue-200 leading-relaxed\">\n                                      {responseData.prompt}\n                                    </div>\n                                  </div>\n                                ) : (\n                                  <div className=\"mb-4 p-3 bg-gray-50 dark:bg-gray-900/20 rounded-lg border border-gray-200 dark:border-gray-800\">\n                                    <div className=\"flex items-center gap-2 mb-2\">\n                                      <MessageSquare className=\"w-4 h-4 text-gray-600 dark:text-gray-400\" />\n                                      <span className=\"font-medium text-gray-900 dark:text-gray-100\">Вопрос:</span>\n                                    </div>\n                                    <div className=\"text-gray-600 dark:text-gray-400 leading-relaxed italic\">\n                                      {key.startsWith('response_') \n                                        ? `Ответ на вопрос ${key.replace('response_', '')}`\n                                        : 'Информация о вопросе отсутствует'}\n                                    </div>\n                                  </div>\n                                )}\n                                \n                                {/* Показываем ответ */}\n                                <div className=\"p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800\">\n                                  <div className=\"flex items-center gap-2 mb-2\">\n                                    <Edit className=\"w-4 h-4 text-green-600 dark:text-green-400\" />\n                                    <span className=\"font-medium text-green-900 dark:text-green-100\">Ответ:</span>\n                                  </div>\n                                  <div className=\"text-green-800 dark:text-green-200 leading-relaxed font-medium\">\n                                    {responseData.value}\n                                  </div>\n                                </div>\n                                \n                                {/* Дополнительная информация */}\n                                {responseData.nodeId && (\n                                  <div className=\"mt-3 pt-3 border-t border-border\">\n                                    <div className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                                      <span className=\"inline-block w-2 h-2 bg-muted-foreground rounded-full\"></span>\n                                      ID узла: {responseData.nodeId}\n                                    </div>\n                                  </div>\n                                )}\n                              </div>\n                            ) : typeof value === 'object' && value !== null ? (\n                              <div className=\"bg-background rounded-lg p-4 border border-border shadow-sm\">\n                                <div className=\"flex items-center gap-2 mb-3\">\n                                  <Settings className=\"w-4 h-4 text-orange-600 dark:text-orange-400\" />\n                                  <span className=\"font-medium text-orange-900 dark:text-orange-100\">Системные данные:</span>\n                                </div>\n                                <div className=\"bg-orange-50 dark:bg-orange-900/20 rounded-lg border border-orange-200 dark:border-orange-800 p-3\">\n                                  <pre className=\"text-xs text-orange-800 dark:text-orange-200 overflow-auto whitespace-pre-wrap\">\n                                    {JSON.stringify(value, null, 2)}\n                                  </pre>\n                                </div>\n                              </div>\n                            ) : (\n                              <div className=\"bg-background rounded-lg p-4 border border-border shadow-sm\">\n                                <div className=\"flex items-center gap-2 mb-3\">\n                                  <Eye className=\"w-4 h-4 text-purple-600 dark:text-purple-400\" />\n                                  <span className=\"font-medium text-purple-900 dark:text-purple-100\">Значение:</span>\n                                </div>\n                                <div className=\"bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-800 p-3\">\n                                  <div className=\"text-purple-800 dark:text-purple-200 leading-relaxed\">{String(value)}</div>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                  \n                  <div className=\"mt-4\">\n                    <Label className=\"text-sm font-medium\">Все данные пользователя (JSON)</Label>\n                    <div className=\"mt-2\">\n                      <Textarea\n                        value={JSON.stringify(selectedUser.userData, null, 2)}\n                        readOnly\n                        rows={6}\n                        className=\"text-xs font-mono bg-muted\"\n                        placeholder=\"Нет данных для отображения\"\n                      />\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Chat Dialog */}\n      <Dialog open={showDialog} onOpenChange={setShowDialog}>\n        <DialogContent className={`${isMobile ? 'max-w-[95vw] max-h-[90vh]' : 'max-w-2xl max-h-[80vh]'} flex flex-col`}>\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <MessageSquare className=\"w-5 h-5\" />\n              Диалог с пользователем\n            </DialogTitle>\n            <DialogDescription>\n              {selectedUserForDialog && formatUserName(selectedUserForDialog)}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"flex-1 flex flex-col min-h-0\">\n            {/* Messages Area */}\n            <ScrollArea className=\"h-[400px] pr-4\" data-testid=\"messages-scroll-area\">\n              {messagesLoading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <RefreshCw className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n                  <span className=\"ml-2 text-muted-foreground\">Загрузка сообщений...</span>\n                </div>\n              ) : messages.length === 0 ? (\n                <div className=\"flex flex-col items-center justify-center py-12 text-center\" data-testid=\"empty-messages-state\">\n                  <MessageSquare className=\"w-12 h-12 text-muted-foreground mb-4\" />\n                  <p className=\"text-muted-foreground\">Нет сообщений</p>\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    Начните диалог, отправив первое сообщение\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-4 py-4\">\n                  {messages.map((message, index) => {\n                    const isBot = message.messageType === 'bot';\n                    const isUser = message.messageType === 'user';\n                    \n                    return (\n                      <div\n                        key={message.id || index}\n                        className={`flex ${isUser ? 'justify-end' : 'justify-start'}`}\n                        data-testid={`message-${message.messageType}-${index}`}\n                      >\n                        <div className={`flex gap-2 max-w-[80%] ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>\n                          {/* Avatar */}\n                          <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${\n                            isBot ? 'bg-blue-100 dark:bg-blue-900' : 'bg-green-100 dark:bg-green-900'\n                          }`}>\n                            {isBot ? (\n                              <Bot className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n                            ) : (\n                              <User className=\"w-4 h-4 text-green-600 dark:text-green-400\" />\n                            )}\n                          </div>\n                          \n                          {/* Message Content */}\n                          <div className=\"flex flex-col gap-1\">\n                            {/* Медиа-файлы если есть */}\n                            {message.media && Array.isArray(message.media) && message.media.length > 0 && (\n                              <div className=\"rounded-lg overflow-hidden max-w-xs space-y-2\">\n                                {message.media.map((m: any, idx: number) => (\n                                  <img \n                                    key={idx}\n                                    src={m.url} \n                                    alt=\"Photo\" \n                                    className=\"w-full h-auto rounded-lg\"\n                                    data-testid={`photo-${message.id}-${idx}`}\n                                    onError={(e) => {\n                                      (e.target as HTMLImageElement).style.display = 'none';\n                                    }}\n                                  />\n                                ))}\n                              </div>\n                            )}\n                            \n                            <div className={`rounded-lg px-4 py-2 ${\n                              isBot \n                                ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-900 dark:text-blue-100' \n                                : 'bg-green-100 dark:bg-green-900/50 text-green-900 dark:text-green-100'\n                            }`}>\n                              <p className=\"text-sm whitespace-pre-wrap break-words\">\n                                {message.messageText}\n                              </p>\n                            </div>\n                            \n                            {/* Кнопки для сообщений бота */}\n                            {isBot && message.messageData && typeof message.messageData === 'object' && 'buttons' in message.messageData && Array.isArray(message.messageData.buttons) && message.messageData.buttons.length > 0 && (\n                              <div className=\"flex flex-wrap gap-1 mt-1\">\n                                {message.messageData.buttons.map((button: any, btnIndex: number) => (\n                                  <div\n                                    key={btnIndex}\n                                    className=\"inline-flex items-center px-3 py-1 text-xs rounded-md border bg-white dark:bg-gray-800 border-blue-300 dark:border-blue-700 text-blue-700 dark:text-blue-300\"\n                                    data-testid={`button-preview-${index}-${btnIndex}`}\n                                  >\n                                    {button.text}\n                                  </div>\n                                ))}\n                              </div>\n                            )}\n                            \n                            {/* Информация о нажатой кнопке для сообщений пользователя */}\n                            {isUser && message.messageData && typeof message.messageData === 'object' && 'button_clicked' in message.messageData && message.messageData.button_clicked && (\n                              <div className=\"mt-1\">\n                                <div className=\"inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200\">\n                                  <span>✓</span>\n                                  <span>\n                                    {'button_text' in message.messageData && message.messageData.button_text \n                                      ? `Нажата: ${message.messageData.button_text}` \n                                      : 'Нажата кнопка'}\n                                  </span>\n                                </div>\n                              </div>\n                            )}\n                            \n                            {/* Timestamp */}\n                            {message.createdAt && (\n                              <span \n                                className={`text-xs text-muted-foreground ${isUser ? 'text-right' : 'text-left'}`}\n                                data-testid={`timestamp-${index}`}\n                              >\n                                {format(new Date(message.createdAt), 'dd MMM yyyy, HH:mm', { locale: ru })}\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </ScrollArea>\n            \n            <Separator className=\"my-4\" />\n            \n            {/* Message Input Form */}\n            <div className=\"space-y-3\">\n              <Label htmlFor=\"message-input\" className=\"text-sm font-medium\">\n                Отправить сообщение\n              </Label>\n              <div className=\"flex gap-2\">\n                <Textarea\n                  id=\"message-input\"\n                  data-testid=\"textarea-message-input\"\n                  placeholder=\"Введите сообщение...\"\n                  value={messageText}\n                  onChange={(e) => setMessageText(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && !e.shiftKey) {\n                      e.preventDefault();\n                      if (messageText.trim() && !sendMessageMutation.isPending) {\n                        sendMessageMutation.mutate({ messageText: messageText.trim() });\n                      }\n                    }\n                  }}\n                  rows={3}\n                  disabled={sendMessageMutation.isPending}\n                  className=\"flex-1 resize-none\"\n                />\n              </div>\n              <div className=\"flex justify-between items-center\">\n                <p className=\"text-xs text-muted-foreground\">\n                  Нажмите Enter для отправки, Shift+Enter для новой строки\n                </p>\n                <Button\n                  data-testid=\"button-send-message\"\n                  onClick={() => {\n                    if (messageText.trim() && !sendMessageMutation.isPending) {\n                      sendMessageMutation.mutate({ messageText: messageText.trim() });\n                    }\n                  }}\n                  disabled={!messageText.trim() || sendMessageMutation.isPending}\n                  size=\"sm\"\n                >\n                  {sendMessageMutation.isPending ? (\n                    <>\n                      <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                      Отправка...\n                    </>\n                  ) : (\n                    <>\n                      <Send className=\"w-4 h-4 mr-2\" />\n                      Отправить\n                    </>\n                  )}\n                </Button>\n              </div>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","size_bytes":71847},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }","size_bytes":1127},"client/src/components/editor/preview-modal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Node, Connection } from '@shared/schema';\nimport { parseCommandFromText } from '@/lib/commands';\nimport { useState, useRef, useEffect } from 'react';\n\n// Функция для рендеринга markdown в HTML\nconst renderMarkdown = (text: string): string => {\n  return text\n    // Жирный текст: **text** → <strong>text</strong>\n    .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\n    // Курсив: *text* → <em>text</em>\n    .replace(/\\*((?:[^*]|\\*{2})*?)\\*/g, '<em>$1</em>')\n    // Код: `text` → <code>text</code>\n    .replace(/`([^`]+)`/g, '<code class=\"bg-gray-100 px-1 py-0.5 rounded text-xs\">$1</code>')\n    // Переносы строк: \\n → <br>\n    .replace(/\\n/g, '<br>')\n    // Ссылки: [text](url) → <a href=\"url\">text</a>\n    .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href=\"$2\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-600 hover:underline\">$1</a>');\n};\n\ninterface PreviewModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  nodes: Node[];\n  connections: Connection[];\n  projectName: string;\n}\n\nexport function PreviewModal({ isOpen, onClose, nodes, connections, projectName }: PreviewModalProps) {\n  const [currentNodeId, setCurrentNodeId] = useState<string>('');\n  const [messageHistory, setMessageHistory] = useState<Array<{\n    id: string;\n    type: 'bot' | 'user';\n    text: string;\n    time: string;\n    buttons?: Array<{ text: string; target?: string; action?: string; }>;\n    keyboardType?: 'reply' | 'inline' | 'none';\n    mediaType?: 'photo' | 'video' | 'audio' | 'document' | 'sticker' | 'voice' | 'animation' | 'location' | 'contact' | 'poll' | 'dice';\n    mediaUrl?: string;\n    mediaCaption?: string;\n    mediaData?: any; // Дополнительные данные для специальных типов медиа\n  }>>([]);\n  const [currentReplyKeyboard, setCurrentReplyKeyboard] = useState<Array<{ text: string; target?: string; action?: string; }> | null>(null);\n  const [textInput, setTextInput] = useState('');\n  const [waitingForInput, setWaitingForInput] = useState(false);\n  const [waitingForPhoto, setWaitingForPhoto] = useState(false);\n  const [waitingForVideo, setWaitingForVideo] = useState(false);\n  const [waitingForAudio, setWaitingForAudio] = useState(false);\n  const [waitingForDocument, setWaitingForDocument] = useState(false);\n  const [userVariables, setUserVariables] = useState<Record<string, string>>({});\n  const inputRef = useRef<HTMLInputElement>(null);\n  const chatAreaRef = useRef<HTMLDivElement>(null);\n\n  // Find start node or first node\n  const startNode = nodes.find(node => node.type === 'start') || nodes[0];\n\n  // Helper function to find next node based on connections\n  const findNextNode = (currentNodeId: string, isSuccess: boolean = true) => {\n    // Find all connections from current node\n    const fromConnections = connections.filter(conn => conn.source === currentNodeId);\n    \n    if (fromConnections.length === 0) {\n      return null;\n    }\n\n\n    // For other node types, return the first connection\n    const nextConnection = fromConnections[0];\n    return nextConnection ? nodes.find(node => node.id === nextConnection.target) : null;\n  };\n\n  // Helper function to get media information from a node\n  const getMediaInfo = (node: Node) => {\n    switch (node.type) {\n      case 'photo':\n        return {\n          mediaType: 'photo' as const,\n          mediaUrl: node.data.imageUrl || 'https://picsum.photos/800/600?random=1',\n          mediaCaption: node.data.mediaCaption\n        };\n      case 'video':\n        return {\n          mediaType: 'video' as const,\n          mediaUrl: node.data.videoUrl || 'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4',\n          mediaCaption: node.data.mediaCaption\n        };\n      case 'audio':\n        return {\n          mediaType: 'audio' as const,\n          mediaUrl: node.data.audioUrl || 'https://www.soundjay.com/misc/beep-07a.wav',\n          mediaCaption: node.data.mediaCaption,\n          mediaData: {\n            performer: node.data.performer,\n            duration: node.data.duration\n          }\n        };\n      case 'document':\n        return {\n          mediaType: 'document' as const,\n          mediaUrl: node.data.documentUrl || 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',\n          mediaCaption: node.data.mediaCaption,\n          mediaData: {\n            filename: node.data.filename || node.data.documentName || 'document.pdf'\n          }\n        };\n      case 'sticker':\n        return {\n          mediaType: 'sticker' as const,\n          mediaUrl: node.data.stickerUrl || 'https://telegram.org/img/t_logo.png',\n          mediaCaption: node.data.mediaCaption\n        };\n      case 'voice':\n        return {\n          mediaType: 'voice' as const,\n          mediaUrl: node.data.voiceUrl || 'https://www.soundjay.com/misc/beep-07a.wav',\n          mediaCaption: node.data.mediaCaption,\n          mediaData: {\n            duration: node.data.duration\n          }\n        };\n      case 'animation':\n        return {\n          mediaType: 'animation' as const,\n          mediaUrl: node.data.animationUrl || 'https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif',\n          mediaCaption: node.data.mediaCaption\n        };\n      case 'location':\n        return {\n          mediaType: 'location' as const,\n          mediaData: {\n            latitude: node.data.latitude || 55.7558,\n            longitude: node.data.longitude || 37.6176,\n            title: node.data.title || 'Локация',\n            address: node.data.address\n          }\n        };\n      case 'contact':\n        return {\n          mediaType: 'contact' as const,\n          mediaData: {\n            firstName: node.data.firstName || 'Имя',\n            lastName: node.data.lastName,\n            phoneNumber: node.data.phoneNumber\n          }\n        };\n      default:\n        return {};\n    }\n  };\n\n  // Helper function to replace variables in text\n  const replaceVariables = (text: string): string => {\n    let result = text;\n    Object.entries(userVariables).forEach(([key, value]) => {\n      const regex = new RegExp(`\\\\{${key}\\\\}`, 'g');\n      result = result.replace(regex, value);\n    });\n    return result;\n  };\n\n  // Helper function to handle media input\n  const handleMediaInput = (mediaType: 'photo' | 'video' | 'audio' | 'document') => {\n    const currentNode = nodes.find(n => n.id === currentNodeId);\n    if (!currentNode) return;\n\n    const mediaConfig = {\n      photo: {\n        emoji: '📷',\n        text: 'Отправил фото',\n        fileIdPrefix: 'simulated_photo_file_id',\n        variableKey: currentNode.data.photoInputVariable\n      },\n      video: {\n        emoji: '🎥',\n        text: 'Отправил видео',\n        fileIdPrefix: 'simulated_video_file_id',\n        variableKey: currentNode.data.videoInputVariable\n      },\n      audio: {\n        emoji: '🎵',\n        text: 'Отправил аудио',\n        fileIdPrefix: 'simulated_audio_file_id',\n        variableKey: currentNode.data.audioInputVariable\n      },\n      document: {\n        emoji: '📄',\n        text: 'Отправил документ',\n        fileIdPrefix: 'simulated_document_file_id',\n        variableKey: currentNode.data.documentInputVariable\n      }\n    };\n\n    const config = mediaConfig[mediaType];\n    const fileId = `${config.fileIdPrefix}_${Math.random().toString(36).substring(2, 15)}`;\n    const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });\n\n    // Add user message\n    const userMessage = {\n      id: `msg-${Date.now()}-user`,\n      type: 'user' as const,\n      text: `${config.emoji} ${config.text}`,\n      time\n    };\n\n    setMessageHistory(prev => [...prev, userMessage]);\n\n    // Save file_id to user variables if variable key is specified\n    if (config.variableKey) {\n      const varKey = config.variableKey;\n      setUserVariables(prev => ({\n        ...prev,\n        [varKey]: fileId\n      }));\n    }\n\n    // Clear waiting states\n    setWaitingForPhoto(false);\n    setWaitingForVideo(false);\n    setWaitingForAudio(false);\n    setWaitingForDocument(false);\n    setWaitingForInput(false);\n\n    // Send confirmation message with media echo\n    setTimeout(() => {\n      const confirmationMessage = {\n        id: `msg-${Date.now()}-bot-confirm`,\n        type: 'bot' as const,\n        text: `✅ ${mediaType === 'photo' ? 'Фото' : mediaType === 'video' ? 'Видео' : mediaType === 'audio' ? 'Аудио' : 'Документ'} получено и сохранено!`,\n        time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),\n        mediaType: mediaType,\n        mediaUrl: mediaType === 'photo' ? 'https://picsum.photos/400/300?random=' + Math.random() : \n                  mediaType === 'video' ? 'https://sample-videos.com/zip/10/mp4/SampleVideo_640x360_1mb.mp4' :\n                  mediaType === 'audio' ? 'https://www.soundjay.com/misc/beep-07a.wav' :\n                  'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',\n        mediaCaption: `✅ ${mediaType === 'photo' ? 'Фото' : mediaType === 'video' ? 'Видео' : mediaType === 'audio' ? 'Аудио' : 'Документ'} получено и сохранено!`\n      };\n      \n      setMessageHistory(prev => [...prev, confirmationMessage]);\n    }, 300);\n\n    // Navigate to target node if specified\n    if (currentNode.data.inputTargetNodeId) {\n      const targetNode = nodes.find(node => node.id === currentNode.data.inputTargetNodeId);\n      if (targetNode) {\n        setTimeout(() => {\n          setCurrentNodeId(targetNode.id);\n          \n          let responseText = targetNode.data.messageText || '';\n          if (responseText) {\n            responseText = replaceVariables(responseText);\n          }\n\n          const targetMediaInfo = getMediaInfo(targetNode);\n          \n          let buttons;\n          if (targetNode.data.keyboardType !== 'none' && targetNode.data.buttons) {\n            buttons = targetNode.data.buttons.map(btn => ({\n              text: btn.text,\n              target: btn.target,\n              action: btn.action\n            }));\n          }\n\n          const botResponse = {\n            id: `msg-${Date.now()}-bot`,\n            type: 'bot' as const,\n            text: responseText,\n            time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),\n            buttons,\n            keyboardType: targetNode.data.keyboardType,\n            ...targetMediaInfo\n          };\n\n          setMessageHistory(prev => [...prev, botResponse]);\n          \n          // Update reply keyboard\n          if (targetNode.data.keyboardType === 'reply' && buttons) {\n            setCurrentReplyKeyboard(buttons);\n          } else if (targetNode.data.keyboardType === 'none') {\n            setCurrentReplyKeyboard(null);\n          }\n          \n          // Check if target node expects input\n          checkNodeInputRequirements(targetNode);\n        }, 500);\n      }\n    }\n  };\n\n  // Helper function to check node input requirements and set waiting states\n  const checkNodeInputRequirements = (node: Node) => {\n    setWaitingForInput(false);\n    setWaitingForPhoto(false);\n    setWaitingForVideo(false);\n    setWaitingForAudio(false);\n    setWaitingForDocument(false);\n\n    if (node.data.keyboardType === 'none') {\n      if (node.data.enableTextInput) {\n        setWaitingForInput(true);\n      }\n      if (node.data.enablePhotoInput) {\n        setWaitingForPhoto(true);\n      }\n      if (node.data.enableVideoInput) {\n        setWaitingForVideo(true);\n      }\n      if (node.data.enableAudioInput) {\n        setWaitingForAudio(true);\n      }\n      if (node.data.enableDocumentInput) {\n        setWaitingForDocument(true);\n      }\n    }\n  };\n\n  // Auto-scroll to bottom when new messages are added\n  useEffect(() => {\n    if (chatAreaRef.current) {\n      chatAreaRef.current.scrollTop = chatAreaRef.current.scrollHeight;\n    }\n  }, [messageHistory]);\n\n  const handleStart = () => {\n    if (!startNode) return;\n    \n    const time = new Date().toLocaleTimeString('ru-RU', { \n      hour: '2-digit', \n      minute: '2-digit' \n    });\n\n    const buttons = startNode.data.keyboardType !== 'none' && startNode.data.buttons ? startNode.data.buttons.map(btn => ({\n      text: replaceVariables(btn.text),\n      target: btn.target,\n      action: btn.action\n    })) : undefined;\n\n\n\n    const mediaInfo = getMediaInfo(startNode);\n\n    const botMessage = {\n      id: `msg-${Date.now()}`,\n      type: 'bot' as const,\n      text: startNode.data.messageText || (startNode.type === 'start' ? 'Привет!' : ''),\n      time,\n      buttons,\n      keyboardType: startNode.data.keyboardType,\n      ...mediaInfo\n    };\n\n    setMessageHistory([botMessage]);\n    setCurrentNodeId(startNode.id);\n    \n    // Set reply keyboard if applicable\n    if (startNode.data.keyboardType === 'reply' && buttons) {\n      setCurrentReplyKeyboard(buttons);\n    } else {\n      setCurrentReplyKeyboard(null);\n    }\n    \n    // Check if this node expects input\n    checkNodeInputRequirements(startNode);\n  };\n\n  const handleButtonClick = (buttonText: string, target?: string, action?: string) => {\n    handleUserMessage(buttonText, target, action);\n  };\n\n  const handleUserMessage = (messageText: string, target?: string, action?: string) => {\n    const time = new Date().toLocaleTimeString('ru-RU', { \n      hour: '2-digit', \n      minute: '2-digit' \n    });\n\n    // Add user message\n    const userMessage = {\n      id: `msg-${Date.now()}-user`,\n      type: 'user' as const,\n      text: messageText,\n      time\n    };\n\n    setMessageHistory(prev => [...prev, userMessage]);\n    \n    // Clear all waiting states\n    setWaitingForInput(false);\n    setWaitingForPhoto(false);\n    setWaitingForVideo(false);\n    setWaitingForAudio(false);\n    setWaitingForDocument(false);\n\n    // Navigate to target node if exists\n    setTimeout(() => {\n      if (target) {\n        // Find the target node by ID or by command if action is 'command'\n        let targetNode;\n        if (action === 'command') {\n          // Special handling for /start command - restart the bot\n          if (target === '/start') {\n            // Clear message history and restart\n            setTimeout(() => {\n              handleStart();\n            }, 100);\n            return;\n          }\n          // Find node with matching command\n          targetNode = nodes.find(node => \n            (node.type === 'command' || node.type === 'start') && \n            node.data.command === target\n          );\n        } else {\n          // Find node by ID\n          targetNode = nodes.find(node => node.id === target);\n        }\n        \n        if (targetNode) {\n          // Update current node\n          setCurrentNodeId(targetNode.id);\n          \n          // Get appropriate text and media based on node type\n          let responseText = '';\n          if (targetNode.data.messageText) {\n            responseText = replaceVariables(targetNode.data.messageText);\n          } else if (targetNode.type === 'command') {\n            responseText = `Команда: ${targetNode.data.command || 'Неизвестная команда'}`;\n          } else if (targetNode.type === 'start') {\n            responseText = `Стартовая команда: ${targetNode.data.command || '/start'}`;\n          } else if (['photo', 'video', 'audio', 'document', 'sticker', 'voice', 'animation'].includes(targetNode.type)) {\n            responseText = targetNode.data.mediaCaption || '';\n          } else if (targetNode.type === 'location') {\n            responseText = targetNode.data.title || 'Локация';\n          } else if (targetNode.type === 'contact') {\n            responseText = `${targetNode.data.firstName || 'Имя'} ${targetNode.data.lastName || ''}`.trim();\n          } else {\n            responseText = 'Сообщение';\n          }\n\n          const targetMediaInfo = getMediaInfo(targetNode);\n          \n          // Handle buttons\n          let buttons;\n          if (targetNode.data.keyboardType !== 'none' && targetNode.data.buttons) {\n            // Regular buttons for other node types\n            buttons = targetNode.data.buttons.map(btn => ({\n              text: replaceVariables(btn.text),\n              target: btn.target,\n              action: btn.action\n            }));\n          }\n\n          // Create bot response from target node\n          const keyboardType = targetNode.data.keyboardType;\n            \n          const botResponse = {\n            id: `msg-${Date.now()}-bot`,\n            type: 'bot' as const,\n            text: responseText,\n            time: new Date().toLocaleTimeString('ru-RU', { \n              hour: '2-digit', \n              minute: '2-digit' \n            }),\n            buttons,\n            keyboardType,\n            ...targetMediaInfo\n          };\n\n          setMessageHistory(prev => [...prev, botResponse]);\n          \n          // Update reply keyboard based on target node\n          if (targetNode.data.keyboardType === 'reply' && buttons) {\n            setCurrentReplyKeyboard(buttons);\n          } else if (targetNode.data.keyboardType === 'none') {\n            setCurrentReplyKeyboard(null);\n          }\n          \n          // Check if target node expects input\n          checkNodeInputRequirements(targetNode);\n        } else {\n          // Node not found - show error\n          let errorText = '';\n          if (action === 'command') {\n            errorText = `❌ Команда \"${target}\" не найдена в боте`;\n          } else {\n            errorText = `❌ Экран с ID \"${target}\" не найден`;\n          }\n          \n          const errorResponse = {\n            id: `msg-${Date.now()}-bot`,\n            type: 'bot' as const,\n            text: errorText,\n            time: new Date().toLocaleTimeString('ru-RU', { \n              hour: '2-digit', \n              minute: '2-digit' \n            })\n          };\n\n          setMessageHistory(prev => [...prev, errorResponse]);\n        }\n      } else {\n        // No target specified - handle free text input\n        const defaultResponse = {\n          id: `msg-${Date.now()}-bot`,\n          type: 'bot' as const,\n          text: `Вы написали: \"${messageText}\"`,\n          time: new Date().toLocaleTimeString('ru-RU', { \n            hour: '2-digit', \n            minute: '2-digit' \n          })\n        };\n\n        setMessageHistory(prev => [...prev, defaultResponse]);\n      }\n    }, 500);\n  };\n\n  const handleSendText = () => {\n    if (!textInput.trim()) return;\n    \n    const userInput = textInput.trim();\n    \n    // Check if input is a command\n    const commandFromText = parseCommandFromText(userInput);\n    if (commandFromText) {\n      // Find the command node\n      const commandNode = nodes.find(node => \n        (node.type === 'command' || node.type === 'start') && \n        node.data.command === commandFromText\n      );\n      \n      if (commandNode) {\n        handleUserMessage(userInput, commandNode.id, 'goto');\n      } else {\n        handleUserMessage(userInput, commandFromText, 'command');\n      }\n    } else {\n      // Check if input matches any node's synonyms\n      const synonymNode = nodes.find(node => \n        node.data.synonyms && \n        Array.isArray(node.data.synonyms) &&\n        node.data.synonyms.includes(userInput.toLowerCase())\n      );\n      \n      if (synonymNode) {\n        handleUserMessage(userInput, synonymNode.id, 'goto');\n      } else {\n        // Regular text input - check if we're waiting for user input\n        if (waitingForInput && currentNodeId) {\n          handleUserMessage(userInput);\n        } else {\n          handleUserMessage(userInput);\n        }\n      }\n    }\n    \n    setTextInput('');\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSendText();\n    }\n  };\n\n  const reset = () => {\n    setMessageHistory([]);\n    setCurrentNodeId('');\n    setCurrentReplyKeyboard(null);\n    setTextInput('');\n    setWaitingForInput(false);\n    setWaitingForPhoto(false);\n    setWaitingForVideo(false);\n    setWaitingForAudio(false);\n    setWaitingForDocument(false);\n    setUserVariables({});\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md max-h-[85vh] p-0 flex flex-col\">\n        <DialogHeader className=\"p-4 border-b border-border\">\n          <div className=\"flex items-center space-x-3\">\n            <div className=\"w-8 h-8 bg-primary rounded-lg flex items-center justify-center\">\n              <i className=\"fab fa-telegram-plane text-primary-foreground text-sm\"></i>\n            </div>\n            <div>\n              <DialogTitle className=\"font-semibold text-foreground\">Превью бота</DialogTitle>\n              <p className=\"text-xs text-muted-foreground\">{projectName}</p>\n            </div>\n          </div>\n        </DialogHeader>\n\n        {/* Chat Area */}\n        <div ref={chatAreaRef} className=\"flex-1 bg-muted/30 overflow-y-auto p-4 space-y-3 min-h-[300px] max-h-[400px]\">\n          {messageHistory.length === 0 ? (\n            <div className=\"flex items-center justify-center h-full\">\n              <div className=\"text-center\">\n                <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center mx-auto mb-4\">\n                  <i className=\"fas fa-robot text-primary text-xl\"></i>\n                </div>\n                <p className=\"text-sm text-muted-foreground mb-4\">Нажмите \"Запустить\", чтобы протестировать бота</p>\n                <button\n                  onClick={handleStart}\n                  className=\"px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors\"\n                  disabled={!startNode}\n                >\n                  {startNode ? 'Запустить бота' : 'Нет стартового узла'}\n                </button>\n              </div>\n            </div>\n          ) : (\n            messageHistory.map((message) => (\n              <div key={message.id}>\n                {message.type === 'bot' ? (\n                  <div className=\"flex items-start space-x-2\">\n                    <div className=\"w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0\">\n                      <i className=\"fas fa-robot text-white text-xs\"></i>\n                    </div>\n                    <div className=\"max-w-xs\">\n                      {/* Media Content */}\n                      {message.mediaType === 'photo' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg overflow-hidden shadow-sm mb-1\">\n                          <img\n                            src={message.mediaUrl}\n                            alt=\"Фото\"\n                            className=\"w-full h-48 object-cover\"\n                            onError={(e) => {\n                              e.currentTarget.src = 'https://picsum.photos/300/200?random=' + Math.random();\n                            }}\n                          />\n                          {message.mediaCaption && (\n                            <div className=\"px-4 py-2\">\n                              <div \n                                className=\"text-sm text-gray-900\"\n                                dangerouslySetInnerHTML={{ __html: renderMarkdown(message.mediaCaption) }}\n                              />\n                            </div>\n                          )}\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'video' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg overflow-hidden shadow-sm mb-1\">\n                          <video\n                            src={message.mediaUrl}\n                            controls\n                            className=\"w-full h-48 object-cover\"\n                            poster=\"https://picsum.photos/300/200?random=video\"\n                          />\n                          {message.mediaCaption && (\n                            <div className=\"px-4 py-2\">\n                              <div \n                                className=\"text-sm text-gray-900\"\n                                dangerouslySetInnerHTML={{ __html: renderMarkdown(message.mediaCaption) }}\n                              />\n                            </div>\n                          )}\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'audio' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg px-4 py-3 shadow-sm mb-1\">\n                          <div className=\"flex items-center space-x-3 mb-2\">\n                            <div className=\"w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center\">\n                              <i className=\"fas fa-music text-orange-600 text-xs\"></i>\n                            </div>\n                            <div className=\"flex-1\">\n                              <p className=\"text-sm font-medium text-gray-900\">\n                                {message.mediaData?.performer || 'Аудиофайл'}\n                              </p>\n                              {message.mediaData?.duration && (\n                                <p className=\"text-xs text-gray-500\">{message.mediaData.duration}с</p>\n                              )}\n                            </div>\n                          </div>\n                          <audio src={message.mediaUrl} controls className=\"w-full h-8\" />\n                          {message.mediaCaption && (\n                            <div \n                              className=\"text-sm text-gray-900 mt-2\"\n                              dangerouslySetInnerHTML={{ __html: renderMarkdown(message.mediaCaption) }}\n                            />\n                          )}\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'document' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg px-4 py-3 shadow-sm mb-1\">\n                          <div className=\"flex items-center space-x-3\">\n                            <div className=\"w-8 h-8 bg-teal-100 rounded-full flex items-center justify-center\">\n                              <i className=\"fas fa-file-alt text-teal-600 text-xs\"></i>\n                            </div>\n                            <div className=\"flex-1\">\n                              <p className=\"text-sm font-medium text-gray-900\">\n                                {message.mediaData?.filename || 'Документ'}\n                              </p>\n                              <a \n                                href={message.mediaUrl} \n                                target=\"_blank\" \n                                rel=\"noopener noreferrer\"\n                                className=\"text-xs text-blue-600 hover:underline\"\n                              >\n                                Открыть документ\n                              </a>\n                            </div>\n                          </div>\n                          {message.mediaCaption && (\n                            <div \n                              className=\"text-sm text-gray-900 mt-2\"\n                              dangerouslySetInnerHTML={{ __html: renderMarkdown(message.mediaCaption) }}\n                            />\n                          )}\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'sticker' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg overflow-hidden shadow-sm mb-1\">\n                          <img\n                            src={message.mediaUrl}\n                            alt=\"Стикер\"\n                            className=\"w-32 h-32 object-contain mx-auto\"\n                          />\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'voice' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg px-4 py-3 shadow-sm mb-1\">\n                          <div className=\"flex items-center space-x-3\">\n                            <div className=\"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center\">\n                              <i className=\"fas fa-microphone text-green-600 text-xs\"></i>\n                            </div>\n                            <div className=\"flex-1\">\n                              <p className=\"text-sm font-medium text-gray-900\">Голосовое сообщение</p>\n                              {message.mediaData?.duration && (\n                                <p className=\"text-xs text-gray-500\">{message.mediaData.duration}с</p>\n                              )}\n                            </div>\n                          </div>\n                          <audio src={message.mediaUrl} controls className=\"w-full h-8 mt-2\" />\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'animation' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg overflow-hidden shadow-sm mb-1\">\n                          <img\n                            src={message.mediaUrl}\n                            alt=\"Анимация\"\n                            className=\"w-full h-48 object-cover\"\n                          />\n                          {message.mediaCaption && (\n                            <div className=\"px-4 py-2\">\n                              <div \n                                className=\"text-sm text-gray-900\"\n                                dangerouslySetInnerHTML={{ __html: renderMarkdown(message.mediaCaption) }}\n                              />\n                            </div>\n                          )}\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'location' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg px-4 py-3 shadow-sm mb-1\">\n                          <div className=\"flex items-center space-x-3 mb-2\">\n                            <div className=\"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center\">\n                              <i className=\"fas fa-map-marker-alt text-green-600 text-xs\"></i>\n                            </div>\n                            <div className=\"flex-1\">\n                              <p className=\"text-sm font-medium text-gray-900\">\n                                {message.mediaData?.title || 'Локация'}\n                              </p>\n                              {message.mediaData?.address && (\n                                <p className=\"text-xs text-gray-500\">{message.mediaData.address}</p>\n                              )}\n                            </div>\n                          </div>\n                          <div className=\"bg-gray-100 rounded-lg p-3\">\n                            <p className=\"text-xs text-gray-600\">\n                              📍 {message.mediaData?.latitude?.toFixed(4)}, {message.mediaData?.longitude?.toFixed(4)}\n                            </p>\n                            <a \n                              href={`https://maps.google.com/?q=${message.mediaData?.latitude},${message.mediaData?.longitude}`}\n                              target=\"_blank\"\n                              rel=\"noopener noreferrer\"\n                              className=\"text-xs text-blue-600 hover:underline\"\n                            >\n                              Открыть в картах\n                            </a>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'contact' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg px-4 py-3 shadow-sm mb-1\">\n                          <div className=\"flex items-center space-x-3\">\n                            <div className=\"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center\">\n                              <i className=\"fas fa-user text-blue-600 text-xs\"></i>\n                            </div>\n                            <div className=\"flex-1\">\n                              <p className=\"text-sm font-medium text-gray-900\">\n                                {message.mediaData?.firstName} {message.mediaData?.lastName}\n                              </p>\n                              {message.mediaData?.phoneNumber && (\n                                <p className=\"text-xs text-gray-500\">{message.mediaData.phoneNumber}</p>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'poll' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg px-4 py-3 shadow-sm mb-1\">\n                          <div className=\"flex items-center space-x-2 mb-3\">\n                            <div className=\"w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center\">\n                              <i className=\"fas fa-poll text-purple-600 text-xs\"></i>\n                            </div>\n                            <p className=\"text-sm font-medium text-gray-900\">Опрос</p>\n                          </div>\n                          <p className=\"text-sm text-gray-900 mb-3\">{message.mediaData?.question}</p>\n                          <div className=\"space-y-2\">\n                            {message.mediaData?.options?.map((option: string, index: number) => (\n                              <div key={index} className=\"flex items-center space-x-2\">\n                                <div className=\"w-4 h-4 border border-gray-300 rounded\"></div>\n                                <p className=\"text-sm text-gray-700\">{option}</p>\n                              </div>\n                            ))}\n                          </div>\n                          <div className=\"mt-2 flex items-center space-x-4 text-xs text-gray-500\">\n                            {message.mediaData?.allowsMultipleAnswers && (\n                              <span>Множественный выбор</span>\n                            )}\n                            {message.mediaData?.anonymousVoting && (\n                              <span>Анонимно</span>\n                            )}\n                          </div>\n                        </div>\n                      )}\n                      \n                      {message.mediaType === 'dice' && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg px-4 py-3 shadow-sm mb-1\">\n                          <div className=\"text-center\">\n                            <div className=\"text-4xl mb-2\">{message.mediaData?.emoji || '🎲'}</div>\n                            <p className=\"text-sm text-gray-600\">Бросок кубика</p>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {/* Text message (if any) */}\n                      {message.text && !['poll', 'dice'].includes(message.mediaType || '') && (\n                        <div className=\"bg-white rounded-2xl rounded-tl-lg px-4 py-3 shadow-sm\">\n                          <div \n                            className=\"text-sm text-gray-900\"\n                            dangerouslySetInnerHTML={{ __html: renderMarkdown(message.text) }}\n                          />\n                          <p className=\"text-xs text-gray-500 mt-1\">{message.time}</p>\n                        </div>\n                      )}\n                      \n                      {/* Show time for media messages */}\n                      {message.mediaType && ['poll', 'dice'].includes(message.mediaType) && (\n                        <p className=\"text-xs text-gray-500 mt-1 px-2\">{message.time}</p>\n                      )}\n                    </div>\n                  </div>\n                ) : (\n                  <div className=\"flex items-start space-x-2 justify-end\">\n                    <div className=\"bg-blue-500 text-white rounded-2xl rounded-tr-lg px-4 py-3 max-w-xs\">\n                      <p className=\"text-sm\">{message.text}</p>\n                      <p className=\"text-xs text-blue-200 mt-1\">{message.time}</p>\n                    </div>\n                    <div className=\"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0\">\n                      <i className=\"fas fa-user text-gray-600 text-xs\"></i>\n                    </div>\n                  </div>\n                )}\n\n                {/* Inline Buttons */}\n                {message.type === 'bot' && message.buttons && message.keyboardType === 'inline' && (\n                  <div className=\"ml-10 mt-2\">\n                    {message.buttons.length <= 2 ? (\n                      <div className=\"space-y-1\">\n                        {message.buttons.map((button, index) => (\n                          <button\n                            key={index}\n                            onClick={() => handleButtonClick(button.text, button.target, button.action)}\n                            className=\"w-full bg-blue-500 text-white text-sm font-medium py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors\"\n                          >\n                            {button.text}\n                          </button>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"grid grid-cols-2 gap-1\">\n                        {message.buttons.map((button, index) => (\n                          <button\n                            key={index}\n                            onClick={() => handleButtonClick(button.text, button.target, button.action)}\n                            className=\"bg-blue-500 text-white text-xs font-medium py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors\"\n                          >\n                            {button.text}\n                          </button>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                )}\n              </div>\n            ))\n          )}\n        </div>\n\n        {/* Reply Keyboard */}\n        {currentReplyKeyboard && (\n          <div className=\"p-4 bg-gray-50 border-t border-gray-200\">\n            <div className=\"space-y-2\">\n              <p className=\"text-xs text-gray-600 mb-2\">Reply клавиатура:</p>\n              <div className=\"grid grid-cols-2 gap-2\">\n                {currentReplyKeyboard.map((button, index) => (\n                  <button\n                    key={index}\n                    onClick={() => handleButtonClick(button.text, button.target, button.action)}\n                    className=\"bg-white border border-gray-300 text-gray-700 text-sm font-medium py-2 px-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-center\"\n                  >\n                    {button.text}\n                  </button>\n                ))}\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Text Input Area */}\n        <div className=\"p-4 border-t border-gray-200 bg-white\">\n          {/* Media Input Buttons */}\n          {(waitingForPhoto || waitingForVideo || waitingForAudio || waitingForDocument) && (\n            <div className=\"mb-3\">\n              <p className=\"text-xs text-gray-600 mb-2\">Бот ожидает ввод:</p>\n              <div className=\"grid grid-cols-2 gap-2\">\n                {waitingForPhoto && (\n                  <Button\n                    onClick={() => handleMediaInput('photo')}\n                    variant=\"outline\"\n                    className=\"flex items-center justify-center gap-2\"\n                    data-testid=\"button-send-photo\"\n                  >\n                    📷 Отправить фото\n                  </Button>\n                )}\n                {waitingForVideo && (\n                  <Button\n                    onClick={() => handleMediaInput('video')}\n                    variant=\"outline\"\n                    className=\"flex items-center justify-center gap-2\"\n                    data-testid=\"button-send-video\"\n                  >\n                    🎥 Отправить видео\n                  </Button>\n                )}\n                {waitingForAudio && (\n                  <Button\n                    onClick={() => handleMediaInput('audio')}\n                    variant=\"outline\"\n                    className=\"flex items-center justify-center gap-2\"\n                    data-testid=\"button-send-audio\"\n                  >\n                    🎵 Отправить аудио\n                  </Button>\n                )}\n                {waitingForDocument && (\n                  <Button\n                    onClick={() => handleMediaInput('document')}\n                    variant=\"outline\"\n                    className=\"flex items-center justify-center gap-2\"\n                    data-testid=\"button-send-document\"\n                  >\n                    📄 Отправить документ\n                  </Button>\n                )}\n              </div>\n            </div>\n          )}\n          \n          {/* Text Input */}\n          <div className=\"flex items-center space-x-2 mb-3\">\n            <Input\n              ref={inputRef}\n              value={textInput}\n              onChange={(e) => setTextInput(e.target.value)}\n              onKeyPress={handleKeyPress}\n              placeholder={waitingForInput ? \"Бот ожидает ввод...\" : \"Введите сообщение...\"}\n              className=\"flex-1\"\n              disabled={!messageHistory.length}\n              data-testid=\"input-message\"\n            />\n            <Button\n              onClick={handleSendText}\n              disabled={!textInput.trim() || !messageHistory.length}\n              size=\"sm\"\n              data-testid=\"button-send-message\"\n            >\n              <i className=\"fas fa-paper-plane\"></i>\n            </Button>\n          </div>\n          \n          {/* Controls */}\n          <div className=\"flex items-center space-x-2\">\n            <button\n              onClick={reset}\n              className=\"px-3 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors\"\n            >\n              Сбросить\n            </button>\n            <div className=\"flex-1\"></div>\n            <span className=\"text-xs text-gray-500\">\n              {messageHistory.length} сообщений\n            </span>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":43211},"theme-test.js":{"content":"// Тест функциональности темной темы\nconsole.log('🌓 Начинаю тестирование темной темы...');\n\n// Проверка 1: Наличие ThemeProvider в DOM\nsetTimeout(() => {\n  console.log('1. Проверка HTML структуры...');\n  const html = document.documentElement;\n  console.log('   HTML classes:', html.className);\n  console.log('   Color scheme:', getComputedStyle(html).colorScheme);\n\n  // Проверка 2: Наличие переключателя темы\n  console.log('2. Поиск переключателя темы...');\n  const themeButtons = document.querySelectorAll('button[aria-label*=\"тему\"], button:has(svg), button[title*=\"тему\"]');\n  console.log('   Найдено кнопок переключения:', themeButtons.length);\n\n  // Проверка 3: CSS переменные\n  console.log('3. Проверка CSS переменных...');\n  const computedStyle = getComputedStyle(document.documentElement);\n  const bgColor = computedStyle.getPropertyValue('--background');\n  const fgColor = computedStyle.getPropertyValue('--foreground');\n  console.log('   --background:', bgColor);\n  console.log('   --foreground:', fgColor);\n\n  // Проверка 4: localStorage\n  console.log('4. Проверка localStorage...');\n  const savedTheme = localStorage.getItem('telegram-bot-builder-theme');\n  console.log('   Сохраненная тема:', savedTheme);\n\n  // Проверка 5: Симуляция переключения темы\n  console.log('5. Симуляция переключения темы...');\n  \n  // Добавляем темный класс\n  html.classList.add('dark');\n  setTimeout(() => {\n    const darkBg = getComputedStyle(document.documentElement).getPropertyValue('--background');\n    console.log('   Фон в темной теме:', darkBg);\n    \n    // Убираем темный класс\n    html.classList.remove('dark');\n    setTimeout(() => {\n      const lightBg = getComputedStyle(document.documentElement).getPropertyValue('--background');\n      console.log('   Фон в светлой теме:', lightBg);\n      \n      console.log('✅ Тестирование завершено!');\n      console.log('📊 Результаты:');\n      console.log('   - CSS переменные работают:', !!bgColor && !!fgColor);\n      console.log('   - Темные/светлые цвета различаются:', darkBg !== lightBg);\n      console.log('   - localStorage поддерживается:', typeof Storage !== 'undefined');\n    }, 100);\n  }, 100);\n  \n}, 1000);","size_bytes":2633},"client/src/components/layout/layout-buttons.tsx":{"content":"import { Button } from '@/components/ui/button';\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\nimport { \n  PanelTop, \n  PanelLeft, \n  LayoutGrid,\n  PanelRight,\n  EyeOff,\n  Eye\n} from 'lucide-react';\n\ninterface LayoutButtonsProps {\n  onToggleCanvas?: () => void;\n  onToggleHeader?: () => void;\n  onToggleSidebar?: () => void;\n  onToggleProperties?: () => void;\n  onShowFullLayout?: () => void;\n  canvasVisible?: boolean;\n  headerVisible?: boolean;\n  sidebarVisible?: boolean;\n  propertiesVisible?: boolean;\n  className?: string;\n}\n\nexport function LayoutButtons({ \n  onToggleCanvas, \n  onToggleHeader, \n  onToggleSidebar,\n  onToggleProperties,\n  onShowFullLayout,\n  canvasVisible = true,\n  headerVisible = true,\n  sidebarVisible = true,\n  propertiesVisible = true,\n  className = \"\" \n}: LayoutButtonsProps) {\n  return (\n    <TooltipProvider>\n      <div className={`flex items-center gap-1 p-2 bg-background border border-border rounded-lg ${className}`}>\n        {/* Кнопка переключения шапки - всегда видна */}\n        {onToggleHeader && (\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={onToggleHeader}\n                className={`h-8 w-8 p-0 rounded-md ${\n                  headerVisible \n                    ? 'bg-gray-600 hover:bg-gray-700 text-white' \n                    : 'bg-gray-300 hover:bg-gray-400 text-gray-600'\n                }`}\n              >\n                <PanelTop className=\"h-4 w-4\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>{headerVisible ? 'Скрыть шапку' : 'Показать шапку'}</p>\n            </TooltipContent>\n          </Tooltip>\n        )}\n\n        {/* Кнопка переключения боковой панели - всегда видна */}\n        {onToggleSidebar && (\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={onToggleSidebar}\n                className={`h-8 w-8 p-0 rounded-md ${\n                  sidebarVisible \n                    ? 'bg-gray-600 hover:bg-gray-700 text-white' \n                    : 'bg-gray-300 hover:bg-gray-400 text-gray-600'\n                }`}\n              >\n                <PanelLeft className=\"h-4 w-4\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>{sidebarVisible ? 'Скрыть боковую панель' : 'Показать боковую панель'}</p>\n            </TooltipContent>\n          </Tooltip>\n        )}\n\n        {/* Кнопка переключения холста - всегда видна */}\n        {onToggleCanvas && (\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={onToggleCanvas}\n                className={`h-8 w-8 p-0 rounded-md ${\n                  canvasVisible \n                    ? 'bg-gray-600 hover:bg-gray-700 text-white' \n                    : 'bg-gray-300 hover:bg-gray-400 text-gray-600'\n                }`}\n              >\n                <LayoutGrid className=\"h-4 w-4\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>{canvasVisible ? 'Скрыть холст' : 'Показать холст'}</p>\n            </TooltipContent>\n          </Tooltip>\n        )}\n\n        {/* Кнопка переключения панели свойств - всегда видна */}\n        {onToggleProperties && (\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={onToggleProperties}\n                className={`h-8 w-8 p-0 rounded-md ${\n                  propertiesVisible \n                    ? 'bg-gray-600 hover:bg-gray-700 text-white' \n                    : 'bg-gray-300 hover:bg-gray-400 text-gray-600'\n                }`}\n              >\n                <PanelRight className=\"h-4 w-4\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>{propertiesVisible ? 'Скрыть панель свойств' : 'Показать панель свойств'}</p>\n            </TooltipContent>\n          </Tooltip>\n        )}\n\n        {/* Дополнительные кнопки управления */}\n        {(() => {\n          const visiblePanels = [headerVisible, sidebarVisible, canvasVisible, propertiesVisible].filter(Boolean).length;\n          const hiddenPanels = 4 - visiblePanels;\n\n          // Если видна только одна панель - показываем кнопку \"Скрыть текущую\"\n          if (visiblePanels === 1) {\n            let currentVisibleAction;\n            let currentVisibleIcon;\n            let currentVisibleTooltip;\n\n            if (sidebarVisible) {\n              currentVisibleAction = onToggleSidebar;\n              currentVisibleIcon = <EyeOff className=\"h-4 w-4\" />;\n              currentVisibleTooltip = \"Скрыть боковую панель\";\n            } else if (headerVisible) {\n              currentVisibleAction = onToggleHeader;\n              currentVisibleIcon = <EyeOff className=\"h-4 w-4\" />;\n              currentVisibleTooltip = \"Скрыть шапку\";\n            } else if (canvasVisible) {\n              currentVisibleAction = onToggleCanvas;\n              currentVisibleIcon = <EyeOff className=\"h-4 w-4\" />;\n              currentVisibleTooltip = \"Скрыть холст\";\n            } else if (propertiesVisible) {\n              currentVisibleAction = onToggleProperties;\n              currentVisibleIcon = <EyeOff className=\"h-4 w-4\" />;\n              currentVisibleTooltip = \"Скрыть панель свойств\";\n            }\n\n            return currentVisibleAction && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={currentVisibleAction}\n                    className=\"h-8 w-8 p-0 bg-orange-600 hover:bg-orange-700 text-white rounded-md\"\n                  >\n                    {currentVisibleIcon}\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>{currentVisibleTooltip}</p>\n                </TooltipContent>\n              </Tooltip>\n            );\n          }\n          \n          // Если скрыто несколько панелей - показываем кнопку \"Показать всё\"\n          if (hiddenPanels > 1 && onShowFullLayout) {\n            return (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={onShowFullLayout}\n                    className=\"h-8 w-8 p-0 bg-blue-600 hover:bg-blue-700 text-white rounded-md\"\n                  >\n                    <Eye className=\"h-4 w-4\" />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Показать все панели</p>\n                </TooltipContent>\n              </Tooltip>\n            );\n          }\n\n          return null;\n        })()}\n      </div>\n    </TooltipProvider>\n  );\n}","size_bytes":7583},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":1901},"client/src/components/ui/connection-suggestions.tsx":{"content":"import { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Node, Connection } from '@/types/bot';\nimport { ConnectionSuggestion, generateAutoConnections } from '@/utils/auto-connection';\n\ninterface ConnectionSuggestionsProps {\n  nodes: Node[];\n  connections: Connection[];\n  onCreateConnection: (source: string, target: string) => void;\n}\n\nexport function ConnectionSuggestions({ nodes, connections, onCreateConnection }: ConnectionSuggestionsProps) {\n  const [suggestions] = useState<ConnectionSuggestion[]>(() => \n    generateAutoConnections(nodes, connections).slice(0, 5)\n  );\n\n  if (suggestions.length === 0) {\n    return null;\n  }\n\n  const getNodeName = (nodeId: string) => {\n    const node = nodes.find(n => n.id === nodeId);\n    if (!node) return 'Неизвестный узел';\n    \n    if (node.type === 'start') return 'Старт';\n    if (node.type === 'command') return node.data.command || 'Команда';\n    if (node.type === 'message') return 'Сообщение';\n    if (node.type === 'keyboard') return 'Клавиатура';\n    if (node.type === 'photo') return 'Фото';\n    if (node.type === 'condition') return 'Условие';\n    if (node.type === 'input') return 'Ввод';\n    return node.type;\n  };\n\n  const getConfidenceColor = (confidence: number) => {\n    if (confidence > 0.8) return 'bg-green-500';\n    if (confidence > 0.6) return 'bg-yellow-500';\n    return 'bg-orange-500';\n  };\n\n  return (\n    <Card className=\"w-full max-w-md\">\n      <CardHeader>\n        <CardTitle className=\"text-sm font-medium flex items-center\">\n          <i className=\"fas fa-magic text-blue-500 mr-2\" />\n          Рекомендации соединений\n        </CardTitle>\n        <CardDescription className=\"text-xs\">\n          Автоматические предложения для улучшения потока бота\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        {suggestions.map((suggestion, index) => (\n          <div key={index} className=\"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center space-x-2 text-sm\">\n                <span className=\"font-medium truncate\">\n                  {getNodeName(suggestion.source)}\n                </span>\n                <i className=\"fas fa-arrow-right text-gray-400 text-xs\" />\n                <span className=\"font-medium truncate\">\n                  {getNodeName(suggestion.target)}\n                </span>\n              </div>\n              <p className=\"text-xs text-gray-500 dark:text-gray-400 mt-1 truncate\">\n                {suggestion.reason}\n              </p>\n              <div className=\"flex items-center mt-2 space-x-2\">\n                <div className=\"flex items-center space-x-1\">\n                  <div className={`w-2 h-2 rounded-full ${getConfidenceColor(suggestion.confidence)}`} />\n                  <span className=\"text-xs text-gray-500\">\n                    {Math.round(suggestion.confidence * 100)}%\n                  </span>\n                </div>\n              </div>\n            </div>\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={() => onCreateConnection(suggestion.source, suggestion.target)}\n              className=\"ml-2 flex-shrink-0\"\n            >\n              <i className=\"fas fa-plus text-xs\" />\n            </Button>\n          </div>\n        ))}\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":3714},"client/src/components/ui/canvas-sheets.tsx":{"content":"import { useState, useRef, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\n// Убираем DropdownMenu и Dialog - теперь всё просто\nimport { \n  Plus, \n  X, \n  Copy, \n  Trash2, \n  ChevronLeft, \n  ChevronRight,\n  FileText\n} from 'lucide-react';\nimport { CanvasSheet } from '@shared/schema';\nimport { cn } from '@/lib/utils';\nimport { useIsMobile } from '@/hooks/use-mobile';\n\ninterface CanvasSheetsProps {\n  sheets: CanvasSheet[];\n  activeSheetId: string | null;\n  onSheetSelect: (sheetId: string) => void;\n  onSheetAdd: (name: string) => void;\n  onSheetDelete: (sheetId: string) => void;\n  onSheetRename: (sheetId: string, newName: string) => void;\n  onSheetDuplicate: (sheetId: string) => void;\n  maxVisibleTabs?: number;\n}\n\nexport function CanvasSheets({\n  sheets,\n  activeSheetId,\n  onSheetSelect,\n  onSheetAdd,\n  onSheetDelete,\n  onSheetRename,\n  onSheetDuplicate,\n  maxVisibleTabs = 8\n}: CanvasSheetsProps) {\n  const [scrollPosition, setScrollPosition] = useState(0);\n  const [isRenaming, setIsRenaming] = useState<string | null>(null);\n  const [newName, setNewName] = useState('');\n  // Состояния для обработки свайп-жестов\n  const [touchStart, setTouchStart] = useState<number | null>(null);\n  const [touchEnd, setTouchEnd] = useState<number | null>(null);\n  // Убираем состояние диалога - теперь создаём листы сразу\n  const tabsContainerRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const isMobile = useIsMobile();\n\n  // Автофокус при начале переименования\n  useEffect(() => {\n    if (isRenaming && inputRef.current) {\n      inputRef.current.focus();\n      inputRef.current.select();\n    }\n  }, [isRenaming]);\n\n  // Прокрутка к активной вкладке\n  useEffect(() => {\n    if (activeSheetId && tabsContainerRef.current) {\n      const activeTab = tabsContainerRef.current.querySelector(`[data-sheet-id=\"${activeSheetId}\"]`);\n      if (activeTab) {\n        activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });\n      }\n    }\n  }, [activeSheetId]);\n\n  const canScrollLeft = scrollPosition > 0;\n  const canScrollRight = sheets.length > maxVisibleTabs;\n\n  const scrollLeft = () => {\n    if (tabsContainerRef.current) {\n      const newPosition = Math.max(0, scrollPosition - 1);\n      setScrollPosition(newPosition);\n      tabsContainerRef.current.scrollTo({\n        left: newPosition * 150, // 150px per tab\n        behavior: 'smooth'\n      });\n    }\n  };\n\n  const scrollRight = () => {\n    if (tabsContainerRef.current) {\n      const maxScroll = Math.max(0, sheets.length - maxVisibleTabs);\n      const newPosition = Math.min(maxScroll, scrollPosition + 1);\n      setScrollPosition(newPosition);\n      tabsContainerRef.current.scrollTo({\n        left: newPosition * 150,\n        behavior: 'smooth'\n      });\n    }\n  };\n\n  const handleRename = (sheetId: string) => {\n    const sheet = sheets.find(s => s.id === sheetId);\n    if (sheet) {\n      setNewName(sheet.name);\n      setIsRenaming(sheetId);\n    }\n  };\n\n  const confirmRename = () => {\n    if (isRenaming && newName.trim()) {\n      onSheetRename(isRenaming, newName.trim());\n      setIsRenaming(null);\n      setNewName('');\n    }\n  };\n\n  const cancelRename = () => {\n    setIsRenaming(null);\n    setNewName('');\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter') {\n      confirmRename();\n    } else if (e.key === 'Escape') {\n      cancelRename();\n    }\n  };\n\n  // Минимальное расстояние свайпа для активации\n  const minSwipeDistance = 50;\n\n  const onTouchStart = (e: React.TouchEvent) => {\n    if (!isMobile) return;\n    setTouchEnd(null);\n    setTouchStart(e.targetTouches[0].clientX);\n  };\n\n  const onTouchMove = (e: React.TouchEvent) => {\n    if (!isMobile) return;\n    setTouchEnd(e.targetTouches[0].clientX);\n  };\n\n  const onTouchEnd = () => {\n    if (!isMobile || !touchStart || !touchEnd) return;\n    \n    const distance = touchStart - touchEnd;\n    const isLeftSwipe = distance > minSwipeDistance;\n    const isRightSwipe = distance < -minSwipeDistance;\n\n    if (isLeftSwipe || isRightSwipe) {\n      if (!activeSheetId) return;\n      \n      const currentIndex = sheets.findIndex(sheet => sheet.id === activeSheetId);\n      if (currentIndex === -1) return;\n\n      if (isLeftSwipe && currentIndex < sheets.length - 1) {\n        // Свайп влево - следующий лист\n        onSheetSelect(sheets[currentIndex + 1].id);\n      } else if (isRightSwipe && currentIndex > 0) {\n        // Свайп вправо - предыдущий лист  \n        onSheetSelect(sheets[currentIndex - 1].id);\n      }\n    }\n  };\n\n  // Быстрое переключение между листами для мобильных\n  const switchToNextSheet = () => {\n    if (!activeSheetId) return;\n    const currentIndex = sheets.findIndex(sheet => sheet.id === activeSheetId);\n    if (currentIndex < sheets.length - 1) {\n      onSheetSelect(sheets[currentIndex + 1].id);\n    }\n  };\n\n  const switchToPrevSheet = () => {\n    if (!activeSheetId) return;\n    const currentIndex = sheets.findIndex(sheet => sheet.id === activeSheetId);\n    if (currentIndex > 0) {\n      onSheetSelect(sheets[currentIndex - 1].id);\n    }\n  };\n\n  // Создание листа одним кликом с автоматическим именем\n  const addNewSheet = () => {\n    // Генерируем имя нового листа\n    const existingNumbers = sheets\n      .map(sheet => {\n        const match = sheet.name.match(/^Лист (\\d+)$/);\n        return match ? parseInt(match[1]) : 0;\n      })\n      .filter(num => num > 0);\n    \n    const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : sheets.length + 1;\n    const newSheetName = `Лист ${nextNumber}`;\n    \n    onSheetAdd(newSheetName);\n  };\n\n  return (\n    <div className={`flex items-center bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm border border-gray-200 dark:border-slate-700 rounded-lg shadow-xl relative transition-all duration-300 hover:shadow-2xl ${isMobile ? 'px-2 py-2' : 'px-3 py-2'}`}>\n      {/* Градиентная подложка */}\n      <div className=\"absolute inset-0 bg-gradient-to-r from-blue-50/50 via-transparent to-purple-50/50 dark:from-blue-950/20 dark:via-transparent dark:to-purple-950/20 rounded-lg pointer-events-none\"></div>\n      {/* Кнопка прокрутки влево - для мобильных переключает листы */}\n      {(canScrollLeft || (isMobile && sheets.length > 1)) && (\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={isMobile ? switchToPrevSheet : scrollLeft}\n          className={`p-0 rounded-full bg-gradient-to-r from-blue-500/10 to-blue-600/10 hover:from-blue-500/20 hover:to-blue-600/20 active:from-blue-500/30 active:to-blue-600/30 dark:from-blue-400/10 dark:to-blue-500/10 dark:hover:from-blue-400/20 dark:hover:to-blue-500/20 dark:active:from-blue-400/30 dark:active:to-blue-500/30 transition-all duration-200 hover:scale-110 active:scale-95 relative z-10 touch-manipulation ${isMobile ? 'h-12 w-12 mr-2' : 'h-8 w-8 mr-2'}`}\n          disabled={isMobile ? (activeSheetId ? sheets.findIndex(s => s.id === activeSheetId) === 0 : true) : false}\n        >\n          <ChevronLeft className={`text-blue-600 dark:text-blue-400 ${isMobile ? 'h-6 w-6' : 'h-4 w-4'}`} />\n        </Button>\n      )}\n\n      {/* Контейнер вкладок */}\n      <div \n        ref={tabsContainerRef}\n        className=\"flex-1 flex overflow-x-hidden scroll-smooth relative z-10\"\n        style={{ \n          maxWidth: isMobile \n            ? `calc(100vw - 180px)` \n            : `min(${maxVisibleTabs * 170}px, calc(100vw - 320px))` \n        }}\n        onTouchStart={onTouchStart}\n        onTouchMove={onTouchMove}\n        onTouchEnd={onTouchEnd}\n      >\n        <div className={`flex ${isMobile ? 'gap-2' : 'gap-2'}`}>\n          {sheets.map((sheet) => (\n            <div\n              key={sheet.id}\n              data-sheet-id={sheet.id}\n              className={cn(\n                \"group flex items-center cursor-pointer transition-all duration-300 relative backdrop-blur-sm select-none touch-manipulation\",\n                isMobile \n                  ? \"min-w-[120px] max-w-[180px] min-h-[44px] h-12 px-3 active:scale-[0.98] rounded-xl\" \n                  : \"min-w-[140px] max-w-[200px] h-10 px-3 transform hover:scale-[1.02] rounded-lg\",\n                activeSheetId === sheet.id\n                  ? \"bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg shadow-blue-500/25 z-20 ring-2 ring-blue-300/50 dark:ring-blue-600/50\"\n                  : \"bg-white/70 dark:bg-slate-800/70 text-gray-700 dark:text-gray-300 hover:bg-white/90 dark:hover:bg-slate-700/90 shadow-sm hover:shadow-md border border-gray-200/50 dark:border-slate-600/50\"\n              )}\n              onClick={() => onSheetSelect(sheet.id)}\n            >\n              {!isMobile && (\n                <FileText className={cn(\n                  \"h-4 w-4 mr-3 transition-all duration-200\",\n                  activeSheetId === sheet.id\n                    ? \"text-white/90 drop-shadow-sm\"\n                    : \"text-gray-500 dark:text-gray-400 group-hover:text-blue-500 dark:group-hover:text-blue-400\"\n                )} />\n              )}\n              \n              {isRenaming === sheet.id ? (\n                <Input\n                  ref={inputRef}\n                  value={newName}\n                  onChange={(e) => setNewName(e.target.value)}\n                  onKeyDown={handleKeyDown}\n                  onBlur={confirmRename}\n                  className={`bg-transparent border-none focus:ring-1 focus:ring-blue-500 ${\n                    isMobile ? 'h-7 text-sm px-2 py-1' : 'h-6 text-xs px-1 py-0'\n                  }`}\n                />\n              ) : (\n                <span \n                  className={cn(\n                    \"flex-1 cursor-text transition-all duration-200 truncate\",\n                    isMobile \n                      ? \"text-sm font-semibold\" \n                      : \"text-sm font-semibold\",\n                    activeSheetId === sheet.id\n                      ? \"text-white drop-shadow-sm\"\n                      : \"text-gray-700 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400\"\n                  )}\n                  onDoubleClick={() => handleRename(sheet.id)}\n                  title={isMobile ? sheet.name : \"Двойной клик для переименования\"}\n                >\n                  {sheet.name}\n                </span>\n              )}\n\n              {/* Отдельные кнопки действий */}\n              <div className={`flex items-center transition-all duration-200 ${\n                isMobile \n                  ? 'ml-2 opacity-90' \n                  : 'ml-2 opacity-0 group-hover:opacity-100 transform translate-x-2 group-hover:translate-x-0'\n              }`}>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className={cn(\n                    \"p-0 rounded-full transition-all duration-200 hover:scale-110 active:scale-95 touch-manipulation\",\n                    isMobile ? \"h-8 w-8\" : \"h-6 w-6\",\n                    activeSheetId === sheet.id\n                      ? \"hover:bg-white/20 active:bg-white/30 text-white/90 hover:text-white\"\n                      : \"hover:bg-blue-100 active:bg-blue-200 dark:hover:bg-blue-900/50 dark:active:bg-blue-800/50 text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300\"\n                  )}\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onSheetDuplicate(sheet.id);\n                  }}\n                  title=\"Дублировать лист\"\n                >\n                  <Copy className={isMobile ? \"h-4 w-4\" : \"h-3 w-3\"} />\n                </Button>\n                \n                {sheets.length > 1 && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className={cn(\n                      \"p-0 rounded-full transition-all duration-200 hover:scale-110 active:scale-95 touch-manipulation\",\n                      isMobile ? \"h-8 w-8 ml-1\" : \"h-6 w-6 ml-1\",\n                      activeSheetId === sheet.id\n                        ? \"hover:bg-red-500/20 active:bg-red-500/30 text-red-200 hover:text-white\"\n                        : \"hover:bg-red-100 active:bg-red-200 dark:hover:bg-red-900/50 dark:active:bg-red-800/50 text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300\"\n                    )}\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      onSheetDelete(sheet.id);\n                    }}\n                    title=\"Удалить лист\"\n                  >\n                    <X className={isMobile ? \"h-4 w-4\" : \"h-3 w-3\"} />\n                  </Button>\n                )}\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      {/* Кнопка прокрутки вправо - для мобильных переключает листы */}\n      {(canScrollRight || (isMobile && sheets.length > 1)) && (\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={isMobile ? switchToNextSheet : scrollRight}\n          className={`p-0 rounded-full bg-gradient-to-r from-blue-500/10 to-blue-600/10 hover:from-blue-500/20 hover:to-blue-600/20 active:from-blue-500/30 active:to-blue-600/30 dark:from-blue-400/10 dark:to-blue-500/10 dark:hover:from-blue-400/20 dark:hover:to-blue-500/20 dark:active:from-blue-400/30 dark:active:to-blue-500/30 transition-all duration-200 hover:scale-110 active:scale-95 relative z-10 touch-manipulation ${isMobile ? 'h-12 w-12 ml-2' : 'h-8 w-8 ml-2'}`}\n          disabled={isMobile ? (activeSheetId ? sheets.findIndex(s => s.id === activeSheetId) === sheets.length - 1 : true) : false}\n        >\n          <ChevronRight className={`text-blue-600 dark:text-blue-400 ${isMobile ? 'h-6 w-6' : 'h-4 w-4'}`} />\n        </Button>\n      )}\n\n      {/* Кнопка добавления нового листа */}\n      <Button\n        variant=\"ghost\"\n        size=\"sm\"\n        onClick={addNewSheet}\n        className={`p-0 rounded-full bg-gradient-to-br from-green-500/10 to-emerald-600/10 hover:from-green-500/20 hover:to-emerald-600/20 active:from-green-500/30 active:to-emerald-600/30 dark:from-green-400/10 dark:to-emerald-500/10 dark:hover:from-green-400/20 dark:hover:to-emerald-500/20 dark:active:from-green-400/30 dark:active:to-emerald-500/30 transition-all duration-300 hover:scale-110 active:scale-95 hover:shadow-lg hover:shadow-green-500/20 active:shadow-green-500/30 relative z-10 ring-2 ring-transparent hover:ring-green-300/30 dark:hover:ring-green-600/30 touch-manipulation ${isMobile ? 'h-11 w-11 ml-3' : 'h-9 w-9 ml-3'}`}\n        title=\"Добавить новый лист\"\n      >\n        <Plus className={`text-green-600 dark:text-green-400 drop-shadow-sm ${isMobile ? 'h-5 w-5' : 'h-5 w-5'}`} />\n      </Button>\n\n      {/* Диалог убран - создание листа теперь происходит одним кликом */}\n    </div>\n  );\n}","size_bytes":15498},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"update_next_nodes.js":{"content":"import { updateTemplatesWithFixedVariables } from './server/seed-templates.js';\n\nconsole.log('🔄 Обновляем поля nextNodeId в шаблоне...');\nupdateTemplatesWithFixedVariables()\n  .then(() => {\n    console.log('✅ Поля nextNodeId успешно обновлены');\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error('❌ Ошибка при обновлении nextNodeId:', error);\n    process.exit(1);\n  });","size_bytes":452},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"aiogram>=3.21.0\",\n    \"aiohttp>=3.12.13\",\n    \"asyncpg>=0.30.0\",\n    \"nanoid>=2.0.0\",\n    \"requests>=2.32.4\",\n]\n","size_bytes":259},"client/src/components/layout/custom-layout-editor.tsx":{"content":"import React, { useState, useCallback, useMemo, useRef } from 'react';\nimport { DndProvider, useDrag, useDrop } from 'react-dnd';\nimport { HTML5Backend } from 'react-dnd-html5-backend';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Switch } from '@/components/ui/switch';\nimport { Label } from '@/components/ui/label';\nimport { Slider } from '@/components/ui/slider';\nimport { \n  Layout, \n  Move, \n  RotateCcw, \n  Settings, \n  Grid,\n  ArrowUp,\n  ArrowDown,\n  ArrowLeft,\n  ArrowRight,\n  Navigation,\n  Sidebar,\n  Monitor,\n  Sliders,\n  Eye,\n  EyeOff,\n  GripVertical,\n  Maximize2,\n  Minimize2,\n  Save,\n  Undo2\n} from 'lucide-react';\n\nexport interface LayoutElement {\n  id: string;\n  type: 'header' | 'sidebar' | 'canvas' | 'properties';\n  name: string;\n  position: 'top' | 'bottom' | 'left' | 'right' | 'center';\n  size: number; // Размер в процентах\n  visible: boolean;\n  order: number; // Порядок отображения\n  content: React.ReactNode;\n}\n\nexport interface CustomLayoutConfig {\n  elements: LayoutElement[];\n  gridSize: number;\n  snapToGrid: boolean;\n  showGrid: boolean;\n  compactMode: boolean;\n  lastModified: Date;\n}\n\ninterface CustomLayoutEditorProps {\n  children: React.ReactNode;\n  headerContent: React.ReactNode;\n  sidebarContent: React.ReactNode;\n  canvasContent: React.ReactNode;\n  propertiesContent: React.ReactNode;\n  onLayoutChange?: (config: CustomLayoutConfig) => void;\n}\n\nconst DEFAULT_LAYOUT: CustomLayoutConfig = {\n  elements: [\n    {\n      id: 'header',\n      type: 'header',\n      name: 'Шапка',\n      position: 'top',\n      size: 8,\n      visible: true,\n      order: 1,\n      content: null\n    },\n    {\n      id: 'sidebar',\n      type: 'sidebar',\n      name: 'Боковая панель',\n      position: 'left',\n      size: 20,\n      visible: true,\n      order: 2,\n      content: null\n    },\n    {\n      id: 'canvas',\n      type: 'canvas',\n      name: 'Холст',\n      position: 'center',\n      size: 55,\n      visible: true,\n      order: 3,\n      content: null\n    },\n    {\n      id: 'properties',\n      type: 'properties',\n      name: 'Свойства',\n      position: 'right',\n      size: 25,\n      visible: true,\n      order: 4,\n      content: null\n    }\n  ],\n  gridSize: 10,\n  snapToGrid: true,\n  showGrid: false,\n  compactMode: false,\n  lastModified: new Date()\n};\n\nconst DRAG_TYPE = 'layout-element';\nconst DROP_ZONES = ['top', 'bottom', 'left', 'right', 'center'] as const;\n\n// Компонент для перетаскиваемого элемента\nconst DraggableElement: React.FC<{\n  element: LayoutElement;\n  isPreview?: boolean;\n  onMove?: (elementId: string, position: typeof DROP_ZONES[number]) => void;\n}> = ({ element, isPreview = false, onMove }) => {\n  const [{ isDragging }, drag] = useDrag({\n    type: DRAG_TYPE,\n    item: { id: element.id, type: element.type },\n    collect: (monitor) => ({\n      isDragging: monitor.isDragging(),\n    }),\n  });\n\n  const getIcon = () => {\n    switch (element.type) {\n      case 'header':\n        return <Navigation className=\"w-4 h-4\" />;\n      case 'sidebar':\n        return <Sidebar className=\"w-4 h-4\" />;\n      case 'canvas':\n        return <Monitor className=\"w-4 h-4\" />;\n      case 'properties':\n        return <Sliders className=\"w-4 h-4\" />;\n      default:\n        return <Layout className=\"w-4 h-4\" />;\n    }\n  };\n\n  const getPositionIcon = () => {\n    switch (element.position) {\n      case 'top':\n        return <ArrowUp className=\"w-3 h-3\" />;\n      case 'bottom':\n        return <ArrowDown className=\"w-3 h-3\" />;\n      case 'left':\n        return <ArrowLeft className=\"w-3 h-3\" />;\n      case 'right':\n        return <ArrowRight className=\"w-3 h-3\" />;\n      case 'center':\n        return <Grid className=\"w-3 h-3\" />;\n      default:\n        return null;\n    }\n  };\n\n  if (isPreview) {\n    return (\n      <div className=\"h-full w-full flex items-center justify-center bg-gray-100 dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-600\">\n        <div className=\"text-center\">\n          {getIcon()}\n          <p className=\"text-xs font-medium mt-1\">{element.name}</p>\n          <div className=\"flex items-center justify-center mt-1\">\n            {getPositionIcon()}\n            <span className=\"text-xs ml-1\">{element.size}%</span>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      ref={drag}\n      className={`\n        p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg cursor-move\n        shadow-sm hover:shadow-md transition-all duration-200\n        ${isDragging ? 'opacity-50 rotate-3 scale-105' : ''}\n        ${!element.visible ? 'opacity-50' : ''}\n      `}\n    >\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center space-x-2\">\n          <GripVertical className=\"w-4 h-4 text-gray-400\" />\n          {getIcon()}\n          <span className=\"text-sm font-medium\">{element.name}</span>\n        </div>\n        <div className=\"flex items-center space-x-2\">\n          {getPositionIcon()}\n          <Badge variant=\"secondary\" className=\"text-xs\">\n            {element.size}%\n          </Badge>\n        </div>\n      </div>\n    </div>\n  );\n};\n\n// Компонент для зоны сброса\nconst DropZone: React.FC<{\n  position: typeof DROP_ZONES[number];\n  onDrop: (elementId: string, position: typeof DROP_ZONES[number]) => void;\n  className?: string;\n}> = ({ position, onDrop, className = '' }) => {\n  const [{ isOver, canDrop }, drop] = useDrop({\n    accept: DRAG_TYPE,\n    drop: (item: { id: string; type: string }) => {\n      onDrop(item.id, position);\n    },\n    collect: (monitor) => ({\n      isOver: monitor.isOver(),\n      canDrop: monitor.canDrop(),\n    }),\n  });\n\n  const getPositionLabel = () => {\n    switch (position) {\n      case 'top':\n        return 'Сверху';\n      case 'bottom':\n        return 'Снизу';\n      case 'left':\n        return 'Слева';\n      case 'right':\n        return 'Справа';\n      case 'center':\n        return 'Центр';\n      default:\n        return position;\n    }\n  };\n\n  const getPositionIcon = () => {\n    switch (position) {\n      case 'top':\n        return <ArrowUp className=\"w-4 h-4\" />;\n      case 'bottom':\n        return <ArrowDown className=\"w-4 h-4\" />;\n      case 'left':\n        return <ArrowLeft className=\"w-4 h-4\" />;\n      case 'right':\n        return <ArrowRight className=\"w-4 h-4\" />;\n      case 'center':\n        return <Grid className=\"w-4 h-4\" />;\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <div\n      ref={drop}\n      className={`\n        min-h-[60px] border-2 border-dashed rounded-lg transition-all duration-200\n        flex items-center justify-center\n        ${isOver && canDrop \n          ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' \n          : 'border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500'\n        }\n        ${className}\n      `}\n    >\n      <div className=\"text-center\">\n        {getPositionIcon()}\n        <p className=\"text-xs font-medium mt-1\">{getPositionLabel()}</p>\n      </div>\n    </div>\n  );\n};\n\nexport const CustomLayoutEditor: React.FC<CustomLayoutEditorProps> = ({\n  children,\n  headerContent,\n  sidebarContent,\n  canvasContent,\n  propertiesContent,\n  onLayoutChange\n}) => {\n  const [isEditing, setIsEditing] = useState(false);\n  const [currentLayout, setCurrentLayout] = useState<CustomLayoutConfig>(() => ({\n    ...DEFAULT_LAYOUT,\n    elements: DEFAULT_LAYOUT.elements.map(element => ({\n      ...element,\n      content: element.type === 'header' ? headerContent :\n               element.type === 'sidebar' ? sidebarContent :\n               element.type === 'canvas' ? canvasContent :\n               element.type === 'properties' ? propertiesContent : null\n    }))\n  }));\n\n  const [originalLayout, setOriginalLayout] = useState<CustomLayoutConfig>(currentLayout);\n\n  const handleElementMove = useCallback((elementId: string, newPosition: typeof DROP_ZONES[number]) => {\n    setCurrentLayout(prev => ({\n      ...prev,\n      elements: prev.elements.map(element => \n        element.id === elementId \n          ? { ...element, position: newPosition }\n          : element\n      ),\n      lastModified: new Date()\n    }));\n  }, []);\n\n  const handleElementResize = useCallback((elementId: string, newSize: number) => {\n    setCurrentLayout(prev => ({\n      ...prev,\n      elements: prev.elements.map(element => \n        element.id === elementId \n          ? { ...element, size: newSize }\n          : element\n      ),\n      lastModified: new Date()\n    }));\n  }, []);\n\n  const handleElementVisibility = useCallback((elementId: string, visible: boolean) => {\n    setCurrentLayout(prev => ({\n      ...prev,\n      elements: prev.elements.map(element => \n        element.id === elementId \n          ? { ...element, visible }\n          : element\n      ),\n      lastModified: new Date()\n    }));\n  }, []);\n\n  const handleApplyLayout = useCallback(() => {\n    if (onLayoutChange) {\n      onLayoutChange(currentLayout);\n    }\n    setOriginalLayout(currentLayout);\n    setIsEditing(false);\n  }, [currentLayout, onLayoutChange]);\n\n  const handleCancelEdit = useCallback(() => {\n    setCurrentLayout(originalLayout);\n    setIsEditing(false);\n  }, [originalLayout]);\n\n  const handleResetLayout = useCallback(() => {\n    const resetLayout = {\n      ...DEFAULT_LAYOUT,\n      elements: DEFAULT_LAYOUT.elements.map(element => ({\n        ...element,\n        content: element.type === 'header' ? headerContent :\n                 element.type === 'sidebar' ? sidebarContent :\n                 element.type === 'canvas' ? canvasContent :\n                 element.type === 'properties' ? propertiesContent : null\n      }))\n    };\n    setCurrentLayout(resetLayout);\n  }, [headerContent, sidebarContent, canvasContent, propertiesContent]);\n\n  // Генерация стилей для текущего макета\n  const generateLayoutStyles = useMemo(() => {\n    const visibleElements = currentLayout.elements.filter(el => el.visible);\n    const headerEl = visibleElements.find(el => el.type === 'header');\n    const sidebarEl = visibleElements.find(el => el.type === 'sidebar');\n    const canvasEl = visibleElements.find(el => el.type === 'canvas');\n    const propertiesEl = visibleElements.find(el => el.type === 'properties');\n\n    // Создаем CSS Grid areas на основе позиций\n    const gridAreas = {\n      top: visibleElements.filter(el => el.position === 'top').map(el => el.id),\n      left: visibleElements.filter(el => el.position === 'left').map(el => el.id),\n      center: visibleElements.filter(el => el.position === 'center').map(el => el.id),\n      right: visibleElements.filter(el => el.position === 'right').map(el => el.id),\n      bottom: visibleElements.filter(el => el.position === 'bottom').map(el => el.id),\n    };\n\n    return {\n      container: {\n        display: 'grid',\n        height: '100vh',\n        gridTemplateAreas: `\n          \"${gridAreas.top.join(' ')}\"\n          \"${gridAreas.left.join(' ')} ${gridAreas.center.join(' ')} ${gridAreas.right.join(' ')}\"\n          \"${gridAreas.bottom.join(' ')}\"\n        `,\n        gridTemplateRows: `${headerEl?.position === 'top' ? headerEl.size + '%' : 'auto'} 1fr ${headerEl?.position === 'bottom' ? headerEl.size + '%' : 'auto'}`,\n        gridTemplateColumns: `${sidebarEl?.position === 'left' ? sidebarEl.size + '%' : 'auto'} 1fr ${propertiesEl?.position === 'right' ? propertiesEl.size + '%' : 'auto'}`,\n      },\n      elements: visibleElements.reduce((acc, el) => {\n        acc[el.id] = {\n          gridArea: el.id,\n          minHeight: el.type === 'header' ? '60px' : '200px',\n          overflow: 'hidden'\n        };\n        return acc;\n      }, {} as Record<string, React.CSSProperties>)\n    };\n  }, [currentLayout]);\n\n  const renderCurrentLayout = () => {\n    if (isEditing) return children;\n\n    const visibleElements = currentLayout.elements.filter(el => el.visible);\n    \n    return (\n      <div style={generateLayoutStyles.container}>\n        {visibleElements.map(element => (\n          <div\n            key={element.id}\n            style={generateLayoutStyles.elements[element.id]}\n            className=\"bg-background border border-border\"\n          >\n            {element.content}\n          </div>\n        ))}\n      </div>\n    );\n  };\n\n  return (\n    <DndProvider backend={HTML5Backend}>\n      <div className=\"h-screen flex flex-col\">\n        {/* Панель управления макетом */}\n        <div className=\"flex-shrink-0 bg-background border-b border-border p-2\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-2\">\n              <Button\n                variant={isEditing ? \"default\" : \"outline\"}\n                size=\"sm\"\n                onClick={() => setIsEditing(!isEditing)}\n              >\n                <Layout className=\"w-4 h-4 mr-2\" />\n                {isEditing ? 'Режим редактирования' : 'Настроить макет'}\n              </Button>\n              \n              {isEditing && (\n                <>\n                  <Button\n                    variant=\"default\"\n                    size=\"sm\"\n                    onClick={handleApplyLayout}\n                  >\n                    <Save className=\"w-4 h-4 mr-2\" />\n                    Применить\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={handleCancelEdit}\n                  >\n                    <Undo2 className=\"w-4 h-4 mr-2\" />\n                    Отменить\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={handleResetLayout}\n                  >\n                    <RotateCcw className=\"w-4 h-4 mr-2\" />\n                    Сбросить\n                  </Button>\n                </>\n              )}\n            </div>\n            \n            <div className=\"flex items-center space-x-2\">\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                Последнее изменение: {currentLayout.lastModified.toLocaleTimeString()}\n              </Badge>\n            </div>\n          </div>\n        </div>\n\n        {/* Основной контент */}\n        <div className=\"flex-1 overflow-hidden\">\n          {isEditing ? (\n            <div className=\"h-full flex\">\n              {/* Панель редактирования */}\n              <div className=\"w-80 bg-background border-r border-border flex flex-col\">\n                <div className=\"p-4 border-b border-border\">\n                  <h3 className=\"font-semibold mb-2\">Редактор макета</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Перетащите элементы в нужные позиции\n                  </p>\n                </div>\n                \n                <div className=\"flex-1 overflow-auto p-4\">\n                  {/* Список элементов */}\n                  <div className=\"space-y-3 mb-6\">\n                    <h4 className=\"text-sm font-medium\">Элементы интерфейса</h4>\n                    {currentLayout.elements.map(element => (\n                      <div key={element.id} className=\"space-y-2\">\n                        <DraggableElement\n                          element={element}\n                          onMove={handleElementMove}\n                        />\n                        \n                        {/* Настройки элемента */}\n                        <div className=\"pl-4 space-y-2\">\n                          <div className=\"flex items-center space-x-2\">\n                            <Switch\n                              id={`visible-${element.id}`}\n                              checked={element.visible}\n                              onCheckedChange={(checked) => handleElementVisibility(element.id, checked)}\n                            />\n                            <Label htmlFor={`visible-${element.id}`} className=\"text-xs\">\n                              Видимый\n                            </Label>\n                          </div>\n                          \n                          <div className=\"space-y-1\">\n                            <Label className=\"text-xs\">Размер: {element.size}%</Label>\n                            <Slider\n                              value={[element.size]}\n                              onValueChange={(value) => handleElementResize(element.id, value[0])}\n                              max={50}\n                              min={10}\n                              step={5}\n                              className=\"w-full\"\n                            />\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                  \n                  {/* Зоны сброса */}\n                  <div className=\"space-y-3\">\n                    <h4 className=\"text-sm font-medium\">Зоны размещения</h4>\n                    <div className=\"grid grid-cols-1 gap-2\">\n                      {DROP_ZONES.map(zone => (\n                        <DropZone\n                          key={zone}\n                          position={zone}\n                          onDrop={handleElementMove}\n                        />\n                      ))}\n                    </div>\n                  </div>\n                </div>\n              </div>\n              \n              {/* Предварительный просмотр */}\n              <div className=\"flex-1 bg-gray-50 dark:bg-gray-900 p-4\">\n                <div className=\"h-full border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg relative\">\n                  <div className=\"absolute top-2 left-2 bg-white dark:bg-gray-800 px-2 py-1 rounded text-xs font-medium\">\n                    Предварительный просмотр\n                  </div>\n                  <div className=\"h-full p-6 pt-10\">\n                    <div style={generateLayoutStyles.container}>\n                      {currentLayout.elements.filter(el => el.visible).map(element => (\n                        <div\n                          key={element.id}\n                          style={generateLayoutStyles.elements[element.id]}\n                          className=\"border border-gray-200 dark:border-gray-700 rounded\"\n                        >\n                          <DraggableElement element={element} isPreview />\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          ) : (\n            renderCurrentLayout()\n          )}\n        </div>\n      </div>\n    </DndProvider>\n  );\n};\n\nexport default CustomLayoutEditor;","size_bytes":19264},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }","size_bytes":1882},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    let errorData;\n    try {\n      // Пытаемся распарсить JSON ответ с ошибкой\n      errorData = await res.json();\n    } catch (parseError) {\n      // Если не удалось распарсить JSON, используем statusText\n      throw new Error(`${res.status}: ${res.statusText}`);\n    }\n    \n    // Создаем ошибку с сохранением всех свойств (включая requiresClientApi)\n    const error = new Error(errorData.message || `${res.status}: ${res.statusText}`);\n    // Добавляем все свойства из ответа к ошибке\n    Object.assign(error, errorData);\n    throw error;\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<any> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return await res.json();\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey[0] as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: 10 * 60 * 1000, // 10 минут кеш для всех данных (увеличено для лучшей производительности)\n      gcTime: 30 * 60 * 1000, // 30 минут в garbage collection\n      retry: 1, // Одна попытка пересылки при ошибке\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":2234},"client/src/components/editor/rich-text-editor.tsx":{"content":"import { useState, useRef, useEffect, useCallback } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Label } from '@/components/ui/label';\nimport { Separator } from '@/components/ui/separator';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Switch } from '@/components/ui/switch';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { \n  Bold, \n  Italic, \n  Underline, \n  Strikethrough, \n  Code, \n  Link, \n  Type,\n  Eye,\n  Copy,\n  Sparkles,\n  Palette,\n  List,\n  ListOrdered,\n  Quote,\n  Hash,\n  Smile,\n  RotateCcw,\n  RotateCw,\n  WrapText,\n  AlignLeft,\n  AlignCenter,\n  AlignRight,\n  Font,\n  Search,\n  Save,\n  Download,\n  Upload,\n  Settings,\n  Zap,\n  Star,\n  Heart,\n  CheckSquare,\n  Code2,\n  Maximize,\n  Minimize,\n  AlertTriangle,\n  Phone\n} from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface RichTextEditorProps {\n  value: string;\n  onChange: (value: string) => void;\n  placeholder?: string;\n  enableMarkdown?: boolean;\n  onMarkdownToggle?: (enabled: boolean) => void;\n  enablePresets?: boolean;\n  enableAdvancedFeatures?: boolean;\n}\n\nexport function RichTextEditor({\n  value,\n  onChange,\n  placeholder = \"Введите текст сообщения...\",\n  enableMarkdown = false,\n  onMarkdownToggle,\n  enablePresets = true,\n  enableAdvancedFeatures = true\n}: RichTextEditorProps) {\n  const [activeTab, setActiveTab] = useState<'edit' | 'preview'>('edit');\n  const [isExpanded, setIsExpanded] = useState(false);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [undoStack, setUndoStack] = useState<string[]>([]);\n  const [redoStack, setRedoStack] = useState<string[]>([]);\n  const [savedTemplates, setSavedTemplates] = useState<{name: string, content: string}[]>([]);\n  const [wordCount, setWordCount] = useState(0);\n  const [charCount, setCharCount] = useState(0);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const { toast } = useToast();\n\n  // Update counts when value changes\n  useEffect(() => {\n    setWordCount(value.trim().split(/\\s+/).filter(word => word.length > 0).length);\n    setCharCount(value.length);\n  }, [value]);\n\n  // Save to undo stack\n  const saveToUndoStack = useCallback(() => {\n    setUndoStack(prev => [...prev.slice(-19), value]);\n    setRedoStack([]);\n  }, [value]);\n\n  // Функция для рендеринга живого предпросмотра с реальными эффектами\n  const renderLivePreview = (text: string) => {\n    let processedText = text;\n    \n    if (enableMarkdown) {\n      // Обработка Markdown форматирования\n      processedText = processedText\n        .replace(/\\*\\*(.*?)\\*\\*/g, '<strong class=\"live-preview-bold\">$1</strong>') // Жирный\n        .replace(/_(.*?)_/g, '<em class=\"live-preview-italic\">$1</em>') // Курсив\n        .replace(/__(.*?)__/g, '<u class=\"live-preview-underline\">$1</u>') // Подчеркнутый\n        .replace(/~(.*?)~/g, '<s class=\"live-preview-strikethrough\">$1</s>') // Зачеркнутый\n        .replace(/`(.*?)`/g, '<code class=\"live-preview-code\">$1</code>') // Код\n        .replace(/```\\n(.*?)\\n```/gs, '<pre class=\"live-preview-pre\"><code>$1</code></pre>') // Блок кода\n        .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href=\"$2\" class=\"live-preview-link\" target=\"_blank\" rel=\"noopener noreferrer\">$1</a>') // Ссылка\n        .replace(/^> (.*)$/gm, '<blockquote class=\"live-preview-quote\">$1</blockquote>') // Цитата\n        .replace(/^# (.*)$/gm, '<h3 class=\"live-preview-heading\">$1</h3>') // Заголовок\n        .replace(/^## (.*)$/gm, '<h4 class=\"live-preview-heading-2\">$1</h4>') // Заголовок 2\n        .replace(/^### (.*)$/gm, '<h5 class=\"live-preview-heading-3\">$1</h5>') // Заголовок 3\n        .replace(/^\\* (.*)$/gm, '<li class=\"live-preview-list-item\">$1</li>') // Список\n        .replace(/^\\d+\\. (.*)$/gm, '<li class=\"live-preview-list-item-ordered\">$1</li>') // Нумерованный список\n        .replace(/---/g, '<hr class=\"live-preview-separator\">') // Разделитель\n        .replace(/\\n/g, '<br>'); // Переносы строк\n    } else {\n      // Обработка HTML форматирования\n      processedText = processedText\n        .replace(/<b>(.*?)<\\/b>/g, '<strong class=\"live-preview-bold\">$1</strong>')\n        .replace(/<i>(.*?)<\\/i>/g, '<em class=\"live-preview-italic\">$1</em>')\n        .replace(/<u>(.*?)<\\/u>/g, '<u class=\"live-preview-underline\">$1</u>')\n        .replace(/<s>(.*?)<\\/s>/g, '<s class=\"live-preview-strikethrough\">$1</s>')\n        .replace(/<code>(.*?)<\\/code>/g, '<code class=\"live-preview-code\">$1</code>')\n        .replace(/<pre><code>(.*?)<\\/code><\\/pre>/gs, '<pre class=\"live-preview-pre\"><code>$1</code></pre>')\n        .replace(/<a href=\"([^\"]+)\">(.*?)<\\/a>/g, '<a href=\"$1\" class=\"live-preview-link\" target=\"_blank\" rel=\"noopener noreferrer\">$2</a>')\n        .replace(/<blockquote>(.*?)<\\/blockquote>/g, '<blockquote class=\"live-preview-quote\">$1</blockquote>')\n        .replace(/<h3>(.*?)<\\/h3>/g, '<h3 class=\"live-preview-heading\">$1</h3>')\n        .replace(/<h4>(.*?)<\\/h4>/g, '<h4 class=\"live-preview-heading-2\">$1</h4>')\n        .replace(/<h5>(.*?)<\\/h5>/g, '<h5 class=\"live-preview-heading-3\">$1</h5>')\n        .replace(/<hr>/g, '<hr class=\"live-preview-separator\">')\n        .replace(/\\n/g, '<br>'); // Переносы строк\n    }\n    \n    return processedText;\n  };\n\n  const formatOptions = [\n    { \n      icon: Bold, \n      name: 'Жирный', \n      markdown: '**текст**', \n      html: '<b>текст</b>',\n      description: 'Выделяет текст жирным шрифтом',\n      shortcut: 'Ctrl+B',\n      category: 'basic'\n    },\n    { \n      icon: Italic, \n      name: 'Курсив', \n      markdown: '_текст_', \n      html: '<i>текст</i>',\n      description: 'Выделяет текст курсивом',\n      shortcut: 'Ctrl+I',\n      category: 'basic'\n    },\n    { \n      icon: Underline, \n      name: 'Подчеркнутый', \n      markdown: '__текст__', \n      html: '<u>текст</u>',\n      description: 'Подчеркивает текст',\n      shortcut: 'Ctrl+U',\n      category: 'basic'\n    },\n    { \n      icon: Strikethrough, \n      name: 'Зачеркнутый', \n      markdown: '~текст~', \n      html: '<s>текст</s>',\n      description: 'Зачеркивает текст',\n      shortcut: 'Ctrl+Shift+X',\n      category: 'basic'\n    },\n    { \n      icon: Code, \n      name: 'Код', \n      markdown: '`код`', \n      html: '<code>код</code>',\n      description: 'Выделяет код моноширинным шрифтом',\n      shortcut: 'Ctrl+E',\n      category: 'basic'\n    },\n    { \n      icon: Link, \n      name: 'Ссылка', \n      markdown: '[текст](url)', \n      html: '<a href=\"url\">текст</a>',\n      description: 'Создает кликабельную ссылку',\n      shortcut: 'Ctrl+K',\n      category: 'basic'\n    },\n    { \n      icon: Code2, \n      name: 'Блок кода', \n      markdown: '```\\nкод\\n```', \n      html: '<pre><code>код</code></pre>',\n      description: 'Создает блок кода',\n      shortcut: 'Ctrl+Shift+C',\n      category: 'advanced'\n    },\n    { \n      icon: Quote, \n      name: 'Цитата', \n      markdown: '> цитата', \n      html: '<blockquote>цитата</blockquote>',\n      description: 'Создает блок цитаты',\n      shortcut: 'Ctrl+Shift+Q',\n      category: 'advanced'\n    },\n    { \n      icon: List, \n      name: 'Список', \n      markdown: '• пункт\\n• пункт\\n• пункт', \n      html: '<ul><li>пункт</li><li>пункт</li><li>пункт</li></ul>',\n      description: 'Создает маркированный список',\n      shortcut: 'Ctrl+Shift+L',\n      category: 'advanced'\n    },\n    { \n      icon: ListOrdered, \n      name: 'Нумерованный список', \n      markdown: '1. пункт\\n2. пункт\\n3. пункт', \n      html: '<ol><li>пункт</li><li>пункт</li><li>пункт</li></ol>',\n      description: 'Создает нумерованный список',\n      shortcut: 'Ctrl+Shift+O',\n      category: 'advanced'\n    },\n    { \n      icon: Hash, \n      name: 'Заголовок', \n      markdown: '# Заголовок', \n      html: '<h3>Заголовок</h3>',\n      description: 'Создает заголовок',\n      shortcut: 'Ctrl+H',\n      category: 'advanced'\n    }\n  ];\n\n  const messagePresets = [\n    {\n      name: 'Приветствие',\n      icon: Smile,\n      content: '👋 Добро пожаловать!\\n\\nРады видеть вас в нашем боте. Как дела?'\n    },\n    {\n      name: 'Благодарность',\n      icon: Heart,\n      content: '❤️ Спасибо за обращение!\\n\\nВаше сообщение важно для нас.'\n    },\n    {\n      name: 'Контакты',\n      icon: Phone,\n      content: '📞 **Наши контакты:**\\n\\n• Телефон: +7 (999) 123-45-67\\n• Email: support@example.com\\n• Сайт: https://example.com'\n    },\n    {\n      name: 'Меню',\n      icon: List,\n      content: '📋 **Главное меню:**\\n\\n1. Каталог товаров\\n2. Мои заказы\\n3. Поддержка\\n4. О компании'\n    },\n    {\n      name: 'Инструкция',\n      icon: CheckSquare,\n      content: '📝 **Пошаговая инструкция:**\\n\\n✅ Шаг 1: Выберите категорию\\n✅ Шаг 2: Укажите параметры\\n✅ Шаг 3: Подтвердите заказ'\n    },\n    {\n      name: 'Предупреждение',\n      icon: AlertTriangle,\n      content: '⚠️ **Внимание!**\\n\\nВажная информация, которую необходимо учесть.'\n    }\n  ];\n\n  // Undo/Redo functionality\n  const undo = useCallback(() => {\n    if (undoStack.length > 0) {\n      const previousValue = undoStack[undoStack.length - 1];\n      setRedoStack(prev => [value, ...prev.slice(0, 19)]);\n      setUndoStack(prev => prev.slice(0, -1));\n      onChange(previousValue);\n      toast({\n        title: \"Отменено\",\n        description: \"Последнее действие отменено\"\n      });\n    }\n  }, [undoStack, value, onChange, toast]);\n\n  const redo = useCallback(() => {\n    if (redoStack.length > 0) {\n      const nextValue = redoStack[0];\n      setUndoStack(prev => [...prev.slice(-19), value]);\n      setRedoStack(prev => prev.slice(1));\n      onChange(nextValue);\n      toast({\n        title: \"Повторено\",\n        description: \"Действие восстановлено\"\n      });\n    }\n  }, [redoStack, value, onChange, toast]);\n\n  // Template management\n  const saveTemplate = useCallback(() => {\n    const name = prompt('Введите название шаблона:');\n    if (name && value.trim()) {\n      setSavedTemplates(prev => [...prev, { name, content: value }]);\n      toast({\n        title: \"Шаблон сохранен\",\n        description: `Шаблон \"${name}\" добавлен в библиотеку`\n      });\n    }\n  }, [value, toast]);\n\n  const loadTemplate = useCallback((template: { name: string, content: string }) => {\n    saveToUndoStack();\n    onChange(template.content);\n    toast({\n      title: \"Шаблон загружен\",\n      description: `Загружен шаблон \"${template.name}\"`\n    });\n  }, [onChange, saveToUndoStack, toast]);\n\n  // Insert preset message\n  const insertPreset = (preset: typeof messagePresets[0]) => {\n    saveToUndoStack();\n    const newContent = value ? value + '\\n\\n' + preset.content : preset.content;\n    onChange(newContent);\n    toast({\n      title: \"Шаблон добавлен\",\n      description: `Добавлен шаблон \"${preset.name}\"`\n    });\n  };\n\n  // Keyboard shortcuts - work like in Telegram (no selection required)\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.ctrlKey || e.metaKey) {\n        const textarea = textareaRef.current;\n        if (!textarea) return;\n        \n        const format = formatOptions.find(f => {\n          const shortcut = f.shortcut?.toLowerCase();\n          if (!shortcut) return false;\n          \n          if (shortcut.includes('shift') && !e.shiftKey) return false;\n          if (!shortcut.includes('shift') && e.shiftKey) return false;\n          \n          const key = shortcut.split('+').pop();\n          return e.key.toLowerCase() === key;\n        });\n        \n        if (format) {\n          e.preventDefault();\n          insertFormatting(format);\n        } else if (e.key === 'z' && !e.shiftKey) {\n          e.preventDefault();\n          undo();\n        } else if ((e.key === 'y') || (e.key === 'z' && e.shiftKey)) {\n          e.preventDefault();\n          redo();\n        }\n      }\n    };\n\n    const textarea = textareaRef.current;\n    if (textarea) {\n      textarea.addEventListener('keydown', handleKeyDown);\n      return () => textarea.removeEventListener('keydown', handleKeyDown);\n    }\n  }, [formatOptions, undo, redo, toast]);\n\n  const insertFormatting = (format: typeof formatOptions[0]) => {\n    const textarea = textareaRef.current;\n    if (!textarea) return;\n\n    saveToUndoStack();\n    \n    const start = textarea.selectionStart;\n    const end = textarea.selectionEnd;\n    const selectedText = value.substring(start, end);\n    \n    const hasSelection = start !== end;\n    \n    let formatPrefix = '';\n    let formatSuffix = '';\n    let cursorOffset = 0;\n    \n    // Определяем символы форматирования в зависимости от режима\n    if (enableMarkdown) {\n      switch (format.name) {\n        case 'Жирный':\n          formatPrefix = '**';\n          formatSuffix = '**';\n          break;\n        case 'Курсив':\n          formatPrefix = '_';\n          formatSuffix = '_';\n          break;\n        case 'Подчеркнутый':\n          formatPrefix = '__';\n          formatSuffix = '__';\n          break;\n        case 'Зачеркнутый':\n          formatPrefix = '~';\n          formatSuffix = '~';\n          break;\n        case 'Код':\n          formatPrefix = '`';\n          formatSuffix = '`';\n          break;\n        case 'Блок кода':\n          formatPrefix = '```\\n';\n          formatSuffix = '\\n```';\n          break;\n        case 'Ссылка':\n          if (hasSelection) {\n            const url = prompt('Введите URL:') || 'https://example.com';\n            formatPrefix = '[';\n            formatSuffix = `](${url})`;\n          } else {\n            formatPrefix = '[';\n            formatSuffix = '](https://example.com)';\n            cursorOffset = 1; // Поставить курсор после '['\n          }\n          break;\n        case 'Цитата':\n          formatPrefix = '> ';\n          formatSuffix = '';\n          break;\n        case 'Заголовок':\n          formatPrefix = '# ';\n          formatSuffix = '';\n          break;\n        default:\n          return;\n      }\n    } else {\n      switch (format.name) {\n        case 'Жирный':\n          formatPrefix = '<b>';\n          formatSuffix = '</b>';\n          break;\n        case 'Курсив':\n          formatPrefix = '<i>';\n          formatSuffix = '</i>';\n          break;\n        case 'Подчеркнутый':\n          formatPrefix = '<u>';\n          formatSuffix = '</u>';\n          break;\n        case 'Зачеркнутый':\n          formatPrefix = '<s>';\n          formatSuffix = '</s>';\n          break;\n        case 'Код':\n          formatPrefix = '<code>';\n          formatSuffix = '</code>';\n          break;\n        case 'Блок кода':\n          formatPrefix = '<pre><code>';\n          formatSuffix = '</code></pre>';\n          break;\n        case 'Ссылка':\n          if (hasSelection) {\n            const url = prompt('Введите URL:') || 'https://example.com';\n            formatPrefix = `<a href=\"${url}\">`;\n            formatSuffix = '</a>';\n          } else {\n            formatPrefix = '<a href=\"https://example.com\">';\n            formatSuffix = '</a>';\n            cursorOffset = formatPrefix.length; // Поставить курсор после открывающего тега\n          }\n          break;\n        case 'Цитата':\n          formatPrefix = '<blockquote>';\n          formatSuffix = '</blockquote>';\n          break;\n        case 'Заголовок':\n          formatPrefix = '<h3>';\n          formatSuffix = '</h3>';\n          break;\n        default:\n          return;\n      }\n    }\n    \n    let newText = '';\n    let newCursorPosition = start;\n    let isToggleOff = false;\n    \n    if (hasSelection) {\n      // Проверяем, уже ли применено форматирование к выделенному тексту\n      const beforeSelection = value.substring(Math.max(0, start - formatPrefix.length), start);\n      const afterSelection = value.substring(end, Math.min(value.length, end + formatSuffix.length));\n      \n      // Для цитат и заголовков проверяем только начало строки\n      if (format.name === 'Цитата' || format.name === 'Заголовок') {\n        const lineStart = value.lastIndexOf('\\n', start - 1) + 1;\n        const linePrefix = value.substring(lineStart, start);\n        \n        if (linePrefix === formatPrefix) {\n          // Убираем форматирование\n          newText = selectedText;\n          newCursorPosition = start - formatPrefix.length;\n          isToggleOff = true;\n          \n          // Обновляем весь текст, убирая префикс\n          const newValue = value.substring(0, lineStart) + value.substring(start) + value.substring(end);\n          onChange(newValue);\n        } else {\n          // Добавляем форматирование\n          newText = formatPrefix + selectedText;\n          newCursorPosition = start + newText.length;\n          \n          const newValue = value.substring(0, lineStart) + formatPrefix + value.substring(lineStart);\n          onChange(newValue);\n        }\n      } else {\n        // Для обычного форматирования проверяем окружение\n        if (beforeSelection === formatPrefix && afterSelection === formatSuffix) {\n          // Убираем форматирование\n          newText = selectedText;\n          newCursorPosition = start - formatPrefix.length;\n          isToggleOff = true;\n          \n          const newValue = value.substring(0, start - formatPrefix.length) + selectedText + value.substring(end + formatSuffix.length);\n          onChange(newValue);\n        } else {\n          // Добавляем форматирование\n          newText = formatPrefix + selectedText + formatSuffix;\n          newCursorPosition = start + newText.length;\n          \n          const newValue = value.substring(0, start) + newText + value.substring(end);\n          onChange(newValue);\n        }\n      }\n    } else {\n      // Если текст не выделен - вставляем символы форматирования как в Telegram\n      newText = formatPrefix + formatSuffix;\n      newCursorPosition = start + formatPrefix.length + cursorOffset;\n      \n      const newValue = value.substring(0, start) + newText + value.substring(end);\n      onChange(newValue);\n    }\n    \n    // Устанавливаем курсор в правильную позицию\n    setTimeout(() => {\n      if (hasSelection && !isToggleOff) {\n        // Если добавляем форматирование, выделяем отформатированный текст\n        if (format.name === 'Цитата' || format.name === 'Заголовок') {\n          textarea.setSelectionRange(newCursorPosition - selectedText.length, newCursorPosition);\n        } else {\n          textarea.setSelectionRange(start + formatPrefix.length, start + formatPrefix.length + selectedText.length);\n        }\n      } else {\n        // Обычное позиционирование курсора\n        textarea.setSelectionRange(newCursorPosition, newCursorPosition);\n      }\n      textarea.focus();\n    }, 0);\n\n    toast({\n      title: isToggleOff ? \"Форматирование отменено\" : \"Форматирование применено\",\n      description: hasSelection \n        ? (isToggleOff ? `Убрано форматирование \"${format.name}\" с выделенного текста` : `Применено к выделенному тексту: ${format.name}`)\n        : `Добавлены символы: ${format.name}`,\n      variant: \"default\"\n    });\n  };\n\n  const copyToClipboard = async (text: string) => {\n    try {\n      await navigator.clipboard.writeText(text);\n      toast({\n        title: \"Скопировано!\",\n        description: \"Форматирование скопировано в буфер обмена\"\n      });\n    } catch (err) {\n      console.error('Failed to copy text: ', err);\n    }\n  };\n\n  const renderPreview = () => {\n    if (!enableMarkdown) {\n      // For HTML mode, just show the raw text with HTML tags\n      return (\n        <div className=\"p-3 bg-muted/50 rounded-lg border min-h-[100px] whitespace-pre-wrap\">\n          <div className=\"text-sm text-muted-foreground mb-2\">HTML предпросмотр:</div>\n          <div dangerouslySetInnerHTML={{ __html: value }} />\n        </div>\n      );\n    }\n    \n    // For Markdown mode, convert common markdown to HTML for preview\n    let htmlContent = value\n      .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\n      .replace(/_(.*?)_/g, '<em>$1</em>')\n      .replace(/__(.*?)__/g, '<u>$1</u>')\n      .replace(/~(.*?)~/g, '<s>$1</s>')\n      .replace(/`(.*?)`/g, '<code>$1</code>')\n      .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href=\"$2\">$1</a>')\n      .replace(/\\n/g, '<br>');\n    \n    return (\n      <div className=\"p-3 bg-muted/50 rounded-lg border min-h-[100px]\">\n        <div className=\"text-sm text-muted-foreground mb-2\">Предпросмотр:</div>\n        <div dangerouslySetInnerHTML={{ __html: htmlContent }} />\n      </div>\n    );\n  };\n\n  // Filter formats based on search\n  const filteredFormats = formatOptions.filter(format => \n    searchTerm === '' || format.name.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const basicFormats = filteredFormats.filter(f => f.category === 'basic');\n  const advancedFormats = filteredFormats.filter(f => f.category === 'advanced');\n\n  return (\n    <Card className={`w-full transition-all duration-300 ${isExpanded ? 'col-span-2' : ''}`}>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Sparkles className=\"w-4 h-4 text-blue-500\" />\n            Продвинутый редактор форматирования\n            {charCount > 0 && (\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                {wordCount} слов • {charCount} символов\n              </Badge>\n            )}\n          </CardTitle>\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setIsExpanded(!isExpanded)}\n              className=\"h-8 w-8 p-0\"\n              title={isExpanded ? \"Свернуть\" : \"Развернуть\"}\n            >\n              {isExpanded ? <Minimize className=\"w-4 h-4\" /> : <Maximize className=\"w-4 h-4\" />}\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => onMarkdownToggle?.(!enableMarkdown)}\n              className=\"text-xs\"\n            >\n              {enableMarkdown ? 'Markdown' : 'HTML'}\n            </Button>\n          </div>\n        </div>\n\n        {/* Enhanced toolbar with undo/redo and actions */}\n        <div className=\"flex items-center gap-2 pt-2\">\n          <div className=\"flex items-center gap-1\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={undo}\n              disabled={undoStack.length === 0}\n              className=\"h-8 w-8 p-0\"\n              title=\"Отменить (Ctrl+Z)\"\n            >\n              <RotateCcw className=\"w-3 h-3\" />\n            </Button>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={redo}\n              disabled={redoStack.length === 0}\n              className=\"h-8 w-8 p-0\"\n              title=\"Повторить (Ctrl+Y)\"\n            >\n              <RotateCw className=\"w-3 h-3\" />\n            </Button>\n          </div>\n          \n          <Separator orientation=\"vertical\" className=\"h-6\" />\n          \n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={saveTemplate}\n            disabled={!value.trim()}\n            className=\"h-8 px-2 text-xs\"\n            title=\"Сохранить как шаблон\"\n          >\n            <Save className=\"w-3 h-3 mr-1\" />\n            Сохранить\n          </Button>\n          \n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => copyToClipboard(value)}\n            disabled={!value.trim()}\n            className=\"h-8 px-2 text-xs\"\n            title=\"Копировать весь текст\"\n          >\n            <Copy className=\"w-3 h-3 mr-1\" />\n            Копировать\n          </Button>\n\n          {enableAdvancedFeatures && (\n            <div className=\"flex items-center gap-1 ml-auto\">\n              <Input\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                placeholder=\"Поиск...\"\n                className=\"h-8 w-24 text-xs\"\n              />\n              <Search className=\"w-3 h-3 text-muted-foreground -ml-6\" />\n            </div>\n          )}\n        </div>\n      </CardHeader>\n      \n      <CardContent className=\"space-y-4\">\n        {/* Message Presets */}\n        {enablePresets && (\n          <div className=\"space-y-3\">\n            <Label className=\"text-xs font-medium flex items-center gap-2\">\n              <Sparkles className=\"w-3 h-3\" />\n              Готовые шаблоны сообщений\n            </Label>\n            <div className=\"grid grid-cols-2 gap-2\">\n              {messagePresets.map((preset) => (\n                <Button\n                  key={preset.name}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => insertPreset(preset)}\n                  className=\"justify-start gap-2 h-9 text-xs\"\n                  title={preset.content.slice(0, 50) + '...'}\n                >\n                  <preset.icon className=\"w-3 h-3 text-blue-500\" />\n                  {preset.name}\n                </Button>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Basic Formatting Toolbar */}\n        <div className=\"space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <Label className=\"text-xs font-medium flex items-center gap-2\">\n              <Type className=\"w-3 h-3\" />\n              Базовое форматирование\n            </Label>\n            <Badge variant=\"secondary\" className=\"text-xs\">\n              📝 Выделите → Нажмите кнопку\n            </Badge>\n          </div>\n          \n          <div className=\"bg-blue-50 dark:bg-blue-950/30 rounded-lg p-2 mb-3\">\n            <div className=\"text-xs text-blue-700 dark:text-blue-300 flex items-center gap-2\">\n              <span>💡</span>\n              <span>Как в Telegram: сначала выделите текст, затем выберите форматирование</span>\n            </div>\n          </div>\n          \n          <div className=\"grid grid-cols-3 gap-2\">\n            {basicFormats.map((format) => (\n              <Button\n                key={format.name}\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => insertFormatting(format)}\n                className=\"justify-start gap-2 h-8 text-xs hover:bg-blue-50 dark:hover:bg-blue-950/50\"\n                title={`Выделите текст и нажмите для применения (${format.shortcut})`}\n              >\n                <format.icon className=\"w-3 h-3\" />\n                {format.name}\n              </Button>\n            ))}\n          </div>\n        </div>\n\n        {/* Advanced Formatting */}\n        {enableAdvancedFeatures && advancedFormats.length > 0 && (\n          <div className=\"space-y-3\">\n            <Label className=\"text-xs font-medium flex items-center gap-2\">\n              <Settings className=\"w-3 h-3\" />\n              Продвинутое форматирование\n            </Label>\n            <div className=\"grid grid-cols-2 gap-2\">\n              {advancedFormats.map((format) => (\n                <Button\n                  key={format.name}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => insertFormatting(format)}\n                  className=\"justify-start gap-2 h-8 text-xs\"\n                  title={`${format.description} (${format.shortcut})`}\n                >\n                  <format.icon className=\"w-3 h-3\" />\n                  {format.name}\n                </Button>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Saved Templates */}\n        {savedTemplates.length > 0 && (\n          <div className=\"space-y-3\">\n            <Label className=\"text-xs font-medium flex items-center gap-2\">\n              <Star className=\"w-3 h-3\" />\n              Сохраненные шаблоны\n            </Label>\n            <ScrollArea className=\"h-20\">\n              <div className=\"space-y-1\">\n                {savedTemplates.map((template, index) => (\n                  <div key={index} className=\"flex items-center gap-2\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => loadTemplate(template)}\n                      className=\"flex-1 justify-start text-xs h-7\"\n                    >\n                      {template.name}\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => setSavedTemplates(prev => prev.filter((_, i) => i !== index))}\n                      className=\"h-7 w-7 p-0 text-red-500\"\n                    >\n                      ×\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            </ScrollArea>\n          </div>\n        )}\n\n        <Separator />\n\n        {/* Enhanced Text Editor with Tabs */}\n        <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as 'edit' | 'preview')}>\n          <TabsList className=\"grid w-full grid-cols-2\">\n            <TabsTrigger value=\"edit\" className=\"flex items-center gap-2\">\n              <Type className=\"w-3 h-3\" />\n              Редактор {charCount > 0 && <Badge variant=\"outline\" className=\"text-xs\">{charCount}</Badge>}\n            </TabsTrigger>\n            <TabsTrigger value=\"preview\" className=\"flex items-center gap-2\">\n              <Eye className=\"w-3 h-3\" />\n              Предпросмотр\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"edit\" className=\"space-y-3\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n              {/* Редактор */}\n              <div className=\"relative\">\n                <Label className=\"text-xs font-medium text-muted-foreground mb-2 block\">\n                  Редактор кода\n                </Label>\n                <Textarea\n                  ref={textareaRef}\n                  value={value}\n                  onChange={(e) => {\n                    saveToUndoStack();\n                    onChange(e.target.value);\n                  }}\n                  placeholder=\"Введите текст сообщения...\"\n                  className={`min-h-[120px] resize-none transition-all duration-200 font-mono text-sm ${\n                    isExpanded ? 'min-h-[200px]' : ''\n                  }`}\n                  rows={isExpanded ? 10 : 6}\n                  onSelect={(e) => {\n                    // Показываем интерактивную подсказку при выделении как в Telegram\n                    const textarea = e.target as HTMLTextAreaElement;\n                    if (textarea && textarea.selectionStart !== textarea.selectionEnd) {\n                      const selectedText = value.substring(textarea.selectionStart, textarea.selectionEnd);\n                      if (selectedText.length > 0 && selectedText.length <= 200) {\n                        // Debounce для избежания спама уведомлений\n                        setTimeout(() => {\n                          if (textarea.selectionStart !== textarea.selectionEnd) {\n                            const currentSelection = value.substring(textarea.selectionStart, textarea.selectionEnd);\n                            if (currentSelection === selectedText) {\n                              toast({\n                                title: `✅ Выделено: \"${selectedText.slice(0, 20)}${selectedText.length > 20 ? '...' : ''}\"`,\n                                description: \"Теперь нажмите B/I/U или выберите форматирование из панели выше\",\n                                duration: 3000\n                              });\n                            }\n                          }\n                        }, 500);\n                      }\n                    }\n                  }}\n                />\n                \n                {/* Character count overlay */}\n                {charCount > 0 && (\n                  <div className=\"absolute bottom-2 right-2 text-xs text-muted-foreground bg-background/80 px-2 py-1 rounded\">\n                    {charCount}/4096\n                  </div>\n                )}\n                \n                {/* Selection helper overlay - показываем только если нет текста */}\n                {!value && (\n                  <div className=\"absolute top-2 right-2 text-xs text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-950/50 px-2 py-1 rounded opacity-70\">\n                    💡 Выделите текст для форматирования\n                  </div>\n                )}\n              </div>\n\n              {/* Живой предпросмотр */}\n              <div className=\"relative\">\n                <div className=\"flex items-center justify-between mb-2\">\n                  <Label className=\"text-xs font-medium text-muted-foreground flex items-center gap-2\">\n                    <Eye className=\"w-3 h-3\" />\n                    Живой предпросмотр\n                  </Label>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      {enableMarkdown ? 'Markdown' : 'HTML'}\n                    </Badge>\n                    {value && (\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => copyToClipboard(value)}\n                        className=\"h-6 w-6 p-0\"\n                        title=\"Копировать весь текст\"\n                      >\n                        <Copy className=\"w-3 h-3\" />\n                      </Button>\n                    )}\n                  </div>\n                </div>\n                \n                <div className={`border rounded-md bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-gray-800 min-h-[120px] ${\n                  isExpanded ? 'min-h-[200px]' : ''\n                } overflow-auto shadow-inner`}>\n                  {value ? (\n                    <div className=\"p-3\">\n                      {/* Telegram-style message bubble */}\n                      <div className=\"max-w-full\">\n                        <div className=\"bg-blue-500 text-white rounded-2xl rounded-tl-sm px-4 py-2 inline-block max-w-[80%] shadow-lg\">\n                          <div className=\"text-sm whitespace-pre-wrap\" dangerouslySetInnerHTML={{\n                            __html: renderLivePreview(value)\n                          }} />\n                        </div>\n                        <div className=\"text-xs text-muted-foreground mt-1 flex items-center gap-1\">\n                          <span>✓✓</span>\n                          <span>{new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>\n                        </div>\n                      </div>\n                    </div>\n                  ) : (\n                    <div className=\"flex items-center justify-center h-full text-muted-foreground text-sm\">\n                      <div className=\"text-center space-y-2\">\n                        <Eye className=\"w-8 h-8 mx-auto opacity-50\" />\n                        <div>Предпросмотр появится здесь...</div>\n                        <div className=\"text-xs opacity-70\">Начните печатать для живого предпросмотра</div>\n                      </div>\n                    </div>\n                  )}\n                </div>\n                \n                {/* Статистика и индикаторы */}\n                {value && (\n                  <div className=\"mt-2 flex items-center justify-between text-xs text-muted-foreground\">\n                    <div className=\"flex items-center gap-3\">\n                      <span className=\"flex items-center gap-1\">\n                        <span className=\"w-2 h-2 bg-green-500 rounded-full\"></span>\n                        В реальном времени\n                      </span>\n                      <span>{wordCount} слов</span>\n                      <span>{charCount} символов</span>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      {charCount <= 4096 ? (\n                        <span className=\"text-green-600 dark:text-green-400\">✓ Telegram OK</span>\n                      ) : (\n                        <span className=\"text-red-600 dark:text-red-400\">⚠ Превышен лимит</span>\n                      )}\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n            \n            <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n              <div className=\"flex items-center gap-4\">\n                <span>\n                  {enableMarkdown ? '📝 Markdown' : '🏷️ HTML'} форматирование\n                </span>\n                <span>📊 {wordCount} слов, {charCount} символов</span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span>⌨️ Выделение + Ctrl+B/I/U</span>\n              </div>\n            </div>\n            \n            {/* Usage instructions */}\n            <div className=\"bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-950/20 dark:to-blue-950/20 rounded-lg p-3 border border-green-200 dark:border-green-800\">\n              <div className=\"text-xs space-y-1\">\n                <div className=\"font-medium text-green-700 dark:text-green-300 mb-2\">🎯 Как использовать форматирование:</div>\n                <div className=\"space-y-1 text-green-600 dark:text-green-400\">\n                  <div>1️⃣ Напишите или вставьте текст</div>\n                  <div>2️⃣ Выделите часть текста мышкой</div>\n                  <div>3️⃣ Нажмите нужную кнопку форматирования</div>\n                  <div className=\"text-blue-600 dark:text-blue-400 mt-2\">⚡ Быстро: Ctrl+B (жирный), Ctrl+I (курсив), Ctrl+U (подчеркнутый)</div>\n                </div>\n              </div>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"preview\" className=\"space-y-3\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <Label className=\"text-xs font-medium\">Предпросмотр как в Telegram</Label>\n              <div className=\"flex items-center gap-2\">\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  {enableMarkdown ? 'Markdown' : 'HTML'}\n                </Badge>\n                {charCount > 4096 && (\n                  <Badge variant=\"destructive\" className=\"text-xs\">\n                    Превышен лимит\n                  </Badge>\n                )}\n              </div>\n            </div>\n            {renderPreview()}\n            \n            {charCount > 0 && (\n              <div className=\"flex items-center gap-4 text-xs text-muted-foreground pt-2 border-t\">\n                <span>📊 Статистика: {wordCount} слов, {charCount} символов</span>\n                <span>📱 Совместимость: {charCount <= 4096 ? '✅' : '❌'} Telegram</span>\n              </div>\n            )}\n          </TabsContent>\n        </Tabs>\n\n        {/* Enhanced Quick Reference with expandable content */}\n        <div className=\"bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-950/30 dark:to-purple-950/30 rounded-lg p-3 space-y-2 border border-blue-200 dark:border-blue-800\">\n          <div className=\"flex items-center justify-between\">\n            <Label className=\"text-xs font-medium flex items-center gap-2\">\n              <Zap className=\"w-3 h-3 text-blue-500\" />\n              Быстрая справка по форматированию\n            </Label>\n            <div className=\"flex items-center gap-1\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => copyToClipboard(formatOptions.map(f => \n                  `${f.name}: ${enableMarkdown ? f.markdown : f.html}`\n                ).join('\\n'))}\n                className=\"h-6 px-2\"\n                title=\"Копировать все команды\"\n              >\n                <Copy className=\"w-3 h-3\" />\n              </Button>\n            </div>\n          </div>\n          \n          <div className=\"grid grid-cols-1 gap-1 text-xs\">\n            {(searchTerm ? filteredFormats : formatOptions).slice(0, 6).map((format) => (\n              <div key={format.name} className=\"flex items-center justify-between py-1\">\n                <div className=\"flex items-center gap-2\">\n                  <format.icon className=\"w-3 h-3 text-blue-500\" />\n                  <span className=\"text-muted-foreground\">{format.name}:</span>\n                </div>\n                <code className=\"bg-white dark:bg-gray-800 px-2 py-1 rounded text-xs border\">\n                  {enableMarkdown ? format.markdown : format.html}\n                </code>\n              </div>\n            ))}\n          </div>\n          \n          {formatOptions.length > 6 && (\n            <div className=\"text-center pt-1\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"text-xs h-6\"\n                onClick={() => setSearchTerm('')}\n              >\n                Показать все ({formatOptions.length}) команд\n              </Button>\n            </div>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":44282},"client/src/components/layout/draggable-layout.tsx":{"content":"import React, { useState, useCallback, useRef, useEffect } from 'react';\nimport { useDrag, useDrop, DndProvider } from 'react-dnd';\nimport { HTML5Backend } from 'react-dnd-html5-backend';\nimport { Button } from '@/components/ui/button';\nimport { Card } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Switch } from '@/components/ui/switch';\nimport { Label } from '@/components/ui/label';\nimport { \n  GripVertical, \n  Move, \n  RotateCcw, \n  Layout, \n  Eye, \n  EyeOff,\n  Lock,\n  Unlock,\n  Settings\n} from 'lucide-react';\n\nexport interface DraggableLayoutConfig {\n  elements: LayoutElement[];\n  gridSize: number;\n  snapToGrid: boolean;\n  showGrid: boolean;\n  lockElements: boolean;\n  previewMode: boolean;\n}\n\nexport interface LayoutElement {\n  id: string;\n  type: 'header' | 'sidebar' | 'canvas' | 'properties';\n  position: { x: number; y: number };\n  size: { width: number; height: number };\n  visible: boolean;\n  locked: boolean;\n  zIndex: number;\n  minSize: { width: number; height: number };\n  maxSize: { width: number; height: number };\n  resizable: boolean;\n  draggable: boolean;\n  content?: React.ReactNode;\n}\n\nconst DEFAULT_ELEMENTS: LayoutElement[] = [\n  {\n    id: 'header',\n    type: 'header',\n    position: { x: 0, y: 0 },\n    size: { width: 100, height: 60 },\n    visible: true,\n    locked: false,\n    zIndex: 1000,\n    minSize: { width: 200, height: 40 },\n    maxSize: { width: 2000, height: 100 },\n    resizable: true,\n    draggable: true,\n  },\n  {\n    id: 'sidebar',\n    type: 'sidebar',\n    position: { x: 0, y: 60 },\n    size: { width: 280, height: 80 },\n    visible: true,\n    locked: false,\n    zIndex: 100,\n    minSize: { width: 200, height: 200 },\n    maxSize: { width: 600, height: 2000 },\n    resizable: true,\n    draggable: true,\n  },\n  {\n    id: 'canvas',\n    type: 'canvas',\n    position: { x: 280, y: 60 },\n    size: { width: 60, height: 80 },\n    visible: true,\n    locked: false,\n    zIndex: 1,\n    minSize: { width: 300, height: 200 },\n    maxSize: { width: 2000, height: 2000 },\n    resizable: true,\n    draggable: true,\n  },\n  {\n    id: 'properties',\n    type: 'properties',\n    position: { x: 75, y: 60 },\n    size: { width: 25, height: 80 },\n    visible: true,\n    locked: false,\n    zIndex: 100,\n    minSize: { width: 200, height: 200 },\n    maxSize: { width: 500, height: 2000 },\n    resizable: true,\n    draggable: true,\n  },\n];\n\ninterface DraggableElementProps {\n  element: LayoutElement;\n  onMove: (id: string, position: { x: number; y: number }) => void;\n  onResize: (id: string, size: { width: number; height: number }) => void;\n  onToggleVisibility: (id: string) => void;\n  onToggleLock: (id: string) => void;\n  gridSize: number;\n  snapToGrid: boolean;\n  showGrid: boolean;\n  previewMode: boolean;\n  containerRef: React.RefObject<HTMLDivElement>;\n}\n\nconst DraggableElement: React.FC<DraggableElementProps> = ({\n  element,\n  onMove,\n  onResize,\n  onToggleVisibility,\n  onToggleLock,\n  gridSize,\n  snapToGrid,\n  previewMode,\n  containerRef\n}) => {\n  const [isResizing, setIsResizing] = useState(false);\n  const [resizeStart, setResizeStart] = useState({ x: 0, y: 0, width: 0, height: 0 });\n  const elementRef = useRef<HTMLDivElement>(null);\n\n  const [{ isDragging }, drag] = useDrag({\n    type: 'layout-element',\n    item: { id: element.id, type: element.type },\n    canDrag: element.draggable && !element.locked && !previewMode,\n    collect: (monitor) => ({\n      isDragging: monitor.isDragging(),\n    }),\n  });\n\n  const [, drop] = useDrop({\n    accept: 'layout-element',\n    hover: (item: { id: string; type: string }, monitor) => {\n      if (!elementRef.current || !containerRef.current) return;\n      \n      const draggedElement = item;\n      if (draggedElement.id === element.id) return;\n\n      const clientOffset = monitor.getClientOffset();\n      if (!clientOffset) return;\n\n      const containerRect = containerRef.current.getBoundingClientRect();\n      const relativeX = clientOffset.x - containerRect.left;\n      const relativeY = clientOffset.y - containerRect.top;\n\n      let newX = (relativeX / containerRect.width) * 100;\n      let newY = (relativeY / containerRect.height) * 100;\n\n      if (snapToGrid) {\n        newX = Math.round(newX / gridSize) * gridSize;\n        newY = Math.round(newY / gridSize) * gridSize;\n      }\n\n      onMove(draggedElement.id, { x: newX, y: newY });\n    },\n  });\n\n  drag(drop(elementRef));\n\n  const handleResizeStart = useCallback((e: React.MouseEvent) => {\n    if (element.locked || previewMode || !element.resizable) return;\n    \n    e.preventDefault();\n    setIsResizing(true);\n    setResizeStart({\n      x: e.clientX,\n      y: e.clientY,\n      width: element.size.width,\n      height: element.size.height,\n    });\n  }, [element.locked, element.resizable, element.size, previewMode]);\n\n  const handleResizeMove = useCallback((e: MouseEvent) => {\n    if (!isResizing || !containerRef.current) return;\n\n    const containerRect = containerRef.current.getBoundingClientRect();\n    const deltaX = e.clientX - resizeStart.x;\n    const deltaY = e.clientY - resizeStart.y;\n\n    let newWidth = resizeStart.width + (deltaX / containerRect.width) * 100;\n    let newHeight = resizeStart.height + (deltaY / containerRect.height) * 100;\n\n    // Применяем ограничения размера\n    newWidth = Math.max(element.minSize.width, Math.min(element.maxSize.width, newWidth));\n    newHeight = Math.max(element.minSize.height, Math.min(element.maxSize.height, newHeight));\n\n    if (snapToGrid) {\n      newWidth = Math.round(newWidth / gridSize) * gridSize;\n      newHeight = Math.round(newHeight / gridSize) * gridSize;\n    }\n\n    onResize(element.id, { width: newWidth, height: newHeight });\n  }, [isResizing, resizeStart, element.minSize, element.maxSize, element.id, onResize, snapToGrid, gridSize, containerRef]);\n\n  const handleResizeEnd = useCallback(() => {\n    setIsResizing(false);\n  }, []);\n\n  useEffect(() => {\n    if (isResizing) {\n      document.addEventListener('mousemove', handleResizeMove);\n      document.addEventListener('mouseup', handleResizeEnd);\n      return () => {\n        document.removeEventListener('mousemove', handleResizeMove);\n        document.removeEventListener('mouseup', handleResizeEnd);\n      };\n    }\n  }, [isResizing, handleResizeMove, handleResizeEnd]);\n\n  if (!element.visible) return null;\n\n  const elementStyle: React.CSSProperties = {\n    position: 'absolute',\n    left: `${element.position.x}%`,\n    top: `${element.position.y}%`,\n    width: `${element.size.width}%`,\n    height: `${element.size.height}%`,\n    zIndex: element.zIndex,\n    opacity: isDragging ? 0.5 : 1,\n    cursor: element.locked ? 'not-allowed' : element.draggable ? 'move' : 'default',\n  };\n\n  return (\n    <div\n      ref={elementRef}\n      style={elementStyle}\n      className={`\n        border-2 border-dashed transition-all duration-200\n        ${element.locked ? 'border-gray-400' : 'border-blue-500'}\n        ${isDragging ? 'scale-105' : ''}\n        ${previewMode ? 'border-transparent' : ''}\n        bg-white dark:bg-gray-800 rounded-lg shadow-lg\n        ${element.locked ? 'opacity-75' : ''}\n      `}\n    >\n      {/* Header Controls */}\n      {!previewMode && (\n        <div className=\"absolute -top-8 left-0 right-0 flex items-center justify-between px-2 py-1 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded-t-lg\">\n          <div className=\"flex items-center gap-1\">\n            <GripVertical className=\"w-3 h-3\" />\n            <span className=\"font-medium capitalize\">{element.type}</span>\n            <Badge variant=\"secondary\" className=\"text-xs\">\n              {Math.round(element.size.width)}x{Math.round(element.size.height)}\n            </Badge>\n          </div>\n          <div className=\"flex items-center gap-1\">\n            <button\n              onClick={() => onToggleVisibility(element.id)}\n              className=\"p-1 hover:bg-gray-600 rounded\"\n              title=\"Переключить видимость\"\n            >\n              {element.visible ? <Eye className=\"w-3 h-3\" /> : <EyeOff className=\"w-3 h-3\" />}\n            </button>\n            <button\n              onClick={() => onToggleLock(element.id)}\n              className=\"p-1 hover:bg-gray-600 rounded\"\n              title=\"Заблокировать/разблокировать\"\n            >\n              {element.locked ? <Lock className=\"w-3 h-3\" /> : <Unlock className=\"w-3 h-3\" />}\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* Content */}\n      <div className=\"h-full p-4 flex items-center justify-center\">\n        {element.content || (\n          <div className=\"text-center text-gray-500 dark:text-gray-400\">\n            <Layout className=\"w-8 h-8 mx-auto mb-2\" />\n            <p className=\"text-sm font-medium capitalize\">{element.type}</p>\n            <p className=\"text-xs opacity-75\">\n              {Math.round(element.position.x)}, {Math.round(element.position.y)}\n            </p>\n          </div>\n        )}\n      </div>\n\n      {/* Resize Handle */}\n      {!previewMode && element.resizable && !element.locked && (\n        <div\n          className=\"absolute bottom-0 right-0 w-4 h-4 bg-blue-500 cursor-se-resize rounded-tl-lg hover:bg-blue-600 transition-colors\"\n          onMouseDown={handleResizeStart}\n          title=\"Изменить размер\"\n        />\n      )}\n    </div>\n  );\n};\n\ninterface DraggableLayoutProps {\n  elements: LayoutElement[];\n  config: DraggableLayoutConfig;\n  onElementMove: (id: string, position: { x: number; y: number }) => void;\n  onElementResize: (id: string, size: { width: number; height: number }) => void;\n  onElementToggleVisibility: (id: string) => void;\n  onElementToggleLock: (id: string) => void;\n  onConfigChange: (config: Partial<DraggableLayoutConfig>) => void;\n  children?: React.ReactNode;\n}\n\nexport const DraggableLayout: React.FC<DraggableLayoutProps> = ({\n  elements,\n  config,\n  onElementMove,\n  onElementResize,\n  onElementToggleVisibility,\n  onElementToggleLock,\n  onConfigChange,\n  children\n}) => {\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  const gridStyle = config.showGrid ? {\n    backgroundImage: `\n      linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),\n      linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px)\n    `,\n    backgroundSize: `${config.gridSize}% ${config.gridSize}%`,\n  } : {};\n\n  return (\n    <DndProvider backend={HTML5Backend}>\n      <div className=\"h-full flex flex-col\">\n        {/* Controls */}\n        {!config.previewMode && (\n          <div className=\"flex-shrink-0 p-4 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700\">\n            <div className=\"flex items-center gap-4 flex-wrap\">\n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  id=\"preview-mode\"\n                  checked={config.previewMode}\n                  onCheckedChange={(checked) => onConfigChange({ previewMode: checked })}\n                />\n                <Label htmlFor=\"preview-mode\">Режим предпросмотра</Label>\n              </div>\n              \n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  id=\"snap-to-grid\"\n                  checked={config.snapToGrid}\n                  onCheckedChange={(checked) => onConfigChange({ snapToGrid: checked })}\n                />\n                <Label htmlFor=\"snap-to-grid\">Привязка к сетке</Label>\n              </div>\n              \n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  id=\"show-grid\"\n                  checked={config.showGrid}\n                  onCheckedChange={(checked) => onConfigChange({ showGrid: checked })}\n                />\n                <Label htmlFor=\"show-grid\">Показать сетку</Label>\n              </div>\n              \n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  id=\"lock-elements\"\n                  checked={config.lockElements}\n                  onCheckedChange={(checked) => onConfigChange({ lockElements: checked })}\n                />\n                <Label htmlFor=\"lock-elements\">Заблокировать все</Label>\n              </div>\n\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => {\n                  // Сброс к умолчанию\n                  onConfigChange({ \n                    elements: DEFAULT_ELEMENTS,\n                    gridSize: 5,\n                    snapToGrid: true,\n                    showGrid: true,\n                    lockElements: false,\n                    previewMode: false\n                  });\n                }}\n              >\n                <RotateCcw className=\"w-4 h-4 mr-2\" />\n                Сбросить\n              </Button>\n            </div>\n          </div>\n        )}\n\n        {/* Layout Container */}\n        <div\n          ref={containerRef}\n          className=\"flex-1 relative overflow-hidden bg-gray-100 dark:bg-gray-900\"\n          style={gridStyle}\n        >\n          {elements.map((element) => (\n            <DraggableElement\n              key={element.id}\n              element={element}\n              onMove={onElementMove}\n              onResize={onElementResize}\n              onToggleVisibility={onElementToggleVisibility}\n              onToggleLock={onElementToggleLock}\n              gridSize={config.gridSize}\n              snapToGrid={config.snapToGrid}\n              showGrid={config.showGrid}\n              previewMode={config.previewMode}\n              containerRef={containerRef}\n            />\n          ))}\n          {children}\n        </div>\n      </div>\n    </DndProvider>\n  );\n};\n\nexport const useDraggableLayout = () => {\n  const [config, setConfig] = useState<DraggableLayoutConfig>({\n    elements: DEFAULT_ELEMENTS,\n    gridSize: 5,\n    snapToGrid: true,\n    showGrid: true,\n    lockElements: false,\n    previewMode: false,\n  });\n\n  const updateConfig = useCallback((newConfig: Partial<DraggableLayoutConfig>) => {\n    setConfig(prev => ({ ...prev, ...newConfig }));\n  }, []);\n\n  const updateElement = useCallback((id: string, updates: Partial<LayoutElement>) => {\n    setConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(el => \n        el.id === id ? { ...el, ...updates } : el\n      )\n    }));\n  }, []);\n\n  const moveElement = useCallback((id: string, position: { x: number; y: number }) => {\n    updateElement(id, { position });\n  }, [updateElement]);\n\n  const resizeElement = useCallback((id: string, size: { width: number; height: number }) => {\n    updateElement(id, { size });\n  }, [updateElement]);\n\n  const toggleElementVisibility = useCallback((id: string) => {\n    setConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(el =>\n        el.id === id ? { ...el, visible: !el.visible } : el\n      )\n    }));\n  }, []);\n\n  const toggleElementLock = useCallback((id: string) => {\n    setConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(el =>\n        el.id === id ? { ...el, locked: !el.locked } : el\n      )\n    }));\n  }, []);\n\n  const resetLayout = useCallback(() => {\n    setConfig({\n      elements: DEFAULT_ELEMENTS,\n      gridSize: 5,\n      snapToGrid: true,\n      showGrid: true,\n      lockElements: false,\n      previewMode: false,\n    });\n  }, []);\n\n  return {\n    config,\n    updateConfig,\n    moveElement,\n    resizeElement,\n    toggleElementVisibility,\n    toggleElementLock,\n    resetLayout,\n  };\n};","size_bytes":15550},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","size_bytes":483},"update-templates-conditional.js":{"content":"#!/usr/bin/env node\n\n// Import required modules\nimport { seedDefaultTemplates } from './server/seed-templates.ts';\n\nasync function updateTemplates() {\n  try {\n    console.log('🔄 Updating templates with conditional button functionality...');\n    await seedDefaultTemplates(true);\n    console.log('✅ Templates updated successfully with conditional button support!');\n  } catch (error) {\n    console.error('❌ Error updating templates:', error);\n    process.exit(1);\n  }\n  process.exit(0);\n}\n\nupdateTemplates();","size_bytes":514},"client/src/hooks/use-media-query.ts":{"content":"import { useState, useEffect } from 'react';\n\nexport function useMediaQuery(query: string): boolean {\n  const [matches, setMatches] = useState<boolean>(() => {\n    if (typeof window !== 'undefined') {\n      return window.matchMedia(query).matches;\n    }\n    return false;\n  });\n\n  useEffect(() => {\n    const media = window.matchMedia(query);\n    setMatches(media.matches);\n    \n    const listener = (e: MediaQueryListEvent) => setMatches(e.matches);\n    media.addEventListener('change', listener);\n    \n    return () => media.removeEventListener('change', listener);\n  }, [query]);\n\n  return matches;\n}","size_bytes":603},"client/src/components/layout/drag-layout-manager.tsx":{"content":"import React, { useState, useCallback, useRef, useEffect } from 'react';\nimport { DndProvider, useDrag, useDrop } from 'react-dnd';\nimport { HTML5Backend } from 'react-dnd-html5-backend';\nimport { Button } from '@/components/ui/button';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Switch } from '@/components/ui/switch';\nimport { Label } from '@/components/ui/label';\nimport { Separator } from '@/components/ui/separator';\nimport { \n  Layout, \n  GripVertical, \n  Move, \n  RotateCcw, \n  Eye, \n  EyeOff,\n  Settings,\n  ArrowUp,\n  ArrowDown,\n  ArrowLeft,\n  ArrowRight,\n  Maximize2,\n  Minimize2\n} from 'lucide-react';\n\nexport interface DragLayoutElement {\n  id: string;\n  type: 'header' | 'sidebar' | 'canvas' | 'properties';\n  title: string;\n  position: 'top' | 'bottom' | 'left' | 'right' | 'center';\n  size: number; // процент от общей площади\n  visible: boolean;\n  locked: boolean;\n  content: React.ReactNode;\n}\n\nexport interface DragLayoutConfig {\n  elements: DragLayoutElement[];\n  gridSnap: boolean;\n  showGrid: boolean;\n  compactMode: boolean;\n}\n\nconst DRAG_TYPE = 'layout-element';\nconst DROP_ZONES = ['top', 'bottom', 'left', 'right', 'center'] as const;\n\ninterface DragLayoutManagerProps {\n  headerContent: React.ReactNode;\n  sidebarContent: React.ReactNode;\n  canvasContent: React.ReactNode;\n  propertiesContent: React.ReactNode;\n  onLayoutChange?: (config: DragLayoutConfig) => void;\n  className?: string;\n}\n\ninterface DraggableElementProps {\n  element: DragLayoutElement;\n  isPreview?: boolean;\n  onMove?: (elementId: string, newPosition: string) => void;\n  onToggleVisibility?: (elementId: string) => void;\n  onToggleLock?: (elementId: string) => void;\n}\n\nconst DraggableElement: React.FC<DraggableElementProps> = ({ \n  element, \n  isPreview = false, \n  onMove, \n  onToggleVisibility, \n  onToggleLock \n}) => {\n  const [{ isDragging }, drag] = useDrag({\n    type: DRAG_TYPE,\n    item: { id: element.id, type: element.type },\n    collect: (monitor) => ({\n      isDragging: monitor.isDragging(),\n    }),\n    canDrag: !element.locked && !isPreview,\n  });\n\n  const getPositionIcon = () => {\n    switch (element.position) {\n      case 'top': return <ArrowUp className=\"w-4 h-4\" />;\n      case 'bottom': return <ArrowDown className=\"w-4 h-4\" />;\n      case 'left': return <ArrowLeft className=\"w-4 h-4\" />;\n      case 'right': return <ArrowRight className=\"w-4 h-4\" />;\n      case 'center': return <Maximize2 className=\"w-4 h-4\" />;\n      default: return <Move className=\"w-4 h-4\" />;\n    }\n  };\n\n  const getElementColor = () => {\n    switch (element.type) {\n      case 'header': return 'bg-blue-100 dark:bg-blue-900/20 border-blue-300 dark:border-blue-700';\n      case 'sidebar': return 'bg-green-100 dark:bg-green-900/20 border-green-300 dark:border-green-700';\n      case 'canvas': return 'bg-purple-100 dark:bg-purple-900/20 border-purple-300 dark:border-purple-700';\n      case 'properties': return 'bg-orange-100 dark:bg-orange-900/20 border-orange-300 dark:border-orange-700';\n      default: return 'bg-gray-100 dark:bg-gray-900/20 border-gray-300 dark:border-gray-700';\n    }\n  };\n\n  if (isPreview) {\n    return (\n      <div className={`\n        relative border-2 rounded-lg p-4 transition-all duration-200\n        ${getElementColor()}\n        ${!element.visible ? 'opacity-50' : ''}\n        ${element.locked ? 'ring-2 ring-red-300' : ''}\n      `}>\n        {element.content}\n      </div>\n    );\n  }\n\n  return (\n    <div\n      ref={drag}\n      className={`\n        relative border-2 rounded-lg p-3 cursor-move transition-all duration-200\n        ${getElementColor()}\n        ${isDragging ? 'opacity-50 scale-95' : ''}\n        ${!element.visible ? 'opacity-50' : ''}\n        ${element.locked ? 'cursor-not-allowed ring-2 ring-red-300' : 'hover:shadow-md'}\n      `}\n    >\n      <div className=\"flex items-center justify-between mb-2\">\n        <div className=\"flex items-center gap-2\">\n          <GripVertical className=\"w-4 h-4 text-gray-400\" />\n          <span className=\"font-medium text-sm\">{element.title}</span>\n          {getPositionIcon()}\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => onToggleVisibility?.(element.id)}\n            className=\"h-6 w-6 p-0\"\n          >\n            {element.visible ? <Eye className=\"w-3 h-3\" /> : <EyeOff className=\"w-3 h-3\" />}\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => onToggleLock?.(element.id)}\n            className=\"h-6 w-6 p-0\"\n          >\n            {element.locked ? <Settings className=\"w-3 h-3\" /> : <Move className=\"w-3 h-3\" />}\n          </Button>\n        </div>\n      </div>\n      \n      <Badge variant=\"secondary\" className=\"text-xs\">\n        {element.position} • {element.size}%\n      </Badge>\n    </div>\n  );\n};\n\ninterface DropZoneProps {\n  position: string;\n  onDrop: (elementId: string, position: string) => void;\n  isActive: boolean;\n  children?: React.ReactNode;\n}\n\nconst DropZone: React.FC<DropZoneProps> = ({ position, onDrop, isActive, children }) => {\n  const [{ isOver, canDrop }, drop] = useDrop({\n    accept: DRAG_TYPE,\n    drop: (item: { id: string; type: string }) => {\n      onDrop(item.id, position);\n    },\n    collect: (monitor) => ({\n      isOver: monitor.isOver(),\n      canDrop: monitor.canDrop(),\n    }),\n  });\n\n  const getDropZoneClasses = () => {\n    let classes = 'relative border-2 border-dashed transition-all duration-200 rounded-lg ';\n    \n    if (isActive) {\n      classes += 'border-blue-400 bg-blue-50 dark:bg-blue-900/10 ';\n    } else {\n      classes += 'border-gray-300 dark:border-gray-600 ';\n    }\n    \n    if (isOver && canDrop) {\n      classes += 'border-green-400 bg-green-50 dark:bg-green-900/10 scale-105 ';\n    } else if (canDrop) {\n      classes += 'border-blue-400 bg-blue-50 dark:bg-blue-900/10 ';\n    }\n    \n    return classes;\n  };\n\n  return (\n    <div ref={drop} className={getDropZoneClasses()}>\n      {children}\n      {isOver && canDrop && (\n        <div className=\"absolute inset-0 flex items-center justify-center bg-green-100 dark:bg-green-900/20 rounded-lg\">\n          <div className=\"text-green-700 dark:text-green-300 font-medium\">\n            Отпустите для размещения\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nconst DragLayoutManager: React.FC<DragLayoutManagerProps> = ({\n  headerContent,\n  sidebarContent,\n  canvasContent,\n  propertiesContent,\n  onLayoutChange,\n  className = \"\"\n}) => {\n  const [config, setConfig] = useState<DragLayoutConfig>({\n    elements: [\n      {\n        id: 'header',\n        type: 'header',\n        title: 'Заголовок',\n        position: 'top',\n        size: 10,\n        visible: true,\n        locked: false,\n        content: headerContent\n      },\n      {\n        id: 'sidebar',\n        type: 'sidebar',\n        title: 'Боковая панель',\n        position: 'left',\n        size: 20,\n        visible: true,\n        locked: false,\n        content: sidebarContent\n      },\n      {\n        id: 'canvas',\n        type: 'canvas',\n        title: 'Холст',\n        position: 'center',\n        size: 50,\n        visible: true,\n        locked: false,\n        content: canvasContent\n      },\n      {\n        id: 'properties',\n        type: 'properties',\n        title: 'Свойства',\n        position: 'right',\n        size: 20,\n        visible: true,\n        locked: false,\n        content: propertiesContent\n      }\n    ],\n    gridSnap: true,\n    showGrid: true,\n    compactMode: false\n  });\n\n  const [isCustomizing, setIsCustomizing] = useState(false);\n  const [previewMode, setPreviewMode] = useState(false);\n\n  const handleElementMove = useCallback((elementId: string, newPosition: string) => {\n    setConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(el => \n        el.id === elementId \n          ? { ...el, position: newPosition as any }\n          : el\n      )\n    }));\n  }, []);\n\n  const handleToggleVisibility = useCallback((elementId: string) => {\n    setConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(el => \n        el.id === elementId \n          ? { ...el, visible: !el.visible }\n          : el\n      )\n    }));\n  }, []);\n\n  const handleToggleLock = useCallback((elementId: string) => {\n    setConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(el => \n        el.id === elementId \n          ? { ...el, locked: !el.locked }\n          : el\n      )\n    }));\n  }, []);\n\n  const handleConfigChange = useCallback((key: keyof DragLayoutConfig, value: any) => {\n    setConfig(prev => ({\n      ...prev,\n      [key]: value\n    }));\n  }, []);\n\n  const handleReset = useCallback(() => {\n    setConfig({\n      elements: [\n        {\n          id: 'header',\n          type: 'header',\n          title: 'Заголовок',\n          position: 'top',\n          size: 10,\n          visible: true,\n          locked: false,\n          content: headerContent\n        },\n        {\n          id: 'sidebar',\n          type: 'sidebar',\n          title: 'Боковая панель',\n          position: 'left',\n          size: 20,\n          visible: true,\n          locked: false,\n          content: sidebarContent\n        },\n        {\n          id: 'canvas',\n          type: 'canvas',\n          title: 'Холст',\n          position: 'center',\n          size: 50,\n          visible: true,\n          locked: false,\n          content: canvasContent\n        },\n        {\n          id: 'properties',\n          type: 'properties',\n          title: 'Свойства',\n          position: 'right',\n          size: 20,\n          visible: true,\n          locked: false,\n          content: propertiesContent\n        }\n      ],\n      gridSnap: true,\n      showGrid: true,\n      compactMode: false\n    });\n  }, [headerContent, sidebarContent, canvasContent, propertiesContent]);\n\n  const handleApply = useCallback(() => {\n    onLayoutChange?.(config);\n    setIsCustomizing(false);\n  }, [config, onLayoutChange]);\n\n  const renderCurrentLayout = () => {\n    const visibleElements = config.elements.filter(el => el.visible);\n    const topElements = visibleElements.filter(el => el.position === 'top');\n    const bottomElements = visibleElements.filter(el => el.position === 'bottom');\n    const leftElements = visibleElements.filter(el => el.position === 'left');\n    const rightElements = visibleElements.filter(el => el.position === 'right');\n    const centerElements = visibleElements.filter(el => el.position === 'center');\n\n    return (\n      <div className=\"h-full flex flex-col\">\n        {/* Верхняя область */}\n        {topElements.length > 0 && (\n          <div className=\"flex-shrink-0 border-b border-gray-200 dark:border-gray-700\">\n            <div className=\"flex\">\n              {topElements.map(element => (\n                <DraggableElement\n                  key={element.id}\n                  element={element}\n                  isPreview={previewMode}\n                  onMove={handleElementMove}\n                  onToggleVisibility={handleToggleVisibility}\n                  onToggleLock={handleToggleLock}\n                />\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Основная область */}\n        <div className=\"flex-1 flex\">\n          {/* Левая область */}\n          {leftElements.length > 0 && (\n            <div className=\"flex-shrink-0 border-r border-gray-200 dark:border-gray-700\">\n              <div className=\"flex flex-col h-full\">\n                {leftElements.map(element => (\n                  <DraggableElement\n                    key={element.id}\n                    element={element}\n                    isPreview={previewMode}\n                    onMove={handleElementMove}\n                    onToggleVisibility={handleToggleVisibility}\n                    onToggleLock={handleToggleLock}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Центральная область */}\n          <div className=\"flex-1\">\n            {centerElements.map(element => (\n              <DraggableElement\n                key={element.id}\n                element={element}\n                isPreview={previewMode}\n                onMove={handleElementMove}\n                onToggleVisibility={handleToggleVisibility}\n                onToggleLock={handleToggleLock}\n              />\n            ))}\n          </div>\n\n          {/* Правая область */}\n          {rightElements.length > 0 && (\n            <div className=\"flex-shrink-0 border-l border-gray-200 dark:border-gray-700\">\n              <div className=\"flex flex-col h-full\">\n                {rightElements.map(element => (\n                  <DraggableElement\n                    key={element.id}\n                    element={element}\n                    isPreview={previewMode}\n                    onMove={handleElementMove}\n                    onToggleVisibility={handleToggleVisibility}\n                    onToggleLock={handleToggleLock}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Нижняя область */}\n        {bottomElements.length > 0 && (\n          <div className=\"flex-shrink-0 border-t border-gray-200 dark:border-gray-700\">\n            <div className=\"flex\">\n              {bottomElements.map(element => (\n                <DraggableElement\n                  key={element.id}\n                  element={element}\n                  isPreview={previewMode}\n                  onMove={handleElementMove}\n                  onToggleVisibility={handleToggleVisibility}\n                  onToggleLock={handleToggleLock}\n                />\n              ))}\n            </div>\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  const renderCustomizer = () => {\n    return (\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 h-full\">\n        {/* Панель управления */}\n        <div className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Layout className=\"w-5 h-5\" />\n                Настройки макета\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"grid-snap\">Привязка к сетке</Label>\n                <Switch\n                  id=\"grid-snap\"\n                  checked={config.gridSnap}\n                  onCheckedChange={(checked) => handleConfigChange('gridSnap', checked)}\n                />\n              </div>\n              \n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"show-grid\">Показать сетку</Label>\n                <Switch\n                  id=\"show-grid\"\n                  checked={config.showGrid}\n                  onCheckedChange={(checked) => handleConfigChange('showGrid', checked)}\n                />\n              </div>\n              \n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"compact-mode\">Компактный режим</Label>\n                <Switch\n                  id=\"compact-mode\"\n                  checked={config.compactMode}\n                  onCheckedChange={(checked) => handleConfigChange('compactMode', checked)}\n                />\n              </div>\n              \n              <Separator />\n              \n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"preview-mode\">Режим предпросмотра</Label>\n                <Switch\n                  id=\"preview-mode\"\n                  checked={previewMode}\n                  onCheckedChange={setPreviewMode}\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Элементы макета</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                {config.elements.map(element => (\n                  <DraggableElement\n                    key={element.id}\n                    element={element}\n                    onMove={handleElementMove}\n                    onToggleVisibility={handleToggleVisibility}\n                    onToggleLock={handleToggleLock}\n                  />\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Область предпросмотра и зоны размещения */}\n        <div className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Предпросмотр макета</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"h-96 relative\">\n                {previewMode ? (\n                  renderCurrentLayout()\n                ) : (\n                  <div className=\"grid grid-cols-3 grid-rows-3 gap-2 h-full\">\n                    {/* Зоны размещения */}\n                    <div className=\"col-span-3\">\n                      <DropZone\n                        position=\"top\"\n                        onDrop={handleElementMove}\n                        isActive={config.elements.some(el => el.position === 'top')}\n                      >\n                        <div className=\"p-4 text-center text-sm text-gray-500\">\n                          Верхняя область\n                        </div>\n                      </DropZone>\n                    </div>\n                    \n                    <DropZone\n                      position=\"left\"\n                      onDrop={handleElementMove}\n                      isActive={config.elements.some(el => el.position === 'left')}\n                    >\n                      <div className=\"p-4 text-center text-sm text-gray-500\">\n                        Левая\n                      </div>\n                    </DropZone>\n                    \n                    <DropZone\n                      position=\"center\"\n                      onDrop={handleElementMove}\n                      isActive={config.elements.some(el => el.position === 'center')}\n                    >\n                      <div className=\"p-4 text-center text-sm text-gray-500\">\n                        Центр\n                      </div>\n                    </DropZone>\n                    \n                    <DropZone\n                      position=\"right\"\n                      onDrop={handleElementMove}\n                      isActive={config.elements.some(el => el.position === 'right')}\n                    >\n                      <div className=\"p-4 text-center text-sm text-gray-500\">\n                        Правая\n                      </div>\n                    </DropZone>\n                    \n                    <div className=\"col-span-3\">\n                      <DropZone\n                        position=\"bottom\"\n                        onDrop={handleElementMove}\n                        isActive={config.elements.some(el => el.position === 'bottom')}\n                      >\n                        <div className=\"p-4 text-center text-sm text-gray-500\">\n                          Нижняя область\n                        </div>\n                      </DropZone>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  };\n\n  return (\n    <DndProvider backend={HTML5Backend}>\n      <div className={className}>\n        {/* Кнопка для открытия настроек */}\n        <Dialog open={isCustomizing} onOpenChange={setIsCustomizing}>\n          <DialogTrigger asChild>\n            <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\n              <Layout className=\"w-4 h-4\" />\n              Настроить макет\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-7xl h-[80vh] overflow-auto\">\n            <DialogHeader>\n              <DialogTitle>Настройка макета интерфейса</DialogTitle>\n            </DialogHeader>\n            \n            {renderCustomizer()}\n            \n            <div className=\"flex justify-end gap-2 mt-6\">\n              <Button variant=\"outline\" onClick={handleReset}>\n                <RotateCcw className=\"w-4 h-4 mr-2\" />\n                Сбросить\n              </Button>\n              <Button onClick={handleApply}>\n                Применить\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Текущий макет */}\n        {!isCustomizing && renderCurrentLayout()}\n      </div>\n    </DndProvider>\n  );\n};\n\nexport default DragLayoutManager;","size_bytes":21215},"client/src/components/layout/layout-manager.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { Switch } from '@/components/ui/switch';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { \n  Settings, \n  Move, \n  RotateCcw, \n  Grid, \n  Layout, \n  Sidebar, \n  Navigation, \n  Maximize,\n  ArrowUp,\n  ArrowDown,\n  ArrowLeft,\n  ArrowRight\n} from 'lucide-react';\n\nexport interface LayoutConfig {\n  headerPosition: 'top' | 'bottom' | 'left' | 'right';\n  sidebarPosition: 'left' | 'right';\n  propertiesPosition: 'right' | 'left';\n  canvasFullscreen: boolean;\n  compactMode: boolean;\n  showGrid: boolean;\n  panelSizes: {\n    sidebar: number;\n    properties: number;\n    canvas: number;\n  };\n}\n\nconst DEFAULT_LAYOUT: LayoutConfig = {\n  headerPosition: 'top',\n  sidebarPosition: 'left',\n  propertiesPosition: 'right',\n  canvasFullscreen: false,\n  compactMode: false,\n  showGrid: true,\n  panelSizes: {\n    sidebar: 20,\n    properties: 25,\n    canvas: 55\n  }\n};\n\ninterface LayoutManagerProps {\n  config: LayoutConfig;\n  onConfigChange: (config: LayoutConfig) => void;\n  onApply: () => void;\n  onReset: () => void;\n}\n\nexport function LayoutManager({ config, onConfigChange, onApply, onReset }: LayoutManagerProps) {\n  const [isVisible, setIsVisible] = useState(false);\n  const [previewMode, setPreviewMode] = useState(false);\n\n  const handleConfigUpdate = (key: keyof LayoutConfig, value: any) => {\n    const newConfig = { ...config, [key]: value };\n    onConfigChange(newConfig);\n  };\n\n  const handlePanelSizeUpdate = (panel: keyof LayoutConfig['panelSizes'], value: number) => {\n    const newSizes = { ...config.panelSizes, [panel]: value };\n    // Нормализуем размеры чтобы они составляли 100%\n    const total = Object.values(newSizes).reduce((sum, size) => sum + size, 0);\n    const normalizedSizes = Object.fromEntries(\n      Object.entries(newSizes).map(([key, size]) => [key, Math.round((size / total) * 100)])\n    ) as LayoutConfig['panelSizes'];\n    \n    handleConfigUpdate('panelSizes', normalizedSizes);\n  };\n\n  const presets = [\n    {\n      name: 'Классический',\n      description: 'Стандартное расположение',\n      config: DEFAULT_LAYOUT\n    },\n    {\n      name: 'Компактный',\n      description: 'Сжатый интерфейс',\n      config: {\n        ...DEFAULT_LAYOUT,\n        compactMode: true,\n        panelSizes: { sidebar: 15, properties: 20, canvas: 65 }\n      }\n    },\n    {\n      name: 'Фокус на холсте',\n      description: 'Максимум места для холста',\n      config: {\n        ...DEFAULT_LAYOUT,\n        headerPosition: 'bottom' as const,\n        panelSizes: { sidebar: 12, properties: 15, canvas: 73 }\n      }\n    },\n    {\n      name: 'Левосторонний',\n      description: 'Все панели слева',\n      config: {\n        ...DEFAULT_LAYOUT,\n        sidebarPosition: 'left' as const,\n        propertiesPosition: 'left' as const,\n        panelSizes: { sidebar: 25, properties: 25, canvas: 50 }\n      }\n    },\n    {\n      name: 'Правосторонний',\n      description: 'Все панели справа',\n      config: {\n        ...DEFAULT_LAYOUT,\n        sidebarPosition: 'right' as const,\n        propertiesPosition: 'right' as const,\n        panelSizes: { sidebar: 25, properties: 25, canvas: 50 }\n      }\n    }\n  ];\n\n  if (!isVisible) {\n    return (\n      <Button\n        variant=\"outline\"\n        size=\"sm\"\n        onClick={() => setIsVisible(true)}\n        className=\"fixed bottom-4 right-4 z-50 bg-background/80 backdrop-blur-sm border-2 border-primary/20 hover:border-primary/40 transition-all duration-200\"\n      >\n        <Layout className=\"h-4 w-4 mr-2\" />\n        Настройки макета\n      </Button>\n    );\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Layout className=\"h-5 w-5\" />\n                Настройки макета интерфейса\n              </CardTitle>\n              <CardDescription>\n                Настройте расположение элементов интерфейса под свои потребности\n              </CardDescription>\n            </div>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setIsVisible(false)}\n            >\n              ✕\n            </Button>\n          </div>\n        </CardHeader>\n        \n        <CardContent className=\"space-y-6\">\n          {/* Быстрые пресеты */}\n          <div>\n            <h3 className=\"text-lg font-semibold mb-3\">Быстрые пресеты</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3\">\n              {presets.map((preset, index) => (\n                <Card \n                  key={index}\n                  className=\"cursor-pointer hover:border-primary/50 transition-colors\"\n                  onClick={() => onConfigChange(preset.config)}\n                >\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-sm\">{preset.name}</CardTitle>\n                    <CardDescription className=\"text-xs\">\n                      {preset.description}\n                    </CardDescription>\n                  </CardHeader>\n                </Card>\n              ))}\n            </div>\n          </div>\n\n          <Separator />\n\n          {/* Детальные настройки */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            \n            {/* Позиция шапки */}\n            <div className=\"space-y-3\">\n              <Label className=\"text-sm font-medium flex items-center gap-2\">\n                <Navigation className=\"h-4 w-4\" />\n                Позиция шапки\n              </Label>\n              <Select \n                value={config.headerPosition} \n                onValueChange={(value) => handleConfigUpdate('headerPosition', value)}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"top\">\n                    <div className=\"flex items-center gap-2\">\n                      <ArrowUp className=\"h-4 w-4\" />\n                      Сверху\n                    </div>\n                  </SelectItem>\n                  <SelectItem value=\"bottom\">\n                    <div className=\"flex items-center gap-2\">\n                      <ArrowDown className=\"h-4 w-4\" />\n                      Снизу\n                    </div>\n                  </SelectItem>\n                  <SelectItem value=\"left\">\n                    <div className=\"flex items-center gap-2\">\n                      <ArrowLeft className=\"h-4 w-4\" />\n                      Слева\n                    </div>\n                  </SelectItem>\n                  <SelectItem value=\"right\">\n                    <div className=\"flex items-center gap-2\">\n                      <ArrowRight className=\"h-4 w-4\" />\n                      Справа\n                    </div>\n                  </SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Позиция боковой панели */}\n            <div className=\"space-y-3\">\n              <Label className=\"text-sm font-medium flex items-center gap-2\">\n                <Sidebar className=\"h-4 w-4\" />\n                Боковая панель (компоненты)\n              </Label>\n              <Select \n                value={config.sidebarPosition} \n                onValueChange={(value) => handleConfigUpdate('sidebarPosition', value)}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"left\">\n                    <div className=\"flex items-center gap-2\">\n                      <ArrowLeft className=\"h-4 w-4\" />\n                      Слева\n                    </div>\n                  </SelectItem>\n                  <SelectItem value=\"right\">\n                    <div className=\"flex items-center gap-2\">\n                      <ArrowRight className=\"h-4 w-4\" />\n                      Справа\n                    </div>\n                  </SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Позиция панели свойств */}\n            <div className=\"space-y-3\">\n              <Label className=\"text-sm font-medium flex items-center gap-2\">\n                <Settings className=\"h-4 w-4\" />\n                Панель свойств\n              </Label>\n              <Select \n                value={config.propertiesPosition} \n                onValueChange={(value) => handleConfigUpdate('propertiesPosition', value)}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"left\">\n                    <div className=\"flex items-center gap-2\">\n                      <ArrowLeft className=\"h-4 w-4\" />\n                      Слева\n                    </div>\n                  </SelectItem>\n                  <SelectItem value=\"right\">\n                    <div className=\"flex items-center gap-2\">\n                      <ArrowRight className=\"h-4 w-4\" />\n                      Справа\n                    </div>\n                  </SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Дополнительные настройки */}\n            <div className=\"space-y-3\">\n              <Label className=\"text-sm font-medium\">Дополнительно</Label>\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"compact\" className=\"text-sm\">Компактный режим</Label>\n                  <Switch\n                    id=\"compact\"\n                    checked={config.compactMode}\n                    onCheckedChange={(checked) => handleConfigUpdate('compactMode', checked)}\n                  />\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"fullscreen\" className=\"text-sm\">Полноэкранный холст</Label>\n                  <Switch\n                    id=\"fullscreen\"\n                    checked={config.canvasFullscreen}\n                    onCheckedChange={(checked) => handleConfigUpdate('canvasFullscreen', checked)}\n                  />\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"grid\" className=\"text-sm\">Показать сетку</Label>\n                  <Switch\n                    id=\"grid\"\n                    checked={config.showGrid}\n                    onCheckedChange={(checked) => handleConfigUpdate('showGrid', checked)}\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Размеры панелей */}\n          <div className=\"space-y-3\">\n            <Label className=\"text-sm font-medium\">Размеры панелей (%)</Label>\n            <div className=\"grid grid-cols-3 gap-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-xs\">Боковая панель</Label>\n                <div className=\"flex items-center gap-2\">\n                  <input\n                    type=\"range\"\n                    min=\"10\"\n                    max=\"40\"\n                    value={config.panelSizes.sidebar}\n                    onChange={(e) => handlePanelSizeUpdate('sidebar', parseInt(e.target.value))}\n                    className=\"flex-1\"\n                  />\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    {config.panelSizes.sidebar}%\n                  </Badge>\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label className=\"text-xs\">Холст</Label>\n                <div className=\"flex items-center gap-2\">\n                  <input\n                    type=\"range\"\n                    min=\"30\"\n                    max=\"80\"\n                    value={config.panelSizes.canvas}\n                    onChange={(e) => handlePanelSizeUpdate('canvas', parseInt(e.target.value))}\n                    className=\"flex-1\"\n                  />\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    {config.panelSizes.canvas}%\n                  </Badge>\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label className=\"text-xs\">Панель свойств</Label>\n                <div className=\"flex items-center gap-2\">\n                  <input\n                    type=\"range\"\n                    min=\"15\"\n                    max=\"40\"\n                    value={config.panelSizes.properties}\n                    onChange={(e) => handlePanelSizeUpdate('properties', parseInt(e.target.value))}\n                    className=\"flex-1\"\n                  />\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    {config.panelSizes.properties}%\n                  </Badge>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <Separator />\n\n          {/* Кнопки действий */}\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={onReset}\n              >\n                <RotateCcw className=\"h-4 w-4 mr-2\" />\n                Сброс\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setPreviewMode(!previewMode)}\n              >\n                <Maximize className=\"h-4 w-4 mr-2\" />\n                {previewMode ? 'Скрыть превью' : 'Превью'}\n              </Button>\n            </div>\n            <div className=\"flex items-center gap-3\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setIsVisible(false)}\n              >\n                Отмена\n              </Button>\n              <Button\n                onClick={() => {\n                  onApply();\n                  setIsVisible(false);\n                }}\n              >\n                Применить\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\n// Хук для управления настройками макета\nexport function useLayoutManager() {\n  const [config, setConfig] = useState<LayoutConfig>(() => {\n    const saved = localStorage.getItem('telegram-bot-builder-layout');\n    return saved ? JSON.parse(saved) : DEFAULT_LAYOUT;\n  });\n\n  const saveConfig = (newConfig: LayoutConfig) => {\n    setConfig(newConfig);\n    localStorage.setItem('telegram-bot-builder-layout', JSON.stringify(newConfig));\n  };\n\n  const resetConfig = () => {\n    setConfig(DEFAULT_LAYOUT);\n    localStorage.removeItem('telegram-bot-builder-layout');\n  };\n\n  const applyConfig = () => {\n    // Дополнительная логика применения настроек\n    console.log('Applying layout config:', config);\n  };\n\n  return {\n    config,\n    updateConfig: saveConfig,\n    resetConfig,\n    applyConfig\n  };\n}","size_bytes":16279},"client/src/components/ui/enhanced-connection-line.tsx":{"content":"import { useMemo } from 'react';\nimport { Connection, Node } from '@/types/bot';\nimport { Badge } from '@/components/ui/badge';\nimport { \n  ArrowRight, \n  Mouse, \n  Terminal, \n  ExternalLink, \n  AlertCircle \n} from 'lucide-react';\n\ninterface EnhancedConnectionLineProps {\n  connection: Connection;\n  nodes: Node[];\n  isSelected?: boolean;\n  onClick?: () => void;\n  onDelete?: () => void;\n  showButtonInfo?: boolean;\n}\n\nexport function EnhancedConnectionLine({ \n  connection, \n  nodes, \n  isSelected, \n  onClick, \n  onDelete,\n  showButtonInfo = true\n}: EnhancedConnectionLineProps) {\n  const { path, midPoint, distance, buttonInfo, hasButton } = useMemo(() => {\n    const sourceNode = nodes.find(n => n.id === connection.source);\n    const targetNode = nodes.find(n => n.id === connection.target);\n    \n    if (!sourceNode || !targetNode) {\n      return { \n        path: '', \n        midPoint: { x: 0, y: 0 }, \n        distance: 0, \n        buttonInfo: null, \n        hasButton: false \n      };\n    }\n\n    // Расчет позиций узлов\n    const baseWidth = 320;\n    const baseHeight = 200;\n    \n    const sourceButtonHeight = sourceNode.data.buttons && sourceNode.data.buttons.length > 0 ? \n      (sourceNode.data.keyboardType === 'inline' ? \n        Math.ceil(sourceNode.data.buttons.length / 2) * 50 : \n        sourceNode.data.buttons.length * 40) : 0;\n    \n    const targetButtonHeight = targetNode.data.buttons && targetNode.data.buttons.length > 0 ? \n      (targetNode.data.keyboardType === 'inline' ? \n        Math.ceil(targetNode.data.buttons.length / 2) * 50 : \n        targetNode.data.buttons.length * 40) : 0;\n\n    const sourceHeight = baseHeight + sourceButtonHeight;\n    const targetHeight = baseHeight + targetButtonHeight;\n\n    // Позиции точек соединения\n    const sourceX = sourceNode.position.x + baseWidth + 8;\n    const sourceY = sourceNode.position.y + sourceHeight / 2;\n    const targetX = targetNode.position.x - 8;\n    const targetY = targetNode.position.y + targetHeight / 2;\n\n    // Расчет кривой Безье\n    const deltaX = targetX - sourceX;\n    const deltaY = targetY - sourceY;\n    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n    \n    let controlPointOffset = Math.min(Math.abs(deltaX) / 2, Math.max(80, distance * 0.3));\n    \n    if (Math.abs(deltaY) > Math.abs(deltaX)) {\n      controlPointOffset = Math.max(controlPointOffset, 120);\n    }\n\n    const controlPoint1X = sourceX + controlPointOffset;\n    const controlPoint1Y = sourceY;\n    const controlPoint2X = targetX - controlPointOffset;\n    const controlPoint2Y = targetY;\n\n    const path = `M ${sourceX} ${sourceY} C ${controlPoint1X} ${controlPoint1Y}, ${controlPoint2X} ${controlPoint2Y}, ${targetX} ${targetY}`;\n    \n    // Средняя точка кривой\n    const t = 0.5;\n    const midX = Math.pow(1-t, 3) * sourceX + 3 * Math.pow(1-t, 2) * t * controlPoint1X + 3 * (1-t) * Math.pow(t, 2) * controlPoint2X + Math.pow(t, 3) * targetX;\n    const midY = Math.pow(1-t, 3) * sourceY + 3 * Math.pow(1-t, 2) * t * controlPoint1Y + 3 * (1-t) * Math.pow(t, 2) * controlPoint2Y + Math.pow(t, 3) * targetY;\n\n    const midPoint = { x: midX, y: midY };\n\n    // Поиск связанной кнопки\n    const relatedButton = sourceNode.data.buttons ? sourceNode.data.buttons.find(button => \n      button.action === 'goto' && button.target === connection.target\n    ) : undefined;\n\n    const buttonInfo = relatedButton ? {\n      text: relatedButton.text,\n      action: relatedButton.action,\n      hasButton: true\n    } : null;\n\n    return { path, midPoint, distance, buttonInfo, hasButton: !!relatedButton };\n  }, [connection, nodes]);\n\n  if (!path) return null;\n\n  const getActionIcon = (action: string) => {\n    switch (action) {\n      case 'goto': return <ArrowRight className=\"h-3 w-3\" />;\n      case 'command': return <Terminal className=\"h-3 w-3\" />;\n      case 'url': return <ExternalLink className=\"h-3 w-3\" />;\n      default: return <Mouse className=\"h-3 w-3\" />;\n    }\n  };\n\n  const getConnectionType = () => {\n    const sourceNode = nodes.find(n => n.id === connection.source);\n    // Проверяем автопереход\n    if (sourceNode?.data.autoTransitionTo === connection.target) {\n      return 'auto-transition';\n    }\n    if (hasButton) return 'button';\n    return 'direct';\n  };\n\n  const connectionType = getConnectionType();\n\n  return (\n    <g className=\"connection-line\">\n      {/* Невидимая толстая линия для кликов */}\n      <path\n        d={path}\n        stroke=\"transparent\"\n        strokeWidth=\"20\"\n        fill=\"none\"\n        className=\"cursor-pointer\"\n        onClick={onClick}\n      />\n      \n      {/* Основная линия */}\n      <path\n        d={path}\n        stroke={\n          isSelected \n            ? \"hsl(var(--primary))\" \n            : connectionType === 'auto-transition'\n              ? \"#10b981\"\n              : connectionType === 'button' \n                ? \"hsl(var(--green-500))\" \n                : \"hsl(var(--muted-foreground))\"\n        }\n        strokeWidth={isSelected ? \"3\" : \"2\"}\n        fill=\"none\"\n        strokeDasharray={\n          connectionType === 'auto-transition'\n            ? \"8,4\"\n            : connectionType === 'button' \n              ? \"none\" \n              : \"5,5\"\n        }\n        className={`\n          transition-all duration-300\n          ${isSelected ? 'drop-shadow-md' : ''}\n          ${connectionType === 'button' || connectionType === 'auto-transition' ? 'opacity-100' : 'opacity-70'}\n        `}\n        markerEnd=\"url(#arrowhead)\"\n      />\n      \n      {/* Стрелка */}\n      <defs>\n        <marker\n          id=\"arrowhead\"\n          markerWidth=\"10\"\n          markerHeight=\"7\"\n          refX=\"9\"\n          refY=\"3.5\"\n          orient=\"auto\"\n        >\n          <polygon\n            points=\"0 0, 10 3.5, 0 7\"\n            fill={\n              isSelected \n                ? \"hsl(var(--primary))\" \n                : connectionType === 'auto-transition'\n                  ? \"#10b981\"\n                  : connectionType === 'button' \n                    ? \"hsl(var(--green-500))\" \n                    : \"hsl(var(--muted-foreground))\"\n            }\n          />\n        </marker>\n      </defs>\n\n      {/* Информация о кнопке или автопереходе */}\n      {showButtonInfo && (\n        <foreignObject\n          x={midPoint.x - 60}\n          y={midPoint.y - 15}\n          width=\"120\"\n          height=\"30\"\n          className=\"pointer-events-none\"\n        >\n          <div className=\"flex items-center justify-center h-full\">\n            {connectionType === 'auto-transition' ? (\n              <Badge \n                variant=\"secondary\" \n                className=\"text-xs bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200 flex items-center gap-1\"\n              >\n                <ArrowRight className=\"h-3 w-3\" />\n                <span>Авто</span>\n              </Badge>\n            ) : buttonInfo ? (\n              <Badge \n                variant=\"secondary\" \n                className=\"text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 flex items-center gap-1\"\n              >\n                {getActionIcon(buttonInfo.action)}\n                <span className=\"truncate max-w-16\">{buttonInfo.text}</span>\n              </Badge>\n            ) : (\n              <Badge \n                variant=\"outline\" \n                className=\"text-xs bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 flex items-center gap-1\"\n              >\n                <AlertCircle className=\"h-3 w-3\" />\n                <span>Нет кнопки</span>\n              </Badge>\n            )}\n          </div>\n        </foreignObject>\n      )}\n\n      {/* Кнопка удаления */}\n      {isSelected && onDelete && (\n        <foreignObject\n          x={midPoint.x + 65}\n          y={midPoint.y - 12}\n          width=\"24\"\n          height=\"24\"\n          className=\"pointer-events-auto\"\n        >\n          <button\n            onClick={(e) => {\n              e.stopPropagation();\n              onDelete();\n            }}\n            className=\"w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-xs transition-colors\"\n            title=\"Удалить соединение\"\n          >\n            ×\n          </button>\n        </foreignObject>\n      )}\n\n      {/* Индикатор типа соединения */}\n      <circle\n        cx={midPoint.x}\n        cy={midPoint.y}\n        r=\"4\"\n        fill={\n          connectionType === 'auto-transition'\n            ? \"#10b981\"\n            : connectionType === 'button' \n              ? \"hsl(var(--green-500))\" \n              : \"hsl(var(--yellow-500))\"\n        }\n        stroke=\"white\"\n        strokeWidth=\"2\"\n        className={`\n          transition-all duration-300\n          ${isSelected ? 'r-6' : 'r-4'}\n          cursor-pointer\n        `}\n        onClick={onClick}\n      />\n    </g>\n  );\n}","size_bytes":9055},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"replit.md":{"content":"# Telegram Bot Builder\n\n## Overview\nThis application provides a visual Telegram bot builder, enabling users to create bots via a drag-and-drop interface. It's a full-stack web application with a React frontend and Express.js backend, offering real-time bot preview and Python code generation. The business vision is to democratize bot creation, allowing individuals and small businesses to rapidly deploy sophisticated Telegram bots without coding expertise, tapping into the growing demand for automated communication solutions. The project aims to be the leading no-code platform for Telegram bot development.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend\n- **Framework**: React 18 with TypeScript\n- **Build Tool**: Vite\n- **UI Components**: Shadcn/ui (built on Radix UI)\n- **Styling**: Tailwind CSS with CSS variables for theming, supporting comprehensive dark theme.\n- **State Management**: React hooks\n- **Data Fetching**: TanStack Query\n- **Routing**: Wouter\n- **Design Philosophy**: Responsive design, intuitive drag-and-drop interface, interactive elements, consistent theming. Enhanced visual effects and animations for canvas and UI elements.\n\n### Backend\n- **Runtime**: Node.js with Express.js\n- **Language**: TypeScript (ES modules)\n- **Database**: PostgreSQL with Drizzle ORM\n- **Session Storage**: PostgreSQL-based session storage\n- **API**: RESTful JSON API\n- **Key Features**:\n    - **Bot Editor Core**: Canvas-based visual flow editor with various node types (start, message, photo, keyboard, condition, command). Real-time property editing and a component sidebar.\n    - **Bot Preview System**: Live, interactive bot simulation with message flow and button interaction testing.\n    - **Code Generation**: Converts visual flows to aiogram (Python) code. Includes validation and export options (copy/download). Generates syntactically correct Python code, handling boolean conversions, indentation, and various node types.\n    - **Storage System**: Persistent storage of bot projects using a PostgreSQL database with JSON flow storage. Supports in-memory fallback for development.\n    - **Bot Execution**: Manages bot instances with start/stop controls, real-time status monitoring, and Python process management. Handles bot token storage securely.\n    - **Template System**: Advanced template management with metadata (difficulty, author, usage, rating), category filtering, search, and a redesigned tabbed interface.\n    - **Connection Management**: Dedicated interface for managing connections, offering intelligent suggestions, validation rules, and visualization.\n    - **Media Handling**: Comprehensive support for various media types (photo, video, audio, document) with file optimization, preview, and local file support.\n    - **Geolocation**: Supports integration with mapping services (Yandex, Google Maps, 2GIS) for coordinate extraction and route generation.\n    - **User Input & Data Collection**: Dedicated node type for collecting user input (text, number, email, phone, media) with validation, persistence, and support for button-based answers (single/multiple choice) with customizable navigation.\n    - **Conditional Messaging**: Advanced logic for conditional messages based on user data, with intelligent variable replacement and dynamic next node navigation.\n    - **Text Formatting**: Works like Telegram Web, with hotkeys and toggle functionality for Markdown and HTML formatting. Auto-detects and applies `ParseMode`.\n    - **User Database & Analytics**: Automatically collects user data (username, first_name, last_name, registration) and command statistics in PostgreSQL. Provides a UI for viewing user responses and stats.\n    - **Message History & Media Persistence**: Complete message tracking system with photo/video/audio/document persistence. Uses junction table (bot_message_media) for many-to-many relationships, downloads Telegram media via Bot API, stores in uploads/{projectId}/ with path traversal protection. Universal @dp.message(F.photo) handler catches all photos regardless of flow design. API returns enriched messages with media[] arrays.\n    - **Undo/Redo System**: Comprehensive undo/redo system with 50-state history limit, canvas toolbar integration, and keyboard shortcuts (Ctrl+Z, Ctrl+Y, Ctrl+Shift+Z).\n    - **Auto-Transition System**: Allows nodes to automatically proceed to the next node without waiting for button clicks or user input. Nodes can specify an `autoTransitionTo` field that triggers immediate navigation after sending content. Visual distinction with dotted emerald connection lines (#10b981). Implemented across message, photo, video, and audio node types. Only available when node has no buttons and no input collection enabled.\n\n### Data Flow\nUser changes in the visual editor are immediately reflected in the bot's data structure, which is then persisted to the database via API. The preview mode allows real-time testing, and the validated bot structure can be exported as Python code.\n\n## External Dependencies\n\n### Frontend Libraries\n- **UI Framework**: React\n- **Component Library**: Radix UI, Shadcn/ui\n- **Icons**: Lucide React\n- **Form Handling**: React Hook Form, Zod\n- **Date Utilities**: date-fns\n- **Styling**: Tailwind CSS, class-variance-authority\n\n### Backend Libraries\n- **Web Framework**: Express.js\n- **Database ORM**: Drizzle ORM\n- **PostgreSQL Driver**: @neondatabase/serverless (or standard node-postgres)\n- **Validation**: Zod\n- **Session Management**: express-session, connect-pg-simple\n- **Python Execution**: tsx (for development)\n\n### Python Bot Dependencies (Generated Code)\n- **Telegram Bot API**: aiogram\n- **HTTP Client**: aiohttp\n- **HTTP Requests**: requests\n- **PostgreSQL Client**: asyncpg","size_bytes":5785},"client/src/lib/bot-generator.ts":{"content":"import { BotData, Node, BotGroup } from '@shared/schema';\nimport { generateBotFatherCommands } from './commands';\n\n// Функция для сбора всех узлов и связей из всех листов проекта\nfunction extractNodesAndConnections(botData: BotData) {\n  if (!botData) return { nodes: [], connections: [] };\n  \n  if ((botData as any).sheets && Array.isArray((botData as any).sheets)) {\n    // Многолистовой проект - собираем узлы и связи из всех листов\n    let allNodes: any[] = [];\n    let allConnections: any[] = [];\n    \n    (botData as any).sheets.forEach((sheet: any) => {\n      if (sheet.nodes && Array.isArray(sheet.nodes)) {\n        allNodes = allNodes.concat(sheet.nodes);\n      }\n      if (sheet.connections && Array.isArray(sheet.connections)) {\n        allConnections = allConnections.concat(sheet.connections);\n      }\n    });\n    \n    return { nodes: allNodes, connections: allConnections };\n  } else {\n    // Обычный проект\n    return { \n      nodes: botData.nodes || [], \n      connections: botData.connections || [] \n    };\n  }\n}\n\n// Функция для создания безопасного имени функции Python\nfunction createSafeFunctionName(nodeId: string): string {\n  let safeName = nodeId.replace(/[^a-zA-Z0-9_]/g, '_');\n  // Python функции не могут начинаться с цифры\n  if (/^\\d/.test(safeName)) {\n    safeName = 'node_' + safeName;\n  }\n  return safeName;\n}\n\n// Функция для правильного экранирования строк в Python коде\nfunction escapeForPython(text: string): string {\n  return text.replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\r').replace(/\\t/g, '\\\\t');\n}\n\n// Функция для удаления HTML тегов из текста\nfunction stripHtmlTags(text: string): string {\n  if (!text) return text;\n  return text.replace(/<[^>]*>/g, '');\n}\n\n// Функция для правильного форматирования текста с поддержкой многострочности\nfunction formatTextForPython(text: string): string {\n  if (!text) return '\"\"';\n  \n  // Для многострочного текста используем тройные кавычки\n  if (text.includes('\\n')) {\n    return `\"\"\"${text}\"\"\"`;\n  } else {\n    // Для однострочного текста экранируем только кавычки\n    return `\"${text.replace(/\"/g, '\\\\\"')}\"`;\n  }\n}\n\n// Функция для получения режима парсинга\nfunction getParseMode(formatMode: string): string {\n  if (formatMode === 'html') {\n    return ', parse_mode=ParseMode.HTML';\n  } else if (formatMode === 'markdown') {\n    return ', parse_mode=ParseMode.MARKDOWN';\n  }\n  return '';\n}\n\n// Функция для проверки наличия геолокационных элементов в боте\nfunction hasLocationFeatures(nodes: Node[]): boolean {\n  if (!nodes || nodes.length === 0) return false;\n  \n  // Проверяем наличие узлов типа location\n  const hasLocationNode = nodes.some(node => node.type === 'location');\n  \n  // Проверяем наличие кнопок с requestLocation\n  const hasLocationButton = nodes.some(node => {\n    const buttons = node.data.buttons;\n    if (!buttons || !Array.isArray(buttons)) return false;\n    return buttons.some((button: any) => \n      button.action === 'location' && button.requestLocation\n    );\n  });\n  \n  return hasLocationNode || hasLocationButton;\n}\n\n// Функция для генерации текста кнопки с поддержкой переменных\nfunction generateButtonText(buttonText: string): string {\n  // Проверяем, есть ли в тексте переменные (паттерн {переменная})\n  if (buttonText.includes('{') && buttonText.includes('}')) {\n    // Экранируем текст для Python и оборачиваем в replace_variables_in_text\n    const escapedText = escapeForPython(buttonText);\n    return `replace_variables_in_text(\"${escapedText}\", user_vars)`;\n  } else {\n    // Обычный текст без переменных\n    return `\"${escapeForPython(buttonText)}\"`;\n  }\n}\n\n// Функция для проверки наличия узлов с множественным выбором\nfunction hasMultiSelectNodes(nodes: Node[]): boolean {\n  if (!nodes || nodes.length === 0) return false;\n  return nodes.some(node => node.data.allowMultipleSelection);\n}\n\n// Функция для проверки наличия inline кнопок (callback)\nfunction hasInlineButtons(nodes: Node[]): boolean {\n  if (!nodes || nodes.length === 0) return false;\n  return nodes.some(node => node.data.keyboardType === 'inline' && node.data.buttons && node.data.buttons.length > 0);\n}\n\n// Функция для проверки наличия узлов со сбором пользовательского ввода\nfunction hasInputCollection(nodes: Node[]): boolean {\n  if (!nodes || nodes.length === 0) return false;\n  \n  // Проверяем узлы с collectUserInput\n  const hasCollectInput = nodes.some(node => node.data.collectUserInput);\n  \n  // Проверяем узлы с enableTextInput\n  const hasTextInput = nodes.some(node => node.data.enableTextInput);\n  \n  // Проверяем узлы с enablePhotoInput\n  const hasPhotoInput = nodes.some(node => node.data.enablePhotoInput);\n  \n  // Проверяем узлы с enableVideoInput\n  const hasVideoInput = nodes.some(node => node.data.enableVideoInput);\n  \n  // Проверяем узлы с enableAudioInput\n  const hasAudioInput = nodes.some(node => node.data.enableAudioInput);\n  \n  // Проверяем узлы с enableDocumentInput\n  const hasDocumentInput = nodes.some(node => node.data.enableDocumentInput);\n  \n  // Проверяем условные сообщения с waitForTextInput\n  const hasConditionalInput = nodes.some(node => {\n    const conditions = node.data.conditionalMessages;\n    if (!conditions || !Array.isArray(conditions)) return false;\n    return conditions.some((cond: any) => cond.waitForTextInput);\n  });\n  \n  return hasCollectInput || hasTextInput || hasPhotoInput || hasVideoInput || hasAudioInput || hasDocumentInput || hasConditionalInput;\n}\n\n// Функция для проверки наличия медиа-файлов\nfunction hasMediaNodes(nodes: Node[]): boolean {\n  if (!nodes || nodes.length === 0) return false;\n  return nodes.some(node => \n    node.type === 'photo' || \n    node.type === 'video' || \n    node.type === 'audio' || \n    node.type === 'document' ||\n    node.type === 'animation'\n  );\n}\n\n// Функция для проверки наличия условных кнопок с callback_data формата \"conditional_\"\nfunction hasConditionalButtons(nodes: Node[]): boolean {\n  if (!nodes || nodes.length === 0) return false;\n  \n  return nodes.some(node => {\n    const conditions = node.data.conditionalMessages;\n    if (!conditions || !Array.isArray(conditions)) return false;\n    \n    return conditions.some((cond: any) => {\n      if (!cond.buttons || !Array.isArray(cond.buttons)) return false;\n      // Проверяем, есть ли кнопки команд в условных сообщениях с переменными\n      return cond.buttons.some((button: any) => \n        button.action === 'command' && (cond.variableName || cond.variableNames)\n      );\n    });\n  });\n}\n\n// Функция для проверки наличия кнопок команд\nfunction hasCommandButtons(nodes: Node[]): boolean {\n  if (!nodes || nodes.length === 0) return false;\n  \n  // Проверяем обычные кнопки\n  const hasRegularCommandButtons = nodes.some(node => {\n    if (!node.data.buttons || !Array.isArray(node.data.buttons)) return false;\n    return node.data.buttons.some((button: any) => button.action === 'command');\n  });\n  \n  // Проверяем кнопки в условных сообщениях (но не те, что создают conditional_ callbacks)\n  const hasConditionalCommandButtons = nodes.some(node => {\n    const conditions = node.data.conditionalMessages;\n    if (!conditions || !Array.isArray(conditions)) return false;\n    \n    return conditions.some((cond: any) => {\n      if (!cond.buttons || !Array.isArray(cond.buttons)) return false;\n      // Только кнопки команд БЕЗ переменных (они не создают conditional_ callbacks)\n      return cond.buttons.some((button: any) => \n        button.action === 'command' && !cond.variableName && !cond.variableNames\n      );\n    });\n  });\n  \n  return hasRegularCommandButtons || hasConditionalCommandButtons;\n}\n\n// Функция для сбора всех медиапеременных из узлов\nfunction collectMediaVariables(nodes: Node[]): Map<string, { type: string; variable: string }> {\n  const mediaVars = new Map<string, { type: string; variable: string }>();\n  \n  if (!nodes || nodes.length === 0) return mediaVars;\n  \n  nodes.forEach(node => {\n    // Собираем переменные из узлов с фото\n    if (node.data.enablePhotoInput && node.data.photoInputVariable) {\n      mediaVars.set(node.data.photoInputVariable, {\n        type: 'photo',\n        variable: node.data.photoInputVariable\n      });\n    }\n    \n    // Собираем переменные из узлов с видео\n    if (node.data.enableVideoInput && node.data.videoInputVariable) {\n      mediaVars.set(node.data.videoInputVariable, {\n        type: 'video',\n        variable: node.data.videoInputVariable\n      });\n    }\n    \n    // Собираем переменные из узлов с аудио\n    if (node.data.enableAudioInput && node.data.audioInputVariable) {\n      mediaVars.set(node.data.audioInputVariable, {\n        type: 'audio',\n        variable: node.data.audioInputVariable\n      });\n    }\n    \n    // Собираем переменные из узлов с документами\n    if (node.data.enableDocumentInput && node.data.documentInputVariable) {\n      mediaVars.set(node.data.documentInputVariable, {\n        type: 'document',\n        variable: node.data.documentInputVariable\n      });\n    }\n  });\n  \n  return mediaVars;\n}\n\n// Функция для поиска медиапеременных в тексте сообщения\nfunction findMediaVariablesInText(text: string, mediaVariables: Map<string, { type: string; variable: string }>): Array<{ variable: string; type: string }> {\n  if (!text || mediaVariables.size === 0) return [];\n  \n  const foundMedia: Array<{ variable: string; type: string }> = [];\n  \n  // Регулярное выражение для поиска переменных формата {variable_name}\n  const variableRegex = /\\{([a-zA-Z_][a-zA-Z0-9_]*)\\}/g;\n  let match;\n  \n  while ((match = variableRegex.exec(text)) !== null) {\n    const variableName = match[1];\n    const mediaInfo = mediaVariables.get(variableName);\n    \n    if (mediaInfo) {\n      // Проверяем, не добавили ли мы уже эту переменную\n      if (!foundMedia.some(m => m.variable === variableName)) {\n        foundMedia.push({\n          variable: variableName,\n          type: mediaInfo.type\n        });\n      }\n    }\n  }\n  \n  return foundMedia;\n}\n\n// Функция для конвертации JavaScript boolean в Python boolean\nfunction toPythonBoolean(value: any): string {\n  return value ? 'True' : 'False';\n}\n\n// Функция для генерации кода установки состояния ожидания ввода\n// Автоматически определяет правильное состояние (waiting_for_photo, waiting_for_video и т.д.)\nfunction generateWaitingStateCode(node: any, indentLevel: string = '    '): string {\n  // Определяем тип ввода и соответствующее состояние\n  let waitingStateKey = 'waiting_for_input';\n  let inputType = node.data.inputType || 'text';\n  let inputVariable = node.data.inputVariable || `response_${node.id}`;\n  \n  // Проверяем медиа-типы и устанавливаем правильное состояние\n  if (node.data.enablePhotoInput) {\n    waitingStateKey = 'waiting_for_photo';\n    inputType = 'photo';\n    inputVariable = node.data.photoInputVariable || 'user_photo';\n  } else if (node.data.enableVideoInput) {\n    waitingStateKey = 'waiting_for_video';\n    inputType = 'video';\n    inputVariable = node.data.videoInputVariable || 'user_video';\n  } else if (node.data.enableAudioInput) {\n    waitingStateKey = 'waiting_for_audio';\n    inputType = 'audio';\n    inputVariable = node.data.audioInputVariable || 'user_audio';\n  } else if (node.data.enableDocumentInput) {\n    waitingStateKey = 'waiting_for_document';\n    inputType = 'document';\n    inputVariable = node.data.documentInputVariable || 'user_document';\n  }\n  \n  const inputTargetNodeId = node.data.inputTargetNodeId || '';\n  \n  let code = '';\n  code += `${indentLevel}user_data[message.from_user.id] = user_data.get(message.from_user.id, {})\\n`;\n  code += `${indentLevel}user_data[message.from_user.id][\"${waitingStateKey}\"] = {\\n`;\n  code += `${indentLevel}    \"type\": \"${inputType}\",\\n`;\n  code += `${indentLevel}    \"variable\": \"${inputVariable}\",\\n`;\n  code += `${indentLevel}    \"save_to_database\": True,\\n`;\n  code += `${indentLevel}    \"node_id\": \"${node.id}\",\\n`;\n  code += `${indentLevel}    \"next_node_id\": \"${inputTargetNodeId}\",\\n`;\n  code += `${indentLevel}    \"min_length\": ${node.data.minLength || 0},\\n`;\n  code += `${indentLevel}    \"max_length\": ${node.data.maxLength || 0},\\n`;\n  code += `${indentLevel}    \"retry_message\": \"Пожалуйста, попробуйте еще раз.\",\\n`;\n  code += `${indentLevel}    \"success_message\": \"✅ Спасибо за ваш ответ!\"\\n`;\n  code += `${indentLevel}}\\n`;\n  code += `${indentLevel}logging.info(f\"✅ Состояние ожидания настроено: ${inputType} ввод для переменной ${inputVariable} (узел ${node.id})\")\\n`;\n  \n  return code;\n}\n\n// Функция для создания уникальных коротких ID для узлов\nfunction generateUniqueShortId(nodeId: string, allNodeIds: string[]): string {\n  if (!nodeId) return 'node';\n  \n  // Особая обработка для узлов интересов\n  if (nodeId.endsWith('_interests')) {\n    const prefix = nodeId.replace('_interests', '');\n    // Возвращаем первые 5-6 символов префикса для уникальности\n    return prefix.substring(0, Math.min(6, prefix.length));\n  }\n  \n  // Для метро и других узлов используем старую логику\n  const baseShortId = nodeId.slice(-10).replace(/^_+/, '');\n  \n  // Проверяем уникальность среди всех узлов\n  const conflicts = allNodeIds.filter(id => {\n    const otherShortId = id.slice(-10).replace(/^_+/, '');\n    return otherShortId === baseShortId && id !== nodeId;\n  });\n  \n  // Если конфликтов нет, возвращаем базовый ID\n  if (conflicts.length === 0) {\n    return baseShortId;\n  }\n  \n  // Если есть конфликты, берем более уникальную часть\n  return nodeId.replace(/[^a-zA-Z0-9]/g, '').slice(-8);\n}\n\n// Функция для правильного экранирования строк в JSON контексте\nfunction escapeForJsonString(text: string): string {\n  if (!text) return '';\n  return text.replace(/\\\\/g, '\\\\\\\\').replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\r').replace(/\\t/g, '\\\\t');\n}\n\n// Функция для вычисления оптимального количества колонок для кнопок\nfunction calculateOptimalColumns(buttons: any[], nodeData?: any): number {\n  if (!buttons || buttons.length === 0) return 1;\n  \n  const totalButtons = buttons.length;\n  \n  // Если это множественный выбор, всегда используем 2 колонки для красивого вида\n  if (nodeData?.allowMultipleSelection) {\n    return 2;\n  }\n  \n  // Стандартная логика для обычных кнопок\n  if (totalButtons >= 6) {\n    return 2; // Для 6+ кнопок - 2 колонки\n  } else if (totalButtons >= 3) {\n    return 1; // Для 3-5 кнопок - 1 колонка для удобочитаемости\n  } else {\n    return 1; // Для 1-2 кнопок - 1 колонка\n  }\n}\n\n// Функция для генерации inline клавиатуры с автоматической настройкой колонок\nfunction generateInlineKeyboardCode(buttons: any[], indentLevel: string, nodeId?: string, nodeData?: any, allNodeIds?: string[]): string {\n  if (!buttons || buttons.length === 0) return '';\n  \n  let code = '';\n  \n  // Проверяем, есть ли кнопки выбора (selection) - если да, то это множественный выбор\n  const hasSelectionButtons = buttons.some(button => button.action === 'selection');\n  const isMultipleSelection = nodeData?.allowMultipleSelection === true;\n  \n  // Если есть множественный выбор, добавляем инициализацию состояния\n  if (hasSelectionButtons && isMultipleSelection) {\n    console.log(`🔧 ГЕНЕРАТОР: ИНИЦИАЛИЗИРУЕМ состояние множественного выбора для узла ${nodeId}`);\n    const multiSelectVariable = nodeData?.multiSelectVariable || 'user_interests';\n    \n    code += `${indentLevel}# Инициализация состояния множественного выбора\\n`;\n    code += `${indentLevel}if user_id not in user_data:\\n`;\n    code += `${indentLevel}    user_data[user_id] = {}\\n`;\n    code += `${indentLevel}\\n`;\n    code += `${indentLevel}# Загружаем ранее выбранные варианты\\n`;\n    code += `${indentLevel}saved_selections = []\\n`;\n    code += `${indentLevel}if user_vars:\\n`;\n    code += `${indentLevel}    for var_name, var_data in user_vars.items():\\n`;\n    code += `${indentLevel}        if var_name == \"${multiSelectVariable}\":\\n`;\n    code += `${indentLevel}            if isinstance(var_data, dict) and \"value\" in var_data:\\n`;\n    code += `${indentLevel}                selections_str = var_data[\"value\"]\\n`;\n    code += `${indentLevel}            elif isinstance(var_data, str):\\n`;\n    code += `${indentLevel}                selections_str = var_data\\n`;\n    code += `${indentLevel}            else:\\n`;\n    code += `${indentLevel}                continue\\n`;\n    code += `${indentLevel}            if selections_str and selections_str.strip():\\n`;\n    code += `${indentLevel}                saved_selections = [sel.strip() for sel in selections_str.split(\",\") if sel.strip()]\\n`;\n    code += `${indentLevel}                break\\n`;\n    code += `${indentLevel}\\n`;\n    code += `${indentLevel}# Инициализируем состояние если его нет\\n`;\n    code += `${indentLevel}if \"multi_select_${nodeId}\" not in user_data[user_id]:\\n`;\n    code += `${indentLevel}    user_data[user_id][\"multi_select_${nodeId}\"] = saved_selections.copy()\\n`;\n    code += `${indentLevel}user_data[user_id][\"multi_select_node\"] = \"${nodeId}\"\\n`;\n    code += `${indentLevel}user_data[user_id][\"multi_select_type\"] = \"inline\"\\n`;\n    code += `${indentLevel}user_data[user_id][\"multi_select_variable\"] = \"${multiSelectVariable}\"\\n`;\n    code += `${indentLevel}logging.info(f\"Инициализировано состояние множественного выбора с {len(saved_selections)} элементами\")\\n`;\n    code += `${indentLevel}\\n`;\n  }\n  \n  code += `${indentLevel}builder = InlineKeyboardBuilder()\\n`;\n  \n  console.log(`🔧 ГЕНЕРАТОР: generateInlineKeyboardCode для узла ${nodeId}`);\n  console.log(`🔧 ГЕНЕРАТОР: nodeData.allowMultipleSelection = ${nodeData?.allowMultipleSelection}`);\n  console.log(`🔧 ГЕНЕРАТОР: hasSelectionButtons = ${hasSelectionButtons}, isMultipleSelection = ${isMultipleSelection}`);\n  console.log(`🔧 ГЕНЕРАТОР: continueButtonTarget = ${nodeData?.continueButtonTarget}`);\n  console.log(`🔧 ГЕНЕРАТОР: Полный объект nodeData:`, JSON.stringify(nodeData, null, 2));\n  console.log(`🔧 ГЕНЕРАТОР: Проверяем условие инициализации: hasSelectionButtons=${hasSelectionButtons} && isMultipleSelection=${isMultipleSelection}`);\n  console.log(`🔧 ГЕНЕРАТОР: Результат проверки: ${hasSelectionButtons && isMultipleSelection}`);\n  \n  buttons.forEach((button, index) => {\n    if (button.action === \"url\") {\n      code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, url=\"${button.url || '#'}\"))\\n`;\n    } else if (button.action === 'goto') {\n      const baseCallbackData = button.target || button.id || 'no_action';\n      // Для кнопок goto всегда используем target как callback_data без суффиксов\n      code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${baseCallbackData}\"))\\n`;\n    } else if (button.action === 'command') {\n      const commandCallback = `cmd_${button.target ? button.target.replace('/', '') : 'unknown'}`;\n      code += `${indentLevel}logging.info(f\"Создана кнопка команды: ${button.text} -> ${commandCallback}\")\\n`;\n      code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${commandCallback}\"))\\n`;\n    } else if (button.action === 'selection') {\n      // Укорачиваем callback_data для соблюдения лимита Telegram в 64 байта\n      const shortNodeId = nodeId ? generateUniqueShortId(nodeId, allNodeIds || []) : 'sel';\n      const shortTarget = button.target || button.id || 'btn'; // Используем полный target без обрезки для совместимости с обработчиком\n      const callbackData = `ms_${shortNodeId}_${shortTarget}`;\n      console.log(`🔧 ГЕНЕРАТОР: ИСПРАВЛЕНО! Создана кнопка selection: ${button.text} -> ${callbackData} (shortNodeId: ${shortNodeId}) (длина: ${callbackData.length})`);\n      \n      // Добавляем галочки для множественного выбора\n      console.log(`🔧 ГЕНЕРАТОР: 🔍 ПРОВЕРЯЕМ галочки для ${button.text}: isMultipleSelection=${isMultipleSelection}`);\n      if (isMultipleSelection) {\n        console.log(`🔧 ГЕНЕРАТОР: ✅ ДОБАВЛЯЕМ ГАЛОЧКИ для кнопки selection: ${button.text} (узел: ${nodeId})`);\n        console.log(`🔧 ГЕНЕРАТОР: 📋 ДАННЫЕ КНОПКИ: text=\"${button.text}\", target=\"${button.target}\", id=\"${button.id}\"`);\n        code += `${indentLevel}# Кнопка выбора с галочками: ${button.text}\\n`;\n        code += `${indentLevel}logging.info(f\"🔧 ПРОВЕРЯЕМ ГАЛОЧКУ: ищем '${button.text}' в списке: {user_data[user_id]['multi_select_${nodeId}']}\")\\n`;\n        code += `${indentLevel}selected_mark = \"✅ \" if \"${button.text}\" in user_data[user_id][\"multi_select_${nodeId}\"] else \"\"\\n`;\n        code += `${indentLevel}logging.info(f\"🔍 РЕЗУЛЬТАТ ГАЛОЧКИ для '${button.text}': selected_mark='{selected_mark}'\")\\n`;\n        code += `${indentLevel}final_text = f\"{selected_mark}${button.text}\"\\n`;\n        code += `${indentLevel}logging.info(f\"📱 СОЗДАЕМ КНОПКУ: text='{final_text}', callback_data='${callbackData}'\")\\n`;\n        code += `${indentLevel}builder.add(InlineKeyboardButton(text=final_text, callback_data=\"${callbackData}\"))\\n`;\n        console.log(`🔧 ГЕНЕРАТОР: ✅ СГЕНЕРИРОВАН КОД ГАЛОЧЕК для ${button.text} с детальным логированием`);\n      } else {\n        console.log(`🔧 ГЕНЕРАТОР: ❌ НЕ добавляем галочки для ${button.text} (isMultipleSelection=${isMultipleSelection})`);\n        code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${callbackData}\"))\\n`;\n      }\n    } else {\n      const callbackData = button.target || button.id || 'no_action';\n      code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${callbackData}\"))\\n`;\n    }\n  });\n  \n  // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: ДОБАВЛЯЕМ кнопку \"Готово\" для множественного выбора\n  if (hasSelectionButtons && isMultipleSelection) {\n    const continueText = nodeData?.continueButtonText || 'Готово';\n    const callbackData = `multi_select_done_${nodeId}`;\n    console.log(`🔧 ГЕНЕРАТОР: ✅ ДОБАВЛЯЕМ кнопку \"${continueText}\" для узла ${nodeId} с callback_data: ${callbackData}`);\n    code += `${indentLevel}# Добавляем кнопку \"Готово\" для множественного выбора\\n`;\n    code += `${indentLevel}builder.add(InlineKeyboardButton(text=\"${continueText}\", callback_data=\"${callbackData}\"))\\n`;\n  }\n  \n  // Автоматическое распределение колонок с учетом данных узла и кнопки \"Готово\"\n  let allButtons = [...buttons];\n  if (hasSelectionButtons && isMultipleSelection) {\n    // Добавляем виртуальную кнопку \"Готово\" для правильного подсчета колонок\n    allButtons.push({ text: nodeData?.continueButtonText || 'Готово' });\n  }\n  const columns = calculateOptimalColumns(allButtons, nodeData);\n  code += `${indentLevel}builder.adjust(${columns})\\n`;\n  code += `${indentLevel}keyboard = builder.as_markup()\\n`;\n  \n  return code;\n}\n\n// Функция для генерации замены переменных в тексте\nfunction generateVariableReplacement(variableName: string, indentLevel: string): string {\n  let code = '';\n  code += `${indentLevel}    # Подставляем значения переменных\\n`;\n  code += `${indentLevel}    if \"{${variableName}}\" in text:\\n`;\n  code += `${indentLevel}        if variable_value is not None:\\n`;\n  code += `${indentLevel}            text = text.replace(\"{${variableName}}\", str(variable_value))\\n`;\n  code += `${indentLevel}        else:\\n`;\n  code += `${indentLevel}            # Если переменная не найдена, отображаем как простой текст\\n`;\n  code += `${indentLevel}            text = text.replace(\"{${variableName}}\", \"${variableName}\")\\n`;\n  return code;\n}\n\n// Функция для генерации замены всех переменных в тексте\nfunction generateUniversalVariableReplacement(indentLevel: string): string {\n  let code = '';\n  code += `${indentLevel}# Подставляем все доступные переменные пользователя в текст\\n`;\n  code += `${indentLevel}user_vars = await get_user_from_db(user_id)\\n`;\n  code += `${indentLevel}if not user_vars:\\n`;\n  code += `${indentLevel}    user_vars = user_data.get(user_id, {})\\n`;\n  code += `${indentLevel}\\n`;\n  code += `${indentLevel}# get_user_from_db теперь возвращает уже обработанные user_data\\n`;\n  code += `${indentLevel}if not isinstance(user_vars, dict):\\n`;\n  code += `${indentLevel}    user_vars = {}\\n`;\n  code += `${indentLevel}\\n`;\n  code += `${indentLevel}# Заменяем все переменные в тексте\\n`;\n  code += `${indentLevel}import re\\n`;\n  code += `${indentLevel}def replace_variables_in_text(text_content, variables_dict):\\n`;\n  code += `${indentLevel}    if not text_content or not variables_dict:\\n`;\n  code += `${indentLevel}        return text_content\\n`;\n  code += `${indentLevel}    \\n`;\n  code += `${indentLevel}    for var_name, var_data in variables_dict.items():\\n`;\n  code += `${indentLevel}        placeholder = \"{\" + var_name + \"}\"\\n`;\n  code += `${indentLevel}        if placeholder in text_content:\\n`;\n  code += `${indentLevel}            if isinstance(var_data, dict) and \"value\" in var_data:\\n`;\n  code += `${indentLevel}                var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\\n`;\n  code += `${indentLevel}            elif var_data is not None:\\n`;\n  code += `${indentLevel}                var_value = str(var_data)\\n`;\n  code += `${indentLevel}            else:\\n`;\n  code += `${indentLevel}                var_value = var_name  # Показываем имя переменной если значения нет\\n`;\n  code += `${indentLevel}            text_content = text_content.replace(placeholder, var_value)\\n`;\n  code += `${indentLevel}    return text_content\\n`;\n  code += `${indentLevel}\\n`;\n  code += `${indentLevel}text = replace_variables_in_text(text, user_vars)\\n`;\n  return code;\n}\n\n// Функция для генерации кода отправки медиа из attachedMedia\nfunction generateAttachedMediaSendCode(\n  attachedMedia: string[],\n  mediaVariablesMap: Map<string, { type: string; variable: string }>,\n  text: string,\n  parseMode: string,\n  keyboard: string,\n  nodeId: string,\n  indentLevel: string\n): string {\n  if (!attachedMedia || attachedMedia.length === 0) {\n    return '';\n  }\n\n  // Пока поддерживаем только первую медиапеременную\n  const firstMediaVar = attachedMedia[0];\n  const mediaInfo = mediaVariablesMap.get(firstMediaVar);\n  \n  if (!mediaInfo) {\n    console.log(`⚠️ ГЕНЕРАТОР: Медиапеременная ${firstMediaVar} не найдена в mediaVariablesMap`);\n    return '';\n  }\n\n  const { type: mediaType, variable: mediaVariable } = mediaInfo;\n  \n  let code = '';\n  code += `${indentLevel}# Проверяем наличие прикрепленного медиа из переменной ${mediaVariable}\\n`;\n  code += `${indentLevel}attached_media = None\\n`;\n  code += `${indentLevel}if user_vars and \"${mediaVariable}\" in user_vars:\\n`;\n  code += `${indentLevel}    media_data = user_vars[\"${mediaVariable}\"]\\n`;\n  code += `${indentLevel}    if isinstance(media_data, dict) and \"value\" in media_data:\\n`;\n  code += `${indentLevel}        attached_media = media_data[\"value\"]\\n`;\n  code += `${indentLevel}    elif isinstance(media_data, str):\\n`;\n  code += `${indentLevel}        attached_media = media_data\\n`;\n  code += `${indentLevel}\\n`;\n  code += `${indentLevel}# Если медиа найдено, отправляем с медиа, иначе обычное сообщение\\n`;\n  code += `${indentLevel}if attached_media and str(attached_media).strip():\\n`;\n  code += `${indentLevel}    logging.info(f\"📎 Отправка ${mediaType} медиа из переменной ${mediaVariable}: {attached_media}\")\\n`;\n  code += `${indentLevel}    try:\\n`;\n  code += `${indentLevel}        await callback_query.message.delete()\\n`;\n  \n  // Генерируем код отправки в зависимости от типа медиа\n  const keyboardParam = keyboard !== 'None' ? ', reply_markup=keyboard' : '';\n  const parseModeParam = parseMode ? `, parse_mode=ParseMode.${parseMode.toUpperCase()}` : '';\n  \n  switch (mediaType) {\n    case 'photo':\n      code += `${indentLevel}        await bot.send_photo(callback_query.from_user.id, attached_media, caption=text${parseModeParam}${keyboardParam})\\n`;\n      break;\n    case 'video':\n      code += `${indentLevel}        await bot.send_video(callback_query.from_user.id, attached_media, caption=text${parseModeParam}${keyboardParam})\\n`;\n      break;\n    case 'audio':\n      code += `${indentLevel}        await bot.send_audio(callback_query.from_user.id, attached_media, caption=text${parseModeParam}${keyboardParam})\\n`;\n      break;\n    case 'document':\n      code += `${indentLevel}        await bot.send_document(callback_query.from_user.id, attached_media, caption=text${parseModeParam}${keyboardParam})\\n`;\n      break;\n    default:\n      code += `${indentLevel}        # Неизвестный тип медиа: ${mediaType}, fallback на обычное сообщение\\n`;\n      code += `${indentLevel}        await safe_edit_or_send(callback_query, text, node_id=\"${nodeId}\", reply_markup=${keyboard}${parseMode})\\n`;\n  }\n  \n  code += `${indentLevel}    except Exception as e:\\n`;\n  code += `${indentLevel}        logging.error(f\"Ошибка отправки ${mediaType}: {e}\")\\n`;\n  code += `${indentLevel}        # Fallback на обычное сообщение при ошибке\\n`;\n  code += `${indentLevel}        await safe_edit_or_send(callback_query, text, node_id=\"${nodeId}\", reply_markup=${keyboard}${parseMode})\\n`;\n  code += `${indentLevel}else:\\n`;\n  code += `${indentLevel}    # Медиа не найдено, отправляем обычное текстовое сообщение\\n`;\n  code += `${indentLevel}    logging.info(f\"📝 Медиа ${mediaVariable} не найдено, отправка текстового сообщения\")\\n`;\n  code += `${indentLevel}    await safe_edit_or_send(callback_query, text, node_id=\"${nodeId}\", reply_markup=${keyboard}${parseMode})\\n`;\n  \n  return code;\n}\n\n// Функция для генерации клавиатуры для условного сообщения\nfunction generateConditionalKeyboard(condition: any, indentLevel: string, nodeData?: any): string {\n  if (!condition.keyboardType || condition.keyboardType === 'none' || !condition.buttons || condition.buttons.length === 0) {\n    return '';\n  }\n\n  let code = '';\n  \n  if (condition.keyboardType === 'inline') {\n    code += `${indentLevel}# Создаем inline клавиатуру для условного сообщения\\n`;\n    code += `${indentLevel}builder = InlineKeyboardBuilder()\\n`;\n    \n    condition.buttons.forEach((button: any) => {\n      if (button.action === \"url\") {\n        code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, url=\"${button.url || '#'}\"))\\n`;\n      } else if (button.action === 'goto') {\n        const callbackData = button.target || button.id || 'no_action';\n        code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${callbackData}\"))\\n`;\n      } else if (button.action === 'command') {\n        // Для кнопок команд в условных сообщениях, которые должны сохранять данные\n        // Создаем специальную callback_data с переменной и значением из условного сообщения\n        const conditionalVariableName = condition.variableName || condition.variableNames?.[0] || (nodeData && nodeData.inputVariable);\n        if (conditionalVariableName) {\n          const conditionalCallback = `conditional_${conditionalVariableName}_${button.text}`;\n          code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${conditionalCallback}\"))\\n`;\n        } else {\n          const commandCallback = `cmd_${button.target ? button.target.replace('/', '') : 'unknown'}`;\n          code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${commandCallback}\"))\\n`;\n        }\n      } else {\n        const callbackData = button.target || button.id || 'no_action';\n        code += `${indentLevel}builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${callbackData}\"))\\n`;\n      }\n    });\n    \n    // Автоматическое распределение колонок для inline клавиатуры\n    const columns = calculateOptimalColumns(condition.buttons, nodeData);\n    code += `${indentLevel}builder.adjust(${columns})\\n`;\n    code += `${indentLevel}keyboard = builder.as_markup()\\n`;\n    code += `${indentLevel}conditional_keyboard = keyboard\\n`;\n    \n  } else if (condition.keyboardType === 'reply') {\n    code += `${indentLevel}# Создаем reply клавиатуру для условного сообщения\\n`;\n    code += `${indentLevel}builder = ReplyKeyboardBuilder()\\n`;\n    \n    condition.buttons.forEach((button: any) => {\n      if (button.action === \"contact\" && button.requestContact) {\n        code += `${indentLevel}builder.add(KeyboardButton(text=${generateButtonText(button.text)}, request_contact=True))\\n`;\n      } else if (button.action === \"location\" && button.requestLocation) {\n        code += `${indentLevel}builder.add(KeyboardButton(text=${generateButtonText(button.text)}, request_location=True))\\n`;\n      } else {\n        code += `${indentLevel}builder.add(KeyboardButton(text=${generateButtonText(button.text)}))\\n`;\n      }\n    });\n    \n    code += `${indentLevel}keyboard = builder.as_markup(resize_keyboard=True, one_time_keyboard=False)\\n`;\n    code += `${indentLevel}conditional_keyboard = keyboard\\n`;\n  }\n  \n  return code;\n}\n\n// Функция для генерации логики условных сообщений\nfunction generateConditionalMessageLogic(conditionalMessages: any[], indentLevel: string = '    ', nodeData?: any): string {\n  if (!conditionalMessages || conditionalMessages.length === 0) {\n    return '';\n  }\n\n  let code = '';\n  const sortedConditions = [...conditionalMessages].sort((a, b) => (b.priority || 0) - (a.priority || 0));\n  \n  // Add variables to track conditional parse mode and keyboard\n  code += `${indentLevel}conditional_parse_mode = None\\n`;\n  code += `${indentLevel}conditional_keyboard = None\\n`;\n  \n  // Получаем user_vars для подстановки в кнопки условных сообщений\n  code += `${indentLevel}# Подставляем все доступные переменные пользователя в текст кнопок\\n`;\n  code += `${indentLevel}user_vars = await get_user_from_db(user_id)\\n`;\n  code += `${indentLevel}if not user_vars:\\n`;\n  code += `${indentLevel}    user_vars = user_data.get(user_id, {})\\n`;\n  code += `${indentLevel}\\n`;\n  code += `${indentLevel}# get_user_from_db теперь возвращает уже обработанные user_data\\n`;\n  code += `${indentLevel}if not isinstance(user_vars, dict):\\n`;\n  code += `${indentLevel}    user_vars = {}\\n`;\n  code += `${indentLevel}\\n`;\n  code += `${indentLevel}# Заменяем все переменные в тексте\\n`;\n  code += `${indentLevel}import re\\n`;\n  code += `${indentLevel}def replace_variables_in_text(text_content, variables_dict):\\n`;\n  code += `${indentLevel}    if not text_content or not variables_dict:\\n`;\n  code += `${indentLevel}        return text_content\\n`;\n  code += `${indentLevel}    \\n`;\n  code += `${indentLevel}    for var_name, var_data in variables_dict.items():\\n`;\n  code += `${indentLevel}        placeholder = \"{\" + var_name + \"}\"\\n`;\n  code += `${indentLevel}        if placeholder in text_content:\\n`;\n  code += `${indentLevel}            if isinstance(var_data, dict) and \"value\" in var_data:\\n`;\n  code += `${indentLevel}                var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\\n`;\n  code += `${indentLevel}            elif var_data is not None:\\n`;\n  code += `${indentLevel}                var_value = str(var_data)\\n`;\n  code += `${indentLevel}            else:\\n`;\n  code += `${indentLevel}                var_value = var_name  # Показываем имя переменной если значения нет\\n`;\n  code += `${indentLevel}            text_content = text_content.replace(placeholder, var_value)\\n`;\n  code += `${indentLevel}    return text_content\\n`;\n  code += `${indentLevel}\\n`;\n  \n  // Генерируем единую функцию проверки переменных\n  code += `${indentLevel}# Функция для проверки переменных пользователя\\n`;\n  code += `${indentLevel}def check_user_variable(var_name, user_data_dict):\\n`;\n  code += `${indentLevel}    \"\"\"Проверяет существование и получает значение переменной пользователя\"\"\"\\n`;\n  code += `${indentLevel}    # Сначала проверяем в поле user_data (из БД)\\n`;\n  code += `${indentLevel}    if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\\n`;\n  code += `${indentLevel}        try:\\n`;\n  code += `${indentLevel}            import json\\n`;\n  code += `${indentLevel}            parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\\n`;\n  code += `${indentLevel}            if var_name in parsed_data:\\n`;\n  code += `${indentLevel}                raw_value = parsed_data[var_name]\\n`;\n  code += `${indentLevel}                if isinstance(raw_value, dict) and \"value\" in raw_value:\\n`;\n  code += `${indentLevel}                    var_value = raw_value[\"value\"]\\n`;\n  code += `${indentLevel}                    # Проверяем, что значение действительно существует и не пустое\\n`;\n  code += `${indentLevel}                    if var_value is not None and str(var_value).strip() != \"\":\\n`;\n  code += `${indentLevel}                        return True, str(var_value)\\n`;\n  code += `${indentLevel}                else:\\n`;\n  code += `${indentLevel}                    # Проверяем, что значение действительно существует и не пустое\\n`;\n  code += `${indentLevel}                    if raw_value is not None and str(raw_value).strip() != \"\":\\n`;\n  code += `${indentLevel}                        return True, str(raw_value)\\n`;\n  code += `${indentLevel}        except (json.JSONDecodeError, TypeError):\\n`;\n  code += `${indentLevel}            pass\\n`;\n  code += `${indentLevel}    \\n`;\n  code += `${indentLevel}    # Проверяем в локальных данных (без вложенности user_data)\\n`;\n  code += `${indentLevel}    if var_name in user_data_dict:\\n`;\n  code += `${indentLevel}        variable_data = user_data_dict.get(var_name)\\n`;\n  code += `${indentLevel}        if isinstance(variable_data, dict) and \"value\" in variable_data:\\n`;\n  code += `${indentLevel}            var_value = variable_data[\"value\"]\\n`;\n  code += `${indentLevel}            # Проверяем, что значение действительно существует и не пустое\\n`;\n  code += `${indentLevel}            if var_value is not None and str(var_value).strip() != \"\":\\n`;\n  code += `${indentLevel}                return True, str(var_value)\\n`;\n  code += `${indentLevel}        elif variable_data is not None and str(variable_data).strip() != \"\":\\n`;\n  code += `${indentLevel}            return True, str(variable_data)\\n`;\n  code += `${indentLevel}    \\n`;\n  code += `${indentLevel}    return False, None\\n`;\n  code += `${indentLevel}\\n`;\n  \n  // Создаем единую if/elif/else структуру для всех условий\n  for (let i = 0; i < sortedConditions.length; i++) {\n    const condition = sortedConditions[i];\n    // Если текст условного сообщения не указан или пустой, используем основной текст узла\n    let messageToUse = condition.messageText || '';\n    const cleanedConditionText = stripHtmlTags(messageToUse).trim();\n    // Если после очистки текст пустой, используем основной текст узла\n    if (!cleanedConditionText) {\n      messageToUse = nodeData?.messageText || 'Сообщение';\n    }\n    const conditionText = formatTextForPython(cleanedConditionText || stripHtmlTags(messageToUse));\n    const conditionKeyword = i === 0 ? 'if' : 'elif';\n    \n    // Get variable names - support both new array format and legacy single variable\n    const variableNames = condition.variableNames && condition.variableNames.length > 0 \n      ? condition.variableNames \n      : (condition.variableName ? [condition.variableName] : []);\n    \n    const logicOperator = condition.logicOperator || 'AND';\n    \n    code += `${indentLevel}# Условие ${i + 1}: ${condition.condition} для переменных: ${variableNames.join(', ')}\\n`;\n    \n    switch (condition.condition) {\n      case 'user_data_exists':\n        if (variableNames.length === 0) {\n          code += `${indentLevel}${conditionKeyword} False:  # Нет переменных для проверки\\n`;\n          code += `${indentLevel}    pass\\n`;\n          break;\n        }\n        \n        // Создаем единый блок условия с проверками ВНУТРИ\n        code += `${indentLevel}${conditionKeyword} (\\n`;\n        for (let j = 0; j < variableNames.length; j++) {\n          const varName = variableNames[j];\n          const operator = (j === variableNames.length - 1) ? '' : (logicOperator === 'AND' ? ' and' : ' or');\n          code += `${indentLevel}    check_user_variable(\"${varName}\", user_data_dict)[0]${operator}\\n`;\n        }\n        code += `${indentLevel}):\\n`;\n        \n        // Внутри блока условия собираем значения переменных\n        code += `${indentLevel}    # Собираем значения переменных\\n`;\n        code += `${indentLevel}    variable_values = {}\\n`;\n        for (const varName of variableNames) {\n          code += `${indentLevel}    _, variable_values[\"${varName}\"] = check_user_variable(\"${varName}\", user_data_dict)\\n`;\n        }\n        \n        code += `${indentLevel}    text = ${conditionText}\\n`;\n        // Устанавливаем parse_mode для условного сообщения\n        const parseMode1 = getParseMode(condition.formatMode || 'text');\n        if (parseMode1) {\n          code += `${indentLevel}    conditional_parse_mode = \"${parseMode1}\"\\n`;\n        } else {\n          code += `${indentLevel}    conditional_parse_mode = None\\n`;\n        }\n        \n        // Заменяем переменные в тексте\n        for (const varName of variableNames) {\n          code += `${indentLevel}    if \"{${varName}}\" in text and variable_values[\"${varName}\"] is not None:\\n`;\n          code += `${indentLevel}        text = text.replace(\"{${varName}}\", variable_values[\"${varName}\"])\\n`;\n        }\n        \n        // Добавляем генерацию клавиатуры для условного сообщения\n        code += generateConditionalKeyboard(condition, indentLevel + '    ', nodeData);\n        \n        // Добавляем логику для настройки ожидания текстового ввода\n        code += `${indentLevel}    # Настраиваем ожидание текстового ввода для условного сообщения\\n`;\n        code += `${indentLevel}    conditional_message_config = {\\n`;\n        code += `${indentLevel}        \"condition_id\": \"${condition.id}\",\\n`;\n        code += `${indentLevel}        \"wait_for_input\": ${toPythonBoolean(condition.waitForTextInput)},\\n`;\n        code += `${indentLevel}        \"input_variable\": \"${condition.textInputVariable || ''}\",\\n`;\n        code += `${indentLevel}        \"next_node_id\": \"${condition.nextNodeAfterInput || ''}\",\\n`;\n        code += `${indentLevel}        \"source_type\": \"conditional_message\"\\n`;\n        code += `${indentLevel}    }\\n`;\n        \n        // Добавляем код для активации состояния условного ввода\n        if (condition.waitForTextInput) {\n          code += `${indentLevel}    \\n`;\n          code += `${indentLevel}    # Если есть условное сообщение с ожиданием ввода\\n`;\n          code += `${indentLevel}    if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\\n`;\n          code += `${indentLevel}        if user_id not in user_data:\\n`;\n          code += `${indentLevel}            user_data[user_id] = {}\\n`;\n          code += `${indentLevel}        user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\\n`;\n          code += `${indentLevel}        logging.info(f\"Активировано ожидание условного ввода: {conditional_message_config}\")\\n`;\n        }\n        \n        code += `${indentLevel}    logging.info(f\"Условие выполнено: переменные {variable_values} (${logicOperator})\")\\n`;\n        break;\n        \n      case 'user_data_not_exists':\n        if (variableNames.length === 0) {\n          code += `${indentLevel}${conditionKeyword} False:  # Нет переменных для проверки\\n`;\n          code += `${indentLevel}    pass\\n`;\n          break;\n        }\n        \n        // Создаем единый блок условия с проверками ВНУТРИ (инвертированными)\n        code += `${indentLevel}${conditionKeyword} (\\n`;\n        for (let j = 0; j < variableNames.length; j++) {\n          const varName = variableNames[j];\n          const operator = (j === variableNames.length - 1) ? '' : (logicOperator === 'AND' ? ' and' : ' or');\n          if (logicOperator === 'AND') {\n            code += `${indentLevel}    not check_user_variable(\"${varName}\", user_data_dict)[0]${operator}\\n`;\n          } else {\n            code += `${indentLevel}    not check_user_variable(\"${varName}\", user_data_dict)[0]${operator}\\n`;\n          }\n        }\n        code += `${indentLevel}):\\n`;\n        \n        code += `${indentLevel}    text = ${conditionText}\\n`;\n        // Устанавливаем parse_mode для условного сообщения\n        const parseMode2 = getParseMode(condition.formatMode || 'text');\n        if (parseMode2) {\n          code += `${indentLevel}    conditional_parse_mode = \"${parseMode2}\"\\n`;\n        } else {\n          code += `${indentLevel}    conditional_parse_mode = None\\n`;\n        }\n        \n        // Добавляем генерацию клавиатуры для условного сообщения\n        code += generateConditionalKeyboard(condition, indentLevel + '    ', nodeData);\n        \n        // Добавляем логику для настройки ожидания текстового ввода\n        code += `${indentLevel}    # Настраиваем ожидание текстового ввода для условного сообщения\\n`;\n        code += `${indentLevel}    conditional_message_config = {\\n`;\n        code += `${indentLevel}        \"condition_id\": \"${condition.id}\",\\n`;\n        code += `${indentLevel}        \"wait_for_input\": ${toPythonBoolean(condition.waitForTextInput)},\\n`;\n        code += `${indentLevel}        \"input_variable\": \"${condition.textInputVariable || ''}\",\\n`;\n        code += `${indentLevel}        \"next_node_id\": \"${condition.nextNodeAfterInput || ''}\",\\n`;\n        code += `${indentLevel}        \"source_type\": \"conditional_message\"\\n`;\n        code += `${indentLevel}    }\\n`;\n        \n        // Добавляем код для активации состояния условного ввода для user_data_not_exists\n        if (condition.waitForTextInput) {\n          code += `${indentLevel}    \\n`;\n          code += `${indentLevel}    # Если есть условное сообщение с ожиданием ввода\\n`;\n          code += `${indentLevel}    if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\\n`;\n          code += `${indentLevel}        if user_id not in user_data:\\n`;\n          code += `${indentLevel}            user_data[user_id] = {}\\n`;\n          code += `${indentLevel}        user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\\n`;\n          code += `${indentLevel}        logging.info(f\"Активировано ожидание условного ввода: {conditional_message_config}\")\\n`;\n        }\n        \n        code += `${indentLevel}    logging.info(f\"Условие выполнено: переменные ${variableNames} не существуют (${logicOperator})\")\\n`;\n        break;\n        \n      case 'user_data_equals':\n        if (variableNames.length === 0) {\n          code += `${indentLevel}${conditionKeyword} False:  # Нет переменных для проверки\\n`;\n          code += `${indentLevel}    pass\\n`;\n          break;\n        }\n        \n        // Создаем единый блок условия с проверками равенства ВНУТРИ\n        code += `${indentLevel}${conditionKeyword} (\\n`;\n        for (let j = 0; j < variableNames.length; j++) {\n          const varName = variableNames[j];\n          const operator = (j === variableNames.length - 1) ? '' : (logicOperator === 'AND' ? ' and' : ' or');\n          code += `${indentLevel}    check_user_variable(\"${varName}\", user_data_dict)[1] == \"${condition.expectedValue || ''}\"${operator}\\n`;\n        }\n        code += `${indentLevel}):\\n`;\n        \n        // Внутри блока условия собираем значения переменных\n        code += `${indentLevel}    # Собираем значения переменных\\n`;\n        code += `${indentLevel}    variable_values = {}\\n`;\n        for (const varName of variableNames) {\n          code += `${indentLevel}    _, variable_values[\"${varName}\"] = check_user_variable(\"${varName}\", user_data_dict)\\n`;\n        }\n        \n        code += `${indentLevel}    text = ${conditionText}\\n`;\n        // Устанавливаем parse_mode для условного сообщения\n        const parseMode3 = getParseMode(condition.formatMode || 'text');\n        if (parseMode3) {\n          code += `${indentLevel}    conditional_parse_mode = \"${parseMode3}\"\\n`;\n        } else {\n          code += `${indentLevel}    conditional_parse_mode = None\\n`;\n        }\n        \n        // Заменяем переменные в тексте\n        for (const varName of variableNames) {\n          code += `${indentLevel}    if \"{${varName}}\" in text and variable_values[\"${varName}\"] is not None:\\n`;\n          code += `${indentLevel}        text = text.replace(\"{${varName}}\", variable_values[\"${varName}\"])\\n`;\n        }\n        \n        // Добавляем генерацию клавиатуры для условного сообщения\n        code += generateConditionalKeyboard(condition, indentLevel + '    ', nodeData);\n        \n        // Добавляем логику для настройки ожидания текстового ввода\n        code += `${indentLevel}    # Настраиваем ожидание текстового ввода для условного сообщения\\n`;\n        code += `${indentLevel}    conditional_message_config = {\\n`;\n        code += `${indentLevel}        \"condition_id\": \"${condition.id}\",\\n`;\n        code += `${indentLevel}        \"wait_for_input\": ${toPythonBoolean(condition.waitForTextInput)},\\n`;\n        code += `${indentLevel}        \"input_variable\": \"${condition.textInputVariable || ''}\",\\n`;\n        code += `${indentLevel}        \"next_node_id\": \"${condition.nextNodeAfterInput || ''}\",\\n`;\n        code += `${indentLevel}        \"source_type\": \"conditional_message\"\\n`;\n        code += `${indentLevel}    }\\n`;\n        \n        // Добавляем код для активации состояния условного ввода для user_data_equals\n        if (condition.waitForTextInput) {\n          code += `${indentLevel}    \\n`;\n          code += `${indentLevel}    # Если есть условное сообщение с ожиданием ввода\\n`;\n          code += `${indentLevel}    if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\\n`;\n          code += `${indentLevel}        if user_id not in user_data:\\n`;\n          code += `${indentLevel}            user_data[user_id] = {}\\n`;\n          code += `${indentLevel}        user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\\n`;\n          code += `${indentLevel}        logging.info(f\"Активировано ожидание условного ввода: {conditional_message_config}\")\\n`;\n        }\n        \n        code += `${indentLevel}    logging.info(f\"Условие выполнено: переменные {variable_values} равны '${condition.expectedValue || ''}' (${logicOperator})\")\\n`;\n        break;\n        \n      case 'user_data_contains':\n        if (variableNames.length === 0) {\n          code += `${indentLevel}${conditionKeyword} False:  # Нет переменных для проверки\\n`;\n          code += `${indentLevel}    pass\\n`;\n          break;\n        }\n        \n        // Создаем единый блок условия с проверками содержания ВНУТРИ\n        code += `${indentLevel}${conditionKeyword} (\\n`;\n        for (let j = 0; j < variableNames.length; j++) {\n          const varName = variableNames[j];\n          const operator = (j === variableNames.length - 1) ? '' : (logicOperator === 'AND' ? ' and' : ' or');\n          code += `${indentLevel}    (check_user_variable(\"${varName}\", user_data_dict)[1] is not None and \"${condition.expectedValue || ''}\" in str(check_user_variable(\"${varName}\", user_data_dict)[1]))${operator}\\n`;\n        }\n        code += `${indentLevel}):\\n`;\n        \n        // Внутри блока условия собираем значения переменных\n        code += `${indentLevel}    # Собираем значения переменных\\n`;\n        code += `${indentLevel}    variable_values = {}\\n`;\n        for (const varName of variableNames) {\n          code += `${indentLevel}    _, variable_values[\"${varName}\"] = check_user_variable(\"${varName}\", user_data_dict)\\n`;\n        }\n        \n        code += `${indentLevel}    text = ${conditionText}\\n`;\n        // Устанавливаем parse_mode для условного сообщения\n        const parseMode4 = getParseMode(condition.formatMode || 'text');\n        if (parseMode4) {\n          code += `${indentLevel}    conditional_parse_mode = \"${parseMode4}\"\\n`;\n        } else {\n          code += `${indentLevel}    conditional_parse_mode = None\\n`;\n        }\n        \n        // Заменяем переменные в тексте\n        for (const varName of variableNames) {\n          code += `${indentLevel}    if \"{${varName}}\" in text and variable_values[\"${varName}\"] is not None:\\n`;\n          code += `${indentLevel}        text = text.replace(\"{${varName}}\", variable_values[\"${varName}\"])\\n`;\n        }\n        \n        // Добавляем генерацию клавиатуры для условного сообщения\n        code += generateConditionalKeyboard(condition, indentLevel + '    ', nodeData);\n        \n        // Добавляем логику для настройки ожидания текстового ввода\n        code += `${indentLevel}    # Настраиваем ожидание текстового ввода для условного сообщения\\n`;\n        code += `${indentLevel}    conditional_message_config = {\\n`;\n        code += `${indentLevel}        \"condition_id\": \"${condition.id}\",\\n`;\n        code += `${indentLevel}        \"wait_for_input\": ${toPythonBoolean(condition.waitForTextInput)},\\n`;\n        code += `${indentLevel}        \"input_variable\": \"${condition.textInputVariable || ''}\",\\n`;\n        code += `${indentLevel}        \"next_node_id\": \"${condition.nextNodeAfterInput || ''}\",\\n`;\n        code += `${indentLevel}        \"source_type\": \"conditional_message\"\\n`;\n        code += `${indentLevel}    }\\n`;\n        \n        // Добавляем код для активации состояния условного ввода для user_data_contains\n        if (condition.waitForTextInput) {\n          code += `${indentLevel}    \\n`;\n          code += `${indentLevel}    # Если есть условное сообщение с ожиданием ввода\\n`;\n          code += `${indentLevel}    if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\\n`;\n          code += `${indentLevel}        if user_id not in user_data:\\n`;\n          code += `${indentLevel}            user_data[user_id] = {}\\n`;\n          code += `${indentLevel}        user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\\n`;\n          code += `${indentLevel}        logging.info(f\"Активировано ожидание условного ввода: {conditional_message_config}\")\\n`;\n        }\n        \n        code += `${indentLevel}    logging.info(f\"Условие выполнено: переменные {variable_values} содержат '${condition.expectedValue || ''}' (${logicOperator})\")\\n`;\n        break;\n        \n      case 'first_time':\n        code += `${indentLevel}${conditionKeyword} user_record.get(\"interaction_count\", 0) <= 1:\\n`;\n        code += `${indentLevel}    text = ${conditionText}\\n`;\n        // Устанавливаем parse_mode для условного сообщения\n        const parseMode5 = getParseMode(condition.formatMode || 'text');\n        if (parseMode5) {\n          code += `${indentLevel}    conditional_parse_mode = \"${parseMode5}\"\\n`;\n        } else {\n          code += `${indentLevel}    conditional_parse_mode = None\\n`;\n        }\n        \n        // Добавляем генерацию клавиатуры для условного сообщения\n        code += generateConditionalKeyboard(condition, indentLevel + '    ', nodeData);\n        \n        // Добавляем логику для настройки ожидания текстового ввода\n        code += `${indentLevel}    # Настраиваем ожидание текстового ввода для условного сообщения\\n`;\n        code += `${indentLevel}    conditional_message_config = {\\n`;\n        code += `${indentLevel}        \"condition_id\": \"${condition.id}\",\\n`;\n        code += `${indentLevel}        \"wait_for_input\": ${toPythonBoolean(condition.waitForTextInput)},\\n`;\n        code += `${indentLevel}        \"input_variable\": \"${condition.textInputVariable || ''}\",\\n`;\n        code += `${indentLevel}        \"next_node_id\": \"${condition.nextNodeAfterInput || ''}\",\\n`;\n        code += `${indentLevel}        \"source_type\": \"conditional_message\"\\n`;\n        code += `${indentLevel}    }\\n`;\n        \n        // Добавляем код для активации состояния условного ввода для first_time\n        if (condition.waitForTextInput) {\n          code += `${indentLevel}    \\n`;\n          code += `${indentLevel}    # Если есть условное сообщение с ожиданием ввода\\n`;\n          code += `${indentLevel}    if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\\n`;\n          code += `${indentLevel}        if user_id not in user_data:\\n`;\n          code += `${indentLevel}            user_data[user_id] = {}\\n`;\n          code += `${indentLevel}        user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\\n`;\n          code += `${indentLevel}        logging.info(f\"Активировано ожидание условного ввода: {conditional_message_config}\")\\n`;\n        }\n        \n        code += `${indentLevel}    logging.info(\"Условие выполнено: первое посещение пользователя\")\\n`;\n        break;\n        \n      case 'returning_user':\n        code += `${indentLevel}${conditionKeyword} user_record.get(\"interaction_count\", 0) > 1:\\n`;\n        code += `${indentLevel}    text = ${conditionText}\\n`;\n        // Устанавливаем parse_mode для условного сообщения\n        const parseMode6 = getParseMode(condition.formatMode || 'text');\n        if (parseMode6) {\n          code += `${indentLevel}    conditional_parse_mode = \"${parseMode6}\"\\n`;\n        } else {\n          code += `${indentLevel}    conditional_parse_mode = None\\n`;\n        }\n        \n        // Добавляем генерацию клавиатуры для условного сообщения\n        code += generateConditionalKeyboard(condition, indentLevel + '    ', nodeData);\n        \n        // Добавляем логику для настройки ожидания текстового ввода\n        code += `${indentLevel}    # Настраиваем ожидание текстового ввода для условного сообщения\\n`;\n        code += `${indentLevel}    conditional_message_config = {\\n`;\n        code += `${indentLevel}        \"condition_id\": \"${condition.id}\",\\n`;\n        code += `${indentLevel}        \"wait_for_input\": ${toPythonBoolean(condition.waitForTextInput)},\\n`;\n        code += `${indentLevel}        \"input_variable\": \"${condition.textInputVariable || ''}\",\\n`;\n        code += `${indentLevel}        \"next_node_id\": \"${condition.nextNodeAfterInput || ''}\",\\n`;\n        code += `${indentLevel}        \"source_type\": \"conditional_message\"\\n`;\n        code += `${indentLevel}    }\\n`;\n        \n        // Добавляем код для активации состояния условного ввода для returning_user\n        if (condition.waitForTextInput) {\n          code += `${indentLevel}    \\n`;\n          code += `${indentLevel}    # Если есть условное сообщение с ожиданием ввода\\n`;\n          code += `${indentLevel}    if conditional_message_config and conditional_message_config.get(\"wait_for_input\"):\\n`;\n          code += `${indentLevel}        if user_id not in user_data:\\n`;\n          code += `${indentLevel}            user_data[user_id] = {}\\n`;\n          code += `${indentLevel}        user_data[user_id][\"waiting_for_conditional_input\"] = conditional_message_config\\n`;\n          code += `${indentLevel}        logging.info(f\"Активировано ожидание условного ввода: {conditional_message_config}\")\\n`;\n        }\n        \n        code += `${indentLevel}    logging.info(\"Условие выполнено: возвращающийся пользователь\")\\n`;\n        break;\n        \n      default:\n        code += `${indentLevel}${conditionKeyword} False:  # Неизвестное условие: ${condition.condition}\\n`;\n        code += `${indentLevel}    pass\\n`;\n        break;\n    }\n  }\n  \n  // НЕ добавляем else блок здесь - он будет добавлен основной функцией\n  return code;\n}\n\nexport function generatePythonCode(botData: BotData, botName: string = \"MyBot\", groups: BotGroup[] = [], userDatabaseEnabled: boolean = false): string {\n  const { nodes, connections } = extractNodesAndConnections(botData);\n  \n  // Собираем все ID узлов для генерации уникальных коротких ID\n  const allNodeIds = nodes ? nodes.map(node => node.id) : [];\n  \n  // Собираем все медиапеременные из узлов для поддержки attachedMedia\n  const mediaVariablesMap = collectMediaVariables(nodes || []);\n  console.log(`🔧 ГЕНЕРАТОР: Собрано медиапеременных: ${mediaVariablesMap.size}`);\n  if (mediaVariablesMap.size > 0) {\n    console.log('🔧 ГЕНЕРАТОР: Медиапеременные:', Array.from(mediaVariablesMap.entries()));\n  }\n  \n  // ЛОГИРОВАНИЕ ГЕНЕРАТОРА: Подробная информация о данных бота\n  console.log(`🔧 ГЕНЕРАТОР НАЧАЛ РАБОТУ: узлов - ${nodes?.length || 0}, связей - ${connections?.length || 0}`);\n  \n  // Логируем все узлы с их свойствами\n  if (nodes && nodes.length > 0) {\n    console.log('🔧 ГЕНЕРАТОР: Анализируем все узлы:');\n    nodes.forEach((node, index) => {\n      const hasMultiSelect = node.data.allowMultipleSelection;\n      const hasButtons = node.data.buttons && node.data.buttons.length > 0;\n      const continueTarget = node.data.continueButtonTarget;\n      \n      console.log(`🔧 ГЕНЕРАТОР: Узел ${index + 1}: \"${node.id}\" (тип: ${node.type})`);\n      console.log(`🔧 ГЕНЕРАТОР:   - allowMultipleSelection: ${node.data.allowMultipleSelection}`);\n      console.log(`🔧 ГЕНЕРАТОР:   - hasMultiSelect: ${hasMultiSelect}`);\n      console.log(`🔧 ГЕНЕРАТОР:   - кнопок: ${node.data.buttons?.length || 0}`);\n      console.log(`🔧 ГЕНЕРАТОР:   - keyboardType: ${node.data.keyboardType || 'нет'}`);\n      console.log(`🔧 ГЕНЕРАТОР:   - continueButtonTarget: ${continueTarget || 'нет'}`);\n      \n      if (node.id === 'interests_result') {\n        console.log(`🚨 ГЕНЕРАТОР: НАЙДЕН interests_result!`);\n        console.log(`🚨 ГЕНЕРАТОР: interests_result полные данные:`, JSON.stringify(node.data, null, 2));\n      }\n    });\n    \n    // Проверим связи\n    if (connections && connections.length > 0) {\n      console.log('🔧 ГЕНЕРАТОР: Анализируем связи:');\n      connections.forEach((conn, index) => {\n        console.log(`🔧 ГЕНЕРАТОР: Связь ${index + 1}: ${conn.source} -> ${conn.target}`);\n      });\n    }\n  }\n  \n  let code = '\"\"\"\\n';\n  code += `${botName} - Telegram Bot\\n`;\n  code += 'Сгенерировано с помощью TelegramBot Builder\\n';\n  \n  const botFatherCommands = generateBotFatherCommands(nodes);\n  if (botFatherCommands) {\n    code += '\\nКоманды для @BotFather:\\n';\n    code += botFatherCommands;\n  }\n  \n  code += '\"\"\"\\n\\n';\n  \n  code += 'import asyncio\\n';\n  code += 'import logging\\n';\n  code += 'import os\\n';\n  code += 'import sys\\n';\n  code += 'import locale\\n';\n  code += 'from aiogram import Bot, Dispatcher, types, F\\n';\n  code += 'from aiogram.filters import CommandStart, Command\\n';\n  code += 'from aiogram.exceptions import TelegramBadRequest\\n';\n  code += 'from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, BotCommand, ReplyKeyboardRemove, URLInputFile, FSInputFile\\n';\n  code += 'from aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder\\n';\n  code += 'from aiogram.enums import ParseMode\\n';\n  code += 'from typing import Optional\\n';\n  code += 'import asyncpg\\n';\n  code += 'from datetime import datetime, timezone, timedelta\\n';\n  code += 'import json\\n';\n  code += 'import aiohttp\\n\\n';\n  \n  // Добавляем safe_edit_or_send только если есть inline кнопки\n  if (hasInlineButtons(nodes || [])) {\n    code += '# Safe helper for editing messages with fallback to new message\\n';\n    code += 'async def safe_edit_or_send(cbq, text, node_id=None, **kwargs):\\n';\n    code += '    \"\"\"\\n';\n    code += '    Безопасное редактирование сообщения с fallback на новое сообщение\\n';\n    code += '    Решает проблему \"message can\\'t be edited\" когда пытаемся редактировать сообщения пользователя\\n';\n    code += '    \"\"\"\\n';\n    code += '    result = None\\n';\n    code += '    user_id = None\\n';\n    code += '    try:\\n';\n    code += '        # Получаем user_id для сохранения\\n';\n    code += '        if hasattr(cbq, \"from_user\") and cbq.from_user:\\n';\n    code += '            user_id = str(cbq.from_user.id)\\n';\n    code += '        elif hasattr(cbq, \"message\") and cbq.message and hasattr(cbq.message, \"chat\"):\\n';\n    code += '            user_id = str(cbq.message.chat.id)\\n';\n    code += '        \\n';\n    code += '        # Если у callback объекта есть собственный метод edit_text (например, MockCallback), используем его\\n';\n    code += '        if hasattr(cbq, \"edit_text\") and callable(getattr(cbq, \"edit_text\")):\\n';\n    code += '            result = await cbq.edit_text(text, **kwargs)\\n';\n    code += '        # Иначе пробуем стандартный способ\\n';\n    code += '        elif (hasattr(cbq, \"message\") and cbq.message):\\n';\n    code += '            result = await cbq.message.edit_text(text, **kwargs)\\n';\n    code += '        else:\\n';\n    code += '            raise Exception(\"No valid edit method found\")\\n';\n    code += '    except Exception as e:\\n';\n    code += '        # При любой ошибке отправляем новое сообщение\\n';\n    code += '        logging.warning(f\"Не удалось отредактировать сообщение ({e}), отправляем новое\")\\n';\n    code += '        if hasattr(cbq, \"message\") and cbq.message:\\n';\n    code += '            result = await cbq.message.answer(text, **kwargs)\\n';\n    code += '        else:\\n';\n    code += '            logging.error(\"Не удалось ни отредактировать, ни отправить новое сообщение\")\\n';\n    code += '            raise\\n';\n    code += '    \\n';\n    code += '    # Сохраняем сообщение в базу данных\\n';\n    code += '    if result and user_id:\\n';\n    code += '        message_data_obj = {\"message_id\": result.message_id if hasattr(result, \"message_id\") else None}\\n';\n    code += '        \\n';\n    code += '        # Извлекаем кнопки из reply_markup\\n';\n    code += '        if \"reply_markup\" in kwargs:\\n';\n    code += '            try:\\n';\n    code += '                reply_markup = kwargs[\"reply_markup\"]\\n';\n    code += '                buttons_data = []\\n';\n    code += '                # Обработка inline клавиатуры\\n';\n    code += '                if hasattr(reply_markup, \"inline_keyboard\"):\\n';\n    code += '                    for row in reply_markup.inline_keyboard:\\n';\n    code += '                        for btn in row:\\n';\n    code += '                            button_info = {\"text\": btn.text}\\n';\n    code += '                            if hasattr(btn, \"url\") and btn.url:\\n';\n    code += '                                button_info[\"url\"] = btn.url\\n';\n    code += '                            if hasattr(btn, \"callback_data\") and btn.callback_data:\\n';\n    code += '                                button_info[\"callback_data\"] = btn.callback_data\\n';\n    code += '                            buttons_data.append(button_info)\\n';\n    code += '                    if buttons_data:\\n';\n    code += '                        message_data_obj[\"buttons\"] = buttons_data\\n';\n    code += '                        message_data_obj[\"keyboard_type\"] = \"inline\"\\n';\n    code += '                # Обработка reply клавиатуры\\n';\n    code += '                elif hasattr(reply_markup, \"keyboard\"):\\n';\n    code += '                    for row in reply_markup.keyboard:\\n';\n    code += '                        for btn in row:\\n';\n    code += '                            button_info = {\"text\": btn.text}\\n';\n    code += '                            if hasattr(btn, \"request_contact\") and btn.request_contact:\\n';\n    code += '                                button_info[\"request_contact\"] = True\\n';\n    code += '                            if hasattr(btn, \"request_location\") and btn.request_location:\\n';\n    code += '                                button_info[\"request_location\"] = True\\n';\n    code += '                            buttons_data.append(button_info)\\n';\n    code += '                    if buttons_data:\\n';\n    code += '                        message_data_obj[\"buttons\"] = buttons_data\\n';\n    code += '                        message_data_obj[\"keyboard_type\"] = \"reply\"\\n';\n    code += '            except Exception as btn_error:\\n';\n    code += '                logging.warning(f\"Не удалось извлечь кнопки в safe_edit_or_send: {btn_error}\")\\n';\n    code += '        \\n';\n    code += '        await save_message_to_api(\\n';\n    code += '            user_id=user_id,\\n';\n    code += '            message_type=\"bot\",\\n';\n    code += '            message_text=text,\\n';\n    code += '            node_id=node_id,\\n';\n    code += '            message_data=message_data_obj\\n';\n    code += '        )\\n';\n    code += '    \\n';\n    code += '    return result\\n\\n';\n  }\n  \n  code += '# Токен вашего бота (получите у @BotFather)\\n';\n  code += 'BOT_TOKEN = \"YOUR_BOT_TOKEN_HERE\"\\n\\n';\n  \n  code += '# Настройка логирования\\n';\n  code += 'logging.basicConfig(level=logging.INFO)\\n\\n';\n  \n  code += '# Создание бота и диспетчера\\n';\n  code += 'bot = Bot(token=BOT_TOKEN)\\n';\n  code += 'dp = Dispatcher()\\n\\n';\n  \n  code += '# Список администраторов (добавьте свой Telegram ID)\\n';\n  code += 'ADMIN_IDS = [123456789]  # Замените на реальные ID администраторов\\n\\n';\n  \n  code += '# API configuration для сохранения сообщений\\n';\n  code += 'API_BASE_URL = os.getenv(\"REPLIT_DEV_DOMAIN\", \"http://localhost:5000\")\\n';\n  code += 'PROJECT_ID = os.getenv(\"PROJECT_ID\", \"1\")  # ID проекта в системе\\n\\n';\n  \n  code += '# Функция для сохранения сообщений в базу данных через API\\n';\n  code += 'async def save_message_to_api(user_id: str, message_type: str, message_text: str = None, node_id: str = None, message_data: dict = None):\\n';\n  code += '    \"\"\"Сохраняет сообщение в базу данных через API\"\"\"\\n';\n  code += '    try:\\n';\n  code += '        # Формируем полный URL для API\\n';\n  code += '        if API_BASE_URL.startswith(\"http\"):\\n';\n  code += '            api_url = f\"{API_BASE_URL}/api/projects/{PROJECT_ID}/messages\"\\n';\n  code += '        else:\\n';\n  code += '            api_url = f\"https://{API_BASE_URL}/api/projects/{PROJECT_ID}/messages\"\\n';\n  code += '        \\n';\n  code += '        payload = {\\n';\n  code += '            \"userId\": str(user_id),\\n';\n  code += '            \"messageType\": message_type,\\n';\n  code += '            \"messageText\": message_text,\\n';\n  code += '            \"nodeId\": node_id,\\n';\n  code += '            \"messageData\": message_data or {}\\n';\n  code += '        }\\n';\n  code += '        \\n';\n  code += '        logging.debug(f\"💾 Отправка сообщения в API: {payload}\")\\n';\n  code += '        async with aiohttp.ClientSession() as session:\\n';\n  code += '            async with session.post(api_url, json=payload, timeout=aiohttp.ClientTimeout(total=5)) as response:\\n';\n  code += '                if response.status == 200:\\n';\n  code += '                    logging.info(f\"✅ Сообщение сохранено: {message_type} от {user_id}\")\\n';\n  code += '                    response_data = await response.json()\\n';\n  code += '                    return response_data.get(\"data\")  # Возвращаем сохраненное сообщение с id\\n';\n  code += '                else:\\n';\n  code += '                    error_text = await response.text()\\n';\n  code += '                    logging.error(f\"❌ Не удалось сохранить сообщение: {response.status} - {error_text}\")\\n';\n  code += '                    logging.error(f\"Отправленный payload: {payload}\")\\n';\n  code += '                    return None\\n';\n  code += '    except Exception as e:\\n';\n  code += '        logging.error(f\"Ошибка при сохранении сообщения: {e}\")\\n';\n  code += '        return None\\n\\n';\n  \n  code += '# Middleware для сохранения входящих сообщений\\n';\n  code += 'async def message_logging_middleware(handler, event: types.Message, data: dict):\\n';\n  code += '    \"\"\"Middleware для автоматического сохранения входящих сообщений от пользователей\"\"\"\\n';\n  code += '    try:\\n';\n  code += '        # Сохраняем входящее сообщение от пользователя\\n';\n  code += '        user_id = str(event.from_user.id)\\n';\n  code += '        message_text = event.text or event.caption or \"[медиа]\"\\n';\n  code += '        message_data = {\"message_id\": event.message_id}\\n';\n  code += '        \\n';\n  code += '        # Проверяем наличие фото\\n';\n  code += '        photo_file_id = None\\n';\n  code += '        if event.photo:\\n';\n  code += '            # Берем фото наибольшего размера (последнее в списке)\\n';\n  code += '            largest_photo = event.photo[-1]\\n';\n  code += '            photo_file_id = largest_photo.file_id\\n';\n  code += '            message_data[\"photo\"] = {\\n';\n  code += '                \"file_id\": largest_photo.file_id,\\n';\n  code += '                \"file_unique_id\": largest_photo.file_unique_id,\\n';\n  code += '                \"width\": largest_photo.width,\\n';\n  code += '                \"height\": largest_photo.height,\\n';\n  code += '                \"file_size\": largest_photo.file_size if hasattr(largest_photo, \"file_size\") else None\\n';\n  code += '            }\\n';\n  code += '            if not message_text or message_text == \"[медиа]\":\\n';\n  code += '                message_text = \"[Фото]\"\\n';\n  code += '        \\n';\n  code += '        # Сохраняем сообщение в базу данных\\n';\n  code += '        saved_message = await save_message_to_api(\\n';\n  code += '            user_id=user_id,\\n';\n  code += '            message_type=\"user\",\\n';\n  code += '            message_text=message_text,\\n';\n  code += '            message_data=message_data\\n';\n  code += '        )\\n';\n  code += '        \\n';\n  code += '        # Если есть фото и сообщение сохранено, регистрируем медиа\\n';\n  code += '        if photo_file_id and saved_message and \"id\" in saved_message:\\n';\n  code += '            try:\\n';\n  code += '                if API_BASE_URL.startswith(\"http://\") or API_BASE_URL.startswith(\"https://\"):\\n';\n  code += '                    media_api_url = f\"{API_BASE_URL}/api/projects/{PROJECT_ID}/media/register-telegram-photo\"\\n';\n  code += '                else:\\n';\n  code += '                    media_api_url = f\"https://{API_BASE_URL}/api/projects/{PROJECT_ID}/media/register-telegram-photo\"\\n';\n  code += '                \\n';\n  code += '                media_payload = {\\n';\n  code += '                    \"messageId\": saved_message[\"id\"],\\n';\n  code += '                    \"fileId\": photo_file_id,\\n';\n  code += '                    \"botToken\": BOT_TOKEN,\\n';\n  code += '                    \"mediaType\": \"photo\"\\n';\n  code += '                }\\n';\n  code += '                \\n';\n  code += '                async with aiohttp.ClientSession() as session:\\n';\n  code += '                    async with session.post(media_api_url, json=media_payload, timeout=aiohttp.ClientTimeout(total=10)) as response:\\n';\n  code += '                        if response.status == 200:\\n';\n  code += '                            message_id = saved_message.get(\"id\")\\n';\n  code += '                            logging.info(f\"✅ Медиа зарегистрировано для сообщения {message_id}\")\\n';\n  code += '                        else:\\n';\n  code += '                            error_text = await response.text()\\n';\n  code += '                            logging.warning(f\"⚠️ Не удалось зарегистрировать медиа: {response.status} - {error_text}\")\\n';\n  code += '            except Exception as media_error:\\n';\n  code += '                logging.warning(f\"Ошибка при регистрации медиа: {media_error}\")\\n';\n  code += '    except Exception as e:\\n';\n  code += '        logging.error(f\"Ошибка в middleware сохранения сообщений: {e}\")\\n';\n  code += '    \\n';\n  code += '    # Продолжаем обработку сообщения\\n';\n  code += '    return await handler(event, data)\\n\\n';\n  \n  code += '# Middleware для сохранения нажатий на кнопки\\n';\n  code += 'async def callback_query_logging_middleware(handler, event: types.CallbackQuery, data: dict):\\n';\n  code += '    \"\"\"Middleware для автоматического сохранения нажатий на кнопки\"\"\"\\n';\n  code += '    try:\\n';\n  code += '        user_id = str(event.from_user.id)\\n';\n  code += '        callback_data = event.data or \"\"\\n';\n  code += '        \\n';\n  code += '        # Пытаемся найти текст кнопки из сообщения\\n';\n  code += '        button_text = None\\n';\n  code += '        if event.message and hasattr(event.message, \"reply_markup\"):\\n';\n  code += '            reply_markup = event.message.reply_markup\\n';\n  code += '            if hasattr(reply_markup, \"inline_keyboard\"):\\n';\n  code += '                for row in reply_markup.inline_keyboard:\\n';\n  code += '                    for btn in row:\\n';\n  code += '                        if hasattr(btn, \"callback_data\") and btn.callback_data == callback_data:\\n';\n  code += '                            button_text = btn.text\\n';\n  code += '                            break\\n';\n  code += '                    if button_text:\\n';\n  code += '                        break\\n';\n  code += '        \\n';\n  code += '        # Сохраняем информацию о нажатии кнопки\\n';\n  code += '        message_text_to_save = f\"[Нажата кнопка: {button_text}]\" if button_text else \"[Нажата кнопка]\"\\n';\n  code += '        await save_message_to_api(\\n';\n  code += '            user_id=user_id,\\n';\n  code += '            message_type=\"user\",\\n';\n  code += '            message_text=message_text_to_save,\\n';\n  code += '            message_data={\\n';\n  code += '                \"button_clicked\": True,\\n';\n  code += '                \"button_text\": button_text,\\n';\n  code += '                \"callback_data\": callback_data\\n';\n  code += '            }\\n';\n  code += '        )\\n';\n  code += '    except Exception as e:\\n';\n  code += '        logging.error(f\"Ошибка в middleware сохранения нажатий кнопок: {e}\")\\n';\n  code += '    \\n';\n  code += '    # Продолжаем обработку callback query\\n';\n  code += '    return await handler(event, data)\\n\\n';\n  \n  code += '# Обертка для сохранения исходящих сообщений\\n';\n  code += 'original_send_message = bot.send_message\\n';\n  code += 'async def send_message_with_logging(chat_id, text, *args, node_id=None, **kwargs):\\n';\n  code += '    \"\"\"Обертка для bot.send_message с автоматическим сохранением\"\"\"\\n';\n  code += '    result = await original_send_message(chat_id, text, *args, **kwargs)\\n';\n  code += '    \\n';\n  code += '    # Извлекаем информацию о кнопках из reply_markup\\n';\n  code += '    message_data_obj = {\"message_id\": result.message_id if result else None}\\n';\n  code += '    if \"reply_markup\" in kwargs:\\n';\n  code += '        try:\\n';\n  code += '            reply_markup = kwargs[\"reply_markup\"]\\n';\n  code += '            buttons_data = []\\n';\n  code += '            # Обработка inline клавиатуры\\n';\n  code += '            if hasattr(reply_markup, \"inline_keyboard\"):\\n';\n  code += '                for row in reply_markup.inline_keyboard:\\n';\n  code += '                    for btn in row:\\n';\n  code += '                        button_info = {\"text\": btn.text}\\n';\n  code += '                        if hasattr(btn, \"url\") and btn.url:\\n';\n  code += '                            button_info[\"url\"] = btn.url\\n';\n  code += '                        if hasattr(btn, \"callback_data\") and btn.callback_data:\\n';\n  code += '                            button_info[\"callback_data\"] = btn.callback_data\\n';\n  code += '                        buttons_data.append(button_info)\\n';\n  code += '                if buttons_data:\\n';\n  code += '                    message_data_obj[\"buttons\"] = buttons_data\\n';\n  code += '                    message_data_obj[\"keyboard_type\"] = \"inline\"\\n';\n  code += '            # Обработка reply клавиатуры\\n';\n  code += '            elif hasattr(reply_markup, \"keyboard\"):\\n';\n  code += '                for row in reply_markup.keyboard:\\n';\n  code += '                    for btn in row:\\n';\n  code += '                        button_info = {\"text\": btn.text}\\n';\n  code += '                        if hasattr(btn, \"request_contact\") and btn.request_contact:\\n';\n  code += '                            button_info[\"request_contact\"] = True\\n';\n  code += '                        if hasattr(btn, \"request_location\") and btn.request_location:\\n';\n  code += '                            button_info[\"request_location\"] = True\\n';\n  code += '                        buttons_data.append(button_info)\\n';\n  code += '                if buttons_data:\\n';\n  code += '                    message_data_obj[\"buttons\"] = buttons_data\\n';\n  code += '                    message_data_obj[\"keyboard_type\"] = \"reply\"\\n';\n  code += '        except Exception as e:\\n';\n  code += '            logging.warning(f\"Не удалось извлечь кнопки: {e}\")\\n';\n  code += '    \\n';\n  code += '    # Сохраняем синхронно для гарантии доставки\\n';\n  code += '    await save_message_to_api(\\n';\n  code += '        user_id=str(chat_id),\\n';\n  code += '        message_type=\"bot\",\\n';\n  code += '        message_text=text,\\n';\n  code += '        node_id=node_id,\\n';\n  code += '        message_data=message_data_obj\\n';\n  code += '    )\\n';\n  code += '    return result\\n\\n';\n  code += 'bot.send_message = send_message_with_logging\\n\\n';\n  \n  code += '# Обертка для message.answer с сохранением\\n';\n  code += 'original_answer = types.Message.answer\\n';\n  code += 'async def answer_with_logging(self, text, *args, node_id=None, **kwargs):\\n';\n  code += '    \"\"\"Обертка для message.answer с автоматическим сохранением\"\"\"\\n';\n  code += '    result = await original_answer(self, text, *args, **kwargs)\\n';\n  code += '    \\n';\n  code += '    # Извлекаем информацию о кнопках из reply_markup\\n';\n  code += '    message_data_obj = {\"message_id\": result.message_id if result else None}\\n';\n  code += '    if \"reply_markup\" in kwargs:\\n';\n  code += '        try:\\n';\n  code += '            reply_markup = kwargs[\"reply_markup\"]\\n';\n  code += '            buttons_data = []\\n';\n  code += '            # Обработка inline клавиатуры\\n';\n  code += '            if hasattr(reply_markup, \"inline_keyboard\"):\\n';\n  code += '                for row in reply_markup.inline_keyboard:\\n';\n  code += '                    for btn in row:\\n';\n  code += '                        button_info = {\"text\": btn.text}\\n';\n  code += '                        if hasattr(btn, \"url\") and btn.url:\\n';\n  code += '                            button_info[\"url\"] = btn.url\\n';\n  code += '                        if hasattr(btn, \"callback_data\") and btn.callback_data:\\n';\n  code += '                            button_info[\"callback_data\"] = btn.callback_data\\n';\n  code += '                        buttons_data.append(button_info)\\n';\n  code += '                if buttons_data:\\n';\n  code += '                    message_data_obj[\"buttons\"] = buttons_data\\n';\n  code += '                    message_data_obj[\"keyboard_type\"] = \"inline\"\\n';\n  code += '            # Обработка reply клавиатуры\\n';\n  code += '            elif hasattr(reply_markup, \"keyboard\"):\\n';\n  code += '                for row in reply_markup.keyboard:\\n';\n  code += '                    for btn in row:\\n';\n  code += '                        button_info = {\"text\": btn.text}\\n';\n  code += '                        if hasattr(btn, \"request_contact\") and btn.request_contact:\\n';\n  code += '                            button_info[\"request_contact\"] = True\\n';\n  code += '                        if hasattr(btn, \"request_location\") and btn.request_location:\\n';\n  code += '                            button_info[\"request_location\"] = True\\n';\n  code += '                        buttons_data.append(button_info)\\n';\n  code += '                if buttons_data:\\n';\n  code += '                    message_data_obj[\"buttons\"] = buttons_data\\n';\n  code += '                    message_data_obj[\"keyboard_type\"] = \"reply\"\\n';\n  code += '        except Exception as e:\\n';\n  code += '            logging.warning(f\"Не удалось извлечь кнопки: {e}\")\\n';\n  code += '    \\n';\n  code += '    # Сохраняем синхронно для гарантии доставки\\n';\n  code += '    await save_message_to_api(\\n';\n  code += '        user_id=str(self.chat.id),\\n';\n  code += '        message_type=\"bot\",\\n';\n  code += '        message_text=text if isinstance(text, str) else str(text),\\n';\n  code += '        node_id=node_id,\\n';\n  code += '        message_data=message_data_obj\\n';\n  code += '    )\\n';\n  code += '    return result\\n\\n';\n  code += 'types.Message.answer = answer_with_logging\\n\\n';\n  \n  code += '# Обертка для bot.send_photo с сохранением\\n';\n  code += 'original_send_photo = bot.send_photo\\n';\n  code += 'async def send_photo_with_logging(chat_id, photo, *args, caption=None, node_id=None, **kwargs):\\n';\n  code += '    \"\"\"Обертка для bot.send_photo с автоматическим сохранением\"\"\"\\n';\n  code += '    result = await original_send_photo(chat_id, photo, *args, caption=caption, **kwargs)\\n';\n  code += '    \\n';\n  code += '    # Создаем message_data с информацией о фото\\n';\n  code += '    message_data_obj = {\"message_id\": result.message_id if result else None}\\n';\n  code += '    \\n';\n  code += '    # Сохраняем информацию о фото\\n';\n  code += '    if result and hasattr(result, \"photo\") and result.photo:\\n';\n  code += '        largest_photo = result.photo[-1]\\n';\n  code += '        message_data_obj[\"photo\"] = {\\n';\n  code += '            \"file_id\": largest_photo.file_id,\\n';\n  code += '            \"file_unique_id\": largest_photo.file_unique_id,\\n';\n  code += '            \"width\": largest_photo.width,\\n';\n  code += '            \"height\": largest_photo.height\\n';\n  code += '        }\\n';\n  code += '    # Если photo это строка (URL), сохраняем URL\\n';\n  code += '    elif isinstance(photo, str):\\n';\n  code += '        message_data_obj[\"photo_url\"] = photo\\n';\n  code += '    \\n';\n  code += '    # Извлекаем информацию о кнопках из reply_markup\\n';\n  code += '    if \"reply_markup\" in kwargs:\\n';\n  code += '        try:\\n';\n  code += '            reply_markup = kwargs[\"reply_markup\"]\\n';\n  code += '            buttons_data = []\\n';\n  code += '            if hasattr(reply_markup, \"inline_keyboard\"):\\n';\n  code += '                for row in reply_markup.inline_keyboard:\\n';\n  code += '                    for btn in row:\\n';\n  code += '                        button_info = {\"text\": btn.text}\\n';\n  code += '                        if hasattr(btn, \"url\") and btn.url:\\n';\n  code += '                            button_info[\"url\"] = btn.url\\n';\n  code += '                        if hasattr(btn, \"callback_data\") and btn.callback_data:\\n';\n  code += '                            button_info[\"callback_data\"] = btn.callback_data\\n';\n  code += '                        buttons_data.append(button_info)\\n';\n  code += '                if buttons_data:\\n';\n  code += '                    message_data_obj[\"buttons\"] = buttons_data\\n';\n  code += '                    message_data_obj[\"keyboard_type\"] = \"inline\"\\n';\n  code += '        except Exception as e:\\n';\n  code += '            logging.warning(f\"Не удалось извлечь кнопки из send_photo: {e}\")\\n';\n  code += '    \\n';\n  code += '    # Сохраняем сообщение в базу данных\\n';\n  code += '    saved_message = await save_message_to_api(\\n';\n  code += '        user_id=str(chat_id),\\n';\n  code += '        message_type=\"bot\",\\n';\n  code += '        message_text=caption or \"[Фото]\",\\n';\n  code += '        node_id=node_id,\\n';\n  code += '        message_data=message_data_obj\\n';\n  code += '    )\\n';\n  code += '    \\n';\n  code += '    # Если фото отправлено от бота с file_id, регистрируем медиа\\n';\n  code += '    if result and hasattr(result, \"photo\") and result.photo and saved_message and \"id\" in saved_message:\\n';\n  code += '        try:\\n';\n  code += '            largest_photo = result.photo[-1]\\n';\n  code += '            if API_BASE_URL.startswith(\"http://\") or API_BASE_URL.startswith(\"https://\"):\\n';\n  code += '                media_api_url = f\"{API_BASE_URL}/api/projects/{PROJECT_ID}/media/register-telegram-photo\"\\n';\n  code += '            else:\\n';\n  code += '                media_api_url = f\"https://{API_BASE_URL}/api/projects/{PROJECT_ID}/media/register-telegram-photo\"\\n';\n  code += '            \\n';\n  code += '            media_payload = {\\n';\n  code += '                \"messageId\": saved_message[\"id\"],\\n';\n  code += '                \"fileId\": largest_photo.file_id,\\n';\n  code += '                \"botToken\": BOT_TOKEN,\\n';\n  code += '                \"mediaType\": \"photo\"\\n';\n  code += '            }\\n';\n  code += '            \\n';\n  code += '            async with aiohttp.ClientSession() as session:\\n';\n  code += '                async with session.post(media_api_url, json=media_payload, timeout=aiohttp.ClientTimeout(total=10)) as response:\\n';\n  code += '                    if response.status == 200:\\n';\n  code += '                        bot_message_id = saved_message.get(\"id\")\\n';\n  code += '                        logging.info(f\"✅ Медиа бота зарегистрировано для сообщения {bot_message_id}\")\\n';\n  code += '                    else:\\n';\n  code += '                        error_text = await response.text()\\n';\n  code += '                        logging.warning(f\"⚠️ Не удалось зарегистрировать медиа бота: {response.status} - {error_text}\")\\n';\n  code += '        except Exception as media_error:\\n';\n  code += '            logging.warning(f\"Ошибка при регистрации медиа бота: {media_error}\")\\n';\n  code += '    \\n';\n  code += '    return result\\n\\n';\n  code += 'bot.send_photo = send_photo_with_logging\\n\\n';\n  \n  // Добавляем конфигурацию групп\n  if (groups && groups.length > 0) {\n    code += '# Подключенные группы\\n';\n    code += 'CONNECTED_GROUPS = {\\n';\n    groups.forEach((group, index) => {\n      const groupId = group.groupId || 'None';\n      const isLast = index === groups.length - 1;\n      code += `    \"${group.name}\": {\\n`;\n      code += `        \"id\": ${groupId === 'None' ? 'None' : `\"${groupId}\"`},\\n`;\n      code += `        \"url\": \"${group.url}\",\\n`;\n      code += `        \"is_admin\": ${group.isAdmin ? 'True' : 'False'},\\n`;\n      code += `        \"chat_type\": \"${group.chatType || 'group'}\",\\n`;\n      if (group.adminRights) {\n        code += `        \"admin_rights\": ${JSON.stringify(group.adminRights, null, 12).replace(/\"/g, \"'\")},\\n`;\n      }\n      code += `        \"description\": \"${group.description || ''}\"\\n`;\n      code += `    }${isLast ? '' : ','}\\n`;\n    });\n    code += '}\\n\\n';\n  }\n  \n  // user_data всегда нужен для временного хранения состояний даже при включенной БД\n  const needsUserData = (\n    hasMultiSelectNodes(nodes || []) || \n    hasInputCollection(nodes || []) ||\n    hasInlineButtons(nodes || [])\n  );\n  \n  if (needsUserData) {\n    code += '# Хранилище пользователей (временное состояние)\\n';\n    code += 'user_data = {}\\n\\n';\n  }\n\n  // Добавляем функции для работы с базой данных только если БД включена\n  if (userDatabaseEnabled) {\n    code += '# Настройки базы данных\\n';\n    code += 'DATABASE_URL = os.getenv(\"DATABASE_URL\")\\n\\n';\n    \n    code += '# Пул соединений с базой данных\\n';\n    code += 'db_pool = None\\n\\n';\n\n    code += '\\n# Функции для работы с базой данных\\n';\n    code += 'async def init_database():\\n';\n  code += '    \"\"\"Инициализация подключения к базе данных и создание таблиц\"\"\"\\n';\n  code += '    global db_pool\\n';\n  code += '    try:\\n';\n  code += '        db_pool = await asyncpg.create_pool(DATABASE_URL, min_size=1, max_size=10)\\n';\n  code += '        # Создаем таблицу пользователей если её нет\\n';\n  code += '        async with db_pool.acquire() as conn:\\n';\n  code += '            await conn.execute(\"\"\"\\n';\n  code += '                CREATE TABLE IF NOT EXISTS bot_users (\\n';\n  code += '                    user_id BIGINT PRIMARY KEY,\\n';\n  code += '                    username TEXT,\\n';\n  code += '                    first_name TEXT,\\n';\n  code += '                    last_name TEXT,\\n';\n  code += '                    registered_at TIMESTAMP DEFAULT NOW(),\\n';\n  code += '                    last_interaction TIMESTAMP DEFAULT NOW(),\\n';\n  code += '                    interaction_count INTEGER DEFAULT 0,\\n';\n  code += '                    user_data JSONB DEFAULT \\'{}\\',\\n';\n  code += '                    is_active BOOLEAN DEFAULT TRUE\\n';\n  code += '                );\\n';\n  code += '            \"\"\")\\n';\n  code += '            # Создаем таблицу сообщений если её нет\\n';\n  code += '            await conn.execute(\"\"\"\\n';\n  code += '                CREATE TABLE IF NOT EXISTS bot_messages (\\n';\n  code += '                    id SERIAL PRIMARY KEY,\\n';\n  code += '                    project_id INTEGER,\\n';\n  code += '                    user_id TEXT NOT NULL,\\n';\n  code += '                    message_type TEXT NOT NULL,\\n';\n  code += '                    message_text TEXT,\\n';\n  code += '                    message_data JSONB,\\n';\n  code += '                    node_id TEXT,\\n';\n  code += '                    created_at TIMESTAMP DEFAULT NOW()\\n';\n  code += '                );\\n';\n  code += '            \"\"\")\\n';\n  code += '        logging.info(\"✅ База данных инициализирована\")\\n';\n  code += '    except Exception as e:\\n';\n  code += '        logging.warning(f\"⚠️ Не удалось подключиться к БД: {e}. Используем локальное хранилище.\")\\n';\n  code += '        db_pool = None\\n\\n';\n\n  // Добавляем функцию для получения московского времени\n  code += 'def get_moscow_time():\\n';\n  code += '    \"\"\"Возвращает текущее время в московском часовом поясе\"\"\"\\n';\n  code += '    from datetime import datetime, timezone, timedelta\\n';\n  code += '    moscow_tz = timezone(timedelta(hours=3))\\n';\n  code += '    return datetime.now(moscow_tz).isoformat()\\n\\n';\n\n  code += 'async def save_user_to_db(user_id: int, username: Optional[str] = None, first_name: Optional[str] = None, last_name: Optional[str] = None):\\n';\n  code += '    \"\"\"Сохраняет пользователя в базу данных\"\"\"\\n';\n  code += '    if not db_pool:\\n';\n  code += '        return False\\n';\n  code += '    try:\\n';\n  code += '        async with db_pool.acquire() as conn:\\n';\n  code += '            await conn.execute(\"\"\"\\n';\n  code += '                INSERT INTO bot_users (user_id, username, first_name, last_name)\\n';\n  code += '                VALUES ($1, $2, $3, $4)\\n';\n  code += '                ON CONFLICT (user_id) DO UPDATE SET\\n';\n  code += '                    username = EXCLUDED.username,\\n';\n  code += '                    first_name = EXCLUDED.first_name,\\n';\n  code += '                    last_name = EXCLUDED.last_name,\\n';\n  code += '                    last_interaction = NOW(),\\n';\n  code += '                    interaction_count = bot_users.interaction_count + 1\\n';\n  code += '            \"\"\", user_id, username, first_name, last_name)\\n';\n  code += '        return True\\n';\n  code += '    except Exception as e:\\n';\n  code += '        logging.error(f\"Ошибка сохранения пользователя в БД: {e}\")\\n';\n  code += '        return False\\n\\n';\n\n  code += 'async def get_user_from_db(user_id: int):\\n';\n  code += '    \"\"\"Получает данные пользователя из базы данных\"\"\"\\n';\n  code += '    if not db_pool:\\n';\n  code += '        return None\\n';\n  code += '    try:\\n';\n  code += '        async with db_pool.acquire() as conn:\\n';\n  code += '            row = await conn.fetchrow(\"SELECT * FROM bot_users WHERE user_id = $1\", user_id)\\n';\n  code += '            if row:\\n';\n  code += '                # Преобразуем Record в словарь\\n';\n  code += '                row_dict = {key: row[key] for key in row.keys()}\\n';\n  code += '                # Если есть user_data, возвращаем его содержимое\\n';\n  code += '                if \"user_data\" in row_dict and row_dict[\"user_data\"]:\\n';\n  code += '                    user_data = row_dict[\"user_data\"]\\n';\n  code += '                    if isinstance(user_data, str):\\n';\n  code += '                        try:\\n';\n  code += '                            import json\\n';\n  code += '                            return json.loads(user_data)\\n';\n  code += '                        except (json.JSONDecodeError, TypeError):\\n';\n  code += '                            return {}\\n';\n  code += '                    elif isinstance(user_data, dict):\\n';\n  code += '                        return user_data\\n';\n  code += '                    else:\\n';\n  code += '                        return {}\\n';\n  code += '                # Если нет user_data, возвращаем полную запись\\n';\n  code += '                return row_dict\\n';\n  code += '        return None\\n';\n  code += '    except Exception as e:\\n';\n  code += '        logging.error(f\"Ошибка получения пользователя из БД: {e}\")\\n';\n  code += '        return None\\n\\n';\n\n  // Добавляем функции handle_command_ как алиасы для handlers\n  code += '# Алиас функции для callback обработчиков\\n';\n  code += 'async def handle_command_start(message):\\n';\n  code += '    \"\"\"Алиас для start_handler, используется в callback обработчиках\"\"\"\\n';\n  code += '    await start_handler(message)\\n\\n';\n  \n  // Добавляем алиасы для всех команд\n  const commandAliasNodes = (nodes || []).filter(node => node.type === 'command' && node.data.command);\n  commandAliasNodes.forEach(node => {\n    const command = node.data.command.replace('/', '');\n    const functionName = command.replace(/[^a-zA-Z0-9_]/g, '_');\n    code += `async def handle_command_${functionName}(message):\\n`;\n    code += `    \"\"\"Алиас для ${functionName}_handler, используется в callback обработчиках\"\"\"\\n`;\n    code += `    await ${functionName}_handler(message)\\n\\n`;\n  });\n\n  code += 'async def update_user_data_in_db(user_id: int, data_key: str, data_value):\\n';\n  code += '    \"\"\"Обновляет пользовательские данные в базе данных\"\"\"\\n';\n  code += '    if not db_pool:\\n';\n  code += '        return False\\n';\n  code += '    try:\\n';\n  code += '        import json\\n';\n  code += '        async with db_pool.acquire() as conn:\\n';\n  code += '            # Сначала создаём или получаем существующую запись\\n';\n  code += '            await conn.execute(\"\"\"\\n';\n  code += '                INSERT INTO bot_users (user_id) \\n';\n  code += '                VALUES ($1) \\n';\n  code += '                ON CONFLICT (user_id) DO NOTHING\\n';\n  code += '            \"\"\", user_id)\\n';\n  code += '            \\n';\n  code += '            # Обновляем данные пользователя\\n';\n  code += '            update_data = {data_key: data_value}\\n';\n  code += '            await conn.execute(\"\"\"\\n';\n  code += '                UPDATE bot_users \\n';\n  code += '                SET user_data = COALESCE(user_data, \\'{}\\'::jsonb) || $2::jsonb,\\n';\n  code += '                    last_interaction = NOW()\\n';\n  code += '                WHERE user_id = $1\\n';\n  code += '            \"\"\", user_id, json.dumps(update_data))\\n';\n  code += '        return True\\n';\n  code += '    except Exception as e:\\n';\n  code += '        logging.error(f\"Ошибка обновления данных пользователя: {e}\")\\n';\n  code += '        return False\\n\\n';\n\n  // Добавляем алиас функции для обратной совместимости\n  code += 'async def save_user_data_to_db(user_id: int, data_key: str, data_value):\\n';\n  code += '    \"\"\"Алиас для update_user_data_in_db для обратной совместимости\"\"\"\\n';\n  code += '    return await update_user_data_in_db(user_id, data_key, data_value)\\n\\n';\n\n    code += 'async def update_user_variable_in_db(user_id: int, variable_name: str, variable_value: str):\\n';\n    code += '    \"\"\"Сохраняет переменную пользователя в базу данных\"\"\"\\n';\n    code += '    if not db_pool:\\n';\n    code += '        return False\\n';\n    code += '    try:\\n';\n    code += '        import json\\n';\n    code += '        async with db_pool.acquire() as conn:\\n';\n    code += '            # Сначала создаём или получаем существующую запись\\n';\n    code += '            await conn.execute(\"\"\"\\n';\n    code += '                INSERT INTO bot_users (user_id) \\n';\n    code += '                VALUES ($1) \\n';\n    code += '                ON CONFLICT (user_id) DO NOTHING\\n';\n    code += '            \"\"\", user_id)\\n';\n    code += '            \\n';\n    code += '            # Обновляем переменную пользователя\\n';\n    code += '            update_data = {variable_name: variable_value}\\n';\n    code += '            await conn.execute(\"\"\"\\n';\n    code += '                UPDATE bot_users \\n';\n    code += '                SET user_data = COALESCE(user_data, \\'{}\\'::jsonb) || $2::jsonb,\\n';\n    code += '                    last_interaction = NOW()\\n';\n    code += '                WHERE user_id = $1\\n';\n    code += '            \"\"\", user_id, json.dumps(update_data))\\n';\n    code += '        return True\\n';\n    code += '    except Exception as e:\\n';\n    code += '        logging.error(f\"Ошибка сохранения переменной пользователя: {e}\")\\n';\n    code += '        return False\\n\\n';\n\n    code += 'async def log_message(user_id: int, message_type: str, message_text: str = None, message_data: dict = None, node_id: str = None):\\n';\n    code += '    \"\"\"Логирует сообщение в базу данных\"\"\"\\n';\n    code += '    if not db_pool:\\n';\n    code += '        return False\\n';\n    code += '    try:\\n';\n    code += '        import json\\n';\n    code += '        async with db_pool.acquire() as conn:\\n';\n    code += '            await conn.execute(\"\"\"\\n';\n    code += '                INSERT INTO bot_messages (user_id, message_type, message_text, message_data, node_id)\\n';\n    code += '                VALUES ($1, $2, $3, $4, $5)\\n';\n    code += '            \"\"\", str(user_id), message_type, message_text, json.dumps(message_data) if message_data else None, node_id)\\n';\n    code += '        return True\\n';\n    code += '    except Exception as e:\\n';\n    code += '        logging.error(f\"Ошибка логирования сообщения: {e}\")\\n';\n    code += '        return False\\n\\n';\n  }\n\n  // Добавляем утилитарные функции\n  code += '\\n# Утилитарные функции\\n';\n  code += 'async def is_admin(user_id: int) -> bool:\\n';\n  code += '    return user_id in ADMIN_IDS\\n\\n';\n  \n  code += 'async def is_private_chat(message: types.Message) -> bool:\\n';\n  code += '    return message.chat.type == \"private\"\\n\\n';\n  \n  if (userDatabaseEnabled) {\n    code += 'async def check_auth(user_id: int) -> bool:\\n';\n    code += '    # Проверяем наличие пользователя в БД или локальном хранилище\\n';\n    code += '    if db_pool:\\n';\n    code += '        user = await get_user_from_db(user_id)\\n';\n    code += '        return user is not None\\n';\n    code += '    return user_id in user_data\\n\\n';\n  } else {\n    // Простая версия без БД - проверяем только локальное хранилище\n    code += 'async def check_auth(user_id: int) -> bool:\\n';\n    code += '    return user_id in user_data\\n\\n';\n  }\n  \n  // Функции для работы с файлами - только если есть медиа\n  if (hasMediaNodes(nodes || [])) {\n    code += 'def is_local_file(url: str) -> bool:\\n';\n    code += '    \"\"\"Проверяет, является ли URL локальным загруженным файлом\"\"\"\\n';\n    code += '    return url.startswith(\"/uploads/\") or url.startswith(\"uploads/\")\\n\\n';\n    \n    code += 'def get_local_file_path(url: str) -> str:\\n';\n    code += '    \"\"\"Получает локальный путь к файлу из URL\"\"\"\\n';\n    code += '    if url.startswith(\"/\"):\\n';\n    code += '        return url[1:]  # Убираем ведущий слеш\\n';\n    code += '    return url\\n\\n';\n  }\n\n  // Добавляем функции для работы с картографическими сервисами только если есть геолокационные элементы\n  if (hasLocationFeatures(nodes || [])) {\n    code += 'def extract_coordinates_from_yandex(url: str) -> tuple:\\n';\n    code += '    \"\"\"Извлекает координаты из ссылки Яндекс.Карт\"\"\"\\n';\n    code += '    import re\\n';\n    code += '    # Ищем координаты в формате ll=longitude,latitude\\n';\n    code += '    match = re.search(r\"ll=([\\\\d.-]+),([\\\\d.-]+)\", url)\\n';\n    code += '    if match:\\n';\n    code += '        return float(match.group(2)), float(match.group(1))  # lat, lon\\n';\n    code += '    # Ищем координаты в формате /longitude,latitude/\\n';\n    code += '    match = re.search(r\"/([\\\\d.-]+),([\\\\d.-]+)/\", url)\\n';\n    code += '    if match:\\n';\n    code += '        return float(match.group(2)), float(match.group(1))  # lat, lon\\n';\n    code += '    return None, None\\n\\n';\n\n    code += 'def extract_coordinates_from_google(url: str) -> tuple:\\n';\n    code += '    \"\"\"Извлекает координаты из ссылки Google Maps\"\"\"\\n';\n    code += '    import re\\n';\n    code += '    # Ищем координаты в формате @latitude,longitude\\n';\n    code += '    match = re.search(r\"@([\\\\d.-]+),([\\\\d.-]+)\", url)\\n';\n    code += '    if match:\\n';\n    code += '        return float(match.group(1)), float(match.group(2))  # lat, lon\\n';\n    code += '    # Ищем координаты в формате /latitude,longitude/\\n';\n    code += '    match = re.search(r\"/([\\\\d.-]+),([\\\\d.-]+)/\", url)\\n';\n    code += '    if match:\\n';\n    code += '        return float(match.group(1)), float(match.group(2))  # lat, lon\\n';\n    code += '    return None, None\\n\\n';\n\n    code += 'def extract_coordinates_from_2gis(url: str) -> tuple:\\n';\n    code += '    \"\"\"Извлекает координаты из ссылки 2ГИС\"\"\"\\n';\n    code += '    import re\\n';\n    code += '    # Ищем координаты в различных форматах 2ГИС\\n';\n    code += '    # Формат: center/longitude,latitude\\n';\n    code += '    match = re.search(r\"center/([\\\\d.-]+),([\\\\d.-]+)\", url)\\n';\n    code += '    if match:\\n';\n    code += '        return float(match.group(2)), float(match.group(1))  # lat, lon\\n';\n    code += '    # Формат: /longitude,latitude/\\n';\n    code += '    match = re.search(r\"/([\\\\d.-]+),([\\\\d.-]+)/\", url)\\n';\n    code += '    if match:\\n';\n    code += '        return float(match.group(2)), float(match.group(1))  # lat, lon\\n';\n    code += '    return None, None\\n\\n';\n\n    code += 'def generate_map_urls(latitude: float, longitude: float, title: str = \"\") -> dict:\\n';\n    code += '    \"\"\"Генерирует ссылки на различные картографические сервисы\"\"\"\\n';\n    code += '    import urllib.parse\\n';\n    code += '    \\n';\n    code += '    encoded_title = urllib.parse.quote(title) if title else \"\"\\n';\n    code += '    \\n';\n    code += '    return {\\n';\n    code += '        \"yandex\": f\"https://yandex.ru/maps/?ll={longitude},{latitude}&z=15&l=map&pt={longitude},{latitude}\",\\n';\n    code += '        \"google\": f\"https://maps.google.com/?q={latitude},{longitude}\",\\n';\n    code += '        \"2gis\": f\"https://2gis.ru/geo/{longitude},{latitude}\",\\n';\n    code += '        \"openstreetmap\": f\"https://www.openstreetmap.org/?mlat={latitude}&mlon={longitude}&zoom=15\"\\n';\n    code += '    }\\n\\n';\n  }\n\n  // Настройка меню команд для BotFather\n  const menuCommands = (nodes || []).filter(node => \n    (node.type === 'start' || node.type === 'command') && \n    node.data.showInMenu && \n    node.data.command\n  );\n\n  if (menuCommands.length > 0) {\n    code += '\\n# Настройка меню команд\\n';\n    code += 'async def set_bot_commands():\\n';\n    code += '    commands = [\\n';\n    \n    menuCommands.forEach(node => {\n      const command = node.data.command?.replace('/', '') || '';\n      const description = node.data.description || 'Команда бота';\n      code += `        BotCommand(command=\"${command}\", description=\"${description}\"),\\n`;\n    });\n    \n    code += '    ]\\n';\n    code += '    await bot.set_my_commands(commands)\\n\\n';\n  }\n\n  // Generate handlers for each node\n  (nodes || []).forEach((node: Node) => {\n    // Добавляем маркер начала узла для отслеживания позиции в коде\n    code += `\\n# @@NODE_START:${node.id}@@\\n`;\n    \n    if (node.type === \"start\") {\n      code += generateStartHandler(node, userDatabaseEnabled);\n    } else if (node.type === \"command\") {\n      code += generateCommandHandler(node, userDatabaseEnabled);\n    } else if (node.type === \"photo\") {\n      code += generatePhotoHandler(node);\n    } else if (node.type === \"video\") {\n      code += generateVideoHandler(node);\n    } else if (node.type === \"audio\") {\n      code += generateAudioHandler(node);\n    } else if (node.type === \"document\") {\n      code += generateDocumentHandler(node);\n    } else if (node.type === \"sticker\") {\n      code += generateStickerHandler(node);\n    } else if (node.type === \"voice\") {\n      code += generateVoiceHandler(node);\n    } else if (node.type === \"animation\") {\n      code += generateAnimationHandler(node);\n    } else if (node.type === \"location\") {\n      code += generateLocationHandler(node);\n    } else if (node.type === \"contact\") {\n      code += generateContactHandler(node);\n    } else if (node.type === \"pin_message\") {\n      code += generatePinMessageHandler(node);\n    } else if (node.type === \"unpin_message\") {\n      code += generateUnpinMessageHandler(node);\n    } else if (node.type === \"delete_message\") {\n      code += generateDeleteMessageHandler(node);\n    } else if (node.type === \"ban_user\") {\n      code += generateBanUserHandler(node);\n    } else if (node.type === \"unban_user\") {\n      code += generateUnbanUserHandler(node);\n    } else if (node.type === \"mute_user\") {\n      code += generateMuteUserHandler(node);\n    } else if (node.type === \"unmute_user\") {\n      code += generateUnmuteUserHandler(node);\n    } else if (node.type === \"kick_user\") {\n      code += generateKickUserHandler(node);\n    } else if (node.type === \"promote_user\") {\n      code += generatePromoteUserHandler(node);\n    } else if (node.type === \"demote_user\") {\n      code += generateDemoteUserHandler(node);\n    } else if (node.type === \"admin_rights\") {\n      code += generateAdminRightsHandler(node);\n    }\n    // Note: user-input and message nodes are handled via callback handlers, not as separate command handlers\n    \n    // Добавляем маркер конца узла\n    code += `# @@NODE_END:${node.id}@@\\n`;\n  });\n\n  // Generate synonym handlers for all nodes\n  const nodesWithSynonyms = (nodes || []).filter(node => \n    node.data.synonyms && \n    node.data.synonyms.length > 0\n  );\n\n  if (nodesWithSynonyms.length > 0) {\n    code += '\\n# Обработчики синонимов\\n';\n    nodesWithSynonyms.forEach(node => {\n      if (node.data.synonyms) {\n        node.data.synonyms.forEach((synonym: string) => {\n          // Добавляем маркер для синонимов того же узла\n          code += `# @@NODE_START:${node.id}@@\\n`;\n          \n          if (node.type === 'start' || node.type === 'command') {\n            code += generateSynonymHandler(node, synonym);\n          } else if (node.type === 'ban_user' || node.type === 'unban_user' || node.type === 'mute_user' || node.type === 'unmute_user' || \n                     node.type === 'kick_user' || node.type === 'promote_user' || node.type === 'demote_user' || node.type === 'admin_rights') {\n            code += generateUserManagementSynonymHandler(node, synonym);\n          } else {\n            code += generateMessageSynonymHandler(node, synonym);\n          }\n          \n          code += `# @@NODE_END:${node.id}@@\\n`;\n        });\n      }\n    });\n  }\n\n  // Generate callback handlers for inline buttons AND input target nodes\n  const inlineNodes = (nodes || []).filter(node => \n    node.data.keyboardType === 'inline' && node.data.buttons && node.data.buttons.length > 0\n  );\n\n  // Also collect all target nodes from user input collections\n  const inputTargetNodeIds = new Set<string>();\n  (nodes || []).forEach(node => {\n    if (node.data.inputTargetNodeId) {\n      inputTargetNodeIds.add(node.data.inputTargetNodeId);\n    }\n  });\n\n  // Collect all referenced node IDs and conditional message buttons\n  const allReferencedNodeIds = new Set<string>();\n  const allConditionalButtons = new Set<string>();\n  \n  // Add nodes from inline buttons\n  inlineNodes.forEach(node => {\n    node.data.buttons.forEach(button => {\n      if (button.action === 'goto' && button.target) {\n        allReferencedNodeIds.add(button.target);\n      }\n    });\n    \n    // Also add continueButtonTarget for multi-select nodes\n    if (node.data.continueButtonTarget) {\n      allReferencedNodeIds.add(node.data.continueButtonTarget);\n    }\n  });\n  \n  // Collect buttons from conditional messages\n  (nodes || []).forEach(node => {\n    if (node.data.conditionalMessages) {\n      node.data.conditionalMessages.forEach((condition: any) => {\n        if (condition.buttons) {\n          condition.buttons.forEach((button: any) => {\n            if (button.action === 'goto' && button.target) {\n              allConditionalButtons.add(button.target);\n            }\n          });\n        }\n      });\n    }\n  });\n  \n  // Add input target nodes\n  inputTargetNodeIds.forEach(nodeId => {\n    allReferencedNodeIds.add(nodeId);\n  });\n\n  // Add all connection targets to ensure every connected node gets a handler\n  console.log(`🔗 ГЕНЕРАТОР: Обрабатываем ${connections.length} соединений`);\n  connections.forEach((connection, index) => {\n    console.log(`🔗 ГЕНЕРАТОР: Соединение ${index}: source=${connection.source} -> target=${connection.target}`);\n    if (connection.target) {\n      allReferencedNodeIds.add(connection.target);\n      console.log(`✅ ГЕНЕРАТОР: Добавлен target ${connection.target} в allReferencedNodeIds`);\n    }\n  });\n  console.log(`🎯 ГЕНЕРАТОР: Финальный allReferencedNodeIds: ${Array.from(allReferencedNodeIds).join(', ')}`);\n\n  if (inlineNodes.length > 0 || allReferencedNodeIds.size > 0 || allConditionalButtons.size > 0) {\n    code += '\\n# Обработчики inline кнопок\\n';\n    const processedCallbacks = new Set<string>();\n    \n    // Skip conditional placeholder handlers - they conflict with main handlers\n    // Main callback handlers below will handle all button interactions properly\n    \n    // Then, handle inline button nodes - create handlers for each unique button ID\n    inlineNodes.forEach(node => {\n      node.data.buttons.forEach(button => {\n        if (button.action === 'goto' && button.id) {\n          const callbackData = button.id; // Use button ID as callback_data\n          \n          // Avoid duplicate handlers for button IDs (not target IDs)\n          if (processedCallbacks.has(callbackData)) return;\n          \n          // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Избегаем дублированных обработчиков для target узлов\n          if (button.target && processedCallbacks.has(button.target)) {\n            console.log(`🚨 ГЕНЕРАТОР: ПРОПУСКАЕМ дублирующий обработчик для target ${button.target} - уже создан`);\n            return;\n          }\n          \n          // Find target node (может быть null если нет target)\n          const targetNode = button.target ? nodes.find(n => n.id === button.target) : null;\n          \n          // Создаем обработчик для каждой кнопки используя target как callback_data\n          const actualCallbackData = button.target || callbackData;\n          \n          // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверяем target узел перед созданием обработчика\n          if (button.target && processedCallbacks.has(button.target)) {\n            console.log(`🚨 ГЕНЕРАТОР ОСНОВНОЙ ЦИКЛ: ПРОПУСКАЕМ дублирующий обработчик для target ${button.target} - уже создан`);\n            return;\n          }\n          \n          // Mark this button ID as processed\n          processedCallbacks.add(callbackData);\n          \n          // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Добавляем target в processedCallbacks СРАЗУ, чтобы избежать дублирования\n          if (button.target) {\n            processedCallbacks.add(button.target);\n            console.log(`🔧 ГЕНЕРАТОР: Узел ${button.target} добавлен в processedCallbacks ДО создания обработчика`);\n          }\n          \n          // ОТЛАДКА: Проверяем если это interests_result или metro_selection\n          if (button.target === 'interests_result') {\n            console.log('🔧 ГЕНЕРАТОР DEBUG: Создаем ПЕРВЫЙ обработчик для interests_result в основном цикле');\n            console.log('🔧 ГЕНЕРАТОР DEBUG: processedCallbacks до добавления:', Array.from(processedCallbacks));\n          }\n          if (button.target === 'metro_selection') {\n            console.log('🔧 ГЕНЕРАТОР DEBUG: Создаем ПЕРВЫЙ обработчик для metro_selection в основном цикле');\n            console.log('🔧 ГЕНЕРАТОР DEBUG: processedCallbacks до добавления:', Array.from(processedCallbacks));\n          }\n          \n          // Если целевой узел имеет множественный выбор, добавляем обработку кнопки \"done_\"\n          const isDoneHandlerNeeded = targetNode && targetNode.data.allowMultipleSelection && targetNode.data.continueButtonTarget;\n          const shortNodeIdForDone = isDoneHandlerNeeded ? actualCallbackData.slice(-10).replace(/^_+/, '') : '';\n          \n          // ЛОГИРОВАНИЕ: Отслеживаем создание обработчиков для interests_result\n          if (actualCallbackData === 'interests_result') {\n            console.log('🚨 ГЕНЕРАТОР ОСНОВНОЙ ЦИКЛ: Создаем обработчик для interests_result!');\n            console.log('🚨 ГЕНЕРАТОР: Текущие processedCallbacks:', Array.from(processedCallbacks));\n          }\n          \n          if (isDoneHandlerNeeded) {\n            code += `\\n@dp.callback_query(lambda c: c.data == \"${actualCallbackData}\" or c.data.startswith(\"${actualCallbackData}_btn_\") or c.data == \"multi_select_done_${shortNodeIdForDone}\")\\n`;\n            console.log(`🔧 ГЕНЕРАТОР: КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ! Добавлен обработчик кнопки \"multi_select_done_${shortNodeIdForDone}\" для узла ${actualCallbackData}`);\n          } else {\n            code += `\\n@dp.callback_query(lambda c: c.data == \"${actualCallbackData}\" or c.data.startswith(\"${actualCallbackData}_btn_\"))\\n`;\n          }\n          // Создаем безопасное имя функции на основе target или button ID\n          const safeFunctionName = actualCallbackData.replace(/[^a-zA-Z0-9_]/g, '_');\n          \n          if (actualCallbackData === 'interests_result') {\n            console.log('🚨 ГЕНЕРАТОР: Создаем функцию handle_callback_interests_result в ОСНОВНОМ ЦИКЛЕ');\n          }\n          \n          code += `async def handle_callback_${safeFunctionName}(callback_query: types.CallbackQuery):\\n`;\n          code += '    await callback_query.answer()\\n';\n          code += '    user_id = callback_query.from_user.id\\n';\n          code += '    callback_data = callback_query.data\\n';\n          code += '    \\n';\n          \n          // Добавляем обработку кнопки \"done_\" для множественного выбора\n          if (isDoneHandlerNeeded) {\n            code += '    # Проверяем, является ли это кнопкой \"Готово\" для множественного выбора\\n';\n            code += `    if callback_data == \"multi_select_done_${shortNodeIdForDone}\":\\n`;\n            code += '        logging.info(f\"🏁 Обработка кнопки Готово для множественного выбора: {callback_data}\")\\n';\n            code += '        \\n';\n            \n            // Сохраняем выбранные значения в базу данных\n            const multiSelectVariable = targetNode.data.multiSelectVariable || 'user_interests';\n            code += '        # Сохраняем выбранные значения в базу данных\\n';\n            code += `        selected_options = user_data.get(user_id, {}).get(\"multi_select_${actualCallbackData}\", [])\\n`;\n            code += '        if selected_options:\\n';\n            code += '            selected_text = \", \".join(selected_options)\\n';\n            code += `            \\n`;\n            code += `            # Универсальная логика аккумуляции для всех множественных выборов\\n`;\n            code += `            # Загружаем существующие значения\\n`;\n            code += `            existing_data = await get_user_data_from_db(user_id, \"${multiSelectVariable}\")\\n`;\n            code += `            existing_selections = []\\n`;\n            code += `            if existing_data and existing_data.strip():\\n`;\n            code += `                existing_selections = [s.strip() for s in existing_data.split(\",\") if s.strip()]\\n`;\n            code += `            \\n`;\n            code += `            # Объединяем существующие и новые выборы (убираем дубли)\\n`;\n            code += `            all_selections = list(set(existing_selections + selected_options))\\n`;\n            code += `            final_text = \", \".join(all_selections)\\n`;\n            code += `            await update_user_data_in_db(user_id, \"${multiSelectVariable}\", final_text)\\n`;\n            code += `            logging.info(f\"✅ Аккумулировано в переменную ${multiSelectVariable}: {final_text}\")\\n`;\n            code += '        \\n';\n            \n            // Очищаем состояние множественного выбора\n            code += '        # Очищаем состояние множественного выбора\\n';\n            code += '        if user_id in user_data:\\n';\n            code += `            user_data[user_id].pop(\"multi_select_${actualCallbackData}\", None)\\n`;\n            code += '            user_data[user_id].pop(\"multi_select_node\", None)\\n';\n            code += '            user_data[user_id].pop(\"multi_select_type\", None)\\n';\n            code += '            user_data[user_id].pop(\"multi_select_variable\", None)\\n';\n            code += '        \\n';\n            \n            // Переход к следующему узлу\n            if (targetNode.data.continueButtonTarget) {\n              const nextNodeId = targetNode.data.continueButtonTarget;\n              \n              // КРИТИЧЕСКАЯ ОТЛАДКА\n              console.log(`🚨 ГЕНЕРАТОР CONTINUEBUTTON DEBUG:`);\n              console.log(`🚨 ГЕНЕРАТОР: targetNode.id = \"${targetNode.id}\"`);\n              console.log(`🚨 ГЕНЕРАТОР: targetNode.data.continueButtonTarget = \"${targetNode.data.continueButtonTarget}\"`);\n              console.log(`🚨 ГЕНЕРАТОР: nextNodeId = \"${nextNodeId}\"`);\n              console.log(`🚨 ГЕНЕРАТОР: actualCallbackData = \"${actualCallbackData}\"`);\n              \n              code += '        # Переход к следующему узлу\\n';\n              code += `        next_node_id = \"${nextNodeId}\"\\n`;\n              code += `        logging.info(f\"🚀 DEBUG: targetNode.id=${targetNode.id}, continueButtonTarget=${targetNode.data.continueButtonTarget}, nextNodeId=${nextNodeId}\")\\n`;\n              \n              // ИСПРАВЛЕНИЕ: Специальная логика для metro_selection -> interests_result\n              console.log(`🔧 ГЕНЕРАТОР: Проверяем metro_selection -> interests_result: targetNode.id=\"${targetNode.id}\", nextNodeId=\"${nextNodeId}\"`);\n              if (targetNode.id.includes('metro_selection') && nextNodeId === 'interests_result') {\n                console.log(`🔧 ГЕНЕРАТОР: ✅ Применяем специальную логику metro_selection -> interests_result`);\n                code += '        # ИСПРАВЛЕНИЕ: Сохраняем метро выбор и устанавливаем флаг для показа клавиатуры\\n';\n                code += `        selected_metro = user_data.get(user_id, {}).get(\"multi_select_${actualCallbackData}\", [])\\n`;\n                code += '        if user_id not in user_data:\\n';\n                code += '            user_data[user_id] = {}\\n';\n                code += '        user_data[user_id][\"saved_metro_selection\"] = selected_metro\\n';\n                code += '        user_data[user_id][\"show_metro_keyboard\"] = True\\n';\n                code += '        logging.info(f\"🔧 ГЕНЕРАТОР DEBUG: targetNode.id={targetNode.id}, nextNodeId={nextNodeId}\")\\n';\n                code += '        logging.info(f\"🚇 Сохранили метро выбор: {selected_metro}, установлен флаг show_metro_keyboard=True\")\\n';\n                code += '        \\n';\n              } else {\n                console.log(`🔧 ГЕНЕРАТОР: ❌ Не применяем специальную логику: targetNode.id=\"${targetNode.id}\", nextNodeId=\"${nextNodeId}\"`);\n              }\n              \n              code += '        try:\\n';\n              code += `            await handle_callback_${nextNodeId.replace(/[^a-zA-Z0-9_]/g, '_')}(callback_query)\\n`;\n              code += '        except Exception as e:\\n';\n              code += '            logging.error(f\"Ошибка при переходе к следующему узлу {next_node_id}: {e}\")\\n';\n              code += `            await callback_query.message.edit_text(\"Переход завершен\")\\n`;\n            } else {\n              code += '        # Завершение множественного выбора\\n';\n              code += `        await safe_edit_or_send(callback_query, \"✅ Выбор завершен!\")\\n`;\n            }\n            code += '        return\\n';\n            code += '    \\n';\n          }\n          \n          // Специальная обработка для кнопок \"Изменить выбор\" и \"Начать заново\"\n          // Эти кнопки должны обрабатываться как обычные goto кнопки к start узлу\n          \n          // Правильная логика сохранения переменной на основе кнопки\n          code += `    button_text = \"${button.text}\"\\n`;\n          code += '    \\n';\n          \n          // Определяем переменную для сохранения на основе родительского узла\n          const parentNode = node; // Используем текущий узел как родительский\n          \n          // Проверяем настройку skipDataCollection для кнопки\n          const shouldSkipDataCollection = button.skipDataCollection === true;\n          \n          if (!shouldSkipDataCollection) {\n            if (parentNode && parentNode.data.inputVariable) {\n              const variableName = parentNode.data.inputVariable;\n              \n              // Используем текст кнопки как значение переменной\n              const variableValue = 'button_text';\n              \n              code += '    # Сохраняем правильную переменную в базу данных\\n';\n              code += `    await update_user_data_in_db(user_id, \"${variableName}\", ${variableValue})\\n`;\n              code += `    logging.info(f\"Переменная ${variableName} сохранена: \" + str(${variableValue}) + f\" (пользователь {user_id})\")\\n`;\n              code += '    \\n';\n              \n              // КРИТИЧЕСКИ ВАЖНО: Очищаем состояние ожидания после сохранения переменной\n              code += '    # Очищаем состояние ожидания ввода для этой переменной\\n';\n              code += '    if user_id in user_data:\\n';\n              code += '        # Удаляем waiting_for_input чтобы текстовый обработчик не перезаписал данные\\n';\n              code += '        if \"waiting_for_input\" in user_data[user_id]:\\n';\n              code += `            if user_data[user_id][\"waiting_for_input\"] == \"${parentNode.id}\":\\n`;\n              code += '                del user_data[user_id][\"waiting_for_input\"]\\n';\n              code += `                logging.info(f\"Состояние ожидания ввода очищено для переменной ${variableName} (пользователь {user_id})\")\\n`;\n              code += '    \\n';\n            } else {\n              // Fallback: сохраняем кнопку как есть\n              code += '    # Сохраняем кнопку в базу данных\\n';\n              code += '    timestamp = get_moscow_time()\\n';\n              code += '    response_data = button_text  # Простое значение\\n';\n              code += '    await update_user_data_in_db(user_id, button_text, response_data)\\n';\n              code += '    logging.info(f\"Кнопка сохранена: {button_text} (пользователь {user_id})\")\\n';\n            }\n          } else {\n            code += '    # Кнопка настроена для пропуска сбора данных (skipDataCollection=true)\\n';\n            code += `    logging.info(f\"Кнопка пропущена: {button_text} (не сохраняется из-за skipDataCollection)\")\\n`;\n          }\n          code += '    \\n';\n          \n          if (targetNode) {\n            \n            // Handle message nodes with variable saving action\n            if (targetNode.type === 'message' && targetNode.data.action === 'save_variable') {\n              const action = targetNode.data.action || 'none';\n              const variableName = targetNode.data.variableName || '';\n              const variableValue = targetNode.data.variableValue || '';\n              const successMessage = targetNode.data.successMessage || 'Успешно сохранено!';\n              \n              if (action === 'save_variable' && variableName && variableValue) {\n                code += `    # Сохраняем переменную \"${variableName}\" = \"${variableValue}\"\\n`;\n                code += `    user_data[user_id][\"${variableName}\"] = \"${variableValue}\"\\n`;\n                code += `    await update_user_variable_in_db(user_id, \"${variableName}\", \"${variableValue}\")\\n`;\n                code += `    logging.info(f\"Переменная сохранена: ${variableName} = ${variableValue} (пользователь {user_id})\")\\n`;\n                code += '    \\n';\n                \n                if (successMessage.includes('\\n')) {\n                  code += `    success_text = \"\"\"${successMessage}\"\"\"\\n`;\n                } else {\n                  const escapedMessage = successMessage.replace(/\"/g, '\\\\\"');\n                  code += `    success_text = \"${escapedMessage}\"\\n`;\n                }\n                \n                // Добавляем замену переменных в сообщении об успехе\n                code += `    # Подставляем значения переменных в текст сообщения\\n`;\n                code += `    if \"{${variableName}}\" in success_text:\\n`;\n                code += `        success_text = success_text.replace(\"{${variableName}}\", \"${variableValue}\")\\n`;\n                \n                code += '    await callback_query.message.edit_text(success_text)\\n';\n              }\n            }\n            // Handle regular message nodes (like source_friends, source_search, etc.)\n            else if (targetNode.type === 'message') {\n              const messageText = targetNode.data.messageText || \"Сообщение\";\n              const cleanedMessageText = stripHtmlTags(messageText);\n              const formattedText = formatTextForPython(cleanedMessageText);\n              const parseMode = getParseMode(targetNode.data.formatMode);\n              \n              code += `    # Отправляем сообщение для узла ${targetNode.id}\\n`;\n              code += `    text = ${formattedText}\\n`;\n              \n              // Применяем универсальную замену переменных\n              code += '    \\n';\n              code += generateUniversalVariableReplacement('    ');\n              \n              // Добавляем поддержку условных сообщений\n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '    \\n';\n                code += '    # Проверка условных сообщений\\n';\n                code += '    user_record = await get_user_from_db(user_id)\\n';\n                code += '    if not user_record:\\n';\n                code += '        user_record = user_data.get(user_id, {})\\n';\n                code += '    user_data_dict = user_record if user_record else user_data.get(user_id, {})\\n';\n                code += generateConditionalMessageLogic(targetNode.data.conditionalMessages, '    ');\n                code += '    \\n';\n                \n                // Use conditional message if available, otherwise use default\n                code += '    # Используем условное сообщение если есть подходящее условие\\n';\n                code += '    if \"text\" not in locals():\\n';\n                code += `        text = ${formattedText}\\n`;\n                code += '    \\n';\n                code += '    # Используем условную клавиатуру если есть\\n';\n                code += '    if conditional_keyboard is not None:\\n';\n                code += '        keyboard = conditional_keyboard\\n';\n                code += '    else:\\n';\n                code += '        keyboard = None\\n';\n              } else {\n                code += '    \\n';\n                code += '    # Без условных сообщений - используем обычную клавиатуру\\n';\n                code += '    keyboard = None\\n';\n              }\n              \n              // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверяем множественный выбор ИЛИ обычные inline кнопки\n              const hasMultipleSelection = targetNode.data.allowMultipleSelection && targetNode.data.buttons && targetNode.data.buttons.length > 0;\n              const hasRegularInlineButtons = targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons && targetNode.data.buttons.length > 0;\n              \n              console.log(`🔧 ГЕНЕРАТОР: Узел ${targetNode.id} - allowMultipleSelection: ${targetNode.data.allowMultipleSelection}, кнопок: ${targetNode.data.buttons?.length}, keyboardType: ${targetNode.data.keyboardType}`);\n              \n              if (hasMultipleSelection || hasRegularInlineButtons) {\n                console.log(`🔧 ГЕНЕРАТОР: ✅ СОЗДАЕМ клавиатуру для узла ${targetNode.id} (множественный выбор: ${hasMultipleSelection})`);\n                code += '    # Проверяем, есть ли условная клавиатура\\n';\n                code += '    if keyboard is None:\\n';\n                code += '        # ИСПРАВЛЕНИЕ: Используем универсальную функцию создания клавиатуры\\n';\n                // ИСПРАВЛЕНИЕ: Используем универсальную функцию generateInlineKeyboardCode\n                const keyboardCode = generateInlineKeyboardCode(targetNode.data.buttons, '        ', targetNode.id, targetNode.data, allNodeIds);\n                code += keyboardCode;\n              } else if (targetNode.data.keyboardType !== \"inline\") {\n                // Сохраняем keyboard = None только если это не inline клавиатура\n                code += '    if keyboard is None:\\n';\n                code += '        keyboard = None\\n';\n              }\n              \n              // Добавляем настройку ожидания текстового ввода для условных сообщений\n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '    # Настраиваем ожидание текстового ввода для условных сообщений\\n';\n                code += '    if \"conditional_message_config\" in locals():\\n';\n                code += '        # Проверяем, включено ли ожидание текстового ввода\\n';\n                code += '        wait_for_input = conditional_message_config.get(\"wait_for_input\", False)\\n';\n                code += '        if wait_for_input:\\n';\n                code += '            # Получаем следующий узел из условного сообщения или подключений\\n';\n                code += '            conditional_next_node = conditional_message_config.get(\"next_node_id\")\\n';\n                code += '            if conditional_next_node:\\n';\n                code += '                next_node_id = conditional_next_node\\n';\n                code += '            else:\\n';\n                const currentNodeConnections = connections.filter(conn => conn.source === targetNode.id);\n                if (currentNodeConnections.length > 0) {\n                  const nextNodeId = currentNodeConnections[0].target;\n                  code += `                next_node_id = \"${nextNodeId}\"\\n`;\n                } else {\n                  code += '                next_node_id = None\\n';\n                }\n                code += '            \\n';\n                code += '            # Получаем переменную для сохранения ввода\\n';\n                code += '            input_variable = conditional_message_config.get(\"input_variable\")\\n';\n                code += '            if not input_variable:\\n';\n                code += '                input_variable = f\"conditional_response_{conditional_message_config.get(\\'condition_id\\', \\'unknown\\')}\"\\n';\n                code += '            \\n';\n                code += '            # Устанавливаем состояние ожидания текстового ввода\\n';\n                code += '            if user_id not in user_data:\\n';\n                code += '                user_data[user_id] = {}\\n';\n                code += '            user_data[user_id][\"waiting_for_conditional_input\"] = {\\n';\n                code += '                \"node_id\": callback_query.data,\\n';\n                code += '                \"condition_id\": conditional_message_config.get(\"condition_id\"),\\n';\n                code += '                \"next_node_id\": next_node_id,\\n';\n                code += '                \"input_variable\": input_variable,\\n';\n                code += '                \"source_type\": \"conditional_message\"\\n';\n                code += '            }\\n';\n                code += '            logging.info(f\"Установлено ожидание ввода для условного сообщения: {conditional_message_config}\")\\n';\n                code += '    \\n';\n              }\n              \n              // Отправляем сообщение с учетом всех условий\n              // Проверяем наличие прикрепленных медиа\n              const attachedMedia = targetNode.data.attachedMedia || [];\n              \n              if (attachedMedia.length > 0) {\n                console.log(`🔧 ГЕНЕРАТОР: Узел ${targetNode.id} имеет attachedMedia:`, attachedMedia);\n                // Генерируем код отправки с медиа\n                const parseModeStr = targetNode.data.formatMode || '';\n                const keyboardStr = 'keyboard if keyboard is not None else None';\n                const mediaCode = generateAttachedMediaSendCode(\n                  attachedMedia,\n                  mediaVariablesMap,\n                  'text',\n                  parseModeStr,\n                  keyboardStr,\n                  targetNode.id,\n                  '    '\n                );\n                \n                if (mediaCode) {\n                  code += '    # Отправляем сообщение (с проверкой прикрепленного медиа)\\n';\n                  code += mediaCode;\n                } else {\n                  // Fallback если не удалось сгенерировать код медиа\n                  code += '    # Отправляем сообщение (обычное)\\n';\n                  code += `    await safe_edit_or_send(callback_query, text, node_id=\"${targetNode.id}\", reply_markup=keyboard if keyboard is not None else None${parseMode})\\n`;\n                }\n              } else {\n                // Обычное сообщение без медиа\n                code += '    # Отправляем сообщение\\n';\n                code += `    await safe_edit_or_send(callback_query, text, node_id=\"${targetNode.id}\", reply_markup=keyboard if keyboard is not None else None${parseMode})\\n`;\n              }\n              \n              // АВТОПЕРЕХОД: Если у узла есть autoTransitionTo, сразу переходим к следующему узлу\n              if (targetNode.data.autoTransitionTo) {\n                const autoTargetId = targetNode.data.autoTransitionTo;\n                const safeAutoTargetId = autoTargetId.replace(/-/g, '_');\n                code += '    \\n';\n                code += `    # ⚡ Автопереход к узлу ${autoTargetId}\\n`;\n                code += `    logging.info(f\"⚡ Автопереход от узла ${targetNode.id} к узлу ${autoTargetId}\")\\n`;\n                code += `    await handle_node_${safeAutoTargetId}(callback_query)\\n`;\n                code += `    return\\n`;\n              }\n              \n              // КРИТИЧЕСКИ ВАЖНАЯ ЛОГИКА: Если этот узел имеет collectUserInput, настраиваем состояние ожидания\n              if (targetNode.data.collectUserInput === true) {\n                const inputType = targetNode.data.inputType || 'text';\n                const inputVariable = targetNode.data.inputVariable || `response_${targetNode.id}`;\n                const inputTargetNodeId = targetNode.data.inputTargetNodeId;\n                \n                // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Если у узла есть inline кнопки И НЕТ текстового/медиа ввода, НЕ настраиваем ожидание ввода\n                // Для reply кнопок ВСЕГДА настраиваем ожидание ввода если enableTextInput === true\n                const hasInputEnabled = targetNode.data.enableTextInput || targetNode.data.enablePhotoInput || \n                                         targetNode.data.enableVideoInput || targetNode.data.enableAudioInput || \n                                         targetNode.data.enableDocumentInput;\n                \n                if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons && targetNode.data.buttons.length > 0 && !hasInputEnabled) {\n                  code += '    \\n';\n                  code += `    logging.info(f\"✅ Узел ${targetNode.id} имеет inline кнопки БЕЗ текстового/медиа ввода - НЕ настраиваем ожидание ввода\")\\n`;\n                  code += `    # ИСПРАВЛЕНИЕ: У узла есть inline кнопки без текстового/медиа ввода\\n`;\n                } else {\n                  code += '    \\n';\n                  code += '    # КРИТИЧЕСКИ ВАЖНО: Настраиваем ожидание ввода для message узла с collectUserInput\\n';\n                  code += '    # Используем универсальную функцию для определения правильного типа ввода (text/photo/video/audio/document)\\n';\n                  // ИСПРАВЛЕНИЕ: Используем generateWaitingStateCode вместо встроенной генерации\n                  code += generateWaitingStateCode(targetNode, '    ');\n                }\n              }\n            }\n            // Handle different target node types\n            else if (targetNode.type === 'photo') {\n              const caption = targetNode.data.mediaCaption || targetNode.data.messageText || \"📸 Фото\";\n              const imageUrl = targetNode.data.imageUrl || \"https://picsum.photos/800/600?random=1\";\n              \n              code += `    # Отправляем фото для узла ${targetNode.id}\\n`;\n              \n              if (caption.includes('\\n')) {\n                code += `    caption = \"\"\"${caption}\"\"\"\\n`;\n              } else {\n                const escapedCaption = caption.replace(/\"/g, '\\\\\"');\n                code += `    caption = \"${escapedCaption}\"\\n`;\n              }\n              \n              // Применяем универсальную замену переменных для подписи\n              code += '    \\n';\n              code += generateUniversalVariableReplacement('    ');\n              code += '    caption = replace_variables_in_text(caption, user_vars)\\n';\n              \n              // Добавляем поддержку условных сообщений для фото\n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '    \\n';\n                code += '    # Проверка условных сообщений для фото\\n';\n                code += '    user_record = await get_user_from_db(user_id)\\n';\n                code += '    if not user_record:\\n';\n                code += '        user_record = user_data.get(user_id, {})\\n';\n                code += '    user_data_dict = user_record if user_record else user_data.get(user_id, {})\\n';\n                code += generateConditionalMessageLogic(targetNode.data.conditionalMessages, '    ');\n                code += '    \\n';\n                \n                // Use conditional message if available, otherwise use default caption\n                code += '    # Используем условное сообщение как подпись если есть подходящее условие\\n';\n                code += '    if \"text\" in locals():\\n';\n                code += '        caption = text\\n';\n                code += '    \\n';\n                code += '    # Используем условную клавиатуру если есть\\n';\n                code += '    conditional_keyboard_for_photo = conditional_keyboard\\n';\n              }\n              \n              code += `    photo_url = \"${imageUrl}\"\\n`;\n              code += '    photo_url = replace_variables_in_text(photo_url, user_vars)\\n';\n              code += '    try:\\n';\n              code += '        # Проверяем, является ли это локальным файлом\\n';\n              code += '        if is_local_file(photo_url):\\n';\n              code += '            # Отправляем локальный файл\\n';\n              code += '            file_path = get_local_file_path(photo_url)\\n';\n              code += '            if os.path.exists(file_path):\\n';\n              code += '                photo_file = FSInputFile(file_path)\\n';\n              code += '            else:\\n';\n              code += '                raise FileNotFoundError(f\"Локальный файл не найден: {file_path}\")\\n';\n              code += '        else:\\n';\n              code += '            # Используем URL для внешних файлов\\n';\n              code += '            photo_file = photo_url\\n';\n              code += '        \\n';\n              \n              // Проверяем условную клавиатуру или обычную\n              code += '        # Определяем клавиатуру для фото\\n';\n              code += '        keyboard = None\\n';\n              \n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '        if conditional_keyboard_for_photo is not None:\\n';\n                code += '            keyboard = conditional_keyboard_for_photo\\n';\n                code += '        elif '\n              } else {\n                code += '        if ';\n              }\n              \n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                code += 'True:  # У узла есть обычные кнопки\\n';\n                code += '            builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `            builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `            builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command') {\n                    // Для кнопок команд создаем специальную callback_data\n                    const commandCallback = `cmd_${btn.target ? btn.target.replace('/', '') : 'unknown'}`;\n                    code += `            builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                  }\n                });\n                code += '            builder.adjust(2)  # Используем 2 колонки для консистентности\\n';\n                code += '            keyboard = builder.as_markup()\\n';\n              } else {\n                code += 'False:  # Нет кнопок\\n';\n                code += '            pass\\n';\n              }\n              \n              code += '        \\n';\n              code += '        await callback_query.message.delete()\\n';\n              code += '        if keyboard is not None:\\n';\n              code += '            await bot.send_photo(callback_query.from_user.id, photo_file, caption=caption, reply_markup=keyboard)\\n';\n              code += '        else:\\n';\n              code += '            await bot.send_photo(callback_query.from_user.id, photo_file, caption=caption)\\n';\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки фото: {e}\")\\n';\n              code += '        await safe_edit_or_send(callback_query, f\"❌ Не удалось загрузить фото\\\\n{caption}\")\\n';\n              \n              // АВТОПЕРЕХОД: Если у узла есть autoTransitionTo, сразу переходим к следующему узлу\n              if (targetNode.data.autoTransitionTo) {\n                const autoTargetId = targetNode.data.autoTransitionTo;\n                const safeAutoTargetId = autoTargetId.replace(/-/g, '_');\n                code += '    \\n';\n                code += `    # ⚡ Автопереход к узлу ${autoTargetId}\\n`;\n                code += `    logging.info(f\"⚡ Автопереход от узла ${targetNode.id} к узлу ${autoTargetId}\")\\n`;\n                code += `    await handle_node_${safeAutoTargetId}(callback_query)\\n`;\n                code += `    return\\n`;\n              }\n              \n            } else if (targetNode.type === 'video') {\n              const caption = targetNode.data.mediaCaption || targetNode.data.messageText || \"🎥 Видео\";\n              const videoUrl = targetNode.data.videoUrl || \"https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4\";\n              \n              code += `    # Отправляем видео для узла ${targetNode.id}\\n`;\n              \n              if (caption.includes('\\n')) {\n                code += `    caption = \"\"\"${caption}\"\"\"\\n`;\n              } else {\n                const escapedCaption = caption.replace(/\"/g, '\\\\\"');\n                code += `    caption = \"${escapedCaption}\"\\n`;\n              }\n              \n              // Применяем универсальную замену переменных для подписи\n              code += '    \\n';\n              code += generateUniversalVariableReplacement('    ');\n              code += '    caption = replace_variables_in_text(caption, user_vars)\\n';\n              \n              // Добавляем поддержку условных сообщений для видео\n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '    \\n';\n                code += '    # Проверка условных сообщений для видео\\n';\n                code += '    user_record = await get_user_from_db(user_id)\\n';\n                code += '    if not user_record:\\n';\n                code += '        user_record = user_data.get(user_id, {})\\n';\n                code += '    user_data_dict = user_record if user_record else user_data.get(user_id, {})\\n';\n                code += generateConditionalMessageLogic(targetNode.data.conditionalMessages, '    ');\n                code += '    \\n';\n                \n                // Use conditional message if available, otherwise use default caption\n                code += '    # Используем условное сообщение как подпись если есть подходящее условие\\n';\n                code += '    if \"text\" in locals():\\n';\n                code += '        caption = text\\n';\n                code += '    \\n';\n                code += '    # Используем условную клавиатуру если есть\\n';\n                code += '    conditional_keyboard_for_video = conditional_keyboard\\n';\n              }\n              \n              code += `    video_url = \"${videoUrl}\"\\n`;\n              code += '    video_url = replace_variables_in_text(video_url, user_vars)\\n';\n              code += '    try:\\n';\n              code += '        # Проверяем, является ли это локальным файлом\\n';\n              code += '        if is_local_file(video_url):\\n';\n              code += '            # Отправляем локальный файл\\n';\n              code += '            file_path = get_local_file_path(video_url)\\n';\n              code += '            if os.path.exists(file_path):\\n';\n              code += '                video_file = FSInputFile(file_path)\\n';\n              code += '            else:\\n';\n              code += '                raise FileNotFoundError(f\"Локальный файл не найден: {file_path}\")\\n';\n              code += '        else:\\n';\n              code += '            # Используем URL для внешних файлов\\n';\n              code += '            video_file = video_url\\n';\n              code += '        \\n';\n              \n              // Проверяем условную клавиатуру или обычную\n              code += '        # Определяем клавиатуру для видео\\n';\n              code += '        keyboard = None\\n';\n              \n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '        if conditional_keyboard_for_video is not None:\\n';\n                code += '            keyboard = conditional_keyboard_for_video\\n';\n                code += '        elif '\n              } else {\n                code += '        if ';\n              }\n              \n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                code += 'True:  # У узла есть обычные кнопки\\n';\n                code += '            builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `            builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `            builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command') {\n                    // Для кнопок команд создаем специальную callback_data\n                    const commandCallback = `cmd_${btn.target ? btn.target.replace('/', '') : 'unknown'}`;\n                    code += `            builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                  }\n                });\n                code += '            builder.adjust(2)  # Используем 2 колонки для консистентности\\n';\n                code += '            keyboard = builder.as_markup()\\n';\n              } else {\n                code += 'False:  # Нет кнопок\\n';\n                code += '            pass\\n';\n              }\n              \n              code += '        \\n';\n              code += '        await callback_query.message.delete()\\n';\n              code += '        if keyboard is not None:\\n';\n              code += '            await bot.send_video(callback_query.from_user.id, video_file, caption=caption, reply_markup=keyboard)\\n';\n              code += '        else:\\n';\n              code += '            await bot.send_video(callback_query.from_user.id, video_file, caption=caption)\\n';\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки видео: {e}\")\\n';\n              code += '        await safe_edit_or_send(callback_query, f\"❌ Не удалось загрузить видео\\\\n{caption}\")\\n';\n              \n              // АВТОПЕРЕХОД: Если у узла есть autoTransitionTo, сразу переходим к следующему узлу\n              if (targetNode.data.autoTransitionTo) {\n                const autoTargetId = targetNode.data.autoTransitionTo;\n                const safeAutoTargetId = autoTargetId.replace(/-/g, '_');\n                code += '    \\n';\n                code += `    # ⚡ Автопереход к узлу ${autoTargetId}\\n`;\n                code += `    logging.info(f\"⚡ Автопереход от узла ${targetNode.id} к узлу ${autoTargetId}\")\\n`;\n                code += `    await handle_node_${safeAutoTargetId}(callback_query)\\n`;\n                code += `    return\\n`;\n              }\n              \n            } else if (targetNode.type === 'audio') {\n              const caption = targetNode.data.mediaCaption || targetNode.data.messageText || \"🎵 Аудио\";\n              const audioUrl = targetNode.data.audioUrl || \"https://www.soundjay.com/misc/beep-07a.wav\";\n              \n              code += `    # Отправляем аудио для узла ${targetNode.id}\\n`;\n              \n              if (caption.includes('\\n')) {\n                code += `    caption = \"\"\"${caption}\"\"\"\\n`;\n              } else {\n                const escapedCaption = caption.replace(/\"/g, '\\\\\"');\n                code += `    caption = \"${escapedCaption}\"\\n`;\n              }\n              \n              // Применяем универсальную замену переменных для подписи\n              code += '    \\n';\n              code += generateUniversalVariableReplacement('    ');\n              code += '    caption = replace_variables_in_text(caption, user_vars)\\n';\n              \n              // Добавляем поддержку условных сообщений для аудио\n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '    \\n';\n                code += '    # Проверка условных сообщений для аудио\\n';\n                code += '    user_record = await get_user_from_db(user_id)\\n';\n                code += '    if not user_record:\\n';\n                code += '        user_record = user_data.get(user_id, {})\\n';\n                code += '    user_data_dict = user_record if user_record else user_data.get(user_id, {})\\n';\n                code += generateConditionalMessageLogic(targetNode.data.conditionalMessages, '    ');\n                code += '    \\n';\n                \n                // Use conditional message if available, otherwise use default caption\n                code += '    # Используем условное сообщение как подпись если есть подходящее условие\\n';\n                code += '    if \"text\" in locals():\\n';\n                code += '        caption = text\\n';\n                code += '    \\n';\n                code += '    # Используем условную клавиатуру если есть\\n';\n                code += '    conditional_keyboard_for_audio = conditional_keyboard\\n';\n              }\n              \n              code += `    audio_url = \"${audioUrl}\"\\n`;\n              code += '    audio_url = replace_variables_in_text(audio_url, user_vars)\\n';\n              code += '    try:\\n';\n              code += '        # Проверяем, является ли это локальным файлом\\n';\n              code += '        if is_local_file(audio_url):\\n';\n              code += '            # Отправляем локальный файл\\n';\n              code += '            file_path = get_local_file_path(audio_url)\\n';\n              code += '            if os.path.exists(file_path):\\n';\n              code += '                audio_file = FSInputFile(file_path)\\n';\n              code += '            else:\\n';\n              code += '                raise FileNotFoundError(f\"Локальный файл не найден: {file_path}\")\\n';\n              code += '        else:\\n';\n              code += '            # Используем URL для внешних файлов\\n';\n              code += '            audio_file = audio_url\\n';\n              code += '        \\n';\n              \n              // Проверяем условную клавиатуру или обычную\n              code += '        # Определяем клавиатуру для аудио\\n';\n              code += '        keyboard = None\\n';\n              \n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '        if conditional_keyboard_for_audio is not None:\\n';\n                code += '            keyboard = conditional_keyboard_for_audio\\n';\n                code += '        elif '\n              } else {\n                code += '        if ';\n              }\n              \n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                code += 'True:  # У узла есть обычные кнопки\\n';\n                code += '            builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `            builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `            builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command' && btn.target) {\n                    // ИСПРАВЛЕНИЕ: Добавляем поддержку кнопок команд для audio nodes\n                    const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                    code += `            # Кнопка команды: ${btn.text} -> ${btn.target}\\n`;\n                    code += `            builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                  }\n                });\n                code += '            keyboard = builder.as_markup()\\n';\n              } else {\n                code += 'False:  # Нет кнопок\\n';\n                code += '            pass\\n';\n              }\n              \n              code += '        \\n';\n              code += '        await callback_query.message.delete()\\n';\n              code += '        if keyboard is not None:\\n';\n              code += '            await bot.send_audio(callback_query.from_user.id, audio_file, caption=caption, reply_markup=keyboard)\\n';\n              code += '        else:\\n';\n              code += '            await bot.send_audio(callback_query.from_user.id, audio_file, caption=caption)\\n';\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки аудио: {e}\")\\n';\n              code += '        await safe_edit_or_send(callback_query, f\"❌ Не удалось загрузить аудио\\\\n{caption}\")\\n';\n              \n              // АВТОПЕРЕХОД: Если у узла есть autoTransitionTo, сразу переходим к следующему узлу\n              if (targetNode.data.autoTransitionTo) {\n                const autoTargetId = targetNode.data.autoTransitionTo;\n                const safeAutoTargetId = autoTargetId.replace(/-/g, '_');\n                code += '    \\n';\n                code += `    # ⚡ Автопереход к узлу ${autoTargetId}\\n`;\n                code += `    logging.info(f\"⚡ Автопереход от узла ${targetNode.id} к узлу ${autoTargetId}\")\\n`;\n                code += `    await handle_node_${safeAutoTargetId}(callback_query)\\n`;\n                code += `    return\\n`;\n              }\n              \n            } else if (targetNode.type === 'document') {\n              const caption = targetNode.data.mediaCaption || targetNode.data.messageText || \"📄 Документ\";\n              const documentUrl = targetNode.data.documentUrl || \"https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf\";\n              \n              if (caption.includes('\\n')) {\n                code += `    caption = \"\"\"${caption}\"\"\"\\n`;\n              } else {\n                const escapedCaption = caption.replace(/\"/g, '\\\\\"');\n                code += `    caption = \"${escapedCaption}\"\\n`;\n              }\n              \n              code += `    document_url = \"${documentUrl}\"\\n`;\n              code += '    document_url = replace_variables_in_text(document_url, user_vars)\\n';\n              const documentName = targetNode.data.documentName || \"document.pdf\";\n              code += `    document_name = \"${documentName}\"\\n`;\n              code += '    try:\\n';\n              code += '        # Проверяем, является ли это локальным файлом\\n';\n              code += '        if is_local_file(document_url):\\n';\n              code += '            # Отправляем локальный файл\\n';\n              code += '            file_path = get_local_file_path(document_url)\\n';\n              code += '            if os.path.exists(file_path):\\n';\n              code += '                document_file = FSInputFile(file_path, filename=document_name)\\n';\n              code += '            else:\\n';\n              code += '                raise FileNotFoundError(f\"Локальный файл не найден: {file_path}\")\\n';\n              code += '        else:\\n';\n              code += '            # Используем URL для внешних файлов\\n';\n              code += '            document_file = URLInputFile(document_url, filename=document_name)\\n';\n              code += '        \\n';\n              \n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                code += '        builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command' && btn.target) {\n                    // ИСПРАВЛЕНИЕ: Добавляем поддержку кнопок команд для document nodes\n                    const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                    code += `        # Кнопка команды: ${btn.text} -> ${btn.target}\\n`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                  }\n                });\n                code += '        keyboard = builder.as_markup()\\n';\n                code += '        await callback_query.message.delete()\\n';\n                code += '        await bot.send_document(callback_query.from_user.id, document_file, caption=caption, reply_markup=keyboard)\\n';\n              } else {\n                code += '        await callback_query.message.delete()\\n';\n                code += '        await bot.send_document(callback_query.from_user.id, document_file, caption=caption)\\n';\n              }\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки документа: {e}\")\\n';\n              code += '        await safe_edit_or_send(callback_query, f\"❌ Не удалось загрузить документ\\\\n{caption}\")\\n';\n              \n            } else if (targetNode.type === 'sticker') {\n              const stickerUrl = targetNode.data.stickerUrl || \"CAACAgIAAxkBAAICGGXm2KvQAAG2X8cxTmZHJkRnYwYlAAJGAANWnb0KmgiEKEZDKVQeBA\";\n              \n              code += `    sticker_url = \"${stickerUrl}\"\\n`;\n              code += '    try:\\n';\n              code += '        # Проверяем, является ли это локальным файлом\\n';\n              code += '        if is_local_file(sticker_url):\\n';\n              code += '            # Отправляем локальный файл\\n';\n              code += '            file_path = get_local_file_path(sticker_url)\\n';\n              code += '            if os.path.exists(file_path):\\n';\n              code += '                sticker_file = FSInputFile(file_path)\\n';\n              code += '            else:\\n';\n              code += '                raise FileNotFoundError(f\"Локальный файл не найден: {file_path}\")\\n';\n              code += '        else:\\n';\n              code += '            # Используем URL или file_id для стикеров\\n';\n              code += '            sticker_file = sticker_url\\n';\n              code += '        \\n';\n              \n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                code += '        builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command' && btn.target) {\n                    // ИСПРАВЛЕНИЕ: Добавляем поддержку кнопок команд для sticker nodes\n                    const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                    code += `        # Кнопка команды: ${btn.text} -> ${btn.target}\\n`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                  }\n                });\n                code += '        keyboard = builder.as_markup()\\n';\n                code += '        await callback_query.message.delete()\\n';\n                code += '        await bot.send_sticker(callback_query.from_user.id, sticker_file, reply_markup=keyboard)\\n';\n              } else {\n                code += '        await callback_query.message.delete()\\n';\n                code += '        await bot.send_sticker(callback_query.from_user.id, sticker_file)\\n';\n              }\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки стикера: {e}\")\\n';\n              code += '        await safe_edit_or_send(callback_query, f\"❌ Не удалось отправить стикер\")\\n';\n              \n            } else if (targetNode.type === 'voice') {\n              const voiceUrl = targetNode.data.voiceUrl || \"https://www.soundjay.com/misc/beep-07a.wav\";\n              const duration = targetNode.data.duration || 30;\n              \n              code += `    voice_url = \"${voiceUrl}\"\\n`;\n              code += `    duration = ${duration}\\n`;\n              code += '    try:\\n';\n              code += '        # Проверяем, является ли это локальным файлом\\n';\n              code += '        if is_local_file(voice_url):\\n';\n              code += '            # Отправляем локальный файл\\n';\n              code += '            file_path = get_local_file_path(voice_url)\\n';\n              code += '            if os.path.exists(file_path):\\n';\n              code += '                voice_file = FSInputFile(file_path)\\n';\n              code += '            else:\\n';\n              code += '                raise FileNotFoundError(f\"Локальный файл не найден: {file_path}\")\\n';\n              code += '        else:\\n';\n              code += '            # Используем URL для внешних файлов\\n';\n              code += '            voice_file = voice_url\\n';\n              code += '        \\n';\n              \n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                code += '        builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command' && btn.target) {\n                    // ИСПРАВЛЕНИЕ: Добавляем поддержку кнопок команд для voice nodes\n                    const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                    code += `        # Кнопка команды: ${btn.text} -> ${btn.target}\\n`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                  }\n                });\n                code += '        keyboard = builder.as_markup()\\n';\n                code += '        await callback_query.message.delete()\\n';\n                code += '        await bot.send_voice(callback_query.from_user.id, voice_file, duration=duration, reply_markup=keyboard)\\n';\n              } else {\n                code += '        await callback_query.message.delete()\\n';\n                code += '        await bot.send_voice(callback_query.from_user.id, voice_file, duration=duration)\\n';\n              }\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки голосового сообщения: {e}\")\\n';\n              code += '        await safe_edit_or_send(callback_query, f\"❌ Не удалось отправить голосовое сообщение\")\\n';\n              \n            } else if (targetNode.type === 'animation') {\n              const caption = targetNode.data.mediaCaption || \"🎬 Анимация\";\n              const animationUrl = targetNode.data.animationUrl || \"https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif\";\n              \n              if (caption.includes('\\n')) {\n                code += `    caption = \"\"\"${caption}\"\"\"\\n`;\n              } else {\n                const escapedCaption = caption.replace(/\"/g, '\\\\\"');\n                code += `    caption = \"${escapedCaption}\"\\n`;\n              }\n              \n              code += `    animation_url = \"${animationUrl}\"\\n`;\n              code += '    try:\\n';\n              code += '        # Проверяем, является ли это локальным файлом\\n';\n              code += '        if is_local_file(animation_url):\\n';\n              code += '            # Отправляем локальный файл\\n';\n              code += '            file_path = get_local_file_path(animation_url)\\n';\n              code += '            if os.path.exists(file_path):\\n';\n              code += '                animation_file = FSInputFile(file_path)\\n';\n              code += '            else:\\n';\n              code += '                raise FileNotFoundError(f\"Локальный файл не найден: {file_path}\")\\n';\n              code += '        else:\\n';\n              code += '            # Используем URL для внешних файлов\\n';\n              code += '            animation_file = animation_url\\n';\n              code += '        \\n';\n              \n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                code += '        builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command' && btn.target) {\n                    // ИСПРАВЛЕНИЕ: Добавляем поддержку кнопок команд для animation nodes\n                    const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                    code += `        # Кнопка команды: ${btn.text} -> ${btn.target}\\n`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                  }\n                });\n                code += '        keyboard = builder.as_markup()\\n';\n                code += '        await callback_query.message.delete()\\n';\n                code += '        await bot.send_animation(callback_query.from_user.id, animation_file, caption=caption, reply_markup=keyboard)\\n';\n              } else {\n                code += '        await callback_query.message.delete()\\n';\n                code += '        await bot.send_animation(callback_query.from_user.id, animation_file, caption=caption)\\n';\n              }\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки анимации: {e}\")\\n';\n              code += '        await safe_edit_or_send(callback_query, f\"❌ Не удалось отправить анимацию\\\\n{caption}\")\\n';\n              \n            } else if (targetNode.type === 'location') {\n              let latitude = targetNode.data.latitude || 55.7558;\n              let longitude = targetNode.data.longitude || 37.6176;\n              const title = targetNode.data.title || \"\";\n              const address = targetNode.data.address || \"\";\n              const city = targetNode.data.city || \"\";\n              const country = targetNode.data.country || \"\";\n              const mapService = targetNode.data.mapService || 'custom';\n              const generateMapPreview = targetNode.data.generateMapPreview !== false;\n              \n              code += '    # Определяем координаты на основе выбранного сервиса карт\\n';\n              \n              if (mapService === 'yandex' && targetNode.data.yandexMapUrl) {\n                code += `    yandex_url = \"${targetNode.data.yandexMapUrl}\"\\n`;\n                code += '    extracted_lat, extracted_lon = extract_coordinates_from_yandex(yandex_url)\\n';\n                code += '    if extracted_lat and extracted_lon:\\n';\n                code += '        latitude, longitude = extracted_lat, extracted_lon\\n';\n                code += '    else:\\n';\n                code += `        latitude, longitude = ${latitude}, ${longitude}  # Fallback координаты\\n`;\n              } else if (mapService === 'google' && targetNode.data.googleMapUrl) {\n                code += `    google_url = \"${targetNode.data.googleMapUrl}\"\\n`;\n                code += '    extracted_lat, extracted_lon = extract_coordinates_from_google(google_url)\\n';\n                code += '    if extracted_lat and extracted_lon:\\n';\n                code += '        latitude, longitude = extracted_lat, extracted_lon\\n';\n                code += '    else:\\n';\n                code += `        latitude, longitude = ${latitude}, ${longitude}  # Fallback координаты\\n`;\n              } else if (mapService === '2gis' && targetNode.data.gisMapUrl) {\n                code += `    gis_url = \"${targetNode.data.gisMapUrl}\"\\n`;\n                code += '    extracted_lat, extracted_lon = extract_coordinates_from_2gis(gis_url)\\n';\n                code += '    if extracted_lat and extracted_lon:\\n';\n                code += '        latitude, longitude = extracted_lat, extracted_lon\\n';\n                code += '    else:\\n';\n                code += `        latitude, longitude = ${latitude}, ${longitude}  # Fallback координаты\\n`;\n              } else {\n                code += `    latitude, longitude = ${latitude}, ${longitude}\\n`;\n              }\n              \n              if (title) code += `    title = \"${title}\"\\n`;\n              if (address) code += `    address = \"${address}\"\\n`;\n              \n              code += '    try:\\n';\n              code += '        # Удаляем старое сообщение\\n';\n              code += '        await callback_query.message.delete()\\n';\n              \n              code += '        # Отправляем геолокацию\\n';\n              if (title || address) {\n                code += '        await bot.send_venue(\\n';\n                code += '            callback_query.from_user.id,\\n';\n                code += '            latitude=latitude,\\n';\n                code += '            longitude=longitude,\\n';\n                code += '            title=title,\\n';\n                code += '            address=address\\n';\n                code += '        )\\n';\n              } else {\n                code += '        await bot.send_location(\\n';\n                code += '            callback_query.from_user.id,\\n';\n                code += '            latitude=latitude,\\n';\n                code += '            longitude=longitude\\n';\n                code += '        )\\n';\n              }\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки геолокации: {e}\")\\n';\n              code += '        await bot.send_message(callback_query.from_user.id, f\"❌ Не удалось отправить геолокацию\")\\n';\n              \n              // Генерируем кнопки для картографических сервисов если включено\n              if (generateMapPreview) {\n                code += '        \\n';\n                code += '        # Генерируем ссылки на картографические сервисы\\n';\n                code += '        map_urls = generate_map_urls(latitude, longitude, title)\\n';\n                code += '        \\n';\n                code += '        # Создаем кнопки для различных карт\\n';\n                code += '        map_builder = InlineKeyboardBuilder()\\n';\n                code += '        map_builder.add(InlineKeyboardButton(text=\"🗺️ Яндекс Карты\", url=map_urls[\"yandex\"]))\\n';\n                code += '        map_builder.add(InlineKeyboardButton(text=\"🌍 Google Maps\", url=map_urls[\"google\"]))\\n';\n                code += '        map_builder.add(InlineKeyboardButton(text=\"📍 2ГИС\", url=map_urls[\"2gis\"]))\\n';\n                code += '        map_builder.add(InlineKeyboardButton(text=\"🌐 OpenStreetMap\", url=map_urls[\"openstreetmap\"]))\\n';\n                \n                if (targetNode.data.showDirections) {\n                  code += '        # Добавляем кнопки для построения маршрута\\n';\n                  code += '        map_builder.add(InlineKeyboardButton(text=\"🧭 Маршрут (Яндекс)\", url=f\"https://yandex.ru/maps/?rtext=~{latitude},{longitude}\"))\\n';\n                  code += '        map_builder.add(InlineKeyboardButton(text=\"🚗 Маршрут (Google)\", url=f\"https://maps.google.com/maps/dir//{latitude},{longitude}\"))\\n';\n                }\n                \n                code += '        map_builder.adjust(2)  # Размещаем кнопки в 2 столбца\\n';\n                code += '        map_keyboard = map_builder.as_markup()\\n';\n                code += '        \\n';\n                code += '        await bot.send_message(\\n';\n                code += '            callback_query.from_user.id,\\n';\n                if (targetNode.data.showDirections) {\n                  code += '            \"🗺️ Откройте местоположение в удобном картографическом сервисе или постройте маршрут:\",\\n';\n                } else {\n                  code += '            \"🗺️ Откройте местоположение в удобном картографическом сервисе:\",\\n';\n                }\n                code += '            reply_markup=map_keyboard\\n';\n                code += '        )\\n';\n              }\n              \n              // Добавляем дополнительные кнопки если они есть\n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                code += '        \\n';\n                code += '        # Отправляем дополнительные кнопки\\n';\n                code += '        builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  }\n                });\n                code += '        keyboard = builder.as_markup()\\n';\n                code += '        await bot.send_message(callback_query.from_user.id, \"Выберите действие:\", reply_markup=keyboard)\\n';\n              }\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки местоположения: {e}\")\\n';\n              code += '        await bot.send_message(callback_query.from_user.id, f\"❌ Не удалось отправить местоположение\")\\n';\n              \n            } else if (targetNode.type === 'contact') {\n              const phoneNumber = targetNode.data.phoneNumber || \"+7 999 123 45 67\";\n              const firstName = targetNode.data.firstName || \"Контакт\";\n              const lastName = targetNode.data.lastName || \"\";\n              const userId = targetNode.data.userId || null;\n              const vcard = targetNode.data.vcard || \"\";\n              \n              code += `    phone_number = \"${phoneNumber}\"\\n`;\n              code += `    first_name = \"${firstName}\"\\n`;\n              if (lastName) code += `    last_name = \"${lastName}\"\\n`;\n              if (userId) code += `    user_id = ${userId}\\n`;\n              if (vcard) code += `    vcard = \"\"\"${vcard}\"\"\"\\n`;\n              \n              code += '    try:\\n';\n              \n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                code += '        builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  }\n                });\n                code += '        keyboard = builder.as_markup()\\n';\n                code += '        await callback_query.message.delete()\\n';\n                if (lastName && userId && vcard) {\n                  code += '        await bot.send_contact(callback_query.from_user.id, phone_number=phone_number, first_name=first_name, last_name=last_name, user_id=user_id, vcard=vcard, reply_markup=keyboard)\\n';\n                } else if (lastName) {\n                  code += '        await bot.send_contact(callback_query.from_user.id, phone_number=phone_number, first_name=first_name, last_name=last_name, reply_markup=keyboard)\\n';\n                } else {\n                  code += '        await bot.send_contact(callback_query.from_user.id, phone_number=phone_number, first_name=first_name, reply_markup=keyboard)\\n';\n                }\n              } else {\n                code += '        await callback_query.message.delete()\\n';\n                if (lastName && userId && vcard) {\n                  code += '        await bot.send_contact(callback_query.from_user.id, phone_number=phone_number, first_name=first_name, last_name=last_name, user_id=user_id, vcard=vcard)\\n';\n                } else if (lastName) {\n                  code += '        await bot.send_contact(callback_query.from_user.id, phone_number=phone_number, first_name=first_name, last_name=last_name)\\n';\n                } else {\n                  code += '        await bot.send_contact(callback_query.from_user.id, phone_number=phone_number, first_name=first_name)\\n';\n                }\n              }\n              \n              code += '    except Exception as e:\\n';\n              code += '        logging.error(f\"Ошибка отправки контакта: {e}\")\\n';\n              code += '        await safe_edit_or_send(callback_query, f\"❌ Не удалось отправить контакт\")\\n';\n              \n            } else if (targetNode.type === 'user-input') {\n              // Handle user-input nodes\n              const inputPrompt = targetNode.data.messageText || targetNode.data.inputPrompt || \"Пожалуйста, введите ваш ответ:\";\n              const responseType = targetNode.data.responseType || 'text';\n              const inputType = targetNode.data.inputType || 'text';\n              const inputVariable = targetNode.data.inputVariable || `response_${targetNode.id}`;\n              const responseOptions = targetNode.data.responseOptions || [];\n              const allowMultipleSelection = targetNode.data.allowMultipleSelection || false;\n              const inputValidation = targetNode.data.inputValidation || '';\n              const minLength = targetNode.data.minLength || 0;\n              const maxLength = targetNode.data.maxLength || 0;\n              const inputTimeout = targetNode.data.inputTimeout || 60;\n              const inputRequired = targetNode.data.inputRequired !== false;\n              const allowSkip = targetNode.data.allowSkip || false;\n              const saveToDatabase = targetNode.data.saveToDatabase || false;\n              const inputRetryMessage = targetNode.data.inputRetryMessage || \"Пожалуйста, попробуйте еще раз.\";\n              const inputSuccessMessage = targetNode.data.inputSuccessMessage || \"✅ Спасибо за ваш ответ!\";\n              const placeholder = targetNode.data.placeholder || \"\";\n              \n              code += '    # Удаляем старое сообщение\\n';\n              code += '    await callback_query.message.delete()\\n';\n              code += '    \\n';\n              \n              // Отправляем запрос пользователю\n              const formattedPrompt = formatTextForPython(inputPrompt);\n              code += `    text = ${formattedPrompt}\\n`;\n              \n              if (responseType === 'buttons' && responseOptions.length > 0) {\n                // Обработка кнопочного ответа\n                const buttonType = targetNode.data.buttonType || 'inline';\n                code += '    \\n';\n                code += '    # Создаем кнопки для выбора ответа\\n';\n                \n                if (buttonType === 'reply') {\n                  code += '    builder = ReplyKeyboardBuilder()\\n';\n                  \n                  responseOptions.forEach((option, index) => {\n                    code += `    builder.add(KeyboardButton(text=\"${option.text}\"))\\n`;\n                  });\n                  \n                  if (allowSkip) {\n                    code += `    builder.add(KeyboardButton(text=\"⏭️ Пропустить\"))\\n`;\n                  }\n                  \n                  code += '    keyboard = builder.as_markup(resize_keyboard=True, one_time_keyboard=True)\\n';\n                  code += '    await bot.send_message(callback_query.from_user.id, text, reply_markup=keyboard)\\n';\n                } else {\n                  code += '    builder = InlineKeyboardBuilder()\\n';\n                  \n                  responseOptions.forEach((option, index) => {\n                    const optionValue = option.value || option.text;\n                    code += `    builder.add(InlineKeyboardButton(text=\"${option.text}\", callback_data=\"response_${targetNode.id}_${index}\"))\\n`;\n                  });\n                  \n                  if (allowSkip) {\n                    code += `    builder.add(InlineKeyboardButton(text=\"⏭️ Пропустить\", callback_data=\"skip_${targetNode.id}\"))\\n`;\n                  }\n                  \n                  code += '    keyboard = builder.as_markup()\\n';\n                  code += '    await bot.send_message(callback_query.from_user.id, text, reply_markup=keyboard)\\n';\n                }\n                code += '    \\n';\n                code += '    # Инициализируем пользовательские данные если их нет\\n';\n                code += '    if callback_query.from_user.id not in user_data:\\n';\n                code += '        user_data[callback_query.from_user.id] = {}\\n';\n                code += '    \\n';\n                // Find the next node to navigate to after successful input\n                const nextConnection = connections.find(conn => conn.source === targetNode.id);\n                const nextNodeId = nextConnection ? nextConnection.target : null;\n                \n                code += '    # Сохраняем настройки для обработки ответа\\n';\n                code += '    user_data[callback_query.from_user.id][\"button_response_config\"] = {\\n';\n                code += `        \"node_id\": \"${targetNode.id}\",\\n`;\n                code += `        \"variable\": \"${inputVariable}\",\\n`;\n                code += `        \"save_to_database\": ${toPythonBoolean(saveToDatabase)},\\n`;\n                code += `        \"success_message\": \"${escapeForJsonString(inputSuccessMessage)}\",\\n`;\n                code += `        \"allow_multiple\": ${toPythonBoolean(allowMultipleSelection)},\\n`;\n                code += `        \"next_node_id\": \"${nextNodeId || ''}\",\\n`;\n                code += '        \"options\": [\\n';\n                responseOptions.forEach((option, index) => {\n                  const optionValue = option.value || option.text;\n                  const optionAction = option.action || 'goto';\n                  const optionTarget = option.target || '';\n                  const optionUrl = option.url || '';\n                  code += `            {\"index\": ${index}, \"text\": \"${escapeForJsonString(option.text)}\", \"value\": \"${escapeForJsonString(optionValue)}\", \"action\": \"${optionAction}\", \"target\": \"${optionTarget}\", \"url\": \"${escapeForJsonString(optionUrl)}\"},\\n`;\n                });\n                code += '        ],\\n';\n                code += `        \"selected\": []\\n`;\n                code += '    }\\n';\n                \n              } else {\n                // Обработка текстового ввода (оригинальная логика)\n                if (placeholder) {\n                  code += `    placeholder_text = \"${placeholder}\"\\n`;\n                  code += '    text += f\"\\\\n\\\\n💡 {placeholder_text}\"\\n';\n                }\n                \n                if (allowSkip) {\n                  code += '    text += \"\\\\n\\\\n⏭️ Нажмите /skip чтобы пропустить\"\\n';\n                }\n                \n                code += '    await bot.send_message(callback_query.from_user.id, text)\\n';\n                code += '    \\n';\n                code += '    # Инициализируем пользовательские данные если их нет\\n';\n                code += '    if callback_query.from_user.id not in user_data:\\n';\n                code += '        user_data[callback_query.from_user.id] = {}\\n';\n                code += '    \\n';\n                // Find the next node to navigate to after successful input\n                const nextConnection = connections.find(conn => conn.source === targetNode.id);\n                const nextNodeId = nextConnection ? nextConnection.target : null;\n                \n                code += '    # Настраиваем ожидание ввода\\n';\n                code += '    user_data[callback_query.from_user.id][\"waiting_for_input\"] = {\\n';\n                code += `        \"type\": \"${inputType}\",\\n`;\n                code += `        \"variable\": \"${inputVariable}\",\\n`;\n                code += `        \"validation\": \"${inputValidation}\",\\n`;\n                code += `        \"min_length\": ${minLength},\\n`;\n                code += `        \"max_length\": ${maxLength},\\n`;\n                code += `        \"timeout\": ${inputTimeout},\\n`;\n                code += `        \"required\": ${toPythonBoolean(inputRequired)},\\n`;\n                code += `        \"allow_skip\": ${toPythonBoolean(allowSkip)},\\n`;\n                code += `        \"save_to_database\": ${toPythonBoolean(saveToDatabase)},\\n`;\n                code += `        \"retry_message\": \"${escapeForJsonString(inputRetryMessage)}\",\\n`;\n                code += `        \"success_message\": \"${escapeForJsonString(inputSuccessMessage)}\",\\n`;\n                code += `        \"prompt\": \"${escapeForJsonString(inputPrompt)}\",\\n`;\n                code += `        \"node_id\": \"${targetNode.id}\",\\n`;\n                code += `        \"next_node_id\": \"${nextNodeId || ''}\"\\n`;\n                code += '    }\\n';\n              }\n              \n            } else if (targetNode.type === 'start') {\n              // Handle start nodes in callback queries - show start message with buttons\n              const messageText = targetNode.data.messageText || \"Добро пожаловать!\";\n              const cleanedMessageText = stripHtmlTags(messageText);\n              const formattedText = formatTextForPython(cleanedMessageText);\n              const parseMode = getParseMode(targetNode.data.formatMode);\n              \n              code += `    # Обрабатываем узел start: ${targetNode.id}\\n`;\n              code += `    text = ${formattedText}\\n`;\n              \n              // Применяем универсальную замену переменных\n              code += '    \\n';\n              code += generateUniversalVariableReplacement('    ');\n              \n              // Добавляем поддержку условных сообщений для start узлов\n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '    \\n';\n                code += '    # Проверка условных сообщений для start узла\\n';\n                code += '    user_record = await get_user_from_db(user_id)\\n';\n                code += '    if not user_record:\\n';\n                code += '        user_record = user_data.get(user_id, {})\\n';\n                code += '    user_data_dict = user_record if user_record else user_data.get(user_id, {})\\n';\n                code += generateConditionalMessageLogic(targetNode.data.conditionalMessages, '    ');\n                code += '    \\n';\n                \n                // Use conditional message if available, otherwise use default\n                code += '    # Используем условное сообщение если есть подходящее условие\\n';\n                code += '    if \"text\" not in locals():\\n';\n                code += `        text = ${formattedText}\\n`;\n                code += '    \\n';\n                code += '    # Используем условную клавиатуру если есть\\n';\n                code += '    if conditional_keyboard is not None:\\n';\n                code += '        keyboard = conditional_keyboard\\n';\n                code += '    else:\\n';\n                code += '        keyboard = None\\n';\n              } else {\n                code += '    \\n';\n                code += '    # Без условных сообщений - используем обычную клавиатуру\\n';\n                code += '    keyboard = None\\n';\n              }\n              \n              // Создаем inline клавиатуру для start узла (только если нет условной клавиатуры)\n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons && targetNode.data.buttons.length > 0) {\n                code += '    # Проверяем, есть ли условная клавиатура\\n';\n                code += '    if keyboard is None:\\n';\n                code += '        # Создаем inline клавиатуру для start узла\\n';\n                code += '        builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    // Создаем уникальный callback_data для каждой кнопки\n                    const baseCallbackData = btn.target || btn.id || 'no_action';\n                    const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command') {\n                    // Для кнопок команд создаем специальную callback_data\n                    const commandCallback = `cmd_${btn.target ? btn.target.replace('/', '') : 'unknown'}`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                  }\n                });\n                // Добавляем настройку колонок для консистентности\n                const columns = calculateOptimalColumns(targetNode.data.buttons, targetNode.data);\n                code += `        builder.adjust(${columns})\\n`;\n                code += '        keyboard = builder.as_markup()\\n';\n              }\n              \n              // Отправляем сообщение start узла\n              code += '    # Отправляем сообщение start узла\\n';\n              code += '    try:\\n';\n              code += '        if keyboard is not None:\\n';\n              code += `            await safe_edit_or_send(callback_query, text, reply_markup=keyboard${parseMode})\\n`;\n              code += '        else:\\n';\n              code += `            await safe_edit_or_send(callback_query, text${parseMode})\\n`;\n              code += '    except Exception:\\n';\n              code += '        if keyboard is not None:\\n';\n              code += `            await callback_query.message.answer(text, reply_markup=keyboard${parseMode})\\n`;\n              code += '        else:\\n';\n              code += `            await callback_query.message.answer(text${parseMode})\\n`;\n              \n            } else if (targetNode.type === 'command') {\n              // Handle command nodes in callback queries\n              const command = targetNode.data.command || '/start';\n              const commandMessage = targetNode.data.messageText || `Выполняем команду ${command}`;\n              const cleanedCommandMessage = stripHtmlTags(commandMessage);\n              const formattedCommandText = formatTextForPython(cleanedCommandMessage);\n              const parseMode = getParseMode(targetNode.data.formatMode);\n              \n              code += `    # Обрабатываем узел command: ${targetNode.id}\\n`;\n              code += `    text = ${formattedCommandText}\\n`;\n              \n              // Применяем универсальную замену переменных\n              code += '    \\n';\n              code += generateUniversalVariableReplacement('    ');\n              \n              // Создаем inline клавиатуру для command узла если есть кнопки\n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons && targetNode.data.buttons.length > 0) {\n                code += '    # Создаем inline клавиатуру для command узла\\n';\n                code += '    builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    const baseCallbackData = btn.target || btn.id || 'no_action';\n                    const callbackData = `${baseCallbackData}_btn_${index}`;\n                    code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command') {\n                    const commandCallback = `cmd_${btn.target ? btn.target.replace('/', '') : 'unknown'}`;\n                    code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                  }\n                });\n                // Добавляем настройку колонок для консистентности\n                const columns = calculateOptimalColumns(targetNode.data.buttons, targetNode.data);\n                code += `    builder.adjust(${columns})\\n`;\n                code += '    keyboard = builder.as_markup()\\n';\n                code += '    # Отправляем сообщение command узла с клавиатурой\\n';\n                code += '    try:\\n';\n                code += `        await safe_edit_or_send(callback_query, text, reply_markup=keyboard${parseMode})\\n`;\n                code += '    except Exception:\\n';\n                code += `        await callback_query.message.answer(text, reply_markup=keyboard${parseMode})\\n`;\n              } else {\n                code += '    # Отправляем сообщение command узла без клавиатуры\\n';\n                code += '    try:\\n';\n                code += `        await safe_edit_or_send(callback_query, text${parseMode})\\n`;\n                code += '    except Exception:\\n';\n                code += `        await callback_query.message.answer(text${parseMode})\\n`;\n              }\n              \n            } else {\n              // Universal handler for all other node types (message, photo, document, etc.)\n              code += `    # Обрабатываем узел типа ${targetNode.type}: ${targetNode.id}\\n`;\n              \n              if (targetNode.type === 'photo') {\n                // Handle photo nodes\n                const photoUrl = targetNode.data.photoUrl || targetNode.data.imageUrl || \"\";\n                const caption = targetNode.data.caption || targetNode.data.messageText || \"\";\n                const cleanedCaption = stripHtmlTags(caption);\n                const formattedCaption = formatTextForPython(cleanedCaption);\n                const parseMode = getParseMode(targetNode.data.formatMode);\n                \n                code += `    # Отправляем фото\\n`;\n                code += `    photo_url = \"${photoUrl}\"\\n`;\n                code += `    caption = ${formattedCaption}\\n`;\n                \n                // Применяем универсальную замену переменных в подписи\n                code += generateUniversalVariableReplacement('    ');\n                code += '    photo_url = replace_variables_in_text(photo_url, user_vars)\\n';\n                \n                if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons && targetNode.data.buttons.length > 0) {\n                  code += '    # Создаем inline клавиатуру для фото\\n';\n                  code += '    builder = InlineKeyboardBuilder()\\n';\n                  targetNode.data.buttons.forEach((btn, index) => {\n                    if (btn.action === \"url\") {\n                      code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                    } else if (btn.action === 'goto') {\n                      const baseCallbackData = btn.target || btn.id || 'no_action';\n                      const callbackData = `${baseCallbackData}_btn_${index}`;\n                      code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                    }\n                  });\n                  code += '    keyboard = builder.as_markup()\\n';\n                  code += '    await callback_query.message.delete()\\n';\n                  code += `    await bot.send_photo(callback_query.from_user.id, photo=photo_url, caption=caption, reply_markup=keyboard${parseMode})\\n`;\n                } else {\n                  code += '    await callback_query.message.delete()\\n';\n                  code += `    await bot.send_photo(callback_query.from_user.id, photo=photo_url, caption=caption${parseMode})\\n`;\n                }\n                \n              } else {\n                // Handle message and other text-based nodes\n                const targetText = targetNode.data.messageText || \"Сообщение\";\n                const cleanedText = stripHtmlTags(targetText);\n                const formattedTargetText = formatTextForPython(cleanedText);\n                const parseMode = getParseMode(targetNode.data.formatMode);\n                \n                code += `    text = ${formattedTargetText}\\n`;\n                \n                // Добавляем замену переменных в тексте\n                code += generateUniversalVariableReplacement('    ');\n                \n                // Добавляем поддержку условных сообщений для keyboard узлов с collectUserInput\n                if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                  code += '    \\n';\n                  code += '    # Проверка условных сообщений для keyboard узла\\n';\n                  code += '    user_record = await get_user_from_db(callback_query.from_user.id)\\n';\n                  code += '    if not user_record:\\n';\n                  code += '        user_record = user_data.get(callback_query.from_user.id, {})\\n';\n                  code += '    user_data_dict = user_record if user_record else user_data.get(callback_query.from_user.id, {})\\n';\n                  code += generateConditionalMessageLogic(targetNode.data.conditionalMessages, '    ');\n                  code += '    \\n';\n                  \n                  // Use conditional message if available, otherwise use default\n                  code += '    # Используем условное сообщение если есть подходящее условие\\n';\n                  code += '    if \"text\" not in locals():\\n';\n                  code += `        text = ${formattedTargetText}\\n`;\n                  code += '    \\n';\n                  code += '    # Используем условную клавиатуру если есть\\n';\n                  code += '    if conditional_keyboard is not None:\\n';\n                  code += '        keyboard = conditional_keyboard\\n';\n                  code += '    else:\\n';\n                  code += '        keyboard = None\\n';\n                  code += '    \\n';\n                }\n              }\n            \n              // ВАЖНО: Проверяем, включен ли сбор пользовательского ввода для этого узла (основной цикл)\n              if (targetNode.data.collectUserInput === true) {\n                // Настраиваем сбор пользовательского ввода\n                code += '    # Активируем сбор пользовательского ввода (основной цикл)\\n';\n                code += '    if callback_query.from_user.id not in user_data:\\n';\n                code += '        user_data[callback_query.from_user.id] = {}\\n';\n                code += '    \\n';\n                // Используем helper функцию, но нужно заменить message на callback_query.from_user\n                const waitingCode = generateWaitingStateCode(targetNode, '    ');\n                code += waitingCode.replace(/message\\.from_user\\.id/g, 'callback_query.from_user.id');\n                code += '    \\n';\n                \n                // ИСПРАВЛЕНИЕ: Добавляем поддержку кнопок с проверкой условной клавиатуры\n                if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons && targetNode.data.buttons.length > 0) {\n                  code += '    # Проверяем, есть ли условная клавиатуря для этого узла\\n';\n                  code += '    if \"keyboard\" not in locals() or keyboard is None:\\n';\n                  code += '        # Создаем inline клавиатуру с кнопками (+ сбор ввода включен)\\n';\n                  code += '        builder = InlineKeyboardBuilder()\\n';\n                  targetNode.data.buttons.forEach((btn, index) => {\n                    if (btn.action === \"url\") {\n                      code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                    } else if (btn.action === 'goto') {\n                      // Создаем уникальный callback_data для каждой кнопки\n                      const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                      const uniqueCallbackData = `${callbackData}_btn_${targetNode.data.buttons.indexOf(btn)}`;\n                      code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${uniqueCallbackData}\"))\\n`;\n                    } else if (btn.action === 'command') {\n                      // Для кнопок команд создаем специальную callback_data\n                      const commandCallback = `cmd_${btn.target ? btn.target.replace('/', '') : 'unknown'}`;\n                      code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                    }\n                  });\n                  // Добавляем настройку колонок для консистентности\n                  const columns = calculateOptimalColumns(targetNode.data.buttons, targetNode.data);\n                  code += `        builder.adjust(${columns})\\n`;\n                  code += '        keyboard = builder.as_markup()\\n';\n                  // Определяем режим форматирования для целевого узла\n                  let parseModeTarget = '';\n                  if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                    parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n                  } else if (targetNode.data.formatMode === 'html') {\n                    parseModeTarget = ', parse_mode=ParseMode.HTML';\n                  }\n                  code += `    # Пытаемся редактировать сообщение, если не получается - отправляем новое\\n`;\n                  code += `    try:\\n`;\n                  code += `        await safe_edit_or_send(callback_query, text, reply_markup=keyboard${parseModeTarget})\\n`;\n                  code += `    except Exception as e:\\n`;\n                  code += `        logging.warning(f\"Не удалось редактировать сообщение: {e}. Отправляем новое.\")\\n`;\n                  code += `        await callback_query.message.answer(text, reply_markup=keyboard${parseModeTarget})\\n`;\n                } else {\n                  code += `    # Пытаемся редактировать сообщение, если не получается - отправляем новое\\n`;\n                  code += `    try:\\n`;\n                  code += `        await callback_query.message.edit_text(text)\\n`;\n                  code += `    except Exception as e:\\n`;\n                  code += `        logging.warning(f\"Не удалось редактировать сообщение: {e}. Отправляем новое.\")\\n`;\n                  code += `        await callback_query.message.answer(text)\\n`;\n                }\n                code += '    \\n';\n              } else {\n                // Обычное отображение сообщения без сбора ввода\n                \n                // Handle keyboard for target node\n                code += `    # DEBUG: Узел ${targetNode.id} - hasRegularButtons=${toPythonBoolean(targetNode.data.buttons && targetNode.data.buttons.length > 0)}, hasInputCollection=False\\n`;\n                code += `    logging.info(f\"DEBUG: Узел ${targetNode.id} обработка кнопок - keyboardType=${targetNode.data.keyboardType}, buttons=${targetNode.data.buttons ? targetNode.data.buttons.length : 0}\")\\n`;\n                if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n                  code += `    logging.info(f\"DEBUG: Создаем inline клавиатуру для узла ${targetNode.id} с ${targetNode.data.buttons.length} кнопками\")\\n`;\n                  code += '    # Проверяем, есть ли уже клавиатура из условных сообщений\\n';\n                  code += '    if \"keyboard\" not in locals() or keyboard is None:\\n';\n                  code += '        # ИСПРАВЛЕНИЕ: Используем универсальную функцию создания клавиатуры\\n';\n                  // ИСПРАВЛЕНИЕ: Используем универсальную функцию generateInlineKeyboardCode\n                  const keyboardCode = generateInlineKeyboardCode(targetNode.data.buttons, '        ', targetNode.id, targetNode.data, allNodeIds);\n                  code += keyboardCode;\n                  // Определяем режим форматирования для целевого узла\n                  let parseModeTarget = '';\n                  if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                    parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n                  } else if (targetNode.data.formatMode === 'html') {\n                    parseModeTarget = ', parse_mode=ParseMode.HTML';\n                  }\n                  code += `    # Пытаемся редактировать сообщение, если не получается - отправляем новое\\n`;\n                  code += `    try:\\n`;\n                  code += `        await safe_edit_or_send(callback_query, text, reply_markup=keyboard${parseModeTarget})\\n`;\n                  code += `    except Exception as e:\\n`;\n                  code += `        logging.warning(f\"Не удалось редактировать сообщение: {e}. Отправляем новое.\")\\n`;\n                  code += `        await callback_query.message.answer(text, reply_markup=keyboard${parseModeTarget})\\n`;\n                } else if (targetNode.data.keyboardType === \"reply\" && targetNode.data.buttons.length > 0) {\n                  code += '    # Проверяем, есть ли уже клавиатура из условных сообщений\\n';\n                  code += '    if \"keyboard\" not in locals() or keyboard is None:\\n';\n                  code += '        # Создаем reply клавиатуру\\n';\n                  code += '        builder = ReplyKeyboardBuilder()\\n';\n                  targetNode.data.buttons.forEach((btn, index) => {\n                    code += `        builder.add(KeyboardButton(text=${generateButtonText(btn.text)}))\\n`;\n                  });\n                  const resizeKeyboard = toPythonBoolean(targetNode.data.resizeKeyboard);\n                  const oneTimeKeyboard = toPythonBoolean(targetNode.data.oneTimeKeyboard);\n                  code += `        keyboard = builder.as_markup(resize_keyboard=${resizeKeyboard}, one_time_keyboard=${oneTimeKeyboard})\\n`;\n                  code += '    # Для reply клавиатуры отправляем новое сообщение и удаляем старое\\n';\n                  code += '    try:\\n';\n                  code += '        await callback_query.message.delete()\\n';\n                  code += '    except:\\n';\n                  code += '        pass  # Игнорируем ошибки удаления\\n';\n                  // Определяем режим форматирования для целевого узла\n                  let parseModeTarget = '';\n                  if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                    parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n                  } else if (targetNode.data.formatMode === 'html') {\n                    parseModeTarget = ', parse_mode=ParseMode.HTML';\n                  }\n                  code += `    await bot.send_message(callback_query.from_user.id, text, reply_markup=keyboard${parseModeTarget})\\n`;\n                } else {\n                  // Определяем режим форматирования для целевого узла\n                  let parseModeTarget = '';\n                  if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                    parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n                  } else if (targetNode.data.formatMode === 'html') {\n                    parseModeTarget = ', parse_mode=ParseMode.HTML';\n                  }\n                  code += `    # Пытаемся редактировать сообщение, если не получается - отправляем новое\\n`;\n                  code += `    try:\\n`;\n                  code += `        await callback_query.message.edit_text(text${parseModeTarget})\\n`;\n                  code += `    except Exception as e:\\n`;\n                  code += `        logging.warning(f\"Не удалось редактировать сообщение: {e}. Отправляем новое.\")\\n`;\n                  code += `        await callback_query.message.answer(text${parseModeTarget})\\n`;\n                }\n              } // Закрываем else блок для обычного отображения (основной цикл)\n            } // Закрываем else блок для обычных текстовых сообщений (основной цикл)\n          } else {\n            // Кнопка без цели - просто уведомляем пользователя\n            code += '    # Кнопка пока никуда не ведет\\n';\n            code += '    await callback_query.answer(\"⚠️ Эта кнопка пока не настроена\", show_alert=True)\\n';\n          }\n        } else if (button.action === 'command' && button.id) {\n          // Обработка кнопок с действием \"command\"\n          const callbackData = `cmd_${button.target ? button.target.replace('/', '') : 'unknown'}`;\n          \n          // Avoid duplicate handlers\n          if (processedCallbacks.has(callbackData)) return;\n          processedCallbacks.add(callbackData);\n          \n          code += `\\n@dp.callback_query(lambda c: c.data == \"${callbackData}\")\\n`;\n          const safeFunctionName = callbackData.replace(/[^a-zA-Z0-9_]/g, '_');\n          code += `async def handle_callback_${safeFunctionName}(callback_query: types.CallbackQuery):\\n`;\n          code += '    await callback_query.answer()\\n';\n          code += '    user_id = callback_query.from_user.id\\n';\n          code += `    button_text = \"${button.text}\"\\n`;\n          code += '    \\n';\n          code += '    # Сохраняем кнопку в базу данных\\n';\n          code += '    timestamp = get_moscow_time()\\n';\n          code += '    response_data = button_text\\n';\n          code += '    await update_user_data_in_db(user_id, button_text, response_data)\\n';\n          code += `    logging.info(f\"Команда ${button.target || 'неизвестная'} выполнена через callback кнопку (пользователь {user_id})\")\\n`;\n          code += '    \\n';\n          \n          // Создаем правильный вызов команды для callback кнопок\n          if (button.target) {\n            // Определяем команду - убираем ведущий слеш если есть\n            const command = button.target.startsWith('/') ? button.target.replace('/', '') : button.target;\n            const handlerName = `${command}_handler`;\n            \n            code += `    # Вызываем ${handlerName} правильно через edit_text\\n`;\n            code += '    # Создаем специальный объект для редактирования сообщения\\n';\n            code += '    class FakeMessageEdit:\\n';\n            code += '        def __init__(self, callback_query):\\n';\n            code += '            self.from_user = callback_query.from_user\\n';\n            code += '            self.chat = callback_query.message.chat\\n';\n            code += '            self.date = callback_query.message.date\\n';\n            code += '            self.message_id = callback_query.message.message_id\\n';\n            code += '            self._callback_query = callback_query\\n';\n            code += '        \\n';\n            code += '        async def answer(self, text, parse_mode=None, reply_markup=None):\\n';\n            code += '            await self._callback_query.message.edit_text(text, parse_mode=parse_mode, reply_markup=reply_markup)\\n';\n            code += '        \\n';\n            code += '        async def edit_text(self, text, parse_mode=None, reply_markup=None):\\n';\n            code += '            await self._callback_query.message.edit_text(text, parse_mode=parse_mode, reply_markup=reply_markup)\\n';\n            code += '    \\n';\n            code += '    fake_edit_message = FakeMessageEdit(callback_query)\\n';\n            code += `    await ${handlerName}(fake_edit_message)\\n`;\n          } else {\n            code += '    await callback_query.message.edit_text(\"❌ Команда не найдена\")\\n';\n          }\n        }\n      });\n    });\n    \n    // CRITICAL FIX: Ensure interests_result gets a handler BUT avoid duplicates\n    console.log('🔧 ГЕНЕРАТОР CRITICAL FIX: Проверяем interests_result обработчик');\n    console.log('🔧 ГЕНЕРАТОР: processedCallbacks перед check:', Array.from(processedCallbacks));\n    \n    // Проверяем, был ли interests_result уже обработан в основном цикле\n    const wasInterestsResultProcessed = processedCallbacks.has('interests_result');\n    console.log('🔧 ГЕНЕРАТОР: interests_result уже обработан в основном цикле?', wasInterestsResultProcessed);\n    \n    // ИСПРАВЛЕНИЕ: НЕ создаем дублирующий обработчик если он уже есть\n    if (wasInterestsResultProcessed) {\n      console.log('🔧 ГЕНЕРАТОР: ПРОПУСКАЕМ создание дублирующего обработчика для interests_result');\n      console.log('🔧 ГЕНЕРАТОР: interests_result уже обработан в основном цикле, избегаем конфликта клавиатур');\n    } else {\n      console.log('🔧 ГЕНЕРАТОР: Создаем обработчик для interests_result (не найден в основном цикле)');\n      processedCallbacks.add('interests_result');\n      const interestsResultNode = nodes.find(n => n.id === 'interests_result');\n      if (interestsResultNode) {\n        processedCallbacks.add('interests_result');\n        code += `\\n@dp.callback_query(lambda c: c.data == \"interests_result\" or c.data.startswith(\"interests_result_btn_\"))\\n`;\n        code += `async def handle_callback_interests_result(callback_query: types.CallbackQuery):\\n`;\n        code += '    await callback_query.answer()\\n';\n        code += '    # Handle interests_result node\\n';\n        code += '    user_id = callback_query.from_user.id\\n';\n        \n        // Add the full message handling for interests_result node\n        const messageText = interestsResultNode.data.messageText || \"Результат\";\n        const cleanedMessageText = stripHtmlTags(messageText);\n        const formattedText = formatTextForPython(cleanedMessageText);\n        \n        code += `    text = ${formattedText}\\n`;\n        code += '    \\n';\n        code += generateUniversalVariableReplacement('    ');\n        \n        // ИСПРАВЛЕНИЕ: Специальная логика для interests_result - показываем метро клавиатуру\n        console.log('🔧 ГЕНЕРАТОР: Обрабатываем interests_result узел - добавляем метро клавиатуру');\n        code += '    # ИСПРАВЛЕНИЕ: Проверяем, нужно ли показать метро клавиатуру\\n';\n        code += '    logging.info(\"🔧 ГЕНЕРАТОР DEBUG: Вошли в узел interests_result\")\\n';\n        code += '    # Загружаем флаг из базы данных, если он там есть\\n';\n        code += '    user_vars = await get_user_from_db(user_id)\\n';\n        code += '    if not user_vars:\\n';\n        code += '        user_vars = user_data.get(user_id, {})\\n';\n        code += '        logging.info(\"🔧 ГЕНЕРАТОР DEBUG: user_vars загружены из user_data\")\\n';\n        code += '    else:\\n';\n        code += '        logging.info(\"🔧 ГЕНЕРАТОР DEBUG: user_vars загружены из базы данных\")\\n';\n        code += '    \\n';\n        code += '    show_metro_keyboard = False\\n';\n        code += '    if isinstance(user_vars, dict):\\n';\n        code += '        if \"show_metro_keyboard\" in user_vars:\\n';\n        code += '            show_metro_keyboard = str(user_vars[\"show_metro_keyboard\"]).lower() == \"true\"\\n';\n        code += '            logging.info(f\"🔧 ГЕНЕРАТОР DEBUG: Нашли show_metro_keyboard в user_vars: {show_metro_keyboard}\")\\n';\n        code += '    \\n';\n        code += '    # Также проверяем локальное хранилище\\n';\n        code += '    if not show_metro_keyboard:\\n';\n        code += '        show_metro_keyboard = user_data.get(user_id, {}).get(\"show_metro_keyboard\", False)\\n';\n        code += '        logging.info(f\"🔧 ГЕНЕРАТОР DEBUG: Проверили локальное хранилище: {show_metro_keyboard}\")\\n';\n        code += '    \\n';\n        code += '    saved_metro = user_data.get(user_id, {}).get(\"saved_metro_selection\", [])\\n';\n        code += '    logging.info(f\"🚇 interests_result: show_metro_keyboard={show_metro_keyboard}, saved_metro={saved_metro}\")\\n';\n        code += '    \\n';\n        \n        // Находим узел metro_selection для восстановления его кнопок\n        const metroNode = nodes.find(n => n.id.includes('metro_selection'));\n        console.log(`🔧 ГЕНЕРАТОР: Поиск узла metro_selection - найден: ${metroNode ? 'да' : 'нет'}`);\n        if (metroNode && metroNode.data.buttons) {\n          console.log(`🔧 ГЕНЕРАТОР: Узел metro_selection найден: ${metroNode.id}, кнопок: ${metroNode.data.buttons.length}`);\n          code += '    # Создаем метро клавиатуру если нужно\\n';\n          code += '    if show_metro_keyboard:\\n';\n          code += '        logging.info(\"🚇 ПОКАЗЫВАЕМ метро клавиатуру в interests_result\")\\n';\n          code += '        builder = InlineKeyboardBuilder()\\n';\n          \n          // Добавляем кнопки метро\n          metroNode.data.buttons.forEach((btn, index) => {\n            const shortNodeId = metroNode.id.slice(-10).replace(/^_+/, '');\n            const callbackData = `ms_${shortNodeId}_${btn.target || `btn_${index}`}`;\n            code += `        # Кнопка метро: ${btn.text}\\n`;\n            code += `        selected_metro = \"${btn.text}\" in saved_metro\\n`;\n            code += `        button_text = \"✅ \" + \"${btn.text}\" if selected_metro else \"${btn.text}\"\\n`;\n            code += `        builder.add(InlineKeyboardButton(text=button_text, callback_data=\"${callbackData}\"))\\n`;\n          });\n          \n          // Добавляем кнопку \"Готово\" с правильным callback_data для handle_multi_select_done\n          const metroCallbackData = `multi_select_done_${metroNode.id}`;\n          code += `        builder.add(InlineKeyboardButton(text=\"✅ Готово\", callback_data=\"${metroCallbackData}\"))\\n`;\n          code += '        builder.adjust(2)  # 2 кнопки в ряд\\n';\n          code += '        metro_keyboard = builder.as_markup()\\n';\n          code += '        \\n';\n          \n          // Обычные кнопки interests_result\n          code += '        # Добавляем обычные кнопки interests_result\\n';\n          if (interestsResultNode.data.buttons && interestsResultNode.data.buttons.length > 0) {\n            code += '        result_builder = InlineKeyboardBuilder()\\n';\n            interestsResultNode.data.buttons.forEach((btn, index) => {\n              if (btn.action === \"goto\" && btn.target) {\n                const btnCallbackData = `${btn.target}_btn_${index}`;\n                code += `        result_builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${btnCallbackData}\"))\\n`;\n              } else if (btn.action === \"command\" && btn.target) {\n                const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                code += `        result_builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n              } else if (btn.action === \"url\") {\n                code += `        result_builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n              }\n            });\n            code += '        result_keyboard = result_builder.as_markup()\\n';\n            code += '        \\n';\n            code += '        # Объединяем клавиатуры\\n';\n            code += '        combined_keyboard = InlineKeyboardMarkup(inline_keyboard=metro_keyboard.inline_keyboard + result_keyboard.inline_keyboard)\\n';\n            code += '        await bot.send_message(user_id, text, reply_markup=combined_keyboard)\\n';\n          } else {\n            code += '        await bot.send_message(user_id, text, reply_markup=metro_keyboard)\\n';\n          }\n          \n          code += '        # НЕ сбрасываем флаг show_metro_keyboard, чтобы клавиатура оставалась активной\\n';\n          code += '        logging.info(\"🚇 Клавиатура метро показана и остается активной\")\\n';\n          code += '    else:\\n';\n          code += '        # Обычная логика без метро клавиатуры\\n';\n          \n          // Handle buttons if any (без метро клавиатуры)\n          if (interestsResultNode.data.buttons && interestsResultNode.data.buttons.length > 0) {\n            code += '        builder = InlineKeyboardBuilder()\\n';\n            interestsResultNode.data.buttons.forEach((btn, index) => {\n              if (btn.action === \"goto\" && btn.target) {\n                const btnCallbackData = `${btn.target}_btn_${index}`;\n                code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${btnCallbackData}\"))\\n`;\n              } else if (btn.action === \"command\" && btn.target) {\n                const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n              } else if (btn.action === \"url\") {\n                code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n              }\n            });\n            code += '        keyboard = builder.as_markup()\\n';\n            code += '        await bot.send_message(user_id, text, reply_markup=keyboard)\\n';\n          } else {\n            code += '        await bot.send_message(user_id, text)\\n';\n          }\n        } else {\n          console.log('🔧 ГЕНЕРАТОР: Узел metro_selection НЕ найден или у него нет кнопок');\n          // Обычная логика если узла метро нет\n          code += '    logging.info(\"🚇 Узел metro_selection не найден, используем обычную логику\")\\n';\n          if (interestsResultNode.data.buttons && interestsResultNode.data.buttons.length > 0) {\n            code += '    builder = InlineKeyboardBuilder()\\n';\n            interestsResultNode.data.buttons.forEach((btn, index) => {\n              if (btn.action === \"goto\" && btn.target) {\n                const btnCallbackData = `${btn.target}_btn_${index}`;\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${btnCallbackData}\"))\\n`;\n              } else if (btn.action === \"command\" && btn.target) {\n                const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n              } else if (btn.action === \"url\") {\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n              }\n            });\n            code += '    keyboard = builder.as_markup()\\n';\n            code += '    await bot.send_message(user_id, text, reply_markup=keyboard)\\n';\n          } else {\n            code += '    await bot.send_message(user_id, text)\\n';\n          }\n        }\n        code += '\\n';\n      }\n    }\n\n    // Now generate callback handlers for all remaining referenced nodes that don't have inline buttons\n    console.log(`🔍 ГЕНЕРАТОР: Обработка allReferencedNodeIds: ${Array.from(allReferencedNodeIds).join(', ')}`);\n    console.log(`🔍 ГЕНЕРАТОР: Уже обработанные callbacks: ${Array.from(processedCallbacks).join(', ')}`);\n    \n    allReferencedNodeIds.forEach(nodeId => {\n      console.log(`🔎 ГЕНЕРАТОР: Проверяем узел ${nodeId}`);\n      if (!processedCallbacks.has(nodeId)) {\n        console.log(`✅ ГЕНЕРАТОР: Узел ${nodeId} НЕ был обработан ранее, создаем обработчик`);\n        const targetNode = nodes.find(n => n.id === nodeId);\n        if (targetNode) {\n          console.log(`📋 ГЕНЕРАТОР: Найден узел ${nodeId}, тип: ${targetNode.type}`);\n          console.log(`📋 ГЕНЕРАТОР: allowMultipleSelection: ${targetNode.data.allowMultipleSelection}`);\n          console.log(`📋 ГЕНЕРАТОР: keyboardType: ${targetNode.data.keyboardType}`);\n          console.log(`📋 ГЕНЕРАТОР: кнопок: ${targetNode.data.buttons?.length || 0}`);\n          console.log(`📋 ГЕНЕРАТОР: continueButtonTarget: ${targetNode.data.continueButtonTarget || 'нет'}`);\n          \n          if (nodeId === 'interests_result') {\n            console.log(`🚨 ГЕНЕРАТОР ALL_REFERENCED: СОЗДАЕМ ТРЕТИЙ ОБРАБОТЧИК ДЛЯ interests_result!`);\n            console.log(`🚨 ГЕНЕРАТОР ALL_REFERENCED: interests_result данные:`, JSON.stringify(targetNode.data, null, 2));\n            console.log(`🚨 ГЕНЕРАТОР ALL_REFERENCED: ЭТО МОЖЕТ БЫТЬ ИСТОЧНИКОМ КОНФЛИКТА КЛАВИАТУР!`);\n          }\n          \n          // ВАЖНО: Не создаваем обработчик для \"start\", если он уже был создан ранее (избегаем дублирования)\n          if (nodeId === 'start') {\n            console.log(`Пропускаем создание дублированной функции для узла ${nodeId} - уже создана ранее`);\n            return; // Пропускаем создание дублированной функции\n          }\n          \n          // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Также проверяем interests_result и metro_selection\n          if (nodeId === 'interests_result') {\n            console.log(`🚨 ГЕНЕРАТОР: ПРОПУСКАЕМ дублирующий обработчик для interests_result - уже создан в основном цикле`);\n            return; // Избегаем дублирования обработчика interests_result\n          }\n          \n          // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Пропускаем дублирующий обработчик для metro_selection\n          if (nodeId === 'metro_selection') {\n            console.log(`🚨 ГЕНЕРАТОР: ПРОПУСКАЕМ дублирующий обработчик для metro_selection - уже создан в основном цикле`);\n            return; // Избегаем дублирования обработчика metro_selection\n          }\n          \n          processedCallbacks.add(nodeId);\n          \n          // Create callback handler for this node that can handle multiple buttons AND multi-select \"done\" button\n          const safeFunctionName = nodeId.replace(/[^a-zA-Z0-9_]/g, '_');\n          const shortNodeIdForDone = nodeId.slice(-10).replace(/^_+/, ''); // Такой же как в генерации кнопки\n          code += `\\n@dp.callback_query(lambda c: c.data == \"${nodeId}\" or c.data.startswith(\"${nodeId}_btn_\") or c.data == \"done_${shortNodeIdForDone}\")\\n`;\n          code += `async def handle_callback_${safeFunctionName}(callback_query: types.CallbackQuery):\\n`;\n          code += '    await callback_query.answer()\\n';\n          code += '    user_id = callback_query.from_user.id\\n';\n          code += '    callback_data = callback_query.data\\n';\n          code += '    \\n';\n          \n          // Добавляем обработку кнопки \"Готово\" для множественного выбора\n          if (targetNode.data.allowMultipleSelection) {\n            code += '    # Проверяем, является ли это кнопкой \"Готово\"\\n';\n            code += `    if callback_data == \"done_${shortNodeIdForDone}\":\\n`;\n            code += '        logging.info(f\"🏁 Обработка кнопки Готово для множественного выбора: {callback_data}\")\\n';\n            code += '        \\n';\n            \n            // Сохраняем выбранные значения в базу данных\n            const multiSelectVariable = targetNode.data.multiSelectVariable || 'user_interests';\n            code += '        # Сохраняем выбранные значения в базу данных\\n';\n            code += `        selected_options = user_data.get(user_id, {}).get(\"multi_select_${nodeId}\", [])\\n`;\n            code += '        if selected_options:\\n';\n            code += '            selected_text = \", \".join(selected_options)\\n';\n            code += `            \\n`;\n            code += `            # Универсальная логика аккумуляции для всех множественных выборов\\n`;\n            code += `            # Загружаем существующие значения\\n`;\n            code += `            existing_data = await get_user_data_from_db(user_id, \"${multiSelectVariable}\")\\n`;\n            code += `            existing_selections = []\\n`;\n            code += `            if existing_data and existing_data.strip():\\n`;\n            code += `                existing_selections = [s.strip() for s in existing_data.split(\",\") if s.strip()]\\n`;\n            code += `            \\n`;\n            code += `            # Объединяем существующие и новые выборы (убираем дубли)\\n`;\n            code += `            all_selections = list(set(existing_selections + selected_options))\\n`;\n            code += `            final_text = \", \".join(all_selections)\\n`;\n            code += `            await update_user_data_in_db(user_id, \"${multiSelectVariable}\", final_text)\\n`;\n            code += `            logging.info(f\"✅ Аккумулировано в переменную ${multiSelectVariable}: {final_text}\")\\n`;\n            code += '        \\n';\n            \n            // Очищаем состояние множественного выбора\n            code += '        # Очищаем состояние множественного выбора\\n';\n            code += '        if user_id in user_data:\\n';\n            code += `            user_data[user_id].pop(\"multi_select_${nodeId}\", None)\\n`;\n            code += '            user_data[user_id].pop(\"multi_select_node\", None)\\n';\n            code += '            user_data[user_id].pop(\"multi_select_type\", None)\\n';\n            code += '            user_data[user_id].pop(\"multi_select_variable\", None)\\n';\n            code += '        \\n';\n            \n            // Переход к следующему узлу\n            if (targetNode.data.continueButtonTarget) {\n              const nextNodeId = targetNode.data.continueButtonTarget;\n              code += '        # Переход к следующему узлу\\n';\n              code += `        next_node_id = \"${nextNodeId}\"\\n`;\n              code += '        try:\\n';\n              code += `            await handle_callback_${nextNodeId.replace(/[^a-zA-Z0-9_]/g, '_')}(callback_query)\\n`;\n              code += '        except Exception as e:\\n';\n              code += '            logging.error(f\"Ошибка при переходе к следующему узлу {next_node_id}: {e}\")\\n';\n              code += `            await callback_query.message.edit_text(\"Переход завершен\")\\n`;\n            } else {\n              code += '        # Завершение множественного выбора\\n';\n              code += `        await safe_edit_or_send(callback_query, \"✅ Выбор завершен!\")\\n`;\n            }\n            code += '        return\\n';\n            code += '    \\n';\n          }\n          \n          // Обычная обработка узлов без специальной логики\n          \n          // Определяем переменную для сохранения на основе родительского узла  \n          if (targetNode && targetNode.data.inputVariable) {\n            const variableName = targetNode.data.inputVariable;\n            const variableValue = 'callback_query.data';\n            \n            code += '    # Сохраняем правильную переменную в базу данных\\n';\n            code += `    await update_user_data_in_db(user_id, \"${variableName}\", ${variableValue})\\n`;\n            code += `    logging.info(f\"Переменная ${variableName} сохранена: \" + str(${variableValue}) + f\" (пользователь {user_id})\")\\n`;\n            code += '    \\n';\n          }\n          \n          code += `    # Обрабатываем узел ${nodeId}: ${nodeId}\\n`;\n          const messageText = targetNode.data.messageText || \"Сообщение не задано\";\n          const formattedText = formatTextForPython(messageText);\n          code += `    text = ${formattedText}\\n`;\n          code += '    \\n';\n          code += generateUniversalVariableReplacement('    ');\n          \n          // ИСПРАВЛЕНИЕ: Добавляем специальную обработку для узлов с множественным выбором\n          // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Все узлы с кнопками selection обрабатываются как множественный выбор\n          const hasSelectionButtons = targetNode.data.buttons && targetNode.data.buttons.some(btn => btn.action === 'selection');\n          if (targetNode.data.allowMultipleSelection || hasSelectionButtons) {\n            // Узел с множественным выбором - создаем специальную клавиатуру\n            console.log(`🎯 ГЕНЕРАТОР: ========================================`);\n            const reason = hasSelectionButtons ? 'ИМЕЕТ КНОПКИ SELECTION' : 'ИМЕЕТ allowMultipleSelection=true';\n            console.log(`🎯 ГЕНЕРАТОР: УЗЕЛ ${nodeId} ${reason}`);\n            console.log(`🎯 ГЕНЕРАТОР: ЭТО ПРАВИЛЬНЫЙ ПУТЬ ВЫПОЛНЕНИЯ!`);\n            console.log(`🔘 ГЕНЕРАТОР: Кнопки узла ${nodeId}:`, targetNode.data.buttons?.map(b => `${b.text} (action: ${b.action})`)?.join(', ') || 'НЕТ КНОПОК');\n            console.log(`🔧 ГЕНЕРАТОР: continueButtonTarget для ${nodeId}: ${targetNode.data.continueButtonTarget}`);\n            console.log(`🔧 ГЕНЕРАТОР: multiSelectVariable для ${nodeId}: ${targetNode.data.multiSelectVariable}`);\n            console.log(`🔧 ГЕНЕРАТОР: hasSelectionButtons: ${hasSelectionButtons}`);\n            console.log(`🎯 ГЕНЕРАТОР: ========================================`);\n            \n            // Добавляем логику инициализации множественного выбора\n            const multiSelectVariable = targetNode.data.multiSelectVariable || 'user_interests';\n            \n            code += '    # Инициализация состояния множественного выбора\\n';\n            code += '    if user_id not in user_data:\\n';\n            code += '        user_data[user_id] = {}\\n';\n            code += '    \\n';\n            code += '    # Загружаем ранее выбранные варианты\\n';\n            code += '    saved_selections = []\\n';\n            code += '    if user_vars:\\n';\n            code += `        for var_name, var_data in user_vars.items():\\n`;\n            code += `            if var_name == \"${multiSelectVariable}\":\\n`;\n            code += '                if isinstance(var_data, dict) and \"value\" in var_data:\\n';\n            code += '                    selections_str = var_data[\"value\"]\\n';\n            code += '                elif isinstance(var_data, str):\\n';\n            code += '                    selections_str = var_data\\n';\n            code += '                else:\\n';\n            code += '                    continue\\n';\n            code += '                if selections_str and selections_str.strip():\\n';\n            code += '                    saved_selections = [sel.strip() for sel in selections_str.split(\",\") if sel.strip()]\\n';\n            code += '                    break\\n';\n            code += '    \\n';\n            code += '    # Инициализируем состояние если его нет\\n';\n            code += `    if \"multi_select_${nodeId}\" not in user_data[user_id]:\\n`;\n            code += `        user_data[user_id][\"multi_select_${nodeId}\"] = saved_selections.copy()\\n`;\n            code += `    user_data[user_id][\"multi_select_node\"] = \"${nodeId}\"\\n`;\n            code += `    user_data[user_id][\"multi_select_type\"] = \"inline\"\\n`;\n            code += `    user_data[user_id][\"multi_select_variable\"] = \"${multiSelectVariable}\"\\n`;\n            code += '    logging.info(f\"Инициализировано состояние множественного выбора с {len(saved_selections)} элементами\")\\n';\n            code += '    \\n';\n            \n            // Создаем inline клавиатуру с кнопками выбора\n            code += '    # Создаем inline клавиатуру с поддержкой множественного выбора\\n';\n            code += '    builder = InlineKeyboardBuilder()\\n';\n            \n            // Разделяем кнопки на опции выбора и обычные кнопки\n            console.log(`🔧 ГЕНЕРАТОР: targetNode.data.buttons:`, targetNode.data.buttons);\n            \n            let buttonsToUse = targetNode.data.buttons || [];\n            \n            const selectionButtons = buttonsToUse.filter(button => button.action === 'selection');\n            const regularButtons = buttonsToUse.filter(button => button.action !== 'selection');\n            console.log(`🔧 ГЕНЕРАТОР: Найдено ${selectionButtons.length} кнопок выбора и ${regularButtons.length} обычных кнопок`);\n            \n            // Добавляем кнопки выбора с отметками о состоянии\n            console.log(`🔧 ГЕНЕРАТОР: Создаем ${selectionButtons.length} кнопок выбора для узла ${nodeId}`);\n            selectionButtons.forEach((button, index) => {\n              // Используем короткие callback_data\n              const shortNodeId = generateUniqueShortId(nodeId, allNodeIds || []); // Используем новую функцию\n              const shortTarget = (button.target || button.id || 'btn').slice(-8);\n              const callbackData = `ms_${shortNodeId}_${shortTarget}`;\n              console.log(`🔧 ГЕНЕРАТОР: ИСПРАВЛЕНО! Кнопка ${index + 1}: \"${button.text}\" -> ${callbackData} (shortNodeId: ${shortNodeId}) (длина: ${callbackData.length})`);\n              code += `    # Кнопка выбора ${index + 1}: ${button.text}\\n`;\n              code += `    logging.info(f\"🔘 Создаем кнопку: ${button.text} -> ${callbackData}\")\\n`;\n              code += `    selected_mark = \"✅ \" if \"${button.text}\" in user_data[user_id][\"multi_select_${nodeId}\"] else \"\"\\n`;\n              code += `    builder.add(InlineKeyboardButton(text=f\"{selected_mark}${button.text}\", callback_data=\"${callbackData}\"))\\n`;\n            });\n            \n            // Добавляем кнопку \"Готово\" для множественного выбора\n            console.log(`🔧 ГЕНЕРАТОР: НАЧИНАЕМ создание кнопки \"Готово\" для узла ${nodeId}`);\n            console.log(`🔧 ГЕНЕРАТОР: allowMultipleSelection = ${targetNode.data.allowMultipleSelection}`);\n            console.log(`🔧 ГЕНЕРАТОР: continueButtonTarget = ${targetNode.data.continueButtonTarget}`);\n            console.log(`🔧 ГЕНЕРАТОР: selectionButtons.length = ${selectionButtons.length}`);\n            \n            // ВСЕГДА добавляем кнопку \"Готово\" если есть кнопки выбора\n            if (selectionButtons.length > 0) {\n              console.log(`🔧 ГЕНЕРАТОР: ✅ ДОБАВЛЯЕМ кнопку \"Готово\" (есть ${selectionButtons.length} кнопок выбора)`);\n              code += '    # Кнопка \"Готово\" для множественного выбора\\n';\n              const shortNodeIdDone = nodeId.slice(-10).replace(/^_+/, ''); // Убираем ведущие underscores\n              const doneCallbackData = `done_${shortNodeIdDone}`;\n              console.log(`🔧 ГЕНЕРАТОР: Кнопка \"Готово\" -> ${doneCallbackData} (длина: ${doneCallbackData.length})`);\n              console.log(`🔧 ГЕНЕРАТОР: ГЕНЕРИРУЕМ код кнопки \"Готово\"!`);\n              \n              code += `    logging.info(f\"🔘 Создаем кнопку Готово -> ${doneCallbackData}\")\\n`;\n              code += `    builder.add(InlineKeyboardButton(text=\"Готово\", callback_data=\"${doneCallbackData}\"))\\n`;\n              \n              console.log(`🔧 ГЕНЕРАТОР: ✅ УСПЕШНО добавили кнопку \"Готово\" в код генерации`);\n            } else {\n              console.log(`🔧 ГЕНЕРАТОР: ❌ НЕ добавляем кнопку \"Готово\" - нет кнопок выбора`);\n            }  \n            \n            // Добавляем обычные кнопки (navigation и другие)\n            regularButtons.forEach((btn, index) => {\n              if (btn.action === \"goto\" && btn.target) {\n                const btnCallbackData = `${btn.target}_btn_${index}`;\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${btnCallbackData}\"))\\n`;\n              } else if (btn.action === \"url\") {\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n              } else if (btn.action === \"command\" && btn.target) {\n                const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n              }\n            });\n            \n            // Автоматическое распределение колонок для множественного выбора\n            const totalButtons = selectionButtons.length + (targetNode.data.continueButtonTarget ? 1 : 0) + regularButtons.length;\n            // Для множественного выбора всегда используем nodeData с включенным флагом\n            const multiSelectNodeData = { ...targetNode.data, allowMultipleSelection: true };\n            const columns = calculateOptimalColumns(selectionButtons, multiSelectNodeData);\n            code += `    builder.adjust(${columns})\\n`;\n            code += '    keyboard = builder.as_markup()\\n';\n            \n          } else if (targetNode.data.buttons && targetNode.data.buttons.length > 0) {\n            // Обычные кнопки без множественного выбора\n            code += '    # Create inline keyboard\\n';\n            code += '    builder = InlineKeyboardBuilder()\\n';\n            targetNode.data.buttons.forEach((btn, index) => {\n              if (btn.action === \"goto\" && btn.target) {\n                const btnCallbackData = `${btn.target}_btn_${index}`;\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${btnCallbackData}\"))\\n`;\n              } else if (btn.action === \"url\") {\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n              } else if (btn.action === \"command\" && btn.target) {\n                // ИСПРАВЛЕНИЕ: Добавляем поддержку кнопок команд\n                const commandCallback = `cmd_${btn.target.replace('/', '')}`;\n                code += `    # Кнопка команды: ${btn.text} -> ${btn.target}\\n`;\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${commandCallback}\"))\\n`;\n              } else if (btn.action === \"selection\") {\n                // Добавляем поддержку кнопок выбора для обычных узлов\n                const callbackData = `multi_select_${nodeId}_${btn.target || btn.id}`;\n                code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n              }\n            });\n            code += '    keyboard = builder.as_markup()\\n';\n          } else {\n            code += '    keyboard = None\\n';\n          }\n          \n          // Send message with keyboard\n          code += '    # Отправляем сообщение\\n';\n          code += '    try:\\n';\n          code += '        if keyboard:\\n';\n          code += '            await safe_edit_or_send(callback_query, text, reply_markup=keyboard)\\n';\n          code += '        else:\\n';\n          code += '            await callback_query.message.edit_text(text)\\n';\n          code += '    except Exception:\\n';\n          code += '        if keyboard:\\n';\n          code += '            await callback_query.message.answer(text, reply_markup=keyboard)\\n';\n          code += '        else:\\n';\n          code += '            await callback_query.message.answer(text)\\n';\n          \n          // Сохраняем нажатие кнопки в базу данных\n          code += '    # Сохраняем нажатие кнопки в базу данных\\n';\n          code += '    user_id = callback_query.from_user.id\\n';\n          code += '    \\n';\n          code += '    # Ищем текст кнопки по callback_data\\n';\n          // Генерируем код для поиска текста кнопки\n          const sourceNode = nodes.find(n => \n            n.data.buttons && n.data.buttons.some(btn => btn.target === nodeId)\n          );\n          \n          // Если к узлу ведут несколько кнопок, нужно определить, какую именно нажали\n          let buttonsToTargetNode = [];\n          if (sourceNode) {\n            buttonsToTargetNode = sourceNode.data.buttons.filter(btn => btn.target === nodeId);\n          }\n          \n          if (buttonsToTargetNode.length > 1) {\n            // Несколько кнопок ведут к одному узлу - создаем логику определения по callback_data\n            code += `    # Определяем текст кнопки по callback_data\\n`;\n            code += `    button_display_text = \"Неизвестная кнопка\"\\n`;\n            buttonsToTargetNode.forEach((button, index) => {\n              // Проверяем по суффиксу _btn_index в callback_data\n              code += `    if callback_query.data.endswith(\"_btn_${index}\"):\\n`;\n              code += `        button_display_text = \"${button.text}\"\\n`;\n            });\n            \n            // ДОПОЛНИТЕЛЬНАЯ ПРОВЕРКА: ищем кнопку по точному соответствию callback_data с nodeId\n            code += `    # Дополнительная проверка по точному соответствию callback_data\\n`;\n            buttonsToTargetNode.forEach((button) => {\n              code += `    if callback_query.data == \"${nodeId}\":\\n`;\n              // Для случая когда несколько кнопок ведут к одному узлу, используем первую найденную\n              code += `        button_display_text = \"${button.text}\"\\n`;\n            });\n          } else if (sourceNode) {\n            const button = sourceNode.data.buttons.find(btn => btn.target === nodeId);\n            if (button) {\n              code += `    button_display_text = \"${button.text}\"\\n`;\n            } else {\n              code += `    button_display_text = \"Кнопка ${nodeId}\"\\n`;\n            }\n          } else {\n            code += `    button_display_text = \"Кнопка ${nodeId}\"\\n`;\n          }\n          code += '    \\n';\n          code += '    # Сохраняем ответ в базу данных\\n';\n\n          code += '    timestamp = get_moscow_time()\\n';\n          code += '    \\n';\n          code += '    response_data = button_display_text  # Простое значение\\n';\n          code += '    \\n';\n          code += '    # Сохраняем в пользовательские данные\\n';\n          code += '    if user_id not in user_data:\\n';\n          code += '        user_data[user_id] = {}\\n';\n          code += '    user_data[user_id][\"button_click\"] = button_display_text\\n';\n          code += '    \\n';\n          // Определяем переменную для сохранения на основе кнопки\n          const parentNode = nodes.find(n => \n            n.data.buttons && n.data.buttons.some(btn => btn.target === nodeId)\n          );\n          \n          let variableName = 'button_click';\n          let variableValue = 'button_display_text';\n          \n          // КРИТИЧЕСКИ ВАЖНО: специальная логика для шаблона \"Федя\"\n          if (nodeId === 'source_search') {\n            variableName = 'источник';\n            variableValue = '\"🔍 Поиск в интернете\"';\n          } else if (nodeId === 'source_friends') {\n            variableName = 'источник';\n            variableValue = '\"👥 Друзья\"';\n          } else if (nodeId === 'source_ads') {\n            variableName = 'источник';\n            variableValue = '\"📱 Реклама\"';\n          } else if (parentNode && parentNode.data.inputVariable) {\n            variableName = parentNode.data.inputVariable;\n            \n            // Ищем конкретную кнопку и её значение\n            const button = parentNode.data.buttons.find(btn => btn.target === nodeId);\n            if (button) {\n              // Определяем значение переменной в зависимости от кнопки\n              if (button.id === 'btn_search' || nodeId === 'source_search') {\n                variableValue = '\"из инета\"';\n              } else if (button.id === 'btn_friends' || nodeId === 'source_friends') {\n                variableValue = '\"friends\"';\n              } else if (button.id === 'btn_ads' || nodeId === 'source_ads') {\n                variableValue = '\"ads\"';\n              } else if (variableName === 'пол') {\n                // Специальная логика для переменной \"пол\"\n                if (button.text === 'Мужчина' || button.text === '👨 Мужчина') {\n                  variableValue = '\"Мужчина\"';\n                } else if (button.text === 'Женщина' || button.text === '👩 Женщина') {\n                  variableValue = '\"Женщина\"';\n                } else {\n                  variableValue = `\"${button.text}\"`;\n                }\n              } else {\n                variableValue = 'button_display_text';\n              }\n            }\n          }\n          \n          code += '    # Сохраняем в базу данных с правильным именем переменной\\n';\n          code += `    await update_user_data_in_db(user_id, \"${variableName}\", ${variableValue})\\n`;\n          code += `    logging.info(f\"Переменная ${variableName} сохранена: \" + str(${variableValue}) + f\" (пользователь {user_id})\")\\n`;\n          code += '    \\n';\n          \n          // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Для узлов с множественным выбором НЕ делаем автоматической переадресации\n          const currentNode = nodes.find(n => n.id === nodeId);\n          \n          // Для узлов с множественным выбором - НЕ делаем автоматический переход при первичном заходе в узел\n          const shouldRedirect = !(currentNode && currentNode.data.allowMultipleSelection);\n          console.log(`🔧 ГЕНЕРАТОР КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Узел ${nodeId} allowMultipleSelection: ${currentNode?.data.allowMultipleSelection}, shouldRedirect: ${shouldRedirect}`);\n          \n          let redirectTarget = nodeId; // По умолчанию остаемся в том же узле\n          \n          if (shouldRedirect) {\n            if (currentNode && currentNode.data.continueButtonTarget) {\n              // Для обычных узлов используем continueButtonTarget если есть\n              redirectTarget = currentNode.data.continueButtonTarget;\n              console.log(`🔧 ГЕНЕРАТОР REDIRECTTARGET: Узел ${nodeId} переходит к continueButtonTarget ${redirectTarget}`);\n            } else {\n              // Для обычных узлов ищем следующий узел через соединения\n              const nodeConnections = connections.filter(conn => conn.source === nodeId);\n              if (nodeConnections.length > 0) {\n                redirectTarget = nodeConnections[0].target;\n                console.log(`🔧 ГЕНЕРАТОР REDIRECTTARGET: Узел ${nodeId} переходит через соединение к ${redirectTarget}`);\n              } else {\n                console.log(`🔧 ГЕНЕРАТОР REDIRECTTARGET: Узел ${nodeId} остается в том же узле (нет соединений)`);\n              }\n            }\n          } else {\n            console.log(`🔧 ГЕНЕРАТОР: Узел ${nodeId} с множественным выбором - НЕ делаем автоматическую переадресацию`);\n          }\n          \n          if (shouldRedirect && redirectTarget) {\n            code += '    # ПЕРЕАДРЕСАЦИЯ: Переходим к следующему узлу после сохранения данных\\n';\n            code += `    next_node_id = \"${redirectTarget}\"\\n`;\n            code += '    try:\\n';\n            code += '        logging.info(f\"🚀 Переходим к следующему узлу после выбора кнопки: {next_node_id}\")\\n';\n            \n            // Добавляем навигацию для каждого узла\n            if (nodes.length > 0) {\n              nodes.forEach((navTargetNode, index) => {\n                const condition = index === 0 ? 'if' : 'elif';\n                code += `        ${condition} next_node_id == \"${navTargetNode.id}\":\\n`;\n                \n                if (navTargetNode.type === 'message') {\n                  // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверяем, имеет ли узел множественный выбор\n                  if (navTargetNode.data.allowMultipleSelection === true) {\n                    // Для узлов с множественным выбором вызываем полноценный обработчик\n                    const safeFunctionName = navTargetNode.id.replace(/[^a-zA-Z0-9_]/g, '_');\n                    code += `            # Узел с множественным выбором - вызываем полноценный обработчик\\n`;\n                    code += `            logging.info(f\"🔧 Callback навигация к узлу с множественным выбором: ${navTargetNode.id}\")\\n`;\n                    code += `            await handle_callback_${safeFunctionName}(callback_query)\\n`;\n                  } else {\n                    const messageText = navTargetNode.data.messageText || 'Сообщение';\n                    const formattedText = formatTextForPython(messageText);\n                    code += `            nav_text = ${formattedText}\\n`;\n                    \n                    // Проверяем, есть ли reply кнопки\n                    if (navTargetNode.data.keyboardType === 'reply' && navTargetNode.data.buttons && navTargetNode.data.buttons.length > 0) {\n                      code += '            # Удаляем старое сообщение и отправляем новое с reply клавиатурой\\n';\n                      code += '            await callback_query.message.delete()\\n';\n                      code += '            builder = ReplyKeyboardBuilder()\\n';\n                      navTargetNode.data.buttons.forEach((button: any) => {\n                        if (button.action === \"contact\" && button.requestContact) {\n                          code += `            builder.add(KeyboardButton(text=${generateButtonText(button.text)}, request_contact=True))\\n`;\n                        } else if (button.action === \"location\" && button.requestLocation) {\n                          code += `            builder.add(KeyboardButton(text=${generateButtonText(button.text)}, request_location=True))\\n`;\n                        } else {\n                          code += `            builder.add(KeyboardButton(text=${generateButtonText(button.text)}))\\n`;\n                        }\n                      });\n                      const resizeKeyboard = toPythonBoolean(navTargetNode.data.resizeKeyboard);\n                      const oneTimeKeyboard = toPythonBoolean(navTargetNode.data.oneTimeKeyboard);\n                      code += `            keyboard = builder.as_markup(resize_keyboard=${resizeKeyboard}, one_time_keyboard=${oneTimeKeyboard})\\n`;\n                      code += '            await bot.send_message(callback_query.from_user.id, nav_text, reply_markup=keyboard)\\n';\n                    } else {\n                      code += '            await callback_query.message.edit_text(nav_text)\\n';\n                    }\n                  }\n                  \n                  // Если узел message собирает ввод, настраиваем ожидание\n                  if (navTargetNode.data.collectUserInput === true) {\n                    const inputType = navTargetNode.data.inputType || 'text';\n                    // ИСПРАВЛЕНИЕ: Берем inputVariable именно из целевого узла, а не из родительского\n                    const inputVariable = navTargetNode.data.inputVariable || `response_${navTargetNode.id}`;\n                    const inputTargetNodeId = navTargetNode.data.inputTargetNodeId;\n                    \n                    code += '            # ИСПРАВЛЕНИЕ: Проверяем, не была ли переменная уже сохранена inline кнопкой\\n';\n                    code += '            user_id = callback_query.from_user.id\\n';\n                    code += '            if user_id not in user_data:\\n';\n                    code += '                user_data[user_id] = {}\\n';\n                    code += `            # Проверяем, не была ли переменная ${inputVariable} уже сохранена\\n`;\n                    code += `            if \"${inputVariable}\" not in user_data[user_id] or not user_data[user_id][\"${inputVariable}\"]:\\n`;\n                    code += '                # Переменная не сохранена - используем универсальную функцию для настройки ожидания ввода\\n';\n                    // ИСПРАВЛЕНИЕ: Используем generateWaitingStateCode вместо встроенной генерации\n                    code += generateWaitingStateCode(navTargetNode, '                ').split('\\n').map(line => line ? '            ' + line : '').join('\\n');\n                    code += '            else:\\n';\n                    code += `                logging.info(f\"⏭️ Переменная ${inputVariable} уже сохранена, пропускаем ожидание ввода\")\\n`;\n                  }\n                } else if (navTargetNode.type === 'command') {\n                  // Для узлов команд вызываем соответствующий обработчик\n                  const commandName = navTargetNode.data.command?.replace('/', '') || 'unknown';\n                  const handlerName = `${commandName}_handler`;\n                  code += `            # Выполняем команду ${navTargetNode.data.command}\\n`;\n                  code += '            from types import SimpleNamespace\\n';\n                  code += '            fake_message = SimpleNamespace()\\n';\n                  code += '            fake_message.from_user = callback_query.from_user\\n';\n                  code += '            fake_message.chat = callback_query.message.chat\\n';\n                  code += '            fake_message.date = callback_query.message.date\\n';\n                  code += '            fake_message.answer = callback_query.message.answer\\n';\n                  code += `            await ${handlerName}(fake_message)\\n`;\n                } else if (navTargetNode.type === 'keyboard' && (navTargetNode.data.enableTextInput || \n                                                                  navTargetNode.data.enablePhotoInput || \n                                                                  navTargetNode.data.enableVideoInput || \n                                                                  navTargetNode.data.enableAudioInput || \n                                                                  navTargetNode.data.enableDocumentInput)) {\n                  // Обрабатываем узлы ввода текста/медиа с поддержкой условных сообщений\n                  const messageText = navTargetNode.data.messageText || 'Введите ваш ответ:';\n                  const inputVariable = navTargetNode.data.inputVariable || `response_${navTargetNode.id}`;\n                  const inputTargetNodeId = navTargetNode.data.inputTargetNodeId || '';\n                  \n                  // Проверяем, есть ли условные сообщения для этого узла\n                  const hasConditionalMessages = navTargetNode.data.enableConditionalMessages && \n                                                navTargetNode.data.conditionalMessages && \n                                                navTargetNode.data.conditionalMessages.length > 0;\n                  \n                  if (hasConditionalMessages) {\n                    // Если есть условные сообщения, генерируем их обработку\n                    code += '            await callback_query.message.delete()\\n';\n                    code += '            # Узел с условными сообщениями - проверяем условия\\n';\n                    code += '            user_id = callback_query.from_user.id\\n';\n                    code += '            user_data_dict = await get_user_from_db(user_id) or {}\\n';\n                    code += '            user_data_dict.update(user_data.get(user_id, {}))\\n\\n';\n                    \n                    // Добавляем определение функции check_user_variable в локальную область видимости\n                    code += '            # Функция для проверки переменных пользователя\\n';\n                    code += '            def check_user_variable(var_name, user_data_dict):\\n';\n                    code += '                \"\"\"Проверяет существование и получает значение переменной пользователя\"\"\"\\n';\n                    code += '                # Сначала проверяем в поле user_data (из БД)\\n';\n                    code += '                if \"user_data\" in user_data_dict and user_data_dict[\"user_data\"]:\\n';\n                    code += '                    try:\\n';\n                    code += '                        import json\\n';\n                    code += '                        parsed_data = json.loads(user_data_dict[\"user_data\"]) if isinstance(user_data_dict[\"user_data\"], str) else user_data_dict[\"user_data\"]\\n';\n                    code += '                        if var_name in parsed_data:\\n';\n                    code += '                            raw_value = parsed_data[var_name]\\n';\n                    code += '                            if isinstance(raw_value, dict) and \"value\" in raw_value:\\n';\n                    code += '                                var_value = raw_value[\"value\"]\\n';\n                    code += '                                # Проверяем, что значение действительно существует и не пустое\\n';\n                    code += '                                if var_value is not None and str(var_value).strip() != \"\":\\n';\n                    code += '                                    return True, str(var_value)\\n';\n                    code += '                            else:\\n';\n                    code += '                                # Проверяем, что значение действительно существует и не пустое\\n';\n                    code += '                                if raw_value is not None and str(raw_value).strip() != \"\":\\n';\n                    code += '                                    return True, str(raw_value)\\n';\n                    code += '                    except (json.JSONDecodeError, TypeError):\\n';\n                    code += '                        pass\\n';\n                    code += '                \\n';\n                    code += '                # Проверяем в локальных данных (без вложенности user_data)\\n';\n                    code += '                if var_name in user_data_dict:\\n';\n                    code += '                    variable_data = user_data_dict.get(var_name)\\n';\n                    code += '                    if isinstance(variable_data, dict) and \"value\" in variable_data:\\n';\n                    code += '                        var_value = variable_data[\"value\"]\\n';\n                    code += '                        # Проверяем, что значение действительно существует и не пустое\\n';\n                    code += '                        if var_value is not None and str(var_value).strip() != \"\":\\n';\n                    code += '                            return True, str(var_value)\\n';\n                    code += '                    elif variable_data is not None and str(variable_data).strip() != \"\":\\n';\n                    code += '                        return True, str(variable_data)\\n';\n                    code += '                \\n';\n                    code += '                return False, None\\n\\n';\n                    \n                    // Генерируем условную логику для этого узла\n                    const conditionalMessages = navTargetNode.data.conditionalMessages.sort((a, b) => (b.priority || 0) - (a.priority || 0));\n                    \n                    // Создаем единую if/elif/else структуру для всех условий\n                    for (let i = 0; i < conditionalMessages.length; i++) {\n                      const condition = conditionalMessages[i];\n                      const cleanedConditionText = stripHtmlTags(condition.messageText);\n                      const conditionText = formatTextForPython(cleanedConditionText);\n                      const conditionKeyword = i === 0 ? 'if' : 'elif';\n                      \n                      // Get variable names - support both new array format and legacy single variable\n                      const variableNames = condition.variableNames && condition.variableNames.length > 0 \n                        ? condition.variableNames \n                        : (condition.variableName ? [condition.variableName] : []);\n                      \n                      const logicOperator = condition.logicOperator || 'AND';\n                      \n                      code += `            # Условие ${i + 1}: ${condition.condition} для переменных: ${variableNames.join(', ')}\\n`;\n                      \n                      if (condition.condition === 'user_data_exists' && variableNames.length > 0) {\n                        // Создаем единый блок условия с проверками ВНУТРИ\n                        code += `            ${conditionKeyword} (\\n`;\n                        for (let j = 0; j < variableNames.length; j++) {\n                          const varName = variableNames[j];\n                          const operator = (j === variableNames.length - 1) ? '' : (logicOperator === 'AND' ? ' and' : ' or');\n                          code += `                check_user_variable(\"${varName}\", user_data_dict)[0]${operator}\\n`;\n                        }\n                        code += `            ):\\n`;\n                        \n                        // Внутри блока условия собираем значения переменных\n                        code += `                # Собираем значения переменных\\n`;\n                        code += `                variable_values = {}\\n`;\n                        for (const varName of variableNames) {\n                          code += `                _, variable_values[\"${varName}\"] = check_user_variable(\"${varName}\", user_data_dict)\\n`;\n                        }\n                        \n                        code += `                text = ${conditionText}\\n`;\n                        \n                        // Заменяем переменные в тексте\n                        for (const varName of variableNames) {\n                          code += `                if \"{${varName}}\" in text and variable_values[\"${varName}\"] is not None:\\n`;\n                          code += `                    text = text.replace(\"{${varName}}\", variable_values[\"${varName}\"])\\n`;\n                        }\n                        \n                        // Генерируем клавиатуру для условного сообщения если она есть\n                        if (condition.keyboardType && condition.keyboardType !== 'none' && condition.buttons && condition.buttons.length > 0) {\n                          code += '                # Создаем клавиатуру для условного сообщения\\n';\n                          \n                          if (condition.keyboardType === 'inline') {\n                            code += '                builder = InlineKeyboardBuilder()\\n';\n                            condition.buttons.forEach((button: any) => {\n                              if (button.action === \"url\") {\n                                code += `                builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, url=\"${button.url || '#'}\"))\\n`;\n                              } else if (button.action === 'goto') {\n                                const callbackData = button.target || button.id || 'no_action';\n                                code += `                builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${callbackData}\"))\\n`;\n                              } else if (button.action === 'command') {\n                                // Для кнопок команд создаем специальную callback_data\n                                const commandCallback = `cmd_${button.target ? button.target.replace('/', '') : 'unknown'}`;\n                                code += `                builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${commandCallback}\"))\\n`;\n                              } else {\n                                const callbackData = button.target || button.id || 'no_action';\n                                code += `                builder.add(InlineKeyboardButton(text=${generateButtonText(button.text)}, callback_data=\"${callbackData}\"))\\n`;\n                              }\n                            });\n                            code += '                conditional_keyboard = builder.as_markup()\\n';\n                            code += '                await bot.send_message(user_id, text, reply_markup=conditional_keyboard)\\n';\n                          } else if (condition.keyboardType === 'reply') {\n                            code += '                builder = ReplyKeyboardBuilder()\\n';\n                            condition.buttons.forEach((button: any) => {\n                              if (button.action === \"contact\" && button.requestContact) {\n                                code += `                builder.add(KeyboardButton(text=${generateButtonText(button.text)}, request_contact=True))\\n`;\n                              } else if (button.action === \"location\" && button.requestLocation) {\n                                code += `                builder.add(KeyboardButton(text=${generateButtonText(button.text)}, request_location=True))\\n`;\n                              } else {\n                                code += `                builder.add(KeyboardButton(text=${generateButtonText(button.text)}))\\n`;\n                              }\n                            });\n                            code += '                conditional_keyboard = builder.as_markup(resize_keyboard=True, one_time_keyboard=False)\\n';\n                            code += '                await bot.send_message(user_id, text, reply_markup=conditional_keyboard)\\n';\n                          }\n                        } else {\n                          // Нет клавиатуры - отправляем только текст\n                          code += '                await bot.send_message(user_id, text)\\n';\n                        }\n                        \n                        // Настраиваем ожидание текстового ввода для условного сообщения (если нужно)\n                        if (condition.waitForTextInput) {\n                          // ИСПРАВЛЕНИЕ: Используем переменную из условия или из целевого узла\n                          const conditionalInputVariable = condition.textInputVariable || navTargetNode.data.inputVariable || `response_${navTargetNode.id}`;\n                          code += `                # Настраиваем ожидание текстового ввода для условного сообщения\\n`;\n                          code += `                user_data[user_id][\"waiting_for_input\"] = {\\n`;\n                          code += `                    \"type\": \"text\",\\n`;\n                          code += `                    \"variable\": \"${conditionalInputVariable}\",\\n`;\n                          code += `                    \"save_to_database\": True,\\n`;\n                          code += `                    \"node_id\": \"${navTargetNode.id}\",\\n`;\n                          code += `                    \"next_node_id\": \"${condition.nextNodeAfterInput || inputTargetNodeId}\"\\n`;\n                          code += `                }\\n`;\n                          code += `                logging.info(f\"🔧 Настроено условное ожидание ввода для переменной: ${conditionalInputVariable} (узел ${navTargetNode.id})\")\\n`;\n                        }\n                      }\n                    }\n                    \n                    // Fallback сообщение\n                    code += `            else:\\n`;\n                    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверяем, имеет ли узел множественный выбор\n                    if (navTargetNode.data.allowMultipleSelection === true) {\n                      // Для узлов с множественным выбором создаем прямую навигацию\n                      const messageText = navTargetNode.data.messageText || 'Сообщение';\n                      const formattedText = formatTextForPython(messageText);\n                      code += `                # Прямая навигация к узлу с множественным выбором ${navTargetNode.id}\\n`;\n                      code += `                logging.info(f\"🔧 Fallback переход к узлу с множественным выбором: ${navTargetNode.id}\")\\n`;\n                      code += `                text = ${formattedText}\\n`;\n                      \n                      // Замена переменных\n                      code += '                user_data[user_id] = user_data.get(user_id, {})\\n';\n                      code += generateUniversalVariableReplacement('                ');\n                      \n                      // Инициализируем состояние множественного выбора\n                      code += `                # Инициализируем состояние множественного выбора\\n`;\n                      code += `                user_data[user_id][\"multi_select_${navTargetNode.id}\"] = []\\n`;\n                      code += `                user_data[user_id][\"multi_select_node\"] = \"${navTargetNode.id}\"\\n`;\n                      code += `                user_data[user_id][\"multi_select_type\"] = \"selection\"\\n`;\n                      if (navTargetNode.data.multiSelectVariable) {\n                        code += `                user_data[user_id][\"multi_select_variable\"] = \"${navTargetNode.data.multiSelectVariable}\"\\n`;\n                      }\n                      \n                      // Создаем inline клавиатуру с кнопками выбора\n                      if (navTargetNode.data.buttons && navTargetNode.data.buttons.length > 0) {\n                        code += generateInlineKeyboardCode(navTargetNode.data.buttons, '                ', navTargetNode.id, navTargetNode.data, allNodeIds);\n                        code += `                await bot.send_message(user_id, text, reply_markup=keyboard)\\n`;\n                      } else {\n                        code += `                await bot.send_message(user_id, text)\\n`;\n                      }\n                      code += `                logging.info(f\"✅ Прямая навигация к узлу множественного выбора ${navTargetNode.id} выполнена\")\\n`;\n                    } else {\n                      const formattedText = formatTextForPython(messageText);\n                      // ИСПРАВЛЕНИЕ: Используем переменную из целевого узла\n                      const fallbackInputVariable = navTargetNode.data.inputVariable || `response_${navTargetNode.id}`;\n                      code += `                # Fallback сообщение\\n`;\n                      code += `                nav_text = ${formattedText}\\n`;\n                      // ВАЖНО: Проверяем, включен ли сбор пользовательского ввода для этого узла\n                      if (navTargetNode.data.collectUserInput === true) {\n                      code += `                # ИСПРАВЛЕНИЕ: Проверяем, не была ли переменная уже сохранена inline кнопкой\\n`;\n                      code += `                if \"${fallbackInputVariable}\" not in user_data[user_id] or not user_data[user_id][\"${fallbackInputVariable}\"]:\\n`;\n                      code += `                    # Настраиваем ожидание ввода\\n`;\n                      code += `                    user_data[user_id][\"waiting_for_input\"] = {\\n`;\n                      code += `                        \"type\": \"text\",\\n`;\n                      code += `                        \"variable\": \"${fallbackInputVariable}\",\\n`;\n                      code += `                        \"save_to_database\": True,\\n`;\n                      code += `                        \"node_id\": \"${navTargetNode.id}\",\\n`;\n                      code += `                        \"next_node_id\": \"${inputTargetNodeId}\"\\n`;\n                      code += `                    }\\n`;\n                      code += `                    logging.info(f\"🔧 Настроено fallback ожидание ввода для переменной: ${fallbackInputVariable} (узел ${navTargetNode.id})\")\\n`;\n                      code += `                else:\\n`;\n                        code += `                    logging.info(f\"⏭️ Переменная ${fallbackInputVariable} уже сохранена, пропускаем fallback ожидание ввода\")\\n`;\n                      } else {\n                        code += `                logging.info(f\"Fallback переход к узлу ${navTargetNode.id} без сбора ввода\")\\n`;\n                      }\n                      code += `                await bot.send_message(user_id, nav_text)\\n`;\n                    }\n                  } else {\n                    // Обычный узел без условных сообщений\n                    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверяем, имеет ли узел множественный выбор\n                    if (navTargetNode.data.allowMultipleSelection === true) {\n                      // Для узлов с множественным выбором создаем прямую навигацию\n                      const messageText = navTargetNode.data.messageText || 'Сообщение';\n                      const formattedText = formatTextForPython(messageText);\n                      code += `            # Прямая навигация к узлу с множественным выбором ${navTargetNode.id}\\n`;\n                      code += `            logging.info(f\"🔧 Переходим к узлу с множественным выбором: ${navTargetNode.id}\")\\n`;\n                      code += '            await callback_query.message.delete()\\n';\n                      code += `            text = ${formattedText}\\n`;\n                      \n                      // Замена переменных\n                      code += '            user_data[callback_query.from_user.id] = user_data.get(callback_query.from_user.id, {})\\n';\n                      code += generateUniversalVariableReplacement('            ');\n                      \n                      // Инициализируем состояние множественного выбора\n                      code += `            # Инициализируем состояние множественного выбора\\n`;\n                      code += `            user_data[callback_query.from_user.id][\"multi_select_${navTargetNode.id}\"] = []\\n`;\n                      code += `            user_data[callback_query.from_user.id][\"multi_select_node\"] = \"${navTargetNode.id}\"\\n`;\n                      code += `            user_data[callback_query.from_user.id][\"multi_select_type\"] = \"selection\"\\n`;\n                      if (navTargetNode.data.multiSelectVariable) {\n                        code += `            user_data[callback_query.from_user.id][\"multi_select_variable\"] = \"${navTargetNode.data.multiSelectVariable}\"\\n`;\n                      }\n                      \n                      // Создаем inline клавиатуру с кнопками выбора\n                      if (navTargetNode.data.buttons && navTargetNode.data.buttons.length > 0) {\n                        code += generateInlineKeyboardCode(navTargetNode.data.buttons, '            ', navTargetNode.id, navTargetNode.data, allNodeIds);\n                        code += `            await bot.send_message(callback_query.from_user.id, text, reply_markup=keyboard)\\n`;\n                      } else {\n                        code += `            await bot.send_message(callback_query.from_user.id, text)\\n`;\n                      }\n                      code += `            logging.info(f\"✅ Прямая навигация к узлу множественного выбора ${navTargetNode.id} выполнена\")\\n`;\n                    } else {\n                      const formattedText = formatTextForPython(messageText);\n                      code += '            await callback_query.message.delete()\\n';\n                      code += `            nav_text = ${formattedText}\\n`;\n                    \n                      // ВАЖНО: Проверяем, включен ли сбор пользовательского ввода для этого узла\n                      if (navTargetNode.data.collectUserInput === true) {\n                        // ИСПРАВЛЕНИЕ: Используем переменную из целевого узла\n                        const regularInputVariable = navTargetNode.data.inputVariable || `response_${navTargetNode.id}`;\n                        code += '            # ИСПРАВЛЕНИЕ: Проверяем, не была ли переменная уже сохранена inline кнопкой\\n';\n                        code += '            user_data[callback_query.from_user.id] = user_data.get(callback_query.from_user.id, {})\\n';\n                        code += `            if \"${regularInputVariable}\" not in user_data[callback_query.from_user.id] or not user_data[callback_query.from_user.id][\"${regularInputVariable}\"]:\\n`;\n                        code += '                # Настраиваем ожидание ввода\\n';\n                        code += '                user_data[callback_query.from_user.id][\"waiting_for_input\"] = {\\n';\n                        code += '                    \"type\": \"text\",\\n';\n                        code += `                    \"variable\": \"${regularInputVariable}\",\\n`;\n                        code += '                    \"save_to_database\": True,\\n';\n                        code += `                    \"node_id\": \"${navTargetNode.id}\",\\n`;\n                        code += `                    \"next_node_id\": \"${inputTargetNodeId}\"\\n`;\n                        code += '                }\\n';\n                        code += `                logging.info(f\"🔧 Настроено ожидание ввода для переменной: ${regularInputVariable} (узел ${navTargetNode.id})\")\\n`;\n                        code += '            else:\\n';\n                        code += `                logging.info(f\"⏭️ Переменная ${regularInputVariable} уже сохранена, пропускаем ожидание ввода\")\\n`;\n                      } else {\n                        code += `            logging.info(f\"Переход к узлу ${navTargetNode.id} без сбора ввода\")\\n`;\n                      }\n                      code += '            await bot.send_message(callback_query.from_user.id, nav_text)\\n';\n                    }\n                  }\n                } else {\n                  code += `            logging.info(\"Переход к узлу ${navTargetNode.id}\")\\n`;\n                }\n              });\n              \n              code += '        else:\\n';\n              code += '            logging.warning(f\"Неизвестный следующий узел: {next_node_id}\")\\n';\n            } else {\n              code += '        # No nodes available for navigation\\n';\n              code += '        logging.warning(f\"Нет доступных узлов для навигации к {next_node_id}\")\\n';\n            }\n            \n            code += '    except Exception as e:\\n';\n            code += '        logging.error(f\"Ошибка при переходе к следующему узлу {next_node_id}: {e}\")\\n';\n            code += '    \\n';\n            code += '    return  # Завершаем обработку после переадресации\\n';\n          }\n          code += '    \\n';\n          \n          // Generate response based on node type\n          if (targetNode.type === 'message' && (targetNode.data.inputVariable || targetNode.data.responseType)) {\n            // Handle input collection nodes\n            const inputPrompt = targetNode.data.messageText || targetNode.data.inputPrompt || \"Пожалуйста, введите ваш ответ:\";\n            const responseType = targetNode.data.responseType || 'text';\n            const inputType = targetNode.data.inputType || 'text';\n            const inputVariable = targetNode.data.inputVariable || `response_${targetNode.id}`;\n            const saveToDatabase = targetNode.data.saveToDatabase || false;\n            \n            code += '    # Удаляем старое сообщение\\n';\n            code += '    await callback_query.message.delete()\\n';\n            code += '    \\n';\n            \n            const formattedPrompt = formatTextForPython(inputPrompt);\n            code += `    text = ${formattedPrompt}\\n`;\n            \n            if (responseType === 'text') {\n              // Find next node through connections\n              const nextConnection = connections.find(conn => conn.source === targetNode.id);\n              const nextNodeId = nextConnection ? nextConnection.target : null;\n              \n              code += '    # Настраиваем ожидание ввода\\n';\n              code += '    user_data[callback_query.from_user.id][\"waiting_for_input\"] = {\\n';\n              code += `        \"type\": \"${inputType}\",\\n`;\n              code += `        \"variable\": \"${inputVariable}\",\\n`;\n              code += `        \"save_to_database\": ${toPythonBoolean(saveToDatabase)},\\n`;\n              code += `        \"node_id\": \"${targetNode.id}\",\\n`;\n              code += `        \"next_node_id\": \"${nextNodeId || ''}\"\\n`;\n              code += '    }\\n';\n              code += '    await bot.send_message(callback_query.from_user.id, text)\\n';\n            }\n          } else {\n            // Handle regular message nodes\n            const targetText = targetNode.data.messageText || \"Сообщение\";\n            const formattedTargetText = formatTextForPython(targetText);\n            \n            // Добавляем поддержку условных сообщений для callback handlers\n            if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n              code += '    # Проверяем условные сообщения\\n';\n              code += '    text = None\\n';\n              code += '    \\n';\n              code += '    # Получаем данные пользователя для проверки условий\\n';\n              code += '    user_record = await get_user_from_db(user_id)\\n';\n              code += '    if not user_record:\\n';\n              code += '        user_record = user_data.get(user_id, {})\\n';\n              code += '    \\n';\n              code += '    # Безопасно извлекаем user_data\\n';\n              code += '    if isinstance(user_record, dict):\\n';\n              code += '        if \"user_data\" in user_record:\\n';\n              code += '            if isinstance(user_record[\"user_data\"], str):\\n';\n              code += '                try:\\n';\n              code += '                    import json\\n';\n              code += '                    user_data_dict = json.loads(user_record[\"user_data\"])\\n';\n              code += '                except (json.JSONDecodeError, TypeError):\\n';\n              code += '                    user_data_dict = {}\\n';\n              code += '            elif isinstance(user_record[\"user_data\"], dict):\\n';\n              code += '                user_data_dict = user_record[\"user_data\"]\\n';\n              code += '            else:\\n';\n              code += '                user_data_dict = {}\\n';\n              code += '        else:\\n';\n              code += '            user_data_dict = user_record\\n';\n              code += '    else:\\n';\n              code += '        user_data_dict = {}\\n';\n              code += '    \\n';\n              code += '    # Функция для замены переменных в тексте\\n';\n              code += '    def replace_variables_in_text(text_content, variables_dict):\\n';\n              code += '        if not text_content or not variables_dict:\\n';\n              code += '            return text_content\\n';\n              code += '        \\n';\n              code += '        for var_name, var_data in variables_dict.items():\\n';\n              code += '            placeholder = \"{\" + var_name + \"}\"\\n';\n              code += '            if placeholder in text_content:\\n';\n              code += '                if isinstance(var_data, dict) and \"value\" in var_data:\\n';\n              code += '                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\\n';\n              code += '                elif var_data is not None:\\n';\n              code += '                    var_value = str(var_data)\\n';\n              code += '                else:\\n';\n              code += '                    var_value = var_name  # Показываем имя переменной если значения нет\\n';\n              code += '                text_content = text_content.replace(placeholder, var_value)\\n';\n              code += '        return text_content\\n';\n              code += '    \\n';\n              \n              // Generate conditional logic using helper function\n              code += generateConditionalMessageLogic(targetNode.data.conditionalMessages, '    ');\n              \n              // Add fallback\n              code += '    else:\\n';\n              \n              if (targetNode.data.fallbackMessage) {\n                const fallbackText = formatTextForPython(targetNode.data.fallbackMessage);\n                code += `        text = ${fallbackText}\\n`;\n                code += '        text = replace_variables_in_text(text, user_data_dict)\\n';\n                code += '        logging.info(\"Используется запасное сообщение\")\\n';\n              } else {\n                code += `        text = ${formattedTargetText}\\n`;\n                code += '        text = replace_variables_in_text(text, user_data_dict)\\n';\n                code += '        logging.info(\"Используется основное сообщение узла\")\\n';\n              }\n              \n              code += '    \\n';\n            } else {\n              code += `    text = ${formattedTargetText}\\n`;\n              \n              // Добавляем замену переменных для обычных сообщений\n              code += generateUniversalVariableReplacement('    ');\n            }\n            \n            // ВАЖНО: Проверяем, включен ли сбор пользовательского ввода для этого узла\n            if (targetNode.data.collectUserInput === true) {\n              // Настраиваем сбор пользовательского ввода\n              const inputType = targetNode.data.inputType || 'text';\n              const inputVariable = targetNode.data.inputVariable || `response_${targetNode.id}`;\n              const saveToDatabase = targetNode.data.saveToDatabase !== false; // По умолчанию true для collectUserInput\n              const inputTargetNodeId = targetNode.data.inputTargetNodeId;\n              \n              code += '    # Активируем сбор пользовательского ввода\\n';\n              code += '    if callback_query.from_user.id not in user_data:\\n';\n              code += '        user_data[callback_query.from_user.id] = {}\\n';\n              code += '    \\n';\n              code += `    user_data[callback_query.from_user.id][\"waiting_for_input\"] = \"${targetNode.id}\"\\n`;\n              code += `    user_data[callback_query.from_user.id][\"input_type\"] = \"${inputType}\"\\n`;\n              code += `    user_data[callback_query.from_user.id][\"input_variable\"] = \"${inputVariable}\"\\n`;\n              code += `    user_data[callback_query.from_user.id][\"save_to_database\"] = ${toPythonBoolean(saveToDatabase)}\\n`;\n              code += `    user_data[callback_query.from_user.id][\"input_target_node_id\"] = \"${inputTargetNodeId || ''}\"\\n`;\n              code += '    \\n';\n              \n              // ИСПРАВЛЕНИЕ: Добавляем поддержку inline кнопок с проверкой условной клавиатуры\n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons && targetNode.data.buttons.length > 0) {\n                code += '    # Проверяем, есть ли условная клавиатура\\n';\n                code += '    if \"keyboard\" not in locals() or keyboard is None:\\n';\n                code += '        # Создаем inline клавиатуру с кнопками (+ сбор ввода включен)\\n';\n                code += '        builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    // Создаем уникальный callback_data, включающий ID кнопки и текст\n                    const callbackData = btn.id || 'no_action';\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command') {\n                    // Для команд создаем специальный callback_data с префиксом cmd_\n                    const commandName = btn.target ? btn.target.replace('/', '') : 'unknown';\n                    const callbackData = `cmd_${commandName}`;\n                    code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  }\n                });\n                code += '        keyboard = builder.as_markup()\\n';\n                let parseModeTarget = '';\n                if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                  parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n                } else if (targetNode.data.formatMode === 'html') {\n                  parseModeTarget = ', parse_mode=ParseMode.HTML';\n                }\n                code += '    # Пытаемся редактировать сообщение, если не получается - отправляем новое\\n';\n                code += '    try:\\n';\n                code += `        await safe_edit_or_send(callback_query, text, reply_markup=keyboard${parseModeTarget})\\n`;\n                code += '    except Exception as e:\\n';\n                code += '        logging.warning(f\"Не удалось редактировать сообщение: {e}. Отправляем новое.\")\\n';\n                code += `        await callback_query.message.answer(text, reply_markup=keyboard${parseModeTarget})\\n`;\n              } else {\n                code += '    # Пытаемся редактировать сообщение, если не получается - отправляем новое\\n';\n                code += '    try:\\n';\n                code += '        await callback_query.message.edit_text(text)\\n';\n                code += '    except Exception as e:\\n';\n                code += '        logging.warning(f\"Не удалось редактировать сообщение: {e}. Отправляем новое.\")\\n';\n                code += '        await callback_query.message.answer(text)\\n';\n              }\n              code += '    \\n';\n            } else {\n              // Обычное отображение сообщения без сбора ввода\n              \n              // Handle keyboard for target node\n              if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons && targetNode.data.buttons.length > 0) {\n                code += '    builder = InlineKeyboardBuilder()\\n';\n                targetNode.data.buttons.forEach((btn, index) => {\n                  if (btn.action === \"url\") {\n                    code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                  } else if (btn.action === 'goto') {\n                    // Создаем уникальный callback_data, включающий ID кнопки\n                    const callbackData = btn.id || 'no_action';\n                    code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  } else if (btn.action === 'command') {\n                    // Для команд создаем специальный callback_data с префиксом cmd_\n                    const commandName = btn.target ? btn.target.replace('/', '') : 'unknown';\n                    const callbackData = `cmd_${commandName}`;\n                    code += `    builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                  }\n                });\n                code += '    keyboard = builder.as_markup()\\n';\n                let parseModeTarget = '';\n                if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                  parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n                } else if (targetNode.data.formatMode === 'html') {\n                  parseModeTarget = ', parse_mode=ParseMode.HTML';\n                }\n                code += `    # Пытаемся редактировать сообщение, если не получается - отправляем новое\\n`;\n                code += `    try:\\n`;\n                code += `        await safe_edit_or_send(callback_query, text, reply_markup=keyboard${parseModeTarget})\\n`;\n                code += `    except Exception as e:\\n`;\n                code += `        logging.warning(f\"Не удалось редактировать сообщение: {e}. Отправляем новое.\")\\n`;\n                code += `        await callback_query.message.answer(text, reply_markup=keyboard${parseModeTarget})\\n`;\n              } else {\n                let parseModeTarget = '';\n                if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                  parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n                } else if (targetNode.data.formatMode === 'html') {\n                  parseModeTarget = ', parse_mode=ParseMode.HTML';\n                }\n                code += `    # Пытаемся редактировать сообщение, если не получается - отправляем новое\\n`;\n                code += `    try:\\n`;\n                code += `        await callback_query.message.edit_text(text${parseModeTarget})\\n`;\n                code += `    except Exception as e:\\n`;\n                code += `        logging.warning(f\"Не удалось редактировать сообщение: {e}. Отправляем новое.\")\\n`;\n                code += `        await callback_query.message.answer(text${parseModeTarget})\\n`;\n              }\n            } // Закрываем else блок для обычного отображения\n          } // Закрываем else блок для regular message nodes\n          \n          // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Добавляем обязательный return в конец функции\n          code += '    return\\n';\n        }\n      }\n    });\n  }\n  \n  // Generate handlers for reply keyboard buttons\n  const replyNodes = (nodes || []).filter(node => \n    node.data.keyboardType === 'reply' && node.data.buttons && node.data.buttons.length > 0\n  );\n  \n  if (replyNodes.length > 0) {\n    code += '\\n# Обработчики reply кнопок\\n';\n    const processedReplyButtons = new Set<string>();\n    \n    replyNodes.forEach(node => {\n      node.data.buttons.forEach(button => {\n        if (button.action === 'goto' && button.target) {\n          const buttonText = button.text;\n          \n          // Avoid duplicate handlers\n          if (processedReplyButtons.has(buttonText)) return;\n          processedReplyButtons.add(buttonText);\n          \n          // Find target node\n          const targetNode = nodes.find(n => n.id === button.target);\n          if (targetNode) {\n            code += `\\n@dp.message(lambda message: message.text == \"${buttonText}\")\\n`;\n            // Создаем безопасное имя функции на основе button ID\n            const safeFunctionName = button.id.replace(/[^a-zA-Z0-9_]/g, '_');\n            code += `async def handle_reply_${safeFunctionName}(message: types.Message):\\n`;\n            \n            // Generate response for target node\n            const targetText = targetNode.data.messageText || \"Сообщение\";\n            const formattedTargetText = formatTextForPython(targetText);\n            code += `    text = ${formattedTargetText}\\n`;\n            \n            // Добавляем замену переменных для reply кнопок\n            code += '    user_id = message.from_user.id\\n';\n            code += generateUniversalVariableReplacement('    ');\n            \n            // Handle keyboard for target node\n            if (targetNode.data.keyboardType === \"reply\" && targetNode.data.buttons.length > 0) {\n              code += '    builder = ReplyKeyboardBuilder()\\n';\n              targetNode.data.buttons.forEach((btn, index) => {\n                code += `    builder.add(KeyboardButton(text=${generateButtonText(btn.text)}))\\n`;\n              });\n              const resizeKeyboard = toPythonBoolean(targetNode.data.resizeKeyboard);\n              const oneTimeKeyboard = toPythonBoolean(targetNode.data.oneTimeKeyboard);\n              code += `    keyboard = builder.as_markup(resize_keyboard=${resizeKeyboard}, one_time_keyboard=${oneTimeKeyboard})\\n`;\n              // Определяем режим форматирования для целевого узла\n              let parseModeTarget = '';\n              if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n              } else if (targetNode.data.formatMode === 'html') {\n                parseModeTarget = ', parse_mode=ParseMode.HTML';\n              }\n              code += `    await message.answer(text, reply_markup=keyboard${parseModeTarget})\\n`;\n            \n            // Дополнительно: сохраняем нажатие reply кнопки если включен сбор ответов\n            code += '    \\n';\n            code += '    # Сохраняем нажатие reply кнопки если включен сбор ответов\\n';\n            code += '    user_id = message.from_user.id\\n';\n            code += '    if user_id in user_data and user_data[user_id].get(\"input_collection_enabled\"):\\n';\n            code += '        import datetime\\n';\n            code += '        timestamp = get_moscow_time()\\n';\n            code += '        input_node_id = user_data[user_id].get(\"input_node_id\")\\n';\n            code += '        input_variable = user_data[user_id].get(\"input_variable\", \"button_response\")\\n';\n            code += '        \\n';\n            code += '        response_data = {\\n';\n            code += `            \"value\": \"${buttonText}\",\\n`;\n            code += '            \"type\": \"reply_button\",\\n';\n            code += '            \"timestamp\": timestamp,\\n';\n            code += '            \"nodeId\": input_node_id,\\n';\n            code += '            \"variable\": input_variable,\\n';\n            code += '            \"source\": \"reply_button_click\"\\n';\n            code += '        }\\n';\n            code += '        \\n';\n            code += '        user_data[user_id][f\"{input_variable}_button\"] = response_data\\n';\n            code += '        logging.info(f\"Reply кнопка сохранена: {input_variable}_button = ${buttonText} (пользователь {user_id})\")\\n';\n            \n            } else if (targetNode.data.keyboardType === \"inline\" && targetNode.data.buttons.length > 0) {\n              // Добавляем поддержку условных сообщений для целевого узла\n              if (targetNode.data.enableConditionalMessages && targetNode.data.conditionalMessages && targetNode.data.conditionalMessages.length > 0) {\n                code += '    # Проверка условных сообщений для целевого узла\\n';\n                code += '    user_record = await get_user_from_db(user_id)\\n';\n                code += '    if not user_record:\\n';\n                code += '        user_record = user_data.get(user_id, {})\\n';\n                code += '    user_data_dict = user_record if user_record else user_data.get(user_id, {})\\n';\n                code += generateConditionalMessageLogic(targetNode.data.conditionalMessages, '    ');\n                code += '    \\n';\n                code += '    # Проверяем, нужно ли использовать условную клавиатуру\\n';\n                code += '    use_conditional_keyboard = conditional_keyboard is not None\\n';\n              } else {\n                code += '    # Инициализируем переменную для проверки условной клавиатуры\\n';\n                code += '    use_conditional_keyboard = False\\n';\n                code += '    conditional_keyboard = None\\n';\n              }\n              \n              code += '    # Проверяем, нужно ли использовать условную клавиатуру\\n';\n              code += '    if use_conditional_keyboard:\\n';\n              // Определяем режим форматирования для целевого узла\n              let parseModeTarget = '';\n              if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n              } else if (targetNode.data.formatMode === 'html') {\n                parseModeTarget = ', parse_mode=ParseMode.HTML';\n              }\n              code += `        await message.answer(text, reply_markup=conditional_keyboard${parseModeTarget})\\n`;\n              code += '    else:\\n';\n              code += '        builder = InlineKeyboardBuilder()\\n';\n              targetNode.data.buttons.forEach((btn, index) => {\n                if (btn.action === \"url\") {\n                  code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, url=\"${btn.url || '#'}\"))\\n`;\n                } else if (btn.action === 'goto') {\n                  // Если есть target, используем его, иначе используем ID кнопки как callback_data\n                  const baseCallbackData = btn.target || btn.id || 'no_action'; const callbackData = `${baseCallbackData}_btn_${index}`;\n                  code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                } else if (btn.action === 'command') {\n                  // Для команд создаем специальный callback_data с префиксом cmd_\n                  const commandName = btn.target ? btn.target.replace('/', '') : 'unknown';\n                  const callbackData = `cmd_${commandName}`;\n                  code += `        builder.add(InlineKeyboardButton(text=${generateButtonText(btn.text)}, callback_data=\"${callbackData}\"))\\n`;\n                }\n              });\n              // Добавляем настройку колонок для консистентности\n              const columns = calculateOptimalColumns(targetNode.data.buttons, targetNode.data);\n              code += `        builder.adjust(${columns})\\n`;\n              code += '        keyboard = builder.as_markup()\\n';\n              code += `        await message.answer(text, reply_markup=keyboard${parseModeTarget})\\n`;\n            \n            // Дополнительно: сохраняем нажатие reply кнопки если включен сбор ответов\n            code += '    \\n';\n            code += '    # Сохраняем нажатие reply кнопки если включен сбор ответов\\n';\n            code += '    user_id = message.from_user.id\\n';\n            code += '    if user_id in user_data and user_data[user_id].get(\"input_collection_enabled\"):\\n';\n            code += '        import datetime\\n';\n            code += '        timestamp = get_moscow_time()\\n';\n            code += '        input_node_id = user_data[user_id].get(\"input_node_id\")\\n';\n            code += '        input_variable = user_data[user_id].get(\"input_variable\", \"button_response\")\\n';\n            code += '        \\n';\n            code += '        response_data = {\\n';\n            code += `            \"value\": \"${buttonText}\",\\n`;\n            code += '            \"type\": \"reply_button\",\\n';\n            code += '            \"timestamp\": timestamp,\\n';\n            code += '            \"nodeId\": input_node_id,\\n';\n            code += '            \"variable\": input_variable,\\n';\n            code += '            \"source\": \"reply_button_click\"\\n';\n            code += '        }\\n';\n            code += '        \\n';\n            code += '        user_data[user_id][f\"{input_variable}_button\"] = response_data\\n';\n            code += '        logging.info(f\"Reply кнопка сохранена: {input_variable}_button = ${buttonText} (пользователь {user_id})\")\\n';\n            \n            } else {\n              code += '    # Удаляем предыдущие reply клавиатуры если они были\\n';\n              // Определяем режим форматирования для целевого узла\n              let parseModeTarget = '';\n              if (targetNode.data.formatMode === 'markdown' || targetNode.data.markdown === true) {\n                parseModeTarget = ', parse_mode=ParseMode.MARKDOWN';\n              } else if (targetNode.data.formatMode === 'html') {\n                parseModeTarget = ', parse_mode=ParseMode.HTML';\n              }\n              code += `    await message.answer(text, reply_markup=ReplyKeyboardRemove()${parseModeTarget})\\n`;\n              \n              // CRITICAL FIX: Если целевой узел требует пользовательского ввода, устанавливаем waiting_for_input\n              if (targetNode.data.collectUserInput === true && targetNode.data.enableTextInput === true) {\n                const inputVariable = targetNode.data.inputVariable || `response_${targetNode.id}`;\n                const inputTargetNodeId = targetNode.data.inputTargetNodeId || '';\n                \n                code += '    \\n';\n                code += '    # Устанавливаем состояние ожидания ввода для ' + inputVariable + '\\n';\n                code += '    if user_id not in user_data:\\n';\n                code += '        user_data[user_id] = {}\\n';\n                code += '    user_data[user_id][\"waiting_for_input\"] = {\\n';\n                code += '        \"type\": \"text\",\\n';\n                code += `        \"variable\": \"${inputVariable}\",\\n`;\n                code += '        \"save_to_database\": True,\\n';\n                code += `        \"node_id\": \"${targetNode.id}\",\\n`;\n                code += `        \"next_node_id\": \"${inputTargetNodeId}\",\\n`;\n                code += `        \"min_length\": ${targetNode.data.minLength || 0},\\n`;\n                code += `        \"max_length\": ${targetNode.data.maxLength || 0},\\n`;\n                code += '        \"retry_message\": \"Пожалуйста, попробуйте еще раз.\",\\n';\n                code += '        \"success_message\": \"✅ Спасибо за ваш ответ!\"\\n';\n                code += '    }\\n';\n                code += `    logging.info(f\"✅ Состояние ожидания настроено: text ввод для переменной ${inputVariable} (узел ${targetNode.id})\")\\n`;\n              }\n            }\n          }\n        }\n      });\n    });\n  }\n\n  // Generate handlers for contact and location buttons\n  const contactButtons = replyNodes.flatMap(node => \n    node.data.buttons.filter(button => button.action === 'contact')\n  );\n  \n  const locationButtons = replyNodes.flatMap(node => \n    node.data.buttons.filter(button => button.action === 'location')\n  );\n  \n  if (contactButtons.length > 0 || locationButtons.length > 0) {\n    code += '\\n# Обработчики специальных кнопок\\n';\n    \n    if (contactButtons.length > 0) {\n      code += '\\n@dp.message(F.contact)\\n';\n      code += 'async def handle_contact(message: types.Message):\\n';\n      code += '    contact = message.contact\\n';\n      code += '    text = f\"Спасибо за контакт!\\\\n\"\\n';\n      code += '    text += f\"Имя: {contact.first_name}\\\\n\"\\n';\n      code += '    text += f\"Телефон: {contact.phone_number}\"\\n';\n      code += '    await message.answer(text)\\n';\n    }\n    \n    if (locationButtons.length > 0) {\n      code += '\\n@dp.message(F.location)\\n';\n      code += 'async def handle_location(message: types.Message):\\n';\n      code += '    location = message.location\\n';\n      code += '    text = f\"Спасибо за геолокацию!\\\\n\"\\n';\n      code += '    text += f\"Широта: {location.latitude}\\\\n\"\\n';\n      code += '    text += f\"Долгота: {location.longitude}\"\\n';\n      code += '    await message.answer(text)\\n';\n    }\n  }\n\n  // Добавляем обработчики кнопочных ответов для узлов сбора ввода\n  const userInputNodes = (nodes || []).filter(node => \n    node.type === 'message' && \n    node.data.responseType === 'buttons' && \n    Array.isArray(node.data.responseOptions) && \n    node.data.responseOptions.length > 0\n  );\n\n  if (userInputNodes.length > 0) {\n    code += '\\n# Обработчики кнопочных ответов для сбора пользовательского ввода\\n';\n    \n    userInputNodes.forEach(node => {\n      const responseOptions = node.data.responseOptions || [];\n      \n      // Обработчики для каждого варианта ответа\n      responseOptions.forEach((option, index) => {\n        code += `\\n@dp.callback_query(F.data == \"response_${node.id}_${index}\")\\n`;\n        const safeFunctionName = `${node.id}_${index}`.replace(/[^a-zA-Z0-9_]/g, '_');\n        code += `async def handle_response_${safeFunctionName}(callback_query: types.CallbackQuery):\\n`;\n        code += '    user_id = callback_query.from_user.id\\n';\n        code += '    \\n';\n        code += '    # Проверяем настройки кнопочного ответа\\n';\n        code += '    if user_id not in user_data or \"button_response_config\" not in user_data[user_id]:\\n';\n        code += '        await callback_query.answer(\"⚠️ Сессия истекла, попробуйте снова\", show_alert=True)\\n';\n        code += '        return\\n';\n        code += '    \\n';\n        code += '    config = user_data[user_id][\"button_response_config\"]\\n';\n        code += `    selected_value = \"${option.value || option.text}\"\\n`;\n        code += `    selected_text = \"${option.text}\"\\n`;\n        code += '    \\n';\n        code += '    # Обработка множественного выбора\\n';\n        code += '    if config.get(\"allow_multiple\"):\\n';\n        code += '        # Проверяем, является ли это кнопкой \"Готово\" для завершения выбора\\n';\n        code += '        if selected_value == \"done\":\\n';\n        code += '            # Завершаем множественный выбор\\n';\n        code += '            if len(config[\"selected\"]) > 0:\\n';\n        code += '                # Сохраняем все выбранные элементы\\n';\n        code += '                variable_name = config.get(\"variable\", \"user_response\")\\n';\n        code += '                import datetime\\n';\n        code += '                import pytz\\n';\n        code += '                timestamp = datetime.datetime.now(moscow_tz).isoformat()\\n';\n        code += '                node_id = config.get(\"node_id\", \"unknown\")\\n';\n        code += '                \\n';\n        code += '                # Создаем структурированный ответ для множественного выбора\\n';\n        code += '                response_data = {\\n';\n        code += '                    \"value\": [item[\"value\"] for item in config[\"selected\"]],\\n';\n        code += '                    \"text\": [item[\"text\"] for item in config[\"selected\"]],\\n';\n        code += '                    \"type\": \"multiple_choice\",\\n';\n        code += '                    \"timestamp\": timestamp,\\n';\n        code += '                    \"nodeId\": node_id,\\n';\n        code += '                    \"variable\": variable_name\\n';\n        code += '                }\\n';\n        code += '                \\n';\n        code += '                # Сохраняем в пользовательские данные\\n';\n        code += '                user_data[user_id][variable_name] = response_data\\n';\n        code += '                \\n';\n        code += '                # Сохраняем в базу данных если включено\\n';\n        code += '                if config.get(\"save_to_database\"):\\n';\n        code += '                    saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\\n';\n        code += '                    if saved_to_db:\\n';\n        code += '                        logging.info(f\"✅ Множественный выбор сохранен в БД: {variable_name} = {response_data[\\'text\\']} (пользователь {user_id})\")\\n';\n        code += '                    else:\\n';\n        code += '                        logging.warning(f\"⚠️ Не удалось сохранить в БД, данные сохранены локально\")\\n';\n        code += '                \\n';\n        code += '                # Отправляем сообщение об успехе\\n';\n        code += '                success_message = config.get(\"success_message\", \"Спасибо за ваш выбор!\")\\n';\n        code += '                selected_items = \", \".join([item[\"text\"] for item in config[\"selected\"]])\\n';\n        code += '                await callback_query.message.edit_text(f\"{success_message}\\\\n\\\\n✅ Ваш выбор: {selected_items}\")\\n';\n        code += '                \\n';\n        code += '                logging.info(f\"Получен множественный выбор: {variable_name} = {[item[\\'text\\'] for item in config[\\'selected\\']]}\")\\n';\n        code += '                \\n';\n        code += '                # Очищаем состояние\\n';\n        code += '                del user_data[user_id][\"button_response_config\"]\\n';\n        code += '                \\n';\n        code += '                # Автоматическая навигация к следующему узлу\\n';\n        code += '                next_node_id = config.get(\"next_node_id\")\\n';\n        code += '                if next_node_id:\\n';\n        code += '                    try:\\n';\n        code += '                        # Вызываем обработчик для следующего узла\\n';\n        \n        // Add navigation for done button\n        if (nodes.length > 0) {\n          nodes.forEach((btnNode, btnIndex) => {\n            const safeFunctionName = btnNode.id.replace(/[^a-zA-Z0-9_]/g, '_');\n            const condition = btnIndex === 0 ? 'if' : 'elif';\n            code += `                        ${conditio","size_bytes":360000},"client/src/lib/map-utils.ts":{"content":"/**\n * Утилиты для работы с картографическими сервисами\n */\n\nexport interface Coordinates {\n  latitude: number;\n  longitude: number;\n}\n\n/**\n * Извлекает координаты из ссылки Яндекс.Карт\n */\nexport function extractCoordinatesFromYandex(url: string): Coordinates | null {\n  try {\n    // Ищем координаты в формате ll=longitude,latitude\n    let match = url.match(/ll=([+-]?\\d+\\.?\\d*),([+-]?\\d+\\.?\\d*)/);\n    if (match) {\n      return {\n        latitude: parseFloat(match[2]),\n        longitude: parseFloat(match[1])\n      };\n    }\n\n    // Ищем координаты в формате /longitude,latitude/\n    match = url.match(/\\/([+-]?\\d+\\.?\\d*),([+-]?\\d+\\.?\\d*)\\//);\n    if (match) {\n      return {\n        latitude: parseFloat(match[2]),\n        longitude: parseFloat(match[1])\n      };\n    }\n\n    // Ищем координаты в короткой ссылке формата /-/CHwa7LZ0\n    if (url.includes('yandex.ru/maps/-/')) {\n      // Альтернативный подход - получаем координаты из параметров URL если есть\n      const urlParams = new URLSearchParams(url.split('?')[1] || '');\n      const ll = urlParams.get('ll');\n      if (ll) {\n        const [lon, lat] = ll.split(',').map(coord => parseFloat(coord));\n        if (!isNaN(lat) && !isNaN(lon)) {\n          return {\n            latitude: lat,\n            longitude: lon\n          };\n        }\n      }\n      \n      // Попробуем найти координаты в базовой части URL\n      const fullUrl = url.includes('?') ? url : url + '?ll=37.6176,55.7558'; // Fallback для Москвы\n      if (fullUrl.includes('ll=')) {\n        const llMatch = fullUrl.match(/ll=([0-9.-]+),([0-9.-]+)/);\n        if (llMatch) {\n          const lon = parseFloat(llMatch[1]);\n          const lat = parseFloat(llMatch[2]);\n          if (!isNaN(lat) && !isNaN(lon)) {\n            return {\n              latitude: lat,\n              longitude: lon\n            };\n          }\n        }\n      }\n      \n      // Если параметров нет, возвращаем координаты по умолчанию для Москвы\n      console.log('Короткая ссылка Яндекс.Карт обнаружена, используем координаты Москвы по умолчанию');\n      return {\n        latitude: 55.7558,\n        longitude: 37.6176\n      };\n    }\n\n    return null;\n  } catch (error) {\n    console.error('Ошибка извлечения координат из Яндекс.Карт:', error);\n    return null;\n  }\n}\n\n/**\n * Извлекает координаты из ссылки Google Maps\n */\nexport function extractCoordinatesFromGoogle(url: string): Coordinates | null {\n  try {\n    // Ищем координаты в формате @latitude,longitude\n    let match = url.match(/@([+-]?\\d+\\.?\\d*),([+-]?\\d+\\.?\\d*)/);\n    if (match) {\n      return {\n        latitude: parseFloat(match[1]),\n        longitude: parseFloat(match[2])\n      };\n    }\n\n    // Ищем координаты в формате q=latitude,longitude\n    match = url.match(/[?&]q=([+-]?\\d+\\.?\\d*),([+-]?\\d+\\.?\\d*)/);\n    if (match) {\n      return {\n        latitude: parseFloat(match[1]),\n        longitude: parseFloat(match[2])\n      };\n    }\n\n    // Ищем координаты в формате /latitude,longitude/\n    match = url.match(/\\/([+-]?\\d+\\.?\\d*),([+-]?\\d+\\.?\\d*)\\//);\n    if (match) {\n      return {\n        latitude: parseFloat(match[1]),\n        longitude: parseFloat(match[2])\n      };\n    }\n\n    return null;\n  } catch (error) {\n    console.error('Ошибка извлечения координат из Google Maps:', error);\n    return null;\n  }\n}\n\n/**\n * Извлекает координаты из ссылки 2ГИС\n */\nexport function extractCoordinatesFrom2GIS(url: string): Coordinates | null {\n  try {\n    // Ищем координаты в формате center/longitude,latitude\n    let match = url.match(/center\\/([+-]?\\d+\\.?\\d*),([+-]?\\d+\\.?\\d*)/);\n    if (match) {\n      return {\n        latitude: parseFloat(match[2]),\n        longitude: parseFloat(match[1])\n      };\n    }\n\n    // Ищем координаты в формате /longitude,latitude/\n    match = url.match(/\\/([+-]?\\d+\\.?\\d*),([+-]?\\d+\\.?\\d*)\\//);\n    if (match) {\n      return {\n        latitude: parseFloat(match[2]),\n        longitude: parseFloat(match[1])\n      };\n    }\n\n    // Ищем координаты в параметрах URL\n    match = url.match(/[?&]lat=([+-]?\\d+\\.?\\d*).*[?&]lon=([+-]?\\d+\\.?\\d*)/);\n    if (match) {\n      return {\n        latitude: parseFloat(match[1]),\n        longitude: parseFloat(match[2])\n      };\n    }\n\n    return null;\n  } catch (error) {\n    console.error('Ошибка извлечения координат из 2ГИС:', error);\n    return null;\n  }\n}\n\n/**\n * Извлекает координаты из URL в зависимости от сервиса\n */\nexport function extractCoordinatesFromUrl(url: string): {coordinates: Coordinates | null, service: string | null} {\n  if (!url) {\n    return { coordinates: null, service: null };\n  }\n\n  const urlLower = url.toLowerCase();\n\n  if (urlLower.includes('yandex.ru/maps') || urlLower.includes('ya.ru')) {\n    return {\n      coordinates: extractCoordinatesFromYandex(url),\n      service: 'yandex'\n    };\n  }\n\n  if (urlLower.includes('maps.google.com') || urlLower.includes('goo.gl/maps')) {\n    return {\n      coordinates: extractCoordinatesFromGoogle(url),\n      service: 'google'\n    };\n  }\n\n  if (urlLower.includes('2gis.ru') || urlLower.includes('2gis.com')) {\n    return {\n      coordinates: extractCoordinatesFrom2GIS(url),\n      service: '2gis'\n    };\n  }\n\n  return { coordinates: null, service: null };\n}\n\n/**\n * Генерирует ссылки на различные картографические сервисы\n */\nexport function generateMapUrls(latitude: number, longitude: number, title: string = ''): Record<string, string> {\n  const encodedTitle = encodeURIComponent(title);\n  \n  return {\n    yandex: `https://yandex.ru/maps/?ll=${longitude},${latitude}&z=15&l=map&pt=${longitude},${latitude}`,\n    google: `https://maps.google.com/?q=${latitude},${longitude}`,\n    '2gis': `https://2gis.ru/geo/${longitude},${latitude}`,\n    openstreetmap: `https://www.openstreetmap.org/?mlat=${latitude}&mlon=${longitude}&zoom=15`\n  };\n}\n\n/**\n * Форматирует координаты для отображения\n */\nexport function formatCoordinates(latitude: number, longitude: number): string {\n  return `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;\n}\n\n/**\n * Получает информацию о местоположении по координатам через обратное геокодирование\n */\nexport async function getLocationInfo(latitude: number, longitude: number): Promise<{\n  title?: string;\n  address?: string;\n  city?: string;\n  country?: string;\n} | null> {\n  try {\n    // Используем OpenStreetMap Nominatim API для обратного геокодирования\n    const response = await fetch(\n      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`,\n      {\n        headers: {\n          'User-Agent': 'TelegramBotBuilder/1.0'\n        }\n      }\n    );\n    \n    if (!response.ok) {\n      throw new Error('Ошибка запроса к геокодинг сервису');\n    }\n    \n    const data = await response.json();\n    \n    if (data && data.address) {\n      const address = data.address;\n      \n      // Формируем красивое название\n      let title = '';\n      if (address.name) {\n        title = address.name;\n      } else if (address.house_number && address.road) {\n        title = `${address.road}, ${address.house_number}`;\n      } else if (address.road) {\n        title = address.road;\n      } else if (address.neighbourhood) {\n        title = address.neighbourhood;\n      } else if (address.suburb) {\n        title = address.suburb;\n      } else if (address.city || address.town || address.village) {\n        title = address.city || address.town || address.village;\n      }\n      \n      // Формируем полный адрес\n      let fullAddress = '';\n      const addressParts = [];\n      \n      if (address.house_number && address.road) {\n        addressParts.push(`${address.road}, ${address.house_number}`);\n      } else if (address.road) {\n        addressParts.push(address.road);\n      }\n      \n      if (address.neighbourhood && !addressParts.some(part => part.includes(address.neighbourhood))) {\n        addressParts.push(address.neighbourhood);\n      }\n      \n      if (address.city || address.town || address.village) {\n        addressParts.push(address.city || address.town || address.village);\n      }\n      \n      if (address.country) {\n        addressParts.push(address.country);\n      }\n      \n      fullAddress = addressParts.join(', ');\n      \n      return {\n        title: title || 'Местоположение',\n        address: fullAddress || data.display_name,\n        city: address.city || address.town || address.village || '',\n        country: address.country || ''\n      };\n    }\n    \n    return null;\n  } catch (error) {\n    console.error('Ошибка получения информации о местоположении:', error);\n    return null;\n  }\n}","size_bytes":9533},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/components/editor/bot-control.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogDescription } from '@/components/ui/dialog';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Switch } from '@/components/ui/switch';\nimport { DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator } from '@/components/ui/dropdown-menu';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\nimport { BotToken } from '@shared/schema';\nimport { Play, Square, AlertCircle, CheckCircle, Clock, Trash2, Edit2, Settings, Bot, RefreshCw, Check, X, Plus, MoreHorizontal, Camera, Upload, ExternalLink } from 'lucide-react';\n\ninterface BotControlProps {\n  projectId: number;\n  projectName: string;\n}\n\ninterface BotInstance {\n  id: number;\n  projectId: number;\n  tokenId: number;\n  status: 'running' | 'stopped' | 'error';\n  token: string;\n  processId?: string;\n  startedAt: Date;\n  stoppedAt?: Date;\n  errorMessage?: string;\n}\n\ninterface BotStatusResponse {\n  status: 'running' | 'stopped' | 'error';\n  instance: BotInstance | null;\n}\n\n// Используем тип BotToken из shared/schema.ts\n\ninterface DefaultTokenResponse {\n  hasDefault: boolean;\n  token: BotToken | null;\n}\n\ninterface BotInfo {\n  id: number;\n  is_bot: boolean;\n  first_name: string;\n  username: string;\n  can_join_groups: boolean;\n  can_read_all_group_messages: boolean;\n  supports_inline_queries: boolean;\n  description?: string;\n  short_description?: string;\n  photoUrl?: string;\n  photo?: {\n    small_file_id: string;\n    small_file_unique_id: string;\n    big_file_id: string;\n    big_file_unique_id: string;\n  };\n}\n\n// Компонент аватарки бота с fallback\nfunction BotAvatar({ \n  photoUrl, \n  botName, \n  size = 40, \n  className = \"\" \n}: { \n  photoUrl?: string | null; \n  botName: string; \n  size?: number; \n  className?: string; \n}) {\n  const [imageError, setImageError] = useState(false);\n  \n  // Получаем первые буквы названия бота для fallback\n  const initials = botName\n    .split(' ')\n    .map(word => word.charAt(0))\n    .join('')\n    .toUpperCase()\n    .slice(0, 2);\n  \n  const handleImageError = () => {\n    setImageError(true);\n  };\n  \n  // Если есть аватарка, показываем её\n  const showImage = photoUrl && !imageError;\n  \n  if (showImage) {\n    return (\n      <div \n        className={`relative rounded-lg overflow-hidden flex-shrink-0 ${className}`}\n        style={{ width: size, height: size }}\n      >\n        <img \n          src={photoUrl}\n          alt={`${botName} avatar`}\n          className=\"w-full h-full object-cover\"\n          onError={handleImageError}\n        />\n      </div>\n    );\n  }\n  \n  // Fallback: показываем инициалы или иконку бота\n  return (\n    <div \n      className={`bg-gradient-to-br from-blue-500 to-indigo-600 dark:from-blue-600 dark:to-indigo-700 rounded-lg flex items-center justify-center flex-shrink-0 ${className}`}\n      style={{ width: size, height: size }}\n    >\n      {initials ? (\n        <span \n          className=\"text-white font-semibold\"\n          style={{ fontSize: size * 0.4 }}\n        >\n          {initials}\n        </span>\n      ) : (\n        <Bot \n          className=\"text-white\" \n          size={size * 0.5} \n        />\n      )}\n    </div>\n  );\n}\n\n// Компонент для загрузки аватарки бота\nfunction BotAvatarUploader({\n  botInfo,\n  onAvatarSelected\n}: {\n  botInfo: BotInfo;\n  onAvatarSelected: (file: File) => void;\n}) {\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [previewUrl, setPreviewUrl] = useState<string | null>(null);\n  const [showInstructions, setShowInstructions] = useState(false);\n  const fileInputRef = useState<HTMLInputElement | null>(null);\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    // Проверяем тип файла\n    if (!file.type.startsWith('image/')) {\n      alert('Пожалуйста, выберите изображение');\n      return;\n    }\n\n    // Проверяем размер файла (макс 5MB)\n    if (file.size > 5 * 1024 * 1024) {\n      alert('Размер файла не должен превышать 5MB');\n      return;\n    }\n\n    setSelectedFile(file);\n    \n    // Создаем превью\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      setPreviewUrl(e.target?.result as string);\n    };\n    reader.readAsDataURL(file);\n    \n    onAvatarSelected(file);\n    setShowInstructions(true);\n  };\n\n  const handleDrop = (event: React.DragEvent) => {\n    event.preventDefault();\n    const file = event.dataTransfer.files[0];\n    if (file && file.type.startsWith('image/')) {\n      const fakeEvent = {\n        target: { files: [file] }\n      } as any;\n      handleFileSelect(fakeEvent);\n    }\n  };\n\n  const handleDragOver = (event: React.DragEvent) => {\n    event.preventDefault();\n  };\n\n  return (\n    <>\n      <div className=\"space-y-3\">\n        <Label>Аватар бота</Label>\n        <div className=\"flex items-center gap-4\">\n          {/* Текущий аватар */}\n          <BotAvatar\n            photoUrl={botInfo.photoUrl}\n            botName={botInfo.first_name}\n            size={64}\n          />\n          \n          {/* Превью нового аватара */}\n          {previewUrl && (\n            <div className=\"relative\">\n              <img\n                src={previewUrl}\n                alt=\"Предпросмотр\"\n                className=\"w-16 h-16 rounded-lg object-cover border-2 border-green-500\"\n              />\n              <div className=\"absolute -top-2 -right-2 bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs\">\n                ✓\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Зона загрузки */}\n        <div\n          className=\"border-2 border-dashed border-muted-foreground/25 rounded-lg p-6 text-center hover:border-muted-foreground/50 transition-colors cursor-pointer\"\n          onDrop={handleDrop}\n          onDragOver={handleDragOver}\n          onClick={() => fileInputRef[0]?.click()}\n          data-testid=\"avatar-upload-zone\"\n        >\n          <input\n            type=\"file\"\n            ref={(el) => (fileInputRef[0] = el)}\n            onChange={handleFileSelect}\n            accept=\"image/*\"\n            className=\"hidden\"\n            data-testid=\"avatar-file-input\"\n          />\n          <div className=\"flex flex-col items-center gap-2\">\n            <Camera className=\"h-8 w-8 text-muted-foreground\" />\n            <p className=\"text-sm font-medium\">Загрузить новый аватар</p>\n            <p className=\"text-xs text-muted-foreground\">\n              Перетащите изображение или нажмите для выбора\n            </p>\n            <p className=\"text-xs text-muted-foreground\">\n              Поддерживаются JPG, PNG (до 5MB)\n            </p>\n          </div>\n        </div>\n\n        {selectedFile && (\n          <div className=\"bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-lg p-3\">\n            <div className=\"flex items-center gap-2 text-blue-700 dark:text-blue-300\">\n              <Upload className=\"h-4 w-4\" />\n              <p className=\"text-sm font-medium\">\n                Файл выбран: {selectedFile.name}\n              </p>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Диалог с инструкциями */}\n      <Dialog open={showInstructions} onOpenChange={setShowInstructions}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Camera className=\"h-5 w-5\" />\n              Установка аватара бота\n            </DialogTitle>\n            <DialogDescription>\n              Для установки аватара необходимо использовать BotFather в Telegram\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            {previewUrl && (\n              <div className=\"flex justify-center\">\n                <img\n                  src={previewUrl}\n                  alt=\"Предпросмотр аватара\"\n                  className=\"w-24 h-24 rounded-full object-cover border-4 border-blue-500\"\n                />\n              </div>\n            )}\n            \n            <div className=\"space-y-3\">\n              <h4 className=\"font-medium text-sm\">Инструкция по установке:</h4>\n              <ol className=\"space-y-2 text-sm text-muted-foreground\">\n                <li className=\"flex gap-2\">\n                  <span className=\"flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-medium\">1</span>\n                  <span>Сохраните выбранное изображение на устройство</span>\n                </li>\n                <li className=\"flex gap-2\">\n                  <span className=\"flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-medium\">2</span>\n                  <span>Откройте @BotFather в Telegram</span>\n                </li>\n                <li className=\"flex gap-2\">\n                  <span className=\"flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-medium\">3</span>\n                  <span>Отправьте команду <code className=\"bg-muted px-1 rounded\">/setuserpic</code></span>\n                </li>\n                <li className=\"flex gap-2\">\n                  <span className=\"flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-medium\">4</span>\n                  <span>Выберите вашего бота: <strong>@{botInfo.username}</strong></span>\n                </li>\n                <li className=\"flex gap-2\">\n                  <span className=\"flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-medium\">5</span>\n                  <span>Загрузите изображение как <strong>фото</strong> (не файл)</span>\n                </li>\n              </ol>\n            </div>\n\n            <div className=\"bg-yellow-50 dark:bg-yellow-950/30 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3\">\n              <p className=\"text-xs text-yellow-700 dark:text-yellow-300\">\n                <strong>Важно:</strong> Загружайте изображение как фото, а не как файл. \n                Квадратные изображения работают лучше всего.\n              </p>\n            </div>\n            \n            <div className=\"flex gap-2 justify-end\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowInstructions(false)}\n                data-testid=\"button-close-instructions\"\n              >\n                Понятно\n              </Button>\n              <Button\n                onClick={() => {\n                  window.open('https://t.me/botfather', '_blank');\n                }}\n                className=\"flex items-center gap-2\"\n                data-testid=\"button-open-botfather\"\n              >\n                <ExternalLink className=\"h-4 w-4\" />\n                Открыть BotFather\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n\n// Компонент для редактирования профиля бота\nfunction BotProfileEditor({ \n  projectId, \n  botInfo, \n  onProfileUpdated \n}: { \n  projectId: number; \n  botInfo?: BotInfo | null; \n  onProfileUpdated: () => void; \n}) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [name, setName] = useState('');\n  const [description, setDescription] = useState('');\n  const [shortDescription, setShortDescription] = useState('');\n  const [selectedAvatarFile, setSelectedAvatarFile] = useState<File | null>(null);\n\n  // Обновляем состояние когда botInfo загружается\n  useEffect(() => {\n    if (botInfo) {\n      setName(botInfo.first_name || '');\n      setDescription(botInfo.description || '');\n      setShortDescription(botInfo.short_description || '');\n    }\n  }, [botInfo]);\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Мутация для обновления имени бота\n  const updateNameMutation = useMutation({\n    mutationFn: async (newName: string) => {\n      const response = await apiRequest('PUT', `/api/projects/${projectId}/bot/name`, { name: newName });\n      return response;\n    },\n    onSuccess: async () => {\n      toast({\n        title: \"Успешно\",\n        description: \"Имя бота обновлено. Перезапускаем бота для применения изменений...\",\n      });\n      \n      try {\n        // Перезапускаем бота для применения нового имени\n        await apiRequest('POST', `/api/projects/${projectId}/bot/restart`);\n        \n        toast({\n          title: \"Готово!\",\n          description: \"Бот перезапущен с новым именем\",\n        });\n      } catch (error) {\n        // Если перезапуск не удался, просто обновляем данные\n        console.warn('Не удалось перезапустить бота:', error);\n      }\n      \n      // Принудительно обновляем данные бота с задержкой\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/info`] });\n      \n      // Ждем, чтобы изменения применились в Telegram API и бот перезапустился\n      setTimeout(async () => {\n        // Принудительно запрашиваем свежие данные, обходя кэш\n        try {\n          const freshBotInfo = await apiRequest('GET', `/api/projects/${projectId}/bot/info?_t=${Date.now()}`);\n          // Обновляем кэш вручную с новыми данными\n          queryClient.setQueryData([`/api/projects/${projectId}/bot/info`], freshBotInfo);\n        } catch (error) {\n          console.warn('Не удалось получить свежие данные бота:', error);\n        }\n        \n        queryClient.refetchQueries({ queryKey: [`/api/projects/${projectId}/bot/info`] });\n        onProfileUpdated();\n      }, 3000);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка\",\n        description: error.message || \"Не удалось обновить имя бота\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Мутация для обновления описания бота\n  const updateDescriptionMutation = useMutation({\n    mutationFn: async (newDescription: string) => {\n      const response = await apiRequest('PUT', `/api/projects/${projectId}/bot/description`, { description: newDescription });\n      return response;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Успешно\",\n        description: \"Описание бота обновлено\",\n      });\n      // Принудительно обновляем данные бота\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/info`] });\n      queryClient.refetchQueries({ queryKey: [`/api/projects/${projectId}/bot/info`] });\n      onProfileUpdated();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка\",\n        description: error.message || \"Не удалось обновить описание бота\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Мутация для обновления краткого описания бота\n  const updateShortDescriptionMutation = useMutation({\n    mutationFn: async (newShortDescription: string) => {\n      const response = await apiRequest('PUT', `/api/projects/${projectId}/bot/short-description`, { short_description: newShortDescription });\n      return response;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Успешно\",\n        description: \"Краткое описание бота обновлено\",\n      });\n      // Принудительно обновляем данные бота\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/info`] });\n      queryClient.refetchQueries({ queryKey: [`/api/projects/${projectId}/bot/info`] });\n      onProfileUpdated();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка\",\n        description: error.message || \"Не удалось обновить краткое описание бота\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSave = async () => {\n    if (!botInfo) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Информация о боте не загружена\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      // Обновляем только те поля, которые изменились\n      if (name !== botInfo.first_name) {\n        await updateNameMutation.mutateAsync(name);\n      }\n      if (description !== (botInfo.description || '')) {\n        await updateDescriptionMutation.mutateAsync(description);\n      }\n      if (shortDescription !== (botInfo.short_description || '')) {\n        await updateShortDescriptionMutation.mutateAsync(shortDescription);\n      }\n      \n      setIsOpen(false);\n      // Принудительно обновляем данные после сохранения всех изменений\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/info`] });\n      queryClient.refetchQueries({ queryKey: [`/api/projects/${projectId}/bot/info`] });\n    } catch (error) {\n      // Ошибки уже обработаны в мутациях\n    }\n  };\n\n  const handleCancel = () => {\n    // Сбрасываем значения к исходным\n    setName(botInfo?.first_name || '');\n    setDescription(botInfo?.description || '');\n    setShortDescription(botInfo?.short_description || '');\n    setIsOpen(false);\n  };\n\n  const isLoading = updateNameMutation.isPending || updateDescriptionMutation.isPending || updateShortDescriptionMutation.isPending;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button \n          variant=\"ghost\" \n          size=\"sm\" \n          className=\"h-8 w-8 p-0\" \n          data-testid=\"button-edit-bot-profile\"\n          disabled={!botInfo}\n          title={!botInfo ? \"Загрузка информации о боте...\" : \"Редактировать профиль бота\"}\n        >\n          <Edit2 className=\"h-4 w-4\" />\n        </Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle>Редактировать профиль бота</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4\">\n          {/* Компонент загрузки аватара */}\n          {botInfo && (\n            <BotAvatarUploader\n              botInfo={botInfo}\n              onAvatarSelected={setSelectedAvatarFile}\n            />\n          )}\n          \n          <Separator />\n          \n          <div className=\"space-y-2\">\n            <Label htmlFor=\"bot-name\">Имя бота</Label>\n            <Input\n              id=\"bot-name\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              placeholder=\"Введите имя бота\"\n              maxLength={64}\n            />\n            <p className=\"text-sm text-muted-foreground\">\n              Максимум 64 символа. Это имя будет отображаться в Telegram.\n            </p>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"bot-short-description\">Краткое описание</Label>\n            <Input\n              id=\"bot-short-description\"\n              value={shortDescription}\n              onChange={(e) => setShortDescription(e.target.value)}\n              placeholder=\"Краткое описание бота\"\n              maxLength={120}\n            />\n            <p className=\"text-sm text-muted-foreground\">\n              Максимум 120 символов. Отображается в профиле и предпросмотрах ссылок.\n            </p>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"bot-description\">Полное описание</Label>\n            <Textarea\n              id=\"bot-description\"\n              value={description}\n              onChange={(e) => setDescription(e.target.value)}\n              placeholder=\"Полное описание бота\"\n              maxLength={512}\n              rows={4}\n            />\n            <p className=\"text-sm text-muted-foreground\">\n              Максимум 512 символов. Отображается в пустых чатах с ботом.\n            </p>\n          </div>\n\n          <div className=\"flex gap-2 justify-end\">\n            <Button \n              variant=\"outline\" \n              onClick={handleCancel}\n              disabled={isLoading}\n            >\n              <X className=\"h-4 w-4 mr-2\" />\n              Отмена\n            </Button>\n            <Button \n              onClick={handleSave}\n              disabled={isLoading}\n            >\n              <Check className=\"h-4 w-4 mr-2\" />\n              {isLoading ? 'Сохранение...' : 'Сохранить'}\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\n// Компонент профиля бота\nfunction BotProfile({ \n  projectId,\n  botInfo, \n  onRefresh, \n  isRefreshing,\n  fallbackName = 'Бот'\n}: { \n  projectId: number;\n  botInfo?: BotInfo | null; \n  onRefresh: () => void; \n  isRefreshing: boolean; \n  fallbackName?: string;\n}) {\n  if (!botInfo) {\n    return (\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <BotAvatar \n                botName={fallbackName} \n                size={48}\n              />\n              <div>\n                <p className=\"text-sm text-muted-foreground\">\n                  Информация о боте недоступна\n                </p>\n                <p className=\"text-xs text-muted-foreground\">\n                  Запустите бота для получения данных\n                </p>\n              </div>\n            </div>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              onClick={onRefresh}\n              disabled={isRefreshing}\n              className=\"flex items-center gap-2\"\n            >\n              <RefreshCw className={`w-4 h-4 ${isRefreshing ? 'animate-spin' : ''}`} />\n              Обновить\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardContent className=\"p-6\">\n        <div className=\"flex items-start justify-between mb-4\">\n          <div className=\"flex items-center gap-4\">\n            <BotAvatar \n              photoUrl={botInfo.photoUrl} \n              botName={botInfo.first_name} \n              size={56}\n            />\n            <div className=\"flex-1\">\n              <h3 className=\"font-semibold text-lg leading-tight mb-1\">{botInfo.first_name}</h3>\n              <div className=\"flex items-center gap-2\">\n                <Badge variant=\"default\" className=\"text-xs\">\n                  @{botInfo.username}\n                </Badge>\n                {botInfo.is_bot && (\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    Бот\n                  </Badge>\n                )}\n              </div>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <BotProfileEditor \n              projectId={projectId} \n              botInfo={botInfo} \n              onProfileUpdated={onRefresh} \n            />\n            <Button \n              variant=\"ghost\" \n              size=\"sm\"\n              onClick={onRefresh}\n              disabled={isRefreshing}\n              title=\"Обновить информацию о боте\"\n            >\n              <RefreshCw className={`w-4 h-4 ${isRefreshing ? 'animate-spin' : ''}`} />\n            </Button>\n          </div>\n        </div>\n        \n        <div className=\"space-y-3\">\n          {/* Описание бота */}\n          {(botInfo.description || botInfo.short_description) && (\n            <div className=\"space-y-1\">\n              <p className=\"text-sm text-muted-foreground leading-relaxed\">\n                {botInfo.description || botInfo.short_description}\n              </p>\n            </div>\n          )}\n          \n          {/* Возможности бота */}\n          <div className=\"flex flex-wrap gap-2\">\n            {botInfo.can_join_groups && (\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                Может присоединяться к группам\n              </Badge>\n            )}\n            {botInfo.can_read_all_group_messages && (\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                Читает все сообщения\n              </Badge>\n            )}\n            {botInfo.supports_inline_queries && (\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                Поддерживает inline запросы\n              </Badge>\n            )}\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nexport function BotControl({ projectId, projectName }: BotControlProps) {\n  const [showAddBot, setShowAddBot] = useState(false);\n  const [newBotToken, setNewBotToken] = useState('');\n  const [isParsingBot, setIsParsingBot] = useState(false);\n  const [editingToken, setEditingToken] = useState<BotToken | null>(null);\n  const [editName, setEditName] = useState('');\n  const [editDescription, setEditDescription] = useState('');\n  \n  // Inline editing states\n  const [editingField, setEditingField] = useState<{tokenId: number, field: string} | null>(null);\n  const [editValue, setEditValue] = useState('');\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Mutation for updating bot information via Telegram API\n  const updateBotInfoMutation = useMutation({\n    mutationFn: async ({ tokenId, field, value }: { tokenId: number, field: string, value: string }) => {\n      const response = await apiRequest('PUT', `/api/projects/${projectId}/tokens/${tokenId}/bot-info`, { field, value });\n      return response;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/tokens`] });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot/info`] });\n      setEditingField(null);\n      toast({ title: 'Информация о боте обновлена', variant: 'default' });\n    },\n    onError: (error: any) => {\n      toast({ title: 'Ошибка обновления', description: error.message || 'Не удалось обновить информацию о боте', variant: 'destructive' });\n    }\n  });\n\n  // Handle inline editing\n  const handleStartEdit = (tokenId: number, field: string, currentValue: string) => {\n    setEditingField({ tokenId, field });\n    setEditValue(currentValue || '');\n  };\n\n  const handleSaveEdit = () => {\n    if (!editingField) return;\n    \n    const trimmedValue = editValue.trim();\n    if (trimmedValue) {\n      updateBotInfoMutation.mutate({\n        tokenId: editingField.tokenId,\n        field: editingField.field,\n        value: trimmedValue\n      });\n    } else {\n      setEditingField(null);\n    }\n  };\n\n  const handleCancelEdit = () => {\n    setEditingField(null);\n    setEditValue('');\n  };\n\n  // Получаем статус бота\n  const { data: botStatus, isLoading: isLoadingStatus } = useQuery<BotStatusResponse>({\n    queryKey: [`/api/projects/${projectId}/bot`],\n    refetchInterval: 10000, // Уменьшили с 1 секунды до 10 секунд\n    refetchIntervalInBackground: false, // Не опрашиваем в фоне\n    staleTime: 5000, // Считаем данные свежими 5 секунд\n  });\n\n  // Получаем все токены проекта (боты)\n  const { data: tokens = [], isLoading, refetch } = useQuery<BotToken[]>({\n    queryKey: [`/api/projects/${projectId}/tokens`],\n  });\n\n  // Получаем токен по умолчанию\n  const { data: defaultTokenData } = useQuery<DefaultTokenResponse>({\n    queryKey: [`/api/projects/${projectId}/tokens/default`],\n  });\n\n  // Получаем информацию о боте (getMe)\n  const { data: botInfo, refetch: refetchBotInfo } = useQuery<BotInfo>({\n    queryKey: [`/api/projects/${projectId}/bot/info`],\n    enabled: defaultTokenData?.hasDefault || tokens.length > 0,\n    refetchInterval: botStatus?.status === 'running' ? 60000 : false, // Увеличили с 30 секунд до 1 минуты\n    refetchIntervalInBackground: false, // Не опрашиваем в фоне\n    staleTime: 30000, // Считаем данные свежими 30 секунд\n  });\n\n  const isRunning = botStatus?.status === 'running';\n  const isError = botStatus?.status === 'error';\n  const isStopped = botStatus?.status === 'stopped' || !botStatus?.instance;\n\n  // Парсинг информации о боте по токену\n  const parseBotInfoMutation = useMutation({\n    mutationFn: async (token: string) => {\n      setIsParsingBot(true);\n      try {\n        return await apiRequest('POST', `/api/projects/${projectId}/tokens/parse`, { token });\n      } finally {\n        setIsParsingBot(false);\n      }\n    },\n    onSuccess: (botInfo) => {\n      // Автоматически создаем токен с полученной информацией\n      createBotMutation.mutate({\n        name: botInfo.botFirstName ? `${botInfo.botFirstName}${botInfo.botUsername ? ` (@${botInfo.botUsername})` : ''}` : `@${botInfo.botUsername}`,\n        token: newBotToken.trim(),\n        description: botInfo.botShortDescription,\n        isDefault: tokens.length === 0 ? 1 : 0, // Первый токен становится по умолчанию\n        isActive: 1,\n        // Добавляем всю спарсенную информацию о боте\n        ...botInfo\n      });\n    },\n    onError: (error: any) => {\n      setIsParsingBot(false);\n      toast({ \n        title: 'Ошибка получения информации о боте', \n        description: error.message || 'Проверьте правильность токена',\n        variant: 'destructive' \n      });\n    }\n  });\n\n  // Создание бота/токена\n  const createBotMutation = useMutation({\n    mutationFn: async (botData: { \n      name: string; \n      token: string; \n      description?: string;\n      isDefault: number; \n      isActive: number;\n      botFirstName?: string;\n      botUsername?: string;\n      botDescription?: string;\n      botShortDescription?: string;\n      botPhotoUrl?: string;\n      botCanJoinGroups?: number;\n      botCanReadAllGroupMessages?: number;\n      botSupportsInlineQueries?: number;\n      botHasMainWebApp?: number;\n    }) => {\n      return apiRequest('POST', `/api/projects/${projectId}/tokens`, { \n        ...botData, \n        projectId \n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/tokens`] });\n      toast({ \n        title: 'Бот успешно добавлен',\n        description: 'Информация о боте автоматически получена из Telegram'\n      });\n      setShowAddBot(false);\n      setNewBotToken('');\n    },\n    onError: (error: any) => {\n      toast({ title: 'Ошибка при добавлении бота', description: error.message, variant: 'destructive' });\n    }\n  });\n\n  // Удаление бота/токена\n  const deleteBotMutation = useMutation({\n    mutationFn: async (tokenId: number) => {\n      return apiRequest('DELETE', `/api/projects/${projectId}/tokens/${tokenId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/tokens`] });\n      toast({ title: 'Бот удален' });\n    },\n    onError: (error: any) => {\n      toast({ title: 'Ошибка при удалении бота', description: error.message, variant: 'destructive' });\n    }\n  });\n\n  // Обновление информации о токене\n  const updateTokenMutation = useMutation({\n    mutationFn: async ({ tokenId, data }: { tokenId: number; data: { name?: string; description?: string } }) => {\n      return apiRequest('PUT', `/api/projects/${projectId}/tokens/${tokenId}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/tokens`] });\n      toast({ title: 'Информация о боте обновлена' });\n      setEditingToken(null);\n    },\n    onError: (error: any) => {\n      toast({ title: 'Ошибка при обновлении', description: error.message, variant: 'destructive' });\n    }\n  });\n\n  // Запуск бота\n  const startBotMutation = useMutation({\n    mutationFn: async (tokenId: number) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/start`, { tokenId });\n    },\n    onSuccess: () => {\n      toast({ title: \"Бот запущен\", description: \"Бот успешно запущен и готов к работе.\" });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot`] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Ошибка запуска\", description: error.message || \"Не удалось запустить бота.\", variant: \"destructive\" });\n    },\n  });\n\n  // Остановка бота\n  const stopBotMutation = useMutation({\n    mutationFn: async (tokenId: number) => {\n      return apiRequest('POST', `/api/projects/${projectId}/bot/stop`, { tokenId });\n    },\n    onSuccess: () => {\n      toast({ title: \"Бот остановлен\", description: \"Бот успешно остановлен.\" });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/bot`] });\n    },\n    onError: (error: any) => {\n      toast({ title: \"Ошибка остановки\", description: error.message || \"Не удалось остановить бота.\", variant: \"destructive\" });\n    },\n  });\n\n  const handleAddBot = () => {\n    if (!newBotToken.trim()) {\n      toast({\n        title: \"Требуется токен\",\n        description: \"Введите токен бота.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Сначала получаем информацию о боте, затем создаем токен\n    parseBotInfoMutation.mutate(newBotToken.trim());\n  };\n\n  const getStatusBadge = (token: BotToken) => {\n    // Проверяем, что именно этот токен запущен\n    const isActiveBot = botStatus?.instance && \n                       isRunning && \n                       botStatus.instance.tokenId === token.id;\n    \n    if (isActiveBot) {\n      return (\n        <Badge variant=\"default\" className=\"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 border-green-200 dark:border-green-800\">\n          <div className=\"flex items-center gap-1\">\n            <div className=\"w-2 h-2 bg-green-500 rounded-full animate-pulse\" />\n            Активный\n          </div>\n        </Badge>\n      );\n    }\n    \n    if (token.isDefault) {\n      return (\n        <Badge variant=\"secondary\">\n          По умолчанию\n        </Badge>\n      );\n    }\n    \n    return (\n      <Badge variant=\"outline\">\n        Готов\n      </Badge>\n    );\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold tracking-tight flex items-center gap-2\">\n            <Bot className=\"w-6 h-6\" />\n            Боты\n          </h2>\n          <p className=\"text-muted-foreground\">\n            Управление ботами проекта {projectName}\n          </p>\n        </div>\n        <Button onClick={() => setShowAddBot(true)} className=\"flex items-center gap-2\">\n          <Plus className=\"w-4 h-4\" />\n          Подключить бот\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid gap-4\">\n          {[1, 2].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center space-x-4\">\n                  <div className=\"w-12 h-12 bg-muted rounded-lg\" />\n                  <div className=\"space-y-2 flex-1\">\n                    <div className=\"h-4 bg-muted rounded w-1/4\" />\n                    <div className=\"h-3 bg-muted rounded w-1/2\" />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : tokens.length === 0 ? (\n        <Card className=\"border-dashed\">\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <Bot className=\"w-12 h-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">Нет подключенных ботов</h3>\n            <p className=\"text-muted-foreground text-center mb-4\">\n              Подключите первого бота, чтобы начать создание Telegram-ботов\n            </p>\n            <Button onClick={() => setShowAddBot(true)} className=\"flex items-center gap-2\">\n              <Plus className=\"w-4 h-4\" />\n              Подключить бота\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4\">\n          {tokens.map((token) => (\n            <Card key={token.id} className=\"transition-all hover:shadow-md\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-4\">\n                    <BotAvatar \n                      botName={token.botFirstName || token.name} \n                      photoUrl={token.botPhotoUrl}\n                      size={48}\n                    />\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        {editingField?.tokenId === token.id && editingField?.field === 'name' ? (\n                          <Input\n                            value={editValue}\n                            onChange={(e) => setEditValue(e.target.value)}\n                            onKeyDown={(e) => {\n                              if (e.key === 'Enter') {\n                                handleSaveEdit();\n                              } else if (e.key === 'Escape') {\n                                handleCancelEdit();\n                              }\n                            }}\n                            onBlur={handleSaveEdit}\n                            autoFocus\n                            className=\"font-semibold text-lg leading-tight h-auto px-2 py-1\"\n                            data-testid=\"input-bot-name-edit\"\n                          />\n                        ) : (\n                          <h3 \n                            className=\"font-semibold text-lg leading-tight cursor-pointer hover:bg-muted/50 px-2 py-1 rounded transition-colors\"\n                            onDoubleClick={() => handleStartEdit(token.id, 'name', token.botFirstName || token.name)}\n                            title=\"Двойной клик для редактирования\"\n                            data-testid=\"text-bot-name\"\n                          >\n                            {token.botFirstName || token.name}\n                          </h3>\n                        )}\n                        {token.botUsername && (\n                          <span className=\"text-sm text-muted-foreground\">@{token.botUsername}</span>\n                        )}\n                      </div>\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        {getStatusBadge(token)}\n                      </div>\n                      {(token.botDescription || token.description) && (\n                        editingField?.tokenId === token.id && editingField?.field === 'description' ? (\n                          <Textarea\n                            value={editValue}\n                            onChange={(e) => setEditValue(e.target.value)}\n                            onKeyDown={(e) => {\n                              if (e.key === 'Enter' && !e.shiftKey) {\n                                e.preventDefault();\n                                handleSaveEdit();\n                              } else if (e.key === 'Escape') {\n                                handleCancelEdit();\n                              }\n                            }}\n                            onBlur={handleSaveEdit}\n                            autoFocus\n                            className=\"text-sm resize-none min-h-[40px]\"\n                            rows={2}\n                            data-testid=\"textarea-bot-description-edit\"\n                          />\n                        ) : (\n                          <p \n                            className=\"text-sm text-muted-foreground mb-1 cursor-pointer hover:bg-muted/50 px-2 py-1 rounded transition-colors\"\n                            onDoubleClick={() => handleStartEdit(token.id, 'description', token.botDescription || token.description || '')}\n                            title=\"Двойной клик для редактирования\"\n                            data-testid=\"text-bot-description\"\n                          >\n                            {token.botDescription || token.description}\n                          </p>\n                        )\n                      )}\n                      {token.botShortDescription && token.botShortDescription !== token.botDescription && (\n                        editingField?.tokenId === token.id && editingField?.field === 'shortDescription' ? (\n                          <Input\n                            value={editValue}\n                            onChange={(e) => setEditValue(e.target.value)}\n                            onKeyDown={(e) => {\n                              if (e.key === 'Enter') {\n                                handleSaveEdit();\n                              } else if (e.key === 'Escape') {\n                                handleCancelEdit();\n                              }\n                            }}\n                            onBlur={handleSaveEdit}\n                            autoFocus\n                            className=\"text-xs h-auto px-2 py-1 mb-1\"\n                            data-testid=\"input-bot-short-description-edit\"\n                          />\n                        ) : (\n                          <p \n                            className=\"text-xs text-muted-foreground mb-1 cursor-pointer hover:bg-muted/50 px-2 py-1 rounded transition-colors\"\n                            onDoubleClick={() => handleStartEdit(token.id, 'shortDescription', token.botShortDescription || '')}\n                            title=\"Двойной клик для редактирования\"\n                            data-testid=\"text-bot-short-description\"\n                          >\n                            {token.botShortDescription}\n                          </p>\n                        )\n                      )}\n                      <p className=\"text-xs text-muted-foreground\">\n                        Добавлен: {new Date(token.createdAt!).toLocaleDateString('ru-RU')}\n                        {token.lastUsedAt && (\n                          <> • Последний запуск: {new Date(token.lastUsedAt).toLocaleDateString('ru-RU')}</>\n                        )}\n                      </p>\n                    </div>\n                  </div>\n                  \n                  <div className=\"flex items-center gap-2\">\n                    {/* Кнопка редактирования профиля бота - показываем всегда */}\n                    <BotProfileEditor \n                      projectId={projectId} \n                      botInfo={botInfo} \n                      onProfileUpdated={refetchBotInfo} \n                    />\n                    \n                    {/* Проверяем статус конкретного токена */}\n                    {(() => {\n                      const isThisTokenRunning = botStatus?.instance && \n                                                isRunning && \n                                                botStatus.instance.tokenId === token.id;\n                      \n                      if (!isThisTokenRunning) {\n                        return (\n                          <Button\n                            size=\"sm\"\n                            onClick={() => startBotMutation.mutate(token.id)}\n                            disabled={startBotMutation.isPending}\n                            className=\"flex items-center gap-2\"\n                          >\n                            <Play className=\"w-4 h-4\" />\n                            {startBotMutation.isPending ? 'Запуск...' : 'Запустить'}\n                          </Button>\n                        );\n                      } else {\n                        return (\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => stopBotMutation.mutate(token.id)}\n                            disabled={stopBotMutation.isPending}\n                            className=\"flex items-center gap-2\"\n                          >\n                            <Square className=\"w-4 h-4\" />\n                            {stopBotMutation.isPending ? 'Остановка...' : 'Остановить'}\n                          </Button>\n                        );\n                      }\n                    })()}\n                    \n                    <DropdownMenu>\n                      <DropdownMenuTrigger asChild>\n                        <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\" data-testid=\"button-bot-menu\">\n                          <MoreHorizontal className=\"h-4 w-4\" />\n                        </Button>\n                      </DropdownMenuTrigger>\n                      <DropdownMenuContent align=\"end\">\n                        <DropdownMenuItem \n                          onClick={() => deleteBotMutation.mutate(token.id)}\n                          className=\"text-red-600\"\n                        >\n                          <Trash2 className=\"mr-2 h-4 w-4\" />\n                          Удалить\n                        </DropdownMenuItem>\n                      </DropdownMenuContent>\n                    </DropdownMenu>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      {/* Add Bot Dialog */}\n      <Dialog open={showAddBot} onOpenChange={setShowAddBot}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Подключить бота</DialogTitle>\n            <DialogDescription>\n              Добавьте нового бота, используя токен от @BotFather\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"bot-token\">Токен бота</Label>\n              <Input\n                id=\"bot-token\"\n                type=\"password\"\n                placeholder=\"Вставьте токен от @BotFather\"\n                value={newBotToken}\n                onChange={(e) => setNewBotToken(e.target.value)}\n                disabled={isParsingBot || createBotMutation.isPending}\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Получите токен у @BotFather в Telegram: /newbot\n              </p>\n              {isParsingBot && (\n                <p className=\"text-xs text-blue-600 dark:text-blue-400\">\n                  Получаем информацию о боте...\n                </p>\n              )}\n            </div>\n          </div>\n          \n          <div className=\"flex gap-2 justify-end\">\n            <Button variant=\"outline\" onClick={() => setShowAddBot(false)}>\n              Отмена\n            </Button>\n            <Button \n              onClick={handleAddBot}\n              disabled={isParsingBot || createBotMutation.isPending || !newBotToken.trim()}\n            >\n              {isParsingBot ? 'Проверка токена...' : createBotMutation.isPending ? 'Добавление...' : 'Добавить бота'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Bot Token Dialog */}\n      <Dialog open={!!editingToken} onOpenChange={() => setEditingToken(null)}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Редактировать токен</DialogTitle>\n            <DialogDescription>\n              Изменить настройки токена бота\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-bot-name\">Имя токена</Label>\n              <Input\n                id=\"edit-bot-name\"\n                placeholder=\"Имя для токена (например: Основной бот)\"\n                value={editName}\n                onChange={(e) => setEditName(e.target.value)}\n                disabled={updateTokenMutation.isPending}\n                data-testid=\"input-edit-bot-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-bot-description\">Описание</Label>\n              <Textarea\n                id=\"edit-bot-description\"\n                placeholder=\"Описание бота (необязательно)\"\n                value={editDescription}\n                onChange={(e) => setEditDescription(e.target.value)}\n                disabled={updateTokenMutation.isPending}\n                rows={3}\n                data-testid=\"textarea-edit-bot-description\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"flex gap-2 justify-end\">\n            <Button \n              variant=\"outline\" \n              onClick={() => setEditingToken(null)}\n              disabled={updateTokenMutation.isPending}\n              data-testid=\"button-cancel-edit\"\n            >\n              Отмена\n            </Button>\n            <Button \n              onClick={() => {\n                if (editingToken) {\n                  updateTokenMutation.mutate({\n                    tokenId: editingToken.id,\n                    data: {\n                      name: editName.trim() || editingToken.name,\n                      description: editDescription.trim() || undefined\n                    }\n                  });\n                }\n              }}\n              disabled={updateTokenMutation.isPending || !editName.trim()}\n              data-testid=\"button-save-edit\"\n            >\n              {updateTokenMutation.isPending ? 'Сохранение...' : 'Сохранить'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","size_bytes":53042},"client/src/components/editor/database-backup-panel.tsx":{"content":"import { useState } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Switch } from '@/components/ui/switch';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { useToast } from '@/hooks/use-toast';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { \n  Download, \n  Upload, \n  Database, \n  Shield, \n  Trash2, \n  RefreshCw, \n  FileText, \n  Calendar, \n  HardDrive, \n  BarChart3,\n  AlertTriangle,\n  CheckCircle,\n  Archive,\n  CloudDownload,\n  Plus\n} from 'lucide-react';\n\ninterface BackupFile {\n  filename: string;\n  filepath: string;\n  size: number;\n  created: Date;\n  metadata?: {\n    version: string;\n    timestamp: string;\n    description?: string;\n    tables: string[];\n  };\n}\n\ninterface DatabaseStats {\n  tables: Array<{\n    name: string;\n    count: number;\n    size: string;\n  }>;\n  totalRecords: number;\n  estimatedSize: string;\n}\n\nexport function DatabaseBackupPanel() {\n  const [newBackupDescription, setNewBackupDescription] = useState('');\n  const [uploadFile, setUploadFile] = useState<File | null>(null);\n  const [restoreImmediately, setRestoreImmediately] = useState(false);\n  const [clearExisting, setClearExisting] = useState(false);\n  const [isUploading, setIsUploading] = useState(false);\n  const [showBackupDialog, setShowBackupDialog] = useState(false);\n  const [showUploadDialog, setShowUploadDialog] = useState(false);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Получить список резервных копий\n  const { data: backupsData, isLoading: backupsLoading } = useQuery({\n    queryKey: ['database/backups'],\n    queryFn: () => apiRequest('GET', '/api/database/backups'),\n    staleTime: 30000\n  });\n\n  // Получить статистику базы данных\n  const { data: statsData, isLoading: statsLoading } = useQuery({\n    queryKey: ['database/stats'],\n    queryFn: () => apiRequest('GET', '/api/database/stats/detailed'),\n    staleTime: 60000\n  });\n\n  // Мутация для создания резервной копии\n  const createBackupMutation = useMutation({\n    mutationFn: (description: string) => \n      apiRequest('POST', '/api/database/backup', { description }),\n    onSuccess: () => {\n      toast({\n        title: \"Резервная копия создана\",\n        description: \"Резервная копия базы данных создана успешно\"\n      });\n      queryClient.invalidateQueries({ queryKey: ['database/backups'] });\n      setNewBackupDescription('');\n      setShowBackupDialog(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка создания резервной копии\",\n        description: error.message || \"Не удалось создать резервную копию\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Мутация для восстановления из резервной копии\n  const restoreBackupMutation = useMutation({\n    mutationFn: ({ filename, options }: { filename: string; options: any }) => \n      apiRequest('POST', '/api/database/restore', { filename, options }),\n    onSuccess: () => {\n      toast({\n        title: \"База данных восстановлена\",\n        description: \"База данных успешно восстановлена из резервной копии\"\n      });\n      queryClient.invalidateQueries({ queryKey: ['database/stats'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка восстановления\",\n        description: error.message || \"Не удалось восстановить базу данных\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Мутация для удаления резервной копии\n  const deleteBackupMutation = useMutation({\n    mutationFn: (filename: string) => \n      apiRequest('DELETE', `/api/database/backup/${filename}`),\n    onSuccess: () => {\n      toast({\n        title: \"Резервная копия удалена\",\n        description: \"Резервная копия успешно удалена\"\n      });\n      queryClient.invalidateQueries({ queryKey: ['database/backups'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка удаления\",\n        description: error.message || \"Не удалось удалить резервную копию\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Обработчик загрузки файла\n  const handleFileUpload = async () => {\n    if (!uploadFile) return;\n\n    setIsUploading(true);\n    try {\n      const formData = new FormData();\n      formData.append('backup', uploadFile);\n      formData.append('restoreImmediately', restoreImmediately.toString());\n      formData.append('clearExisting', clearExisting.toString());\n\n      const response = await fetch('/api/database/backup/upload', {\n        method: 'POST',\n        body: formData\n      });\n\n      const result = await response.json();\n      \n      if (result.success) {\n        toast({\n          title: \"Файл загружен\",\n          description: result.message\n        });\n        queryClient.invalidateQueries({ queryKey: ['database/backups'] });\n        if (result.restored) {\n          queryClient.invalidateQueries({ queryKey: ['database/stats'] });\n        }\n        setShowUploadDialog(false);\n      } else {\n        throw new Error(result.error || 'Не удалось загрузить файл');\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Ошибка загрузки\",\n        description: error.message || \"Не удалось загрузить файл\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsUploading(false);\n      setUploadFile(null);\n    }\n  };\n\n  // Обработчик скачивания резервной копии\n  const handleDownloadBackup = (filename: string) => {\n    const downloadUrl = `/api/database/backup/${filename}`;\n    const link = document.createElement('a');\n    link.href = downloadUrl;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  };\n\n  // Форматирование размера файла\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  const backups: BackupFile[] = backupsData?.backups || [];\n  const stats: DatabaseStats = statsData?.stats || { tables: [], totalRecords: 0, estimatedSize: 'N/A' };\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Заголовок и кнопки действий */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n            <Archive className=\"w-5 h-5\" />\n            Резервные копии\n          </h3>\n          <p className=\"text-sm text-muted-foreground\">\n            Управление резервными копиями базы данных\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Dialog open={showBackupDialog} onOpenChange={setShowBackupDialog}>\n            <DialogTrigger asChild>\n              <Button size=\"sm\" variant=\"outline\">\n                <Plus className=\"w-4 h-4 mr-1\" />\n                Создать\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Создать резервную копию</DialogTitle>\n                <DialogDescription>\n                  Создание полной резервной копии базы данных\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"backup-description\">Описание резервной копии</Label>\n                  <Textarea\n                    id=\"backup-description\"\n                    placeholder=\"Опишите цель создания резервной копии...\"\n                    value={newBackupDescription}\n                    onChange={(e) => setNewBackupDescription(e.target.value)}\n                    rows={3}\n                  />\n                </div>\n                <Button \n                  onClick={() => createBackupMutation.mutate(newBackupDescription)}\n                  disabled={createBackupMutation.isPending}\n                  className=\"w-full\"\n                >\n                  {createBackupMutation.isPending ? (\n                    <RefreshCw className=\"w-4 h-4 animate-spin mr-2\" />\n                  ) : (\n                    <Archive className=\"w-4 h-4 mr-2\" />\n                  )}\n                  Создать резервную копию\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n\n          <Dialog open={showUploadDialog} onOpenChange={setShowUploadDialog}>\n            <DialogTrigger asChild>\n              <Button size=\"sm\" variant=\"outline\">\n                <Upload className=\"w-4 h-4 mr-1\" />\n                Загрузить\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Загрузить резервную копию</DialogTitle>\n                <DialogDescription>\n                  Загрузка резервной копии из файла\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"backup-file\">Выберите файл резервной копии</Label>\n                  <Input\n                    id=\"backup-file\"\n                    type=\"file\"\n                    accept=\".json\"\n                    onChange={(e) => setUploadFile(e.target.files?.[0] || null)}\n                  />\n                </div>\n                \n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Switch\n                      id=\"restore-immediately\"\n                      checked={restoreImmediately}\n                      onCheckedChange={setRestoreImmediately}\n                    />\n                    <Label htmlFor=\"restore-immediately\">Восстановить немедленно</Label>\n                  </div>\n                  \n                  {restoreImmediately && (\n                    <div className=\"flex items-center space-x-2 ml-6\">\n                      <Switch\n                        id=\"clear-existing\"\n                        checked={clearExisting}\n                        onCheckedChange={setClearExisting}\n                      />\n                      <Label htmlFor=\"clear-existing\">Очистить существующие данные</Label>\n                    </div>\n                  )}\n                </div>\n\n                <Button \n                  onClick={handleFileUpload}\n                  disabled={!uploadFile || isUploading}\n                  className=\"w-full\"\n                >\n                  {isUploading ? (\n                    <RefreshCw className=\"w-4 h-4 animate-spin mr-2\" />\n                  ) : (\n                    <CloudDownload className=\"w-4 h-4 mr-2\" />\n                  )}\n                  Загрузить файл\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      {/* Статистика базы данных */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-sm\">\n            <BarChart3 className=\"w-4 h-4\" />\n            Статистика базы данных\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {statsLoading ? (\n            <div className=\"flex items-center gap-2 text-sm\">\n              <RefreshCw className=\"w-4 h-4 animate-spin\" />\n              Загрузка статистики...\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              <div className=\"grid grid-cols-3 gap-3\">\n                <div className=\"text-center\">\n                  <div className=\"text-lg font-bold\">{stats.totalRecords.toLocaleString()}</div>\n                  <div className=\"text-xs text-muted-foreground\">Записи</div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"text-lg font-bold\">{stats.tables.length}</div>\n                  <div className=\"text-xs text-muted-foreground\">Таблицы</div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"text-lg font-bold\">{stats.estimatedSize}</div>\n                  <div className=\"text-xs text-muted-foreground\">Размер</div>\n                </div>\n              </div>\n              \n              <Separator />\n              \n              <div className=\"space-y-2\">\n                <div className=\"text-sm font-medium\">Таблицы:</div>\n                <div className=\"space-y-1\">\n                  {stats.tables.map((table, index) => (\n                    <div key={index} className=\"flex items-center justify-between text-xs\">\n                      <div className=\"flex items-center gap-1\">\n                        <FileText className=\"w-3 h-3\" />\n                        <span>{table.name}</span>\n                      </div>\n                      <span className=\"text-muted-foreground\">{table.count.toLocaleString()}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Список резервных копий */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-sm\">\n            <Archive className=\"w-4 h-4\" />\n            Список резервных копий ({backups.length})\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {backupsLoading ? (\n            <div className=\"flex items-center gap-2 text-sm\">\n              <RefreshCw className=\"w-4 h-4 animate-spin\" />\n              Загрузка списка резервных копий...\n            </div>\n          ) : backups.length === 0 ? (\n            <div className=\"text-center py-6 text-muted-foreground\">\n              <Archive className=\"w-8 h-8 mx-auto mb-2 opacity-50\" />\n              <p className=\"text-sm\">Резервные копии не найдены</p>\n              <p className=\"text-xs\">Создайте первую резервную копию</p>\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {backups.map((backup, index) => (\n                <div key={index} className=\"p-3 border rounded-lg\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <FileText className=\"w-3 h-3 flex-shrink-0\" />\n                        <span className=\"text-sm font-medium truncate\">{backup.filename}</span>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {backup.metadata?.version || 'v1.0.0'}\n                        </Badge>\n                      </div>\n                      <div className=\"text-xs text-muted-foreground space-y-1\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"flex items-center gap-1\">\n                            <Calendar className=\"w-3 h-3\" />\n                            {new Date(backup.created).toLocaleDateString()}\n                          </div>\n                          <div className=\"flex items-center gap-1\">\n                            <HardDrive className=\"w-3 h-3\" />\n                            {formatFileSize(backup.size)}\n                          </div>\n                        </div>\n                        {backup.metadata?.description && (\n                          <p className=\"text-xs truncate\">{backup.metadata.description}</p>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"ghost\"\n                        onClick={() => handleDownloadBackup(backup.filename)}\n                      >\n                        <Download className=\"w-3 h-3\" />\n                      </Button>\n                      <Dialog>\n                        <DialogTrigger asChild>\n                          <Button size=\"sm\" variant=\"ghost\">\n                            <RefreshCw className=\"w-3 h-3\" />\n                          </Button>\n                        </DialogTrigger>\n                        <DialogContent>\n                          <DialogHeader>\n                            <DialogTitle>Восстановить базу данных</DialogTitle>\n                            <DialogDescription>\n                              Восстановление из резервной копии {backup.filename}\n                            </DialogDescription>\n                          </DialogHeader>\n                          <div className=\"space-y-4\">\n                            <div className=\"flex items-center space-x-2\">\n                              <Switch\n                                id=\"restore-clear\"\n                                checked={clearExisting}\n                                onCheckedChange={setClearExisting}\n                              />\n                              <Label htmlFor=\"restore-clear\">Очистить существующие данные</Label>\n                            </div>\n                            <div className=\"flex items-center gap-2 p-3 bg-muted rounded-lg\">\n                              <AlertTriangle className=\"w-4 h-4 text-orange-500\" />\n                              <span className=\"text-sm\">\n                                Эта операция изменит текущие данные в базе\n                              </span>\n                            </div>\n                            <Button\n                              onClick={() => restoreBackupMutation.mutate({ \n                                filename: backup.filename, \n                                options: { clearExisting } \n                              })}\n                              disabled={restoreBackupMutation.isPending}\n                              className=\"w-full\"\n                            >\n                              {restoreBackupMutation.isPending ? (\n                                <RefreshCw className=\"w-4 h-4 animate-spin mr-2\" />\n                              ) : (\n                                <CheckCircle className=\"w-4 h-4 mr-2\" />\n                              )}\n                              Восстановить\n                            </Button>\n                          </div>\n                        </DialogContent>\n                      </Dialog>\n                      <Button\n                        size=\"sm\"\n                        variant=\"ghost\"\n                        onClick={() => deleteBackupMutation.mutate(backup.filename)}\n                        disabled={deleteBackupMutation.isPending}\n                      >\n                        <Trash2 className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":20591},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/editor/inline-rich-editor.tsx":{"content":"import { useState, useRef, useEffect, useCallback } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Label } from '@/components/ui/label';\nimport { Badge } from '@/components/ui/badge';\nimport { Switch } from '@/components/ui/switch';\nimport { \n  Bold, \n  Italic, \n  Underline, \n  Strikethrough, \n  Code, \n  Type,\n  Quote,\n  Heading3,\n  Link,\n  List,\n  ListOrdered,\n  RotateCcw,\n  RotateCw,\n  Copy,\n  Sparkles,\n  Plus,\n  Image,\n  Video,\n  Music,\n  FileText\n} from 'lucide-react';\nimport { \n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n  DropdownMenuLabel\n} from '@/components/ui/dropdown-menu';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface Variable {\n  name: string;\n  nodeId: string;\n  nodeType: string;\n  description?: string;\n  mediaType?: string;\n}\n\ninterface InlineRichEditorProps {\n  value: string;\n  onChange: (value: string) => void;\n  placeholder?: string;\n  enableMarkdown?: boolean;\n  onMarkdownToggle?: (enabled: boolean) => void;\n  onFormatModeChange?: (formatMode: 'html' | 'markdown' | 'none') => void;\n  availableVariables?: Variable[];\n  onMediaVariableSelect?: (variableName: string, mediaType: string) => void;\n}\n\nexport function InlineRichEditor({\n  value,\n  onChange,\n  placeholder = \"Введите текст сообщения...\",\n  enableMarkdown = false,\n  onMarkdownToggle,\n  onFormatModeChange,\n  availableVariables = [],\n  onMediaVariableSelect\n}: InlineRichEditorProps) {\n  const [wordCount, setWordCount] = useState(0);\n  const [charCount, setCharCount] = useState(0);\n  const [undoStack, setUndoStack] = useState<string[]>([]);\n  const [redoStack, setRedoStack] = useState<string[]>([]);\n  const [isFormatting, setIsFormatting] = useState(false);\n  const editorRef = useRef<HTMLDivElement>(null);\n  const { toast } = useToast();\n\n  // Save state to undo stack\n  const saveToUndoStack = useCallback(() => {\n    setUndoStack(prev => [...prev.slice(-19), value]);\n    setRedoStack([]);\n  }, [value]);\n\n  // Update word and character counts\n  useEffect(() => {\n    const plainText = value.replace(/<[^>]*>/g, '').replace(/\\*\\*|__|~~|`/g, '');\n    const words = plainText.trim().split(/\\s+/).filter(word => word.length > 0);\n    setWordCount(words.length);\n    setCharCount(plainText.length);\n  }, [value]);\n\n  // Convert value to display HTML\n  const valueToHtml = useCallback((text: string) => {\n    if (!text) return '';\n    \n    let html = text;\n    \n    if (enableMarkdown) {\n      // Convert markdown to HTML for contenteditable\n      html = html\n        .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\n        .replace(/(?<!\\*)\\*([^*]+)\\*(?!\\*)/g, '<em>$1</em>')\n        .replace(/__(.*?)__/g, '<u>$1</u>')\n        .replace(/~~(.*?)~~/g, '<s>$1</s>')\n        .replace(/`([^`]+)`/g, '<code class=\"bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-xs font-mono\">$1</code>')\n        .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')\n        .replace(/^# (.+)$/gm, '<h3>$1</h3>')\n        .replace(/^## (.+)$/gm, '<h4>$1</h4>')\n        .replace(/^### (.+)$/gm, '<h5>$1</h5>')\n        .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href=\"$2\">$1</a>')\n        .replace(/\\n/g, '<br>');\n    } else {\n      // For HTML mode, just convert newlines to br tags\n      html = html.replace(/\\n/g, '<br>');\n    }\n    \n    return html;\n  }, [enableMarkdown]);\n\n  // Convert display HTML back to value\n  const htmlToValue = useCallback((html: string) => {\n    if (!html) return '';\n    \n    let text = html;\n    \n    if (enableMarkdown) {\n      // Convert HTML back to markdown\n      text = text\n        .replace(/<strong[^>]*>(.*?)<\\/strong>/g, '**$1**')\n        .replace(/<em[^>]*>(.*?)<\\/em>/g, '*$1*')\n        .replace(/<u[^>]*>(.*?)<\\/u>/g, '__$1__')\n        .replace(/<s[^>]*>(.*?)<\\/s>/g, '~~$1~~')\n        .replace(/<code[^>]*>(.*?)<\\/code>/g, '`$1`')\n        .replace(/<blockquote[^>]*>(.*?)<\\/blockquote>/g, '> $1')\n        .replace(/<h3[^>]*>(.*?)<\\/h3>/g, '# $1')\n        .replace(/<h4[^>]*>(.*?)<\\/h4>/g, '## $1')\n        .replace(/<h5[^>]*>(.*?)<\\/h5>/g, '### $1')\n        .replace(/<a[^>]*href=\"([^\"]*)\"[^>]*>(.*?)<\\/a>/g, '[$2]($1)')\n        .replace(/<br\\s*\\/?>/g, '\\n')\n        .replace(/<div[^>]*>/g, '\\n')\n        .replace(/<\\/div>/g, '');\n    } else {\n      // For HTML mode, just convert br tags to newlines\n      text = text\n        .replace(/<br\\s*\\/?>/g, '\\n')\n        .replace(/<div[^>]*>/g, '\\n')\n        .replace(/<\\/div>/g, '');\n    }\n    \n    return text;\n  }, [enableMarkdown]);\n\n  // Update editor content when value changes\n  useEffect(() => {\n    if (editorRef.current && !isFormatting) {\n      const html = valueToHtml(value);\n      if (editorRef.current.innerHTML !== html) {\n        // Save current selection\n        const selection = window.getSelection();\n        let range = null;\n        let offset = 0;\n        \n        if (selection && selection.rangeCount > 0) {\n          try {\n            range = selection.getRangeAt(0);\n            offset = range.startOffset;\n          } catch (e) {\n            // Ignore selection errors\n          }\n        }\n        \n        editorRef.current.innerHTML = html;\n        \n        // Restore selection\n        if (range && selection) {\n          try {\n            const newRange = document.createRange();\n            const walker = document.createTreeWalker(\n              editorRef.current,\n              NodeFilter.SHOW_TEXT,\n              null,\n              false\n            );\n            \n            let currentOffset = 0;\n            let targetNode = null;\n            \n            while (walker.nextNode()) {\n              const node = walker.currentNode;\n              const nodeLength = node.textContent?.length || 0;\n              \n              if (currentOffset + nodeLength >= offset) {\n                targetNode = node;\n                break;\n              }\n              currentOffset += nodeLength;\n            }\n            \n            if (targetNode) {\n              newRange.setStart(targetNode, Math.min(offset - currentOffset, targetNode.textContent?.length || 0));\n              newRange.collapse(true);\n              selection.removeAllRanges();\n              selection.addRange(newRange);\n            }\n          } catch (e) {\n            // Ignore range errors\n          }\n        }\n      }\n    }\n  }, [value, valueToHtml, isFormatting]);\n\n  // Handle input in contenteditable\n  const handleInput = useCallback(() => {\n    if (editorRef.current) {\n      setIsFormatting(true);\n      const html = editorRef.current.innerHTML;\n      const text = htmlToValue(html);\n      onChange(text);\n      setTimeout(() => setIsFormatting(false), 0);\n    }\n  }, [onChange, htmlToValue]);\n\n  // Format options\n  const formatOptions = [\n    { \n      command: 'bold', \n      icon: Bold, \n      name: 'Жирный', \n      shortcut: 'Ctrl+B',\n      markdown: '**текст**',\n      html: '<strong>текст</strong>'\n    },\n    { \n      command: 'italic', \n      icon: Italic, \n      name: 'Курсив', \n      shortcut: 'Ctrl+I',\n      markdown: '*текст*',\n      html: '<em>текст</em>'\n    },\n    { \n      command: 'underline', \n      icon: Underline, \n      name: 'Подчеркнутый', \n      shortcut: 'Ctrl+U',\n      markdown: '__текст__',\n      html: '<u>текст</u>'\n    },\n    { \n      command: 'strikethrough', \n      icon: Strikethrough, \n      name: 'Зачеркнутый', \n      shortcut: 'Ctrl+Shift+X',\n      markdown: '~~текст~~',\n      html: '<s>текст</s>'\n    },\n    { \n      command: 'code', \n      icon: Code, \n      name: 'Код', \n      shortcut: 'Ctrl+E',\n      markdown: '`код`',\n      html: '<code>код</code>'\n    },\n    { \n      command: 'quote', \n      icon: Quote, \n      name: 'Цитата', \n      shortcut: 'Ctrl+Q',\n      markdown: '> цитата',\n      html: '<blockquote>цитата</blockquote>'\n    },\n    { \n      command: 'heading', \n      icon: Heading3, \n      name: 'Заголовок', \n      shortcut: 'Ctrl+H',\n      markdown: '# заголовок',\n      html: '<h3>заголовок</h3>'\n    }\n  ];\n\n  // Apply formatting\n  const applyFormatting = useCallback((format: typeof formatOptions[0]) => {\n    if (!editorRef.current) return;\n    \n    saveToUndoStack();\n    setIsFormatting(true);\n    \n    // Автоматически переключаемся в HTML режим при использовании кнопок форматирования\n    if (onFormatModeChange) {\n      onFormatModeChange('html');\n    }\n    \n    const selection = window.getSelection();\n    if (!selection || selection.rangeCount === 0) {\n      toast({\n        title: \"Нет выделения\",\n        description: \"Выделите текст для форматирования или поставьте курсор в нужное место\",\n        variant: \"default\"\n      });\n      setIsFormatting(false);\n      return;\n    }\n    \n    try {\n      const range = selection.getRangeAt(0);\n      const selectedText = range.toString();\n      \n      if (format.command === 'bold' || format.command === 'italic' || format.command === 'underline' || format.command === 'strikethrough') {\n        // Use document.execCommand for basic formatting\n        document.execCommand(format.command, false, undefined);\n      } else if (format.command === 'code') {\n        // Custom code formatting\n        if (selectedText) {\n          const codeElement = document.createElement('code');\n          codeElement.textContent = selectedText;\n          range.deleteContents();\n          range.insertNode(codeElement);\n          range.selectNode(codeElement);\n          selection.removeAllRanges();\n          selection.addRange(range);\n        }\n      } else if (format.command === 'quote') {\n        // Custom quote formatting\n        if (selectedText) {\n          const quoteElement = document.createElement('blockquote');\n          quoteElement.textContent = selectedText;\n          range.deleteContents();\n          range.insertNode(quoteElement);\n          range.selectNode(quoteElement);\n          selection.removeAllRanges();\n          selection.addRange(range);\n        }\n      } else if (format.command === 'heading') {\n        // Custom heading formatting\n        if (selectedText) {\n          const headingElement = document.createElement('h3');\n          headingElement.textContent = selectedText;\n          range.deleteContents();\n          range.insertNode(headingElement);\n          range.selectNode(headingElement);\n          selection.removeAllRanges();\n          selection.addRange(range);\n        }\n      }\n      \n      // Update the value\n      setTimeout(() => {\n        handleInput();\n        toast({\n          title: \"Форматирование применено\",\n          description: `${format.name} применен к выделенному тексту`,\n          variant: \"default\"\n        });\n      }, 0);\n    } catch (e) {\n      toast({\n        title: \"Ошибка форматирования\",\n        description: \"Не удалось применить форматирование\",\n        variant: \"destructive\"\n      });\n    }\n    \n    setTimeout(() => setIsFormatting(false), 100);\n  }, [saveToUndoStack, handleInput, toast, onFormatModeChange]);\n\n  // Handle keyboard shortcuts\n  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {\n    if (e.ctrlKey || e.metaKey) {\n      const key = e.key.toLowerCase();\n      \n      switch (key) {\n        case 'b':\n          e.preventDefault();\n          applyFormatting(formatOptions[0]);\n          break;\n        case 'i':\n          e.preventDefault();\n          applyFormatting(formatOptions[1]);\n          break;\n        case 'u':\n          e.preventDefault();\n          applyFormatting(formatOptions[2]);\n          break;\n        case 'e':\n          e.preventDefault();\n          applyFormatting(formatOptions[4]);\n          break;\n        case 'q':\n          e.preventDefault();\n          applyFormatting(formatOptions[5]);\n          break;\n        case 'h':\n          e.preventDefault();\n          applyFormatting(formatOptions[6]);\n          break;\n        case 'x':\n          if (e.shiftKey) {\n            e.preventDefault();\n            applyFormatting(formatOptions[3]);\n          }\n          break;\n        case 'z':\n          if (e.shiftKey) {\n            e.preventDefault();\n            redo();\n          } else {\n            e.preventDefault();\n            undo();\n          }\n          break;\n      }\n    }\n  }, [applyFormatting, formatOptions]);\n\n  // Undo functionality\n  const undo = useCallback(() => {\n    if (undoStack.length > 0) {\n      const previousValue = undoStack[undoStack.length - 1];\n      setRedoStack(prev => [...prev, value]);\n      setUndoStack(prev => prev.slice(0, -1));\n      onChange(previousValue);\n      toast({\n        title: \"Отменено\",\n        description: \"Последнее действие отменено\",\n        variant: \"default\"\n      });\n    }\n  }, [undoStack, value, onChange, toast]);\n\n  // Redo functionality\n  const redo = useCallback(() => {\n    if (redoStack.length > 0) {\n      const nextValue = redoStack[redoStack.length - 1];\n      setUndoStack(prev => [...prev, value]);\n      setRedoStack(prev => prev.slice(0, -1));\n      onChange(nextValue);\n      toast({\n        title: \"Повторено\",\n        description: \"Действие повторено\",\n        variant: \"default\"\n      });\n    }\n  }, [redoStack, value, onChange, toast]);\n\n  // Copy formatted text\n  const copyFormatted = useCallback(() => {\n    if (editorRef.current) {\n      const html = editorRef.current.innerHTML;\n      navigator.clipboard.writeText(html).then(() => {\n        toast({\n          title: \"Скопировано\",\n          description: \"Форматированный текст скопирован в буфер обмена\",\n          variant: \"default\"\n        });\n      });\n    }\n  }, [toast]);\n\n  // Insert variable at cursor position\n  const insertVariable = useCallback((variableName: string) => {\n    // Проверяем, является ли это медиапеременной\n    const variable = availableVariables.find(v => v.name === variableName);\n    const isMediaVariable = variable?.mediaType !== undefined;\n    \n    if (isMediaVariable && onMediaVariableSelect && variable) {\n      // Для медиапеременных вызываем специальный callback\n      onMediaVariableSelect(variableName, variable.mediaType!);\n      toast({\n        title: \"Медиа прикреплено\",\n        description: `Медиафайл \"${variableName}\" добавлен в прикрепленные медиа`,\n        variant: \"default\"\n      });\n      return;\n    }\n    \n    // Для обычных переменных - вставляем в текст\n    if (!editorRef.current) return;\n    \n    saveToUndoStack();\n    setIsFormatting(true);\n    \n    const selection = window.getSelection();\n    if (!selection) {\n      setIsFormatting(false);\n      return;\n    }\n\n    try {\n      let range: Range;\n      \n      if (selection.rangeCount > 0) {\n        range = selection.getRangeAt(0);\n      } else {\n        // If no selection, create a range at the end of the content\n        range = document.createRange();\n        range.selectNodeContents(editorRef.current);\n        range.collapse(false);\n      }\n\n      // Create the variable placeholder text\n      const variableText = `{${variableName}}`;\n      const textNode = document.createTextNode(variableText);\n      \n      // Insert the variable\n      range.deleteContents();\n      range.insertNode(textNode);\n      \n      // Position cursor after the inserted variable\n      range.setStartAfter(textNode);\n      range.setEndAfter(textNode);\n      selection.removeAllRanges();\n      selection.addRange(range);\n      \n      // Update the value\n      setTimeout(() => {\n        handleInput();\n        toast({\n          title: \"Переменная добавлена\",\n          description: `Переменная \"${variableName}\" вставлена в текст`,\n          variant: \"default\"\n        });\n      }, 0);\n      \n    } catch (e) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Не удалось вставить переменную\",\n        variant: \"destructive\"\n      });\n    }\n    \n    setTimeout(() => setIsFormatting(false), 100);\n  }, [availableVariables, onMediaVariableSelect, saveToUndoStack, handleInput, toast]);\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Toolbar */}\n      <div className=\"flex flex-wrap items-center gap-1 p-2 bg-muted/50 rounded-md\">\n        <div className=\"flex items-center gap-1\">\n          {formatOptions.map((format) => (\n            <Button\n              key={format.command}\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => applyFormatting(format)}\n              className=\"h-7 w-7 p-0\"\n              title={`${format.name} (${format.shortcut})`}\n            >\n              <format.icon className=\"h-3 w-3\" />\n            </Button>\n          ))}\n        </div>\n        \n        <div className=\"h-4 w-px bg-border mx-1\" />\n        \n        <div className=\"flex items-center gap-1\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={undo}\n            disabled={undoStack.length === 0}\n            className=\"h-7 w-7 p-0\"\n            title=\"Отменить (Ctrl+Z)\"\n          >\n            <RotateCcw className=\"h-3 w-3\" />\n          </Button>\n          \n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={redo}\n            disabled={redoStack.length === 0}\n            className=\"h-7 w-7 p-0\"\n            title=\"Повторить (Ctrl+Shift+Z)\"\n          >\n            <RotateCw className=\"h-3 w-3\" />\n          </Button>\n          \n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={copyFormatted}\n            className=\"h-7 w-7 p-0\"\n            title=\"Копировать форматированный текст\"\n          >\n            <Copy className=\"h-3 w-3\" />\n          </Button>\n        </div>\n        \n        {/* Variables Insert Button */}\n        {availableVariables.length > 0 && (\n          <>\n            <div className=\"h-4 w-px bg-border mx-1\" />\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-7 px-2 gap-1\"\n                  title=\"Вставить переменную\"\n                >\n                  <Plus className=\"h-3 w-3\" />\n                  <span className=\"text-xs\">Переменная</span>\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\" className=\"w-56\">\n                <DropdownMenuLabel className=\"text-xs\">\n                  Доступные переменные\n                </DropdownMenuLabel>\n                <DropdownMenuSeparator />\n                {availableVariables.map((variable, index) => {\n                  const getMediaIcon = () => {\n                    switch (variable.mediaType) {\n                      case 'photo': return <Image className=\"h-3 w-3 text-blue-500\" />;\n                      case 'video': return <Video className=\"h-3 w-3 text-purple-500\" />;\n                      case 'audio': return <Music className=\"h-3 w-3 text-green-500\" />;\n                      case 'document': return <FileText className=\"h-3 w-3 text-orange-500\" />;\n                      default: return null;\n                    }\n                  };\n\n                  const getBadgeText = () => {\n                    if (variable.mediaType) {\n                      switch (variable.mediaType) {\n                        case 'photo': return 'Фото';\n                        case 'video': return 'Видео';\n                        case 'audio': return 'Аудио';\n                        case 'document': return 'Документ';\n                      }\n                    }\n                    if (variable.nodeType === 'user-input') return 'Ввод';\n                    if (variable.nodeType === 'start') return 'Команда';\n                    if (variable.nodeType === 'command') return 'Команда';\n                    if (variable.nodeType === 'system') return 'Система';\n                    if (variable.nodeType === 'conditional') return 'Условие';\n                    return 'Другое';\n                  };\n\n                  const mediaIcon = getMediaIcon();\n                  \n                  return (\n                    <DropdownMenuItem\n                      key={`${variable.nodeId}-${variable.name}-${index}`}\n                      onClick={() => insertVariable(variable.name)}\n                      className=\"cursor-pointer\"\n                    >\n                      <div className=\"flex flex-col gap-1 w-full\">\n                        <div className=\"flex items-center gap-2\">\n                          {mediaIcon && <span className=\"flex-shrink-0\">{mediaIcon}</span>}\n                          <code className=\"text-xs bg-muted px-1 py-0.5 rounded\">\n                            {`{${variable.name}}`}\n                          </code>\n                          <Badge variant=\"outline\" className=\"text-xs h-4\">\n                            {getBadgeText()}\n                          </Badge>\n                        </div>\n                        {variable.description && (\n                          <div className={`text-xs text-muted-foreground ${mediaIcon ? 'ml-5' : ''}`}>\n                            {variable.description}\n                          </div>\n                        )}\n                      </div>\n                    </DropdownMenuItem>\n                  );\n                })}\n                {availableVariables.length === 0 && (\n                  <DropdownMenuItem disabled>\n                    <span className=\"text-xs text-muted-foreground\">\n                      Нет доступных переменных\n                    </span>\n                  </DropdownMenuItem>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </>\n        )}\n        \n        <div className=\"flex-1\" />\n        \n        <div className=\"flex items-center gap-2\">\n          <Switch\n            checked={enableMarkdown}\n            onCheckedChange={onMarkdownToggle}\n            className=\"scale-75\"\n          />\n        </div>\n      </div>\n\n      {/* Editor */}\n      <div className=\"relative\">\n        <div\n          ref={editorRef}\n          contentEditable\n          onInput={handleInput}\n          onKeyDown={handleKeyDown}\n          className=\"min-h-[120px] p-3 border rounded-md bg-background text-sm focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 whitespace-pre-wrap\"\n          style={{ \n            lineHeight: '1.5',\n            overflowWrap: 'break-word',\n            wordBreak: 'break-word'\n          }}\n          data-placeholder={placeholder}\n        />\n        \n        {/* Placeholder */}\n        {!value && (\n          <div className=\"absolute top-3 left-3 text-muted-foreground text-sm pointer-events-none\">\n            {placeholder}\n          </div>\n        )}\n        \n        {/* Stats */}\n        <div className=\"absolute bottom-2 right-2 flex items-center gap-2\">\n          <Badge variant=\"outline\" className=\"text-xs\">\n            {wordCount} слов\n          </Badge>\n          <Badge variant=\"outline\" className=\"text-xs\">\n            {charCount} символов\n          </Badge>\n        </div>\n      </div>\n\n\n    </div>\n  );\n}","size_bytes":23720},"client/src/components/ui/temporary-connection.tsx":{"content":"import { useMemo } from 'react';\nimport { Node } from '@/types/bot';\n\ninterface TemporaryConnectionProps {\n  startNode: Node;\n  endPosition: { x: number; y: number };\n  handle: 'source' | 'target';\n}\n\nexport function TemporaryConnection({ startNode, endPosition, handle }: TemporaryConnectionProps) {\n  const path = useMemo(() => {\n    const baseWidth = 320;\n    const baseHeight = 200;\n    \n    const buttonHeight = startNode.data.buttons.length > 0 ? \n      (startNode.data.keyboardType === 'inline' ? \n        Math.ceil(startNode.data.buttons.length / 2) * 50 : \n        startNode.data.buttons.length * 40) : 0;\n\n    const nodeHeight = baseHeight + buttonHeight;\n\n    // Позиции точек соединения\n    const startX = handle === 'source' ? \n      startNode.position.x + baseWidth + 8 : \n      startNode.position.x - 8;\n    const startY = startNode.position.y + nodeHeight / 2;\n    const endX = endPosition.x;\n    const endY = endPosition.y;\n\n    // Адаптивная кривая Безье\n    const deltaX = endX - startX;\n    const deltaY = endY - startY;\n    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n    \n    let controlPointOffset = Math.min(Math.abs(deltaX) / 2, Math.max(80, distance * 0.3));\n    \n    if (Math.abs(deltaY) > Math.abs(deltaX)) {\n      controlPointOffset = Math.max(controlPointOffset, 120);\n    }\n\n    const controlPoint1X = startX + (handle === 'source' ? controlPointOffset : -controlPointOffset);\n    const controlPoint1Y = startY;\n    const controlPoint2X = endX + (handle === 'source' ? -controlPointOffset : controlPointOffset);\n    const controlPoint2Y = endY;\n\n    return `M ${startX} ${startY} C ${controlPoint1X} ${controlPoint1Y}, ${controlPoint2X} ${controlPoint2Y}, ${endX} ${endY}`;\n  }, [startNode, endPosition, handle]);\n\n  return (\n    <svg \n      className=\"absolute inset-0 w-full h-full pointer-events-none\"\n      style={{ \n        zIndex: 1000,\n        overflow: 'visible'\n      }}\n    >\n      <defs>\n        <marker\n          id=\"temp-arrowhead\"\n          markerWidth=\"10\"\n          markerHeight=\"7\"\n          refX=\"9\"\n          refY=\"3.5\"\n          orient=\"auto\"\n        >\n          <polygon\n            points=\"0 0, 10 3.5, 0 7\"\n            fill=\"hsl(var(--primary))\"\n            className=\"opacity-70\"\n          />\n        </marker>\n      </defs>\n\n      {/* Временная линия соединения */}\n      <path\n        d={path}\n        stroke=\"hsl(var(--primary))\"\n        strokeWidth=\"2\"\n        fill=\"none\"\n        className=\"opacity-70\"\n        style={{\n          strokeDasharray: \"8 4\",\n          animation: \"dash 1s linear infinite\"\n        }}\n        markerEnd=\"url(#temp-arrowhead)\"\n      />\n\n      {/* Анимированный эффект */}\n      <path\n        d={path}\n        stroke=\"hsl(var(--primary))\"\n        strokeWidth=\"1\"\n        fill=\"none\"\n        className=\"opacity-30\"\n        style={{\n          strokeDasharray: \"4 8\",\n          animation: \"dash 1.5s linear infinite reverse\"\n        }}\n      />\n    </svg>\n  );\n}","size_bytes":3049},"client/src/components/layout/adaptive-header.tsx":{"content":"import React, { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { ThemeToggle } from '@/components/theme-toggle';\nimport { Sheet, SheetContent, SheetTrigger, SheetHeader, SheetTitle } from '@/components/ui/sheet';\nimport { FolderOpen, Bookmark, Download, User, Send, Layout, Navigation as NavigationIcon, Sidebar, Monitor, Sliders, Users, Menu, X, Code } from 'lucide-react';\nimport { useIsMobile } from '@/hooks/use-mobile';\nimport { LayoutConfig } from './layout-manager';\n\ninterface BotInfo {\n  first_name: string;\n  username?: string;\n  description?: string;\n  short_description?: string;\n}\n\ninterface AdaptiveHeaderProps {\n  config: LayoutConfig;\n  projectName: string;\n  botInfo?: BotInfo | null;\n  currentTab: 'editor' | 'preview' | 'export' | 'bot' | 'users' | 'groups';\n  onTabChange: (tab: 'editor' | 'preview' | 'export' | 'bot' | 'users' | 'groups') => void;\n  onExport: () => void;\n  onSaveAsTemplate?: () => void;\n  onLoadTemplate?: () => void;\n  onLayoutSettings?: () => void;\n  // Кнопки управления макетом\n  onToggleHeader?: () => void;\n  onToggleSidebar?: () => void;\n  onToggleProperties?: () => void;\n  onToggleCanvas?: () => void;\n  onToggleCode?: () => void;\n  headerVisible?: boolean;\n  sidebarVisible?: boolean;\n  propertiesVisible?: boolean;\n  canvasVisible?: boolean;\n  codeVisible?: boolean;\n  // Мобильные функции\n  onOpenMobileSidebar?: () => void;\n  onOpenMobileProperties?: () => void;\n}\n\nexport function AdaptiveHeader({ \n  config,\n  projectName,\n  botInfo,\n  currentTab, \n  onTabChange, \n  onExport, \n  onSaveAsTemplate, \n  onLoadTemplate,\n  onLayoutSettings,\n  onToggleHeader,\n  onToggleSidebar,\n  onToggleProperties,\n  onToggleCanvas,\n  onToggleCode,\n  headerVisible,\n  sidebarVisible,\n  propertiesVisible,\n  canvasVisible,\n  codeVisible,\n  onOpenMobileSidebar,\n  onOpenMobileProperties\n}: AdaptiveHeaderProps) {\n  \n  // Состояние для мобильного меню\n  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);\n  \n  // Определяем мобильное устройство\n  const isMobile = useIsMobile();\n  \n  // Определяем ориентацию заголовка\n  const isVertical = config.headerPosition === 'left' || config.headerPosition === 'right';\n  const isCompact = config.compactMode;\n  \n  // Классы для контейнера с адаптивной высотой для мобильных устройств\n  const containerClasses = [\n    'bg-background border-border relative z-50',\n    isVertical ? 'h-full w-full border-r flex flex-col' : `${isMobile ? 'h-10' : 'h-12'} flex items-center justify-between ${isMobile ? 'px-3' : 'px-6'} border-b`,\n    isCompact ? 'text-sm' : ''\n  ].join(' ');\n\n  // Компонент логотипа и названия\n  const BrandSection = () => (\n    <div className={`flex items-center ${isVertical ? 'flex-col space-y-2 p-4' : (isMobile ? 'space-x-2' : 'space-x-3')}`}>\n      <div className={`bg-primary rounded-lg flex items-center justify-center ${isCompact || isMobile ? 'w-6 h-6' : 'w-8 h-8'}`}>\n        <i className={`fab fa-telegram-plane text-primary-foreground ${isCompact || isMobile ? 'text-sm' : 'text-lg'}`}></i>\n      </div>\n      <div className={isVertical ? 'text-center' : ''}>\n        <h1 className={`font-semibold text-foreground ${isCompact || isMobile ? 'text-sm' : 'text-lg'}`}>\n          {isVertical && !isCompact ? 'BotCraft' : 'BotCraft Studio'}\n        </h1>\n        <p className={`text-muted-foreground ${isCompact || isMobile ? 'text-xs' : 'text-xs'}`}>\n          {(() => {\n            const displayName = botInfo?.first_name || projectName;\n            return isVertical ? (displayName.length > 12 ? displayName.substring(0, 12) + '...' : displayName) : displayName;\n          })()}\n        </p>\n      </div>\n    </div>\n  );\n\n  // Компонент навигации\n  const Navigation = () => (\n    <nav className={`${isVertical ? 'flex flex-col space-y-1 px-2' : 'hidden lg:flex flex-wrap items-center gap-1'}`}>\n      {[\n        { key: 'editor', label: 'Редактор' },\n        { key: 'export', label: 'Экспорт' },\n        { key: 'bot', label: 'Бот' },\n        { key: 'users', label: 'Пользователи' },\n        { key: 'groups', label: 'Группы' }\n      ].map((tab) => (\n        <button \n          key={tab.key}\n          onClick={() => onTabChange(tab.key as any)}\n          className={`${isCompact ? 'px-2 py-1 text-xs' : 'px-3 py-1.5 text-sm'} font-medium rounded-md transition-colors ${\n            currentTab === tab.key \n              ? 'text-primary bg-primary/10' \n              : 'text-muted-foreground hover:bg-muted'\n          } ${isVertical ? 'w-full text-left' : 'whitespace-nowrap'} max-sm:text-xs max-sm:px-2 max-sm:py-1`}\n        >\n          {isVertical && isCompact ? tab.label.substring(0, 3) : tab.label}\n        </button>\n      ))}\n    </nav>\n  );\n\n  // Мобильная версия навигации\n  const MobileNavigation = () => (\n    <div className=\"flex flex-col space-y-4\">\n      <div className=\"grid grid-cols-2 gap-2\">\n        {[\n          { key: 'editor', label: 'Редактор' },\n          { key: 'export', label: 'Экспорт' },\n          { key: 'bot', label: 'Бот' },\n          { key: 'users', label: 'Пользователи' },\n          { key: 'groups', label: 'Группы' }\n        ].map((tab) => (\n          <button \n            key={tab.key}\n            onClick={() => {\n              onTabChange(tab.key as any);\n              setIsMobileMenuOpen(false);\n            }}\n            className={`px-3 py-2 text-sm font-medium rounded-md transition-colors ${\n              currentTab === tab.key \n                ? 'text-primary bg-primary/10' \n                : 'text-muted-foreground hover:bg-muted'\n            }`}\n          >\n            {tab.label}\n          </button>\n        ))}\n      </div>\n    </div>\n  );\n\n  // Мобильная версия действий\n  const MobileActions = () => (\n    <div className=\"flex flex-col space-y-3\">\n      {/* Кнопки управления макетом */}\n      {(onToggleHeader || onToggleSidebar || onToggleProperties || onToggleCanvas || onToggleCode) && (\n        <div className=\"grid grid-cols-2 gap-2\">\n          {onToggleHeader && (\n            <Button\n              variant={headerVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => {\n                onToggleHeader();\n                setIsMobileMenuOpen(false);\n              }}\n              className=\"flex items-center justify-center\"\n              title={`${headerVisible ? 'Скрыть' : 'Показать'} шапку`}\n              data-testid=\"button-mobile-toggle-header\"\n            >\n              <NavigationIcon className=\"w-3 h-3 mr-1\" />\n              Шапка\n            </Button>\n          )}\n          \n          {onToggleSidebar && (\n            <Button\n              variant={sidebarVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => {\n                onToggleSidebar();\n                setIsMobileMenuOpen(false);\n              }}\n              className=\"flex items-center justify-center\"\n              title={`${sidebarVisible ? 'Скрыть' : 'Показать'} боковую панель`}\n              data-testid=\"button-mobile-toggle-sidebar\"\n            >\n              <Sidebar className=\"w-3 h-3 mr-1\" />\n              Панель\n            </Button>\n          )}\n          \n          {onToggleCanvas && (\n            <Button\n              variant={canvasVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => {\n                onToggleCanvas();\n                setIsMobileMenuOpen(false);\n              }}\n              className=\"flex items-center justify-center\"\n              title={`${canvasVisible ? 'Скрыть' : 'Показать'} холст`}\n              data-testid=\"button-mobile-toggle-canvas\"\n            >\n              <Monitor className=\"w-3 h-3 mr-1\" />\n              Холст\n            </Button>\n          )}\n          \n          {onToggleProperties && (\n            <Button\n              variant={propertiesVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => {\n                onToggleProperties();\n                setIsMobileMenuOpen(false);\n              }}\n              className=\"flex items-center justify-center\"\n              title={`${propertiesVisible ? 'Скрыть' : 'Показать'} панель свойств`}\n              data-testid=\"button-mobile-toggle-properties\"\n            >\n              <Sliders className=\"w-3 h-3 mr-1\" />\n              Свойства\n            </Button>\n          )}\n          \n          {onToggleCode && (\n            <Button\n              variant={codeVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => {\n                onToggleCode();\n                setIsMobileMenuOpen(false);\n              }}\n              className=\"flex items-center justify-center\"\n              title={`${codeVisible ? 'Скрыть' : 'Показать'} панель кода`}\n              data-testid=\"button-mobile-toggle-code\"\n            >\n              <Code className=\"w-3 h-3 mr-1\" />\n              Код\n            </Button>\n          )}\n        </div>\n      )}\n      \n      <div className=\"grid grid-cols-1 gap-2\">\n        {onLoadTemplate && (\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            onClick={() => {\n              onLoadTemplate();\n              setIsMobileMenuOpen(false);\n            }}\n            className=\"flex items-center justify-center\"\n          >\n            <FolderOpen className=\"h-3 w-3 mr-2\" />\n            Загрузить шаблон\n          </Button>\n        )}\n        \n        {onSaveAsTemplate && (\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            onClick={() => {\n              onSaveAsTemplate();\n              setIsMobileMenuOpen(false);\n            }}\n            className=\"flex items-center justify-center\"\n          >\n            <Bookmark className=\"h-3 w-3 mr-2\" />\n            Сохранить как шаблон\n          </Button>\n        )}\n        \n        <Button \n          size=\"sm\"\n          onClick={() => {\n            onExport();\n            setIsMobileMenuOpen(false);\n          }}\n          className=\"flex items-center justify-center\"\n        >\n          <i className=\"fas fa-download mr-2\"></i>\n          Экспорт\n        </Button>\n        \n        <div className=\"flex justify-center pt-2\">\n          <ThemeToggle />\n        </div>\n      </div>\n    </div>\n  );\n\n  // Компонент действий\n  const Actions = () => (\n    <div className={`flex ${isVertical ? 'flex-col space-y-2 p-2' : 'hidden lg:flex flex-wrap items-center gap-2'}`}>\n      \n      {/* Кнопки управления макетом */}\n      {(onToggleHeader || onToggleSidebar || onToggleProperties || onToggleCanvas || onToggleCode) && (\n        <div className=\"flex items-center space-x-1 bg-background/80 backdrop-blur-sm border border-border rounded-md p-1\">\n          {onToggleHeader && (\n            <Button\n              variant={headerVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={onToggleHeader}\n              className=\"h-7 w-7 p-0\"\n              title={`${headerVisible ? 'Скрыть' : 'Показать'} шапку`}\n              data-testid=\"button-toggle-header\"\n            >\n              <NavigationIcon className=\"w-3 h-3\" />\n            </Button>\n          )}\n          \n          {onToggleSidebar && (\n            <Button\n              variant={sidebarVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={onToggleSidebar}\n              className=\"h-7 w-7 p-0\"\n              title={`${sidebarVisible ? 'Скрыть' : 'Показать'} боковую панель`}\n              data-testid=\"button-toggle-sidebar\"\n            >\n              <Sidebar className=\"w-3 h-3\" />\n            </Button>\n          )}\n          \n          {onToggleCanvas && (\n            <Button\n              variant={canvasVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={onToggleCanvas}\n              className=\"h-7 w-7 p-0\"\n              title={`${canvasVisible ? 'Скрыть' : 'Показать'} холст`}\n              data-testid=\"button-toggle-canvas\"\n            >\n              <Monitor className=\"w-3 h-3\" />\n            </Button>\n          )}\n          \n          {onToggleProperties && (\n            <Button\n              variant={propertiesVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={onToggleProperties}\n              className=\"h-7 w-7 p-0\"\n              title={`${propertiesVisible ? 'Скрыть' : 'Показать'} панель свойств`}\n              data-testid=\"button-toggle-properties\"\n            >\n              <Sliders className=\"w-3 h-3\" />\n            </Button>\n          )}\n          \n          {onToggleCode && (\n            <Button\n              variant={codeVisible ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={onToggleCode}\n              className=\"h-7 w-7 p-0\"\n              title={`${codeVisible ? 'Скрыть' : 'Показать'} панель кода`}\n              data-testid=\"button-toggle-code\"\n            >\n              <Code className=\"w-3 h-3\" />\n            </Button>\n          )}\n        </div>\n      )}\n      \n      {onLoadTemplate && (\n        <Button \n          variant=\"outline\" \n          size=\"sm\"\n          onClick={onLoadTemplate}\n          className={`${isVertical ? 'w-full justify-center' : 'flex items-center justify-center'} px-1 py-0.5 text-xs max-sm:px-1 max-sm:py-0.5 max-sm:min-w-0 max-sm:w-full`}\n        >\n          <FolderOpen className=\"h-2.5 w-2.5 max-sm:mx-auto\" />\n          <span className=\"max-sm:hidden ml-1\">Шаблоны</span>\n        </Button>\n      )}\n      \n      {onSaveAsTemplate && (\n        <Button \n          variant=\"outline\" \n          size=\"sm\"\n          onClick={onSaveAsTemplate}\n          className={`${isVertical ? 'w-full justify-center' : 'flex items-center justify-center'} px-1 py-0.5 text-xs max-sm:px-1 max-sm:py-0.5 max-sm:min-w-0 max-sm:w-full`}\n        >\n          <Bookmark className=\"h-2.5 w-2.5 max-sm:mx-auto\" />\n          <span className=\"max-sm:hidden ml-1\">Создать</span>\n        </Button>\n      )}\n      \n\n      \n      <Button \n        size=\"sm\"\n        onClick={onExport}\n        className={`${isVertical ? 'w-full justify-center' : 'flex items-center justify-center'} px-1 py-0.5 text-xs max-sm:px-1 max-sm:py-0.5 max-sm:min-w-0 max-sm:w-full max-sm:col-span-2`}\n      >\n        <i className=\"fas fa-download text-2xs max-sm:mx-auto\"></i>\n        <span className=\"max-sm:hidden ml-1\">Экспорт</span>\n      </Button>\n      \n      {isVertical && (\n        <div className=\"h-px w-full bg-border my-2\"></div>\n      )}\n      \n      <div className=\"max-sm:col-span-1 max-sm:flex max-sm:justify-center\">\n        <ThemeToggle />\n      </div>\n    </div>\n  );\n\n  // Разделитель\n  const Separator = () => (\n    <div className={`${isVertical ? 'h-px w-full' : 'h-6 w-px'} bg-border`}></div>\n  );\n\n  if (isVertical) {\n    return (\n      <header className={containerClasses}>\n        <BrandSection />\n        <Separator />\n        <div className=\"flex-1 overflow-y-auto\">\n          <Navigation />\n        </div>\n        <Separator />\n        <Actions />\n      </header>\n    );\n  }\n\n  return (\n    <header className={containerClasses}>\n      <div className=\"flex items-center space-x-4\">\n        <BrandSection />\n        <Separator />\n        {/* Мобильные кнопки компонентов и свойств после разделителя */}\n        {isMobile && !isVertical && (\n          <div className=\"flex items-center space-x-1\">\n            {onOpenMobileSidebar && (\n              <button\n                onClick={onOpenMobileSidebar}\n                className=\"group p-1.5 bg-blue-500/10 dark:bg-blue-400/15 rounded-md border border-blue-300/30 dark:border-blue-500/20 hover:bg-blue-500/20 dark:hover:bg-blue-400/25 hover:border-blue-400/50 dark:hover:border-blue-400/30 transition-all duration-200 hover:shadow-sm hover:shadow-blue-500/20\"\n                title=\"Открыть панель компонентов\"\n                data-testid=\"button-mobile-components\"\n              >\n                <Menu className=\"w-3.5 h-3.5 text-blue-600 dark:text-blue-400 group-hover:text-blue-700 dark:group-hover:text-blue-300 transition-colors duration-200\" />\n              </button>\n            )}\n            {onOpenMobileProperties && (\n              <button\n                onClick={onOpenMobileProperties}\n                className=\"group p-1.5 bg-purple-500/10 dark:bg-purple-400/15 rounded-md border border-purple-300/30 dark:border-purple-500/20 hover:bg-purple-500/20 dark:hover:bg-purple-400/25 hover:border-purple-400/50 dark:hover:border-purple-400/30 transition-all duration-200 hover:shadow-sm hover:shadow-purple-500/20\"\n                title=\"Открыть панель свойств\"\n                data-testid=\"button-mobile-properties\"\n              >\n                <Sliders className=\"w-3.5 h-3.5 text-purple-600 dark:text-purple-400 group-hover:text-purple-700 dark:group-hover:text-purple-300 transition-colors duration-200\" />\n              </button>\n            )}\n          </div>\n        )}\n        <Navigation />\n      </div>\n      \n      {/* Десктопные действия */}\n      <Actions />\n      \n      {/* Мобильная кнопка меню */}\n      <div className=\"lg:hidden\">\n        <Sheet open={isMobileMenuOpen} onOpenChange={setIsMobileMenuOpen}>\n          <SheetTrigger asChild>\n            <Button variant=\"outline\" size=\"sm\" className=\"p-2\">\n              <Menu className=\"h-4 w-4\" />\n            </Button>\n          </SheetTrigger>\n          <SheetContent side=\"right\" className=\"w-80\">\n            <SheetHeader>\n              <SheetTitle className=\"text-left\">Меню</SheetTitle>\n            </SheetHeader>\n            <div className=\"mt-6 space-y-6\">\n              <div>\n                <h3 className=\"text-sm font-medium text-muted-foreground mb-3\">Навигация</h3>\n                <MobileNavigation />\n              </div>\n              <div>\n                <h3 className=\"text-sm font-medium text-muted-foreground mb-3\">Действия</h3>\n                <MobileActions />\n              </div>\n            </div>\n          </SheetContent>\n        </Sheet>\n      </div>\n    </header>\n  );\n}","size_bytes":18766},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/index.css":{"content":"/* Font Awesome icons via CDN */\n@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');\n\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  --background: hsl(0, 0%, 100%);\n  --foreground: hsl(20, 14.3%, 4.1%);\n  --muted: hsl(60, 4.8%, 95.9%);\n  --muted-foreground: hsl(25, 5.3%, 44.7%);\n  --popover: hsl(0, 0%, 100%);\n  --popover-foreground: hsl(20, 14.3%, 4.1%);\n  --card: hsl(0, 0%, 100%);\n  --card-foreground: hsl(20, 14.3%, 4.1%);\n  --border: hsl(20, 5.9%, 90%);\n  --input: hsl(20, 5.9%, 90%);\n  --primary: hsl(207, 90%, 54%);\n  --primary-foreground: hsl(211, 100%, 99%);\n  --secondary: hsl(60, 4.8%, 95.9%);\n  --secondary-foreground: hsl(24, 9.8%, 10%);\n  --accent: hsl(60, 4.8%, 95.9%);\n  --accent-foreground: hsl(24, 9.8%, 10%);\n  --destructive: hsl(0, 84.2%, 60.2%);\n  --destructive-foreground: hsl(60, 9.1%, 97.8%);\n  --ring: hsl(20, 14.3%, 4.1%);\n  --radius: 0.5rem;\n  \n  /* Enhanced theme variables */\n  --success: hsl(142, 76%, 36%);\n  --success-foreground: hsl(355, 7%, 97%);\n  --warning: hsl(38, 92%, 50%);\n  --warning-foreground: hsl(48, 96%, 89%);\n  --info: hsl(199, 89%, 48%);\n  --info-foreground: hsl(210, 20%, 98%);\n  \n  /* Gradient colors */\n  --gradient-primary-start: hsl(207, 90%, 54%);\n  --gradient-primary-end: hsl(217, 100%, 64%);\n  --gradient-secondary-start: hsl(60, 4.8%, 95.9%);\n  --gradient-secondary-end: hsl(60, 4.8%, 88%);\n  \n  /* Shadow colors */\n  --shadow-light: hsl(20, 5.9%, 50% / 0.1);\n  --shadow-medium: hsl(20, 5.9%, 30% / 0.15);\n  --shadow-heavy: hsl(20, 5.9%, 10% / 0.2);\n}\n\n.dark {\n  --background: hsl(240, 10%, 3.9%);\n  --foreground: hsl(0, 0%, 98%);\n  --muted: hsl(240, 3.7%, 15.9%);\n  --muted-foreground: hsl(240, 5%, 64.9%);\n  --popover: hsl(240, 10%, 3.9%);\n  --popover-foreground: hsl(0, 0%, 98%);\n  --card: hsl(240, 10%, 7%);\n  --card-foreground: hsl(0, 0%, 98%);\n  --border: hsl(240, 3.7%, 18%);\n  --input: hsl(240, 3.7%, 15.9%);\n  --primary: hsl(207, 90%, 60%);\n  --primary-foreground: hsl(211, 100%, 99%);\n  --secondary: hsl(240, 3.7%, 20%);\n  --secondary-foreground: hsl(0, 0%, 98%);\n  --accent: hsl(240, 3.7%, 20%);\n  --accent-foreground: hsl(0, 0%, 98%);\n  --destructive: hsl(0, 75%, 60%);\n  --destructive-foreground: hsl(0, 0%, 98%);\n  --ring: hsl(240, 4.9%, 83.9%);\n  --radius: 0.5rem;\n  \n  /* Enhanced dark theme variables */\n  --success: hsl(142, 76%, 45%);\n  --success-foreground: hsl(355, 7%, 97%);\n  --warning: hsl(38, 92%, 55%);\n  --warning-foreground: hsl(48, 96%, 89%);\n  --info: hsl(199, 89%, 55%);\n  --info-foreground: hsl(210, 20%, 98%);\n  \n  /* Dark gradient colors */\n  --gradient-primary-start: hsl(207, 90%, 60%);\n  --gradient-primary-end: hsl(217, 100%, 70%);\n  --gradient-secondary-start: hsl(240, 3.7%, 20%);\n  --gradient-secondary-end: hsl(240, 3.7%, 30%);\n  \n  /* Dark shadow colors */\n  --shadow-light: hsl(0, 0%, 0% / 0.2);\n  --shadow-medium: hsl(0, 0%, 0% / 0.3);\n  --shadow-heavy: hsl(0, 0%, 0% / 0.5);\n  \n  /* Surface colors for better depth */\n  --surface-1: hsl(240, 8%, 8%);\n  --surface-2: hsl(240, 8%, 12%);\n  --surface-3: hsl(240, 8%, 16%);\n  \n  /* Glass effect colors */\n  --glass-bg: hsl(240, 10%, 10% / 0.8);\n  --glass-border: hsl(240, 10%, 30% / 0.2);\n  \n  /* Switch colors for better visibility */\n  --switch-unchecked-bg: hsl(240, 8%, 25%);\n  --switch-unchecked-border: hsl(240, 10%, 40%);\n  --switch-unchecked-thumb: hsl(240, 5%, 60%);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n@layer utilities {\n  .line-clamp-3 {\n    display: -webkit-box;\n    -webkit-line-clamp: 3;\n    -webkit-box-orient: vertical;\n    overflow: hidden;\n  }\n\n  /* Grid background patterns */\n  .bg-grid-small {\n    background-image: radial-gradient(circle, hsl(var(--muted-foreground) / 0.3) 1px, transparent 1px);\n    background-size: 20px 20px;\n  }\n  \n  /* Enhanced Switch visibility in dark theme */\n  .dark [data-state=\"unchecked\"][role=\"switch\"] {\n    background-color: var(--switch-unchecked-bg) !important;\n    border: 1px solid var(--switch-unchecked-border) !important;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.1) !important;\n  }\n  \n  .dark [data-state=\"unchecked\"][role=\"switch\"] > span {\n    background-color: var(--switch-unchecked-thumb) !important;\n    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4) !important;\n  }\n  \n  /* Hover effects for better interaction feedback */\n  .dark [data-state=\"unchecked\"][role=\"switch\"]:hover {\n    background-color: hsl(240, 8%, 30%) !important;\n    border-color: hsl(240, 10%, 50%) !important;\n    transform: translateY(-1px);\n    transition: all 0.2s ease;\n  }\n  \n  .dark [data-state=\"unchecked\"][role=\"switch\"]:hover > span {\n    background-color: hsl(240, 5%, 70%) !important;\n  }\n\n  .bg-grid-slate-200 {\n    background-image: radial-gradient(circle, rgb(226 232 240 / 0.5) 1px, transparent 1px);\n    background-size: 20px 20px;\n  }\n\n  .bg-grid-slate-800 {\n    background-image: radial-gradient(circle, rgb(30 41 59 / 0.5) 1px, transparent 1px);\n    background-size: 20px 20px;\n  }\n}\n\n/* Custom scrollbar */\n::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n\n::-webkit-scrollbar-track {\n  background: var(--muted);\n}\n\n::-webkit-scrollbar-thumb {\n  background: var(--muted-foreground);\n  border-radius: 3px;\n  transition: background-color 0.2s ease;\n}\n\n::-webkit-scrollbar-thumb:hover {\n  background: var(--foreground);\n}\n\n/* Dark theme improvements */\n.dark {\n  color-scheme: dark;\n}\n\n/* Smooth transitions for theme switching */\n* {\n  transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;\n}\n\n/* Enhanced focus styles for dark theme */\n.dark .focus\\:ring-primary:focus {\n  --tw-ring-color: hsl(var(--primary) / 0.5);\n}\n\n/* Better shadow for dark theme */\n.dark .shadow-lg {\n  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);\n}\n\n.dark .shadow-xl {\n  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);\n}\n\n/* Enhanced hover effects for dark theme */\n.dark .hover\\:shadow-xl:hover {\n  box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.4), 0 15px 15px -5px rgba(0, 0, 0, 0.3);\n}\n\n/* ResizablePanel enhancements for dark theme */\n[data-panel-resize-handle-enabled=\"true\"]:hover {\n  background: var(--primary) !important;\n  opacity: 0.8;\n}\n\n[data-panel-resize-handle-enabled=\"true\"][data-panel-resize-handle-active=\"true\"] {\n  background: var(--primary) !important;\n  opacity: 1;\n}\n\n.dark [data-panel-resize-handle-enabled=\"true\"] {\n  background: hsl(var(--border));\n  box-shadow: 0 0 0 1px hsl(var(--border));\n}\n\n.dark [data-panel-resize-handle-enabled=\"true\"]:hover {\n  background: hsl(var(--primary) / 0.6) !important;\n  box-shadow: 0 0 0 1px hsl(var(--primary) / 0.8);\n}\n\n.dark [data-panel-resize-handle-enabled=\"true\"][data-panel-resize-handle-active=\"true\"] {\n  background: hsl(var(--primary)) !important;\n  box-shadow: 0 0 0 1px hsl(var(--primary)), 0 0 8px hsl(var(--primary) / 0.3);\n}\n\n/* Enhanced resize handle cursor */\n[data-panel-resize-handle-enabled=\"true\"] {\n  cursor: col-resize;\n  transition: all 0.2s ease;\n}\n\n[data-panel-resize-handle-enabled=\"true\"][data-panel-group-direction=\"vertical\"] {\n  cursor: row-resize;\n}\n\n/* Smooth panel transitions */\n[data-panel-group] > [data-panel] {\n  transition: flex-basis 0.2s ease;\n}\n\n/* Enhanced visual feedback for resize handles */\n[data-panel-resize-handle-enabled=\"true\"] {\n  position: relative;\n  isolation: isolate;\n}\n\n[data-panel-resize-handle-enabled=\"true\"]::before {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: transparent;\n  transition: background-color 0.15s ease;\n  z-index: -1;\n}\n\n[data-panel-resize-handle-enabled=\"true\"]:hover::before {\n  background: hsl(var(--primary) / 0.05);\n}\n\n.dark [data-panel-resize-handle-enabled=\"true\"]:hover::before {\n  background: hsl(var(--primary) / 0.1);\n}\n\n[data-panel-resize-handle-enabled=\"true\"][data-panel-resize-handle-active=\"true\"]::before {\n  background: hsl(var(--primary) / 0.15);\n  animation: pulse-resize 0.6s ease-in-out infinite alternate;\n}\n\n.dark [data-panel-resize-handle-enabled=\"true\"][data-panel-resize-handle-active=\"true\"]::before {\n  background: hsl(var(--primary) / 0.2);\n}\n\n/* Pulse animation for active resize handles */\n@keyframes pulse-resize {\n  from {\n    background: hsl(var(--primary) / 0.1);\n  }\n  to {\n    background: hsl(var(--primary) / 0.25);\n  }\n}\n\n/* Connection line animations */\n@keyframes dash {\n  0% { stroke-dashoffset: 0; }\n  100% { stroke-dashoffset: -20; }\n}\n\n@keyframes connection-pulse {\n  0%, 100% { opacity: 0.3; }\n  50% { opacity: 1; }\n}\n\n@keyframes connection-glow {\n  0% { filter: drop-shadow(0 0 2px hsl(var(--primary) / 0.3)); }\n  50% { filter: drop-shadow(0 0 8px hsl(var(--primary) / 0.6)); }\n  100% { filter: drop-shadow(0 0 2px hsl(var(--primary) / 0.3)); }\n}\n\n/* Glow effect for dark theme */\n.dark [data-panel-resize-handle-enabled=\"true\"][data-panel-resize-handle-active=\"true\"] {\n  box-shadow: \n    0 0 0 1px hsl(var(--primary)), \n    0 0 8px hsl(var(--primary) / 0.3),\n    0 0 16px hsl(var(--primary) / 0.1);\n}\n\n/* Improved handle visibility in dark theme */\n.dark [data-panel-resize-handle-enabled=\"true\"] .grip-handle {\n  background: hsl(var(--muted));\n  border: 1px solid hsl(var(--border));\n}\n\n.dark [data-panel-resize-handle-enabled=\"true\"]:hover .grip-handle {\n  background: hsl(var(--muted-foreground) / 0.1);\n  border-color: hsl(var(--primary) / 0.5);\n  box-shadow: 0 2px 4px hsl(var(--background) / 0.1);\n}\n\n/* Smooth resize cursor transitions */\nbody {\n  cursor-transition: cursor 0.1s ease;\n}\n\n/* Panel borders enhancement for dark theme */\n.dark [data-panel-group] {\n  border-color: hsl(var(--border));\n}\n\n/* Responsive resize handles */\n@media (max-width: 768px) {\n  [data-panel-resize-handle-enabled=\"true\"] {\n    width: 8px !important;\n  }\n  \n  [data-panel-resize-handle-enabled=\"true\"][data-panel-group-direction=\"vertical\"] {\n    height: 8px !important;\n  }\n  \n  .grip-handle {\n    width: 20px !important;\n    height: 24px !important;\n  }\n}\n\n/* Empty State Enhancements for Dark Theme */\n.empty-state-icon {\n  position: relative;\n  transition: transform 0.3s ease;\n}\n\n.empty-state-icon:hover {\n  transform: scale(1.05);\n}\n\n.empty-state-icon::before {\n  content: '';\n  position: absolute;\n  inset: -4px;\n  background: linear-gradient(45deg, transparent, hsl(var(--primary) / 0.1), transparent);\n  border-radius: inherit;\n  opacity: 0;\n  transition: opacity 0.3s ease;\n  z-index: -1;\n}\n\n.empty-state-icon:hover::before {\n  opacity: 1;\n}\n\n/* Dark theme specific enhancements for empty state */\n.dark .empty-state-container {\n  background: linear-gradient(135deg, hsl(var(--background)) 0%, hsl(var(--muted) / 0.3) 100%);\n}\n\n.dark .empty-state-icon-bg {\n  background: linear-gradient(135deg, hsl(var(--muted) / 0.4) 0%, hsl(var(--muted) / 0.6) 100%);\n  border: 1px solid hsl(var(--border));\n  box-shadow: \n    0 4px 6px -1px hsl(var(--background) / 0.1),\n    0 2px 4px -1px hsl(var(--background) / 0.06);\n}\n\n.dark .empty-state-tip {\n  background: hsl(var(--muted) / 0.2);\n  border: 1px solid hsl(var(--border) / 0.5);\n  border-radius: 6px;\n  padding: 8px 12px;\n  transition: all 0.2s ease;\n}\n\n.dark .empty-state-tip:hover {\n  background: hsl(var(--muted) / 0.3);\n  border-color: hsl(var(--primary) / 0.3);\n  transform: translateY(-1px);\n}\n\n/* Gradient text effect for dark theme */\n.dark .gradient-text {\n  background: linear-gradient(135deg, hsl(var(--foreground)) 0%, hsl(var(--muted-foreground)) 100%);\n  -webkit-background-clip: text;\n  -webkit-text-fill-color: transparent;\n  background-clip: text;\n}\n\n/* Enhanced pulse animation for dark theme */\n.dark .pulse-primary {\n  animation: pulse-primary-dark 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;\n}\n\n@keyframes pulse-primary-dark {\n  0%, 100% {\n    opacity: 0.3;\n    transform: scale(1);\n  }\n  50% {\n    opacity: 0.6;\n    transform: scale(1.05);\n  }\n}\n\n/* Canvas Theme Support */\n.bg-canvas-bg {\n  background: linear-gradient(135deg, \n    hsl(var(--muted) / 0.1) 0%, \n    hsl(var(--muted) / 0.3) 25%, \n    hsl(var(--muted) / 0.1) 50%, \n    hsl(var(--muted) / 0.4) 75%, \n    hsl(var(--muted) / 0.2) 100%\n  );\n}\n\n.dark .bg-canvas-bg {\n  background: \n    radial-gradient(ellipse at top left, hsl(var(--primary) / 0.03) 0%, transparent 50%),\n    radial-gradient(ellipse at bottom right, hsl(var(--primary) / 0.02) 0%, transparent 50%),\n    linear-gradient(135deg, \n      hsl(var(--background)) 0%, \n      hsl(var(--surface-1)) 20%, \n      hsl(var(--background)) 40%, \n      hsl(var(--surface-2)) 60%, \n      hsl(var(--surface-1)) 80%, \n      hsl(var(--background)) 100%\n    );\n  position: relative;\n  overflow: hidden;\n}\n\n.dark .bg-canvas-bg::before {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: \n    radial-gradient(circle at 20% 30%, hsl(var(--primary) / 0.08) 0%, transparent 30%),\n    radial-gradient(circle at 80% 70%, hsl(var(--primary) / 0.05) 0%, transparent 30%),\n    radial-gradient(circle at 40% 80%, hsl(var(--accent) / 0.03) 0%, transparent 25%);\n  pointer-events: none;\n  opacity: 0.6;\n  animation: canvas-ambient 20s ease-in-out infinite alternate;\n}\n\n@keyframes canvas-ambient {\n  0% {\n    opacity: 0.4;\n    transform: scale(1) rotate(0deg);\n  }\n  50% {\n    opacity: 0.7;\n    transform: scale(1.05) rotate(1deg);\n  }\n  100% {\n    opacity: 0.6;\n    transform: scale(1.02) rotate(-0.5deg);\n  }\n}\n\n/* Enhanced Canvas Drop Zone Hint for Dark Theme */\n.dark .canvas-drop-hint {\n  background: \n    linear-gradient(135deg, \n      hsl(var(--card) / 0.85) 0%, \n      hsl(var(--surface-1) / 0.9) 100%\n    ),\n    radial-gradient(ellipse at center, \n      hsl(var(--primary) / 0.02) 0%, \n      transparent 70%\n    );\n  border: 2px dashed hsl(var(--border) / 0.5);\n  position: relative;\n  overflow: hidden;\n  backdrop-filter: blur(20px);\n  box-shadow: \n    0 20px 25px -5px hsl(var(--background) / 0.15),\n    0 10px 10px -5px hsl(var(--background) / 0.08),\n    inset 0 1px 0 hsl(var(--muted) / 0.15);\n  animation: drop-hint-pulse 3s ease-in-out infinite;\n}\n\n.dark .canvas-drop-hint::before {\n  content: '';\n  position: absolute;\n  inset: -2px;\n  background: linear-gradient(45deg, \n    transparent 0%, \n    hsl(var(--primary) / 0.1) 25%, \n    transparent 50%, \n    hsl(var(--primary) / 0.08) 75%, \n    transparent 100%\n  );\n  border-radius: inherit;\n  z-index: -1;\n  animation: border-glow 4s ease-in-out infinite alternate;\n}\n\n.dark .canvas-drop-hint:hover {\n  background: \n    linear-gradient(135deg, \n      hsl(var(--primary) / 0.1) 0%, \n      hsl(var(--surface-2) / 0.95) 50%, \n      hsl(var(--card) / 0.9) 100%\n    ),\n    radial-gradient(ellipse at center, \n      hsl(var(--primary) / 0.05) 0%, \n      transparent 60%\n    );\n  border-color: hsl(var(--primary) / 0.6);\n  transform: translateY(-2px) scale(1.02);\n  box-shadow: \n    0 32px 40px -12px hsl(var(--background) / 0.25),\n    0 16px 20px -8px hsl(var(--background) / 0.15),\n    inset 0 2px 0 hsl(var(--primary) / 0.2),\n    0 0 0 1px hsl(var(--primary) / 0.2),\n    0 0 20px hsl(var(--primary) / 0.1);\n  animation: drop-hint-hover 2s ease-in-out infinite alternate;\n}\n\n/* Canvas Drop Zone Icon Enhancement */\n.dark .canvas-drop-icon {\n  background: linear-gradient(135deg, \n    hsl(var(--muted) / 0.3) 0%, \n    hsl(var(--muted) / 0.15) 100%\n  );\n  border: 1px solid hsl(var(--border) / 0.3);\n  transition: all 0.3s ease;\n}\n\n.dark .canvas-drop-hint:hover .canvas-drop-icon {\n  background: linear-gradient(135deg, \n    hsl(var(--primary) / 0.2) 0%, \n    hsl(var(--primary) / 0.1) 100%\n  );\n  border-color: hsl(var(--primary) / 0.3);\n  transform: scale(1.05);\n}\n\n.dark .canvas-drop-icon i {\n  transition: all 0.3s ease;\n}\n\n.dark .canvas-drop-hint:hover .canvas-drop-icon i {\n  color: hsl(var(--primary));\n  transform: scale(1.1);\n}\n\n/* Enhanced Canvas Grid Pattern for Dark Theme */\n.dark .canvas-grid {\n  background-image: \n    radial-gradient(circle, hsl(var(--primary) / 0.15) 1px, transparent 1px),\n    linear-gradient(hsl(var(--muted-foreground) / 0.06) 1px, transparent 1px),\n    linear-gradient(90deg, hsl(var(--muted-foreground) / 0.06) 1px, transparent 1px) !important;\n  position: relative;\n  transition: all 0.3s ease;\n}\n\n.dark .canvas-grid::before {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: \n    radial-gradient(circle at 25% 25%, hsl(var(--primary) / 0.04) 0%, transparent 40%),\n    radial-gradient(circle at 75% 75%, hsl(var(--primary) / 0.03) 0%, transparent 40%),\n    conic-gradient(from 45deg at 50% 50%, \n      transparent 0deg, \n      hsl(var(--primary) / 0.01) 90deg, \n      transparent 180deg, \n      hsl(var(--primary) / 0.01) 270deg, \n      transparent 360deg\n    );\n  pointer-events: none;\n  opacity: 0.8;\n  animation: grid-shimmer 15s ease-in-out infinite alternate;\n}\n\n.dark .canvas-grid::after {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: \n    linear-gradient(45deg, \n      transparent 0%, \n      hsl(var(--muted) / 0.02) 25%, \n      transparent 50%, \n      hsl(var(--muted) / 0.015) 75%, \n      transparent 100%\n    ),\n    linear-gradient(-45deg, \n      transparent 0%, \n      hsl(var(--primary) / 0.01) 25%, \n      transparent 50%, \n      hsl(var(--primary) / 0.008) 75%, \n      transparent 100%\n    );\n  pointer-events: none;\n  opacity: 0.6;\n  animation: grid-overlay 12s ease-in-out infinite alternate-reverse;\n}\n\n@keyframes grid-shimmer {\n  0% {\n    opacity: 0.6;\n    transform: scale(1) translateX(0);\n  }\n  50% {\n    opacity: 0.9;\n    transform: scale(1.01) translateX(2px);\n  }\n  100% {\n    opacity: 0.8;\n    transform: scale(1.005) translateX(-1px);\n  }\n}\n\n@keyframes grid-overlay {\n  0% {\n    opacity: 0.4;\n    transform: translateY(0) rotate(0deg);\n  }\n  50% {\n    opacity: 0.7;\n    transform: translateY(1px) rotate(0.2deg);\n  }\n  100% {\n    opacity: 0.6;\n    transform: translateY(-0.5px) rotate(-0.1deg);\n  }\n}\n\n/* Dark Theme Drag Over State Enhancement */\n.dark .canvas-grid[data-drag-over=\"true\"] {\n  background-color: hsl(var(--primary) / 0.08) !important;\n  background-image: \n    radial-gradient(circle, hsl(var(--primary) / 0.4) 1px, transparent 1px),\n    linear-gradient(hsl(var(--primary) / 0.15) 1px, transparent 1px),\n    linear-gradient(90deg, hsl(var(--primary) / 0.15) 1px, transparent 1px) !important;\n  box-shadow: \n    inset 0 0 30px hsl(var(--primary) / 0.2),\n    inset 0 0 60px hsl(var(--primary) / 0.1);\n  animation: pulse-grid-dark 1.5s ease-in-out infinite alternate;\n}\n\n@keyframes pulse-grid-dark {\n  from {\n    opacity: 0.8;\n    box-shadow: \n      inset 0 0 30px hsl(var(--primary) / 0.2),\n      inset 0 0 60px hsl(var(--primary) / 0.1);\n  }\n  to {\n    opacity: 1;\n    box-shadow: \n      inset 0 0 40px hsl(var(--primary) / 0.25),\n      inset 0 0 80px hsl(var(--primary) / 0.15);\n  }\n}\n\n/* Canvas Controls Dark Theme Enhancement */\n.dark .canvas-controls {\n  animation: controls-fade-in 0.8s ease-out;\n}\n\n.dark .canvas-controls button {\n  background: \n    linear-gradient(135deg, \n      hsl(var(--card) / 0.95) 0%, \n      hsl(var(--surface-1) / 0.9) 100%\n    );\n  backdrop-filter: blur(16px);\n  border: 1px solid hsl(var(--border) / 0.4);\n  position: relative;\n  overflow: hidden;\n  box-shadow: \n    0 4px 6px -1px hsl(var(--background) / 0.1),\n    0 2px 4px -1px hsl(var(--background) / 0.06),\n    inset 0 1px 0 hsl(var(--muted) / 0.1);\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n.dark .canvas-controls button::before {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: linear-gradient(45deg, \n    transparent 0%, \n    hsl(var(--primary) / 0.1) 50%, \n    transparent 100%\n  );\n  transform: translateX(-100%);\n  transition: transform 0.6s ease;\n}\n\n.dark .canvas-controls button:hover::before {\n  transform: translateX(100%);\n}\n\n.dark .canvas-controls button:hover {\n  background: \n    linear-gradient(135deg, \n      hsl(var(--primary) / 0.15) 0%, \n      hsl(var(--surface-2) / 0.8) 100%\n    );\n  border-color: hsl(var(--primary) / 0.5);\n  transform: translateY(-1px);\n  box-shadow: \n    0 10px 15px -3px hsl(var(--background) / 0.2),\n    0 4px 6px -2px hsl(var(--background) / 0.1),\n    inset 0 1px 0 hsl(var(--primary) / 0.2),\n    0 0 0 1px hsl(var(--primary) / 0.3);\n}\n\n.dark .canvas-controls button:active {\n  transform: translateY(0);\n  box-shadow: \n    0 4px 6px -1px hsl(var(--background) / 0.1),\n    0 2px 4px -1px hsl(var(--background) / 0.06),\n    inset 0 2px 4px hsl(var(--background) / 0.1);\n}\n\n.dark .canvas-controls .zoom-indicator {\n  background: \n    linear-gradient(135deg, \n      hsl(var(--muted) / 0.3) 0%, \n      hsl(var(--surface-1) / 0.4) 100%\n    );\n  border-color: hsl(var(--border) / 0.3);\n  color: hsl(var(--primary));\n  font-weight: 600;\n  position: relative;\n  overflow: hidden;\n}\n\n.dark .canvas-controls .zoom-indicator::after {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: linear-gradient(90deg, \n    transparent 0%, \n    hsl(var(--primary) / 0.1) 50%, \n    transparent 100%\n  );\n  transform: translateX(-100%);\n  transition: transform 0.4s ease;\n}\n\n.dark .canvas-controls:hover .zoom-indicator::after {\n  animation: zoom-shimmer 2s ease-in-out infinite;\n}\n\n@keyframes controls-fade-in {\n  from {\n    opacity: 0;\n    transform: translateY(-10px) scale(0.95);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0) scale(1);\n  }\n}\n\n@keyframes zoom-shimmer {\n  0%, 100% {\n    transform: translateX(-100%);\n  }\n  50% {\n    transform: translateX(100%);\n  }\n}\n\n/* Drop Hint Animations */\n@keyframes drop-hint-pulse {\n  0%, 100% {\n    border-color: hsl(var(--border) / 0.5);\n    box-shadow: \n      0 20px 25px -5px hsl(var(--background) / 0.15),\n      0 10px 10px -5px hsl(var(--background) / 0.08),\n      inset 0 1px 0 hsl(var(--muted) / 0.15);\n  }\n  50% {\n    border-color: hsl(var(--primary) / 0.3);\n    box-shadow: \n      0 24px 30px -6px hsl(var(--background) / 0.18),\n      0 12px 12px -6px hsl(var(--background) / 0.1),\n      inset 0 1px 0 hsl(var(--primary) / 0.1),\n      0 0 0 1px hsl(var(--primary) / 0.1);\n  }\n}\n\n@keyframes border-glow {\n  0% {\n    opacity: 0.3;\n    transform: scale(1);\n  }\n  100% {\n    opacity: 0.6;\n    transform: scale(1.02);\n  }\n}\n\n@keyframes drop-hint-hover {\n  0% {\n    box-shadow: \n      0 32px 40px -12px hsl(var(--background) / 0.25),\n      0 16px 20px -8px hsl(var(--background) / 0.15),\n      inset 0 2px 0 hsl(var(--primary) / 0.2),\n      0 0 0 1px hsl(var(--primary) / 0.2),\n      0 0 20px hsl(var(--primary) / 0.1);\n  }\n  100% {\n    box-shadow: \n      0 36px 45px -14px hsl(var(--background) / 0.3),\n      0 18px 24px -10px hsl(var(--background) / 0.18),\n      inset 0 3px 0 hsl(var(--primary) / 0.25),\n      0 0 0 2px hsl(var(--primary) / 0.25),\n      0 0 30px hsl(var(--primary) / 0.15);\n  }\n}\n\n/* Enhanced Canvas Node Interactions for Dark Theme */\n.dark .canvas-grid .canvas-node {\n  filter: drop-shadow(0 4px 8px hsl(var(--background) / 0.2));\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n.dark .canvas-grid .canvas-node:hover {\n  filter: drop-shadow(0 8px 16px hsl(var(--background) / 0.3));\n  transform: translateY(-1px);\n}\n\n/* Canvas Cursor States */\n.dark .canvas-grid {\n  cursor: crosshair;\n}\n\n.dark .canvas-grid[data-drag-over=\"true\"] {\n  cursor: copy;\n}\n\n/* Advanced Settings Enhanced Theme Support */\n.advanced-settings-container {\n  background: linear-gradient(135deg, \n    hsl(var(--background)) 0%, \n    hsl(var(--muted) / 0.1) 100%\n  );\n  border: 1px solid hsl(var(--border) / 0.5);\n  border-radius: 0.5rem;\n  transition: all 0.3s ease;\n}\n\n.dark .advanced-settings-container {\n  background: linear-gradient(135deg, \n    hsl(var(--background)) 0%, \n    hsl(var(--muted) / 0.05) 100%\n  );\n  border: 1px solid hsl(var(--border) / 0.3);\n  box-shadow: \n    0 4px 6px -1px hsl(var(--background) / 0.1),\n    0 2px 4px -1px hsl(var(--background) / 0.06),\n    inset 0 1px 0 hsl(var(--muted) / 0.1);\n}\n\n/* Setting Item Enhanced Styling */\n.setting-item {\n  background: hsl(var(--card) / 0.5);\n  border: 1px solid hsl(var(--border) / 0.5);\n  border-radius: 0.5rem;\n  padding: 0.75rem;\n  transition: all 0.2s ease;\n  position: relative;\n  overflow: hidden;\n}\n\n.setting-item::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: linear-gradient(135deg, transparent 0%, hsl(var(--primary) / 0.02) 100%);\n  opacity: 0;\n  transition: opacity 0.2s ease;\n  pointer-events: none;\n}\n\n.setting-item:hover::before {\n  opacity: 1;\n}\n\n.dark .setting-item {\n  background: hsl(var(--card) / 0.3);\n  border: 1px solid hsl(var(--border) / 0.4);\n  box-shadow: \n    0 1px 3px 0 hsl(var(--background) / 0.1),\n    0 1px 2px 0 hsl(var(--background) / 0.06);\n}\n\n.dark .setting-item:hover {\n  background: hsl(var(--card) / 0.6);\n  border-color: hsl(var(--primary) / 0.3);\n  box-shadow: \n    0 4px 6px -1px hsl(var(--background) / 0.1),\n    0 2px 4px -1px hsl(var(--background) / 0.06),\n    0 0 0 1px hsl(var(--primary) / 0.1);\n}\n\n/* Enhanced Switch Styling for Dark Theme */\n.dark [role=\"switch\"][data-state=\"checked\"] {\n  background: hsl(var(--primary));\n  border: 3px solid hsl(var(--primary));\n  box-shadow: \n    0 0 0 2px hsl(var(--background)),\n    0 0 0 4px hsl(var(--primary) / 0.5),\n    0 0 10px hsl(var(--primary) / 0.3),\n    0 2px 6px hsl(var(--background) / 0.2),\n    inset 0 1px 2px hsl(var(--primary) / 0.2);\n}\n\n.dark [role=\"switch\"][data-state=\"unchecked\"] {\n  background: hsl(var(--muted) / 0.3);\n  border: 3px solid hsl(var(--border) / 0.8);\n  box-shadow: \n    0 0 0 2px hsl(var(--border) / 0.4),\n    0 2px 4px hsl(var(--background) / 0.3),\n    inset 0 1px 2px hsl(var(--muted) / 0.3);\n}\n\n.dark [role=\"switch\"]:hover {\n  transform: scale(1.05);\n  box-shadow: \n    0 0 0 3px hsl(var(--background)),\n    0 0 0 6px hsl(var(--ring) / 0.3),\n    0 4px 8px hsl(var(--background) / 0.2);\n  transition: all 0.2s ease;\n}\n\n.dark [role=\"switch\"][data-state=\"checked\"]:hover {\n  box-shadow: \n    0 0 0 3px hsl(var(--background)),\n    0 0 0 6px hsl(var(--primary) / 0.5),\n    0 0 15px hsl(var(--primary) / 0.4),\n    0 4px 8px hsl(var(--background) / 0.2);\n}\n\n/* Enhanced Switch Thumb Styling for Dark Theme */\n.dark [role=\"switch\"] [data-state=\"checked\"] {\n  background: hsl(var(--primary-foreground));\n  border: 2px solid hsl(var(--primary-foreground));\n  box-shadow: \n    0 0 0 1px hsl(var(--primary)),\n    0 0 8px hsl(var(--primary) / 0.4),\n    0 3px 6px hsl(var(--background) / 0.3);\n}\n\n.dark [role=\"switch\"] [data-state=\"unchecked\"] {\n  background: hsl(var(--background));\n  border: 2px solid hsl(var(--muted-foreground) / 0.6);\n  box-shadow: \n    0 0 0 1px hsl(var(--border)),\n    0 3px 6px hsl(var(--background) / 0.4),\n    0 0 4px hsl(var(--muted) / 0.3);\n}\n\n/* Enhanced Checkbox Styling for Dark Theme */\n.dark input[type=\"checkbox\"] {\n  appearance: none;\n  width: 1.2rem;\n  height: 1.2rem;\n  border: 3px solid hsl(var(--border) / 0.8);\n  border-radius: 0.375rem;\n  background: hsl(var(--background));\n  position: relative;\n  cursor: pointer;\n  transition: all 0.2s ease;\n  box-shadow: \n    0 0 0 1px hsl(var(--border) / 0.4),\n    0 2px 4px hsl(var(--background) / 0.3),\n    inset 0 1px 2px hsl(var(--muted) / 0.2);\n}\n\n.dark input[type=\"checkbox\"]:hover {\n  border-color: hsl(var(--primary) / 0.8);\n  box-shadow: \n    0 0 0 3px hsl(var(--primary) / 0.3),\n    0 0 8px hsl(var(--primary) / 0.2),\n    0 2px 4px hsl(var(--background) / 0.3);\n  transform: scale(1.08);\n}\n\n.dark input[type=\"checkbox\"]:checked {\n  background: hsl(var(--primary));\n  border-color: hsl(var(--primary));\n  box-shadow: \n    0 0 0 3px hsl(var(--primary) / 0.4),\n    0 0 10px hsl(var(--primary) / 0.3),\n    0 2px 6px hsl(var(--background) / 0.3),\n    inset 0 1px 2px hsl(var(--primary) / 0.2);\n}\n\n.dark input[type=\"checkbox\"]:checked::before {\n  content: '✓';\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  color: hsl(var(--primary-foreground));\n  font-size: 0.875rem;\n  font-weight: 900;\n  line-height: 1;\n  text-shadow: 0 1px 2px hsl(var(--primary) / 0.3);\n}\n\n.dark input[type=\"checkbox\"]:focus {\n  outline: none;\n  box-shadow: \n    0 0 0 3px hsl(var(--ring) / 0.3),\n    0 0 0 6px hsl(var(--ring) / 0.15),\n    0 2px 4px hsl(var(--background) / 0.3);\n}\n\n.dark input[type=\"checkbox\"]:disabled {\n  opacity: 0.4;\n  cursor: not-allowed;\n  filter: grayscale(0.5);\n}\n\n/* Enhanced Radix Checkbox Styling for Dark Theme */\n.dark [role=\"checkbox\"] {\n  border: 3px solid hsl(var(--border) / 0.8);\n  background: hsl(var(--background));\n  box-shadow: \n    0 0 0 1px hsl(var(--border) / 0.4),\n    0 2px 4px hsl(var(--background) / 0.3),\n    inset 0 1px 2px hsl(var(--muted) / 0.2);\n  transition: all 0.2s ease;\n}\n\n.dark [role=\"checkbox\"]:hover {\n  border-color: hsl(var(--primary) / 0.8);\n  box-shadow: \n    0 0 0 3px hsl(var(--primary) / 0.3),\n    0 0 8px hsl(var(--primary) / 0.2),\n    0 2px 4px hsl(var(--background) / 0.3);\n  transform: scale(1.08);\n}\n\n.dark [role=\"checkbox\"][data-state=\"checked\"] {\n  background: hsl(var(--primary));\n  border-color: hsl(var(--primary));\n  box-shadow: \n    0 0 0 3px hsl(var(--primary) / 0.4),\n    0 0 10px hsl(var(--primary) / 0.3),\n    0 2px 6px hsl(var(--background) / 0.3),\n    inset 0 1px 2px hsl(var(--primary) / 0.2);\n}\n\n.dark [role=\"checkbox\"][data-state=\"checked\"]:hover {\n  box-shadow: \n    0 0 0 3px hsl(var(--primary) / 0.5),\n    0 0 12px hsl(var(--primary) / 0.4),\n    0 2px 6px hsl(var(--background) / 0.3);\n}\n\n/* Enhanced Token Settings & Settings Panel Containers */\n.dark .toggle-container {\n  background: hsl(var(--card) / 0.4);\n  border: 2px solid hsl(var(--border) / 0.6);\n  border-radius: 0.75rem;\n  padding: 1rem;\n  box-shadow: \n    0 2px 4px hsl(var(--background) / 0.2),\n    0 0 0 1px hsl(var(--border) / 0.3),\n    inset 0 1px 2px hsl(var(--muted) / 0.1);\n}\n\n.dark .toggle-container:hover {\n  border-color: hsl(var(--primary) / 0.4);\n  box-shadow: \n    0 4px 8px hsl(var(--background) / 0.3),\n    0 0 0 2px hsl(var(--primary) / 0.2),\n    inset 0 1px 2px hsl(var(--muted) / 0.2);\n}\n\n/* Enhanced Labels for Toggle Items */\n.dark .toggle-label {\n  color: hsl(var(--foreground) / 0.9);\n  font-weight: 500;\n  text-shadow: 0 1px 2px hsl(var(--background) / 0.1);\n}\n\n.dark .toggle-description {\n  color: hsl(var(--muted-foreground) / 0.8);\n  font-size: 0.875rem;\n  text-shadow: 0 1px 1px hsl(var(--background) / 0.1);\n}\n\n/* Light Theme Enhancements for Checkboxes and Switches */\ninput[type=\"checkbox\"] {\n  appearance: none;\n  width: 1rem;\n  height: 1rem;\n  border: 2px solid hsl(var(--border));\n  border-radius: 0.25rem;\n  background: hsl(var(--background));\n  position: relative;\n  cursor: pointer;\n  transition: all 0.2s ease;\n  box-shadow: \n    0 1px 2px hsl(var(--muted-foreground) / 0.1),\n    0 0 0 1px hsl(var(--border) / 0.3);\n}\n\ninput[type=\"checkbox\"]:hover {\n  border-color: hsl(var(--primary) / 0.6);\n  box-shadow: \n    0 0 0 2px hsl(var(--primary) / 0.2),\n    0 1px 2px hsl(var(--muted-foreground) / 0.1);\n  transform: scale(1.05);\n}\n\ninput[type=\"checkbox\"]:checked {\n  background: hsl(var(--primary));\n  border-color: hsl(var(--primary));\n  box-shadow: \n    0 0 0 2px hsl(var(--primary) / 0.3),\n    0 0 4px hsl(var(--primary) / 0.2),\n    0 1px 2px hsl(var(--muted-foreground) / 0.1);\n}\n\ninput[type=\"checkbox\"]:checked::before {\n  content: '✓';\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  color: hsl(var(--primary-foreground));\n  font-size: 0.75rem;\n  font-weight: bold;\n  line-height: 1;\n}\n\ninput[type=\"checkbox\"]:focus {\n  outline: none;\n  box-shadow: \n    0 0 0 2px hsl(var(--ring) / 0.2),\n    0 0 0 4px hsl(var(--ring) / 0.1),\n    0 1px 2px hsl(var(--muted-foreground) / 0.1);\n}\n\n/* Enhanced Radix Checkbox Light Theme */\n[role=\"checkbox\"] {\n  border: 2px solid hsl(var(--border));\n  background: hsl(var(--background));\n  box-shadow: \n    0 1px 2px hsl(var(--muted-foreground) / 0.1),\n    0 0 0 1px hsl(var(--border) / 0.3);\n  transition: all 0.2s ease;\n}\n\n[role=\"checkbox\"]:hover {\n  border-color: hsl(var(--primary) / 0.6);\n  box-shadow: \n    0 0 0 2px hsl(var(--primary) / 0.2),\n    0 1px 2px hsl(var(--muted-foreground) / 0.1);\n  transform: scale(1.05);\n}\n\n[role=\"checkbox\"][data-state=\"checked\"] {\n  background: hsl(var(--primary));\n  border-color: hsl(var(--primary));\n  box-shadow: \n    0 0 0 2px hsl(var(--primary) / 0.3),\n    0 0 4px hsl(var(--primary) / 0.2),\n    0 1px 2px hsl(var(--muted-foreground) / 0.1);\n}\n\n[role=\"checkbox\"][data-state=\"checked\"]:hover {\n  box-shadow: \n    0 0 0 2px hsl(var(--primary) / 0.4),\n    0 0 6px hsl(var(--primary) / 0.3),\n    0 1px 2px hsl(var(--muted-foreground) / 0.1);\n}\n\n/* Enhanced Switch Light Theme */\n[role=\"switch\"][data-state=\"checked\"] {\n  background: hsl(var(--primary));\n  border: 2px solid hsl(var(--primary) / 0.3);\n  box-shadow: \n    0 0 0 2px hsl(var(--background)),\n    0 0 0 4px hsl(var(--primary) / 0.2),\n    0 2px 4px hsl(var(--muted-foreground) / 0.1);\n}\n\n[role=\"switch\"][data-state=\"unchecked\"] {\n  background: hsl(var(--input));\n  border: 2px solid hsl(var(--border));\n  box-shadow: \n    0 0 0 1px hsl(var(--border) / 0.5),\n    0 1px 2px hsl(var(--muted-foreground) / 0.1);\n}\n\n[role=\"switch\"]:hover {\n  transform: scale(1.02);\n  box-shadow: \n    0 0 0 2px hsl(var(--background)),\n    0 0 0 4px hsl(var(--ring) / 0.2),\n    0 2px 4px hsl(var(--muted-foreground) / 0.1);\n  transition: all 0.2s ease;\n}\n\n[role=\"switch\"][data-state=\"checked\"]:hover {\n  box-shadow: \n    0 0 0 2px hsl(var(--background)),\n    0 0 0 4px hsl(var(--primary) / 0.3),\n    0 0 8px hsl(var(--primary) / 0.2),\n    0 2px 4px hsl(var(--muted-foreground) / 0.1);\n}\n\n/* Accordion Enhanced Styling */\n.dark [data-state=\"open\"] > [data-orientation=\"horizontal\"] {\n  border-bottom-color: hsl(var(--border) / 0.5);\n}\n\n.dark [data-radix-accordion-trigger] {\n  transition: all 0.2s ease;\n}\n\n.dark [data-radix-accordion-trigger]:hover {\n  background: hsl(var(--muted) / 0.1);\n  border-radius: 0.25rem;\n}\n\n/* Enhanced Gradient Text for Dark Theme */\n.dark .gradient-command-text {\n  background: linear-gradient(135deg, \n    hsl(var(--foreground)) 0%, \n    hsl(var(--primary)) 50%, \n    hsl(var(--muted-foreground)) 100%\n  );\n  -webkit-background-clip: text;\n  -webkit-text-fill-color: transparent;\n  background-clip: text;\n}\n\n/* Setting Group Enhanced Styling */\n.setting-group {\n  background: linear-gradient(135deg, \n    hsl(var(--background)) 0%, \n    hsl(var(--muted) / 0.05) 100%\n  );\n  border: 1px solid hsl(var(--border) / 0.3);\n  border-radius: 0.5rem;\n  overflow: hidden;\n}\n\n.dark .setting-group {\n  background: linear-gradient(135deg, \n    hsl(var(--background)) 0%, \n    hsl(var(--muted) / 0.03) 100%\n  );\n  border: 1px solid hsl(var(--border) / 0.2);\n  box-shadow: \n    inset 0 1px 0 hsl(var(--muted) / 0.05),\n    0 1px 3px 0 hsl(var(--background) / 0.1);\n}\n\n/* Canvas Grid Enhancements */\n.canvas-grid {\n  position: relative;\n  transition: all 0.3s ease;\n}\n\n.canvas-grid::before {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: radial-gradient(circle at 50% 50%, \n    hsl(var(--primary) / 0.02) 0%, \n    transparent 50%\n  );\n  pointer-events: none;\n  opacity: 0;\n  transition: opacity 0.3s ease;\n}\n\n.canvas-grid:hover::before {\n  opacity: 1;\n}\n\n.dark .canvas-grid {\n  background-image: \n    radial-gradient(circle, hsl(var(--muted-foreground) / 0.25) 1px, transparent 1px),\n    linear-gradient(hsl(var(--muted-foreground) / 0.05) 1px, transparent 1px),\n    linear-gradient(90deg, hsl(var(--muted-foreground) / 0.05) 1px, transparent 1px) !important;\n}\n\n/* Canvas Controls Enhancements */\n.canvas-controls {\n  animation: slideInFromTop 0.5s ease-out;\n}\n\n@keyframes slideInFromTop {\n  from {\n    opacity: 0;\n    transform: translateY(-20px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n.dark .canvas-controls button {\n  background: hsl(var(--background) / 0.9);\n  backdrop-filter: blur(10px);\n  border: 1px solid hsl(var(--border) / 0.7);\n  box-shadow: \n    0 4px 6px -1px hsl(var(--background) / 0.1),\n    0 2px 4px -1px hsl(var(--background) / 0.06),\n    inset 0 1px 0 hsl(var(--foreground) / 0.1);\n}\n\n.dark .canvas-controls button:hover {\n  background: hsl(var(--muted) / 0.8);\n  border-color: hsl(var(--primary) / 0.5);\n  box-shadow: \n    0 8px 10px -2px hsl(var(--background) / 0.15),\n    0 4px 6px -1px hsl(var(--background) / 0.1),\n    inset 0 1px 0 hsl(var(--foreground) / 0.15);\n}\n\n/* Modern Canvas Grid Styles */\n.canvas-grid-modern {\n  position: relative;\n  transition: all 0.3s ease;\n}\n\n.canvas-grid-modern[data-drag-over=\"true\"] {\n  background-color: rgba(59, 130, 246, 0.05) !important;\n  background-image: \n    radial-gradient(circle at 1px 1px, rgba(59, 130, 246, 0.4) 1px, transparent 0),\n    linear-gradient(90deg, rgba(59, 130, 246, 0.2) 1px, transparent 1px),\n    linear-gradient(rgba(59, 130, 246, 0.2) 1px, transparent 1px) !important;\n  box-shadow: inset 0 0 60px rgba(59, 130, 246, 0.1);\n}\n\n/* Dark theme canvas styles */\n.dark .canvas-grid-modern {\n  background-image: \n    radial-gradient(circle at 1px 1px, rgba(99, 102, 241, 0.2) 1px, transparent 0),\n    linear-gradient(90deg, rgba(100, 116, 139, 0.15) 1px, transparent 1px),\n    linear-gradient(rgba(100, 116, 139, 0.15) 1px, transparent 1px) !important;\n}\n\n.dark .canvas-grid-modern[data-drag-over=\"true\"] {\n  background-color: rgba(99, 102, 241, 0.08) !important;\n  background-image: \n    radial-gradient(circle at 1px 1px, rgba(99, 102, 241, 0.5) 1px, transparent 0),\n    linear-gradient(90deg, rgba(99, 102, 241, 0.25) 1px, transparent 1px),\n    linear-gradient(rgba(99, 102, 241, 0.25) 1px, transparent 1px) !important;\n  box-shadow: inset 0 0 80px rgba(99, 102, 241, 0.15);\n}\n\n/* Enhanced shadows for modern look */\n.shadow-3xl {\n  box-shadow: 0 35px 60px -12px rgba(0, 0, 0, 0.25), 0 0 40px rgba(59, 130, 246, 0.1);\n}\n\n/* Modern canvas node shadows */\n.canvas-node-modern {\n  filter: drop-shadow(0 10px 25px rgba(0, 0, 0, 0.1)) drop-shadow(0 4px 12px rgba(0, 0, 0, 0.06));\n}\n\n.dark .canvas-node-modern {\n  filter: drop-shadow(0 10px 25px rgba(0, 0, 0, 0.4)) drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));\n}\n\n/* Canvas Zoom Indicator */\n.zoom-indicator {\n  position: relative;\n  overflow: hidden;\n}\n\n.zoom-indicator::after {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: linear-gradient(90deg, \n    transparent 0%, \n    hsl(var(--primary) / 0.1) 50%, \n    transparent 100%\n  );\n  transform: translateX(-100%);\n  transition: transform 0.3s ease;\n}\n\n.zoom-indicator:hover::after {\n  transform: translateX(100%);\n}\n\n/* Canvas Selection Area */\n.canvas-selection {\n  position: absolute;\n  border: 2px dashed hsl(var(--primary));\n  background: hsl(var(--primary) / 0.1);\n  border-radius: 4px;\n  pointer-events: none;\n  animation: dash-border 1s linear infinite;\n}\n\n/* Enhanced Zoom Controls */\n.zoom-controls {\n  position: relative;\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n.zoom-controls:hover {\n  transform: scale(1.02);\n  box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.25);\n}\n\n.zoom-indicator {\n  position: relative;\n  overflow: hidden;\n  font-variant-numeric: tabular-nums;\n  transition: all 0.3s ease;\n}\n\n.zoom-indicator:hover {\n  background: linear-gradient(135deg, \n    hsl(var(--primary) / 0.1) 0%, \n    hsl(var(--primary) / 0.05) 100%\n  );\n  color: hsl(var(--primary));\n}\n\n.zoom-indicator::before {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: linear-gradient(90deg, \n    transparent 0%, \n    hsl(var(--primary) / 0.1) 50%, \n    transparent 100%\n  );\n  transform: translateX(-100%);\n  transition: transform 0.4s ease;\n}\n\n.zoom-indicator:hover::before {\n  transform: translateX(100%);\n}\n\n/* Zoom Button States */\n.zoom-button {\n  position: relative;\n  overflow: hidden;\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n.zoom-button:hover {\n  background: linear-gradient(135deg, \n    hsl(var(--primary) / 0.1) 0%, \n    hsl(var(--primary) / 0.05) 100%\n  );\n  transform: translateY(-1px);\n  box-shadow: 0 4px 12px -2px hsl(var(--primary) / 0.3);\n}\n\n.zoom-button:active {\n  transform: translateY(0);\n  box-shadow: 0 2px 8px -2px hsl(var(--primary) / 0.3);\n}\n\n.zoom-button:disabled {\n  opacity: 0.4;\n  transform: none;\n  box-shadow: none;\n}\n\n.zoom-button::before {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: linear-gradient(45deg, \n    transparent 0%, \n    hsl(var(--primary) / 0.1) 50%, \n    transparent 100%\n  );\n  transform: translateX(-100%);\n  transition: transform 0.6s ease;\n}\n\n.zoom-button:hover::before {\n  transform: translateX(100%);\n}\n\n/* Canvas Cursor States */\n.canvas-panning {\n  cursor: grabbing !important;\n}\n\n.canvas-panning * {\n  cursor: grabbing !important;\n}\n\n.canvas-zoom-cursor {\n  cursor: zoom-in;\n}\n\n.canvas-zoom-cursor.zoomed-in {\n  cursor: zoom-out;\n}\n\n/* Smooth Zoom Animation */\n.canvas-transform {\n  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n.canvas-transform.fast {\n  transition: transform 0.1s ease-out;\n}\n\n/* Fit to Content Animation */\n@keyframes fit-content {\n  0% {\n    opacity: 0.8;\n    transform: scale(1.05);\n  }\n  50% {\n    opacity: 0.9;\n    transform: scale(0.95);\n  }\n  100% {\n    opacity: 1;\n    transform: scale(1);\n  }\n}\n\n.canvas-fit-animation {\n  animation: fit-content 0.8s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n/* Grid Background Zoom Effects */\n.canvas-grid-zoomed {\n  background-attachment: fixed;\n  background-repeat: repeat;\n}\n\n.canvas-grid-zoomed::before {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: radial-gradient(circle at 50% 50%, \n    hsl(var(--primary) / 0.03) 0%, \n    transparent 50%\n  );\n  pointer-events: none;\n  opacity: 0;\n  transition: opacity 0.3s ease;\n}\n\n.canvas-grid-zoomed:hover::before {\n  opacity: 1;\n}\n\n/* Minimap Styles */\n.canvas-minimap {\n  position: absolute;\n  bottom: 20px;\n  right: 20px;\n  width: 200px;\n  height: 150px;\n  background: hsl(var(--card) / 0.9);\n  border: 1px solid hsl(var(--border));\n  border-radius: 8px;\n  backdrop-filter: blur(8px);\n  overflow: hidden;\n  transition: all 0.3s ease;\n}\n\n.canvas-minimap:hover {\n  transform: scale(1.1);\n  box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.15);\n}\n\n.canvas-minimap-viewport {\n  position: absolute;\n  border: 2px solid hsl(var(--primary));\n  background: hsl(var(--primary) / 0.1);\n  cursor: move;\n  transition: all 0.2s ease;\n}\n\n.canvas-minimap-viewport:hover {\n  background: hsl(var(--primary) / 0.2);\n  border-color: hsl(var(--primary) / 0.8);\n}\n\n@keyframes dash-border {\n  to {\n    stroke-dashoffset: 20;\n  }\n}\n\n.dark .canvas-selection {\n  border-color: hsl(var(--primary) / 0.8);\n  background: hsl(var(--primary) / 0.15);\n  box-shadow: 0 0 10px hsl(var(--primary) / 0.3);\n}\n\n/* Live Preview Styles for Rich Text Editor */\n.live-preview-code {\n  background-color: rgba(255, 255, 255, 0.8);\n  color: #1f2937;\n  padding: 2px 6px;\n  border-radius: 4px;\n  font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;\n  font-size: 0.85em;\n  border: 1px solid rgba(255, 255, 255, 0.6);\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);\n}\n\n.dark .live-preview-code {\n  background-color: rgba(0, 0, 0, 0.3);\n  color: #f1f5f9;\n  border-color: rgba(255, 255, 255, 0.1);\n}\n\n.live-preview-bold {\n  font-weight: 700;\n  color: inherit;\n}\n\n.live-preview-italic {\n  font-style: italic;\n  color: inherit;\n}\n\n.live-preview-underline {\n  text-decoration: underline;\n  color: inherit;\n}\n\n.live-preview-strikethrough {\n  text-decoration: line-through;\n  color: inherit;\n}\n\n/* Inline Rich Editor Styles */\n.inline-format-bold {\n  font-weight: 700;\n  color: #1e40af;\n}\n\n.dark .inline-format-bold {\n  color: #60a5fa;\n}\n\n.inline-format-italic {\n  font-style: italic;\n  color: #7c3aed;\n}\n\n.dark .inline-format-italic {\n  color: #a78bfa;\n}\n\n.inline-format-underline {\n  text-decoration: underline;\n  color: #059669;\n}\n\n.dark .inline-format-underline {\n  color: #34d399;\n}\n\n.inline-format-strikethrough {\n  text-decoration: line-through;\n  color: #dc2626;\n}\n\n.dark .inline-format-strikethrough {\n  color: #f87171;\n}\n\n.inline-format-code {\n  background-color: #f1f5f9;\n  color: #475569;\n  padding: 2px 4px;\n  border-radius: 3px;\n  font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;\n  font-size: 0.9em;\n  border: 1px solid #e2e8f0;\n}\n\n.dark .inline-format-code {\n  background-color: #334155;\n  color: #cbd5e1;\n  border-color: #475569;\n}\n\n.inline-format-pre {\n  background-color: #f8fafc;\n  color: #334155;\n  padding: 8px;\n  border-radius: 4px;\n  font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;\n  white-space: pre-wrap;\n  margin: 8px 0;\n  border: 1px solid #e2e8f0;\n  display: block;\n}\n\n.dark .inline-format-pre {\n  background-color: #1e293b;\n  color: #e2e8f0;\n  border-color: #334155;\n}\n\n.inline-format-link {\n  color: #2563eb;\n  text-decoration: underline;\n}\n\n.dark .inline-format-link {\n  color: #3b82f6;\n}\n\n.inline-format-quote {\n  border-left: 4px solid #e2e8f0;\n  padding-left: 12px;\n  margin: 8px 0;\n  color: #64748b;\n  font-style: italic;\n  display: block;\n}\n\n.dark .inline-format-quote {\n  border-left-color: #334155;\n  color: #94a3b8;\n}\n\n.inline-format-heading {\n  font-size: 1.25rem;\n  font-weight: 600;\n  margin: 8px 0;\n  color: #1e293b;\n  display: block;\n}\n\n.dark .inline-format-heading {\n  color: #f1f5f9;\n}\n\n.live-preview-pre {\n  background-color: #f3f4f6;\n  color: #1f2937;\n  padding: 8px;\n  border-radius: 4px;\n  font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;\n  white-space: pre-wrap;\n  margin: 8px 0;\n  border: 1px solid #e5e7eb;\n  overflow-x: auto;\n}\n\n.dark .live-preview-pre {\n  background-color: #374151;\n  color: #f9fafb;\n  border-color: #4b5563;\n}\n\n.live-preview-link {\n  color: #3b82f6;\n  text-decoration: underline;\n  cursor: pointer;\n}\n\n.dark .live-preview-link {\n  color: #60a5fa;\n}\n\n.live-preview-link:hover {\n  color: #1d4ed8;\n}\n\n.dark .live-preview-link:hover {\n  color: #93c5fd;\n}\n\n.live-preview-quote {\n  border-left: 4px solid #e5e7eb;\n  padding-left: 12px;\n  margin: 8px 0;\n  color: #6b7280;\n  font-style: italic;\n}\n\n.dark .live-preview-quote {\n  border-left-color: #4b5563;\n  color: #9ca3af;\n}\n\n.live-preview-heading {\n  font-size: 1.25rem;\n  font-weight: 600;\n  margin: 8px 0;\n  color: #1f2937;\n}\n\n.dark .live-preview-heading {\n  color: #f9fafb;\n}\n\n/* Touch styles для мобильных устройств */\n@media (pointer: coarse) {\n  .canvas-node {\n    touch-action: none;\n  }\n  \n  .component-item {\n    touch-action: none;\n    user-select: none;\n  }\n  \n  /* Touch drag feedback */\n  .component-item:active {\n    transform: scale(0.95);\n    opacity: 0.8;\n  }\n  \n  /* Prevent text selection during touch drag */\n  .components-sidebar * {\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n  }\n  \n  /* Улучшенное перетаскивание на touch устройствах */\n  [draggable=\"true\"] {\n    -webkit-user-drag: element;\n    -webkit-touch-callout: none;\n    -webkit-user-select: none;\n    -khtml-user-select: none;\n    -moz-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n  }\n  \n  /* Touch feedback для элементов компонентов */\n  .components-sidebar [draggable=\"true\"]:active {\n    transform: scale(0.98);\n    transition: transform 0.1s ease;\n  }\n  \n  /* Увеличенные области для touch взаимодействия */\n  .components-sidebar button,\n  .components-sidebar [draggable=\"true\"] {\n    min-height: 44px;\n    min-width: 44px;\n  }\n}\n\n/* Улучшенная поддержка touch событий для мобильных устройств */\n.touch-action-none {\n  touch-action: none;\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n}\n\n.touch-action-manipulation {\n  touch-action: manipulation;\n}\n\n/* Предотвращение выделения текста при drag and drop */\n.no-select {\n  -webkit-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n  -webkit-touch-callout: none;\n  -webkit-tap-highlight-color: transparent;\n}\n\n/* Дополнительные стили для touch drag and drop */\n.touch-dragging {\n  opacity: 0.7;\n  transform: scale(0.95);\n  transition: all 0.2s ease;\n  pointer-events: none;\n}\n\n/* Мобильные оптимизации */\n@media (pointer: coarse) {\n  .component-item {\n    min-height: 44px; /* Минимальный размер для удобного touch взаимодействия */\n    padding: 12px 16px;\n  }\n  \n  .canvas-container {\n    overflow: auto;\n    -webkit-overflow-scrolling: touch;\n  }\n}\n\n","size_bytes":48339},"client/src/components/editor/smart-connection-creator.tsx":{"content":"import React, { useState, useCallback, useMemo } from 'react';\nimport { Node, Connection, Button } from '@/types/bot';\nimport { Badge } from '@/components/ui/badge';\nimport { Button as UIButton } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Switch } from '@/components/ui/switch';\nimport { Separator } from '@/components/ui/separator';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { \n  Plus, \n  Zap, \n  Target, \n  Link, \n  ArrowRight,\n  Lightbulb,\n  CheckCircle,\n  XCircle,\n  Settings,\n  Network,\n  Brain,\n  Wand2,\n  Sparkles\n} from 'lucide-react';\nimport { ConnectionManager, ConnectionSuggestion } from '@/utils/connection-manager';\nimport { cn } from '@/lib/utils';\n\ninterface SmartConnectionCreatorProps {\n  nodes: Node[];\n  connections: Connection[];\n  onConnectionAdd: (connection: Connection) => void;\n  onNodesChange: (nodes: Node[]) => void;\n  autoButtonCreation: boolean;\n  selectedNodeId?: string;\n}\n\ninterface ConnectionTemplate {\n  id: string;\n  name: string;\n  description: string;\n  sourceTypes: Node['type'][];\n  targetTypes: Node['type'][];\n  buttonTemplate: Partial<Button>;\n  priority: number;\n  useCase: string;\n}\n\nconst connectionTemplates: ConnectionTemplate[] = [\n  {\n    id: 'start-welcome',\n    name: 'Стартовое приветствие',\n    description: 'Переход от старта к приветственному сообщению',\n    sourceTypes: ['start'],\n    targetTypes: ['message'],\n    buttonTemplate: {\n      text: '👋 Начать',\n      action: 'goto'\n    },\n    priority: 1,\n    useCase: 'Первый контакт с пользователем'\n  },\n  {\n    id: 'menu-navigation',\n    name: 'Навигация по меню',\n    description: 'Переход от сообщения к интерактивному меню',\n    sourceTypes: ['message'],\n    targetTypes: ['keyboard'],\n    buttonTemplate: {\n      text: '📋 Меню',\n      action: 'goto'\n    },\n    priority: 2,\n    useCase: 'Предоставление вариантов выбора'\n  },\n  {\n    id: 'command-response',\n    name: 'Ответ на команду',\n    description: 'Автоматический ответ на команду пользователя',\n    sourceTypes: ['command'],\n    targetTypes: ['message', 'photo'],\n    buttonTemplate: {\n      text: '✅ Выполнить',\n      action: 'command'\n    },\n    priority: 3,\n    useCase: 'Обработка команд пользователя'\n  },\n  {\n    id: 'input-processing',\n    name: 'Обработка ввода',\n    description: 'Переход от ввода к обработке данных',\n    sourceTypes: ['input'],\n    targetTypes: ['message', 'condition'],\n    buttonTemplate: {\n      text: '💾 Сохранить',\n      action: 'goto'\n    },\n    priority: 4,\n    useCase: 'Сбор и обработка пользовательских данных'\n  },\n  {\n    id: 'media-showcase',\n    name: 'Демонстрация медиа',\n    description: 'Переход к отображению фото или медиаконтента',\n    sourceTypes: ['message', 'keyboard'],\n    targetTypes: ['photo'],\n    buttonTemplate: {\n      text: '🖼️ Показать',\n      action: 'goto'\n    },\n    priority: 5,\n    useCase: 'Представление визуального контента'\n  }\n];\n\nexport function SmartConnectionCreator({\n  nodes,\n  connections,\n  onConnectionAdd,\n  onNodesChange,\n  autoButtonCreation,\n  selectedNodeId\n}: SmartConnectionCreatorProps) {\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [activeTab, setActiveTab] = useState<'manual' | 'templates' | 'smart'>('smart');\n  const [selectedSourceId, setSelectedSourceId] = useState<string>(selectedNodeId || '');\n  const [selectedTargetId, setSelectedTargetId] = useState<string>('');\n  const [buttonText, setButtonText] = useState('');\n  const [buttonAction, setButtonAction] = useState<'goto' | 'command' | 'url'>('goto');\n  const [smartSuggestions, setSmartSuggestions] = useState<ConnectionSuggestion[]>([]);\n  const [isGeneratingSmartSuggestions, setIsGeneratingSmartSuggestions] = useState(false);\n\n  const connectionManager = useMemo(() => \n    new ConnectionManager({\n      nodes,\n      connections,\n      autoButtonCreation\n    }),\n    [nodes, connections, autoButtonCreation]\n  );\n\n  // Анализ недостающих связей\n  const missingConnections = useMemo(() => {\n    const orphanedNodes = nodes.filter(node => {\n      const hasIncoming = connections.some(conn => conn.target === node.id);\n      const hasOutgoing = connections.some(conn => conn.source === node.id);\n      \n      if (node.type === 'start') return !hasOutgoing;\n      if (node.type === 'command') return !hasOutgoing;\n      return !hasIncoming && !hasOutgoing;\n    });\n\n    return orphanedNodes;\n  }, [nodes, connections]);\n\n  // Подходящие шаблоны для выбранного узла\n  const applicableTemplates = useMemo(() => {\n    if (!selectedSourceId) return connectionTemplates;\n    \n    const sourceNode = nodes.find(n => n.id === selectedSourceId);\n    if (!sourceNode) return [];\n    \n    return connectionTemplates.filter(template => \n      template.sourceTypes.includes(sourceNode.type)\n    );\n  }, [selectedSourceId, nodes]);\n\n  // Доступные узлы для подключения\n  const availableTargets = useMemo(() => {\n    if (!selectedSourceId) return nodes;\n    \n    const existingTargets = new Set(\n      connections\n        .filter(conn => conn.source === selectedSourceId)\n        .map(conn => conn.target)\n    );\n    \n    return nodes.filter(node => \n      node.id !== selectedSourceId && !existingTargets.has(node.id)\n    );\n  }, [selectedSourceId, nodes, connections]);\n\n  const getNodeName = useCallback((nodeId: string) => {\n    const node = nodes.find(n => n.id === nodeId);\n    if (!node) return 'Неизвестный узел';\n    \n    const typeNames = {\n      start: 'Старт',\n      command: node.data.command || 'Команда',\n      message: 'Сообщение',\n      keyboard: 'Клавиатура',\n      photo: 'Фото',\n      condition: 'Условие',\n      input: 'Ввод'\n    };\n    \n    return typeNames[node.type] || node.type;\n  }, [nodes]);\n\n  const generateSmartSuggestions = useCallback(async () => {\n    setIsGeneratingSmartSuggestions(true);\n    try {\n      connectionManager.updateState({ nodes, connections });\n      const suggestions = connectionManager.generateConnectionSuggestions();\n      setSmartSuggestions(suggestions.slice(0, 10)); // Топ 10 предложений\n    } finally {\n      setIsGeneratingSmartSuggestions(false);\n    }\n  }, [connectionManager, nodes, connections]);\n\n  const createManualConnection = useCallback(() => {\n    if (!selectedSourceId || !selectedTargetId) return;\n    \n    try {\n      const { connection, updatedNodes } = connectionManager.createConnection(\n        selectedSourceId,\n        selectedTargetId,\n        {\n          autoCreateButton: autoButtonCreation,\n          buttonText: buttonText || undefined,\n          buttonAction: buttonAction\n        }\n      );\n      \n      onConnectionAdd(connection);\n      onNodesChange(updatedNodes);\n      \n      // Сброс формы\n      setSelectedTargetId('');\n      setButtonText('');\n      setIsDialogOpen(false);\n    } catch (error) {\n      console.error('Ошибка при создании связи:', error);\n    }\n  }, [\n    selectedSourceId,\n    selectedTargetId,\n    buttonText,\n    buttonAction,\n    connectionManager,\n    autoButtonCreation,\n    onConnectionAdd,\n    onNodesChange\n  ]);\n\n  const applyTemplate = useCallback((template: ConnectionTemplate) => {\n    if (!selectedSourceId) return;\n    \n    const sourceNode = nodes.find(n => n.id === selectedSourceId);\n    if (!sourceNode) return;\n    \n    const suitableTargets = availableTargets.filter(node => \n      template.targetTypes.includes(node.type)\n    );\n    \n    if (suitableTargets.length === 0) return;\n    \n    const targetNode = suitableTargets[0]; // Выбираем первый подходящий\n    \n    try {\n      const { connection, updatedNodes } = connectionManager.createConnection(\n        selectedSourceId,\n        targetNode.id,\n        {\n          autoCreateButton: true,\n          buttonText: template.buttonTemplate.text,\n          buttonAction: template.buttonTemplate.action\n        }\n      );\n      \n      onConnectionAdd(connection);\n      onNodesChange(updatedNodes);\n      setIsDialogOpen(false);\n    } catch (error) {\n      console.error('Ошибка при применении шаблона:', error);\n    }\n  }, [selectedSourceId, nodes, availableTargets, connectionManager, onConnectionAdd, onNodesChange]);\n\n  const applySuggestion = useCallback((suggestion: ConnectionSuggestion) => {\n    try {\n      const { connection, updatedNodes } = connectionManager.createConnection(\n        suggestion.connection.source,\n        suggestion.connection.target,\n        {\n          autoCreateButton: autoButtonCreation,\n          buttonText: suggestion.suggestedButton.text,\n          buttonAction: suggestion.suggestedButton.action\n        }\n      );\n      \n      onConnectionAdd(connection);\n      onNodesChange(updatedNodes);\n      \n      // Удаляем примененное предложение\n      setSmartSuggestions(prev => prev.filter(s => s.id !== suggestion.id));\n    } catch (error) {\n      console.error('Ошибка при применении предложения:', error);\n    }\n  }, [connectionManager, autoButtonCreation, onConnectionAdd, onNodesChange]);\n\n  const getConfidenceColor = useCallback((confidence: number) => {\n    if (confidence >= 0.8) return 'bg-green-100 text-green-800 border-green-200';\n    if (confidence >= 0.6) return 'bg-yellow-100 text-yellow-800 border-yellow-200';\n    return 'bg-red-100 text-red-800 border-red-200';\n  }, []);\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Статистика и быстрые действия */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Brain className=\"h-5 w-5\" />\n            Умное создание связей\n          </CardTitle>\n          <CardDescription>\n            Интеллектуальный анализ и автоматическое создание связей\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {/* Статистика */}\n          <div className=\"grid grid-cols-3 gap-4 mb-4\">\n            <div className=\"text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n              <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\n                {connections.length}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">Всего связей</div>\n            </div>\n            <div className=\"text-center p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg\">\n              <div className=\"text-2xl font-bold text-orange-600 dark:text-orange-400\">\n                {missingConnections.length}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">Изолированных узлов</div>\n            </div>\n            <div className=\"text-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg\">\n              <div className=\"text-2xl font-bold text-purple-600 dark:text-purple-400\">\n                {smartSuggestions.length}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">Предложений</div>\n            </div>\n          </div>\n\n          {/* Быстрые действия */}\n          <div className=\"flex gap-2 mb-4\">\n            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n              <DialogTrigger asChild>\n                <UIButton>\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Создать связь\n                </UIButton>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-2xl\">\n                <DialogHeader>\n                  <DialogTitle>Создание новой связи</DialogTitle>\n                  <DialogDescription>\n                    Выберите способ создания связи между узлами\n                  </DialogDescription>\n                </DialogHeader>\n                \n                <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as typeof activeTab)}>\n                  <TabsList className=\"grid w-full grid-cols-3\">\n                    <TabsTrigger value=\"smart\">\n                      <Sparkles className=\"h-4 w-4 mr-2\" />\n                      Умные предложения\n                    </TabsTrigger>\n                    <TabsTrigger value=\"templates\">\n                      <Wand2 className=\"h-4 w-4 mr-2\" />\n                      Шаблоны\n                    </TabsTrigger>\n                    <TabsTrigger value=\"manual\">\n                      <Settings className=\"h-4 w-4 mr-2\" />\n                      Вручную\n                    </TabsTrigger>\n                  </TabsList>\n\n                  <TabsContent value=\"smart\" className=\"space-y-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <p className=\"text-sm text-muted-foreground\">\n                        Автоматические предложения на основе анализа структуры бота\n                      </p>\n                      <UIButton\n                        onClick={generateSmartSuggestions}\n                        disabled={isGeneratingSmartSuggestions}\n                        variant=\"outline\"\n                      >\n                        {isGeneratingSmartSuggestions ? 'Генерация...' : 'Обновить'}\n                      </UIButton>\n                    </div>\n                    \n                    <div className=\"space-y-2 max-h-80 overflow-y-auto\">\n                      {smartSuggestions.map((suggestion) => (\n                        <div\n                          key={suggestion.id}\n                          className=\"p-3 border rounded-lg space-y-2\"\n                        >\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center gap-2\">\n                              <Target className=\"h-4 w-4\" />\n                              <span className=\"font-medium text-sm\">\n                                {getNodeName(suggestion.connection.source)} → {getNodeName(suggestion.connection.target)}\n                              </span>\n                            </div>\n                            <Badge className={cn(\"text-xs\", getConfidenceColor(suggestion.confidence))}>\n                              {Math.round(suggestion.confidence * 100)}%\n                            </Badge>\n                          </div>\n                          \n                          <p className=\"text-xs text-muted-foreground\">\n                            {suggestion.reason}\n                          </p>\n                          \n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center gap-2\">\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                {suggestion.suggestedButton.text}\n                              </Badge>\n                              <Badge variant=\"secondary\" className=\"text-xs\">\n                                {suggestion.suggestedButton.action}\n                              </Badge>\n                            </div>\n                            \n                            <UIButton\n                              size=\"sm\"\n                              onClick={() => applySuggestion(suggestion)}\n                              disabled={suggestion.confidence < 0.5}\n                            >\n                              <CheckCircle className=\"h-3 w-3 mr-1\" />\n                              Применить\n                            </UIButton>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"templates\" className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"template-source\">Исходный узел</Label>\n                      <Select value={selectedSourceId} onValueChange={setSelectedSourceId}>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Выберите исходный узел\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {nodes.map(node => (\n                            <SelectItem key={node.id} value={node.id}>\n                              {getNodeName(node.id)}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    \n                    <div className=\"space-y-2 max-h-80 overflow-y-auto\">\n                      {applicableTemplates.map((template) => (\n                        <div\n                          key={template.id}\n                          className=\"p-3 border rounded-lg space-y-2\"\n                        >\n                          <div className=\"flex items-center justify-between\">\n                            <h4 className=\"font-medium\">{template.name}</h4>\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              Приоритет: {template.priority}\n                            </Badge>\n                          </div>\n                          \n                          <p className=\"text-sm text-muted-foreground\">\n                            {template.description}\n                          </p>\n                          \n                          <div className=\"flex items-center gap-2\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              {template.useCase}\n                            </Badge>\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {template.buttonTemplate.text}\n                            </Badge>\n                          </div>\n                          \n                          <UIButton\n                            size=\"sm\"\n                            onClick={() => applyTemplate(template)}\n                            disabled={!selectedSourceId}\n                            className=\"w-full\"\n                          >\n                            <Zap className=\"h-3 w-3 mr-1\" />\n                            Применить шаблон\n                          </UIButton>\n                        </div>\n                      ))}\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"manual\" className=\"space-y-4\">\n                    <div className=\"space-y-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"source-node\">Исходный узел</Label>\n                        <Select value={selectedSourceId} onValueChange={setSelectedSourceId}>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Выберите исходный узел\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {nodes.map(node => (\n                              <SelectItem key={node.id} value={node.id}>\n                                {getNodeName(node.id)}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"target-node\">Целевой узел</Label>\n                        <Select value={selectedTargetId} onValueChange={setSelectedTargetId}>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Выберите целевой узел\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {availableTargets.map(node => (\n                              <SelectItem key={node.id} value={node.id}>\n                                {getNodeName(node.id)}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      \n                      <Separator />\n                      \n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"button-text\">Текст кнопки (необязательно)</Label>\n                        <Input\n                          id=\"button-text\"\n                          value={buttonText}\n                          onChange={(e) => setButtonText(e.target.value)}\n                          placeholder=\"Автоматически сгенерируется\"\n                        />\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"button-action\">Тип действия кнопки</Label>\n                        <Select value={buttonAction} onValueChange={(value: typeof buttonAction) => setButtonAction(value)}>\n                          <SelectTrigger>\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"goto\">Переход</SelectItem>\n                            <SelectItem value=\"command\">Команда</SelectItem>\n                            <SelectItem value=\"url\">Ссылка</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      \n                      <UIButton\n                        onClick={createManualConnection}\n                        disabled={!selectedSourceId || !selectedTargetId}\n                        className=\"w-full\"\n                      >\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Создать связь\n                      </UIButton>\n                    </div>\n                  </TabsContent>\n                </Tabs>\n              </DialogContent>\n            </Dialog>\n            \n            <UIButton\n              onClick={generateSmartSuggestions}\n              disabled={isGeneratingSmartSuggestions}\n              variant=\"outline\"\n            >\n              <Lightbulb className=\"h-4 w-4 mr-2\" />\n              Предложения\n            </UIButton>\n          </div>\n\n          {/* Предупреждения */}\n          {missingConnections.length > 0 && (\n            <div className=\"p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 rounded-lg\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <XCircle className=\"h-4 w-4 text-yellow-600\" />\n                <span className=\"font-medium text-yellow-800 dark:text-yellow-200\">\n                  Найдены изолированные узлы\n                </span>\n              </div>\n              <p className=\"text-sm text-yellow-700 dark:text-yellow-300 mb-2\">\n                {missingConnections.length} узлов не имеют связей и могут быть недоступны для пользователей\n              </p>\n              <div className=\"flex flex-wrap gap-1\">\n                {missingConnections.map(node => (\n                  <Badge key={node.id} variant=\"outline\" className=\"text-xs\">\n                    {getNodeName(node.id)}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":24824},"server/seed-templates-backup.ts":{"content":"import { storage } from \"./storage\";\n\n// Стандартные шаблоны для демонстрации\nexport async function seedDefaultTemplates() {\n  try {\n    const existingTemplates = await storage.getAllBotTemplates();\n    \n    // Проверяем, есть ли уже системные шаблоны\n    const systemTemplates = existingTemplates.filter(t => t.authorName === 'Система');\n    if (systemTemplates.length >= 6) {\n      console.log('Системные шаблоны уже существуют, пропускаем инициализацию');\n      return;\n    }\n\n    // Простой информационный бот\n    await storage.createBotTemplate({\n      name: \"Простой информационный бот\",\n      description: \"Базовый бот для предоставления информации с главным меню и командами\",\n      category: \"business\",\n      tags: [\"информация\", \"меню\", \"базовый\"],\n      isPublic: 1,\n      difficulty: \"easy\",\n      authorName: \"Система\",\n      version: \"1.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 3,\n      estimatedTime: 10,\n      data: {\n        nodes: [\n          {\n            id: \"start-1\",\n            type: \"start\",\n            position: { x: 100, y: 100 },\n            data: {\n              command: \"/start\",\n              description: \"Приветствие пользователя\",\n              messageText: \"Добро пожаловать! 👋\\n\\nЯ информационный бот. Выберите, что вас интересует:\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-1\",\n                  text: \"📋 Информация\",\n                  action: \"goto\",\n                  target: \"info-1\"\n                },\n                {\n                  id: \"btn-2\",\n                  text: \"📞 Контакты\",\n                  action: \"goto\",\n                  target: \"contacts-1\"\n                },\n                {\n                  id: \"btn-3\",\n                  text: \"❓ Помощь\",\n                  action: \"command\",\n                  target: \"/help\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"info-1\",\n            type: \"message\",\n            position: { x: 350, y: 100 },\n            data: {\n              messageText: \"ℹ️ Информация о нас\\n\\nМы предоставляем качественные услуги и всегда готовы помочь нашим клиентам.\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-back-1\",\n                  text: \"◀️ Назад\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"contacts-1\",\n            type: \"message\",\n            position: { x: 350, y: 250 },\n            data: {\n              messageText: \"📞 Наши контакты:\\n\\n📧 Email: info@example.com\\n📱 Телефон: +7 (999) 123-45-67\\n🌐 Сайт: example.com\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-back-2\",\n                  text: \"◀️ Назад\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"help-1\",\n            type: \"command\",\n            position: { x: 100, y: 250 },\n            data: {\n              command: \"/help\",\n              description: \"Справка по боту\",\n              messageText: \"❓ Справка\\n\\nИспользуйте кнопки меню для навигации по боту.\\n\\nДоступные команды:\\n/start - Главное меню\\n/help - Эта справка\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-menu\",\n                  text: \"📋 Главное меню\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          }\n        ],\n        connections: [\n          {\n            id: \"conn-1\",\n            source: \"start-1\",\n            target: \"info-1\"\n          },\n          {\n            id: \"conn-2\",\n            source: \"start-1\",\n            target: \"contacts-1\"\n          },\n          {\n            id: \"conn-3\",\n            source: \"start-1\",\n            target: \"help-1\"\n          }\n        ]\n      }\n    });\n\n    // Простой FAQ бот\n    await storage.createBotTemplate({\n      name: \"FAQ бот\",\n      description: \"Бот для ответов на часто задаваемые вопросы с поиском по темам\",\n      category: \"utility\",\n      tags: [\"faq\", \"вопросы\", \"поддержка\"],\n      isPublic: 1,\n      difficulty: \"medium\",\n      authorName: \"Система\",\n      version: \"1.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 5,\n      estimatedTime: 15,\n      data: {\n        nodes: [\n          {\n            id: \"start-1\",\n            type: \"start\",\n            position: { x: 100, y: 100 },\n            data: {\n              command: \"/start\",\n              description: \"Главное меню FAQ\",\n              messageText: \"🤖 Привет! Я бот поддержки.\\n\\nВыберите категорию вопроса:\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-tech\",\n                  text: \"💻 Технические вопросы\",\n                  action: \"goto\",\n                  target: \"tech-1\"\n                },\n                {\n                  id: \"btn-billing\",\n                  text: \"💳 Вопросы оплаты\",\n                  action: \"goto\",\n                  target: \"billing-1\"\n                },\n                {\n                  id: \"btn-general\",\n                  text: \"❓ Общие вопросы\",\n                  action: \"goto\",\n                  target: \"general-1\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"tech-1\",\n            type: \"message\",\n            position: { x: 400, y: 50 },\n            data: {\n              messageText: \"💻 Технические вопросы:\\n\\n• Проблемы с входом\\n• Ошибки в работе\\n• Настройка аккаунта\\n\\nВыберите вопрос:\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-login\",\n                  text: \"🔐 Проблемы с входом\",\n                  action: \"goto\",\n                  target: \"login-help\"\n                },\n                {\n                  id: \"btn-back-tech\",\n                  text: \"◀️ Назад\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"billing-1\",\n            type: \"message\",\n            position: { x: 400, y: 150 },\n            data: {\n              messageText: \"💳 Вопросы оплаты:\\n\\n• Способы оплаты\\n• Возврат средств\\n• Тарифы\\n\\nВыберите вопрос:\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-payment\",\n                  text: \"💰 Способы оплаты\",\n                  action: \"goto\",\n                  target: \"payment-help\"\n                },\n                {\n                  id: \"btn-back-billing\",\n                  text: \"◀️ Назад\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"general-1\",\n            type: \"message\",\n            position: { x: 400, y: 250 },\n            data: {\n              messageText: \"❓ Общие вопросы:\\n\\n• О компании\\n• Контакты\\n• Часы работы\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-contact\",\n                  text: \"📞 Связаться с нами\",\n                  action: \"url\",\n                  url: \"https://t.me/support\"\n                },\n                {\n                  id: \"btn-back-general\",\n                  text: \"◀️ Назад\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          }\n        ],\n        connections: [\n          {\n            id: \"conn-1\",\n            source: \"start-1\",\n            target: \"tech-1\"\n          },\n          {\n            id: \"conn-2\",\n            source: \"start-1\",\n            target: \"billing-1\"\n          },\n          {\n            id: \"conn-3\",\n            source: \"start-1\",\n            target: \"general-1\"\n          }\n        ]\n      }\n    });\n\n    // Простой интернет-магазин\n    await storage.createBotTemplate({\n      name: \"Интернет-магазин\",\n      description: \"Базовый шаблон бота для интернет-магазина с каталогом товаров\",\n      category: \"business\",\n      tags: [\"магазин\", \"товары\", \"продажи\"],\n      isPublic: 1,\n      difficulty: \"medium\",\n      authorName: \"Система\", \n      version: \"1.0.0\",\n      language: \"ru\",\n      complexity: 6,\n      estimatedTime: 20,\n      data: {\n        nodes: [\n          {\n            id: \"start-1\",\n            type: \"start\",\n            position: { x: 100, y: 100 },\n            data: {\n              command: \"/start\",\n              description: \"Добро пожаловать в магазин\",\n              messageText: \"🛍️ Добро пожаловать в наш интернет-магазин!\\n\\nЧто вас интересует?\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-catalog\",\n                  text: \"📦 Каталог товаров\",\n                  action: \"goto\",\n                  target: \"catalog-1\"\n                },\n                {\n                  id: \"btn-cart\",\n                  text: \"🛒 Корзина\",\n                  action: \"goto\",\n                  target: \"cart-1\"\n                },\n                {\n                  id: \"btn-info\",\n                  text: \"ℹ️ О доставке\",\n                  action: \"goto\",\n                  target: \"delivery-1\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"catalog-1\",\n            type: \"message\",\n            position: { x: 400, y: 100 },\n            data: {\n              messageText: \"📦 Каталог товаров:\\n\\n🏷️ Категории:\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-electronics\",\n                  text: \"📱 Электроника\",\n                  action: \"goto\",\n                  target: \"electronics-1\"\n                },\n                {\n                  id: \"btn-clothes\",\n                  text: \"👕 Одежда\",\n                  action: \"goto\",\n                  target: \"clothes-1\"\n                },\n                {\n                  id: \"btn-home\",\n                  text: \"🏠 Для дома\",\n                  action: \"goto\",\n                  target: \"home-1\"\n                },\n                {\n                  id: \"btn-back-catalog\",\n                  text: \"◀️ Главное меню\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"cart-1\",\n            type: \"message\",\n            position: { x: 400, y: 200 },\n            data: {\n              messageText: \"🛒 Ваша корзина пуста\\n\\nДобавьте товары из каталога!\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-to-catalog\",\n                  text: \"📦 Перейти к каталогу\",\n                  action: \"goto\",\n                  target: \"catalog-1\"\n                },\n                {\n                  id: \"btn-back-cart\",\n                  text: \"◀️ Главное меню\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"delivery-1\",\n            type: \"message\",\n            position: { x: 400, y: 300 },\n            data: {\n              messageText: \"🚚 Информация о доставке:\\n\\n📦 Бесплатная доставка от 2000₽\\n⏱️ Доставка 1-3 дня\\n📍 Доставляем по всей России\\n\\n💳 Оплата при получении или картой\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-back-delivery\",\n                  text: \"◀️ Главное меню\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          }\n        ],\n        connections: [\n          {\n            id: \"conn-1\",\n            source: \"start-1\",\n            target: \"catalog-1\"\n          },\n          {\n            id: \"conn-2\",\n            source: \"start-1\",\n            target: \"cart-1\"\n          },\n          {\n            id: \"conn-3\",\n            source: \"start-1\",\n            target: \"delivery-1\"\n          }\n        ]\n      }\n    });\n\n    // Простой бот с командой старт и синонимом\n    await storage.createBotTemplate({\n      name: \"Базовый стартовый бот\",\n      description: \"Простой бот с командой /start и синонимом 'старт' для начинающих\",\n      category: \"education\",\n      tags: [\"старт\", \"базовый\", \"обучение\"],\n      isPublic: 1,\n      difficulty: \"easy\",\n      authorName: \"Система\",\n      version: \"1.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 2,\n      estimatedTime: 5,\n      data: {\n        nodes: [\n          {\n            id: \"start-1\",\n            type: \"start\",\n            position: { x: 100, y: 100 },\n            data: {\n              command: \"/start\",\n              synonyms: [\"старт\"],\n              description: \"Команда запуска бота\",\n              messageText: \"🚀 Привет! Я твой первый бот!\\n\\nТы можешь написать:\\n• /start - чтобы запустить меня\\n• старт - это тоже работает!\\n\\nВыбери действие:\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-info\",\n                  text: \"ℹ️ Информация\",\n                  action: \"goto\",\n                  target: \"info-1\"\n                },\n                {\n                  id: \"btn-help\",\n                  text: \"❓ Помощь\",\n                  action: \"goto\",\n                  target: \"help-1\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"info-1\",\n            type: \"message\",\n            position: { x: 350, y: 100 },\n            data: {\n              messageText: \"📋 Информация о боте:\\n\\nЭто простой бот-пример, который показывает:\\n• Как работают команды\\n• Как использовать синонимы\\n• Базовую навигацию\\n\\nТеперь ты можешь создать своего!\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-back-info\",\n                  text: \"◀️ Назад\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"help-1\",\n            type: \"message\",\n            position: { x: 350, y: 250 },\n            data: {\n              messageText: \"❓ Справка:\\n\\n🔤 Команды:\\n• /start или старт - запуск бота\\n\\n🎯 Советы:\\n• Используй кнопки для навигации\\n• Синонимы делают бота удобнее\\n• Экспериментируй с настройками!\",\n              keyboardType: \"reply\",\n              buttons: [\n                {\n                  id: \"btn-back-help\",\n                  text: \"◀️ Назад\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          }\n        ],\n        connections: [\n          {\n            id: \"conn-1\",\n            source: \"start-1\",\n            target: \"info-1\"\n          },\n          {\n            id: \"conn-2\",\n            source: \"start-1\",\n            target: \"help-1\"\n          }\n        ]\n      }\n    });\n\n    // Ультра-комплексный политико-исторический опрос\n    await storage.createBotTemplate({\n      name: \"🏛️ Ультра-Комплексный Политико-Исторический Опрос\",\n      description: \"Масштабный опрос по политологии, истории, философии и социологии с глубоким анализом взглядов и знаний\",\n      category: \"education\",\n      tags: [\"политика\", \"история\", \"философия\", \"социология\", \"опрос\", \"анализ\", \"образование\", \"комплексный\"],\n      isPublic: 1,\n      difficulty: \"hard\",\n      authorName: \"Система\",\n      version: \"1.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 10,\n      estimatedTime: 60,\n      data: {\n        \"nodes\": [\n          {\n            \"id\": \"start-poll\",\n            \"type\": \"start\",\n            \"position\": {\"x\": 100, \"y\": 100},\n            \"data\": {\n              \"command\": \"/start\",\n              \"description\": \"Запуск ультра-комплексного политико-исторического опроса\",\n              \"messageText\": \"🏛️ **ДОБРО ПОЖАЛОВАТЬ В УЛЬТРА-КОМПЛЕКСНЫЙ ПОЛИТИКО-ИСТОРИЧЕСКИЙ ОПРОС!**\\n\\n📚 Этот опрос включает:\\n• 🗳️ **Политические взгляды** (20+ вопросов)\\n• 📜 **Историческое знание** (25+ вопросов)\\n• 🤔 **Философские воззрения** (15+ вопросов)\\n• 🌍 **Социологический анализ** (20+ вопросов)\\n\\n⏱️ **Время прохождения:** 45-60 минут\\n🎯 **Результат:** Подробный анализ ваших взглядов\\n\\n**Готовы начать глубокое исследование?**\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"start-survey\",\n                  \"text\": \"🚀 Начать опрос\",\n                  \"action\": \"goto\",\n                  \"target\": \"political-intro\"\n                },\n                {\n                  \"id\": \"view-sections\",\n                  \"text\": \"📋 Обзор разделов\",\n                  \"action\": \"goto\",\n                  \"target\": \"sections-overview\"\n                },\n                {\n                  \"id\": \"instructions\",\n                  \"text\": \"📖 Инструкции\",\n                  \"action\": \"goto\",\n                  \"target\": \"survey-instructions\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"sections-overview\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 400, \"y\": 50},\n            \"data\": {\n              \"messageText\": \"📋 **РАЗДЕЛЫ ОПРОСА:**\\n\\n🗳️ **БЛОК А: ПОЛИТОЛОГИЯ** (20 вопросов)\\n• Политические предпочтения\\n• Отношение к власти и государству\\n• Экономические взгляды\\n• Социальная политика\\n\\n📜 **БЛОК Б: ИСТОРИЯ** (25 вопросов)\\n• Знание исторических событий\\n• Оценка исторических личностей\\n• Понимание исторических процессов\\n• Альтернативная история\\n\\n🤔 **БЛОК В: ФИЛОСОФИЯ** (15 вопросов)\\n• Этические воззрения\\n• Метафизические взгляды\\n• Политическая философия\\n• Смысл и ценности\\n\\n🌍 **БЛОК Г: СОЦИОЛОГИЯ** (20 вопросов)\\n• Социальные проблемы\\n• Межгрупповые отношения\\n• Глобализация и культура\\n• Будущее общества\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"back-to-start\",\n                  \"text\": \"⬅️ Назад к началу\",\n                  \"action\": \"goto\",\n                  \"target\": \"start-poll\"\n                },\n                {\n                  \"id\": \"start-from-overview\",\n                  \"text\": \"🚀 Начать опрос\",\n                  \"action\": \"goto\",\n                  \"target\": \"political-intro\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"political-intro\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 700, \"y\": 100},\n            \"data\": {\n              \"messageText\": \"🗳️ **БЛОК А: ПОЛИТОЛОГИЯ**\\n\\n**Исследуем ваши политические взгляды и предпочтения**\\n\\nВ этом блоке 20 вопросов о:\\n• Роли государства в экономике\\n• Социальной политике\\n• Международных отношениях\\n• Правах и свободах\\n• Политических системах\\n\\n**Готовы начать политический анализ?**\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"start-political\",\n                  \"text\": \"🗳️ Начать политблок\",\n                  \"action\": \"goto\",\n                  \"target\": \"pol-q1\"\n                },\n                {\n                  \"id\": \"skip-to-history\",\n                  \"text\": \"📜 Перейти к истории\",\n                  \"action\": \"goto\",\n                  \"target\": \"history-intro\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"pol-q1\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 1000, \"y\": 250},\n            \"data\": {\n              \"messageText\": \"🗳️ **ВОПРОС 1/20** (Политология)\\n\\n**Какую роль должно играть государство в экономике?**\\n\\nВыберите наиболее близкий вам вариант:\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"pol-q1-opt1\",\n                  \"text\": \"A) Минимальная роль - свободный...\",\n                  \"action\": \"goto\",\n                  \"target\": \"pol-q1-result\"\n                },\n                {\n                  \"id\": \"pol-q1-opt2\",\n                  \"text\": \"B) Умеренное регулирование...\",\n                  \"action\": \"goto\",\n                  \"target\": \"pol-q1-result\"\n                },\n                {\n                  \"id\": \"pol-q1-opt3\",\n                  \"text\": \"C) Активное вмешательство...\",\n                  \"action\": \"goto\",\n                  \"target\": \"pol-q1-result\"\n                },\n                {\n                  \"id\": \"pol-q1-opt4\",\n                  \"text\": \"D) Полный государственный...\",\n                  \"action\": \"goto\",\n                  \"target\": \"pol-q1-result\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"pol-q1-result\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 1400, \"y\": 250},\n            \"data\": {\n              \"messageText\": \"✅ **Ответ записан!**\\n\\n**Полные варианты ответа:**\\n\\nA) Минимальная роль - свободный рынок\\n\\nB) Умеренное регулирование ключевых отраслей\\n\\nC) Активное вмешательство и планирование\\n\\nD) Полный государственный контроль\\n\\n📊 **Прогресс:** 1/20 вопросов политблока\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"pol-q1-next\",\n                  \"text\": \"➡️ Следующий вопрос\",\n                  \"action\": \"goto\",\n                  \"target\": \"history-intro\"\n                },\n                {\n                  \"id\": \"pol-q1-skip-to-history\",\n                  \"text\": \"📜 Перейти к истории\",\n                  \"action\": \"goto\",\n                  \"target\": \"history-intro\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"history-intro\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 100, \"y\": 500},\n            \"data\": {\n              \"messageText\": \"📜 **БЛОК Б: ИСТОРИЯ**\\n\\n**Проверим ваши исторические знания и интерпретации**\\n\\nВ этом блоке 25 вопросов о:\\n• Ключевых исторических событиях\\n• Великих исторических личностях\\n• Причинах и последствиях событий\\n• Альтернативных сценариях развития\\n• Исторических параллелях\\n\\n**Готовы окунуться в историю?**\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"start-history\",\n                  \"text\": \"📜 Начать истблок\",\n                  \"action\": \"goto\",\n                  \"target\": \"hist-q1\"\n                },\n                {\n                  \"id\": \"skip-to-philosophy\",\n                  \"text\": \"🤔 Перейти к философии\",\n                  \"action\": \"goto\",\n                  \"target\": \"philosophy-intro\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"hist-q1\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 400, \"y\": 700},\n            \"data\": {\n              \"messageText\": \"📜 **ВОПРОС 1/25** (История)\\n\\n**Что стало главной причиной Первой мировой войны?**\\n\\nВыберите наиболее правильный ответ:\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"hist-q1-opt1\",\n                  \"text\": \"A) Убийство эрцгерцога...\",\n                  \"action\": \"goto\",\n                  \"target\": \"hist-q1-result\"\n                },\n                {\n                  \"id\": \"hist-q1-opt2\",\n                  \"text\": \"B) Империалистические противоречия...\",\n                  \"action\": \"goto\",\n                  \"target\": \"hist-q1-result\"\n                },\n                {\n                  \"id\": \"hist-q1-opt3\",\n                  \"text\": \"C) Национальные движения...\",\n                  \"action\": \"goto\",\n                  \"target\": \"hist-q1-result\"\n                },\n                {\n                  \"id\": \"hist-q1-opt4\",\n                  \"text\": \"D) Гонка вооружений...\",\n                  \"action\": \"goto\",\n                  \"target\": \"hist-q1-result\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"hist-q1-result\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 800, \"y\": 700},\n            \"data\": {\n              \"messageText\": \"✅ **Исторический факт зафиксирован!**\\n\\n**Полные варианты:**\\n\\nA) Убийство эрцгерцога Франца Фердинанда\\n\\nB) Империалистические противоречия великих держав\\n\\nC) Национальные движения на Балканах\\n\\nD) Гонка вооружений и милитаризм\\n\\n📊 **Прогресс:** 1/25 вопросов историблока\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"hist-q1-next\",\n                  \"text\": \"🤔 К блоку Философия\",\n                  \"action\": \"goto\",\n                  \"target\": \"philosophy-intro\"\n                },\n                {\n                  \"id\": \"hist-q1-skip-to-philosophy\",\n                  \"text\": \"🤔 Перейти к философии\",\n                  \"action\": \"goto\",\n                  \"target\": \"philosophy-intro\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"philosophy-intro\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 100, \"y\": 1000},\n            \"data\": {\n              \"messageText\": \"🤔 **БЛОК В: ФИЛОСОФИЯ**\\n\\n**Исследуем ваши мировоззренческие установки**\\n\\nВ этом блоке 15 вопросов о:\\n• Этических принципах и морали\\n• Метафизических взглядах на реальность\\n• Смысле жизни и ценностях\\n• Политической философии\\n• Эпистемологии и познании\\n\\n**Готовы к философскому анализу?**\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"start-philosophy\",\n                  \"text\": \"🤔 Начать филблок\",\n                  \"action\": \"goto\",\n                  \"target\": \"phil-q1\"\n                },\n                {\n                  \"id\": \"skip-to-sociology\",\n                  \"text\": \"🌍 Перейти к социологии\",\n                  \"action\": \"goto\",\n                  \"target\": \"sociology-intro\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"phil-q1\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 400, \"y\": 1200},\n            \"data\": {\n              \"messageText\": \"🤔 **ВОПРОС 1/15** (Философия)\\n\\n**Что является основой моральных суждений?**\\n\\nВыберите ваш философский взгляд:\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"phil-q1-opt1\",\n                  \"text\": \"A) Врожденные моральные...\",\n                  \"action\": \"goto\",\n                  \"target\": \"phil-q1-result\"\n                },\n                {\n                  \"id\": \"phil-q1-opt2\",\n                  \"text\": \"B) Последствия действий...\",\n                  \"action\": \"goto\",\n                  \"target\": \"phil-q1-result\"\n                },\n                {\n                  \"id\": \"phil-q1-opt3\",\n                  \"text\": \"C) Долг и универсальные...\",\n                  \"action\": \"goto\",\n                  \"target\": \"phil-q1-result\"\n                },\n                {\n                  \"id\": \"phil-q1-opt4\",\n                  \"text\": \"D) Социальные соглашения...\",\n                  \"action\": \"goto\",\n                  \"target\": \"phil-q1-result\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"phil-q1-result\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 800, \"y\": 1200},\n            \"data\": {\n              \"messageText\": \"✅ **Философская позиция учтена!**\\n\\n**Варианты размышления:**\\n\\nA) Врожденные моральные интуиции\\n\\nB) Последствия действий (утилитаризм)\\n\\nC) Долг и универсальные принципы\\n\\nD) Социальные соглашения и культура\\n\\n📊 **Прогресс:** 1/15 вопросов филблока\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"phil-q1-next\",\n                  \"text\": \"🌍 К блоку Социология\",\n                  \"action\": \"goto\",\n                  \"target\": \"sociology-intro\"\n                },\n                {\n                  \"id\": \"phil-q1-skip-to-sociology\",\n                  \"text\": \"🌍 Перейти к социологии\",\n                  \"action\": \"goto\",\n                  \"target\": \"sociology-intro\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"sociology-intro\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 100, \"y\": 1500},\n            \"data\": {\n              \"messageText\": \"🌍 **БЛОК Г: СОЦИОЛОГИЯ**\\n\\n**Изучаем ваши взгляды на общество и социальные процессы**\\n\\nВ этом блоке 20 вопросов о:\\n• Социальном неравенстве и стратификации\\n• Глобализации и культурных изменениях\\n• Межгрупповых отношениях\\n• Технологиях и будущем общества\\n• Социальных проблемах современности\\n\\n**Готовы к социологическому анализу?**\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"start-sociology\",\n                  \"text\": \"🌍 Начать социоблок\",\n                  \"action\": \"goto\",\n                  \"target\": \"soc-q1\"\n                },\n                {\n                  \"id\": \"skip-to-results\",\n                  \"text\": \"📊 Перейти к результатам\",\n                  \"action\": \"goto\",\n                  \"target\": \"final-results\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"soc-q1\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 400, \"y\": 1700},\n            \"data\": {\n              \"messageText\": \"🌍 **ВОПРОС 1/20** (Социология)\\n\\n**Главная причина социального неравенства:**\\n\\nВыберите ваш социологический взгляд:\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"soc-q1-opt1\",\n                  \"text\": \"A) Различия в способностях...\",\n                  \"action\": \"goto\",\n                  \"target\": \"soc-q1-result\"\n                },\n                {\n                  \"id\": \"soc-q1-opt2\",\n                  \"text\": \"B) Структурные особенности...\",\n                  \"action\": \"goto\",\n                  \"target\": \"soc-q1-result\"\n                },\n                {\n                  \"id\": \"soc-q1-opt3\",\n                  \"text\": \"C) Культурные и образовательные...\",\n                  \"action\": \"goto\",\n                  \"target\": \"soc-q1-result\"\n                },\n                {\n                  \"id\": \"soc-q1-opt4\",\n                  \"text\": \"D) Исторические факторы...\",\n                  \"action\": \"goto\",\n                  \"target\": \"soc-q1-result\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"soc-q1-result\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 800, \"y\": 1700},\n            \"data\": {\n              \"messageText\": \"✅ **Социологическая позиция зафиксирована!**\\n\\n**Варианты анализа:**\\n\\nA) Различия в способностях и таланте\\n\\nB) Структурные особенности экономической системы\\n\\nC) Культурные и образовательные различия\\n\\nD) Исторические факторы и наследие прошлого\\n\\n📊 **Прогресс:** 1/20 вопросов социоблока\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"soc-q1-next\",\n                  \"text\": \"🎉 К результатам!\",\n                  \"action\": \"goto\",\n                  \"target\": \"final-results\"\n                },\n                {\n                  \"id\": \"soc-q1-skip-to-results\",\n                  \"text\": \"📊 К результатам\",\n                  \"action\": \"goto\",\n                  \"target\": \"final-results\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"final-results\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 100, \"y\": 2000},\n            \"data\": {\n              \"messageText\": \"🎉 **ПОЗДРАВЛЯЕМ С ЗАВЕРШЕНИЕМ УЛЬТРА-КОМПЛЕКСНОГО ОПРОСА!**\\n\\n📊 **ВАШИ РЕЗУЛЬТАТЫ:**\\n\\n🗳️ **Политический профиль:** Анализируется...\\n📜 **Историческая компетентность:** Оценивается...\\n🤔 **Философские взгляды:** Обрабатываются...\\n🌍 **Социологические позиции:** Систематизируются...\\n\\n⏱️ **Время прохождения:** Впечатляющая стойкость!\\n🎯 **Полнота ответов:** 80+ вопросов пройдено\\n\\n**Подробный анализ готовится...**\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"detailed-analysis\",\n                  \"text\": \"📊 Детальный анализ\",\n                  \"action\": \"goto\",\n                  \"target\": \"detailed-analysis\"\n                },\n                {\n                  \"id\": \"recommendations\",\n                  \"text\": \"📚 Рекомендации\",\n                  \"action\": \"goto\",\n                  \"target\": \"recommendations\"\n                },\n                {\n                  \"id\": \"restart-survey\",\n                  \"text\": \"🔄 Пройти снова\",\n                  \"action\": \"goto\",\n                  \"target\": \"start-poll\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"detailed-analysis\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 400, \"y\": 2200},\n            \"data\": {\n              \"messageText\": \"📊 **ДЕТАЛЬНЫЙ АНАЛИЗ РЕЗУЛЬТАТОВ**\\n\\n🗳️ **ПОЛИТИЧЕСКИЙ БЛОК:**\\n• Экономические взгляды: Смешанная экономика\\n• Социальная политика: Умеренно-прогрессивная\\n• Внешняя политика: Многосторонность\\n• Авторитаризм vs Либерализм: Либерально-демократический\\n\\n📜 **ИСТОРИЧЕСКИЙ БЛОК:**\\n• Знание фактов: Высокий уровень\\n• Понимание процессов: Системное мышление\\n• Интерпретация событий: Многофакторный анализ\\n• Исторические параллели: Развитое понимание\\n\\n🤔 **ФИЛОСОФСКИЙ БЛОК:**\\n• Этика: Деонтологическо-утилитарный синтез\\n• Метафизика: Материалистический реализм\\n• Эпистемология: Критический рационализм\\n• Смысл жизни: Самоактуализация и служение\\n\\n🌍 **СОЦИОЛОГИЧЕСКИЙ БЛОК:**\\n• Социальное неравенство: Структурно обусловлено\\n• Глобализация: Сложный процесс с плюсами и минусами\\n• Технологии: Трансформируют общество\\n• Будущее: Осторожный оптимизм\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"back-to-results\",\n                  \"text\": \"⬅️ К результатам\",\n                  \"action\": \"goto\",\n                  \"target\": \"final-results\"\n                },\n                {\n                  \"id\": \"profile-comparison\",\n                  \"text\": \"👥 Сравнение с профилями\",\n                  \"action\": \"goto\",\n                  \"target\": \"profile-comparison\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"profile-comparison\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 800, \"y\": 2200},\n            \"data\": {\n              \"messageText\": \"👥 **СРАВНЕНИЕ С ТИПИЧНЫМИ ПРОФИЛЯМИ**\\n\\n🎯 **Ваш профиль наиболее близок к:**\\n\\n**\\\"Просвещенный Центрист\\\"** - 87% совпадение\\n• Рациональный подход к политике\\n• Глубокое понимание истории\\n• Философская рефлексивность\\n• Системное мышление о обществе\\n\\n📊 **Другие близкие профили:**\\n• Либеральный Интеллектуал - 78%\\n• Прогрессивный Прагматик - 74%\\n• Социал-демократ - 71%\\n\\n🔍 **Уникальные черты вашего профиля:**\\n• Балансирование противоположных взглядов\\n• Критическое мышление с открытостью\\n• Исторический контекст в политических суждениях\\n• Философская глубина в социальном анализе\\n\\n**Вы демонстрируете редкое сочетание аналитического мышления и человечности!**\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"back-to-analysis\",\n                  \"text\": \"⬅️ К анализу\",\n                  \"action\": \"goto\",\n                  \"target\": \"detailed-analysis\"\n                },\n                {\n                  \"id\": \"view-recommendations\",\n                  \"text\": \"📚 Рекомендации\",\n                  \"action\": \"goto\",\n                  \"target\": \"recommendations\"\n                }\n              ],\n              \"markdown\": true\n            }\n          },\n          {\n            \"id\": \"recommendations\",\n            \"type\": \"message\",\n            \"position\": {\"x\": 400, \"y\": 2400},\n            \"data\": {\n              \"messageText\": \"📚 **ПЕРСОНАЛЬНЫЕ РЕКОМЕНДАЦИИ ДЛЯ РАЗВИТИЯ**\\n\\n📖 **Книги для углубления знаний:**\\n• \\\"Политическая философия\\\" - Роберт Пол Вольф\\n• \\\"Столкновение цивилизаций\\\" - Сэмюэл Хантингтон\\n• \\\"Справедливость\\\" - Майкл Сэндел\\n• \\\"Постиндустриальное общество\\\" - Дэниел Белл\\n\\n🎓 **Области для изучения:**\\n• Сравнительная политология\\n• Философия истории\\n• Социальная психология\\n• Глобальная политическая экономия\\n\\n💭 **Темы для размышления:**\\n• Как совместить индивидуальные права и общественное благо?\\n• Какие уроки истории актуальны для современности?\\n• Как технологии изменят природу демократии?\\n• Возможно ли справедливое глобальное управление?\\n\\n🌟 **Практические рекомендации:**\\n• Участвуйте в общественных дискуссиях\\n• Изучайте разные точки зрения\\n• Применяйте исторический анализ к современным событиям\\n• Развивайте критическое мышление\",\n              \"keyboardType\": \"inline\",\n              \"buttons\": [\n                {\n                  \"id\": \"back-to-results-final\",\n                  \"text\": \"⬅️ К результатам\",\n                  \"action\": \"goto\",\n                  \"target\": \"final-results\"\n                },\n                {\n                  \"id\": \"new-survey\",\n                  \"text\": \"🆕 Новый опрос\",\n                  \"action\": \"goto\",\n                  \"target\": \"start-poll\"\n                }\n              ],\n              \"markdown\": true\n            }\n          }\n        ],\n        \"connections\": [\n          {\n            \"id\": \"conn-start-overview\",\n            \"source\": \"start-poll\",\n            \"target\": \"sections-overview\"\n          },\n          {\n            \"id\": \"conn-start-instructions\",\n            \"source\": \"start-poll\",\n            \"target\": \"survey-instructions\"\n          },\n          {\n            \"id\": \"conn-start-political\",\n            \"source\": \"start-poll\",\n            \"target\": \"political-intro\"\n          },\n          {\n            \"id\": \"conn-overview-start\",\n            \"source\": \"sections-overview\",\n            \"target\": \"start-poll\"\n          },\n          {\n            \"id\": \"conn-political-history\",\n            \"source\": \"political-intro\",\n            \"target\": \"history-intro\"\n          },\n          {\n            \"id\": \"conn-history-philosophy\",\n            \"source\": \"history-intro\",\n            \"target\": \"philosophy-intro\"\n          },\n          {\n            \"id\": \"conn-philosophy-sociology\",\n            \"source\": \"philosophy-intro\",\n            \"target\": \"sociology-intro\"\n          },\n          {\n            \"id\": \"conn-sociology-results\",\n            \"source\": \"sociology-intro\",\n            \"target\": \"final-results\"\n          },\n          {\n            \"id\": \"conn-results-analysis\",\n            \"source\": \"final-results\",\n            \"target\": \"detailed-analysis\"\n          },\n          {\n            \"id\": \"conn-analysis-comparison\",\n            \"source\": \"detailed-analysis\",\n            \"target\": \"profile-comparison\"\n          },\n          {\n            \"id\": \"conn-results-recommendations\",\n            \"source\": \"final-results\",\n            \"target\": \"recommendations\"\n          }\n        ]\n      }\n    });\n\n    // Простой опрос с пользовательским вводом\n    await storage.createBotTemplate({\n      name: \"📝 Опрос с текстовым вводом\",\n      description: \"Простой бот для сбора обратной связи от пользователей с полем для ввода текста\",\n      category: \"business\",\n      tags: [\"опрос\", \"ввод\", \"обратная связь\", \"анкета\"],\n      isPublic: 1,\n      difficulty: \"medium\",\n      authorName: \"Система\",\n      version: \"1.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 4,\n      estimatedTime: 15,\n      data: {\n        nodes: [\n          {\n            id: \"start-1\",\n            type: \"start\",\n            position: { x: 100, y: 100 },\n            data: {\n              command: \"/start\",\n              description: \"Приветствие и начало опроса\",\n              messageText: \"👋 Добро пожаловать в бот обратной связи!\\n\\nМы очень ценим мнение наших пользователей. Поделитесь своими впечатлениями!\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-start-survey\",\n                  text: \"📝 Начать опрос\",\n                  action: \"goto\",\n                  target: \"survey-question\"\n                },\n                {\n                  id: \"btn-skip\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"thank-you\"\n                }\n              ],\n              markdown: false,\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"survey-question\",\n            type: \"message\",\n            position: { x: 400, y: 100 },\n            data: {\n              messageText: \"📋 Вопрос 1 из 2\\n\\nКак бы вы оценили качество нашего сервиса?\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-excellent\",\n                  text: \"⭐⭐⭐⭐⭐ Отлично\",\n                  action: \"goto\",\n                  target: \"feedback-input\"\n                },\n                {\n                  id: \"btn-good\",\n                  text: \"⭐⭐⭐⭐ Хорошо\",\n                  action: \"goto\",\n                  target: \"feedback-input\"\n                },\n                {\n                  id: \"btn-average\",\n                  text: \"⭐⭐⭐ Средне\",\n                  action: \"goto\",\n                  target: \"feedback-input\"\n                },\n                {\n                  id: \"btn-poor\",\n                  text: \"⭐⭐ Плохо\",\n                  action: \"goto\",\n                  target: \"feedback-input\"\n                },\n                {\n                  id: \"btn-terrible\",\n                  text: \"⭐ Ужасно\",\n                  action: \"goto\",\n                  target: \"feedback-input\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"feedback-input\",\n            type: \"user-input\",\n            position: { x: 700, y: 100 },\n            data: {\n              messageText: \"💬 Вопрос 2 из 2\\n\\nРасскажите подробнее о своих впечатлениях. Что вам понравилось или что можно улучшить?\\n\\n✍️ Напишите ваш отзыв:\",\n              inputType: \"text\",\n              inputVariable: \"user_feedback\",\n              placeholder: \"Введите ваш отзыв здесь...\",\n              isRequired: true,\n              minLength: 10,\n              maxLength: 500,\n              validationMessage: \"Пожалуйста, введите отзыв от 10 до 500 символов\",\n              timeoutSeconds: 300,\n              timeoutMessage: \"⏰ Время для ввода истекло. Попробуйте снова позже.\",\n              saveToDatabase: true,\n              successTarget: \"thank-you\",\n              errorTarget: \"feedback-error\"\n            }\n          },\n          {\n            id: \"feedback-error\",\n            type: \"message\",\n            position: { x: 700, y: 250 },\n            data: {\n              messageText: \"❌ Ошибка ввода\\n\\nПожалуйста, введите корректный отзыв (от 10 до 500 символов).\\n\\nПопробуйте ещё раз:\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-retry\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"feedback-input\"\n                },\n                {\n                  id: \"btn-skip-feedback\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"thank-you\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"thank-you\",\n            type: \"message\",\n            position: { x: 1000, y: 100 },\n            data: {\n              messageText: \"🎉 Спасибо за участие!\\n\\nВаша обратная связь очень важна для нас и поможет улучшить наш сервис.\\n\\nЕсли у вас есть ещё вопросы или предложения, не стесняйтесь обращаться!\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-restart\",\n                  text: \"🔄 Пройти опрос снова\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                },\n                {\n                  id: \"btn-help\",\n                  text: \"❓ Помощь\",\n                  action: \"command\",\n                  target: \"/help\"\n                }\n              ],\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          }\n        ],\n        connections: [\n          {\n            id: \"conn-1\",\n            source: \"start-1\",\n            target: \"survey-question\"\n          },\n          {\n            id: \"conn-2\",\n            source: \"start-1\",\n            target: \"thank-you\"\n          },\n          {\n            id: \"conn-3\",\n            source: \"survey-question\",\n            target: \"feedback-input\"\n          },\n          {\n            id: \"conn-4\",\n            source: \"feedback-input\",\n            target: \"thank-you\"\n          },\n          {\n            id: \"conn-5\",\n            source: \"feedback-input\",\n            target: \"feedback-error\"\n          },\n          {\n            id: \"conn-6\",\n            source: \"feedback-error\",\n            target: \"feedback-input\"\n          },\n          {\n            id: \"conn-7\",\n            source: \"feedback-error\",\n            target: \"thank-you\"\n          },\n          {\n            id: \"conn-8\",\n            source: \"thank-you\",\n            target: \"start-1\"\n          }\n        ]\n      }\n    });\n\n    console.log('Базовые шаблоны успешно созданы');\n  } catch (error) {\n    console.error('Ошибка при создании шаблонов:', error);\n  }\n}\n    await storage.createBotTemplate({\n      name: \"📊 Комплексный сбор данных\",\n      description: \"Демонстрация всех типов сбора пользовательского ввода: текстовый, кнопочный, множественный выбор, медиа\",\n      category: \"official\",\n      tags: [\"сбор данных\", \"формы\", \"опросы\", \"ввод\", \"кнопки\"],\n      isPublic: 1,\n      difficulty: \"hard\",\n      authorName: \"Система\",\n      version: \"1.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 8,\n      estimatedTime: 25,\n      data: {\n        nodes: [\n          {\n            id: \"start-1\",\n            type: \"start\",\n            position: { x: 100, y: 100 },\n            data: {\n              command: \"/start\",\n              description: \"Начало сбора данных\",\n              messageText: \"🎯 Добро пожаловать в систему сбора данных!\\n\\nЭтот бот демонстрирует все возможности сбора пользовательского ввода:\\n\\n• 📝 Текстовый ввод\\n• 🔘 Кнопочные ответы\\n• ☑️ Множественный выбор\\n• 📱 Медиа файлы\\n• 📊 Структурированные данные\\n\\nНачнем сбор ваших данных?\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-start-survey\",\n                  text: \"🚀 Начать сбор данных\",\n                  action: \"goto\",\n                  target: \"name-input\"\n                },\n                {\n                  id: \"btn-skip-all\",\n                  text: \"⏭️ Пропустить все\",\n                  action: \"goto\",\n                  target: \"final-results\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"name-input\",\n            type: \"user-input\",\n            position: { x: 400, y: 100 },\n            data: {\n              messageText: \"👤 Шаг 1: Персональные данные\\n\\nКак вас зовут?\\n\\nВведите ваше имя (от 2 до 50 символов):\",\n              responseType: \"text\",\n              inputType: \"text\",\n              inputVariable: \"user_name\",\n              placeholder: \"Введите ваше имя...\",\n              isRequired: true,\n              minLength: 2,\n              maxLength: 50,\n              validationMessage: \"Имя должно содержать от 2 до 50 символов\",\n              timeoutSeconds: 120,\n              timeoutMessage: \"⏰ Время ввода истекло. Попробуйте снова.\",\n              saveToDatabase: true,\n              successTarget: \"age-buttons\",\n              errorTarget: \"name-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"name-error\",\n            type: \"message\",\n            position: { x: 400, y: 250 },\n            data: {\n              messageText: \"❌ Ошибка ввода имени\\n\\nПожалуйста, введите корректное имя (от 2 до 50 символов).\\n\\nПопробуйте ещё раз:\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-retry-name\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"name-input\"\n                },\n                {\n                  id: \"btn-skip-name\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"age-buttons\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"age-buttons\",\n            type: \"user-input\",\n            position: { x: 700, y: 100 },\n            data: {\n              messageText: \"🎂 Шаг 2: Возрастная группа\\n\\nВыберите вашу возрастную группу:\\n\\nИспользуйте кнопки для выбора:\",\n              responseType: \"buttons\",\n              responseOptions: [\n                {\n                  id: \"age-18-25\",\n                  text: \"18-25 лет\",\n                  value: \"18-25\"\n                },\n                {\n                  id: \"age-26-35\",\n                  text: \"26-35 лет\",\n                  value: \"26-35\"\n                },\n                {\n                  id: \"age-36-45\",\n                  text: \"36-45 лет\",\n                  value: \"36-45\"\n                },\n                {\n                  id: \"age-46-55\",\n                  text: \"46-55 лет\",\n                  value: \"46-55\"\n                },\n                {\n                  id: \"age-55+\",\n                  text: \"55+ лет\",\n                  value: \"55+\"\n                }\n              ],\n              allowMultipleSelection: false,\n              inputVariable: \"user_age_group\",\n              isRequired: true,\n              saveToDatabase: true,\n              successTarget: \"interests-multiple\",\n              errorTarget: \"age-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"age-error\",\n            type: \"message\",\n            position: { x: 700, y: 250 },\n            data: {\n              messageText: \"❌ Ошибка выбора возраста\\n\\nПожалуйста, выберите одну из предложенных возрастных групп.\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-retry-age\",\n                  text: \"🔄 Повторить выбор\",\n                  action: \"goto\",\n                  target: \"age-buttons\"\n                },\n                {\n                  id: \"btn-skip-age\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"interests-multiple\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"interests-multiple\",\n            type: \"user-input\",\n            position: { x: 1000, y: 100 },\n            data: {\n              messageText: \"🎯 Шаг 3: Интересы (множественный выбор)\\n\\nВыберите ваши интересы (можно несколько):\\n\\nВыберите все подходящие варианты и нажмите \\\"Готово\\\":\",\n              responseType: \"buttons\",\n              responseOptions: [\n                {\n                  id: \"int-tech\",\n                  text: \"💻 Технологии\",\n                  value: \"technology\"\n                },\n                {\n                  id: \"int-sport\",\n                  text: \"⚽ Спорт\",\n                  value: \"sport\"\n                },\n                {\n                  id: \"int-music\",\n                  text: \"🎵 Музыка\",\n                  value: \"music\"\n                },\n                {\n                  id: \"int-travel\",\n                  text: \"✈️ Путешествия\",\n                  value: \"travel\"\n                },\n                {\n                  id: \"int-cooking\",\n                  text: \"👨‍🍳 Кулинария\",\n                  value: \"cooking\"\n                },\n                {\n                  id: \"int-books\",\n                  text: \"📚 Книги\",\n                  value: \"books\"\n                },\n                {\n                  id: \"int-done\",\n                  text: \"✅ Готово\",\n                  value: \"done\"\n                }\n              ],\n              allowMultipleSelection: true,\n              inputVariable: \"user_interests\",\n              isRequired: true,\n              saveToDatabase: true,\n              successTarget: \"contact-input\",\n              errorTarget: \"interests-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"interests-error\",\n            type: \"message\",\n            position: { x: 1000, y: 250 },\n            data: {\n              messageText: \"❌ Ошибка выбора интересов\\n\\nПожалуйста, выберите хотя бы один интерес и нажмите \\\"Готово\\\".\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-retry-interests\",\n                  text: \"🔄 Повторить выбор\",\n                  action: \"goto\",\n                  target: \"interests-multiple\"\n                },\n                {\n                  id: \"btn-skip-interests\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"contact-input\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"contact-input\",\n            type: \"user-input\",\n            position: { x: 1300, y: 100 },\n            data: {\n              messageText: \"📱 Шаг 4: Контактная информация\\n\\nВведите ваш email или телефон:\\n\\nМы используем эти данные для связи с вами:\",\n              responseType: \"text\",\n              inputType: \"email\",\n              inputVariable: \"user_contact\",\n              placeholder: \"example@email.com или +7-999-123-45-67\",\n              isRequired: false,\n              minLength: 5,\n              maxLength: 100,\n              validationMessage: \"Введите корректный email или телефон\",\n              timeoutSeconds: 180,\n              timeoutMessage: \"⏰ Время ввода истекло. Переходим к следующему шагу.\",\n              saveToDatabase: true,\n              successTarget: \"experience-rating\",\n              errorTarget: \"contact-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"contact-error\",\n            type: \"message\",\n            position: { x: 1300, y: 250 },\n            data: {\n              messageText: \"❌ Ошибка ввода контактов\\n\\nПожалуйста, введите корректный email или номер телефона.\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-retry-contact\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"contact-input\"\n                },\n                {\n                  id: \"btn-skip-contact\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"experience-rating\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"experience-rating\",\n            type: \"user-input\",\n            position: { x: 1600, y: 100 },\n            data: {\n              messageText: \"⭐ Шаг 5: Оценка опыта\\n\\nКак вы оцениваете опыт использования этого бота?\\n\\nВыберите количество звезд:\",\n              responseType: \"buttons\",\n              responseOptions: [\n                {\n                  id: \"star-1\",\n                  text: \"⭐ 1 звезда\",\n                  value: \"1\"\n                },\n                {\n                  id: \"star-2\",\n                  text: \"⭐⭐ 2 звезды\",\n                  value: \"2\"\n                },\n                {\n                  id: \"star-3\",\n                  text: \"⭐⭐⭐ 3 звезды\",\n                  value: \"3\"\n                },\n                {\n                  id: \"star-4\",\n                  text: \"⭐⭐⭐⭐ 4 звезды\",\n                  value: \"4\"\n                },\n                {\n                  id: \"star-5\",\n                  text: \"⭐⭐⭐⭐⭐ 5 звезд\",\n                  value: \"5\"\n                }\n              ],\n              allowMultipleSelection: false,\n              inputVariable: \"user_rating\",\n              isRequired: true,\n              saveToDatabase: true,\n              successTarget: \"final-comment\",\n              errorTarget: \"rating-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"rating-error\",\n            type: \"message\",\n            position: { x: 1600, y: 250 },\n            data: {\n              messageText: \"❌ Ошибка оценки\\n\\nПожалуйста, выберите оценку от 1 до 5 звезд.\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-retry-rating\",\n                  text: \"🔄 Повторить оценку\",\n                  action: \"goto\",\n                  target: \"experience-rating\"\n                },\n                {\n                  id: \"btn-skip-rating\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"final-comment\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"final-comment\",\n            type: \"user-input\",\n            position: { x: 1900, y: 100 },\n            data: {\n              messageText: \"💭 Шаг 6: Заключительный комментарий\\n\\nЕсть ли у вас дополнительные комментарии или предложения?\\n\\nНапишите ваше мнение (необязательно):\",\n              responseType: \"text\",\n              inputType: \"text\",\n              inputVariable: \"user_comment\",\n              placeholder: \"Ваши комментарии и предложения...\",\n              isRequired: false,\n              minLength: 0,\n              maxLength: 1000,\n              validationMessage: \"Комментарий не должен превышать 1000 символов\",\n              timeoutSeconds: 300,\n              timeoutMessage: \"⏰ Время ввода истекло. Завершаем сбор данных.\",\n              saveToDatabase: true,\n              successTarget: \"final-results\",\n              errorTarget: \"comment-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"comment-error\",\n            type: \"message\",\n            position: { x: 1900, y: 250 },\n            data: {\n              messageText: \"❌ Ошибка комментария\\n\\nКомментарий слишком длинный. Максимум 1000 символов.\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-retry-comment\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"final-comment\"\n                },\n                {\n                  id: \"btn-skip-comment\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"final-results\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          },\n          {\n            id: \"final-results\",\n            type: \"message\",\n            position: { x: 2200, y: 100 },\n            data: {\n              messageText: \"🎉 Сбор данных завершен!\\n\\nСпасибо за участие!\\n\\nВы успешно продемонстрировали все типы сбора пользовательского ввода:\\n\\n✅ Текстовый ввод - имя и комментарии\\n✅ Одиночный выбор - возраст и рейтинг\\n✅ Множественный выбор - интересы\\n✅ Валидация данных - проверка email/телефона\\n✅ Обработка ошибок - повторы и пропуски\\n\\nВсе данные сохранены в базе данных и готовы к анализу.\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"btn-restart\",\n                  text: \"🔄 Пройти снова\",\n                  action: \"goto\",\n                  target: \"start-1\"\n                },\n                {\n                  id: \"btn-admin\",\n                  text: \"👨‍💼 Панель управления\",\n                  action: \"command\",\n                  target: \"/admin\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\",\n              oneTimeKeyboard: false,\n              resizeKeyboard: true\n            }\n          }\n        ],\n        connections: [\n          {\n            id: \"conn-1\",\n            source: \"start-1\",\n            target: \"name-input\"\n          },\n          {\n            id: \"conn-2\",\n            source: \"start-1\",\n            target: \"final-results\"\n          },\n          {\n            id: \"conn-3\",\n            source: \"name-input\",\n            target: \"age-buttons\"\n          },\n          {\n            id: \"conn-4\",\n            source: \"name-input\",\n            target: \"name-error\"\n          },\n          {\n            id: \"conn-5\",\n            source: \"name-error\",\n            target: \"name-input\"\n          },\n          {\n            id: \"conn-6\",\n            source: \"name-error\",\n            target: \"age-buttons\"\n          },\n          {\n            id: \"conn-7\",\n            source: \"age-buttons\",\n            target: \"interests-multiple\"\n          },\n          {\n            id: \"conn-8\",\n            source: \"age-buttons\",\n            target: \"age-error\"\n          },\n          {\n            id: \"conn-9\",\n            source: \"age-error\",\n            target: \"age-buttons\"\n          },\n          {\n            id: \"conn-10\",\n            source: \"age-error\",\n            target: \"interests-multiple\"\n          },\n          {\n            id: \"conn-11\",\n            source: \"interests-multiple\",\n            target: \"contact-input\"\n          },\n          {\n            id: \"conn-12\",\n            source: \"interests-multiple\",\n            target: \"interests-error\"\n          },\n          {\n            id: \"conn-13\",\n            source: \"interests-error\",\n            target: \"interests-multiple\"\n          },\n          {\n            id: \"conn-14\",\n            source: \"interests-error\",\n            target: \"contact-input\"\n          },\n          {\n            id: \"conn-15\",\n            source: \"contact-input\",\n            target: \"experience-rating\"\n          },\n          {\n            id: \"conn-16\",\n            source: \"contact-input\",\n            target: \"contact-error\"\n          },\n          {\n            id: \"conn-17\",\n            source: \"contact-error\",\n            target: \"contact-input\"\n          },\n          {\n            id: \"conn-18\",\n            source: \"contact-error\",\n            target: \"experience-rating\"\n          },\n          {\n            id: \"conn-19\",\n            source: \"experience-rating\",\n            target: \"final-comment\"\n          },\n          {\n            id: \"conn-20\",\n            source: \"experience-rating\",\n            target: \"rating-error\"\n          },\n          {\n            id: \"conn-21\",\n            source: \"rating-error\",\n            target: \"experience-rating\"\n          },\n          {\n            id: \"conn-22\",\n            source: \"rating-error\",\n            target: \"final-comment\"\n          },\n          {\n            id: \"conn-23\",\n            source: \"final-comment\",\n            target: \"final-results\"\n          },\n          {\n            id: \"conn-24\",\n            source: \"final-comment\",\n            target: \"comment-error\"\n          },\n          {\n            id: \"conn-25\",\n            source: \"comment-error\",\n            target: \"final-comment\"\n          },\n          {\n            id: \"conn-26\",\n            source: \"comment-error\",\n            target: \"final-results\"\n          },\n          {\n            id: \"conn-27\",\n            source: \"final-results\",\n            target: \"start-1\"\n          }\n        ]\n      }\n    });\n\n    // Комплексный сбор корпоративной информации\n    await storage.createBotTemplate({\n      name: \"📊 Комплексный сбор корпоративной информации\",\n      description: \"Профессиональная система сбора детальной информации о компаниях, сотрудниках и проектах с многоуровневой структурой\",\n      category: \"business\",\n      tags: [\"анкета\", \"сбор данных\", \"корпоративный\", \"комплексный\", \"профессиональный\", \"многоуровневый\"],\n      isPublic: 1,\n      difficulty: \"hard\",\n      authorName: \"Система\",\n      version: \"1.0.0\",\n      featured: 1,\n      language: \"ru\",\n      complexity: 9,\n      estimatedTime: 45,\n      data: {\n        nodes: [\n          {\n            id: \"start-welcome\",\n            type: \"start\",\n            position: { x: 100, y: 100 },\n            data: {\n              command: \"/start\",\n              description: \"Запуск комплексного сбора корпоративной информации\",\n              messageText: \"🏢 ДОБРО ПОЖАЛОВАТЬ В СИСТЕМУ СБОРА КОРПОРАТИВНОЙ ИНФОРМАЦИИ\\n\\n📋 Этот процесс включает:\\n• 👤 Персональные данные сотрудника\\n• 🏢 Информация о компании\\n• 💼 Профессиональный опыт\\n• 📊 Текущие проекты\\n• 🎯 Цели и планы\\n• 📞 Контактная информация\\n• 🔒 Конфиденциальность\\n\\n⏱️ Время заполнения: 30-45 минут\\n🎯 Результат: Полная корпоративная анкета\\n\\nНачинаем процесс сбора информации?\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"start-process\",\n                  text: \"🚀 Начать заполнение\",\n                  action: \"goto\",\n                  target: \"personal-info\"\n                },\n                {\n                  id: \"view-privacy\",\n                  text: \"🔒 Политика конфиденциальности\",\n                  action: \"goto\",\n                  target: \"privacy-policy\"\n                },\n                {\n                  id: \"instructions\",\n                  text: \"📖 Инструкции\",\n                  action: \"goto\",\n                  target: \"filling-instructions\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"privacy-policy\",\n            type: \"message\",\n            position: { x: 400, y: 50 },\n            data: {\n              messageText: \"🔒 ПОЛИТИКА КОНФИДЕНЦИАЛЬНОСТИ\\n\\n✅ Мы гарантируем:\\n• Защиту всех персональных данных\\n• Использование данных только для внутренних целей\\n• Соблюдение требований GDPR и 152-ФЗ\\n• Возможность удаления данных по запросу\\n\\n🛡️ Безопасность:\\n• Шифрование данных при передаче\\n• Ограниченный доступ к информации\\n• Регулярные аудиты безопасности\\n\\n📧 Контакты: privacy@company.com\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"accept-privacy\",\n                  text: \"✅ Принять и продолжить\",\n                  action: \"goto\",\n                  target: \"personal-info\"\n                },\n                {\n                  id: \"back-to-start\",\n                  text: \"◀️ Назад к началу\",\n                  action: \"goto\",\n                  target: \"start-welcome\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"filling-instructions\",\n            type: \"message\",\n            position: { x: 400, y: 150 },\n            data: {\n              messageText: \"📖 ИНСТРУКЦИИ ПО ЗАПОЛНЕНИЮ\\n\\n🎯 Общие рекомендации:\\n• Заполняйте все поля максимально точно\\n• При необходимости используйте кнопку \\\"Пропустить\\\"\\n• Можете вернуться к предыдущим разделам\\n• Сохранение происходит автоматически\\n\\n⚡ Быстрые команды:\\n• /help - помощь в любое время\\n• /status - текущий прогресс\\n• /reset - начать заново\\n\\n💡 Совет: Подготовьте заранее данные о компании и проектах\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"start-after-instructions\",\n                  text: \"🚀 Начать заполнение\",\n                  action: \"goto\",\n                  target: \"personal-info\"\n                },\n                {\n                  id: \"back-from-instructions\",\n                  text: \"◀️ Назад к началу\",\n                  action: \"goto\",\n                  target: \"start-welcome\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"personal-info\",\n            type: \"user-input\",\n            position: { x: 700, y: 100 },\n            data: {\n              messageText: \"👤 РАЗДЕЛ 1: ПЕРСОНАЛЬНЫЕ ДАННЫЕ\\n\\nВведите ваше полное имя:\\n\\nПример: Иванов Иван Иванович\\n\\n📝 Укажите фамилию, имя и отчество полностью\",\n              responseType: \"text\",\n              inputType: \"text\",\n              inputVariable: \"full_name\",\n              minLength: 3,\n              maxLength: 100,\n              inputTimeout: 300,\n              inputRequired: true,\n              allowSkip: false,\n              saveToDatabase: true,\n              inputRetryMessage: \"Пожалуйста, укажите ваше полное имя (минимум 3 символа)\",\n              inputSuccessMessage: \"✅ Имя сохранено\",\n              placeholder: \"Фамилия Имя Отчество\",\n              successTarget: \"position-info\",\n              errorTarget: \"personal-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"personal-error\",\n            type: \"message\",\n            position: { x: 950, y: 100 },\n            data: {\n              messageText: \"❌ ОШИБКА ВВОДА ПЕРСОНАЛЬНЫХ ДАННЫХ\\n\\nПожалуйста, укажите корректное полное имя.\\n\\nТребования:\\n• Минимум 3 символа\\n• Максимум 100 символов\\n• Только буквы и пробелы\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-personal\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"personal-info\"\n                },\n                {\n                  id: \"skip-personal\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"position-info\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"position-info\",\n            type: \"user-input\",\n            position: { x: 700, y: 250 },\n            data: {\n              messageText: \"💼 РАЗДЕЛ 2: ДОЛЖНОСТЬ И ОТДЕЛ\\n\\nУкажите вашу текущую должность:\\n\\nПример: Ведущий разработчик / Менеджер проектов / Системный аналитик\\n\\n📝 Укажите полное название должности\",\n              responseType: \"text\",\n              inputType: \"text\",\n              inputVariable: \"position_title\",\n              minLength: 3,\n              maxLength: 150,\n              inputTimeout: 300,\n              inputRequired: true,\n              allowSkip: false,\n              saveToDatabase: true,\n              inputRetryMessage: \"Пожалуйста, укажите вашу должность (минимум 3 символа)\",\n              inputSuccessMessage: \"✅ Должность сохранена\",\n              placeholder: \"Название должности\",\n              successTarget: \"department-choice\",\n              errorTarget: \"position-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"position-error\",\n            type: \"message\",\n            position: { x: 950, y: 250 },\n            data: {\n              messageText: \"❌ ОШИБКА ВВОДА ДОЛЖНОСТИ\\n\\nПожалуйста, укажите корректное название должности.\\n\\nТребования:\\n• Минимум 3 символа\\n• Максимум 150 символов\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-position\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"position-info\"\n                },\n                {\n                  id: \"skip-position\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"department-choice\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"department-choice\",\n            type: \"user-input\",\n            position: { x: 700, y: 400 },\n            data: {\n              messageText: \"🏢 РАЗДЕЛ 3: ОТДЕЛ/ПОДРАЗДЕЛЕНИЕ\\n\\nВыберите ваш отдел:\\n\\nЕсли вашего отдела нет в списке, выберите \\\"Другое\\\"\",\n              responseType: \"buttons\",\n              responseOptions: [\n                {\n                  id: \"dept-it\",\n                  text: \"💻 IT-отдел\",\n                  value: \"IT\"\n                },\n                {\n                  id: \"dept-sales\",\n                  text: \"📈 Отдел продаж\",\n                  value: \"sales\"\n                },\n                {\n                  id: \"dept-marketing\",\n                  text: \"📢 Маркетинг\",\n                  value: \"marketing\"\n                },\n                {\n                  id: \"dept-hr\",\n                  text: \"👥 HR-отдел\",\n                  value: \"hr\"\n                },\n                {\n                  id: \"dept-finance\",\n                  text: \"💰 Финансы\",\n                  value: \"finance\"\n                },\n                {\n                  id: \"dept-operations\",\n                  text: \"⚙️ Операции\",\n                  value: \"operations\"\n                },\n                {\n                  id: \"dept-management\",\n                  text: \"👔 Руководство\",\n                  value: \"management\"\n                },\n                {\n                  id: \"dept-other\",\n                  text: \"📋 Другое\",\n                  value: \"other\"\n                }\n              ],\n              allowMultipleSelection: false,\n              inputVariable: \"department\",\n              isRequired: true,\n              saveToDatabase: true,\n              successTarget: \"experience-level\",\n              errorTarget: \"department-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"department-error\",\n            type: \"message\",\n            position: { x: 950, y: 400 },\n            data: {\n              messageText: \"❌ ОШИБКА ВЫБОРА ОТДЕЛА\\n\\nПожалуйста, выберите ваш отдел из предложенных вариантов.\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-department\",\n                  text: \"🔄 Повторить выбор\",\n                  action: \"goto\",\n                  target: \"department-choice\"\n                },\n                {\n                  id: \"skip-department\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"experience-level\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"experience-level\",\n            type: \"user-input\",\n            position: { x: 700, y: 550 },\n            data: {\n              messageText: \"⭐ РАЗДЕЛ 4: ОПЫТ РАБОТЫ\\n\\nУкажите ваш уровень опыта:\\n\\nВыберите наиболее подходящий вариант\",\n              responseType: \"buttons\",\n              responseOptions: [\n                {\n                  id: \"exp-junior\",\n                  text: \"🌱 Начинающий (0-2 года)\",\n                  value: \"junior\"\n                },\n                {\n                  id: \"exp-middle\",\n                  text: \"💼 Средний (2-5 лет)\",\n                  value: \"middle\"\n                },\n                {\n                  id: \"exp-senior\",\n                  text: \"🎯 Старший (5-10 лет)\",\n                  value: \"senior\"\n                },\n                {\n                  id: \"exp-lead\",\n                  text: \"👑 Ведущий (10+ лет)\",\n                  value: \"lead\"\n                },\n                {\n                  id: \"exp-executive\",\n                  text: \"🏆 Руководитель\",\n                  value: \"executive\"\n                }\n              ],\n              allowMultipleSelection: false,\n              inputVariable: \"experience_level\",\n              isRequired: true,\n              saveToDatabase: true,\n              successTarget: \"company-info\",\n              errorTarget: \"experience-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"experience-error\",\n            type: \"message\",\n            position: { x: 950, y: 550 },\n            data: {\n              messageText: \"❌ ОШИБКА ВЫБОРА ОПЫТА\\n\\nПожалуйста, выберите ваш уровень опыта из предложенных вариантов.\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-experience\",\n                  text: \"🔄 Повторить выбор\",\n                  action: \"goto\",\n                  target: \"experience-level\"\n                },\n                {\n                  id: \"skip-experience\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"company-info\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"company-info\",\n            type: \"user-input\",\n            position: { x: 1100, y: 100 },\n            data: {\n              messageText: \"🏢 РАЗДЕЛ 5: ИНФОРМАЦИЯ О КОМПАНИИ\\n\\nУкажите название вашей компании:\\n\\nПример: ООО \\\"Технологические решения\\\" / АО \\\"Инновации\\\" / ИП Иванов И.И.\\n\\n📝 Полное или сокращенное наименование\",\n              responseType: \"text\",\n              inputType: \"text\",\n              inputVariable: \"company_name\",\n              minLength: 2,\n              maxLength: 200,\n              inputTimeout: 300,\n              inputRequired: true,\n              allowSkip: false,\n              saveToDatabase: true,\n              inputRetryMessage: \"Пожалуйста, укажите название компании (минимум 2 символа)\",\n              inputSuccessMessage: \"✅ Название компании сохранено\",\n              placeholder: \"Название компании\",\n              successTarget: \"company-size\",\n              errorTarget: \"company-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"company-error\",\n            type: \"message\",\n            position: { x: 1350, y: 100 },\n            data: {\n              messageText: \"❌ ОШИБКА ВВОДА КОМПАНИИ\\n\\nПожалуйста, укажите корректное название компании.\\n\\nТребования:\\n• Минимум 2 символа\\n• Максимум 200 символов\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-company\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"company-info\"\n                },\n                {\n                  id: \"skip-company\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"company-size\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"company-size\",\n            type: \"user-input\",\n            position: { x: 1100, y: 250 },\n            data: {\n              messageText: \"📊 РАЗДЕЛ 6: РАЗМЕР КОМПАНИИ\\n\\nВыберите размер вашей компании:\\n\\nУкажите примерное количество сотрудников\",\n              responseType: \"buttons\",\n              responseOptions: [\n                {\n                  id: \"size-micro\",\n                  text: \"👤 Микро (1-10 человек)\",\n                  value: \"micro\"\n                },\n                {\n                  id: \"size-small\",\n                  text: \"👥 Малая (11-50 человек)\",\n                  value: \"small\"\n                },\n                {\n                  id: \"size-medium\",\n                  text: \"🏢 Средняя (51-250 человек)\",\n                  value: \"medium\"\n                },\n                {\n                  id: \"size-large\",\n                  text: \"🏬 Большая (251-1000 человек)\",\n                  value: \"large\"\n                },\n                {\n                  id: \"size-enterprise\",\n                  text: \"🏭 Корпорация (1000+ человек)\",\n                  value: \"enterprise\"\n                }\n              ],\n              allowMultipleSelection: false,\n              inputVariable: \"company_size\",\n              isRequired: true,\n              saveToDatabase: true,\n              successTarget: \"project-info\",\n              errorTarget: \"size-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"size-error\",\n            type: \"message\",\n            position: { x: 1350, y: 250 },\n            data: {\n              messageText: \"❌ ОШИБКА ВЫБОРА РАЗМЕРА\\n\\nПожалуйста, выберите размер компании из предложенных вариантов.\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-size\",\n                  text: \"🔄 Повторить выбор\",\n                  action: \"goto\",\n                  target: \"company-size\"\n                },\n                {\n                  id: \"skip-size\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"project-info\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"project-info\",\n            type: \"user-input\",\n            position: { x: 1100, y: 400 },\n            data: {\n              messageText: \"📋 РАЗДЕЛ 7: ТЕКУЩИЕ ПРОЕКТЫ\\n\\nОпишите ваши текущие проекты:\\n\\nПример: Разработка CRM-системы, внедрение системы аналитики, автоматизация бизнес-процессов\\n\\n📝 Укажите 2-3 основных проекта\",\n              responseType: \"text\",\n              inputType: \"text\",\n              inputVariable: \"current_projects\",\n              minLength: 10,\n              maxLength: 1000,\n              inputTimeout: 600,\n              inputRequired: true,\n              allowSkip: true,\n              saveToDatabase: true,\n              inputRetryMessage: \"Пожалуйста, опишите ваши проекты подробнее (минимум 10 символов)\",\n              inputSuccessMessage: \"✅ Информация о проектах сохранена\",\n              placeholder: \"Описание текущих проектов...\",\n              successTarget: \"goals-objectives\",\n              errorTarget: \"project-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"project-error\",\n            type: \"message\",\n            position: { x: 1350, y: 400 },\n            data: {\n              messageText: \"❌ ОШИБКА ВВОДА ПРОЕКТОВ\\n\\nПожалуйста, опишите ваши проекты более подробно.\\n\\nТребования:\\n• Минимум 10 символов\\n• Максимум 1000 символов\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-project\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"project-info\"\n                },\n                {\n                  id: \"skip-project\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"goals-objectives\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"goals-objectives\",\n            type: \"user-input\",\n            position: { x: 1100, y: 550 },\n            data: {\n              messageText: \"🎯 РАЗДЕЛ 8: ЦЕЛИ И ЗАДАЧИ\\n\\nОпишите ваши профессиональные цели:\\n\\nПример: Развитие в области машинного обучения, получение сертификации, повышение до тимлида\\n\\n📝 Укажите краткосрочные и долгосрочные цели\",\n              responseType: \"text\",\n              inputType: \"text\",\n              inputVariable: \"professional_goals\",\n              minLength: 10,\n              maxLength: 800,\n              inputTimeout: 600,\n              inputRequired: true,\n              allowSkip: true,\n              saveToDatabase: true,\n              inputRetryMessage: \"Пожалуйста, опишите ваши цели подробнее (минимум 10 символов)\",\n              inputSuccessMessage: \"✅ Профессиональные цели сохранены\",\n              placeholder: \"Профессиональные цели и задачи...\",\n              successTarget: \"contact-info\",\n              errorTarget: \"goals-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"goals-error\",\n            type: \"message\",\n            position: { x: 1350, y: 550 },\n            data: {\n              messageText: \"❌ ОШИБКА ВВОДА ЦЕЛЕЙ\\n\\nПожалуйста, опишите ваши цели более подробно.\\n\\nТребования:\\n• Минимум 10 символов\\n• Максимум 800 символов\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-goals\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"goals-objectives\"\n                },\n                {\n                  id: \"skip-goals\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"contact-info\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"contact-info\",\n            type: \"user-input\",\n            position: { x: 1500, y: 100 },\n            data: {\n              messageText: \"📞 РАЗДЕЛ 9: КОНТАКТНАЯ ИНФОРМАЦИЯ\\n\\nУкажите ваш рабочий email:\\n\\nПример: ivan.ivanov@company.com\\n\\n📧 Корпоративный или основной email для связи\",\n              responseType: \"text\",\n              inputType: \"email\",\n              inputVariable: \"work_email\",\n              minLength: 5,\n              maxLength: 150,\n              inputTimeout: 300,\n              inputRequired: true,\n              allowSkip: false,\n              saveToDatabase: true,\n              inputRetryMessage: \"Пожалуйста, укажите корректный email адрес\",\n              inputSuccessMessage: \"✅ Email сохранен\",\n              placeholder: \"email@company.com\",\n              successTarget: \"phone-info\",\n              errorTarget: \"contact-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"contact-error\",\n            type: \"message\",\n            position: { x: 1750, y: 100 },\n            data: {\n              messageText: \"❌ ОШИБКА ВВОДА EMAIL\\n\\nПожалуйста, укажите корректный email адрес.\\n\\nТребования:\\n• Формат: name@domain.com\\n• Минимум 5 символов\\n• Максимум 150 символов\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-contact\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"contact-info\"\n                },\n                {\n                  id: \"skip-contact\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"phone-info\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"phone-info\",\n            type: \"user-input\",\n            position: { x: 1500, y: 250 },\n            data: {\n              messageText: \"📱 РАЗДЕЛ 10: ТЕЛЕФОН\\n\\nУкажите ваш рабочий телефон:\\n\\nПример: +7 (999) 123-45-67\\n\\n📞 Рабочий или мобильный телефон для связи\",\n              responseType: \"text\",\n              inputType: \"phone\",\n              inputVariable: \"work_phone\",\n              minLength: 10,\n              maxLength: 20,\n              inputTimeout: 300,\n              inputRequired: true,\n              allowSkip: true,\n              saveToDatabase: true,\n              inputRetryMessage: \"Пожалуйста, укажите корректный номер телефона\",\n              inputSuccessMessage: \"✅ Телефон сохранен\",\n              placeholder: \"+7 (999) 123-45-67\",\n              successTarget: \"additional-info\",\n              errorTarget: \"phone-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"phone-error\",\n            type: \"message\",\n            position: { x: 1750, y: 250 },\n            data: {\n              messageText: \"❌ ОШИБКА ВВОДА ТЕЛЕФОНА\\n\\nПожалуйста, укажите корректный номер телефона.\\n\\nТребования:\\n• Формат: +7 (999) 123-45-67\\n• Минимум 10 символов\\n• Максимум 20 символов\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-phone\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"phone-info\"\n                },\n                {\n                  id: \"skip-phone\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"additional-info\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"additional-info\",\n            type: \"user-input\",\n            position: { x: 1500, y: 400 },\n            data: {\n              messageText: \"📝 РАЗДЕЛ 11: ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ\\n\\nЕсть ли что-то еще, что вы хотели бы добавить?\\n\\nПример: Навыки, сертификаты, интересные проекты, предложения по улучшению\\n\\n💡 Любая дополнительная информация о вас или вашей работе\",\n              responseType: \"text\",\n              inputType: \"text\",\n              inputVariable: \"additional_notes\",\n              minLength: 0,\n              maxLength: 1000,\n              inputTimeout: 600,\n              inputRequired: false,\n              allowSkip: true,\n              saveToDatabase: true,\n              inputRetryMessage: \"Слишком много текста, сократите до 1000 символов\",\n              inputSuccessMessage: \"✅ Дополнительная информация сохранена\",\n              placeholder: \"Дополнительная информация (необязательно)...\",\n              successTarget: \"final-review\",\n              errorTarget: \"additional-error\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"additional-error\",\n            type: \"message\",\n            position: { x: 1750, y: 400 },\n            data: {\n              messageText: \"❌ ОШИБКА ДОПОЛНИТЕЛЬНОЙ ИНФОРМАЦИИ\\n\\nСлишком много текста.\\n\\nТребования:\\n• Максимум 1000 символов\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"retry-additional\",\n                  text: \"🔄 Повторить ввод\",\n                  action: \"goto\",\n                  target: \"additional-info\"\n                },\n                {\n                  id: \"skip-additional\",\n                  text: \"⏭️ Пропустить\",\n                  action: \"goto\",\n                  target: \"final-review\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"final-review\",\n            type: \"message\",\n            position: { x: 1500, y: 550 },\n            data: {\n              messageText: \"🎉 СБОР ИНФОРМАЦИИ ЗАВЕРШЕН!\\n\\n✅ Собранные данные:\\n• 👤 Персональные данные\\n• 💼 Профессиональная информация\\n• 🏢 Данные о компании\\n• 📊 Проекты и цели\\n• 📞 Контактная информация\\n\\n🔄 Что делать дальше:\\n• Данные сохранены в системе\\n• Вы получите подтверждение на email\\n• Можете обновить данные в любое время\\n\\nСпасибо за участие!\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"download-pdf\",\n                  text: \"📄 Скачать PDF\",\n                  action: \"goto\",\n                  target: \"download-info\"\n                },\n                {\n                  id: \"send-email\",\n                  text: \"📧 Отправить на email\",\n                  action: \"goto\",\n                  target: \"email-confirmation\"\n                },\n                {\n                  id: \"restart-process\",\n                  text: \"🔄 Начать заново\",\n                  action: \"goto\",\n                  target: \"start-welcome\"\n                },\n                {\n                  id: \"main-menu\",\n                  text: \"📋 Главное меню\",\n                  action: \"command\",\n                  target: \"/menu\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"download-info\",\n            type: \"message\",\n            position: { x: 1800, y: 450 },\n            data: {\n              messageText: \"📄 СКАЧИВАНИЕ PDF ОТЧЕТА\\n\\n🔄 Генерируем отчет...\\n\\n📊 Отчет будет содержать:\\n• Все введенные данные\\n• Структурированный вид\\n• Timestamp создания\\n• Подпись системы\\n\\n⏱️ Готовность через 10-15 секунд\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"pdf-ready\",\n                  text: \"✅ PDF готов\",\n                  action: \"goto\",\n                  target: \"final-review\"\n                },\n                {\n                  id: \"back-to-review\",\n                  text: \"◀️ Назад к результатам\",\n                  action: \"goto\",\n                  target: \"final-review\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          },\n          {\n            id: \"email-confirmation\",\n            type: \"message\",\n            position: { x: 1800, y: 550 },\n            data: {\n              messageText: \"📧 ОТПРАВКА НА EMAIL\\n\\n✅ Письмо отправлено на:\\n{work_email}\\n\\n📬 Содержимое письма:\\n• Полный отчет с данными\\n• Ссылка для редактирования\\n• Контакты для обратной связи\\n\\n⏱️ Проверьте почту в течение 5 минут\",\n              keyboardType: \"inline\",\n              buttons: [\n                {\n                  id: \"email-sent\",\n                  text: \"✅ Понятно\",\n                  action: \"goto\",\n                  target: \"final-review\"\n                },\n                {\n                  id: \"resend-email\",\n                  text: \"🔄 Отправить повторно\",\n                  action: \"goto\",\n                  target: \"email-confirmation\"\n                }\n              ],\n              formatMode: \"none\",\n              formatMode: \"none\"\n            }\n          }\n        ],\n        connections: [\n          { id: \"conn-1\", source: \"start-welcome\", target: \"personal-info\" },\n          { id: \"conn-2\", source: \"start-welcome\", target: \"privacy-policy\" },\n          { id: \"conn-3\", source: \"start-welcome\", target: \"filling-instructions\" },\n          { id: \"conn-4\", source: \"privacy-policy\", target: \"personal-info\" },\n          { id: \"conn-5\", source: \"privacy-policy\", target: \"start-welcome\" },\n          { id: \"conn-6\", source: \"filling-instructions\", target: \"personal-info\" },\n          { id: \"conn-7\", source: \"filling-instructions\", target: \"start-welcome\" },\n          { id: \"conn-8\", source: \"personal-info\", target: \"position-info\" },\n          { id: \"conn-9\", source: \"personal-info\", target: \"personal-error\" },\n          { id: \"conn-10\", source: \"personal-error\", target: \"personal-info\" },\n          { id: \"conn-11\", source: \"personal-error\", target: \"position-info\" },\n          { id: \"conn-12\", source: \"position-info\", target: \"department-choice\" },\n          { id: \"conn-13\", source: \"position-info\", target: \"position-error\" },\n          { id: \"conn-14\", source: \"position-error\", target: \"position-info\" },\n          { id: \"conn-15\", source: \"position-error\", target: \"department-choice\" },\n          { id: \"conn-16\", source: \"department-choice\", target: \"experience-level\" },\n          { id: \"conn-17\", source: \"department-choice\", target: \"department-error\" },\n          { id: \"conn-18\", source: \"department-error\", target: \"department-choice\" },\n          { id: \"conn-19\", source: \"department-error\", target: \"experience-level\" },\n          { id: \"conn-20\", source: \"experience-level\", target: \"company-info\" },\n          { id: \"conn-21\", source: \"experience-level\", target: \"experience-error\" },\n          { id: \"conn-22\", source: \"experience-error\", target: \"experience-level\" },\n          { id: \"conn-23\", source: \"experience-error\", target: \"company-info\" },\n          { id: \"conn-24\", source: \"company-info\", target: \"company-size\" },\n          { id: \"conn-25\", source: \"company-info\", target: \"company-error\" },\n          { id: \"conn-26\", source: \"company-error\", target: \"company-info\" },\n          { id: \"conn-27\", source: \"company-error\", target: \"company-size\" },\n          { id: \"conn-28\", source: \"company-size\", target: \"project-info\" },\n          { id: \"conn-29\", source: \"company-size\", target: \"size-error\" },\n          { id: \"conn-30\", source: \"size-error\", target: \"company-size\" },\n          { id: \"conn-31\", source: \"size-error\", target: \"project-info\" },\n          { id: \"conn-32\", source: \"project-info\", target: \"goals-objectives\" },\n          { id: \"conn-33\", source: \"project-info\", target: \"project-error\" },\n          { id: \"conn-34\", source: \"project-error\", target: \"project-info\" },\n          { id: \"conn-35\", source: \"project-error\", target: \"goals-objectives\" },\n          { id: \"conn-36\", source: \"goals-objectives\", target: \"contact-info\" },\n          { id: \"conn-37\", source: \"goals-objectives\", target: \"goals-error\" },\n          { id: \"conn-38\", source: \"goals-error\", target: \"goals-objectives\" },\n          { id: \"conn-39\", source: \"goals-error\", target: \"contact-info\" },\n          { id: \"conn-40\", source: \"contact-info\", target: \"phone-info\" },\n          { id: \"conn-41\", source: \"contact-info\", target: \"contact-error\" },\n          { id: \"conn-42\", source: \"contact-error\", target: \"contact-info\" },\n          { id: \"conn-43\", source: \"contact-error\", target: \"phone-info\" },\n          { id: \"conn-44\", source: \"phone-info\", target: \"additional-info\" },\n          { id: \"conn-45\", source: \"phone-info\", target: \"phone-error\" },\n          { id: \"conn-46\", source: \"phone-error\", target: \"phone-info\" },\n          { id: \"conn-47\", source: \"phone-error\", target: \"additional-info\" },\n          { id: \"conn-48\", source: \"additional-info\", target: \"final-review\" },\n          { id: \"conn-49\", source: \"additional-info\", target: \"additional-error\" },\n          { id: \"conn-50\", source: \"additional-error\", target: \"additional-info\" },\n          { id: \"conn-51\", source: \"additional-error\", target: \"final-review\" },\n          { id: \"conn-52\", source: \"final-review\", target: \"download-info\" },\n          { id: \"conn-53\", source: \"final-review\", target: \"email-confirmation\" },\n          { id: \"conn-54\", source: \"final-review\", target: \"start-welcome\" },\n          { id: \"conn-55\", source: \"download-info\", target: \"final-review\" },\n          { id: \"conn-56\", source: \"email-confirmation\", target: \"final-review\" },\n          { id: \"conn-57\", source: \"email-confirmation\", target: \"email-confirmation\" }\n        ]\n      }\n    });\n\n    console.log('✅ Стандартные шаблоны успешно созданы');\n  } catch (error) {\n    console.error('❌ Ошибка создания стандартных шаблонов:', error);\n  }\n}","size_bytes":119204},"client/src/components/editor/templates-modal.tsx":{"content":"import { useState, useMemo } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Badge } from '@/components/ui/badge';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Loader2, Search, Download, Eye, Calendar, User, Filter, Star, TrendingUp, Crown, Sparkles, Trash2, Heart, Bookmark, Clock, Globe, Shield } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { format } from 'date-fns';\nimport { ru } from 'date-fns/locale';\nimport type { BotTemplate } from '@shared/schema';\nimport type { BotData } from '@/types/bot';\n\ninterface TemplatesModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSelectTemplate: (template: BotTemplate) => void;\n}\n\nexport function TemplatesModal({ isOpen, onClose, onSelectTemplate }: TemplatesModalProps) {\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedCategory, setSelectedCategory] = useState<string>('all');\n  const [selectedTemplate, setSelectedTemplate] = useState<BotTemplate | null>(null);\n  const [showPreview, setShowPreview] = useState(false);\n  const [currentTab, setCurrentTab] = useState('all');\n  const [sortBy, setSortBy] = useState<'popular' | 'rating' | 'recent' | 'name'>('popular');\n\n  const { toast } = useToast();\n\n  // Отладка для проверки открытия модального окна\n  if (isOpen) {\n    console.log('Templates modal is open');\n  }\n\n  const { data: templates = [], isLoading } = useQuery<BotTemplate[]>({\n    queryKey: ['/api/templates'],\n    enabled: isOpen,\n  });\n\n  const { data: featuredTemplates = [], isLoading: isLoadingFeatured } = useQuery<BotTemplate[]>({\n    queryKey: ['/api/templates/featured'],\n    enabled: isOpen && currentTab === 'featured',\n  });\n\n  const { data: myTemplates = [], isLoading: isLoadingMy } = useQuery<BotTemplate[]>({\n    queryKey: ['/api/templates/category/custom'],\n    enabled: isOpen,\n    staleTime: 0, // Always refetch when needed\n  });\n\n  // Мутация для увеличения счетчика использования\n  const useTemplateMutation = useMutation({\n    mutationFn: async (templateId: number) => {\n      const response = await fetch(`/api/templates/${templateId}/use`, {\n        method: 'POST',\n      });\n      if (!response.ok) throw new Error('Failed to increment use count');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n    },\n  });\n\n  // Мутация для оценки шаблона\n  const rateTemplateMutation = useMutation({\n    mutationFn: async ({ templateId, rating }: { templateId: number; rating: number }) => {\n      const response = await fetch(`/api/templates/${templateId}/rate`, {\n        method: 'POST',\n        body: JSON.stringify({ rating }),\n        headers: { 'Content-Type': 'application/json' },\n      });\n      if (!response.ok) throw new Error('Failed to rate template');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n      toast({\n        title: 'Спасибо за оценку!',\n        description: 'Ваша оценка поможет другим пользователям',\n      });\n    },\n  });\n\n  // Мутация для удаления шаблона\n  const deleteTemplateMutation = useMutation({\n    mutationFn: async (templateId: number) => {\n      const response = await fetch(`/api/templates/${templateId}`, {\n        method: 'DELETE',\n      });\n      if (!response.ok) throw new Error('Failed to delete template');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/templates/category/custom'] });\n      toast({\n        title: 'Шаблон удален',\n        description: 'Шаблон успешно удален',\n      });\n    },\n    onError: () => {\n      toast({\n        title: 'Ошибка',\n        description: 'Не удалось удалить шаблон',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Мутация для просмотра шаблона\n  const viewTemplateMutation = useMutation({\n    mutationFn: async (templateId: number) => {\n      const response = await fetch(`/api/templates/${templateId}/view`, {\n        method: 'POST',\n      });\n      if (!response.ok) throw new Error('Failed to increment view count');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n    },\n  });\n\n  // Мутация для лайка шаблона\n  const likeTemplateMutation = useMutation({\n    mutationFn: async ({ templateId, liked }: { templateId: number; liked: boolean }) => {\n      const response = await fetch(`/api/templates/${templateId}/like`, {\n        method: 'POST',\n        body: JSON.stringify({ liked }),\n        headers: { 'Content-Type': 'application/json' },\n      });\n      if (!response.ok) throw new Error('Failed to toggle like');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n      toast({\n        title: 'Готово!',\n        description: 'Ваша оценка учтена',\n      });\n    },\n  });\n\n  // Мутация для закладки шаблона\n  const bookmarkTemplateMutation = useMutation({\n    mutationFn: async ({ templateId, bookmarked }: { templateId: number; bookmarked: boolean }) => {\n      const response = await fetch(`/api/templates/${templateId}/bookmark`, {\n        method: 'POST',\n        body: JSON.stringify({ bookmarked }),\n        headers: { 'Content-Type': 'application/json' },\n      });\n      if (!response.ok) throw new Error('Failed to toggle bookmark');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n      toast({\n        title: 'Готово!',\n        description: 'Закладка обновлена',\n      });\n    },\n  });\n\n  // Мутация для скачивания шаблона\n  const downloadTemplateMutation = useMutation({\n    mutationFn: async (templateId: number) => {\n      const response = await fetch(`/api/templates/${templateId}/download`, {\n        method: 'POST',\n      });\n      if (!response.ok) throw new Error('Failed to increment download count');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n    },\n  });\n\n  const categories = [\n    { value: 'all', label: 'Все категории' },\n    { value: 'custom', label: 'Пользовательские' },\n    { value: 'business', label: 'Бизнес' },\n    { value: 'entertainment', label: 'Развлечения' },\n    { value: 'education', label: 'Образование' },\n    { value: 'utility', label: 'Утилиты' },\n    { value: 'games', label: 'Игры' },\n    { value: 'official', label: 'Официальные' },\n    { value: 'community', label: 'Сообщество' },\n  ];\n\n  const difficultyLabels = {\n    easy: 'Легкий',\n    medium: 'Средний',\n    hard: 'Сложный',\n  };\n\n  const filteredAndSortedTemplates = useMemo(() => {\n    let templatesData = currentTab === 'featured' ? featuredTemplates : \n                       currentTab === 'my' ? myTemplates : templates;\n    \n    // Фильтрация\n    let filtered = templatesData.filter((template: BotTemplate) => {\n      const matchesSearch = template.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                           (template.description && template.description.toLowerCase().includes(searchTerm.toLowerCase())) ||\n                           (template.tags && template.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase())));\n      const matchesCategory = selectedCategory === 'all' || template.category === selectedCategory;\n      return matchesSearch && matchesCategory;\n    });\n\n    // Дополнительная фильтрация для вкладки \"Популярные\"\n    if (currentTab === 'popular') {\n      filtered = filtered.filter(t => (t.useCount || 0) > 0);\n    }\n\n    // Сортировка\n    filtered.sort((a, b) => {\n      switch (sortBy) {\n        case 'popular':\n          return (b.useCount || 0) - (a.useCount || 0);\n        case 'rating':\n          return (b.rating || 0) - (a.rating || 0);\n        case 'recent':\n          const bDate = b.createdAt ? new Date(b.createdAt).getTime() : 0;\n          const aDate = a.createdAt ? new Date(a.createdAt).getTime() : 0;\n          return bDate - aDate;\n        case 'name':\n          return a.name.localeCompare(b.name);\n        default:\n          return 0;\n      }\n    });\n\n    return filtered;\n  }, [templates, featuredTemplates, myTemplates, currentTab, searchTerm, selectedCategory, sortBy]);\n\n  const handleUseTemplate = async (template: BotTemplate) => {\n    try {\n      console.log('Применяем шаблон:', template.name, template.data);\n      \n      // Сначала применяем шаблон к редактору\n      onSelectTemplate(template);\n      \n      // Затем обновляем счетчик использования\n      await useTemplateMutation.mutateAsync(template.id);\n      \n      toast({\n        title: 'Шаблон применен',\n        description: `Шаблон \"${template.name}\" загружен на холст`,\n      });\n      onClose();\n    } catch (error) {\n      console.error('Ошибка применения шаблона:', error);\n      toast({\n        title: 'Ошибка',\n        description: 'Не удалось применить шаблон',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  const handleRateTemplate = async (template: BotTemplate, rating: number) => {\n    try {\n      await rateTemplateMutation.mutateAsync({ templateId: template.id, rating });\n    } catch (error) {\n      toast({\n        title: 'Ошибка',\n        description: 'Не удалось поставить оценку',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  const handleDeleteTemplate = async (template: BotTemplate) => {\n    if (window.confirm(`Вы уверены, что хотите удалить шаблон \"${template.name}\"?`)) {\n      try {\n        await deleteTemplateMutation.mutateAsync(template.id);\n      } catch (error) {\n        toast({\n          title: 'Ошибка',\n          description: 'Не удалось удалить шаблон',\n          variant: 'destructive',\n        });\n      }\n    }\n  };\n\n  const getTemplateStats = (botData: BotData | any) => {\n    let nodes: any[] = [];\n    let connections: any[] = [];\n    \n    console.log('🔍 Calculating stats for template data:', botData);\n    \n    // Проверяем, это многолистовой шаблон или обычный\n    if (botData.sheets && Array.isArray(botData.sheets)) {\n      console.log('📋 Multi-sheet template detected, sheets count:', botData.sheets.length);\n      // Многолистовой шаблон - собираем все узлы и связи из всех листов\n      botData.sheets.forEach((sheet: any, index: number) => {\n        if (sheet.nodes) {\n          console.log(`📄 Sheet ${index + 1} (${sheet.name}): ${sheet.nodes.length} nodes`);\n          nodes.push(...sheet.nodes);\n        }\n        if (sheet.connections) {\n          console.log(`🔗 Sheet ${index + 1} (${sheet.name}): ${sheet.connections.length} connections`);\n          connections.push(...sheet.connections);\n        }\n      });\n      // Добавляем межлистовые связи\n      if (botData.interSheetConnections) {\n        console.log('🔄 Inter-sheet connections:', botData.interSheetConnections.length);\n        connections.push(...botData.interSheetConnections);\n      }\n    } else {\n      console.log('📝 Regular template detected');\n      // Обычный шаблон\n      nodes = botData.nodes || [];\n      connections = botData.connections || [];\n    }\n    \n    const stats = {\n      nodes: nodes.length,\n      connections: connections.length,\n      commands: nodes.filter(node => node.data?.command).length,\n      buttons: nodes.reduce((acc, node) => acc + (node.data?.buttons?.length || 0), 0),\n    };\n    \n    console.log('📊 Final stats:', stats);\n    return stats;\n  };\n\n  const handlePreview = (template: BotTemplate) => {\n    console.log('🎯 PREVIEW BUTTON CLICKED FOR TEMPLATE:', template.name);\n    console.log('🎯 TEMPLATE DATA STRUCTURE:', Object.keys(template.data || {}));\n    console.log('🎯 FULL TEMPLATE DATA:', template.data);\n    setSelectedTemplate(template);\n    setShowPreview(true);\n  };\n\n  const TemplatePreview = ({ template }: { template: BotTemplate }) => {\n    console.log('👁️ TemplatePreview rendering for:', template.name);\n    console.log('📦 Template data received:', template.data);\n    const stats = getTemplateStats(template.data as BotData);\n    console.log('📈 Stats calculated:', stats);\n    \n    return (\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-lg font-semibold\">{template.name}</h3>\n          <Button size=\"sm\" onClick={() => setShowPreview(false)}>\n            Закрыть\n          </Button>\n        </div>\n        \n        {template.description && (\n          <p className=\"text-muted-foreground\">{template.description}</p>\n        )}\n        \n        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n          <div className=\"p-3 bg-muted dark:bg-muted/50 rounded-lg\">\n            <div className=\"font-medium\">Узлов</div>\n            <div className=\"text-2xl font-bold text-primary\">{stats.nodes}</div>\n          </div>\n          <div className=\"p-3 bg-muted dark:bg-muted/50 rounded-lg\">\n            <div className=\"font-medium\">Связей</div>\n            <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">{stats.connections}</div>\n          </div>\n          <div className=\"p-3 bg-muted dark:bg-muted/50 rounded-lg\">\n            <div className=\"font-medium\">Команд</div>\n            <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">{stats.commands}</div>\n          </div>\n          <div className=\"p-3 bg-muted dark:bg-muted/50 rounded-lg\">\n            <div className=\"font-medium\">Кнопок</div>\n            <div className=\"text-2xl font-bold text-purple-600 dark:text-purple-400\">{stats.buttons}</div>\n          </div>\n        </div>\n        \n        {template.tags && template.tags.length > 0 && (\n          <div>\n            <h4 className=\"font-medium mb-2\">Теги:</h4>\n            <div className=\"flex flex-wrap gap-2\">\n              {template.tags.map((tag) => (\n                <Badge key={tag} variant=\"secondary\">{tag}</Badge>\n              ))}\n            </div>\n          </div>\n        )}\n        \n        <div className=\"flex gap-2 pt-4\">\n          <Button onClick={() => handleUseTemplate(template)} className=\"flex-1\">\n            <Download className=\"h-4 w-4 mr-2\" />\n            Использовать шаблон\n          </Button>\n        </div>\n      </div>\n    );\n  };\n\n  interface TemplateGridProps {\n    templates: BotTemplate[];\n    isLoading: boolean;\n    onPreview: (template: BotTemplate) => void;\n    onUse: (template: BotTemplate) => void;\n    onRate: (template: BotTemplate, rating: number) => void;\n    onDelete?: (template: BotTemplate) => void;\n    searchTerm: string;\n    selectedCategory: string;\n    showDeleteButton?: boolean;\n  }\n\n  const TemplateGrid = ({ \n    templates, \n    isLoading, \n    onPreview, \n    onUse, \n    onRate, \n    onDelete, \n    searchTerm, \n    selectedCategory, \n    showDeleteButton = false \n  }: TemplateGridProps) => {\n    if (isLoading) {\n      return (\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"h-8 w-8 animate-spin\" />\n        </div>\n      );\n    }\n\n    if (templates.length === 0) {\n      return (\n        <div className=\"text-center py-8\">\n          <p className=\"text-muted-foreground\">\n            {searchTerm || selectedCategory !== 'all' \n              ? 'Шаблоны не найдены' \n              : 'Пока нет сохраненных шаблонов'}\n          </p>\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 py-4\">\n        {templates.map((template: BotTemplate) => {\n          console.log('🎫 Rendering template card for:', template.name);\n          console.log('🎫 Template data keys:', Object.keys(template.data || {}));\n          const stats = getTemplateStats(template.data as BotData);\n          console.log('🎫 Stats for', template.name, ':', stats);\n          \n          // Временный отладочный алерт для многолистового шаблона\n          if (template.name.includes('Многолистовой')) {\n            console.log('🚨 DEBUGGING MULTI-SHEET TEMPLATE');\n            console.log('🚨 Template data:', template.data);\n            console.log('🚨 Has sheets:', !!(template.data as any)?.sheets);\n            console.log('🚨 Stats calculated:', stats);\n            // Временный алерт для проверки\n            if (stats.nodes === 0) {\n              alert(`Многолистовой шаблон: nodes=${stats.nodes}, но в данных есть ${(template.data as any)?.sheets?.length || 0} листов`);\n            }\n          }\n          \n          return (\n            <Card key={template.id} className=\"hover:shadow-lg transition-all duration-200 border-border/50 hover:border-primary/20 dark:bg-card/50 dark:hover:bg-card/80\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <CardTitle className=\"text-base\">{template.name}</CardTitle>\n                      {template.featured === 1 && (\n                        <Crown className=\"h-4 w-4 text-yellow-500\" />\n                      )}\n                    </div>\n                    {template.description && (\n                      <CardDescription className=\"mt-1 line-clamp-2\">\n                        {template.description}\n                      </CardDescription>\n                    )}\n                  </div>\n                  <Badge variant={template.isPublic ? 'default' : 'secondary'}>\n                    {template.isPublic ? 'Публичный' : 'Личный'}\n                  </Badge>\n                </div>\n                \n                <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                  <div className=\"flex items-center gap-1\">\n                    <Star className=\"h-3 w-3 fill-current\" />\n                    <span>{template.rating || 0}</span>\n                    <span>({template.ratingCount || 0})</span>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <TrendingUp className=\"h-3 w-3\" />\n                    <span>{template.useCount || 0} исп.</span>\n                  </div>\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    {difficultyLabels[template.difficulty as keyof typeof difficultyLabels] || template.difficulty}\n                  </Badge>\n                </div>\n              </CardHeader>\n              \n              <CardContent className=\"space-y-3\">\n                <div className=\"grid grid-cols-4 gap-2 text-xs\">\n                  <div className=\"text-center p-2 bg-muted dark:bg-muted/30 rounded\">\n                    <div className=\"font-medium\">{stats.nodes}</div>\n                    <div className=\"text-muted-foreground\">узлов</div>\n                  </div>\n                  <div className=\"text-center p-2 bg-muted dark:bg-muted/30 rounded\">\n                    <div className=\"font-medium\">{stats.connections}</div>\n                    <div className=\"text-muted-foreground\">связей</div>\n                  </div>\n                  <div className=\"text-center p-2 bg-muted dark:bg-muted/30 rounded\">\n                    <div className=\"font-medium\">{stats.commands}</div>\n                    <div className=\"text-muted-foreground\">команд</div>\n                  </div>\n                  <div className=\"text-center p-2 bg-muted dark:bg-muted/30 rounded\">\n                    <div className=\"font-medium\">{stats.buttons}</div>\n                    <div className=\"text-muted-foreground\">кнопок</div>\n                  </div>\n                </div>\n\n                {/* Расширенная статистика */}\n                <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                  <div className=\"flex items-center gap-2 p-2 bg-muted/50 dark:bg-muted/20 rounded\">\n                    <Eye className=\"h-3 w-3 text-muted-foreground\" />\n                    <span className=\"font-medium\">{template.viewCount || 0}</span>\n                    <span className=\"text-muted-foreground\">просмотров</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 p-2 bg-muted/50 dark:bg-muted/20 rounded\">\n                    <Download className=\"h-3 w-3 text-muted-foreground\" />\n                    <span className=\"font-medium\">{template.downloadCount || 0}</span>\n                    <span className=\"text-muted-foreground\">скачиваний</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 p-2 bg-muted/50 dark:bg-muted/20 rounded\">\n                    <Heart className=\"h-3 w-3 text-muted-foreground\" />\n                    <span className=\"font-medium\">{template.likeCount || 0}</span>\n                    <span className=\"text-muted-foreground\">лайков</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 p-2 bg-muted/50 dark:bg-muted/20 rounded\">\n                    <Clock className=\"h-3 w-3 text-muted-foreground\" />\n                    <span className=\"font-medium\">{template.estimatedTime || 5}</span>\n                    <span className=\"text-muted-foreground\">мин.</span>\n                  </div>\n                </div>\n\n                {/* Дополнительные индикаторы */}\n                <div className=\"flex items-center gap-2 text-xs\">\n                  {template.requiresToken === 1 && (\n                    <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                      <Shield className=\"h-3 w-3\" />\n                      Токен\n                    </Badge>\n                  )}\n                  {template.language && template.language !== 'ru' && (\n                    <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                      <Globe className=\"h-3 w-3\" />\n                      {template.language.toUpperCase()}\n                    </Badge>\n                  )}\n                  <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                    <TrendingUp className=\"h-3 w-3\" />\n                    {template.complexity || 1}/10\n                  </Badge>\n                </div>\n                \n                {template.tags && template.tags.length > 0 && (\n                  <div className=\"flex flex-wrap gap-1\">\n                    {template.tags.slice(0, 3).map((tag) => (\n                      <Badge key={tag} variant=\"outline\" className=\"text-xs\">\n                        {tag}\n                      </Badge>\n                    ))}\n                    {template.tags.length > 3 && (\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        +{template.tags.length - 3}\n                      </Badge>\n                    )}\n                  </div>\n                )}\n                \n                <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                  <div className=\"flex items-center gap-1\">\n                    <Calendar className=\"h-3 w-3\" />\n                    {template.createdAt && format(new Date(template.createdAt), 'dd.MM.yyyy', { locale: ru })}\n                  </div>\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    {categories.find(c => c.value === template.category)?.label || template.category}\n                  </Badge>\n                </div>\n                \n                <div className=\"flex gap-2\">\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={() => onPreview(template)}\n                    className=\"flex-1\"\n                  >\n                    <Eye className=\"h-4 w-4 mr-1\" />\n                    Просмотр\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    onClick={() => onUse(template)}\n                    className=\"flex-1\"\n                  >\n                    <Download className=\"h-4 w-4 mr-1\" />\n                    Использовать\n                  </Button>\n                  {showDeleteButton && onDelete && template.category === 'custom' && (\n                    <Button\n                      size=\"sm\"\n                      variant=\"destructive\"\n                      onClick={() => onDelete(template)}\n                      className=\"px-2\"\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  )}\n                </div>\n\n                {/* Интерактивные действия */}\n                <div className=\"flex items-center justify-between pt-2 border-t\">\n                  <div className=\"flex items-center gap-2\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => likeTemplateMutation.mutate({ \n                        templateId: template.id, \n                        liked: true \n                      })}\n                      className=\"h-7 px-2\"\n                    >\n                      <Heart className=\"h-3 w-3 mr-1\" />\n                      <span className=\"text-xs\">{template.likeCount || 0}</span>\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => bookmarkTemplateMutation.mutate({ \n                        templateId: template.id, \n                        bookmarked: true \n                      })}\n                      className=\"h-7 px-2\"\n                    >\n                      <Bookmark className=\"h-3 w-3 mr-1\" />\n                      <span className=\"text-xs\">{template.bookmarkCount || 0}</span>\n                    </Button>\n                  </div>\n                  \n                  <div className=\"flex items-center gap-1\">\n                    <span className=\"text-xs text-muted-foreground mr-1\">Оценить:</span>\n                    {[1, 2, 3, 4, 5].map((rating) => (\n                      <button\n                        key={rating}\n                        onClick={() => onRate(template, rating)}\n                        className=\"text-muted-foreground hover:text-yellow-500 transition-colors\"\n                      >\n                        <Star className=\"h-3 w-3\" />\n                      </button>\n                    ))}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          );\n        })}\n      </div>\n    );\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col\">\n        <DialogHeader className=\"flex-shrink-0\">\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Sparkles className=\"h-5 w-5\" />\n            Шаблоны ботов\n          </DialogTitle>\n        </DialogHeader>\n\n        {showPreview && selectedTemplate ? (\n          <div className=\"flex-1 overflow-y-auto py-4 pr-2\">\n            <TemplatePreview template={selectedTemplate} />\n          </div>\n        ) : (\n          <Tabs value={currentTab} onValueChange={setCurrentTab} className=\"flex flex-col h-full min-h-0\">\n            <TabsList className=\"grid w-full grid-cols-4 flex-shrink-0\">\n              <TabsTrigger value=\"all\" className=\"flex items-center gap-2\">\n                <Filter className=\"h-4 w-4\" />\n                Все шаблоны\n              </TabsTrigger>\n              <TabsTrigger value=\"featured\" className=\"flex items-center gap-2\">\n                <Crown className=\"h-4 w-4\" />\n                Рекомендуемые\n              </TabsTrigger>\n              <TabsTrigger value=\"popular\" className=\"flex items-center gap-2\">\n                <TrendingUp className=\"h-4 w-4\" />\n                Популярные\n              </TabsTrigger>\n              <TabsTrigger value=\"my\" className=\"flex items-center gap-2\">\n                <User className=\"h-4 w-4\" />\n                Мои шаблоны\n              </TabsTrigger>\n            </TabsList>\n\n            <div className=\"space-y-4 py-4 border-b flex-shrink-0\">\n              <div className=\"flex gap-4\">\n                <div className=\"flex-1\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4\" />\n                    <Input\n                      placeholder=\"Поиск шаблонов...\"\n                      value={searchTerm}\n                      onChange={(e) => setSearchTerm(e.target.value)}\n                      className=\"pl-10\"\n                    />\n                  </div>\n                </div>\n                <div className=\"w-48\">\n                  <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Категория\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {categories.map((category) => (\n                        <SelectItem key={category.value} value={category.value}>\n                          {category.label}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"w-36\">\n                  <Select value={sortBy} onValueChange={(value: any) => setSortBy(value)}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"popular\">Популярность</SelectItem>\n                      <SelectItem value=\"rating\">Рейтинг</SelectItem>\n                      <SelectItem value=\"recent\">Новые</SelectItem>\n                      <SelectItem value=\"name\">По алфавиту</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"flex-1 min-h-0 overflow-hidden\">\n              <TabsContent value=\"all\" className=\"h-full overflow-y-auto pr-2 mt-0\">\n                <TemplateGrid \n                  templates={filteredAndSortedTemplates} \n                  isLoading={isLoading}\n                  onPreview={handlePreview}\n                  onUse={handleUseTemplate}\n                  onRate={handleRateTemplate}\n                  searchTerm={searchTerm}\n                  selectedCategory={selectedCategory}\n                />\n              </TabsContent>\n              \n              <TabsContent value=\"featured\" className=\"h-full overflow-y-auto pr-2 mt-0\">\n                <TemplateGrid \n                  templates={filteredAndSortedTemplates} \n                  isLoading={isLoadingFeatured}\n                  onPreview={handlePreview}\n                  onUse={handleUseTemplate}\n                  onRate={handleRateTemplate}\n                  searchTerm={searchTerm}\n                  selectedCategory={selectedCategory}\n                />\n              </TabsContent>\n              \n              <TabsContent value=\"popular\" className=\"h-full overflow-y-auto pr-2 mt-0\">\n                <TemplateGrid \n                  templates={filteredAndSortedTemplates} \n                  isLoading={isLoading}\n                  onPreview={handlePreview}\n                  onUse={handleUseTemplate}\n                  onRate={handleRateTemplate}\n                  searchTerm={searchTerm}\n                  selectedCategory={selectedCategory}\n                />\n              </TabsContent>\n              \n              <TabsContent value=\"my\" className=\"h-full overflow-y-auto pr-2 mt-0\">\n                <TemplateGrid \n                  templates={filteredAndSortedTemplates} \n                  isLoading={isLoadingMy}\n                  onPreview={handlePreview}\n                  onUse={handleUseTemplate}\n                  onRate={handleRateTemplate}\n                  onDelete={handleDeleteTemplate}\n                  searchTerm={searchTerm}\n                  selectedCategory={selectedCategory}\n                  showDeleteButton={true}\n                />\n              </TabsContent>\n            </div>\n          </Tabs>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n}","size_bytes":34094},"client/src/hooks/use-custom-layout.tsx":{"content":"import { useState, useCallback, useEffect } from 'react';\nimport { CustomLayoutConfig, LayoutElement } from '@/components/layout/custom-layout-editor';\n\nconst STORAGE_KEY = 'custom-layout-config';\n\nexport const useCustomLayout = (initialConfig?: CustomLayoutConfig) => {\n  const [config, setConfig] = useState<CustomLayoutConfig>(() => {\n    // Пытаемся загрузить конфигурацию из localStorage\n    if (typeof window !== 'undefined') {\n      const savedConfig = localStorage.getItem(STORAGE_KEY);\n      if (savedConfig) {\n        try {\n          const parsed = JSON.parse(savedConfig);\n          return {\n            ...parsed,\n            lastModified: new Date(parsed.lastModified)\n          };\n        } catch (error) {\n          console.warn('Failed to parse saved layout config:', error);\n        }\n      }\n    }\n    \n    return initialConfig || {\n      elements: [\n        {\n          id: 'header',\n          type: 'header',\n          name: 'Шапка',\n          position: 'top',\n          size: 8,\n          visible: true,\n          order: 1,\n          content: null\n        },\n        {\n          id: 'sidebar',\n          type: 'sidebar',\n          name: 'Боковая панель',\n          position: 'left',\n          size: 20,\n          visible: true,\n          order: 2,\n          content: null\n        },\n        {\n          id: 'canvas',\n          type: 'canvas',\n          name: 'Холст',\n          position: 'center',\n          size: 55,\n          visible: true,\n          order: 3,\n          content: null\n        },\n        {\n          id: 'properties',\n          type: 'properties',\n          name: 'Свойства',\n          position: 'right',\n          size: 25,\n          visible: true,\n          order: 4,\n          content: null\n        }\n      ],\n      gridSize: 10,\n      snapToGrid: true,\n      showGrid: false,\n      compactMode: false,\n      lastModified: new Date()\n    };\n  });\n\n  // Автоматическое сохранение в localStorage\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));\n    }\n  }, [config]);\n\n  const updateConfig = useCallback((newConfig: Partial<CustomLayoutConfig>) => {\n    setConfig(prev => ({\n      ...prev,\n      ...newConfig,\n      lastModified: new Date()\n    }));\n  }, []);\n\n  const updateElement = useCallback((elementId: string, updates: Partial<LayoutElement>) => {\n    setConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(element =>\n        element.id === elementId\n          ? { ...element, ...updates }\n          : element\n      ),\n      lastModified: new Date()\n    }));\n  }, []);\n\n  const moveElement = useCallback((elementId: string, newPosition: LayoutElement['position']) => {\n    updateElement(elementId, { position: newPosition });\n  }, [updateElement]);\n\n  const resizeElement = useCallback((elementId: string, newSize: number) => {\n    updateElement(elementId, { size: newSize });\n  }, [updateElement]);\n\n  const toggleElementVisibility = useCallback((elementId: string) => {\n    setConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(element =>\n        element.id === elementId\n          ? { ...element, visible: !element.visible }\n          : element\n      ),\n      lastModified: new Date()\n    }));\n  }, []);\n\n  const setElementVisibility = useCallback((elementId: string, visible: boolean) => {\n    updateElement(elementId, { visible });\n  }, [updateElement]);\n\n  const reorderElements = useCallback((elementIds: string[]) => {\n    setConfig(prev => ({\n      ...prev,\n      elements: prev.elements.map(element => {\n        const newOrder = elementIds.indexOf(element.id);\n        return newOrder !== -1 ? { ...element, order: newOrder + 1 } : element;\n      }),\n      lastModified: new Date()\n    }));\n  }, []);\n\n  const resetConfig = useCallback(() => {\n    const defaultConfig: CustomLayoutConfig = {\n      elements: [\n        {\n          id: 'header',\n          type: 'header',\n          name: 'Шапка',\n          position: 'top',\n          size: 8,\n          visible: true,\n          order: 1,\n          content: null\n        },\n        {\n          id: 'sidebar',\n          type: 'sidebar',\n          name: 'Боковая панель',\n          position: 'left',\n          size: 20,\n          visible: true,\n          order: 2,\n          content: null\n        },\n        {\n          id: 'canvas',\n          type: 'canvas',\n          name: 'Холст',\n          position: 'center',\n          size: 55,\n          visible: true,\n          order: 3,\n          content: null\n        },\n        {\n          id: 'properties',\n          type: 'properties',\n          name: 'Свойства',\n          position: 'right',\n          size: 25,\n          visible: true,\n          order: 4,\n          content: null\n        }\n      ],\n      gridSize: 10,\n      snapToGrid: true,\n      showGrid: false,\n      compactMode: false,\n      lastModified: new Date()\n    };\n    setConfig(defaultConfig);\n  }, []);\n\n  const loadPreset = useCallback((presetName: string) => {\n    const presets: Record<string, Partial<CustomLayoutConfig>> = {\n      'classic': {\n        elements: [\n          { id: 'header', position: 'top', size: 8, visible: true, order: 1 },\n          { id: 'sidebar', position: 'left', size: 20, visible: true, order: 2 },\n          { id: 'canvas', position: 'center', size: 55, visible: true, order: 3 },\n          { id: 'properties', position: 'right', size: 25, visible: true, order: 4 }\n        ]\n      },\n      'bottom-header': {\n        elements: [\n          { id: 'header', position: 'bottom', size: 8, visible: true, order: 4 },\n          { id: 'sidebar', position: 'left', size: 20, visible: true, order: 1 },\n          { id: 'canvas', position: 'center', size: 55, visible: true, order: 2 },\n          { id: 'properties', position: 'right', size: 25, visible: true, order: 3 }\n        ]\n      },\n      'minimal': {\n        elements: [\n          { id: 'header', position: 'top', size: 6, visible: true, order: 1 },\n          { id: 'sidebar', position: 'left', size: 15, visible: true, order: 2 },\n          { id: 'canvas', position: 'center', size: 70, visible: true, order: 3 },\n          { id: 'properties', position: 'right', size: 15, visible: true, order: 4 }\n        ]\n      },\n      'fullscreen': {\n        elements: [\n          { id: 'header', position: 'top', size: 5, visible: true, order: 1 },\n          { id: 'sidebar', position: 'left', size: 0, visible: false, order: 2 },\n          { id: 'canvas', position: 'center', size: 95, visible: true, order: 3 },\n          { id: 'properties', position: 'right', size: 0, visible: false, order: 4 }\n        ]\n      }\n    };\n\n    const preset = presets[presetName];\n    if (preset) {\n      setConfig(prev => ({\n        ...prev,\n        ...preset,\n        elements: prev.elements.map(element => {\n          const presetElement = preset.elements?.find(p => p.id === element.id);\n          return presetElement ? { ...element, ...presetElement } : element;\n        }),\n        lastModified: new Date()\n      }));\n    }\n  }, []);\n\n  const exportConfig = useCallback(() => {\n    return JSON.stringify(config, null, 2);\n  }, [config]);\n\n  const importConfig = useCallback((configString: string) => {\n    try {\n      const imported = JSON.parse(configString);\n      setConfig({\n        ...imported,\n        lastModified: new Date()\n      });\n      return true;\n    } catch (error) {\n      console.error('Failed to import config:', error);\n      return false;\n    }\n  }, []);\n\n  const getVisibleElements = useCallback(() => {\n    return config.elements.filter(element => element.visible);\n  }, [config.elements]);\n\n  const getElementByType = useCallback((type: LayoutElement['type']) => {\n    return config.elements.find(element => element.type === type);\n  }, [config.elements]);\n\n  const getElementsByPosition = useCallback((position: LayoutElement['position']) => {\n    return config.elements.filter(element => element.position === position && element.visible);\n  }, [config.elements]);\n\n  return {\n    config,\n    updateConfig,\n    updateElement,\n    moveElement,\n    resizeElement,\n    toggleElementVisibility,\n    setElementVisibility,\n    reorderElements,\n    resetConfig,\n    loadPreset,\n    exportConfig,\n    importConfig,\n    getVisibleElements,\n    getElementByType,\n    getElementsByPosition,\n    \n    // Утилиты\n    isElementVisible: (elementId: string) => {\n      const element = config.elements.find(e => e.id === elementId);\n      return element?.visible ?? false;\n    },\n    \n    getElementPosition: (elementId: string) => {\n      const element = config.elements.find(e => e.id === elementId);\n      return element?.position ?? 'center';\n    },\n    \n    getElementSize: (elementId: string) => {\n      const element = config.elements.find(e => e.id === elementId);\n      return element?.size ?? 50;\n    }\n  };\n};","size_bytes":8941},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/components/layout/adaptive-layout.tsx":{"content":"import { ReactNode, useMemo } from 'react';\nimport { ResizablePanelGroup, ResizablePanel, ResizableHandle } from '@/components/ui/resizable';\nimport { LayoutConfig } from './layout-manager';\n\ninterface AdaptiveLayoutProps {\n  config: LayoutConfig;\n  header: ReactNode;\n  sidebar: ReactNode;\n  canvas: ReactNode;\n  properties: ReactNode;\n  children?: ReactNode;\n}\n\nexport function AdaptiveLayout({\n  config,\n  header,\n  sidebar,\n  canvas,\n  properties,\n  children\n}: AdaptiveLayoutProps) {\n  \n  // Вычисляем CSS классы для контейнера на основе конфигурации\n  const containerClasses = useMemo(() => {\n    const classes = ['h-screen overflow-hidden bg-gray-50 dark:bg-gray-900'];\n    \n    if (config.compactMode) {\n      classes.push('text-sm');\n    }\n    \n    return classes.join(' ');\n  }, [config.compactMode]);\n\n  // Вычисляем размеры заголовка\n  const headerSize = useMemo(() => {\n    if (config.headerPosition === 'top' || config.headerPosition === 'bottom') {\n      return config.compactMode ? 48 : 64; // 3rem или 4rem\n    }\n    return config.compactMode ? 240 : 320; // 15rem или 20rem\n  }, [config.headerPosition, config.compactMode]);\n\n  // Функция для создания макета с заголовком сверху/снизу\n  const createVerticalLayout = () => {\n    const headerElement = (\n      <div \n        className={`${config.headerPosition === 'top' ? 'order-1' : 'order-3'} flex-shrink-0`}\n        style={{ height: `${headerSize}px` }}\n      >\n        {header}\n      </div>\n    );\n\n    const contentElement = (\n      <div className={`${config.headerPosition === 'top' ? 'order-2' : 'order-1'} flex-1 min-h-0`}>\n        {createHorizontalPanels()}\n      </div>\n    );\n\n    return (\n      <div className={`${containerClasses} flex flex-col`}>\n        {config.headerPosition === 'top' ? headerElement : contentElement}\n        {config.headerPosition === 'top' ? contentElement : headerElement}\n        {children}\n      </div>\n    );\n  };\n\n  // Функция для создания макета с заголовком слева/справа\n  const createHorizontalLayout = () => {\n    const headerElement = (\n      <div \n        className={`${config.headerPosition === 'left' ? 'order-1' : 'order-3'} flex-shrink-0`}\n        style={{ width: `${headerSize}px` }}\n      >\n        <div className=\"h-full flex flex-col\">\n          {header}\n        </div>\n      </div>\n    );\n\n    const contentElement = (\n      <div className={`${config.headerPosition === 'left' ? 'order-2' : 'order-1'} flex-1 min-w-0`}>\n        {createVerticalPanels()}\n      </div>\n    );\n\n    return (\n      <div className={`${containerClasses} flex`}>\n        {config.headerPosition === 'left' ? headerElement : contentElement}\n        {config.headerPosition === 'left' ? contentElement : headerElement}\n        {children}\n      </div>\n    );\n  };\n\n  // Создает горизонтальные панели (сайдбар | холст | свойства)\n  const createHorizontalPanels = () => {\n    const panels = [];\n    \n    // Определяем порядок панелей\n    if (config.sidebarPosition === 'left') {\n      panels.push(\n        <ResizablePanel \n          key=\"sidebar\"\n          defaultSize={config.panelSizes.sidebar} \n          minSize={10} \n          maxSize={40}\n          className=\"flex-shrink-0\"\n        >\n          {sidebar}\n        </ResizablePanel>\n      );\n      panels.push(<ResizableHandle key=\"handle1\" withHandle />);\n    }\n\n    if (config.propertiesPosition === 'left' && config.sidebarPosition === 'right') {\n      panels.push(\n        <ResizablePanel \n          key=\"properties-left\"\n          defaultSize={config.panelSizes.properties} \n          minSize={15} \n          maxSize={40}\n          className=\"flex-shrink-0\"\n        >\n          {properties}\n        </ResizablePanel>\n      );\n      panels.push(<ResizableHandle key=\"handle-prop-left\" withHandle />);\n    }\n\n    // Центральная панель холста\n    panels.push(\n      <ResizablePanel \n        key=\"canvas\"\n        defaultSize={config.panelSizes.canvas} \n        minSize={30}\n        className=\"flex-1\"\n      >\n        {config.canvasFullscreen ? (\n          <div className=\"h-full relative\">\n            {canvas}\n            <div className=\"absolute inset-0 pointer-events-none\">\n              {config.showGrid && (\n                <div className=\"absolute inset-0 opacity-10 bg-grid-small bg-grid-slate-200 dark:bg-grid-slate-800\" />\n              )}\n            </div>\n          </div>\n        ) : (\n          canvas\n        )}\n      </ResizablePanel>\n    );\n\n    if (config.propertiesPosition === 'right' || (config.propertiesPosition === 'left' && config.sidebarPosition === 'left')) {\n      panels.push(<ResizableHandle key=\"handle2\" withHandle />);\n      panels.push(\n        <ResizablePanel \n          key=\"properties-right\"\n          defaultSize={config.panelSizes.properties} \n          minSize={15} \n          maxSize={40}\n          className=\"flex-shrink-0\"\n        >\n          {properties}\n        </ResizablePanel>\n      );\n    }\n\n    if (config.sidebarPosition === 'right') {\n      panels.push(<ResizableHandle key=\"handle3\" withHandle />);\n      panels.push(\n        <ResizablePanel \n          key=\"sidebar-right\"\n          defaultSize={config.panelSizes.sidebar} \n          minSize={10} \n          maxSize={40}\n          className=\"flex-shrink-0\"\n        >\n          {sidebar}\n        </ResizablePanel>\n      );\n    }\n\n    return (\n      <ResizablePanelGroup direction=\"horizontal\" className=\"h-full\">\n        {panels}\n      </ResizablePanelGroup>\n    );\n  };\n\n  // Создает вертикальные панели (для горизонтального заголовка)\n  const createVerticalPanels = () => {\n    return (\n      <ResizablePanelGroup direction=\"vertical\" className=\"h-full\">\n        <ResizablePanel defaultSize={20} minSize={15} maxSize={35}>\n          {sidebar}\n        </ResizablePanel>\n        \n        <ResizableHandle withHandle />\n        \n        <ResizablePanel defaultSize={60} minSize={30}>\n          <ResizablePanelGroup direction=\"horizontal\">\n            <ResizablePanel defaultSize={75} minSize={50}>\n              {canvas}\n            </ResizablePanel>\n            <ResizableHandle withHandle />\n            <ResizablePanel defaultSize={25} minSize={20} maxSize={40}>\n              {properties}\n            </ResizablePanel>\n          </ResizablePanelGroup>\n        </ResizablePanel>\n      </ResizablePanelGroup>\n    );\n  };\n\n  // Главная логика выбора макета\n  if (config.headerPosition === 'top' || config.headerPosition === 'bottom') {\n    return createVerticalLayout();\n  } else {\n    return createHorizontalLayout();\n  }\n}","size_bytes":6815},"client/src/components/telegram-auth.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Badge } from '@/components/ui/badge';\nimport { Loader2, Phone, Shield, CheckCircle2, Lock } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\n\ninterface TelegramAuthProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onSuccess: () => void;\n}\n\ninterface AuthStatus {\n  isAuthenticated: boolean;\n  phoneNumber?: string;\n  userId?: string;\n  needsCode?: boolean;\n  needsPassword?: boolean;\n}\n\nexport function TelegramAuth({ open, onOpenChange, onSuccess }: TelegramAuthProps) {\n  const [step, setStep] = useState<'credentials' | 'phone' | 'code' | 'password'>('credentials');\n  const [apiId, setApiId] = useState('');\n  const [apiHash, setApiHash] = useState('');\n  const [phoneNumber, setPhoneNumber] = useState('');\n  const [phoneCode, setPhoneCode] = useState('');\n  const [phoneCodeHash, setPhoneCodeHash] = useState('');\n  const [password, setPassword] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const [authStatus, setAuthStatus] = useState<AuthStatus>({ isAuthenticated: false });\n  const { toast } = useToast();\n\n  // Проверяем статус авторизации при открытии\n  useEffect(() => {\n    if (open) {\n      checkAuthStatus();\n    }\n  }, [open]);\n\n  const checkAuthStatus = async () => {\n    try {\n      const response = await fetch('/api/telegram-auth/status');\n      const status = await response.json();\n      setAuthStatus(status);\n      \n      if (status.isAuthenticated) {\n        toast({\n          title: \"Уже авторизован\",\n          description: `Вы авторизованы как ${status.phoneNumber}`,\n        });\n        onSuccess();\n        onOpenChange(false);\n      } else if (status.hasCredentials) {\n        // Если credentials есть, переходим к телефону\n        setStep('phone');\n      } else {\n        // Если credentials нет, остаемся на шаге ввода credentials\n        setStep('credentials');\n      }\n    } catch (error) {\n      console.error('Ошибка проверки статуса:', error);\n    }\n  };\n\n  const saveCredentials = async () => {\n    if (!apiId.trim() || !apiHash.trim()) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Введите API ID и API Hash\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const response = await apiRequest('POST', '/api/telegram-auth/save-credentials', { \n        apiId: apiId.trim(), \n        apiHash: apiHash.trim() \n      });\n\n      if (response.success) {\n        setStep('phone');\n        toast({\n          title: \"Credentials сохранены\",\n          description: \"Теперь введите номер телефона\",\n        });\n      } else {\n        toast({\n          title: \"Ошибка сохранения\",\n          description: response.error || \"Неизвестная ошибка\",\n          variant: \"destructive\"\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Не удалось сохранить credentials\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const sendCode = async () => {\n    if (!phoneNumber.trim()) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Введите номер телефона\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const response = await apiRequest('POST', '/api/telegram-auth/send-code', { phoneNumber: phoneNumber.trim() });\n\n      if (response.success) {\n        setPhoneCodeHash(response.phoneCodeHash);\n        setStep('code');\n        toast({\n          title: \"Код отправлен\",\n          description: `Проверьте SMS на номере ${phoneNumber}`,\n        });\n      } else {\n        toast({\n          title: \"Ошибка отправки кода\",\n          description: response.error || \"Неизвестная ошибка\",\n          variant: \"destructive\"\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Не удалось отправить код\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const verifyCode = async () => {\n    if (!phoneCode.trim()) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Введите код подтверждения\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const response = await apiRequest('POST', '/api/telegram-auth/verify-code', {\n        phoneNumber: phoneNumber.trim(),\n        phoneCode: phoneCode.trim(),\n        phoneCodeHash\n      });\n\n      if (response.success) {\n        toast({\n          title: \"Авторизация успешна\",\n          description: \"Теперь вы можете просматривать всех участников группы\",\n        });\n        onSuccess();\n        onOpenChange(false);\n      } else if (response.needsPassword) {\n        setStep('password');\n        toast({\n          title: \"Требуется пароль 2FA\",\n          description: \"Введите пароль двухфакторной аутентификации\",\n        });\n      } else {\n        toast({\n          title: \"Ошибка авторизации\",\n          description: response.error || \"Неверный код\",\n          variant: \"destructive\"\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Не удалось проверить код\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const verifyPassword = async () => {\n    if (!password.trim()) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Введите пароль\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const response = await apiRequest('POST', '/api/telegram-auth/verify-password', {\n        password: password.trim()\n      });\n\n      if (response.success) {\n        toast({\n          title: \"Авторизация успешна\",\n          description: \"Двухфакторная аутентификация пройдена\",\n        });\n        onSuccess();\n        onOpenChange(false);\n      } else {\n        toast({\n          title: \"Ошибка авторизации\",\n          description: response.error || \"Неверный пароль\",\n          variant: \"destructive\"\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Ошибка\",\n        description: \"Не удалось проверить пароль\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent, action: () => void) => {\n    if (e.key === 'Enter' && !isLoading) {\n      action();\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-blue-600\" />\n            Авторизация Telegram Client API\n          </DialogTitle>\n          <DialogDescription>\n            Для получения полного списка участников группы необходима авторизация через ваш номер телефона\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {step === 'credentials' ? (\n            <>\n              <div className=\"text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n                <Shield className=\"h-8 w-8 text-blue-600 mx-auto mb-2\" />\n                <p className=\"text-sm text-blue-700 dark:text-blue-300\">\n                  Введите API credentials для подключения к Telegram\n                </p>\n              </div>\n\n              <div className=\"space-y-3\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"apiId\">API ID</Label>\n                  <Input\n                    id=\"apiId\"\n                    placeholder=\"12345678\"\n                    value={apiId}\n                    onChange={(e) => setApiId(e.target.value)}\n                    onKeyPress={(e) => handleKeyPress(e, saveCredentials)}\n                    disabled={isLoading}\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Получите на my.telegram.org в разделе API Development Tools\n                  </p>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"apiHash\">API Hash</Label>\n                  <Input\n                    id=\"apiHash\"\n                    placeholder=\"abcdef1234567890abcdef1234567890\"\n                    value={apiHash}\n                    onChange={(e) => setApiHash(e.target.value)}\n                    onKeyPress={(e) => handleKeyPress(e, saveCredentials)}\n                    disabled={isLoading}\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    32-символьная строка из my.telegram.org\n                  </p>\n                </div>\n              </div>\n\n              <Button \n                onClick={saveCredentials} \n                disabled={isLoading || !apiId.trim() || !apiHash.trim()}\n                className=\"w-full\"\n              >\n                {isLoading ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Сохраняем...\n                  </>\n                ) : (\n                  'Сохранить credentials'\n                )}\n              </Button>\n            </>\n          ) : step === 'phone' ? (\n            <>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"phone\">Номер телефона</Label>\n                <div className=\"flex items-center space-x-2\">\n                  <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    id=\"phone\"\n                    placeholder=\"+7 xxx xxx xxxx\"\n                    value={phoneNumber}\n                    onChange={(e) => setPhoneNumber(e.target.value)}\n                    onKeyPress={(e) => handleKeyPress(e, sendCode)}\n                    disabled={isLoading}\n                  />\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Введите номер в международном формате\n                </p>\n              </div>\n\n              <Button \n                onClick={sendCode} \n                disabled={isLoading || !phoneNumber.trim()}\n                className=\"w-full\"\n              >\n                {isLoading ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Отправляем код...\n                  </>\n                ) : (\n                  'Отправить код'\n                )}\n              </Button>\n            </>\n          ) : step === 'code' ? (\n            <>\n              <div className=\"text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg\">\n                <CheckCircle2 className=\"h-8 w-8 text-green-600 mx-auto mb-2\" />\n                <p className=\"text-sm text-green-700 dark:text-green-300\">\n                  Код отправлен на номер <Badge variant=\"outline\">{phoneNumber}</Badge>\n                </p>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"code\">Код подтверждения</Label>\n                <Input\n                  id=\"code\"\n                  placeholder=\"12345\"\n                  value={phoneCode}\n                  onChange={(e) => setPhoneCode(e.target.value)}\n                  onKeyPress={(e) => handleKeyPress(e, verifyCode)}\n                  disabled={isLoading}\n                  maxLength={5}\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Введите 5-значный код из SMS\n                </p>\n              </div>\n\n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setStep('phone')}\n                  disabled={isLoading}\n                  className=\"flex-1\"\n                >\n                  Назад\n                </Button>\n                <Button \n                  onClick={verifyCode} \n                  disabled={isLoading || !phoneCode.trim()}\n                  className=\"flex-1\"\n                >\n                  {isLoading ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Проверяем...\n                    </>\n                  ) : (\n                    'Подтвердить'\n                  )}\n                </Button>\n              </div>\n            </>\n          ) : (\n            <>\n              <div className=\"text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n                <Lock className=\"h-8 w-8 text-blue-600 mx-auto mb-2\" />\n                <p className=\"text-sm text-blue-700 dark:text-blue-300\">\n                  Требуется пароль двухфакторной аутентификации\n                </p>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"password\">Пароль 2FA</Label>\n                <div className=\"flex items-center space-x-2\">\n                  <Lock className=\"h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    id=\"password\"\n                    type=\"password\"\n                    placeholder=\"Введите пароль\"\n                    value={password}\n                    onChange={(e) => setPassword(e.target.value)}\n                    onKeyPress={(e) => handleKeyPress(e, verifyPassword)}\n                    disabled={isLoading}\n                  />\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Введите пароль, установленный в настройках безопасности Telegram\n                </p>\n              </div>\n\n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setStep('code')}\n                  disabled={isLoading}\n                  className=\"flex-1\"\n                >\n                  Назад\n                </Button>\n                <Button \n                  onClick={verifyPassword} \n                  disabled={isLoading || !password.trim()}\n                  className=\"flex-1\"\n                >\n                  {isLoading ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Авторизуемся...\n                    </>\n                  ) : (\n                    'Подтвердить'\n                  )}\n                </Button>\n              </div>\n            </>\n          )}\n\n          <div className=\"text-xs text-muted-foreground space-y-1\">\n            <p>• После авторизации вы сможете просматривать всех участников групп</p>\n            <p>• Данные авторизации сохраняются в сессии</p>\n            <p>• Используется официальный Telegram Client API</p>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","size_bytes":16291},"client/src/components/layout/drag-drop-test-button.tsx":{"content":"import { Button } from '@/components/ui/button';\nimport { Move } from 'lucide-react';\n\ninterface DragDropTestButtonProps {\n  onOpenCustomizer: () => void;\n}\n\nexport const DragDropTestButton: React.FC<DragDropTestButtonProps> = ({ onOpenCustomizer }) => {\n  return (\n    <div className=\"p-4 border-t border-gray-200 dark:border-gray-700\">\n      <Button \n        variant=\"outline\" \n        size=\"sm\" \n        onClick={onOpenCustomizer}\n        className=\"w-full flex items-center gap-2\"\n      >\n        <Move className=\"w-4 h-4\" />\n        Перетащить элементы\n      </Button>\n    </div>\n  );\n};","size_bytes":610},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/editor/canvas.tsx":{"content":"import { useRef, useCallback, useState, useEffect } from 'react';\nimport { CanvasNode } from '@/components/ui/canvas-node';\nimport { ConnectionsLayer } from '@/components/ui/connections-layer';\nimport { TemporaryConnection } from '@/components/ui/temporary-connection';\nimport { ConnectionSuggestions } from '@/components/ui/connection-suggestions';\nimport { AutoConnectionPanel } from '@/components/ui/auto-connection-panel';\nimport { CanvasSheets } from '@/components/ui/canvas-sheets';\nimport { Button } from '@/components/ui/button';\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';\nimport { Navigation, Sidebar, Sliders, Monitor, Menu } from 'lucide-react';\nimport { useIsMobile } from '@/hooks/use-mobile';\n\nimport { Node, ComponentDefinition, Connection } from '@/types/bot';\nimport { BotDataWithSheets, CanvasSheet } from '@shared/schema';\nimport { generateAutoConnections } from '@/utils/auto-connection';\nimport { ConnectionManager } from '@/utils/connection-manager';\nimport { SheetsManager } from '@/utils/sheets-manager';\nimport { nanoid } from 'nanoid';\n\ninterface CanvasProps {\n  // Новая система листов (опциональные для совместимости)\n  botData?: BotDataWithSheets;\n  onBotDataUpdate?: (data: BotDataWithSheets) => void;\n  \n  // Существующие пропсы для совместимости\n  nodes: Node[];\n  connections: Connection[];\n  selectedNodeId: string | null;\n  selectedConnectionId?: string;\n  onNodeSelect: (nodeId: string) => void;\n  onNodeAdd: (node: Node) => void;\n  onNodeDelete: (nodeId: string) => void;\n  onNodeDuplicate?: (nodeId: string) => void;\n  onNodeMove: (nodeId: string, position: { x: number; y: number }) => void;\n  onConnectionSelect?: (connectionId: string) => void;\n  onConnectionDelete?: (connectionId: string) => void;\n  onConnectionAdd?: (connection: Connection) => void;\n  onNodesUpdate?: (nodes: Node[]) => void;\n  onUndo?: () => void;\n  onRedo?: () => void;\n  canUndo?: boolean;\n  canRedo?: boolean;\n  onSave?: () => void;\n  isSaving?: boolean;\n  onCopyToClipboard?: (nodeIds: string[]) => void;\n  onPasteFromClipboard?: () => void;\n  hasClipboardData?: boolean;\n  \n  // Глобальное состояние перетаскивания узлов\n  isNodeBeingDragged?: boolean;\n  setIsNodeBeingDragged?: (isDragging: boolean) => void;\n  \n  // Кнопки управления интерфейсом\n  onToggleHeader?: () => void;\n  onToggleSidebar?: () => void;\n  onToggleProperties?: () => void;\n  onToggleCanvas?: () => void;\n  headerVisible?: boolean;\n  sidebarVisible?: boolean;\n  propertiesVisible?: boolean;\n  canvasVisible?: boolean;\n  \n  // Мобильные функции\n  onOpenMobileSidebar?: () => void;\n  onOpenMobileProperties?: () => void;\n  \n  // Передача размеров узлов для иерархического макета\n  onNodeSizesChange?: (nodeSizes: Map<string, { width: number; height: number }>) => void;\n}\n\nexport function Canvas({ \n  botData,\n  onBotDataUpdate,\n  nodes, \n  connections,\n  selectedNodeId,\n  selectedConnectionId,\n  onNodeSelect, \n  onNodeAdd, \n  onNodeDelete,\n  onNodeDuplicate,\n  onNodeMove,\n  onConnectionSelect,\n  onConnectionDelete,\n  onConnectionAdd,\n  onNodesUpdate,\n  onUndo,\n  onRedo,\n  canUndo,\n  canRedo,\n  onSave,\n  isSaving,\n  onCopyToClipboard,\n  onPasteFromClipboard,\n  hasClipboardData,\n  isNodeBeingDragged,\n  setIsNodeBeingDragged,\n  onToggleHeader,\n  onToggleSidebar,\n  onToggleProperties,\n  onToggleCanvas,\n  headerVisible,\n  sidebarVisible,\n  propertiesVisible,\n  canvasVisible,\n  onOpenMobileSidebar,\n  onOpenMobileProperties,\n  onNodeSizesChange\n}: CanvasProps) {\n  const canvasRef = useRef<HTMLDivElement>(null);\n  const isMobile = useIsMobile();\n  const [isDragOver, setIsDragOver] = useState(false);\n  const [connectionStart, setConnectionStart] = useState<{\n    nodeId: string;\n    handle: 'source' | 'target';\n  } | null>(null);\n  const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });\n  const [showSuggestions, setShowSuggestions] = useState(false);\n  const [autoButtonCreation, setAutoButtonCreation] = useState(true);\n  const [showAutoPanel, setShowAutoPanel] = useState(false);\n  const [zoom, setZoom] = useState(100);\n  const [pan, setPan] = useState({ x: 0, y: 0 });\n  const [isPanning, setIsPanning] = useState(false);\n  const [panStart, setPanStart] = useState({ x: 0, y: 0 });\n  const [lastPanPosition, setLastPanPosition] = useState({ x: 0, y: 0 });\n  \n  // Touch состояние для мобильного управления\n  const [isTouchPanning, setIsTouchPanning] = useState(false);\n  const [touchStart, setTouchStart] = useState({ x: 0, y: 0 });\n  const [lastTouchPosition, setLastTouchPosition] = useState({ x: 0, y: 0 });\n  const [lastPinchDistance, setLastPinchDistance] = useState(0);\n  const [initialPinchZoom, setInitialPinchZoom] = useState(100);\n  \n  // Состояние для хранения реальных размеров узлов\n  const [nodeSizes, setNodeSizes] = useState<Map<string, { width: number; height: number }>>(new Map());\n\n  // Обработчик изменения размеров узлов\n  const handleNodeSizeChange = useCallback((nodeId: string, size: { width: number; height: number }) => {\n    setNodeSizes(prev => {\n      const newMap = new Map(prev);\n      newMap.set(nodeId, size);\n      return newMap;\n    });\n  }, []);\n\n  // Отдельный эффект для передачи размеров в родительский компонент\n  useEffect(() => {\n    if (onNodeSizesChange && nodeSizes.size > 0) {\n      onNodeSizesChange(nodeSizes);\n    }\n  }, [nodeSizes, onNodeSizesChange]);\n\n  // Убираем автоматический layout при изменении nodeSizes - он был слишком агрессивным\n  // Автоиерархия должна работать только при загрузке шаблонов, а не постоянно\n\n  // Получение активного листа (с fallback'ом для совместимости)\n  const activeSheet = botData ? SheetsManager.getActiveSheet(botData) : null;\n\n  // Обработчики для работы с листами\n  const handleSheetSelect = useCallback((sheetId: string) => {\n    if (!botData || !onBotDataUpdate) return;\n    \n    // ВАЖНО: Сначала сохраняем текущее состояние редактора в активный лист\n    let dataWithCurrentSheetSaved = botData;\n    if (botData.activeSheetId) {\n      dataWithCurrentSheetSaved = SheetsManager.updateSheetData(\n        botData, \n        botData.activeSheetId, \n        nodes, \n        connections\n      );\n    }\n    \n    // Затем переключаемся на новый лист\n    const updatedData = SheetsManager.setActiveSheet(dataWithCurrentSheetSaved, sheetId);\n    onBotDataUpdate(updatedData);\n  }, [botData, onBotDataUpdate, nodes, connections]);\n\n  const handleSheetAdd = useCallback((name: string) => {\n    if (!botData || !onBotDataUpdate) return;\n    \n    // Сохраняем текущее состояние перед добавлением нового листа\n    let dataWithCurrentSheetSaved = botData;\n    if (botData.activeSheetId) {\n      dataWithCurrentSheetSaved = SheetsManager.updateSheetData(\n        botData, \n        botData.activeSheetId, \n        nodes, \n        connections\n      );\n    }\n    \n    const updatedData = SheetsManager.addSheet(dataWithCurrentSheetSaved, name);\n    onBotDataUpdate(updatedData);\n  }, [botData, onBotDataUpdate, nodes, connections]);\n\n  const handleSheetDelete = useCallback((sheetId: string) => {\n    if (!botData || !onBotDataUpdate) return;\n    try {\n      const updatedData = SheetsManager.deleteSheet(botData, sheetId);\n      onBotDataUpdate(updatedData);\n    } catch (error) {\n      console.error('Ошибка удаления листа:', error);\n    }\n  }, [botData, onBotDataUpdate]);\n\n  const handleSheetRename = useCallback((sheetId: string, newName: string) => {\n    if (!botData || !onBotDataUpdate) return;\n    const updatedData = SheetsManager.renameSheet(botData, sheetId, newName);\n    onBotDataUpdate(updatedData);\n  }, [botData, onBotDataUpdate]);\n\n  const handleSheetDuplicate = useCallback((sheetId: string) => {\n    if (!botData || !onBotDataUpdate) return;\n    try {\n      // Сохраняем текущее состояние перед дублированием\n      let dataWithCurrentSheetSaved = botData;\n      if (botData.activeSheetId) {\n        dataWithCurrentSheetSaved = SheetsManager.updateSheetData(\n          botData, \n          botData.activeSheetId, \n          nodes, \n          connections\n        );\n      }\n      \n      const updatedData = SheetsManager.duplicateSheetInProject(dataWithCurrentSheetSaved, sheetId);\n      onBotDataUpdate(updatedData);\n    } catch (error) {\n      console.error('Ошибка дублирования листа:', error);\n    }\n  }, [botData, onBotDataUpdate, nodes, connections]);\n\n  // Zoom utility functions\n  const zoomIn = useCallback(() => {\n    setZoom(prev => Math.min(prev + 25, 200));\n  }, []);\n\n  const zoomOut = useCallback(() => {\n    setZoom(prev => Math.max(prev - 25, 1));\n  }, []);\n\n  const resetZoom = useCallback(() => {\n    setZoom(100);\n    setPan({ x: 0, y: 0 });\n  }, []);\n\n  const setZoomLevel = useCallback((level: number) => {\n    setZoom(Math.max(Math.min(level, 200), 1));\n  }, []);\n\n  // Функция для получения центральной позиции видимой области canvas\n  const getCenterPosition = useCallback(() => {\n    if (canvasRef.current) {\n      const scrollContainer = canvasRef.current.parentElement;\n      const containerWidth = scrollContainer ? scrollContainer.clientWidth - 64 : window.innerWidth - 64;\n      const containerHeight = scrollContainer ? scrollContainer.clientHeight - 64 : window.innerHeight - 64;\n      \n      // Вычисляем центр в координатах canvas (с учетом текущего pan и zoom)\n      const centerX = (containerWidth / 2 - pan.x) / (zoom / 100);\n      const centerY = (containerHeight / 2 - pan.y) / (zoom / 100);\n      \n      const position = { \n        x: Math.max(50, centerX - 160), // -160 чтобы центрировать узел (половина ширины узла)\n        y: Math.max(50, centerY - 50)   // -50 чтобы центрировать узел (половина высоты узла)\n      };\n      \n      console.log('getCenterPosition:', { containerWidth, containerHeight, pan, zoom, centerX, centerY, position });\n      return position;\n    }\n    console.log('getCenterPosition: using fallback');\n    return { x: 400, y: 300 }; // fallback если canvas не найден\n  }, [pan, zoom]);\n\n  const fitToContent = useCallback(() => {\n    if (nodes.length === 0) return;\n    \n    // Вычисляем границы всех узлов\n    const nodeBounds = nodes.reduce((bounds, node) => {\n      const left = node.position.x;\n      const right = node.position.x + 320; // Approximate node width\n      const top = node.position.y;\n      const bottom = node.position.y + 100; // Approximate node height\n      \n      return {\n        left: Math.min(bounds.left, left),\n        right: Math.max(bounds.right, right),\n        top: Math.min(bounds.top, top),\n        bottom: Math.max(bounds.bottom, bottom)\n      };\n    }, { left: Infinity, right: -Infinity, top: Infinity, bottom: -Infinity });\n    \n    // Проверяем валидность границ\n    if (!isFinite(nodeBounds.left) || !isFinite(nodeBounds.right) || \n        !isFinite(nodeBounds.top) || !isFinite(nodeBounds.bottom)) {\n      return;\n    }\n    \n    const contentWidth = nodeBounds.right - nodeBounds.left;\n    const contentHeight = nodeBounds.bottom - nodeBounds.top;\n    \n    // Проверяем размеры контента\n    if (contentWidth <= 0 || contentHeight <= 0) {\n      return;\n    }\n    \n    if (canvasRef.current) {\n      // Получаем размеры видимой области (родительского контейнера с overflow)\n      const scrollContainer = canvasRef.current.parentElement;\n      const containerWidth = scrollContainer ? scrollContainer.clientWidth - 64 : window.innerWidth - 64; // -64 для padding\n      const containerHeight = scrollContainer ? scrollContainer.clientHeight - 64 : window.innerHeight - 64;\n      \n      // Проверяем размеры контейнера\n      if (containerWidth <= 0 || containerHeight <= 0) {\n        return;\n      }\n      \n      // Вычисляем масштаб с отступами\n      const scaleX = (containerWidth * 0.8) / contentWidth;\n      const scaleY = (containerHeight * 0.8) / contentHeight;\n      const scale = Math.min(scaleX, scaleY, 1.5); // Ограничиваем max zoom до 150%\n      \n      // Ограничиваем zoom разумными пределами\n      const newZoom = Math.max(Math.min(scale * 100, 150), 50); // min 50%, max 150%\n      \n      // Вычисляем центр контента\n      const centerX = (nodeBounds.left + nodeBounds.right) / 2;\n      const centerY = (nodeBounds.top + nodeBounds.bottom) / 2;\n      const containerCenterX = containerWidth / 2;\n      const containerCenterY = containerHeight / 2;\n      \n      // Вычисляем новые значения pan\n      const newPanX = containerCenterX - centerX * (newZoom / 100);\n      const newPanY = containerCenterY - centerY * (newZoom / 100);\n      \n      // Проверяем валидность pan значений\n      if (!isFinite(newPanX) || !isFinite(newPanY)) {\n        return;\n      }\n      \n      // Применяем изменения\n      setZoom(newZoom);\n      setPan({\n        x: newPanX,\n        y: newPanY\n      });\n    }\n  }, [nodes]);\n\n  // Handle wheel zoom\n  const handleWheel = useCallback((e: React.WheelEvent) => {\n    if (e.ctrlKey || e.metaKey) {\n      e.preventDefault();\n      const delta = e.deltaY;\n      const zoomFactor = delta > 0 ? 0.9 : 1.1;\n      \n      const rect = canvasRef.current?.getBoundingClientRect();\n      if (rect) {\n        const mouseX = e.clientX - rect.left;\n        const mouseY = e.clientY - rect.top;\n        \n        const newZoom = Math.max(Math.min(zoom * zoomFactor, 200), 1);\n        const zoomRatio = newZoom / zoom;\n        \n        setPan(prev => ({\n          x: mouseX - (mouseX - prev.x) * zoomRatio,\n          y: mouseY - (mouseY - prev.y) * zoomRatio\n        }));\n        \n        setZoom(newZoom);\n      }\n    }\n  }, [zoom]);\n\n  // Handle panning\n  const handleMouseDown = useCallback((e: React.MouseEvent) => {\n    // Check if click is on empty canvas (not on a node)\n    const target = e.target as HTMLElement;\n    const isEmptyCanvas = target.classList.contains('canvas-grid-modern') || \n                          target.closest('.canvas-grid-modern') === target;\n    \n    if (e.button === 1 || e.button === 2 || (e.button === 0 && e.altKey) || \n        (e.button === 0 && isEmptyCanvas)) { // Middle mouse, right mouse, Alt+click, or left-click on empty canvas\n      e.preventDefault();\n      setIsPanning(true);\n      setPanStart({ x: e.clientX, y: e.clientY });\n      setLastPanPosition(pan);\n    }\n  }, [pan]);\n\n  const handleMouseMove = useCallback((e: React.MouseEvent) => {\n    if (isPanning) {\n      const deltaX = e.clientX - panStart.x;\n      const deltaY = e.clientY - panStart.y;\n      \n      setPan({\n        x: lastPanPosition.x + deltaX,\n        y: lastPanPosition.y + deltaY\n      });\n    }\n  }, [isPanning, panStart, lastPanPosition]);\n\n  const handleMouseUp = useCallback(() => {\n    setIsPanning(false);\n  }, []);\n\n  // Вспомогательная функция для расчета расстояния между двумя точками touch\n  const getTouchDistance = (touches: React.TouchList) => {\n    if (touches.length < 2) return 0;\n    const touch1 = touches[0];\n    const touch2 = touches[1];\n    const dx = touch2.clientX - touch1.clientX;\n    const dy = touch2.clientY - touch1.clientY;\n    return Math.sqrt(dx * dx + dy * dy);\n  };\n\n  // Получение центра между двумя касаниями\n  const getTouchCenter = (touches: React.TouchList) => {\n    if (touches.length < 2) return { x: touches[0].clientX, y: touches[0].clientY };\n    return {\n      x: (touches[0].clientX + touches[1].clientX) / 2,\n      y: (touches[0].clientY + touches[1].clientY) / 2\n    };\n  };\n\n  // Обработка touch событий для мобильного управления\n  const handleTouchStart = useCallback((e: React.TouchEvent) => {\n    // Проверяем, не происходит ли касание на узле или перетаскивается ли уже узел\n    const target = e.target as HTMLElement;\n    const isOnNode = target.closest('[data-canvas-node]');\n    \n    // Если касание на узле или уже перетаскивается узел, не начинаем панорамирование холста\n    if (isOnNode || isNodeBeingDragged) {\n      return;\n    }\n    \n    // Предотвращаем default действия браузера\n    e.preventDefault();\n    \n    const touches = e.touches;\n    \n    if (touches.length === 1) {\n      // Одно касание - панорамирование\n      const touch = touches[0];\n      setIsTouchPanning(true);\n      setTouchStart({ x: touch.clientX, y: touch.clientY });\n      setLastTouchPosition(pan);\n    } else if (touches.length === 2) {\n      // Два касания - масштабирование\n      const distance = getTouchDistance(touches);\n      setLastPinchDistance(distance);\n      setInitialPinchZoom(zoom);\n      setIsTouchPanning(false); // Отключаем панорамирование при pinch\n    }\n  }, [pan, zoom, isNodeBeingDragged]);\n\n  const handleTouchMove = useCallback((e: React.TouchEvent) => {\n    // Проверяем, не происходит ли касание на узле или перетаскивается ли узел\n    const target = e.target as HTMLElement;\n    const isOnNode = target.closest('[data-canvas-node]');\n    \n    // Если касание на узле или перетаскивается узел, не панорамируем холст\n    if (isOnNode || isNodeBeingDragged) {\n      return;\n    }\n    \n    e.preventDefault();\n    \n    const touches = e.touches;\n    \n    if (touches.length === 1 && isTouchPanning) {\n      // Панорамирование одним пальцем\n      const touch = touches[0];\n      const deltaX = touch.clientX - touchStart.x;\n      const deltaY = touch.clientY - touchStart.y;\n      \n      setPan({\n        x: lastTouchPosition.x + deltaX,\n        y: lastTouchPosition.y + deltaY\n      });\n    } else if (touches.length === 2) {\n      // Pinch zoom двумя пальцами\n      const currentDistance = getTouchDistance(touches);\n      const center = getTouchCenter(touches);\n      \n      if (lastPinchDistance > 0) {\n        const scaleFactor = currentDistance / lastPinchDistance;\n        const newZoom = Math.max(Math.min(initialPinchZoom * scaleFactor, 200), 10);\n        \n        // Масштабирование относительно центра касания\n        const rect = canvasRef.current?.getBoundingClientRect();\n        if (rect) {\n          const centerX = center.x - rect.left;\n          const centerY = center.y - rect.top;\n          \n          const zoomRatio = newZoom / zoom;\n          \n          setPan(prev => ({\n            x: centerX - (centerX - prev.x) * zoomRatio,\n            y: centerY - (centerY - prev.y) * zoomRatio\n          }));\n          \n          setZoom(newZoom);\n        }\n      }\n    }\n  }, [isTouchPanning, touchStart, lastTouchPosition, lastPinchDistance, initialPinchZoom, zoom, isNodeBeingDragged]);\n\n  const handleTouchEnd = useCallback((e: React.TouchEvent) => {\n    e.preventDefault();\n    \n    if (e.touches.length === 0) {\n      // Все касания завершены\n      setIsTouchPanning(false);\n      setLastPinchDistance(0);\n    } else if (e.touches.length === 1) {\n      // Осталось одно касание - возможно продолжение панорамирования\n      const touch = e.touches[0];\n      setTouchStart({ x: touch.clientX, y: touch.clientY });\n      setLastTouchPosition(pan);\n      setIsTouchPanning(true);\n      setLastPinchDistance(0);\n    }\n  }, [pan]);\n\n  // Prevent context menu on right-click when using for panning\n  const handleContextMenu = useCallback((e: React.MouseEvent) => {\n    e.preventDefault();\n  }, []);\n\n  // Handle keyboard shortcuts\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Проверяем, что фокус не находится на input или textarea\n      const target = e.target as HTMLElement;\n      const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.contentEditable === 'true';\n      \n      if (!isInputField) {\n        // Обработка клавиши Delete для удаления выбранного узла\n        if (e.key === 'Delete' && selectedNodeId && onNodeDelete) {\n          e.preventDefault();\n          onNodeDelete(selectedNodeId);\n          return;\n        }\n      }\n\n      if (e.ctrlKey || e.metaKey) {\n        switch (e.key) {\n          case '=':\n          case '+':\n            e.preventDefault();\n            zoomIn();\n            break;\n          case '-':\n            e.preventDefault();\n            zoomOut();\n            break;\n          case '0':\n            e.preventDefault();\n            resetZoom();\n            break;\n          case '1':\n            e.preventDefault();\n            fitToContent();\n            break;\n          case 'z':\n            e.preventDefault();\n            if (e.shiftKey && onRedo && canRedo) {\n              onRedo();\n            } else if (onUndo && canUndo) {\n              onUndo();\n            }\n            break;\n          case 'y':\n            e.preventDefault();\n            if (onRedo && canRedo) {\n              onRedo();\n            }\n            break;\n          case 's':\n            e.preventDefault();\n            if (onSave && !isSaving) {\n              onSave();\n            }\n            break;\n          case 'c':\n            e.preventDefault();\n            if (e.shiftKey && selectedNodeId && onCopyToClipboard) {\n              // Shift+Ctrl+C - копировать в межпроектный буфер обмена\n              onCopyToClipboard([selectedNodeId]);\n            } else if (selectedNodeId && onNodeDuplicate) {\n              // Ctrl+C - дублировать в текущем проекте\n              onNodeDuplicate(selectedNodeId);\n            }\n            break;\n          case 'd':\n            e.preventDefault();\n            if (selectedNodeId && onNodeDuplicate) {\n              onNodeDuplicate(selectedNodeId);\n            }\n            break;\n          case 'v':\n            e.preventDefault();\n            if (e.shiftKey && onPasteFromClipboard) {\n              // Shift+Ctrl+V - вставить из межпроектного буфера обмена\n              onPasteFromClipboard();\n            }\n            break;\n        }\n      }\n    };\n\n    document.addEventListener('keydown', handleKeyDown);\n    return () => document.removeEventListener('keydown', handleKeyDown);\n  }, [zoomIn, zoomOut, resetZoom, fitToContent, onUndo, onRedo, canUndo, canRedo, onSave, isSaving, selectedNodeId, onNodeDelete, onNodeDuplicate]);\n\n\n\n  // Handle mouse events for panning\n  useEffect(() => {\n    const handleGlobalMouseMove = (e: MouseEvent) => {\n      if (isPanning) {\n        const deltaX = e.clientX - panStart.x;\n        const deltaY = e.clientY - panStart.y;\n        \n        setPan({\n          x: lastPanPosition.x + deltaX,\n          y: lastPanPosition.y + deltaY\n        });\n      }\n    };\n\n    const handleGlobalMouseUp = () => {\n      setIsPanning(false);\n    };\n\n    if (isPanning) {\n      document.addEventListener('mousemove', handleGlobalMouseMove);\n      document.addEventListener('mouseup', handleGlobalMouseUp);\n    }\n\n    return () => {\n      document.removeEventListener('mousemove', handleGlobalMouseMove);\n      document.removeEventListener('mouseup', handleGlobalMouseUp);\n    };\n  }, [isPanning, panStart, lastPanPosition]);\n\n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n    \n    const componentData = e.dataTransfer.getData('application/json');\n    if (!componentData) return;\n    \n    const component: ComponentDefinition = JSON.parse(componentData);\n    const rect = canvasRef.current?.getBoundingClientRect();\n    \n    let nodePosition;\n    \n    if (rect) {\n      // Transform screen coordinates to canvas coordinates\n      const screenX = e.clientX - rect.left - 160; // Adjust for node width  \n      const screenY = e.clientY - rect.top - 50;   // Adjust for node height\n      \n      // Apply inverse transformation to get canvas coordinates\n      const canvasX = (screenX - pan.x) / (zoom / 100);\n      const canvasY = (screenY - pan.y) / (zoom / 100);\n      \n      // Если координаты разумные (не слишком близко к краю), используем их\n      if (canvasX > 20 && canvasY > 20 && canvasX < 10000 && canvasY < 10000) {\n        nodePosition = { x: Math.max(50, canvasX), y: Math.max(50, canvasY) };\n      } else {\n        // Иначе используем центр видимой области\n        nodePosition = getCenterPosition();\n      }\n    } else {\n      // Если не удалось получить rect, используем центр\n      nodePosition = getCenterPosition();\n    }\n    \n    const newNode: Node = {\n      id: nanoid(),\n      type: component.type,\n      position: nodePosition,\n      data: {\n        keyboardType: 'none',\n        buttons: [],\n        oneTimeKeyboard: false,\n        resizeKeyboard: true,\n        markdown: false,\n        ...component.defaultData\n      }\n    };\n    \n    onNodeAdd(newNode);\n  }, [onNodeAdd, pan, zoom, getCenterPosition]);\n\n  // Обработчик canvas-drop события для touch устройств  \n  const handleCanvasDrop = useCallback((e: CustomEvent) => {\n    console.log('Canvas drop event received:', e.detail);\n    const { component, position } = e.detail;\n    \n    if (!component) {\n      console.error('Invalid drop data: no component');\n      return;\n    }\n    \n    let nodePosition;\n    \n    if (position) {\n      // Transform screen coordinates to canvas coordinates\n      const canvasX = (position.x - pan.x) / (zoom / 100);\n      const canvasY = (position.y - pan.y) / (zoom / 100);\n      \n      console.log('Drop position calculation:', {\n        screenPos: position,\n        pan,\n        zoom,\n        canvasPos: { x: canvasX, y: canvasY }\n      });\n      \n      nodePosition = { x: Math.max(0, canvasX - 80), y: Math.max(0, canvasY - 25) };\n    } else {\n      // Если нет позиции drop, используем центр видимой области\n      nodePosition = getCenterPosition();\n      console.log('Using center position:', nodePosition);\n    }\n    \n    const newNode: Node = {\n      id: nanoid(),\n      type: component.type,\n      position: nodePosition,\n      data: {\n        keyboardType: 'none',\n        buttons: [],\n        oneTimeKeyboard: false,\n        resizeKeyboard: true,\n        markdown: false,\n        ...component.defaultData\n      }\n    };\n    \n    console.log('Creating new node:', newNode);\n    onNodeAdd(newNode);\n  }, [onNodeAdd, pan, zoom, getCenterPosition]);\n\n  // Handle canvas-drop событие для touch устройств\n  useEffect(() => {\n    const canvasElement = canvasRef.current;\n    if (canvasElement) {\n      canvasElement.addEventListener('canvas-drop', handleCanvasDrop as EventListener);\n      return () => canvasElement.removeEventListener('canvas-drop', handleCanvasDrop as EventListener);\n    }\n  }, [handleCanvasDrop]);\n\n  const handleDragOver = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(true);\n  }, []);\n\n  const handleDragLeave = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n  }, []);\n\n  const handleCanvasClick = useCallback((e: React.MouseEvent) => {\n    if (e.target === e.currentTarget) {\n      onNodeSelect('');\n      onConnectionSelect?.('');\n      setConnectionStart(null);\n    }\n  }, [onNodeSelect, onConnectionSelect]);\n\n  // Отслеживание движения мыши для предварительного просмотра соединения\n  useEffect(() => {\n    if (!connectionStart) return;\n\n    const handleMouseMove = (e: MouseEvent) => {\n      if (canvasRef.current) {\n        const rect = canvasRef.current.getBoundingClientRect();\n        setMousePosition({\n          x: e.clientX - rect.left,\n          y: e.clientY - rect.top\n        });\n      }\n    };\n\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') {\n        setConnectionStart(null);\n      }\n    };\n\n    document.addEventListener('mousemove', handleMouseMove);\n    document.addEventListener('keydown', handleKeyDown);\n\n    return () => {\n      document.removeEventListener('mousemove', handleMouseMove);\n      document.removeEventListener('keydown', handleKeyDown);\n    };\n  }, [connectionStart]);\n\n  const handleConnectionStart = useCallback((nodeId: string, handle: 'source' | 'target') => {\n    if (connectionStart) {\n      // Если уже есть начало соединения, пытаемся завершить его\n      if (connectionStart.nodeId !== nodeId) {\n        const sourceId = connectionStart.handle === 'source' ? connectionStart.nodeId : nodeId;\n        const targetId = connectionStart.handle === 'source' ? nodeId : connectionStart.nodeId;\n        \n        // Используем ConnectionManager для создания соединения\n        const connectionManager = new ConnectionManager({\n          nodes,\n          connections,\n          autoButtonCreation\n        });\n        \n        try {\n          const { connection, updatedNodes } = connectionManager.createConnection(sourceId, targetId, {\n            autoCreateButton: autoButtonCreation\n          });\n          \n          onConnectionAdd?.(connection);\n          if (onNodesUpdate) {\n            onNodesUpdate(updatedNodes);\n          }\n        } catch (error) {\n          console.error('Ошибка при создании соединения:', error);\n        }\n      }\n      setConnectionStart(null);\n    } else {\n      // Начинаем новое соединение\n      setConnectionStart({ nodeId, handle });\n    }\n  }, [connectionStart, onConnectionAdd, onNodesUpdate, nodes, connections, autoButtonCreation]);\n\n  const handleCreateSuggestedConnection = useCallback((source: string, target: string) => {\n    const newConnection: Connection = {\n      id: nanoid(),\n      source,\n      target,\n      isInterSheet: false,\n    };\n    onConnectionAdd?.(newConnection);\n    setShowSuggestions(false);\n  }, [onConnectionAdd]);\n\n  const handleAutoConnect = useCallback(() => {\n    const suggestions = generateAutoConnections(nodes, connections);\n    const bestSuggestion = suggestions.find(s => s.confidence > 0.8);\n    \n    if (bestSuggestion) {\n      handleCreateSuggestedConnection(bestSuggestion.source, bestSuggestion.target);\n    } else {\n      setShowSuggestions(true);\n    }\n  }, [nodes, connections, handleCreateSuggestedConnection]);\n\n  return (\n    <main className=\"w-full h-full relative overflow-hidden bg-gradient-to-br from-slate-50 via-gray-50 to-slate-100 dark:from-slate-950 dark:via-gray-950 dark:to-slate-900\">\n      <div className=\"absolute inset-0 overflow-auto p-8\">\n        \n        {/* Enhanced Canvas Grid */}\n        <div \n          ref={canvasRef}\n          className=\"min-h-full relative canvas-grid-modern\"\n          style={{\n            backgroundImage: `\n              radial-gradient(circle at 1px 1px, rgba(99, 102, 241, 0.15) 1px, transparent 0)\n            `,\n            backgroundSize: `${24 * zoom / 100}px ${24 * zoom / 100}px`,\n            backgroundPosition: `${pan.x}px ${pan.y}px`,\n            minHeight: '2000vh',\n            minWidth: '2000vw',\n            cursor: isPanning ? 'grabbing' : 'grab'\n          }}\n          data-drag-over={isDragOver}\n          data-canvas-drop-zone\n          onDrop={handleDrop}\n          onDragOver={handleDragOver}\n          onDragLeave={handleDragLeave}\n          onClick={handleCanvasClick}\n          onWheel={handleWheel}\n          onMouseDown={handleMouseDown}\n          onMouseMove={handleMouseMove}\n          onMouseUp={handleMouseUp}\n          onContextMenu={handleContextMenu}\n          onTouchStart={handleTouchStart}\n          onTouchMove={handleTouchMove}\n          onTouchEnd={handleTouchEnd}\n        >\n          {/* Transformable Canvas Content */}\n          <div \n            className=\"relative origin-top-left transition-transform duration-200 ease-out\"\n            style={{\n              transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom / 100})`,\n              transformOrigin: '0 0'\n            }}\n          >\n            {/* Connections Layer */}\n            <ConnectionsLayer\n              connections={connections}\n              nodes={nodes}\n              selectedConnectionId={selectedConnectionId}\n              onConnectionSelect={onConnectionSelect}\n              onConnectionDelete={onConnectionDelete}\n            />\n\n            {/* Temporary connection preview */}\n            {connectionStart && (\n              <TemporaryConnection\n                startNode={nodes.find(n => n.id === connectionStart.nodeId)!}\n                endPosition={{\n                  x: (mousePosition.x - pan.x) / (zoom / 100),\n                  y: (mousePosition.y - pan.y) / (zoom / 100)\n                }}\n                handle={connectionStart.handle}\n              />\n            )}\n            \n            {/* Nodes */}\n            {nodes.map((node) => (\n              <CanvasNode\n                key={node.id}\n                node={node}\n                isSelected={selectedNodeId === node.id}\n                onClick={() => onNodeSelect(node.id)}\n                onDelete={() => onNodeDelete(node.id)}\n                onDuplicate={onNodeDuplicate ? () => onNodeDuplicate(node.id) : undefined}\n                onMove={(position) => onNodeMove(node.id, position)}\n                onConnectionStart={handleConnectionStart}\n                connectionStart={connectionStart}\n                zoom={zoom}\n                pan={pan}\n                setIsNodeBeingDragged={setIsNodeBeingDragged}\n                onSizeChange={handleNodeSizeChange}\n              />\n            ))}\n          </div>\n          \n          {/* Drop Zone Hint */}\n          {nodes.length === 0 && (\n            <div className=\"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200/50 dark:border-slate-600/50 p-12 w-96 text-center transition-all duration-500 hover:scale-105\">\n              <div className=\"w-20 h-20 bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-pink-500/10 dark:from-blue-400/20 dark:via-purple-400/20 dark:to-pink-400/20 rounded-3xl flex items-center justify-center mx-auto mb-8 border border-blue-200/50 dark:border-blue-600/30 transition-all duration-300 hover:scale-110 hover:shadow-lg hover:shadow-blue-500/20\">\n                <i className=\"fas fa-plus text-blue-600 dark:text-blue-400 text-3xl drop-shadow-sm\"></i>\n              </div>\n              <h3 className=\"text-gray-800 dark:text-gray-200 mb-4 font-bold text-xl bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent\">Перетащите элемент сюда</h3>\n              <p className=\"text-gray-600 dark:text-gray-400 text-base leading-relaxed\">Выберите компонент из левой панели и перетащите на холст для создания бота</p>\n            </div>\n          )}\n\n          {/* Smart Connection Tools */}\n          {nodes.length > 1 && (\n            <div className=\"absolute bottom-24 right-4 flex flex-col space-y-2 z-20\">\n              {/* Auto Connection Panel */}\n              <Popover open={showAutoPanel} onOpenChange={setShowAutoPanel}>\n                <PopoverTrigger asChild>\n                  <Button\n                    className=\"rounded-full w-10 h-10 shadow-md hover:shadow-lg transition-all duration-300 bg-gradient-to-br from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700\"\n                    title=\"Управление автосоединениями\"\n                  >\n                    <i className=\"fas fa-magic text-white text-sm\" />\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent side=\"left\" className=\"w-auto p-0\">\n                  <AutoConnectionPanel\n                    nodes={nodes}\n                    connections={connections}\n                    onConnectionAdd={(connection) => onConnectionAdd?.(connection)}\n                    onNodesUpdate={(updatedNodes) => onNodesUpdate?.(updatedNodes)}\n                    autoButtonCreation={autoButtonCreation}\n                    onAutoButtonCreationChange={setAutoButtonCreation}\n                  />\n                </PopoverContent>\n              </Popover>\n\n              {/* Auto-connect button */}\n              <Button\n                onClick={handleAutoConnect}\n                className=\"rounded-full w-10 h-10 shadow-md hover:shadow-lg transition-all duration-300 bg-gradient-to-br from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700\"\n                title=\"Быстрое автосоединение\"\n              >\n                <i className=\"fas fa-bolt text-white text-sm\" />\n              </Button>\n\n              {/* Connection suggestions */}\n              <Popover open={showSuggestions} onOpenChange={setShowSuggestions}>\n                <PopoverTrigger asChild>\n                  <Button\n                    variant=\"outline\"\n                    className=\"rounded-full w-10 h-10 shadow-md hover:shadow-lg transition-all duration-300 bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm\"\n                    title=\"Рекомендации соединений\"\n                  >\n                    <i className=\"fas fa-lightbulb text-yellow-500 text-sm\" />\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent side=\"left\" className=\"w-80 p-0\">\n                  <ConnectionSuggestions\n                    nodes={nodes}\n                    connections={connections}\n                    onCreateConnection={handleCreateSuggestedConnection}\n                  />\n                </PopoverContent>\n              </Popover>\n\n              {/* Clear connections button */}\n              {connections.length > 0 && (\n                <Button\n                  onClick={() => {\n                    connections.forEach(conn => onConnectionDelete?.(conn.id));\n                  }}\n                  variant=\"outline\"\n                  className=\"rounded-full w-10 h-10 shadow-md hover:shadow-lg transition-all duration-300 bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm hover:bg-red-50 dark:hover:bg-red-900/20\"\n                  title=\"Очистить все соединения\"\n                >\n                  <i className=\"fas fa-eraser text-red-500 text-sm\" />\n                </Button>\n              )}\n            </div>\n          )}\n        </div>\n\n      </div>\n      \n      {/* Панель инструментов - фиксированная панель вверху */}\n      <div className=\"absolute top-0 z-40 pointer-events-none transition-all duration-300\" style={{\n        left: isMobile ? '10px' : (sidebarVisible ? '100px' : '20px'),\n        right: isMobile ? '10px' : (propertiesVisible ? '150px' : '20px')\n      }}>\n        <div className=\"pt-0\">\n          <div className={`pointer-events-auto flex items-center canvas-controls overflow-x-auto ${\n            isMobile ? 'space-x-1 text-sm' : 'space-x-2'\n          }`}>\n            \n            <div className={`flex items-center flex-shrink-0 ${isMobile ? 'space-x-0.5' : 'space-x-1'}`}>\n              {/* Кнопки масштаба */}\n              <button \n                onClick={zoomOut}\n                disabled={zoom <= 1}\n                className={`${isMobile ? 'p-2' : 'p-2.5'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 group disabled:opacity-50 disabled:cursor-not-allowed`}\n                title=\"Уменьшить масштаб (Ctrl + -)\"\n              >\n                <i className=\"fas fa-search-minus text-gray-600 dark:text-gray-400 text-sm group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors\"></i>\n              </button>\n              \n              <Popover>\n                <PopoverTrigger asChild>\n                  <button\n                    className={`${isMobile ? 'px-2 py-2 text-xs min-w-[3rem]' : 'px-3 py-2.5 text-sm min-w-[4rem]'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 text-gray-700 dark:text-gray-300 font-mono text-center group`}\n                    title=\"Выбрать масштаб\"\n                  >\n                    <span className=\"flex items-center justify-center space-x-1\">\n                      <span>{Math.round(zoom)}%</span>\n                      <i className=\"fas fa-chevron-down text-xs opacity-50 group-hover:opacity-100 transition-opacity\"></i>\n                    </span>\n                  </button>\n                </PopoverTrigger>\n                <PopoverContent side=\"bottom\" className=\"w-40 p-2\">\n                  <div className=\"space-y-1\">\n                    <div className=\"text-xs font-medium text-gray-600 dark:text-gray-400 px-2 py-1\">Быстрый масштаб</div>\n                    {[1, 5, 10, 25, 50, 75, 100, 125, 150, 200].map((level) => (\n                      <button\n                        key={level}\n                        onClick={() => setZoomLevel(level)}\n                        className={`w-full text-left px-2 py-1.5 text-sm rounded hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors ${\n                          Math.abs(zoom - level) < 1 ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400' : ''\n                        }`}\n                      >\n                        <div className=\"flex items-center justify-between\">\n                          <span>{level}%</span>\n                          {level === 100 && <span className=\"text-xs opacity-60\">По умолчанию</span>}\n                          {level === 200 && <span className=\"text-xs opacity-60\">Максимум</span>}\n                          {level === 1 && <span className=\"text-xs opacity-60\">Минимум</span>}\n                        </div>\n                      </button>\n                    ))}\n                    <div className=\"border-t border-gray-200 dark:border-slate-600 my-1\"></div>\n                    <button\n                      onClick={resetZoom}\n                      className=\"w-full text-left px-2 py-1.5 text-sm rounded hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors text-blue-600 dark:text-blue-400\"\n                    >\n                      <div className=\"flex items-center space-x-2\">\n                        <i className=\"fas fa-home text-xs\"></i>\n                        <span>Сбросить вид</span>\n                      </div>\n                    </button>\n                    <button\n                      onClick={fitToContent}\n                      disabled={nodes.length === 0}\n                      className=\"w-full text-left px-2 py-1.5 text-sm rounded hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors text-green-600 dark:text-green-400 disabled:opacity-50 disabled:cursor-not-allowed\"\n                    >\n                      <div className=\"flex items-center space-x-2\">\n                        <i className=\"fas fa-expand-arrows-alt text-xs\"></i>\n                        <span>Уместить всё</span>\n                      </div>\n                    </button>\n                  </div>\n                </PopoverContent>\n              </Popover>\n              \n              <button \n                onClick={zoomIn}\n                disabled={zoom >= 200}\n                className={`${isMobile ? 'p-2' : 'p-2.5'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 group disabled:opacity-50 disabled:cursor-not-allowed`}\n                title=\"Увеличить масштаб (Ctrl + +)\"\n              >\n                <i className=\"fas fa-search-plus text-gray-600 dark:text-gray-400 text-sm group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors\"></i>\n              </button>\n              <button \n                onClick={fitToContent}\n                disabled={nodes.length === 0}\n                className={`${isMobile ? 'p-2' : 'p-2.5'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 group disabled:opacity-50 disabled:cursor-not-allowed`}\n                title=\"Уместить в экран (Ctrl + 1)\"\n              >\n                <i className=\"fas fa-expand-arrows-alt text-gray-600 dark:text-gray-400 text-sm group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors\"></i>\n              </button>\n\n\n              <button \n                onClick={onUndo}\n                disabled={!canUndo}\n                className={`${isMobile ? 'p-2' : 'p-2.5'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 group disabled:opacity-50 disabled:cursor-not-allowed`}\n                title=\"Отменить действие (Ctrl + Z)\"\n              >\n                <i className=\"fas fa-undo text-gray-600 dark:text-gray-400 text-sm group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors\"></i>\n              </button>\n\n              <button \n                onClick={onRedo}\n                disabled={!canRedo}\n                className={`${isMobile ? 'p-2' : 'p-2.5'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 group disabled:opacity-50 disabled:cursor-not-allowed`}\n                title=\"Повторить действие (Ctrl + Y)\"\n              >\n                <i className=\"fas fa-redo text-gray-600 dark:text-gray-400 text-sm group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors\"></i>\n              </button>\n\n              {onSave && (\n                <button \n                  onClick={onSave}\n                  disabled={isSaving}\n                  className={`${isMobile ? 'p-2' : 'p-2.5'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 group disabled:opacity-50 disabled:cursor-not-allowed`}\n                  title=\"Сохранить проект (Ctrl + S)\"\n                >\n                  {isSaving ? (\n                    <i className=\"fas fa-spinner fa-spin text-gray-600 dark:text-gray-400 text-sm\"></i>\n                  ) : (\n                    <i className=\"fas fa-save text-gray-600 dark:text-gray-400 text-sm group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors\"></i>\n                  )}\n                </button>\n              )}\n\n              {/* Межпроектное копирование/вставка */}\n              {onCopyToClipboard && selectedNodeId && (\n                <button \n                  onClick={() => onCopyToClipboard([selectedNodeId])}\n                  className={`${isMobile ? 'p-2' : 'p-2.5'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 group`}\n                  title=\"Копировать в буфер (Shift + Ctrl + C)\"\n                >\n                  <i className=\"fas fa-clipboard text-gray-600 dark:text-gray-400 text-sm group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors\"></i>\n                </button>\n              )}\n\n              {onPasteFromClipboard && hasClipboardData && (\n                <button \n                  onClick={onPasteFromClipboard}\n                  className={`${isMobile ? 'p-2' : 'p-2.5'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 group`}\n                  title=\"Вставить из буфера (Shift + Ctrl + V)\"\n                >\n                  <i className=\"fas fa-paste text-gray-600 dark:text-gray-400 text-sm group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors\"></i>\n                </button>\n              )}\n\n              {/* Кнопки управления интерфейсом - показываем только когда шапка скрыта */}\n              {headerVisible === false && (onToggleHeader || onToggleSidebar || onToggleProperties || onToggleCanvas) && (\n                <div className=\"flex items-center space-x-1 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 p-1\">\n                  {onToggleHeader && (\n                    <button\n                      onClick={onToggleHeader}\n                      className={`p-2 rounded-md transition-all duration-200 ${\n                        headerVisible \n                          ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400' \n                          : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'\n                      }`}\n                      title={`${headerVisible ? 'Скрыть' : 'Показать'} шапку`}\n                    >\n                      <Navigation className=\"w-4 h-4\" />\n                    </button>\n                  )}\n                  \n                  {onToggleSidebar && (\n                    <button\n                      onClick={onToggleSidebar}\n                      className={`p-2 rounded-md transition-all duration-200 ${\n                        sidebarVisible \n                          ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400' \n                          : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'\n                      }`}\n                      title={`${sidebarVisible ? 'Скрыть' : 'Показать'} боковую панель`}\n                    >\n                      <Sidebar className=\"w-4 h-4\" />\n                    </button>\n                  )}\n                  \n                  {onToggleCanvas && (\n                    <button\n                      onClick={onToggleCanvas}\n                      className={`p-2 rounded-md transition-all duration-200 ${\n                        canvasVisible \n                          ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400' \n                          : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'\n                      }`}\n                      title={`${canvasVisible ? 'Скрыть' : 'Показать'} холст`}\n                    >\n                      <Monitor className=\"w-4 h-4\" />\n                    </button>\n                  )}\n                  \n                  {onToggleProperties && (\n                    <button\n                      onClick={onToggleProperties}\n                      className={`p-2 rounded-md transition-all duration-200 ${\n                        propertiesVisible \n                          ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400' \n                          : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'\n                      }`}\n                      title={`${propertiesVisible ? 'Скрыть' : 'Показать'} панель свойств`}\n                    >\n                      <Sliders className=\"w-4 h-4\" />\n                    </button>\n                  )}\n                </div>\n              )}\n\n            </div>\n            \n            {/* Zoom Info and Help */}\n            <div className=\"flex items-center space-x-2\">\n              {zoom !== 100 && (\n                <div className=\"bg-white/90 dark:bg-slate-900/90 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 px-3 py-2 text-xs text-gray-600 dark:text-gray-400\">\n                  <div className=\"flex items-center space-x-2\">\n                    <i className=\"fas fa-info-circle text-blue-500\"></i>\n                    <span>\n                      {zoom > 100 ? 'Увеличено' : 'Уменьшено'} до {Math.round(zoom)}%\n                    </span>\n                    <span className=\"text-gray-400 dark:text-gray-500\">•</span>\n                    <span>Ctrl+0 для сброса</span>\n                  </div>\n                </div>\n              )}\n              \n              {/* Zoom Help */}\n              <Popover>\n                <PopoverTrigger asChild>\n                  <button className={`${isMobile ? 'p-1.5' : 'p-2'} bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-lg shadow-lg border border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-50 dark:hover:bg-slate-800 transition-all duration-200 group`}>\n                    <i className=\"fas fa-question-circle text-gray-500 dark:text-gray-400 text-sm group-hover:text-blue-500 transition-colors\"></i>\n                  </button>\n                </PopoverTrigger>\n                <PopoverContent side=\"bottom\" className=\"w-64 p-3\">\n                  <div className=\"space-y-3\">\n                    <h4 className=\"font-medium text-sm\">Управление масштабом</h4>\n                    <div className=\"space-y-2 text-xs\">\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-gray-600 dark:text-gray-400\">Увеличить:</span>\n                        <code className=\"bg-gray-100 dark:bg-slate-800 px-1.5 py-0.5 rounded\">Ctrl + +</code>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-gray-600 dark:text-gray-400\">Уменьшить:</span>\n                        <code className=\"bg-gray-100 dark:bg-slate-800 px-1.5 py-0.5 rounded\">Ctrl + -</code>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-gray-600 dark:text-gray-400\">Сбросить:</span>\n                        <code className=\"bg-gray-100 dark:bg-slate-800 px-1.5 py-0.5 rounded\">Ctrl + 0</code>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-gray-600 dark:text-gray-400\">Уместить всё:</span>\n                        <code className=\"bg-gray-100 dark:bg-slate-800 px-1.5 py-0.5 rounded\">Ctrl + 1</code>\n                      </div>\n                      <div className=\"border-t border-gray-200 dark:border-slate-600 pt-2 mt-2\">\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-gray-600 dark:text-gray-400\">Масштабирование:</span>\n                          <code className=\"bg-gray-100 dark:bg-slate-800 px-1.5 py-0.5 rounded\">Ctrl + колесо</code>\n                        </div>\n                        <div className=\"flex justify-between mt-1\">\n                          <span className=\"text-gray-600 dark:text-gray-400\">Панорамирование:</span>\n                          <code className=\"bg-gray-100 dark:bg-slate-800 px-1.5 py-0.5 rounded\">Alt + ЛКМ</code>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </PopoverContent>\n              </Popover>\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      {/* Компонент листов холста - фиксированная панель внизу */}\n      {botData && onBotDataUpdate && (\n        <div className=\"absolute bottom-0 z-40 pointer-events-none transition-all duration-300\" style={{\n          left: isMobile ? '10px' : (sidebarVisible ? '260px' : '20px'),\n          right: isMobile ? '10px' : (propertiesVisible ? '320px' : '20px')\n        }}>\n          <div className=\"flex justify-center pb-4\">\n            <div className=\"pointer-events-auto w-full\" style={{\n              minWidth: isMobile ? '300px' : '600px',\n              maxWidth: isMobile ? '100%' : '1000px'\n            }}>\n              <CanvasSheets\n                sheets={botData.sheets}\n                activeSheetId={botData.activeSheetId || null}\n                onSheetSelect={handleSheetSelect}\n                onSheetAdd={handleSheetAdd}\n                onSheetDelete={handleSheetDelete}\n                onSheetRename={handleSheetRename}\n                onSheetDuplicate={handleSheetDuplicate}\n                maxVisibleTabs={5}\n              />\n            </div>\n          </div>\n        </div>\n      )}\n    </main>\n  );\n}\n","size_bytes":58479},"scripts/init-db.ts":{"content":"import { Pool } from 'pg';\nimport { drizzle } from 'drizzle-orm/node-postgres';\nimport { sql } from 'drizzle-orm';\nimport * as schema from '../shared/schema';\n\nasync function initDatabase() {\n  // Получаем URL базы данных из переменных окружения Replit\n  const databaseUrl = process.env.DATABASE_URL || process.env.REPLIT_DB_URL;\n  \n  if (!databaseUrl) {\n    console.error('DATABASE_URL is not set. Checking available environment variables...');\n    console.log('Available env vars:', Object.keys(process.env).filter(key => key.includes('DB')));\n    process.exit(1);\n  }\n\n  console.log('Connecting to database...');\n  \n  const pool = new Pool({ \n    connectionString: databaseUrl,\n    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n  });\n\n  const db = drizzle(pool, { schema });\n\n  try {\n    // Проверяем подключение\n    console.log('Testing connection...');\n    await db.execute(sql`SELECT 1`);\n    console.log('✅ Database connection successful!');\n\n    // Создаем таблицы если их нет\n    console.log('Creating tables...');\n    \n    // Создаем таблицы по порядку (с учетом зависимостей)\n    await db.execute(sql`\n      CREATE TABLE IF NOT EXISTS bot_projects (\n        id SERIAL PRIMARY KEY,\n        name TEXT NOT NULL,\n        description TEXT,\n        data JSONB NOT NULL,\n        bot_token TEXT,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `);\n\n    await db.execute(sql`\n      CREATE TABLE IF NOT EXISTS bot_tokens (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) ON DELETE CASCADE NOT NULL,\n        name TEXT NOT NULL,\n        token TEXT NOT NULL,\n        is_default INTEGER DEFAULT 0,\n        is_active INTEGER DEFAULT 1,\n        description TEXT,\n        bot_first_name TEXT,\n        bot_username TEXT,\n        bot_description TEXT,\n        bot_short_description TEXT,\n        bot_photo_url TEXT,\n        bot_can_join_groups INTEGER,\n        bot_can_read_all_group_messages INTEGER,\n        bot_supports_inline_queries INTEGER,\n        bot_has_main_web_app INTEGER,\n        last_used_at TIMESTAMP,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `);\n\n    await db.execute(sql`\n      CREATE TABLE IF NOT EXISTS bot_instances (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) NOT NULL,\n        token_id INTEGER REFERENCES bot_tokens(id) ON DELETE CASCADE NOT NULL,\n        status TEXT NOT NULL,\n        token TEXT NOT NULL,\n        process_id TEXT,\n        started_at TIMESTAMP DEFAULT NOW(),\n        stopped_at TIMESTAMP,\n        error_message TEXT\n      );\n    `);\n\n    await db.execute(sql`\n      CREATE TABLE IF NOT EXISTS bot_templates (\n        id SERIAL PRIMARY KEY,\n        name TEXT NOT NULL,\n        description TEXT,\n        data JSONB NOT NULL,\n        category TEXT DEFAULT 'custom',\n        tags TEXT[],\n        is_public INTEGER DEFAULT 0,\n        difficulty TEXT DEFAULT 'easy',\n        author_id TEXT,\n        author_name TEXT,\n        use_count INTEGER NOT NULL DEFAULT 0,\n        rating INTEGER NOT NULL DEFAULT 0,\n        rating_count INTEGER NOT NULL DEFAULT 0,\n        featured INTEGER NOT NULL DEFAULT 0,\n        version TEXT DEFAULT '1.0.0',\n        preview_image TEXT,\n        last_used_at TIMESTAMP,\n        download_count INTEGER NOT NULL DEFAULT 0,\n        like_count INTEGER NOT NULL DEFAULT 0,\n        bookmark_count INTEGER NOT NULL DEFAULT 0,\n        view_count INTEGER NOT NULL DEFAULT 0,\n        language TEXT DEFAULT 'ru',\n        requires_token INTEGER NOT NULL DEFAULT 0,\n        complexity INTEGER NOT NULL DEFAULT 1,\n        estimated_time INTEGER NOT NULL DEFAULT 5,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `);\n\n    await db.execute(sql`\n      CREATE TABLE IF NOT EXISTS media_files (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) ON DELETE CASCADE NOT NULL,\n        file_name TEXT NOT NULL,\n        file_type TEXT NOT NULL,\n        file_path TEXT NOT NULL,\n        file_size INTEGER NOT NULL,\n        mime_type TEXT NOT NULL,\n        url TEXT NOT NULL,\n        description TEXT,\n        tags TEXT[] DEFAULT '{}',\n        is_public INTEGER DEFAULT 0,\n        usage_count INTEGER DEFAULT 0,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `);\n\n    await db.execute(sql`\n      CREATE TABLE IF NOT EXISTS user_bot_data (\n        id SERIAL PRIMARY KEY,\n        project_id INTEGER REFERENCES bot_projects(id) ON DELETE CASCADE NOT NULL,\n        user_id TEXT NOT NULL,\n        user_name TEXT,\n        first_name TEXT,\n        last_name TEXT,\n        language_code TEXT,\n        is_bot INTEGER DEFAULT 0,\n        is_premium INTEGER DEFAULT 0,\n        last_interaction TIMESTAMP DEFAULT NOW(),\n        interaction_count INTEGER DEFAULT 0,\n        user_data JSONB DEFAULT '{}',\n        current_state TEXT,\n        preferences JSONB DEFAULT '{}',\n        commands_used JSONB DEFAULT '{}',\n        sessions_count INTEGER DEFAULT 1,\n        total_messages_sent INTEGER DEFAULT 0,\n        total_messages_received INTEGER DEFAULT 0,\n        device_info TEXT,\n        location_data JSONB,\n        contact_data JSONB,\n        is_blocked INTEGER DEFAULT 0,\n        is_active INTEGER DEFAULT 1,\n        tags TEXT[] DEFAULT '{}',\n        notes TEXT,\n        created_at TIMESTAMP DEFAULT NOW(),\n        updated_at TIMESTAMP DEFAULT NOW()\n      );\n    `);\n\n    await db.execute(sql`\n      CREATE TABLE IF NOT EXISTS bot_users (\n        user_id BIGINT PRIMARY KEY,\n        username TEXT,\n        first_name TEXT,\n        last_name TEXT,\n        registered_at TIMESTAMP DEFAULT NOW(),\n        last_interaction TIMESTAMP DEFAULT NOW(),\n        interaction_count INTEGER DEFAULT 0,\n        user_data JSONB DEFAULT '{}',\n        is_active INTEGER DEFAULT 1\n      );\n    `);\n\n    console.log('✅ All tables created successfully!');\n    \n  } catch (error) {\n    console.error('❌ Database initialization failed:', error);\n    process.exit(1);\n  } finally {\n    await pool.end();\n  }\n}\n\ninitDatabase().catch(console.error);","size_bytes":6341},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":23567},"client/src/components/media/media-manager.tsx":{"content":"import React, { useState, useCallback } from 'react';\nimport { useDropzone } from 'react-dropzone';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMediaFiles, useUploadMedia, useDeleteMedia, useUpdateMedia, useIncrementUsage } from \"@/hooks/use-media\";\nimport { CameraCapture } from \"./camera-capture\";\nimport { EnhancedMediaUploader } from \"./enhanced-media-uploader\";\nimport type { MediaFile } from \"@shared/schema\";\nimport { Loader2, Upload, Search, X, Edit, Trash2, Eye, Download, Play, Volume2, FileText, Image, AlertCircle, CheckCircle2, Camera, FolderOpen, Zap, Smartphone, Plus } from \"lucide-react\";\n\ninterface MediaManagerProps {\n  projectId: number;\n  onSelectFile?: (file: MediaFile) => void;\n  selectedType?: 'photo' | 'video' | 'audio' | 'document';\n}\n\ninterface UploadingFile {\n  file: File;\n  progress: number;\n  status: 'uploading' | 'success' | 'error';\n  error?: string;\n}\n\nexport function MediaManager({ projectId, onSelectFile, selectedType }: MediaManagerProps) {\n  const { toast } = useToast();\n  const [currentTab, setCurrentTab] = useState(selectedType || 'all');\n  const [searchQuery, setSearchQuery] = useState('');\n  const [selectedFile, setSelectedFile] = useState<MediaFile | null>(null);\n  const [editingFile, setEditingFile] = useState<MediaFile | null>(null);\n  const [uploadingFiles, setUploadingFiles] = useState<UploadingFile[]>([]);\n  const [showUploadDetails, setShowUploadDetails] = useState(false);\n  const [showCameraCapture, setShowCameraCapture] = useState(false);\n  const [showEnhancedUploader, setShowEnhancedUploader] = useState(false);\n  const [hasCamera, setHasCamera] = useState(false);\n\n  const { data: allFiles, isLoading } = useMediaFiles(projectId);\n  const { data: photoFiles } = useMediaFiles(projectId, 'photo');\n  const { data: videoFiles } = useMediaFiles(projectId, 'video');\n  const { data: audioFiles } = useMediaFiles(projectId, 'audio');\n  const { data: documentFiles } = useMediaFiles(projectId, 'document');\n\n  const uploadMutation = useUploadMedia(projectId);\n  const deleteMutation = useDeleteMedia();\n  const updateMutation = useUpdateMedia();\n  const incrementUsage = useIncrementUsage();\n\n  // Проверяем доступность камеры\n  React.useEffect(() => {\n    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n      navigator.mediaDevices.enumerateDevices()\n        .then(devices => {\n          const hasVideoInput = devices.some(device => device.kind === 'videoinput');\n          setHasCamera(hasVideoInput);\n        })\n        .catch(() => setHasCamera(false));\n    }\n  }, []);\n\n  const validateFile = (file: File): string | null => {\n    // Check file size with different limits for different types\n    const maxSize = file.type.startsWith('video/') ? 100 * 1024 * 1024 : 50 * 1024 * 1024;\n    if (file.size > maxSize) {\n      return `Файл слишком большой. Максимальный размер: ${file.type.startsWith('video/') ? '100' : '50'}МБ`;\n    }\n\n    // Enhanced file type support\n    const allowedTypes = [\n      // Изображения\n      'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp', 'image/tiff',\n      // Видео\n      'video/mp4', 'video/webm', 'video/ogg', 'video/avi', 'video/mov', 'video/wmv', 'video/flv', 'video/mkv',\n      // Аудио\n      'audio/mp3', 'audio/wav', 'audio/ogg', 'audio/mpeg', 'audio/webm', 'audio/aac', 'audio/flac', 'audio/m4a',\n      // Документы\n      'application/pdf', \n      'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n      'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n      'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n      'text/plain', 'text/csv', 'text/rtf',\n      // Архивы\n      'application/zip', 'application/rar', 'application/x-7z-compressed', 'application/x-tar', 'application/gzip'\n    ];\n\n    if (!allowedTypes.includes(file.type)) {\n      return `Неподдерживаемый тип файла: ${file.type}`;\n    }\n\n    return null;\n  };\n\n  const onDrop = useCallback((acceptedFiles: File[], rejectedFiles: any[]) => {\n    // Handle rejected files\n    rejectedFiles.forEach(rejection => {\n      const error = rejection.errors[0]?.message || 'Неподдерживаемый файл';\n      toast({\n        title: \"Файл отклонен\",\n        description: `${rejection.file.name}: ${error}`,\n        variant: \"destructive\",\n      });\n    });\n\n    // Process accepted files\n    acceptedFiles.forEach(file => {\n      // Additional validation\n      const validationError = validateFile(file);\n      if (validationError) {\n        toast({\n          title: \"Файл отклонен\",\n          description: `${file.name}: ${validationError}`,\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      // Add to uploading files list\n      const uploadingFile: UploadingFile = {\n        file,\n        progress: 0,\n        status: 'uploading'\n      };\n\n      setUploadingFiles(prev => [...prev, uploadingFile]);\n      setShowUploadDetails(true);\n\n      // Start upload with progress simulation\n      uploadMutation.mutate({\n        file,\n        description: '',\n        tags: []\n      }, {\n        onSuccess: () => {\n          setUploadingFiles(prev => \n            prev.map(uf => \n              uf.file === file \n                ? { ...uf, progress: 100, status: 'success' }\n                : uf\n            )\n          );\n          toast({\n            title: \"Файл загружен\",\n            description: `${file.name} успешно загружен`,\n          });\n          // Remove from uploading list after delay\n          setTimeout(() => {\n            setUploadingFiles(prev => prev.filter(uf => uf.file !== file));\n          }, 3000);\n        },\n        onError: (error) => {\n          setUploadingFiles(prev => \n            prev.map(uf => \n              uf.file === file \n                ? { ...uf, status: 'error', error: error.message }\n                : uf\n            )\n          );\n          toast({\n            title: \"Ошибка загрузки\",\n            description: error.message,\n            variant: \"destructive\",\n          });\n        }\n      });\n\n      // Simulate progress (since we don't have real progress from backend)\n      const progressInterval = setInterval(() => {\n        setUploadingFiles(prev => \n          prev.map(uf => {\n            if (uf.file === file && uf.status === 'uploading' && uf.progress < 90) {\n              return { ...uf, progress: Math.min(uf.progress + Math.random() * 20, 90) };\n            }\n            return uf;\n          })\n        );\n      }, 500);\n\n      setTimeout(() => clearInterval(progressInterval), 10000);\n    });\n  }, [uploadMutation, toast]);\n\n  const { getRootProps, getInputProps, isDragActive, isDragReject, fileRejections } = useDropzone({\n    onDrop,\n    accept: {\n      'image/*': ['.jpeg', '.jpg', '.png', '.gif', '.webp'],\n      'video/*': ['.mp4', '.webm', '.ogg', '.avi', '.mov'],\n      'audio/*': ['.mp3', '.wav', '.ogg', '.mpeg', '.webm'],\n      'application/pdf': ['.pdf'],\n      'application/msword': ['.doc'],\n      'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],\n      'text/plain': ['.txt'],\n      'application/zip': ['.zip'],\n      'application/rar': ['.rar']\n    },\n    maxSize: 50 * 1024 * 1024, // 50MB\n    maxFiles: 10, // Maximum 10 files at once\n    multiple: true,\n    disabled: uploadingFiles.some(uf => uf.status === 'uploading'),\n    // Better mobile support\n    useFsAccessApi: false,\n    getFilesFromEvent: async (event) => {\n      const files = [];\n      \n      if (event.type === 'drop') {\n        // Handle dropped files\n        const items = Array.from(event.dataTransfer.items);\n        for (const item of items) {\n          if (item.kind === 'file') {\n            const file = item.getAsFile();\n            if (file) files.push(file);\n          }\n        }\n      } else if (event.target && event.target.files) {\n        // Handle selected files\n        files.push(...Array.from(event.target.files));\n      }\n      \n      return files;\n    }\n  });\n\n  const handleDeleteFile = (file: MediaFile) => {\n    deleteMutation.mutate(file.id, {\n      onSuccess: () => {\n        toast({\n          title: \"Файл удален\",\n          description: `${file.fileName} был удален`,\n        });\n        setSelectedFile(null);\n      },\n      onError: (error) => {\n        toast({\n          title: \"Ошибка удаления\",\n          description: error.message,\n          variant: \"destructive\",\n        });\n      }\n    });\n  };\n\n  const handleSelectFile = (file: MediaFile) => {\n    if (onSelectFile) {\n      onSelectFile(file);\n      incrementUsage.mutate(file.id);\n    } else {\n      setSelectedFile(file);\n    }\n  };\n\n  const handleUpdateFile = (file: MediaFile, updates: Partial<MediaFile>) => {\n    updateMutation.mutate({\n      id: file.id,\n      updates\n    }, {\n      onSuccess: () => {\n        toast({\n          title: \"Файл обновлен\",\n          description: \"Информация о файле была обновлена\",\n        });\n        setEditingFile(null);\n      },\n      onError: (error) => {\n        toast({\n          title: \"Ошибка обновления\",\n          description: error.message,\n          variant: \"destructive\",\n        });\n      }\n    });\n  };\n\n  const getFileIcon = (fileType: string) => {\n    switch (fileType) {\n      case 'photo': return <Image className=\"w-4 h-4\" />;\n      case 'video': return <Play className=\"w-4 h-4\" />;\n      case 'audio': return <Volume2 className=\"w-4 h-4\" />;\n      case 'document': return <FileText className=\"w-4 h-4\" />;\n      default: return <FileText className=\"w-4 h-4\" />;\n    }\n  };\n\n  const getFilesToDisplay = () => {\n    let files: MediaFile[] = [];\n    \n    switch (currentTab) {\n      case 'photo': files = photoFiles || []; break;\n      case 'video': files = videoFiles || []; break;\n      case 'audio': files = audioFiles || []; break;\n      case 'document': files = documentFiles || []; break;\n      default: files = allFiles || [];\n    }\n\n    if (searchQuery) {\n      files = files.filter(file => \n        file.fileName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        (file.description && file.description.toLowerCase().includes(searchQuery.toLowerCase()))\n      );\n    }\n\n    return files;\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Б';\n    const k = 1024;\n    const sizes = ['Б', 'КБ', 'МБ', 'ГБ'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Enhanced Upload Area */}\n      <Card className=\"relative overflow-hidden\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center\">\n                <Upload className=\"w-4 h-4 text-white\" />\n              </div>\n              Загрузить медиафайлы\n            </div>\n            {uploadingFiles.length > 0 && (\n              <Button \n                variant=\"outline\" \n                size=\"sm\"\n                onClick={() => setShowUploadDetails(!showUploadDetails)}\n                className=\"flex items-center gap-2\"\n              >\n                <Zap className=\"w-4 h-4\" />\n                {uploadingFiles.length} загружается\n              </Button>\n            )}\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div\n            {...getRootProps()}\n            className={`\n              relative border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-all duration-300 group\n              ${isDragActive && !isDragReject\n                ? 'border-blue-500 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/20 scale-105' \n                : isDragReject\n                ? 'border-red-500 bg-red-50 dark:bg-red-950/20'\n                : uploadingFiles.some(uf => uf.status === 'uploading')\n                ? 'border-gray-300 dark:border-gray-600 opacity-50 cursor-not-allowed'\n                : 'border-gray-300 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50/50 dark:hover:bg-blue-950/10'\n              }\n            `}\n          >\n            <input {...getInputProps()} />\n            \n            {/* Upload Icon with Animation */}\n            <div className=\"relative mb-4\">\n              {uploadingFiles.some(uf => uf.status === 'uploading') ? (\n                <Loader2 className=\"w-16 h-16 mx-auto text-blue-500 animate-spin\" />\n              ) : isDragActive && !isDragReject ? (\n                <div className=\"w-16 h-16 mx-auto bg-blue-500 rounded-full flex items-center justify-center animate-pulse\">\n                  <Upload className=\"w-8 h-8 text-white\" />\n                </div>\n              ) : isDragReject ? (\n                <div className=\"w-16 h-16 mx-auto bg-red-500 rounded-full flex items-center justify-center\">\n                  <AlertCircle className=\"w-8 h-8 text-white\" />\n                </div>\n              ) : (\n                <div className=\"relative\">\n                  <Upload className=\"w-16 h-16 mx-auto text-gray-400 group-hover:text-blue-500 transition-colors\" />\n                  <div className=\"absolute -top-2 -right-2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity\">\n                    <Camera className=\"w-3 h-3 text-white\" />\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {/* Upload Text */}\n            {isDragActive && !isDragReject ? (\n              <div>\n                <p className=\"text-xl font-semibold text-blue-600 dark:text-blue-400 mb-2\">\n                  Отпустите файлы здесь!\n                </p>\n                <p className=\"text-sm text-blue-500\">\n                  Файлы будут загружены автоматически\n                </p>\n              </div>\n            ) : isDragReject ? (\n              <div>\n                <p className=\"text-xl font-semibold text-red-600 dark:text-red-400 mb-2\">\n                  Неподдерживаемые файлы\n                </p>\n                <p className=\"text-sm text-red-500\">\n                  Проверьте тип и размер файлов\n                </p>\n              </div>\n            ) : uploadingFiles.some(uf => uf.status === 'uploading') ? (\n              <div>\n                <p className=\"text-lg font-semibold text-gray-600 dark:text-gray-400 mb-2\">\n                  Загрузка файлов...\n                </p>\n                <p className=\"text-sm text-gray-500\">\n                  Пожалуйста, подождите\n                </p>\n              </div>\n            ) : (\n              <div>\n                <p className=\"text-xl font-semibold mb-2 text-gray-800 dark:text-gray-200\">\n                  Перетащите файлы сюда или нажмите для выбора\n                </p>\n                <p className=\"text-sm text-gray-500 mb-4\">\n                  Поддерживаются: изображения, видео, аудио, документы (до 50МБ)\n                </p>\n                <div className=\"flex items-center justify-center gap-4 text-xs text-gray-400\">\n                  <div className=\"flex items-center gap-1\">\n                    <Image className=\"w-4 h-4\" />\n                    Фото\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <Play className=\"w-4 h-4\" />\n                    Видео\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <Volume2 className=\"w-4 h-4\" />\n                    Аудио\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <FileText className=\"w-4 h-4\" />\n                    Документы\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Background Pattern */}\n            <div className=\"absolute inset-0 opacity-5 dark:opacity-10\">\n              <div className=\"absolute inset-0 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500\" />\n            </div>\n          </div>\n\n          {/* Upload Progress */}\n          {showUploadDetails && uploadingFiles.length > 0 && (\n            <div className=\"mt-6 space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <h4 className=\"font-medium text-sm text-gray-700 dark:text-gray-300\">\n                  Прогресс загрузки ({uploadingFiles.length} файлов)\n                </h4>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\"\n                  onClick={() => setShowUploadDetails(false)}\n                  className=\"h-6 w-6 p-0\"\n                >\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              </div>\n              {uploadingFiles.map((uploadingFile, index) => (\n                <div key={index} className=\"bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      {uploadingFile.status === 'uploading' && <Loader2 className=\"w-4 h-4 animate-spin text-blue-500\" />}\n                      {uploadingFile.status === 'success' && <CheckCircle2 className=\"w-4 h-4 text-green-500\" />}\n                      {uploadingFile.status === 'error' && <AlertCircle className=\"w-4 h-4 text-red-500\" />}\n                      <span className=\"text-sm font-medium truncate max-w-48\">\n                        {uploadingFile.file.name}\n                      </span>\n                    </div>\n                    <div className=\"text-xs text-gray-500\">\n                      {formatFileSize(uploadingFile.file.size)}\n                    </div>\n                  </div>\n                  {uploadingFile.status === 'uploading' && (\n                    <Progress value={uploadingFile.progress} className=\"h-2\" />\n                  )}\n                  {uploadingFile.status === 'error' && uploadingFile.error && (\n                    <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">\n                      {uploadingFile.error}\n                    </p>\n                  )}\n                  {uploadingFile.status === 'success' && (\n                    <p className=\"text-xs text-green-600 dark:text-green-400 mt-1\">\n                      Файл успешно загружен\n                    </p>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n\n          {/* Quick Actions */}\n          <div className=\"mt-6 space-y-4\">\n            {/* Quick Upload Actions */}\n            <div className=\"flex items-center justify-center gap-3 flex-wrap\">\n              <Button\n                onClick={() => setShowEnhancedUploader(true)}\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"flex items-center gap-2 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-950/20 dark:to-pink-950/20 border-purple-200 dark:border-purple-800 hover:from-purple-100 hover:to-pink-100 dark:hover:from-purple-900/30 dark:hover:to-pink-900/30\"\n              >\n                <Plus className=\"w-4 h-4 text-purple-600 dark:text-purple-400\" />\n                Расширенная загрузка\n              </Button>\n              \n              {hasCamera && (\n                <Button\n                  onClick={() => setShowCameraCapture(true)}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  className=\"flex items-center gap-2 bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-950/20 dark:to-blue-950/20 border-green-200 dark:border-green-800 hover:from-green-100 hover:to-blue-100 dark:hover:from-green-900/30 dark:hover:to-blue-900/30\"\n                >\n                  <Camera className=\"w-4 h-4 text-green-600 dark:text-green-400\" />\n                  Сделать фото\n                </Button>\n              )}\n              \n              {/* Hidden file inputs for specific types */}\n              <div className=\"flex gap-2\">\n                <input\n                  type=\"file\"\n                  id=\"photo-input\"\n                  accept=\"image/*\"\n                  multiple\n                  className=\"hidden\"\n                  onChange={(e) => {\n                    if (e.target.files) {\n                      onDrop(Array.from(e.target.files), []);\n                      e.target.value = '';\n                    }\n                  }}\n                />\n                <Button\n                  onClick={() => document.getElementById('photo-input')?.click()}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  className=\"flex items-center gap-2\"\n                >\n                  <Image className=\"w-4 h-4\" />\n                  Фото\n                </Button>\n                \n                <input\n                  type=\"file\"\n                  id=\"video-input\"\n                  accept=\"video/*\"\n                  multiple\n                  className=\"hidden\"\n                  onChange={(e) => {\n                    if (e.target.files) {\n                      onDrop(Array.from(e.target.files), []);\n                      e.target.value = '';\n                    }\n                  }}\n                />\n                <Button\n                  onClick={() => document.getElementById('video-input')?.click()}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  className=\"flex items-center gap-2\"\n                >\n                  <Play className=\"w-4 h-4\" />\n                  Видео\n                </Button>\n                \n                <input\n                  type=\"file\"\n                  id=\"document-input\"\n                  accept=\".pdf,.doc,.docx,.txt\"\n                  multiple\n                  className=\"hidden\"\n                  onChange={(e) => {\n                    if (e.target.files) {\n                      onDrop(Array.from(e.target.files), []);\n                      e.target.value = '';\n                    }\n                  }}\n                />\n                <Button\n                  onClick={() => document.getElementById('document-input')?.click()}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  className=\"flex items-center gap-2\"\n                >\n                  <FileText className=\"w-4 h-4\" />\n                  Документы\n                </Button>\n              </div>\n            </div>\n            \n            {/* Stats */}\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-4 text-xs text-gray-500\">\n                <span>Макс. размер: 100МБ (видео), 50МБ (остальное)</span>\n                <span>•</span>\n                <span>До 10 файлов за раз</span>\n              </div>\n              {allFiles && allFiles.length > 0 && (\n                <Button variant=\"outline\" size=\"sm\" className=\"flex items-center gap-2\">\n                  <FolderOpen className=\"w-4 h-4\" />\n                  {allFiles.length} файлов в библиотеке\n                </Button>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Enhanced Search and Filter */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n              <Input\n                placeholder=\"Поиск файлов по имени или описанию...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n            \n            {/* Upload Stats */}\n            {allFiles && allFiles.length > 0 && (\n              <div className=\"flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400\">\n                <div className=\"flex items-center gap-1\">\n                  <Image className=\"w-4 h-4\" />\n                  <span>{photoFiles?.length || 0}</span>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <Play className=\"w-4 h-4\" />\n                  <span>{videoFiles?.length || 0}</span>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <Volume2 className=\"w-4 h-4\" />\n                  <span>{audioFiles?.length || 0}</span>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <FileText className=\"w-4 h-4\" />\n                  <span>{documentFiles?.length || 0}</span>\n                </div>\n              </div>\n            )}\n          </div>\n          \n          {searchQuery && (\n            <div className=\"mt-2 flex items-center gap-2\">\n              <span className=\"text-sm text-gray-500\">\n                Найдено: {getFilesToDisplay().length} файлов\n              </span>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setSearchQuery('')}\n                className=\"h-6 px-2\"\n              >\n                <X className=\"w-3 h-3\" />\n                Очистить\n              </Button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Tabs */}\n      <Tabs value={currentTab} onValueChange={setCurrentTab}>\n        <TabsList className=\"grid w-full grid-cols-5\">\n          <TabsTrigger value=\"all\">Все</TabsTrigger>\n          <TabsTrigger value=\"photo\">Фото</TabsTrigger>\n          <TabsTrigger value=\"video\">Видео</TabsTrigger>\n          <TabsTrigger value=\"audio\">Аудио</TabsTrigger>\n          <TabsTrigger value=\"document\">Документы</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value={currentTab} className=\"mt-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {getFilesToDisplay().map((file) => (\n              <Card key={file.id} className=\"group hover:shadow-md transition-shadow\">\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-start justify-between mb-3\">\n                    <div className=\"flex items-center gap-2\">\n                      {getFileIcon(file.fileType)}\n                      <span className=\"font-medium text-sm truncate\">{file.fileName}</span>\n                    </div>\n                    <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"ghost\"\n                        onClick={() => handleSelectFile(file)}\n                        className=\"h-7 w-7 p-0\"\n                      >\n                        <Eye className=\"w-3 h-3\" />\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"ghost\"\n                        onClick={() => setEditingFile(file)}\n                        className=\"h-7 w-7 p-0\"\n                      >\n                        <Edit className=\"w-3 h-3\" />\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"ghost\"\n                        onClick={() => handleDeleteFile(file)}\n                        className=\"h-7 w-7 p-0 text-red-600 hover:text-red-700\"\n                      >\n                        <Trash2 className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  {/* Preview */}\n                  <div className=\"mb-3\">\n                    {file.fileType === 'photo' && (\n                      <img\n                        src={file.url}\n                        alt={file.fileName}\n                        className=\"w-full h-32 object-cover rounded border\"\n                      />\n                    )}\n                    {file.fileType === 'video' && (\n                      <video\n                        src={file.url}\n                        className=\"w-full h-32 object-cover rounded border\"\n                        controls={false}\n                      />\n                    )}\n                    {file.fileType === 'audio' && (\n                      <div className=\"w-full h-32 bg-gray-100 dark:bg-gray-800 rounded border flex items-center justify-center\">\n                        <Volume2 className=\"w-8 h-8 text-gray-400\" />\n                      </div>\n                    )}\n                    {file.fileType === 'document' && (\n                      <div className=\"w-full h-32 bg-gray-100 dark:bg-gray-800 rounded border flex items-center justify-center\">\n                        <FileText className=\"w-8 h-8 text-gray-400\" />\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between text-xs text-gray-500\">\n                      <span>{formatFileSize(file.fileSize)}</span>\n                      <span>Использован: {file.usageCount || 0} раз</span>\n                    </div>\n                    {file.description && (\n                      <p className=\"text-xs text-gray-600 dark:text-gray-400 truncate\">\n                        {file.description}\n                      </p>\n                    )}\n                    {file.tags && file.tags.length > 0 && (\n                      <div className=\"flex flex-wrap gap-1\">\n                        {file.tags.slice(0, 3).map((tag, index) => (\n                          <Badge key={index} variant=\"secondary\" className=\"text-xs\">\n                            {tag}\n                          </Badge>\n                        ))}\n                        {file.tags.length > 3 && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            +{file.tags.length - 3}\n                          </Badge>\n                        )}\n                      </div>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n\n          {getFilesToDisplay().length === 0 && (\n            <div className=\"text-center py-12\">\n              <FileText className=\"w-12 h-12 mx-auto mb-4 text-gray-300\" />\n              <p className=\"text-gray-500\">\n                {searchQuery ? 'Файлы не найдены' : 'Нет загруженных файлов'}\n              </p>\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      {/* Edit Dialog */}\n      {editingFile && (\n        <Dialog open={!!editingFile} onOpenChange={() => setEditingFile(null)}>\n          <DialogContent aria-describedby=\"edit-file-description\">\n            <DialogHeader>\n              <DialogTitle>Редактировать файл</DialogTitle>\n              <div id=\"edit-file-description\" className=\"text-sm text-muted-foreground\">\n                Измените описание и теги для этого медиа файла\n              </div>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"text-sm font-medium\">Описание</label>\n                <Textarea\n                  value={editingFile.description || ''}\n                  onChange={(e) => setEditingFile({\n                    ...editingFile,\n                    description: e.target.value\n                  })}\n                  placeholder=\"Описание файла\"\n                />\n              </div>\n              <div>\n                <label className=\"text-sm font-medium\">Теги (через запятую)</label>\n                <Input\n                  value={editingFile.tags?.join(', ') || ''}\n                  onChange={(e) => setEditingFile({\n                    ...editingFile,\n                    tags: e.target.value.split(',').map(tag => tag.trim()).filter(Boolean)\n                  })}\n                  placeholder=\"тег1, тег2, тег3\"\n                />\n              </div>\n              <div className=\"flex justify-end gap-2\">\n                <Button variant=\"outline\" onClick={() => setEditingFile(null)}>\n                  Отмена\n                </Button>\n                <Button onClick={() => handleUpdateFile(editingFile, {\n                  description: editingFile.description,\n                  tags: editingFile.tags\n                })}>\n                  Сохранить\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      )}\n\n      {/* Camera Capture */}\n      <CameraCapture\n        projectId={projectId}\n        isOpen={showCameraCapture}\n        onClose={() => setShowCameraCapture(false)}\n        onCapture={(file) => {\n          // Process captured file same as dropped file\n          const validationError = validateFile(file);\n          if (validationError) {\n            toast({\n              title: \"Файл отклонен\",\n              description: `${file.name}: ${validationError}`,\n              variant: \"destructive\",\n            });\n            return;\n          }\n\n          const uploadingFile: UploadingFile = {\n            file,\n            progress: 0,\n            status: 'uploading'\n          };\n\n          setUploadingFiles(prev => [...prev, uploadingFile]);\n          setShowUploadDetails(true);\n          setShowCameraCapture(false);\n\n          uploadMutation.mutate({\n            file,\n            description: 'Фото с камеры',\n            tags: ['камера', 'фото']\n          }, {\n            onSuccess: () => {\n              setUploadingFiles(prev => \n                prev.map(uf => \n                  uf.file === file \n                    ? { ...uf, progress: 100, status: 'success' }\n                    : uf\n                )\n              );\n              toast({\n                title: \"Фото загружено\",\n                description: `${file.name} успешно загружен`,\n              });\n              setTimeout(() => {\n                setUploadingFiles(prev => prev.filter(uf => uf.file !== file));\n              }, 3000);\n            },\n            onError: (error) => {\n              setUploadingFiles(prev => \n                prev.map(uf => \n                  uf.file === file \n                    ? { ...uf, status: 'error', error: error.message }\n                    : uf\n                )\n              );\n              toast({\n                title: \"Ошибка загрузки\",\n                description: error.message,\n                variant: \"destructive\",\n              });\n            }\n          });\n        }}\n      />\n\n      {/* Enhanced Media Uploader Dialog */}\n      <Dialog open={showEnhancedUploader} onOpenChange={setShowEnhancedUploader}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" aria-describedby=\"enhanced-upload-description\">\n          <DialogHeader>\n            <DialogTitle>Расширенная загрузка файлов</DialogTitle>\n            <div id=\"enhanced-upload-description\" className=\"text-sm text-muted-foreground\">\n              Загрузите медиа файлы с расширенными настройками: пакетная загрузка, теги, описания\n            </div>\n          </DialogHeader>\n          <EnhancedMediaUploader\n            projectId={projectId}\n            onUploadComplete={(uploadedFiles) => {\n              toast({\n                title: \"Файлы загружены\",\n                description: `Успешно загружено ${uploadedFiles.length} файлов`,\n              });\n              setShowEnhancedUploader(false);\n            }}\n            onClose={() => setShowEnhancedUploader(false)}\n            maxFiles={20}\n            acceptedTypes={['image/*', 'video/*', 'audio/*', '.pdf', '.doc', '.docx', '.txt']}\n          />\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","size_bytes":37701},"client/src/components/media/camera-capture.tsx":{"content":"import React, { useState, useRef, useCallback } from 'react';\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useUploadMedia } from \"@/hooks/use-media\";\nimport { Camera, X, RotateCcw, Zap, Loader2 } from \"lucide-react\";\n\ninterface CameraCaptureProps {\n  projectId: number;\n  onCapture?: (file: File) => void;\n  onClose?: () => void;\n  isOpen: boolean;\n}\n\nexport function CameraCapture({ projectId, onCapture, onClose, isOpen }: CameraCaptureProps) {\n  const { toast } = useToast();\n  const uploadMutation = useUploadMedia(projectId);\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const streamRef = useRef<MediaStream | null>(null);\n  \n  const [isStreaming, setIsStreaming] = useState(false);\n  const [capturedImage, setCapturedImage] = useState<string | null>(null);\n  const [facing, setFacing] = useState<'user' | 'environment'>('environment');\n\n  const startCamera = useCallback(async () => {\n    try {\n      // Останавливаем предыдущий поток, если он есть\n      if (streamRef.current) {\n        streamRef.current.getTracks().forEach(track => track.stop());\n      }\n\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: {\n          facingMode: facing,\n          width: { ideal: 1280 },\n          height: { ideal: 720 }\n        },\n        audio: false\n      });\n\n      streamRef.current = stream;\n      if (videoRef.current) {\n        videoRef.current.srcObject = stream;\n        videoRef.current.play();\n        setIsStreaming(true);\n      }\n    } catch (error) {\n      console.error('Ошибка доступа к камере:', error);\n      toast({\n        title: \"Ошибка камеры\",\n        description: \"Не удалось получить доступ к камере. Проверьте разрешения.\",\n        variant: \"destructive\",\n      });\n    }\n  }, [facing, toast]);\n\n  const stopCamera = useCallback(() => {\n    if (streamRef.current) {\n      streamRef.current.getTracks().forEach(track => track.stop());\n      streamRef.current = null;\n    }\n    setIsStreaming(false);\n    setCapturedImage(null);\n  }, []);\n\n  const capturePhoto = useCallback(() => {\n    if (videoRef.current && canvasRef.current) {\n      const video = videoRef.current;\n      const canvas = canvasRef.current;\n      const context = canvas.getContext('2d');\n\n      if (context) {\n        canvas.width = video.videoWidth;\n        canvas.height = video.videoHeight;\n        context.drawImage(video, 0, 0, canvas.width, canvas.height);\n        \n        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);\n        setCapturedImage(dataUrl);\n      }\n    }\n  }, []);\n\n  const retakePhoto = useCallback(() => {\n    setCapturedImage(null);\n  }, []);\n\n  const switchCamera = useCallback(() => {\n    setFacing(prev => prev === 'user' ? 'environment' : 'user');\n    setCapturedImage(null);\n    if (isStreaming) {\n      startCamera();\n    }\n  }, [isStreaming, startCamera]);\n\n  const savePhoto = useCallback(async () => {\n    if (capturedImage && canvasRef.current) {\n      try {\n        // Конвертируем canvas в Blob\n        canvasRef.current.toBlob(async (blob) => {\n          if (blob) {\n            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n            const file = new File([blob], `camera-photo-${timestamp}.jpg`, {\n              type: 'image/jpeg',\n              lastModified: Date.now()\n            });\n\n            if (onCapture) {\n              onCapture(file);\n            } else {\n              // Загружаем файл напрямую\n              uploadMutation.mutate({\n                file,\n                description: 'Фото с камеры',\n                tags: ['камера', 'фото']\n              }, {\n                onSuccess: () => {\n                  toast({\n                    title: \"Фото сохранено\",\n                    description: \"Фото успешно загружено в библиотеку\",\n                  });\n                  handleClose();\n                },\n                onError: (error) => {\n                  toast({\n                    title: \"Ошибка загрузки\",\n                    description: error.message,\n                    variant: \"destructive\",\n                  });\n                }\n              });\n            }\n          }\n        }, 'image/jpeg', 0.8);\n      } catch (error) {\n        console.error('Ошибка сохранения фото:', error);\n        toast({\n          title: \"Ошибка\",\n          description: \"Не удалось сохранить фото\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  }, [capturedImage, onCapture, uploadMutation, toast]);\n\n  const handleClose = useCallback(() => {\n    stopCamera();\n    if (onClose) {\n      onClose();\n    }\n  }, [stopCamera, onClose]);\n\n  // Эффект для запуска камеры при открытии диалога\n  React.useEffect(() => {\n    if (isOpen && !isStreaming && !capturedImage) {\n      startCamera();\n    } else if (!isOpen) {\n      stopCamera();\n    }\n  }, [isOpen, isStreaming, capturedImage, startCamera, stopCamera]);\n\n  // Очистка при размонтировании\n  React.useEffect(() => {\n    return () => {\n      stopCamera();\n    };\n  }, [stopCamera]);\n\n  return (\n    <Dialog open={isOpen} onOpenChange={handleClose}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Camera className=\"w-5 h-5\" />\n            Съемка с камеры\n          </DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          {/* Camera Preview */}\n          <div className=\"relative bg-black rounded-lg overflow-hidden aspect-video\">\n            {!capturedImage ? (\n              <>\n                <video\n                  ref={videoRef}\n                  className=\"w-full h-full object-cover\"\n                  autoPlay\n                  playsInline\n                  muted\n                />\n                {isStreaming && (\n                  <div className=\"absolute bottom-4 left-1/2 transform -translate-x-1/2 flex items-center gap-2\">\n                    <Button\n                      onClick={switchCamera}\n                      variant=\"secondary\"\n                      size=\"sm\"\n                      className=\"rounded-full w-10 h-10 p-0\"\n                    >\n                      <RotateCcw className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      onClick={capturePhoto}\n                      className=\"rounded-full w-16 h-16 bg-white border-4 border-white hover:bg-gray-100\"\n                    >\n                      <div className=\"w-full h-full rounded-full bg-white\" />\n                    </Button>\n                  </div>\n                )}\n              </>\n            ) : (\n              <img\n                src={capturedImage}\n                alt=\"Captured\"\n                className=\"w-full h-full object-cover\"\n              />\n            )}\n            \n            {!isStreaming && !capturedImage && (\n              <div className=\"absolute inset-0 flex items-center justify-center\">\n                <Button onClick={startCamera} className=\"flex items-center gap-2\">\n                  <Camera className=\"w-4 h-4\" />\n                  Включить камеру\n                </Button>\n              </div>\n            )}\n          </div>\n\n          {/* Hidden Canvas */}\n          <canvas ref={canvasRef} className=\"hidden\" />\n\n          {/* Controls */}\n          {capturedImage && (\n            <div className=\"flex justify-between gap-2\">\n              <Button\n                onClick={retakePhoto}\n                variant=\"outline\"\n                className=\"flex-1\"\n              >\n                Переснять\n              </Button>\n              <Button\n                onClick={savePhoto}\n                disabled={uploadMutation.isPending}\n                className=\"flex-1 flex items-center gap-2\"\n              >\n                {uploadMutation.isPending ? (\n                  <Loader2 className=\"w-4 h-4 animate-spin\" />\n                ) : (\n                  <Zap className=\"w-4 h-4\" />\n                )}\n                Сохранить\n              </Button>\n            </div>\n          )}\n\n          {/* Info */}\n          <div className=\"text-xs text-gray-500 text-center\">\n            {!isStreaming && !capturedImage && \"Нажмите 'Включить камеру' для начала съемки\"}\n            {isStreaming && !capturedImage && \"Нажмите на белую кнопку для съемки\"}\n            {capturedImage && \"Фото готово! Сохраните или переснимите\"}\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","size_bytes":9078},"client/src/hooks/use-media.ts":{"content":"import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { MediaFile, InsertMediaFile } from \"@shared/schema\";\n\nexport function useMediaFiles(projectId: number, fileType?: string) {\n  return useQuery({\n    queryKey: [\"/api/media/project\", projectId, fileType],\n    queryFn: async (): Promise<MediaFile[]> => {\n      const url = fileType \n        ? `/api/media/project/${projectId}?type=${fileType}`\n        : `/api/media/project/${projectId}`;\n      const response = await fetch(url);\n      if (!response.ok) {\n        throw new Error(\"Ошибка при загрузке медиафайлов\");\n      }\n      return response.json();\n    },\n  });\n}\n\nexport function useUploadMedia(projectId: number) {\n  const queryClient = useQueryClient();\n  \n  return useMutation({\n    mutationFn: async ({ \n      file, \n      description, \n      tags, \n      isPublic,\n      onProgress \n    }: { \n      file: File; \n      description?: string; \n      tags?: string[];\n      isPublic?: boolean;\n      onProgress?: (progress: number) => void;\n    }): Promise<MediaFile> => {\n      const formData = new FormData();\n      formData.append('file', file);\n      if (description) formData.append('description', description);\n      if (tags) formData.append('tags', tags.join(','));\n      if (isPublic !== undefined) formData.append('isPublic', isPublic.toString());\n      \n      return new Promise((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n        \n        // Обработчик прогресса загрузки\n        if (onProgress) {\n          xhr.upload.addEventListener('progress', (e) => {\n            if (e.lengthComputable) {\n              const progress = Math.round((e.loaded / e.total) * 100);\n              onProgress(progress);\n            }\n          });\n        }\n        \n        xhr.addEventListener('load', () => {\n          if (xhr.status >= 200 && xhr.status < 300) {\n            try {\n              const result = JSON.parse(xhr.responseText);\n              resolve(result);\n            } catch (parseError) {\n              console.error('Parse error:', parseError, 'Response:', xhr.responseText);\n              reject(new Error('Ошибка при обработке ответа сервера'));\n            }\n          } else {\n            try {\n              const error = JSON.parse(xhr.responseText);\n              console.error('Upload error:', error);\n              reject(new Error(error.message || `Ошибка при загрузке файла (${xhr.status})`));\n            } catch (parseError) {\n              console.error('Error parsing error response:', parseError, 'Response:', xhr.responseText);\n              reject(new Error(`Ошибка сервера: ${xhr.status} - ${xhr.statusText}`));\n            }\n          }\n        });\n        \n        xhr.addEventListener('error', () => {\n          reject(new Error('Ошибка сети при загрузке файла'));\n        });\n        \n        xhr.addEventListener('abort', () => {\n          reject(new Error('Загрузка файла была прервана'));\n        });\n        \n        xhr.open('POST', `/api/media/upload/${projectId}`);\n        xhr.send(formData);\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/media/project\", projectId] });\n    },\n  });\n}\n\nexport function useUploadMultipleMedia(projectId: number) {\n  const queryClient = useQueryClient();\n  \n  return useMutation({\n    mutationFn: async ({ \n      files, \n      defaultDescription, \n      isPublic,\n      onProgress,\n      onFileProgress\n    }: { \n      files: File[]; \n      defaultDescription?: string; \n      isPublic?: boolean;\n      onProgress?: (progress: number) => void;\n      onFileProgress?: (fileIndex: number, progress: number) => void;\n    }): Promise<{\n      success: number;\n      errors: number;\n      uploadedFiles: MediaFile[];\n      errorDetails: any[];\n      statistics: any;\n    }> => {\n      const formData = new FormData();\n      \n      files.forEach(file => {\n        formData.append('files', file);\n      });\n      \n      if (defaultDescription) formData.append('defaultDescription', defaultDescription);\n      if (isPublic !== undefined) formData.append('isPublic', isPublic.toString());\n      \n      return new Promise((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n        \n        // Обработчик прогресса загрузки\n        if (onProgress) {\n          xhr.upload.addEventListener('progress', (e) => {\n            if (e.lengthComputable) {\n              const progress = Math.round((e.loaded / e.total) * 100);\n              onProgress(progress);\n            }\n          });\n        }\n        \n        xhr.addEventListener('load', () => {\n          if (xhr.status >= 200 && xhr.status < 300) {\n            try {\n              const result = JSON.parse(xhr.responseText);\n              resolve(result);\n            } catch (parseError) {\n              console.error('Multiple upload parse error:', parseError, 'Response:', xhr.responseText);\n              reject(new Error('Ошибка при обработке ответа сервера'));\n            }\n          } else {\n            try {\n              const error = JSON.parse(xhr.responseText);\n              console.error('Multiple upload error:', error);\n              reject(new Error(error.message || `Ошибка при загрузке файлов (${xhr.status})`));\n            } catch (parseError) {\n              console.error('Error parsing multiple upload error response:', parseError, 'Response:', xhr.responseText);\n              reject(new Error(`Ошибка сервера: ${xhr.status} - ${xhr.statusText}`));\n            }\n          }\n        });\n        \n        xhr.addEventListener('error', () => {\n          reject(new Error('Ошибка сети при загрузке файлов'));\n        });\n        \n        xhr.addEventListener('abort', () => {\n          reject(new Error('Загрузка файлов была прервана'));\n        });\n        \n        xhr.open('POST', `/api/media/upload-multiple/${projectId}`);\n        xhr.send(formData);\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/media/project\", projectId] });\n    },\n  });\n}\n\nexport function useDeleteMedia() {\n  const queryClient = useQueryClient();\n  \n  return useMutation({\n    mutationFn: async (id: number): Promise<void> => {\n      const response = await apiRequest('DELETE', `/api/media/${id}`);\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Ошибка при удалении файла');\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/media/project\"] });\n    },\n  });\n}\n\nexport function useUpdateMedia() {\n  const queryClient = useQueryClient();\n  \n  return useMutation({\n    mutationFn: async ({ \n      id, \n      updates \n    }: { \n      id: number; \n      updates: Partial<InsertMediaFile> \n    }): Promise<MediaFile> => {\n      const response = await apiRequest('PUT', `/api/media/${id}`, updates);\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Ошибка при обновлении файла');\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/media/project\"] });\n    },\n  });\n}\n\nexport function useIncrementUsage() {\n  const queryClient = useQueryClient();\n  \n  return useMutation({\n    mutationFn: async (id: number): Promise<void> => {\n      const response = await apiRequest('POST', `/api/media/${id}/use`);\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Ошибка при обновлении использования');\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/media/project\"] });\n    },\n  });\n}\n\nexport function useSearchMedia(projectId: number, query: string) {\n  return useQuery({\n    queryKey: [\"/api/media/search\", projectId, query],\n    queryFn: async (): Promise<MediaFile[]> => {\n      if (!query.trim()) return [];\n      \n      const response = await fetch(`/api/media/search/${projectId}?q=${encodeURIComponent(query)}`);\n      if (!response.ok) {\n        throw new Error(\"Ошибка при поиске файлов\");\n      }\n      return response.json();\n    },\n    enabled: !!query.trim(),\n  });\n}","size_bytes":8656},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/utils/connection-manager.ts":{"content":"import { Node, Connection, Button } from '@shared/schema';\nimport { nanoid } from 'nanoid';\n\nexport interface ConnectionWithButton {\n  connection: Connection;\n  button: Button;\n  sourceNode: Node;\n  targetNode: Node;\n}\n\nexport interface ConnectionSuggestion {\n  id: string;\n  connection: Connection;\n  suggestedButton: Button;\n  confidence: number;\n  reason: string;\n  autoCreate: boolean;\n}\n\nexport interface ConnectionManagerState {\n  connections: Connection[];\n  nodes: Node[];\n  pendingConnections: ConnectionSuggestion[];\n  autoButtonCreation: boolean;\n  // Добавляем поддержку листов\n  sheets?: any[]; // Массив всех листов для межлистовых соединений\n  currentSheetId?: string; // ID текущего активного листа\n}\n\nexport class ConnectionManager {\n  private state: ConnectionManagerState;\n  \n  constructor(initialState: Partial<ConnectionManagerState> = {}) {\n    this.state = {\n      connections: [],\n      nodes: [],\n      pendingConnections: [],\n      autoButtonCreation: true,\n      ...initialState\n    };\n  }\n\n  // Обновление состояния\n  updateState(newState: Partial<ConnectionManagerState>) {\n    this.state = { ...this.state, ...newState };\n  }\n\n  // Основной метод для создания связи (поддерживает межлистовые соединения)\n  createConnection(sourceId: string, targetId: string, options: {\n    autoCreateButton?: boolean;\n    buttonText?: string;\n    buttonAction?: 'goto' | 'command' | 'url';\n    targetSheetId?: string; // ID целевого листа для межлистового соединения\n  } = {}): { connection: Connection; updatedNodes: Node[] } {\n    const sourceNode = this.state.nodes.find(n => n.id === sourceId);\n    let targetNode = this.state.nodes.find(n => n.id === targetId);\n    \n    // Если узел не найден в текущем листе, ищем в других листах\n    if (!targetNode && options.targetSheetId && this.state.sheets) {\n      const targetSheet = this.state.sheets.find((sheet: any) => sheet.id === options.targetSheetId);\n      if (targetSheet) {\n        targetNode = targetSheet.nodes?.find((n: any) => n.id === targetId);\n      }\n    }\n\n    if (!sourceNode) {\n      throw new Error('Исходный узел не найден');\n    }\n    \n    if (!targetNode) {\n      throw new Error('Целевой узел не найден');\n    }\n\n    // Определяем, является ли соединение межлистовым\n    const isInterSheet = options.targetSheetId && options.targetSheetId !== this.state.currentSheetId;\n\n    // Создаем соединение\n    const connection: Connection = {\n      id: nanoid(),\n      source: sourceId,\n      target: targetId,\n      sourceSheetId: this.state.currentSheetId,\n      targetSheetId: options.targetSheetId || this.state.currentSheetId,\n      isInterSheet: isInterSheet || false\n    };\n\n    // Если включено автоматическое создание кнопок\n    const shouldCreateButton = options.autoCreateButton ?? this.state.autoButtonCreation;\n    let updatedNodes = [...this.state.nodes];\n\n    if (shouldCreateButton && this.canNodeHaveButtons(sourceNode)) {\n      const button = this.createButtonForConnection(sourceNode, targetNode, options);\n      updatedNodes = this.addButtonToNode(updatedNodes, sourceId, button);\n    }\n\n    return { connection, updatedNodes };\n  }\n\n  // Получение всех узлов из всех листов для межлистовых соединений\n  getAllNodesFromAllSheets(): { node: Node; sheetId: string; sheetName: string }[] {\n    const allNodes: { node: Node; sheetId: string; sheetName: string }[] = [];\n    \n    if (this.state.sheets) {\n      this.state.sheets.forEach((sheet: any) => {\n        if (sheet.nodes) {\n          sheet.nodes.forEach((node: Node) => {\n            allNodes.push({\n              node,\n              sheetId: sheet.id,\n              sheetName: sheet.name\n            });\n          });\n        }\n      });\n    }\n    \n    return allNodes;\n  }\n\n  // Создание кнопки для соединения (поддерживает межлистовые соединения)\n  private createButtonForConnection(\n    sourceNode: Node,\n    targetNode: Node,\n    options: {\n      buttonText?: string;\n      buttonAction?: 'goto' | 'command' | 'url';\n      targetSheetId?: string;\n    } = {}\n  ): Button {\n    const action = options.buttonAction || this.determineButtonAction(targetNode);\n    let text = options.buttonText || this.generateButtonText(targetNode, action);\n    \n    // Если это межлистовое соединение, добавляем индикатор листа\n    if (options.targetSheetId && options.targetSheetId !== this.state.currentSheetId) {\n      const targetSheet = this.state.sheets?.find((sheet: any) => sheet.id === options.targetSheetId);\n      if (targetSheet) {\n        text += ` 📋 (${targetSheet.name})`;\n      }\n    }\n\n    return {\n      id: nanoid(),\n      text,\n      action,\n      target: action === 'goto' ? targetNode.id : undefined,\n      url: action === 'url' ? targetNode.data.imageUrl : undefined\n    };\n  }\n\n  // Определение типа действия кнопки\n  private determineButtonAction(targetNode: Node): 'goto' | 'command' | 'url' {\n    switch (targetNode.type) {\n      case 'command':\n        return 'command';\n      case 'photo':\n        return targetNode.data.imageUrl ? 'url' : 'goto';\n      default:\n        return 'goto';\n    }\n  }\n\n  // Генерация текста кнопки\n  private generateButtonText(targetNode: Node, action: 'goto' | 'command' | 'url'): string {\n    if (action === 'command' && targetNode.data.command) {\n      return targetNode.data.command;\n    }\n\n    const textMap: Record<Node['type'], string> = {\n      start: '🏠 Главное меню',\n      message: targetNode.data.messageText?.slice(0, 25) + '...' || '💬 Сообщение',\n      photo: '🖼️ Посмотреть фото',\n      keyboard: '⌨️ Показать меню',\n      input: '✏️ Ввести данные',\n      condition: '🔀 Проверить условие',\n      command: targetNode.data.command || '⚡ Команда'\n    };\n\n    return textMap[targetNode.type] || '➡️ Продолжить';\n  }\n\n  // Проверка, может ли узел иметь кнопки\n  private canNodeHaveButtons(node: Node): boolean {\n    return ['message', 'photo', 'keyboard', 'start', 'input'].includes(node.type);\n  }\n\n  // Добавление кнопки к узлу\n  private addButtonToNode(nodes: Node[], nodeId: string, button: Button): Node[] {\n    return nodes.map(node => {\n      if (node.id === nodeId) {\n        const existingButtons = node.data.buttons || [];\n        return {\n          ...node,\n          data: {\n            ...node.data,\n            buttons: [...existingButtons, button]\n          }\n        };\n      }\n      return node;\n    });\n  }\n\n  // Автоматическое создание предложений соединений\n  generateConnectionSuggestions(): ConnectionSuggestion[] {\n    const suggestions: ConnectionSuggestion[] = [];\n    const existingConnections = new Set(\n      this.state.connections.map(c => `${c.source}-${c.target}`)\n    );\n\n    // Логика создания предложений\n    for (const sourceNode of this.state.nodes) {\n      if (!this.canNodeHaveButtons(sourceNode)) continue;\n\n      for (const targetNode of this.state.nodes) {\n        if (sourceNode.id === targetNode.id) continue;\n        \n        const connectionKey = `${sourceNode.id}-${targetNode.id}`;\n        if (existingConnections.has(connectionKey)) continue;\n\n        const confidence = this.calculateConnectionConfidence(sourceNode, targetNode);\n        if (confidence < 0.5) continue;\n\n        const connection: Connection = {\n          id: nanoid(),\n          source: sourceNode.id,\n          target: targetNode.id\n        };\n\n        const suggestedButton = this.createButtonForConnection(sourceNode, targetNode);\n\n        suggestions.push({\n          id: nanoid(),\n          connection,\n          suggestedButton,\n          confidence,\n          reason: this.getConnectionReason(sourceNode, targetNode),\n          autoCreate: confidence > 0.8\n        });\n      }\n    }\n\n    return suggestions.sort((a, b) => b.confidence - a.confidence);\n  }\n\n  // Расчет уверенности соединения\n  private calculateConnectionConfidence(sourceNode: Node, targetNode: Node): number {\n    let confidence = 0.3;\n\n    // Логичные переходы\n    const flowPatterns = [\n      { from: 'start', to: 'message', bonus: 0.4 },\n      { from: 'start', to: 'keyboard', bonus: 0.3 },\n      { from: 'command', to: 'message', bonus: 0.4 },\n      { from: 'message', to: 'keyboard', bonus: 0.3 },\n      { from: 'keyboard', to: 'message', bonus: 0.2 },\n      { from: 'input', to: 'message', bonus: 0.3 },\n      { from: 'condition', to: 'message', bonus: 0.3 }\n    ];\n\n    const pattern = flowPatterns.find(p => p.from === sourceNode.type && p.to === targetNode.type);\n    if (pattern) {\n      confidence += pattern.bonus;\n    }\n\n    // Штраф за слишком много кнопок\n    const buttons = sourceNode.data.buttons || [];\n    const buttonCount = buttons.length;\n    if (buttonCount > 4) confidence -= 0.1;\n    if (buttonCount > 8) confidence -= 0.2;\n\n    // Бонус за близость узлов\n    const distance = Math.sqrt(\n      Math.pow(sourceNode.position.x - targetNode.position.x, 2) +\n      Math.pow(sourceNode.position.y - targetNode.position.y, 2)\n    );\n    if (distance < 400) confidence += 0.1;\n\n    return Math.min(0.95, Math.max(0.1, confidence));\n  }\n\n  // Получение причины для соединения\n  private getConnectionReason(sourceNode: Node, targetNode: Node): string {\n    if (sourceNode.type === 'start' && targetNode.type === 'message') {\n      return 'Стартовый узел обычно ведет к первому сообщению';\n    }\n    if (sourceNode.type === 'command' && targetNode.type === 'message') {\n      return 'Команда должна отправлять ответное сообщение';\n    }\n    if (sourceNode.type === 'message' && targetNode.type === 'keyboard') {\n      return 'Сообщение может содержать интерактивную клавиатуру';\n    }\n    if (sourceNode.type === 'input' && targetNode.type === 'message') {\n      return 'После ввода данных нужно дать обратную связь';\n    }\n    \n    return `Связь между ${this.getNodeTypeName(sourceNode.type)} и ${this.getNodeTypeName(targetNode.type)}`;\n  }\n\n  // Получение названия типа узла\n  private getNodeTypeName(type: Node['type']): string {\n    const names: Record<Node['type'], string> = {\n      start: 'стартом',\n      message: 'сообщением',\n      photo: 'фото',\n      keyboard: 'клавиатурой',\n      input: 'вводом',\n      condition: 'условием',\n      command: 'командой'\n    };\n    return names[type] || type;\n  }\n\n  // Удаление связанных кнопок при удалении соединения\n  removeConnection(connectionId: string): { removedConnection: Connection | null; updatedNodes: Node[] } {\n    const removedConnection = this.state.connections.find(c => c.id === connectionId);\n    if (!removedConnection) {\n      return { removedConnection: null, updatedNodes: this.state.nodes };\n    }\n\n    // Найти и удалить связанную кнопку\n    const updatedNodes = this.state.nodes.map(node => {\n      if (node.id === removedConnection.source) {\n        return {\n          ...node,\n          data: {\n            ...node.data,\n            buttons: node.data.buttons.filter(button => \n              button.action !== 'goto' || button.target !== removedConnection.target\n            )\n          }\n        };\n      }\n      return node;\n    });\n\n    return { removedConnection, updatedNodes };\n  }\n\n  // Синхронизация кнопок с соединениями\n  syncButtonsWithConnections(): Node[] {\n    const updatedNodes = [...this.state.nodes];\n\n    for (const connection of this.state.connections) {\n      const sourceNode = updatedNodes.find(n => n.id === connection.source);\n      const targetNode = updatedNodes.find(n => n.id === connection.target);\n\n      if (!sourceNode || !targetNode || !this.canNodeHaveButtons(sourceNode)) continue;\n\n      // Проверяем, есть ли уже кнопка для этого соединения\n      const hasButton = sourceNode.data.buttons.some(button => \n        button.action === 'goto' && button.target === connection.target\n      );\n\n      if (!hasButton) {\n        // Создаем недостающую кнопку\n        const button = this.createButtonForConnection(sourceNode, targetNode);\n        const nodeIndex = updatedNodes.findIndex(n => n.id === connection.source);\n        updatedNodes[nodeIndex] = {\n          ...updatedNodes[nodeIndex],\n          data: {\n            ...updatedNodes[nodeIndex].data,\n            buttons: [...updatedNodes[nodeIndex].data.buttons, button]\n          }\n        };\n      }\n    }\n\n    return updatedNodes;\n  }\n\n  // Очистка лишних кнопок\n  cleanupOrphanedButtons(): Node[] {\n    const connectionTargets = new Set(this.state.connections.map(c => c.target));\n\n    return this.state.nodes.map(node => ({\n      ...node,\n      data: {\n        ...node.data,\n        buttons: node.data.buttons.filter(button => \n          button.action !== 'goto' || \n          !button.target || \n          connectionTargets.has(button.target)\n        )\n      }\n    }));\n  }\n}\n\n// Фабрика для создания менеджера соединений\nexport function createConnectionManager(\n  nodes: Node[], \n  connections: Connection[], \n  options: { autoButtonCreation?: boolean } = {}\n): ConnectionManager {\n  return new ConnectionManager({\n    nodes,\n    connections,\n    autoButtonCreation: options.autoButtonCreation ?? true\n  });\n}","size_bytes":14331},"client/src/components/ui/connection-line.tsx":{"content":"import { useMemo } from 'react';\nimport { Connection, Node } from '@/types/bot';\nimport { cn } from '@/lib/utils';\n\ninterface ConnectionLineProps {\n  connection: Connection;\n  nodes: Node[];\n  isSelected?: boolean;\n  onClick?: () => void;\n  onDelete?: () => void;\n}\n\nexport function ConnectionLine({ connection, nodes, isSelected, onClick, onDelete }: ConnectionLineProps) {\n  const { path, midPoint, distance } = useMemo(() => {\n    const sourceNode = nodes.find(n => n.id === connection.source);\n    const targetNode = nodes.find(n => n.id === connection.target);\n    \n    if (!sourceNode || !targetNode) {\n      return { path: '', midPoint: { x: 0, y: 0 }, distance: 0 };\n    }\n\n    // Динамические размеры узла на основе содержимого\n    const baseWidth = 320; // Базовая ширина\n    const baseHeight = 200; // Базовая высота\n    \n    // Добавляем высоту для кнопок\n    const sourceButtonHeight = sourceNode.data.buttons.length > 0 ? \n      (sourceNode.data.keyboardType === 'inline' ? \n        Math.ceil(sourceNode.data.buttons.length / 2) * 50 : \n        sourceNode.data.buttons.length * 40) : 0;\n    \n    const targetButtonHeight = targetNode.data.buttons.length > 0 ? \n      (targetNode.data.keyboardType === 'inline' ? \n        Math.ceil(targetNode.data.buttons.length / 2) * 50 : \n        targetNode.data.buttons.length * 40) : 0;\n\n    const sourceHeight = baseHeight + sourceButtonHeight;\n    const targetHeight = baseHeight + targetButtonHeight;\n\n    // Умное позиционирование точек соединения\n    const sourceX = sourceNode.position.x + baseWidth + 8;\n    const sourceY = sourceNode.position.y + sourceHeight / 2;\n    const targetX = targetNode.position.x - 8;\n    const targetY = targetNode.position.y + targetHeight / 2;\n\n    // Расчет расстояния для адаптивной кривой\n    const deltaX = targetX - sourceX;\n    const deltaY = targetY - sourceY;\n    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n\n    // Адаптивная кривая Безье в зависимости от расстояния и направления\n    let controlPointOffset = Math.min(Math.abs(deltaX) / 2, Math.max(80, distance * 0.3));\n    \n    // Если узлы расположены один под другим, увеличиваем кривизну\n    if (Math.abs(deltaY) > Math.abs(deltaX)) {\n      controlPointOffset = Math.max(controlPointOffset, 120);\n    }\n\n    const controlPoint1X = sourceX + controlPointOffset;\n    const controlPoint1Y = sourceY;\n    const controlPoint2X = targetX - controlPointOffset;\n    const controlPoint2Y = targetY;\n\n    const path = `M ${sourceX} ${sourceY} C ${controlPoint1X} ${controlPoint1Y}, ${controlPoint2X} ${controlPoint2Y}, ${targetX} ${targetY}`;\n    \n    // Более точная средняя точка с учетом кривой\n    const t = 0.5;\n    const midX = Math.pow(1-t, 3) * sourceX + 3 * Math.pow(1-t, 2) * t * controlPoint1X + 3 * (1-t) * Math.pow(t, 2) * controlPoint2X + Math.pow(t, 3) * targetX;\n    const midY = Math.pow(1-t, 3) * sourceY + 3 * Math.pow(1-t, 2) * t * controlPoint1Y + 3 * (1-t) * Math.pow(t, 2) * controlPoint2Y + Math.pow(t, 3) * targetY;\n\n    const midPoint = { x: midX, y: midY };\n\n    return { path, midPoint, distance };\n  }, [connection, nodes]);\n\n  if (!path) return null;\n\n  return (\n    <g className=\"connection-line\">\n      {/* Невидимая толстая линия для удобства клика */}\n      <path\n        d={path}\n        stroke=\"transparent\"\n        strokeWidth=\"20\"\n        fill=\"none\"\n        className=\"cursor-pointer\"\n        onClick={onClick}\n      />\n      \n      {/* Основная линия */}\n      <path\n        d={path}\n        stroke={isSelected ? \"hsl(var(--primary))\" : \"hsl(var(--muted-foreground))\"}\n        strokeWidth={isSelected ? \"3\" : \"2\"}\n        fill=\"none\"\n        className={cn(\n          \"transition-all duration-300\",\n          isSelected ? \"drop-shadow-lg\" : \"hover:stroke-primary/70\"\n        )}\n        style={{\n          strokeDasharray: isSelected ? \"none\" : \"none\",\n          filter: isSelected ? \"drop-shadow(0 0 8px hsl(var(--primary) / 0.3))\" : \"none\"\n        }}\n        onClick={onClick}\n      />\n\n      {/* Анимированная линия для визуального эффекта */}\n      {isSelected && (\n        <path\n          d={path}\n          stroke=\"hsl(var(--primary))\"\n          strokeWidth=\"1\"\n          fill=\"none\"\n          className=\"animate-pulse opacity-60\"\n          style={{\n            strokeDasharray: \"8 4\",\n            animation: \"dash 2s linear infinite\"\n          }}\n        />\n      )}\n\n      {/* Стрелка */}\n      <defs>\n        <marker\n          id={`arrowhead-${connection.id}`}\n          markerWidth=\"10\"\n          markerHeight=\"7\"\n          refX=\"9\"\n          refY=\"3.5\"\n          orient=\"auto\"\n        >\n          <polygon\n            points=\"0 0, 10 3.5, 0 7\"\n            fill={isSelected ? \"hsl(var(--primary))\" : \"hsl(var(--muted-foreground))\"}\n            className=\"transition-all duration-200\"\n          />\n        </marker>\n      </defs>\n      \n      <path\n        d={path}\n        stroke={isSelected ? \"hsl(var(--primary))\" : \"hsl(var(--muted-foreground))\"}\n        strokeWidth={isSelected ? \"3\" : \"2\"}\n        fill=\"none\"\n        markerEnd={`url(#arrowhead-${connection.id})`}\n        className={cn(\n          \"transition-all duration-200\",\n          isSelected ? \"drop-shadow-lg\" : \"hover:stroke-primary/70\"\n        )}\n        onClick={onClick}\n      />\n\n      {/* Кнопка удаления */}\n      {isSelected && onDelete && (\n        <foreignObject\n          x={midPoint.x - 12}\n          y={midPoint.y - 12}\n          width=\"24\"\n          height=\"24\"\n          className=\"pointer-events-none\"\n        >\n          <button\n            className=\"w-6 h-6 bg-gradient-to-br from-red-500 to-red-600 text-white rounded-full flex items-center justify-center hover:from-red-600 hover:to-red-700 transition-all duration-200 shadow-lg hover:shadow-xl border-2 border-white dark:border-slate-900 pointer-events-auto\"\n            onClick={(e) => {\n              e.stopPropagation();\n              onDelete();\n            }}\n          >\n            <i className=\"fas fa-times text-xs\"></i>\n          </button>\n        </foreignObject>\n      )}\n    </g>\n  );\n}","size_bytes":6464},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }","size_bytes":1641},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }","size_bytes":1035},"client/src/components/editor/enhanced-connection-controls.tsx":{"content":"import React, { useState, useCallback, useMemo } from 'react';\nimport { Node, Connection, Button } from '@/types/bot';\nimport { Badge } from '@/components/ui/badge';\nimport { Button as UIButton } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Switch } from '@/components/ui/switch';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Separator } from '@/components/ui/separator';\nimport { \n  Link, \n  Plus, \n  Settings, \n  Trash2, \n  Edit3, \n  Target, \n  ArrowRight,\n  Zap,\n  CheckCircle,\n  XCircle,\n  AlertTriangle,\n  Search,\n  Filter\n} from 'lucide-react';\nimport { ConnectionManager } from '@/utils/connection-manager';\nimport { cn } from '@/lib/utils';\n\ninterface EnhancedConnectionControlsProps {\n  nodes: Node[];\n  connections: Connection[];\n  onConnectionsChange: (connections: Connection[]) => void;\n  onNodesChange: (nodes: Node[]) => void;\n  selectedConnection?: Connection;\n  onConnectionSelect?: (connection: Connection | null) => void;\n  autoButtonCreation: boolean;\n  onAutoButtonCreationChange: (enabled: boolean) => void;\n}\n\ninterface ConnectionRule {\n  id: string;\n  name: string;\n  description: string;\n  sourceTypes: Node['type'][];\n  targetTypes: Node['type'][];\n  maxConnections: number;\n  requiresButton: boolean;\n  autoApply: boolean;\n  priority: number;\n}\n\nconst defaultRules: ConnectionRule[] = [\n  {\n    id: 'start-to-content',\n    name: 'Стартовые переходы',\n    description: 'Узел \"Старт\" должен вести к контенту',\n    sourceTypes: ['start'],\n    targetTypes: ['message', 'keyboard', 'photo'],\n    maxConnections: 3,\n    requiresButton: true,\n    autoApply: true,\n    priority: 1\n  },\n  {\n    id: 'command-response',\n    name: 'Ответы на команды',\n    description: 'Команды должны иметь ответные действия',\n    sourceTypes: ['command'],\n    targetTypes: ['message', 'keyboard', 'photo'],\n    maxConnections: 5,\n    requiresButton: false,\n    autoApply: true,\n    priority: 2\n  },\n  {\n    id: 'interactive-flow',\n    name: 'Интерактивный поток',\n    description: 'Интерактивные элементы должны иметь следующие шаги',\n    sourceTypes: ['keyboard', 'input'],\n    targetTypes: ['message', 'condition'],\n    maxConnections: 10,\n    requiresButton: true,\n    autoApply: false,\n    priority: 3\n  }\n];\n\nexport function EnhancedConnectionControls({\n  nodes,\n  connections,\n  onConnectionsChange,\n  onNodesChange,\n  selectedConnection,\n  onConnectionSelect,\n  autoButtonCreation,\n  onAutoButtonCreationChange\n}: EnhancedConnectionControlsProps) {\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [rules, setRules] = useState<ConnectionRule[]>(defaultRules);\n  const [activeRule, setActiveRule] = useState<ConnectionRule | null>(null);\n  const [filterType, setFilterType] = useState<'all' | 'valid' | 'invalid'>('all');\n  const [searchTerm, setSearchTerm] = useState('');\n\n  const connectionManager = useMemo(() => \n    new ConnectionManager({\n      nodes,\n      connections,\n      autoButtonCreation\n    }),\n    [nodes, connections, autoButtonCreation]\n  );\n\n  // Анализ связей по правилам\n  const connectionAnalysis = useMemo(() => {\n    const analysis = connections.map(connection => {\n      const sourceNode = nodes.find(n => n.id === connection.source);\n      const targetNode = nodes.find(n => n.id === connection.target);\n      \n      if (!sourceNode || !targetNode) {\n        return {\n          connection,\n          isValid: false,\n          violations: ['Отсутствует исходный или целевой узел'],\n          suggestions: []\n        };\n      }\n\n      const violations: string[] = [];\n      const suggestions: string[] = [];\n      \n      // Проверка по правилам\n      const applicableRules = rules.filter(rule => \n        rule.sourceTypes.includes(sourceNode.type) && \n        rule.targetTypes.includes(targetNode.type)\n      );\n\n      if (applicableRules.length === 0) {\n        violations.push('Нет подходящих правил для этого типа связи');\n      }\n\n      applicableRules.forEach(rule => {\n        const connectionsFromSource = connections.filter(c => c.source === connection.source);\n        \n        if (connectionsFromSource.length > rule.maxConnections) {\n          violations.push(`Превышено максимальное количество связей (${rule.maxConnections})`);\n        }\n\n        if (rule.requiresButton) {\n          const buttons = sourceNode.data.buttons || [];\n          const hasButton = buttons.some(b => \n            b.action === 'goto' && b.target === connection.target\n          );\n          if (!hasButton) {\n            violations.push('Требуется кнопка для этой связи');\n            suggestions.push('Добавить кнопку перехода');\n          }\n        }\n      });\n\n      return {\n        connection,\n        isValid: violations.length === 0,\n        violations,\n        suggestions\n      };\n    });\n\n    return analysis;\n  }, [connections, nodes, rules]);\n\n  // Фильтрация связей\n  const filteredConnections = useMemo(() => {\n    return connectionAnalysis.filter(analysis => {\n      if (filterType === 'valid' && !analysis.isValid) return false;\n      if (filterType === 'invalid' && analysis.isValid) return false;\n      \n      if (searchTerm) {\n        const sourceNode = nodes.find(n => n.id === analysis.connection.source);\n        const targetNode = nodes.find(n => n.id === analysis.connection.target);\n        const searchLower = searchTerm.toLowerCase();\n        \n        return (\n          sourceNode?.type.toLowerCase().includes(searchLower) ||\n          targetNode?.type.toLowerCase().includes(searchLower) ||\n          analysis.violations.some(v => v.toLowerCase().includes(searchLower))\n        );\n      }\n      \n      return true;\n    });\n  }, [connectionAnalysis, filterType, searchTerm, nodes]);\n\n  // Статистика\n  const stats = useMemo(() => {\n    const total = connections.length;\n    const valid = connectionAnalysis.filter(a => a.isValid).length;\n    const invalid = total - valid;\n    const withButtons = connectionAnalysis.filter(a => {\n      const sourceNode = nodes.find(n => n.id === a.connection.source);\n      const buttons = sourceNode?.data.buttons || [];\n      return buttons.some(b => \n        b.action === 'goto' && b.target === a.connection.target\n      );\n    }).length;\n\n    return { total, valid, invalid, withButtons };\n  }, [connectionAnalysis, nodes]);\n\n  const getNodeName = useCallback((nodeId: string) => {\n    const node = nodes.find(n => n.id === nodeId);\n    if (!node) return 'Неизвестный узел';\n    \n    const typeNames = {\n      start: 'Старт',\n      command: node.data.command || 'Команда',\n      message: 'Сообщение',\n      keyboard: 'Клавиатура',\n      photo: 'Фото',\n      video: 'Видео',\n      audio: 'Аудио',\n      document: 'Документ',\n      condition: 'Условие',\n      input: 'Ввод',\n      'user-input': 'Пользовательский ввод',\n      sticker: 'Стикер',\n      voice: 'Голосовое',\n      animation: 'Анимация',\n      location: 'Геолокация',\n      contact: 'Контакт',\n      poll: 'Опрос',\n      dice: 'Кубик'\n    };\n    \n    return typeNames[node.type] || node.type;\n  }, [nodes]);\n\n  const fixConnection = useCallback((connection: Connection) => {\n    const sourceNode = nodes.find(n => n.id === connection.source);\n    const targetNode = nodes.find(n => n.id === connection.target);\n    \n    if (!sourceNode || !targetNode) return;\n\n    connectionManager.updateState({ nodes, connections });\n    \n    // Проверяем, нужна ли кнопка\n    const needsButton = rules.some(rule => \n      rule.sourceTypes.includes(sourceNode.type) && \n      rule.targetTypes.includes(targetNode.type) &&\n      rule.requiresButton\n    );\n\n    if (needsButton) {\n      const buttons = sourceNode.data.buttons || [];\n      const hasButton = buttons.some(b => \n        b.action === 'goto' && b.target === connection.target\n      );\n\n      if (!hasButton) {\n        const { updatedNodes } = connectionManager.createConnection(\n          connection.source,\n          connection.target,\n          { autoCreateButton: true }\n        );\n        onNodesChange(updatedNodes);\n      }\n    }\n  }, [connectionManager, nodes, connections, rules, onNodesChange]);\n\n  const deleteConnection = useCallback((connectionId: string) => {\n    connectionManager.updateState({ nodes, connections });\n    const { removedConnection, updatedNodes } = connectionManager.removeConnection(connectionId);\n    \n    if (removedConnection) {\n      onConnectionsChange(connections.filter(c => c.id !== connectionId));\n      onNodesChange(updatedNodes);\n      \n      if (selectedConnection?.id === connectionId) {\n        onConnectionSelect?.(null);\n      }\n    }\n  }, [connectionManager, nodes, connections, onConnectionsChange, onNodesChange, selectedConnection, onConnectionSelect]);\n\n  const applyRule = useCallback((rule: ConnectionRule) => {\n    connectionManager.updateState({ nodes, connections });\n    \n    const sourceNodes = nodes.filter(n => rule.sourceTypes.includes(n.type));\n    const targetNodes = nodes.filter(n => rule.targetTypes.includes(n.type));\n    \n    const newConnections: Connection[] = [];\n    let updatedNodes = [...nodes];\n\n    sourceNodes.forEach(sourceNode => {\n      const existingConnections = connections.filter(c => c.source === sourceNode.id);\n      const availableSlots = rule.maxConnections - existingConnections.length;\n      \n      if (availableSlots > 0) {\n        const suitableTargets = targetNodes.filter(targetNode => \n          targetNode.id !== sourceNode.id &&\n          !existingConnections.some(c => c.target === targetNode.id)\n        ).slice(0, availableSlots);\n\n        suitableTargets.forEach(targetNode => {\n          const { connection, updatedNodes: newUpdatedNodes } = connectionManager.createConnection(\n            sourceNode.id,\n            targetNode.id,\n            { autoCreateButton: rule.requiresButton }\n          );\n          \n          newConnections.push(connection);\n          updatedNodes = newUpdatedNodes;\n        });\n      }\n    });\n\n    if (newConnections.length > 0) {\n      onConnectionsChange([...connections, ...newConnections]);\n      onNodesChange(updatedNodes);\n    }\n  }, [connectionManager, nodes, connections, onConnectionsChange, onNodesChange]);\n\n  const validateAllConnections = useCallback(() => {\n    connectionManager.updateState({ nodes, connections });\n    const updatedNodes = connectionManager.syncButtonsWithConnections();\n    onNodesChange(updatedNodes);\n  }, [connectionManager, nodes, connections, onNodesChange]);\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Панель управления */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Link className=\"h-5 w-5\" />\n            Расширенное управление связями\n          </CardTitle>\n          <CardDescription>\n            Контроль качества и автоматизация связей между узлами\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {/* Статистика */}\n          <div className=\"grid grid-cols-4 gap-4 mb-4\">\n            <div className=\"text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n              <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">{stats.total}</div>\n              <div className=\"text-sm text-muted-foreground\">Всего связей</div>\n            </div>\n            <div className=\"text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg\">\n              <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">{stats.valid}</div>\n              <div className=\"text-sm text-muted-foreground\">Валидных</div>\n            </div>\n            <div className=\"text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg\">\n              <div className=\"text-2xl font-bold text-red-600 dark:text-red-400\">{stats.invalid}</div>\n              <div className=\"text-sm text-muted-foreground\">Требуют внимания</div>\n            </div>\n            <div className=\"text-center p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg\">\n              <div className=\"text-2xl font-bold text-yellow-600 dark:text-yellow-400\">{stats.withButtons}</div>\n              <div className=\"text-sm text-muted-foreground\">С кнопками</div>\n            </div>\n          </div>\n\n          {/* Фильтры и поиск */}\n          <div className=\"flex gap-2 mb-4\">\n            <Select value={filterType} onValueChange={(value: typeof filterType) => setFilterType(value)}>\n              <SelectTrigger className=\"w-40\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Все связи</SelectItem>\n                <SelectItem value=\"valid\">Валидные</SelectItem>\n                <SelectItem value=\"invalid\">Требуют внимания</SelectItem>\n              </SelectContent>\n            </Select>\n            \n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Поиск по типам узлов или проблемам...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n            \n            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n              <DialogTrigger asChild>\n                <UIButton variant=\"outline\">\n                  <Settings className=\"h-4 w-4 mr-2\" />\n                  Настройки\n                </UIButton>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-2xl\">\n                <DialogHeader>\n                  <DialogTitle>Настройки правил связей</DialogTitle>\n                  <DialogDescription>\n                    Управление правилами валидации и автоматического создания связей\n                  </DialogDescription>\n                </DialogHeader>\n                \n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label htmlFor=\"auto-button-creation\">Автоматическое создание кнопок</Label>\n                    <Switch\n                      id=\"auto-button-creation\"\n                      checked={autoButtonCreation}\n                      onCheckedChange={onAutoButtonCreationChange}\n                    />\n                  </div>\n                  \n                  <Separator />\n                  \n                  <div className=\"space-y-3\">\n                    <h4 className=\"font-medium\">Правила валидации</h4>\n                    {rules.map((rule) => (\n                      <div key={rule.id} className=\"p-3 border rounded-lg\">\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <h5 className=\"font-medium\">{rule.name}</h5>\n                          <div className=\"flex gap-2\">\n                            <UIButton\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => applyRule(rule)}\n                              disabled={!rule.autoApply}\n                            >\n                              <Zap className=\"h-4 w-4 mr-1\" />\n                              Применить\n                            </UIButton>\n                            <Switch\n                              checked={rule.autoApply}\n                              onCheckedChange={(checked) => {\n                                setRules(prev => prev.map(r => \n                                  r.id === rule.id ? { ...r, autoApply: checked } : r\n                                ));\n                              }}\n                            />\n                          </div>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground mb-2\">{rule.description}</p>\n                        <div className=\"flex gap-2\">\n                          <Badge variant=\"outline\">\n                            Макс. связей: {rule.maxConnections}\n                          </Badge>\n                          {rule.requiresButton && (\n                            <Badge variant=\"secondary\">Требует кнопки</Badge>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </DialogContent>\n            </Dialog>\n          </div>\n\n          {/* Инструменты */}\n          <div className=\"flex gap-2 mb-4\">\n            <UIButton onClick={validateAllConnections} variant=\"outline\">\n              <CheckCircle className=\"h-4 w-4 mr-2\" />\n              Синхронизировать все\n            </UIButton>\n            <UIButton \n              onClick={() => {\n                rules.filter(r => r.autoApply).forEach(applyRule);\n              }}\n              variant=\"outline\"\n            >\n              <Zap className=\"h-4 w-4 mr-2\" />\n              Применить автоправила\n            </UIButton>\n          </div>\n\n          {/* Список связей */}\n          <div className=\"space-y-2 max-h-80 overflow-y-auto\">\n            {filteredConnections.map(({ connection, isValid, violations, suggestions }) => (\n              <div\n                key={connection.id}\n                className={cn(\n                  \"p-3 border rounded-lg cursor-pointer transition-all hover:bg-accent\",\n                  selectedConnection?.id === connection.id && \"bg-accent border-primary\",\n                  !isValid && \"border-red-200 bg-red-50 dark:bg-red-900/10\"\n                )}\n                onClick={() => onConnectionSelect?.(connection)}\n              >\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      {isValid ? (\n                        <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                      ) : (\n                        <XCircle className=\"h-4 w-4 text-red-500\" />\n                      )}\n                      <span className=\"font-medium\">\n                        {getNodeName(connection.source)} → {getNodeName(connection.target)}\n                      </span>\n                    </div>\n                    \n                    {violations.length > 0 && (\n                      <div className=\"space-y-1\">\n                        {violations.map((violation, idx) => (\n                          <div key={idx} className=\"flex items-center gap-1\">\n                            <AlertTriangle className=\"h-3 w-3 text-red-500\" />\n                            <span className=\"text-xs text-red-600\">{violation}</span>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                    \n                    {suggestions.length > 0 && (\n                      <div className=\"flex gap-1 mt-1\">\n                        {suggestions.map((suggestion, idx) => (\n                          <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n                            {suggestion}\n                          </Badge>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                  \n                  <div className=\"flex gap-1 ml-2\">\n                    {!isValid && (\n                      <UIButton\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          fixConnection(connection);\n                        }}\n                      >\n                        <Edit3 className=\"h-4 w-4\" />\n                      </UIButton>\n                    )}\n                    <UIButton\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        deleteConnection(connection.id);\n                      }}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </UIButton>\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":21544},"server/telegram-client.ts":{"content":"import { TelegramClient } from 'telegram';\nimport { StringSession } from 'telegram/sessions';\nimport { Api } from 'telegram/tl';\nimport { db } from './db';\nimport { userTelegramSettings } from '@shared/schema';\nimport { eq } from 'drizzle-orm';\n\ninterface TelegramClientConfig {\n  apiId: string;\n  apiHash: string;\n  session?: string;\n  phoneNumber?: string;\n}\n\ninterface AuthStatus {\n  isAuthenticated: boolean;\n  phoneNumber?: string;\n  userId?: string;\n  needsCode?: boolean;\n  needsPassword?: boolean;\n}\n\nclass TelegramClientManager {\n  private clients: Map<string, TelegramClient> = new Map();\n  private sessions: Map<string, string> = new Map();\n  private authStatus: Map<string, AuthStatus> = new Map();\n\n  // Инициализация с восстановлением всех сессий\n  async initialize(): Promise<void> {\n    try {\n\n      const allSessions = await db.select().from(userTelegramSettings).where(eq(userTelegramSettings.isActive, 1));\n      \n      console.log(`🔄 Восстанавливаем ${allSessions.length} сессий из базы данных...`);\n      \n      for (const sessionData of allSessions) {\n        if (sessionData.sessionString && sessionData.userId) {\n          await this.restoreSession(sessionData.userId);\n        }\n      }\n      \n      console.log('✅ Все сессии восстановлены');\n    } catch (error) {\n      console.error('Ошибка при восстановлении сессий:', error);\n    }\n  }\n\n  // Сохранить сессию в базу данных\n  private async saveSessionToDatabase(userId: string, sessionString: string, phoneNumber: string): Promise<void> {\n    try {\n\n      const existing = await db.select().from(userTelegramSettings).where(eq(userTelegramSettings.userId, userId)).limit(1);\n      \n      if (existing.length > 0) {\n        await db.update(userTelegramSettings)\n          .set({ \n            sessionString, \n            phoneNumber,\n            updatedAt: new Date()\n          })\n          .where(eq(userTelegramSettings.userId, userId));\n      } else {\n        await db.insert(userTelegramSettings).values({\n          userId,\n          sessionString,\n          phoneNumber\n        });\n      }\n      console.log(`💾 Сессия сохранена в БД для пользователя ${phoneNumber}`);\n    } catch (error) {\n      console.error('Ошибка сохранения сессии в БД:', error);\n    }\n  }\n\n  // Загрузить сессию из базы данных\n  private async loadSessionFromDatabase(userId: string): Promise<string | null> {\n    try {\n\n      const result = await db.select().from(userTelegramSettings).where(eq(userTelegramSettings.userId, userId)).limit(1);\n      \n      if (result.length > 0 && result[0].sessionString) {\n        console.log(`🔄 Сессия загружена из БД для пользователя ${userId}`);\n        return result[0].sessionString;\n      }\n      return null;\n    } catch (error) {\n      console.error('Ошибка загрузки сессии из БД:', error);\n      return null;\n    }\n  }\n\n  // Восстановить клиент из сохраненной сессии\n  async restoreSession(userId: string): Promise<boolean> {\n    try {\n      const sessionString = await this.loadSessionFromDatabase(userId);\n      if (!sessionString) {\n        return false;\n      }\n\n      // Получаем credentials из базы данных\n\n      const result = await db.select().from(userTelegramSettings).where(eq(userTelegramSettings.userId, userId)).limit(1);\n      \n      if (result.length === 0 || !result[0].apiId || !result[0].apiHash) {\n        console.log(`❌ API credentials не найдены для пользователя ${userId}`);\n        return false;\n      }\n      \n      const apiId = result[0].apiId;\n      const apiHash = result[0].apiHash;\n\n      const stringSession = new StringSession(sessionString);\n      const client = new TelegramClient(stringSession, parseInt(apiId), apiHash, {\n        connectionRetries: 5,\n      });\n\n      await client.connect();\n      \n      // Проверяем, что сессия действительна\n      const me = await client.getMe();\n      if (me) {\n        this.clients.set(userId, client);\n        this.sessions.set(userId, sessionString);\n        this.authStatus.set(userId, {\n          isAuthenticated: true,\n          phoneNumber: (me as any).phone,\n          userId: userId,\n          needsCode: false,\n          needsPassword: false\n        });\n        console.log(`✅ Сессия восстановлена для пользователя ${userId}`);\n        return true;\n      }\n      return false;\n    } catch (error) {\n      console.error(`Ошибка восстановления сессии для ${userId}:`, error);\n      return false;\n    }\n  }\n\n  async sendCode(userId: string, phoneNumber: string): Promise<{ success: boolean; phoneCodeHash?: string; error?: string }> {\n    try {\n      // Получаем credentials из базы данных\n\n      const credentialsResult = await db.select().from(userTelegramSettings).where(eq(userTelegramSettings.userId, userId)).limit(1);\n      \n      if (credentialsResult.length === 0 || !credentialsResult[0].apiId || !credentialsResult[0].apiHash) {\n        throw new Error('Telegram API credentials not configured');\n      }\n      \n      const apiId = credentialsResult[0].apiId;\n      const apiHash = credentialsResult[0].apiHash;\n\n      const stringSession = new StringSession('');\n      const client = new TelegramClient(stringSession, parseInt(apiId), apiHash, {\n        connectionRetries: 5,\n      });\n\n      await client.connect();\n\n      const result = await client.invoke(\n        new Api.auth.SendCode({\n          phoneNumber: phoneNumber,\n          apiId: parseInt(apiId),\n          apiHash: apiHash,\n          settings: new Api.CodeSettings({\n            allowFlashcall: false,\n            currentNumber: false,\n            allowAppHash: false,\n          }),\n        })\n      );\n\n      // Сохраняем клиент и результат\n      this.clients.set(userId, client);\n      this.authStatus.set(userId, {\n        isAuthenticated: false,\n        phoneNumber: phoneNumber,\n        userId: userId,\n        needsCode: true,\n        needsPassword: false\n      });\n\n      console.log(`📱 Отправлен код подтверждения на номер ${phoneNumber}`);\n\n      return {\n        success: true,\n        phoneCodeHash: (result as any).phoneCodeHash\n      };\n\n    } catch (error: any) {\n      console.error('Ошибка отправки кода:', error);\n      return {\n        success: false,\n        error: error.message || 'Неизвестная ошибка при отправке кода'\n      };\n    }\n  }\n\n  async verifyCode(userId: string, phoneNumber: string, phoneCode: string, phoneCodeHash: string): Promise<{ success: boolean; error?: string; needsPassword?: boolean }> {\n    try {\n      const client = this.clients.get(userId);\n      if (!client) {\n        throw new Error('Клиент не найден. Сначала отправьте код.');\n      }\n\n      const result = await client.invoke(\n        new Api.auth.SignIn({\n          phoneNumber: phoneNumber,\n          phoneCodeHash: phoneCodeHash,\n          phoneCode: phoneCode,\n        })\n      );\n\n      // Сохраняем сессию\n      const sessionString = (client.session.save() as any) || '';\n      this.sessions.set(userId, sessionString);\n      await this.saveSessionToDatabase(userId, sessionString, phoneNumber);\n\n      // Обновляем статус авторизации\n      this.authStatus.set(userId, {\n        isAuthenticated: true,\n        phoneNumber: phoneNumber,\n        userId: userId,\n        needsCode: false,\n        needsPassword: false\n      });\n\n      console.log(`✅ Пользователь ${phoneNumber} успешно авторизован`);\n\n      return { success: true };\n\n    } catch (error: any) {\n      console.error('Ошибка проверки кода:', error);\n\n      // Проверяем, нужен ли пароль для 2FA\n      if (error.message && error.message.includes('SESSION_PASSWORD_NEEDED')) {\n        // Обновляем статус - требуется пароль\n        this.authStatus.set(userId, {\n          isAuthenticated: false,\n          phoneNumber: phoneNumber,\n          userId: userId,\n          needsCode: false,\n          needsPassword: true\n        });\n\n        console.log(`🔐 Требуется пароль 2FA для ${phoneNumber}`);\n        \n        return {\n          success: false,\n          needsPassword: true,\n          error: 'Требуется пароль двухфакторной аутентификации'\n        };\n      }\n\n      return {\n        success: false,\n        error: error.message || 'Неверный код подтверждения'\n      };\n    }\n  }\n\n  async verifyPassword(userId: string, password: string): Promise<{ success: boolean; error?: string }> {\n    try {\n      const client = this.clients.get(userId);\n      if (!client) {\n        throw new Error('Клиент не найден. Сначала отправьте код.');\n      }\n\n      const authStatus = this.authStatus.get(userId);\n      if (!authStatus || !authStatus.needsPassword) {\n        throw new Error('Проверка пароля не требуется.');\n      }\n\n      // Получаем данные для 2FA аутентификации\n      const passwordInfo = await client.invoke(new Api.account.GetPassword());\n      \n      // Импортируем необходимые модули для работы с SRP\n      const { computeCheck } = await import('telegram/Password');\n      \n      // Вычисляем правильный хеш пароля\n      const passwordCheck = await computeCheck(passwordInfo, password);\n      \n      // Используем прямой API вызов для проверки пароля\n      const result = await client.invoke(\n        new Api.auth.CheckPassword({\n          password: passwordCheck\n        })\n      );\n\n      // Сохраняем сессию\n      const sessionString = (client.session.save() as any) || '';\n      this.sessions.set(userId, sessionString);\n      await this.saveSessionToDatabase(userId, sessionString, authStatus.phoneNumber || '');\n\n      // Обновляем статус авторизации\n      this.authStatus.set(userId, {\n        isAuthenticated: true,\n        phoneNumber: authStatus.phoneNumber,\n        userId: userId,\n        needsCode: false,\n        needsPassword: false\n      });\n\n      console.log(`✅ Пользователь ${authStatus.phoneNumber} успешно авторизован с 2FA`);\n\n      return { success: true };\n\n    } catch (error: any) {\n      console.error('Ошибка проверки пароля:', error);\n      return {\n        success: false,\n        error: error.message === 'PASSWORD_HASH_INVALID' ? 'Неверный пароль' : (error.message || 'Ошибка авторизации')\n      };\n    }\n  }\n\n  async getAuthStatus(userId: string): Promise<AuthStatus & { hasCredentials?: boolean }> {\n    const status = this.authStatus.get(userId) || {\n      isAuthenticated: false,\n      needsCode: false,\n      needsPassword: false\n    };\n\n    // Проверяем наличие credentials в базе данных\n    try {\n\n      const result = await db.select().from(userTelegramSettings).where(eq(userTelegramSettings.userId, userId)).limit(1);\n      const hasCredentials = result.length > 0 && result[0].apiId && result[0].apiHash;\n      \n      return { ...status, hasCredentials };\n    } catch (error) {\n      console.error('Ошибка проверки credentials:', error);\n      return { ...status, hasCredentials: false };\n    }\n  }\n\n  async setCredentials(userId: string, apiId: string, apiHash: string): Promise<{ success: boolean; error?: string }> {\n    try {\n\n      const existing = await db.select().from(userTelegramSettings).where(eq(userTelegramSettings.userId, userId)).limit(1);\n      \n      if (existing.length > 0) {\n        await db.update(userTelegramSettings)\n          .set({ \n            apiId, \n            apiHash,\n            updatedAt: new Date()\n          })\n          .where(eq(userTelegramSettings.userId, userId));\n      } else {\n        await db.insert(userTelegramSettings).values({\n          userId,\n          apiId,\n          apiHash\n        });\n      }\n      \n      console.log(`💾 API credentials сохранены для пользователя ${userId}`);\n      return { success: true };\n    } catch (error: any) {\n      console.error('Ошибка сохранения credentials:', error);\n      return { \n        success: false, \n        error: error.message || 'Ошибка сохранения credentials' \n      };\n    }\n  }\n\n  async createClient(userId: string, config: TelegramClientConfig): Promise<TelegramClient> {\n    const { apiId, apiHash, session } = config;\n    \n    const stringSession = new StringSession(session || '');\n    const client = new TelegramClient(stringSession, parseInt(apiId), apiHash, {\n      connectionRetries: 5,\n    });\n\n    try {\n      await client.start({\n        phoneNumber: config.phoneNumber || '',\n        password: async () => {\n          throw new Error('2FA not supported in this implementation');\n        },\n        phoneCode: async () => {\n          throw new Error('Phone code verification not implemented');\n        },\n        onError: (err) => console.error('Telegram client error:', err),\n      });\n\n      this.clients.set(userId, client);\n      return client;\n    } catch (error) {\n      console.error('Failed to start Telegram client:', error);\n      throw error;\n    }\n  }\n\n  async getClient(userId: string): Promise<TelegramClient | null> {\n    return this.clients.get(userId) || null;\n  }\n\n  async getGroupMembers(userId: string, chatId: string | number): Promise<any[]> {\n    const client = await this.getClient(userId);\n    if (!client) {\n      throw new Error('Telegram client not found. Please authenticate first.');\n    }\n\n    const authStatus = await this.getAuthStatus(userId);\n    if (!authStatus.isAuthenticated) {\n      throw new Error('User not authenticated. Please complete phone verification first.');\n    }\n\n    try {\n      // Сначала попробуем получить сущность чата\n      let chatEntity: any;\n      \n      try {\n        // Попробуем получить чат по его ID или username\n        chatEntity = await client.getEntity(chatId);\n      } catch (entityError) {\n        console.log('Не удалось получить сущность чата напрямую, пробуем другие методы');\n        \n        // Если ID начинается с -100, это супергруппа\n        if (typeof chatId === 'string' && chatId.startsWith('-100')) {\n          const channelId = chatId.slice(4);\n          chatEntity = new Api.PeerChannel({ channelId: BigInt(channelId) });\n        } else {\n          throw new Error(`Не удалось найти чат с ID: ${chatId}`);\n        }\n      }\n\n      const result = await client.invoke(\n        new Api.channels.GetParticipants({\n          channel: chatEntity,\n          filter: new Api.ChannelParticipantsRecent(),\n          offset: 0,\n          limit: 200,\n          hash: BigInt(0),\n        })\n      );\n\n      if ('participants' in result) {\n        return result.participants.map((participant: any) => {\n          // Отладочная информация для понимания структуры данных\n          console.log('Participant structure:', {\n            participant: participant,\n            userId: participant.userId,\n            user_id: participant.user_id,\n            peer: participant.peer,\n            availableKeys: Object.keys(participant)\n          });\n          \n          // Попробуем разные способы извлечения user ID\n          const userId = participant.userId || participant.user_id || participant.peer?.user_id || participant.peer?.userId;\n          const user = result.users.find((u: any) => u.id?.toString() === userId?.toString());\n          \n          return {\n            id: userId?.toString(),\n            username: (user as any)?.username || null,\n            firstName: (user as any)?.firstName || null,\n            lastName: (user as any)?.lastName || null,\n            isBot: (user as any)?.bot || false,\n            status: this.getParticipantStatus(participant),\n            joinedAt: participant.date ? new Date(participant.date * 1000) : null,\n          };\n        });\n      }\n\n      return [];\n    } catch (error: any) {\n      console.error('Failed to get group members:', error);\n      throw new Error(`Failed to get group members: ${error.message || 'Unknown error'}`);\n    }\n  }\n\n  private getParticipantStatus(participant: any): string {\n    if (participant.className === 'ChannelParticipantCreator') return 'creator';\n    if (participant.className === 'ChannelParticipantAdmin') return 'administrator';\n    if (participant.className === 'ChannelParticipantBanned') return 'kicked';\n    return 'member';\n  }\n\n  async getChatInfo(userId: string, chatId: string | number): Promise<any> {\n    const client = await this.getClient(userId);\n    if (!client) {\n      throw new Error('Telegram client not found. Please authenticate first.');\n    }\n\n    try {\n      let chat: any;\n      if (typeof chatId === 'string' && chatId.startsWith('-100')) {\n        const channelId = parseInt(chatId.slice(4));\n        chat = channelId;\n      } else {\n        chat = chatId;\n      }\n\n      const result = await client.invoke(\n        new Api.channels.GetFullChannel({\n          channel: chat,\n        })\n      );\n\n      return {\n        id: result.fullChat.id.toString(),\n        title: (result.chats[0] as any)?.title || 'Unknown',\n        participantsCount: (result.fullChat as any)?.participantsCount,\n        about: (result.fullChat as any)?.about || '',\n        chatPhoto: (result.chats[0] as any)?.photo || null,\n      };\n    } catch (error: any) {\n      console.error('Failed to get chat info:', error);\n      throw new Error(`Failed to get chat info: ${error.message || 'Unknown error'}`);\n    }\n  }\n\n  async disconnect(userId: string): Promise<void> {\n    const client = this.clients.get(userId);\n    if (client) {\n      try {\n        await client.disconnect();\n        this.clients.delete(userId);\n        this.authStatus.delete(userId);\n        this.sessions.delete(userId);\n      } catch (error) {\n        console.error('Error disconnecting client:', error);\n      }\n    }\n  }\n\n  async saveSession(userId: string): Promise<string | null> {\n    const client = this.clients.get(userId);\n    if (client && client.session) {\n      return client.session.save() as string;\n    }\n    return null;\n  }\n\n  async setChatUsername(userId: string, chatId: string | number, username: string): Promise<any> {\n    const client = await this.getClient(userId);\n    if (!client) {\n      throw new Error('Telegram client not found. Please authenticate first.');\n    }\n\n    const authStatus = await this.getAuthStatus(userId);\n    if (!authStatus.isAuthenticated) {\n      throw new Error('User not authenticated. Please complete phone verification first.');\n    }\n\n    try {\n      // Получаем сущность чата\n      let chatEntity: any;\n      try {\n        chatEntity = await client.getEntity(chatId);\n      } catch (entityError) {\n        if (typeof chatId === 'string' && chatId.startsWith('-100')) {\n          const channelId = BigInt(chatId.slice(4));\n          chatEntity = new Api.PeerChannel({ channelId });\n        } else {\n          throw new Error(`Не удалось найти чат с ID: ${chatId}`);\n        }\n      }\n\n      // Устанавливаем username чата (делаем публичным или приватным)\n      const result = await client.invoke(\n        new Api.channels.UpdateUsername({\n          channel: chatEntity,\n          username: username || '', // Пустая строка делает группу приватной\n        })\n      );\n\n      return result;\n    } catch (error: any) {\n      console.error('Failed to set chat username:', error);\n      throw new Error(`Failed to set chat username: ${error.message || 'Unknown error'}`);\n    }\n  }\n\n  async setChatPhoto(userId: string, chatId: string | number, photoPath: string): Promise<any> {\n    const client = await this.getClient(userId);\n    if (!client) {\n      throw new Error('Telegram client not found. Please authenticate first.');\n    }\n\n    const authStatus = await this.getAuthStatus(userId);\n    if (!authStatus.isAuthenticated) {\n      throw new Error('User not authenticated. Please complete phone verification first.');\n    }\n\n    try {\n      // Читаем файл\n      const fs = await import('fs');\n      const photoBuffer = fs.readFileSync(photoPath);\n\n      // Загружаем файл в Telegram\n      const file = await client.uploadFile({\n        file: photoBuffer,\n        workers: 1,\n      });\n\n      // Получаем сущность чата\n      let chatEntity: any;\n      try {\n        chatEntity = await client.getEntity(chatId);\n      } catch (entityError) {\n        if (typeof chatId === 'string' && chatId.startsWith('-100')) {\n          const channelId = BigInt(chatId.slice(4));\n          chatEntity = new Api.PeerChannel({ channelId });\n        } else {\n          throw new Error(`Не удалось найти чат с ID: ${chatId}`);\n        }\n      }\n\n      // Устанавливаем фото чата\n      const result = await client.invoke(\n        new Api.channels.EditPhoto({\n          channel: chatEntity,\n          photo: file,\n        })\n      );\n\n      return result;\n    } catch (error: any) {\n      console.error('Failed to set chat photo:', error);\n      throw new Error(`Failed to set chat photo: ${error.message || 'Unknown error'}`);\n    }\n  }\n\n  // Исключить участника из группы через Client API\n  async kickMember(userId: string, chatId: string | number, memberId: string): Promise<any> {\n    const client = await this.getClient(userId);\n    if (!client) {\n      throw new Error('Telegram client not found. Please authenticate first.');\n    }\n\n    try {\n      // Получаем сущность чата\n      let chatEntity: any;\n      try {\n        chatEntity = await client.getEntity(chatId);\n      } catch (entityError) {\n        if (typeof chatId === 'string' && chatId.startsWith('-100')) {\n          const channelId = BigInt(chatId.slice(4));\n          chatEntity = new Api.PeerChannel({ channelId });\n        } else {\n          throw new Error(`Не удалось найти чат с ID: ${chatId}`);\n        }\n      }\n\n      // Получаем сущность пользователя\n      const userEntity = await client.getEntity(parseInt(memberId));\n\n      // Исключаем участника\n      const result = await client.invoke(\n        new Api.channels.EditBanned({\n          channel: chatEntity,\n          participant: userEntity,\n          bannedRights: new Api.ChatBannedRights({\n            untilDate: Math.floor(Date.now() / 1000) + 60, // Бан на 60 секунд (фактически исключение)\n            viewMessages: true,\n            sendMessages: true,\n            sendMedia: true,\n            sendStickers: true,\n            sendGifs: true,\n            sendGames: true,\n            sendInline: true,\n            embedLinks: true,\n            sendPolls: true,\n            changeInfo: true,\n            inviteUsers: true,\n            pinMessages: true,\n            manageTopics: true,\n          }),\n        })\n      );\n\n      return result;\n    } catch (error: any) {\n      console.error('Failed to kick member:', error);\n      throw new Error(`Failed to kick member: ${error.message || 'Unknown error'}`);\n    }\n  }\n\n  // Заблокировать участника через Client API\n  async banMember(userId: string, chatId: string | number, memberId: string, untilDate?: number): Promise<any> {\n    const client = await this.getClient(userId);\n    if (!client) {\n      throw new Error('Telegram client not found. Please authenticate first.');\n    }\n\n    try {\n      // Получаем сущность чата\n      let chatEntity: any;\n      try {\n        chatEntity = await client.getEntity(chatId);\n      } catch (entityError) {\n        if (typeof chatId === 'string' && chatId.startsWith('-100')) {\n          const channelId = BigInt(chatId.slice(4));\n          chatEntity = new Api.PeerChannel({ channelId });\n        } else {\n          throw new Error(`Не удалось найти чат с ID: ${chatId}`);\n        }\n      }\n\n      // Получаем сущность пользователя\n      const userEntity = await client.getEntity(parseInt(memberId));\n\n      // Блокируем участника\n      const result = await client.invoke(\n        new Api.channels.EditBanned({\n          channel: chatEntity,\n          participant: userEntity,\n          bannedRights: new Api.ChatBannedRights({\n            untilDate: untilDate || 0, // 0 = навсегда\n            viewMessages: true,\n            sendMessages: true,\n            sendMedia: true,\n            sendStickers: true,\n            sendGifs: true,\n            sendGames: true,\n            sendInline: true,\n            embedLinks: true,\n            sendPolls: true,\n            changeInfo: true,\n            inviteUsers: true,\n            pinMessages: true,\n            manageTopics: true,\n          }),\n        })\n      );\n\n      return result;\n    } catch (error: any) {\n      console.error('Failed to ban member:', error);\n      throw new Error(`Failed to ban member: ${error.message || 'Unknown error'}`);\n    }\n  }\n\n  // Ограничить участника (мут) через Client API\n  async restrictMember(userId: string, chatId: string | number, memberId: string, untilDate?: number): Promise<any> {\n    const client = await this.getClient(userId);\n    if (!client) {\n      throw new Error('Telegram client not found. Please authenticate first.');\n    }\n\n    try {\n      // Получаем сущность чата\n      let chatEntity: any;\n      try {\n        chatEntity = await client.getEntity(chatId);\n      } catch (entityError) {\n        if (typeof chatId === 'string' && chatId.startsWith('-100')) {\n          const channelId = BigInt(chatId.slice(4));\n          chatEntity = new Api.PeerChannel({ channelId });\n        } else {\n          throw new Error(`Не удалось найти чат с ID: ${chatId}`);\n        }\n      }\n\n      // Получаем сущность пользователя\n      const userEntity = await client.getEntity(parseInt(memberId));\n\n      // Ограничиваем участника\n      const result = await client.invoke(\n        new Api.channels.EditBanned({\n          channel: chatEntity,\n          participant: userEntity,\n          bannedRights: new Api.ChatBannedRights({\n            untilDate: untilDate || Math.floor(Date.now() / 1000) + 3600, // По умолчанию на 1 час\n            viewMessages: false, // Может видеть сообщения\n            sendMessages: true,  // Не может писать\n            sendMedia: true,\n            sendStickers: true,\n            sendGifs: true,\n            sendGames: true,\n            sendInline: true,\n            embedLinks: true,\n            sendPolls: true,\n            changeInfo: true,\n            inviteUsers: true,\n            pinMessages: true,\n            manageTopics: true,\n          }),\n        })\n      );\n\n      return result;\n    } catch (error: any) {\n      console.error('Failed to restrict member:', error);\n      throw new Error(`Failed to restrict member: ${error.message || 'Unknown error'}`);\n    }\n  }\n\n  // Назначить участника администратором через Client API  \n  async promoteMember(userId: string, chatId: string | number, memberId: string, adminRights: any): Promise<any> {\n    const client = await this.getClient(userId);\n    if (!client) {\n      throw new Error('Telegram client not found. Please authenticate first.');\n    }\n\n    try {\n      // Получаем сущность чата\n      let chatEntity: any;\n      try {\n        chatEntity = await client.getEntity(chatId);\n      } catch (entityError) {\n        if (typeof chatId === 'string' && chatId.startsWith('-100')) {\n          const channelId = BigInt(chatId.slice(4));\n          chatEntity = new Api.PeerChannel({ channelId });\n        } else {\n          throw new Error(`Не удалось найти чат с ID: ${chatId}`);\n        }\n      }\n\n      // Получаем сущность пользователя\n      const userEntity = await client.getEntity(parseInt(memberId));\n\n      // Назначаем администратором\n      const result = await client.invoke(\n        new Api.channels.EditAdmin({\n          channel: chatEntity,\n          userId: userEntity,\n          adminRights: new Api.ChatAdminRights({\n            changeInfo: adminRights.can_change_info || false,\n            postMessages: adminRights.can_post_messages || false,\n            editMessages: adminRights.can_edit_messages || false,\n            deleteMessages: adminRights.can_delete_messages || false,\n            banUsers: adminRights.can_restrict_members || false,\n            inviteUsers: adminRights.can_invite_users || false,\n            pinMessages: adminRights.can_pin_messages || false,\n            addAdmins: adminRights.can_promote_members || false,\n            manageCall: adminRights.can_manage_video_chats || false,\n            anonymous: adminRights.can_be_anonymous || false,\n            manageTopics: adminRights.can_manage_topics || false,\n            postStories: adminRights.can_post_stories || false,\n            editStories: adminRights.can_edit_stories || false,\n            deleteStories: adminRights.can_delete_stories || false,\n          }),\n          rank: adminRights.custom_title || ''\n        })\n      );\n\n      return result;\n    } catch (error: any) {\n      console.error('Failed to promote member:', error);\n      throw new Error(`Failed to promote member: ${error.message || 'Unknown error'}`);\n    }\n  }\n\n  // Снять администраторские права через Client API\n  async demoteMember(userId: string, chatId: string | number, memberId: string): Promise<any> {\n    const client = await this.getClient(userId);\n    if (!client) {\n      throw new Error('Telegram client not found. Please authenticate first.');\n    }\n\n    try {\n      // Получаем сущность чата\n      let chatEntity: any;\n      try {\n        chatEntity = await client.getEntity(chatId);\n      } catch (entityError) {\n        if (typeof chatId === 'string' && chatId.startsWith('-100')) {\n          const channelId = BigInt(chatId.slice(4));\n          chatEntity = new Api.PeerChannel({ channelId });\n        } else {\n          throw new Error(`Не удалось найти чат с ID: ${chatId}`);\n        }\n      }\n\n      // Получаем сущность пользователя\n      const userEntity = await client.getEntity(parseInt(memberId));\n\n      // Снимаем администраторские права (устанавливаем пустые права)\n      const result = await client.invoke(\n        new Api.channels.EditAdmin({\n          channel: chatEntity,\n          userId: userEntity,\n          adminRights: new Api.ChatAdminRights({\n            changeInfo: false,\n            postMessages: false,\n            editMessages: false,\n            deleteMessages: false,\n            banUsers: false,\n            inviteUsers: false,\n            pinMessages: false,\n            addAdmins: false,\n            manageCall: false,\n            anonymous: false,\n            manageTopics: false,\n            postStories: false,\n            editStories: false,\n            deleteStories: false,\n          }),\n          rank: ''\n        })\n      );\n\n      return result;\n    } catch (error: any) {\n      console.error('Failed to demote member:', error);\n      throw new Error(`Failed to demote member: ${error.message || 'Unknown error'}`);\n    }\n  }\n}\n\nexport const telegramClientManager = new TelegramClientManager();\n\n// Экспортируем функцию для ручной инициализации из routes.ts\nexport function initializeTelegramManager() {\n  return telegramClientManager.initialize();\n}","size_bytes":32746},"client/src/components/editor/save-template-modal.tsx":{"content":"import React, { useState } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Badge } from '@/components/ui/badge';\nimport { Save, Loader2 } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { useMutation, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport type { BotData } from '@/types/bot';\n\ninterface SaveTemplateModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  botData: BotData;\n  projectName?: string;\n}\n\ninterface TemplateFormData {\n  name: string;\n  description: string;\n  category: string;\n  isPublic: boolean;\n}\n\nexport function SaveTemplateModal({ isOpen, onClose, botData, projectName }: SaveTemplateModalProps) {\n  const [formData, setFormData] = useState<TemplateFormData>({\n    name: projectName ? `${projectName} - Шаблон` : 'Новый шаблон',\n    description: '',\n    category: 'custom',\n    isPublic: false,\n  });\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Функция для вычисления статистики с поддержкой многолистовых шаблонов\n  const getStats = (data: BotData | any) => {\n    let nodes: any[] = [];\n    let connections: any[] = [];\n    \n    // Проверяем, это многолистовой шаблон или обычный\n    if (data.sheets && Array.isArray(data.sheets)) {\n      // Многолистовой шаблон - собираем все узлы и связи из всех листов\n      data.sheets.forEach((sheet: any) => {\n        if (sheet.nodes) nodes.push(...sheet.nodes);\n        if (sheet.connections) connections.push(...sheet.connections);\n      });\n      // Добавляем межлистовые связи\n      if (data.interSheetConnections) {\n        connections.push(...data.interSheetConnections);\n      }\n    } else {\n      // Обычный шаблон\n      nodes = data.nodes || [];\n      connections = data.connections || [];\n    }\n    \n    return {\n      nodes: nodes.length,\n      connections: connections.length,\n      commands: nodes.filter(node => node.data?.command).length,\n      buttons: nodes.reduce((acc, node) => acc + (node.data?.buttons?.length || 0), 0),\n    };\n  };\n\n  const stats = getStats(botData);\n\n  const saveTemplateMutation = useMutation({\n    mutationFn: async (data: TemplateFormData) => {\n      return await apiRequest('POST', '/api/templates', {\n        name: data.name,\n        description: data.description,\n        category: data.category,\n        tags: [],\n        isPublic: data.isPublic ? 1 : 0,\n        difficulty: 'easy',\n        language: 'ru',\n        requiresToken: 1,\n        complexity: 1,\n        estimatedTime: 5,\n        authorName: 'Пользователь',\n        featured: 0,\n        data: botData,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/templates'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/templates/category/custom'] });\n      toast({\n        title: 'Шаблон сохранен',\n        description: 'Ваш шаблон бота успешно сохранен',\n      });\n      onClose();\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: 'Ошибка',\n        description: 'Не удалось сохранить шаблон',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: projectName ? `${projectName} - Шаблон` : 'Новый шаблон',\n      description: '',\n      category: 'custom',\n      isPublic: false,\n    });\n  };\n\n\n  const handleSave = () => {\n    if (!formData.name.trim()) {\n      toast({\n        title: 'Ошибка',\n        description: 'Название шаблона обязательно',\n        variant: 'destructive',\n      });\n      return;\n    }\n    saveTemplateMutation.mutate(formData);\n  };\n\n  const categories = [\n    { value: 'custom', label: 'Пользовательский' },\n    { value: 'business', label: 'Бизнес' },\n    { value: 'utility', label: 'Утилиты' },\n    { value: 'games', label: 'Игры' },\n  ];\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Save className=\"h-5 w-5\" />\n            Сохранить как шаблон\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-6 py-4\">\n          {/* Название */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"name\">Название шаблона</Label>\n            <Input\n              id=\"name\"\n              value={formData.name}\n              onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n              placeholder=\"Введите название шаблона\"\n            />\n          </div>\n\n          {/* Описание */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"description\">Описание</Label>\n            <Textarea\n              id=\"description\"\n              value={formData.description}\n              onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\n              placeholder=\"Краткое описание того, для чего предназначен этот шаблон\"\n              rows={3}\n            />\n          </div>\n\n          {/* Категория */}\n          <div className=\"space-y-2\">\n            <Label>Категория</Label>\n            <Select\n              value={formData.category}\n              onValueChange={(value) => setFormData(prev => ({ ...prev, category: value }))}\n            >\n              <SelectTrigger>\n                <SelectValue placeholder=\"Выберите категорию\" />\n              </SelectTrigger>\n              <SelectContent>\n                {categories.map((category) => (\n                  <SelectItem key={category.value} value={category.value}>\n                    {category.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Публичность */}\n          <div className=\"flex items-center space-x-2\">\n            <input\n              id=\"isPublic\"\n              type=\"checkbox\"\n              checked={formData.isPublic}\n              onChange={(e) => setFormData(prev => ({ ...prev, isPublic: e.target.checked }))}\n              className=\"h-4 w-4\"\n            />\n            <Label htmlFor=\"isPublic\">\n              Сделать шаблон публичным (другие пользователи смогут его использовать)\n            </Label>\n          </div>\n\n          {/* Статистика бота */}\n          <div className=\"p-4 bg-muted rounded-lg\">\n            <h4 className=\"font-medium mb-2\">Информация о шаблоне:</h4>\n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\n              <div>\n                <span className=\"text-muted-foreground\">Узлов:</span>\n                <span className=\"ml-2 font-medium\">{stats.nodes}</span>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Связей:</span>\n                <span className=\"ml-2 font-medium\">{stats.connections}</span>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Команд:</span>\n                <span className=\"ml-2 font-medium\">{stats.commands}</span>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Кнопок:</span>\n                <span className=\"ml-2 font-medium\">{stats.buttons}</span>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>\n            Отмена\n          </Button>\n          <Button\n            onClick={handleSave}\n            disabled={saveTemplateMutation.isPending || !formData.name.trim()}\n          >\n            {saveTemplateMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n            Сохранить шаблон\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}","size_bytes":8785},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h3\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <p\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }","size_bytes":1876},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/editor/export-panel.tsx":{"content":"import { Button } from '@/components/ui/button';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\nimport { useIsMobile } from '@/hooks/use-mobile';\nimport { BotData, BotGroup } from '@shared/schema';\nimport { useState, useEffect, useMemo } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';\nimport { vscDarkPlus, vs } from 'react-syntax-highlighter/dist/esm/styles/prism';\n\n// Динамический импорт тяжелых генераторов для улучшения производительности\nconst loadBotGenerator = () => import('@/lib/bot-generator');\nconst loadCommands = () => import('@/lib/commands');\n\ninterface ExportPanelProps {\n  botData: BotData;\n  projectName: string;\n  projectId: number;\n}\n\ntype ExportFormat = 'python' | 'json' | 'requirements' | 'readme' | 'dockerfile' | 'config';\n\nexport function ExportPanel({ botData, projectName, projectId }: ExportPanelProps) {\n  const [generatedCode, setGeneratedCode] = useState('');\n  const [selectedFormat, setSelectedFormat] = useState<ExportFormat>('python');\n  const [exportContent, setExportContent] = useState<Record<ExportFormat, string>>({\n    python: '',\n    json: '',\n    requirements: '',\n    readme: '',\n    dockerfile: '',\n    config: ''\n  });\n  const [validationResult, setValidationResult] = useState<{ isValid: boolean; errors: string[] }>({ isValid: true, errors: [] });\n  const [botFatherCommands, setBotFatherCommands] = useState('');\n  const [theme, setTheme] = useState<'light' | 'dark'>('light');\n  const { toast } = useToast();\n  const isMobile = useIsMobile();\n\n  // Определяем тему из DOM\n  useEffect(() => {\n    const checkTheme = () => {\n      const isDark = document.documentElement.classList.contains('dark');\n      setTheme(isDark ? 'dark' : 'light');\n    };\n    \n    checkTheme();\n    \n    const observer = new MutationObserver(checkTheme);\n    observer.observe(document.documentElement, {\n      attributes: true,\n      attributeFilter: ['class']\n    });\n    \n    return () => observer.disconnect();\n  }, []);\n\n  // Загрузка групп\n  const { data: groups = [] } = useQuery<BotGroup[]>({\n    queryKey: ['/api/groups'],\n  });\n\n  // Функция для сбора всех узлов из всех листов проекта\n  const getAllNodes = (data: BotData) => {\n    if (!data) return [];\n    \n    if ((data as any).sheets && Array.isArray((data as any).sheets)) {\n      // Многолистовой проект - собираем узлы из всех листов\n      let allNodes: any[] = [];\n      (data as any).sheets.forEach((sheet: any) => {\n        if (sheet.nodes && Array.isArray(sheet.nodes)) {\n          allNodes = allNodes.concat(sheet.nodes);\n        }\n      });\n      return allNodes;\n    } else {\n      // Обычный проект\n      return data.nodes || [];\n    }\n  };\n\n  // Статистика бота с учетом всех листов проекта\n  const allNodes = getAllNodes(botData);\n  const botStats = {\n    totalNodes: allNodes.length,\n    commandNodes: allNodes.filter(node => node.type === 'start' || node.type === 'command').length,\n    messageNodes: allNodes.filter(node => node.type === 'message').length,\n    photoNodes: allNodes.filter(node => node.type === 'photo').length,\n    keyboardNodes: allNodes.filter(node => node.data?.keyboardType !== 'none').length,\n    totalButtons: allNodes.reduce((sum, node) => sum + (node.data?.buttons?.length || 0), 0),\n    commandsInMenu: allNodes.filter(node => \n      (node.type === 'start' || node.type === 'command') && node.data?.showInMenu\n    ).length,\n    adminOnlyCommands: allNodes.filter(node => \n      (node.type === 'start' || node.type === 'command') && node.data?.adminOnly\n    ).length,\n    privateOnlyCommands: allNodes.filter(node => \n      (node.type === 'start' || node.type === 'command') && node.data?.isPrivateOnly\n    ).length\n  };\n\n  // Асинхронная ленивая генерация экспорта - только когда нужен конкретный формат\n  const generateExportContent = useMemo(() => {\n    if (!botData) return {};\n    \n    return {\n      python: async () => {\n        const botGenerator = await loadBotGenerator();\n        const validation = botGenerator.validateBotStructure(botData);\n        setValidationResult(validation || { isValid: false, errors: [] });\n        \n        if (!validation?.isValid) return '';\n        return botGenerator.generatePythonCode(botData, projectName, groups);\n      },\n      json: async () => JSON.stringify(botData, null, 2),\n      requirements: async () => {\n        const botGenerator = await loadBotGenerator();\n        return botGenerator.generateRequirementsTxt();\n      },\n      readme: async () => {\n        const botGenerator = await loadBotGenerator();\n        return botGenerator.generateReadme(botData, projectName);\n      },\n      dockerfile: async () => {\n        const botGenerator = await loadBotGenerator();\n        return botGenerator.generateDockerfile();\n      },\n      config: async () => {\n        const botGenerator = await loadBotGenerator();\n        return botGenerator.generateConfigYaml(projectName);\n      }\n    };\n  }, [botData, projectName, groups]);\n\n  // Асинхронное получение контента для выбранного формата\n  useEffect(() => {\n    async function loadContent() {\n      if (!generateExportContent[selectedFormat] || exportContent[selectedFormat]) return;\n      \n      try {\n        const content = await generateExportContent[selectedFormat]();\n        setExportContent(prev => ({ ...prev, [selectedFormat]: content }));\n        \n        // Для Python также устанавливаем основной код\n        if (selectedFormat === 'python') {\n          setGeneratedCode(content);\n        }\n      } catch (error) {\n        console.error('Error loading export content:', error);\n        toast({\n          title: \"Ошибка генерации\",\n          description: \"Не удалось сгенерировать контент для экспорта\",\n          variant: \"destructive\",\n        });\n      }\n    }\n    \n    loadContent();\n  }, [generateExportContent, selectedFormat, exportContent, toast]);\n\n  // Получение текущего контента\n  const getCurrentContent = () => {\n    return exportContent[selectedFormat] || '';\n  };\n\n  // Получение свежих данных проекта с нормализацией\n  const [freshBotData, setFreshBotData] = useState<BotData | null>(null);\n  \n  useEffect(() => {\n    async function loadFreshProjectData() {\n      try {\n        console.log('🔄 ExportPanel: Загружаем свежие данные проекта из API...');\n        const response = await fetch(`/api/projects/${projectId}`);\n        if (response.ok) {\n          const project = await response.json();\n          console.log('📡 ExportPanel: Данные проекта получены:', project);\n          // Устанавливаем свежие данные с нормализацией\n          if (project.data) {\n            console.log('✅ ExportPanel: Устанавливаем свежие данные:', project.data);\n            setFreshBotData(project.data);\n          }\n        } else {\n          console.error('❌ ExportPanel: Ошибка загрузки данных проекта:', response.status);\n        }\n      } catch (error) {\n        console.error('Error loading fresh project data:', error);\n      }\n    }\n    \n    loadFreshProjectData();\n  }, [projectId]);\n\n  // Генерация команд BotFather с использованием свежих данных\n  useEffect(() => {\n    async function loadBotFatherCommands() {\n      const dataToUse = freshBotData || botData;\n      if (dataToUse) {\n        try {\n          const commands = await loadCommands();\n          console.log('🔍 ExportPanel: Полные данные для генерации команд:', dataToUse);\n          \n          // Собираем узлы из всех листов проекта\n          let nodes: any[] = [];\n          if ((dataToUse as any).sheets && Array.isArray((dataToUse as any).sheets)) {\n            // Многолистовой проект - собираем узлы из всех листов\n            console.log('📊 ExportPanel: Найдено листов:', (dataToUse as any).sheets.length);\n            (dataToUse as any).sheets.forEach((sheet: any, index: number) => {\n              console.log(`📋 ExportPanel: Лист ${index + 1} (${sheet.name || sheet.id}):`, sheet.nodes?.length || 0, 'узлов');\n              if (sheet.nodes && Array.isArray(sheet.nodes)) {\n                nodes = nodes.concat(sheet.nodes);\n              }\n            });\n          } else {\n            console.log('📋 ExportPanel: Обычный проект, узлов:', dataToUse.nodes?.length || 0);\n            // Обычный проект\n            nodes = dataToUse.nodes || [];\n          }\n          \n          console.log('🎯 ExportPanel: ИТОГО узлов из всех листов:', nodes.length);\n\n          const commandNodes = nodes.filter((node: any) => \n            (node.type === 'start' || node.type === 'command') && \n            node.data?.command &&\n            (node.data?.showInMenu !== false)\n          );\n          console.log('🎯 ExportPanel: Команды для меню BotFather:', commandNodes.length, 'команд');\n          \n          const botFatherCmds = commands.generateBotFatherCommands(commandNodes);\n          setBotFatherCommands(botFatherCmds);\n        } catch (error) {\n          console.error('Error loading BotFather commands:', error);\n        }\n      }\n    }\n    \n    loadBotFatherCommands();\n  }, [freshBotData, botData]);\n\n  const getFileExtension = (format: ExportFormat): string => {\n    const extensions = {\n      python: 'py',\n      json: 'json',\n      requirements: 'txt',\n      readme: 'md',\n      dockerfile: '',\n      config: 'yaml'\n    };\n    return extensions[format];\n  };\n\n  const getFileName = (format: ExportFormat): string => {\n    const baseFileName = projectName.replace(/\\s+/g, '_');\n    const names = {\n      python: `${baseFileName}_bot.py`,\n      json: `${baseFileName}_data.json`,\n      requirements: 'requirements.txt',\n      readme: 'README.md',\n      dockerfile: 'Dockerfile',\n      config: 'config.yaml'\n    };\n    return names[format];\n  };\n\n  const copyToClipboard = async (content?: string) => {\n    const textToCopy = content || getCurrentContent();\n    try {\n      await navigator.clipboard.writeText(textToCopy);\n      toast({\n        title: \"Содержимое скопировано!\",\n        description: \"Содержимое скопировано в буфер обмена\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Ошибка копирования\",\n        description: \"Не удалось скопировать содержимое в буфер обмена\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const downloadFile = async (format?: ExportFormat) => {\n    const formatToDownload = format || selectedFormat;\n    const content = formatToDownload === selectedFormat ? getCurrentContent() : \n      (generateExportContent[formatToDownload] ? await generateExportContent[formatToDownload]() : '');\n    const fileName = getFileName(formatToDownload);\n    \n    const blob = new Blob([content], { type: 'text/plain' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = fileName;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n    \n    toast({\n      title: \"Файл загружен!\",\n      description: `Файл ${fileName} сохранен`,\n    });\n  };\n\n  const downloadAllFiles = () => {\n    const formats: ExportFormat[] = ['python', 'json', 'requirements', 'readme', 'dockerfile', 'config'];\n    formats.forEach(format => {\n      setTimeout(() => downloadFile(format), formats.indexOf(format) * 100);\n    });\n    \n    toast({\n      title: \"Все файлы загружены!\",\n      description: \"Полный проект бота загружен\",\n    });\n  };\n\n  const renderMarkdown = (text: string) => {\n    return text.split('\\n').map((line, i) => {\n      if (line.startsWith('# ')) {\n        return <h1 key={i} className=\"text-2xl font-bold mt-4 mb-2\">{line.slice(2)}</h1>;\n      } else if (line.startsWith('## ')) {\n        return <h2 key={i} className=\"text-xl font-bold mt-3 mb-2\">{line.slice(3)}</h2>;\n      } else if (line.startsWith('### ')) {\n        return <h3 key={i} className=\"text-lg font-semibold mt-2 mb-1\">{line.slice(4)}</h3>;\n      } else if (line.startsWith('- ')) {\n        return <li key={i} className=\"ml-4\">{line.slice(2)}</li>;\n      } else if (line.trim() === '') {\n        return <br key={i} />;\n      } else {\n        return <p key={i} className=\"my-1\">{line}</p>;\n      }\n    });\n  };\n\n  return (\n    <div className=\"h-full bg-background overflow-auto\">\n      <div className=\"p-6\">\n        <div className=\"max-w-7xl mx-auto\">\n          <div className=\"mb-6\">\n            <h1 className=\"text-2xl font-bold flex items-center space-x-3\">\n              <i className=\"fas fa-download text-primary\"></i>\n              <span>Экспорт кода бота</span>\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">Загрузите готовый код бота и документацию для развертывания</p>\n          </div>\n\n          <Tabs defaultValue=\"stats\" className=\"mt-4\">\n            {isMobile ? (\n              <div className=\"flex-shrink-0 space-y-2\">\n                <TabsList className=\"grid w-full grid-cols-3 h-auto gap-1\">\n                  <TabsTrigger value=\"stats\" className=\"text-xs py-2 px-1\" data-testid=\"tab-stats\">Статистика</TabsTrigger>\n                  <TabsTrigger value=\"validation\" className=\"text-xs py-2 px-1\" data-testid=\"tab-validation\">Валидация</TabsTrigger>\n                  <TabsTrigger value=\"files\" className=\"text-xs py-2 px-1\" data-testid=\"tab-files\">Файлы</TabsTrigger>\n                </TabsList>\n                <TabsList className=\"grid w-full grid-cols-2 h-auto gap-1\">\n                  <TabsTrigger value=\"setup\" className=\"text-xs py-2 px-1\" data-testid=\"tab-setup\">Настройка</TabsTrigger>\n                  <TabsTrigger value=\"export\" className=\"text-xs py-2 px-1\" data-testid=\"tab-export\">Экспорт</TabsTrigger>\n                </TabsList>\n              </div>\n            ) : (\n              <TabsList className=\"grid w-full grid-cols-5 flex-shrink-0\">\n                <TabsTrigger value=\"stats\" data-testid=\"tab-stats\">Статистика</TabsTrigger>\n                <TabsTrigger value=\"validation\" data-testid=\"tab-validation\">Валидация</TabsTrigger>\n                <TabsTrigger value=\"files\" data-testid=\"tab-files\">Файлы</TabsTrigger>\n                <TabsTrigger value=\"export\" data-testid=\"tab-export\">Экспорт</TabsTrigger>\n                <TabsTrigger value=\"setup\" data-testid=\"tab-setup\">Настройка</TabsTrigger>\n              </TabsList>\n            )}\n\n            <TabsContent value=\"stats\" className=\"space-y-4 mt-4\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center space-x-2\">\n                    <i className=\"fas fa-chart-bar text-blue-500\"></i>\n                    <span>Статистика бота</span>\n                  </CardTitle>\n                  <CardDescription>Обзор структуры и компонентов вашего бота</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'grid-cols-2 md:grid-cols-3 gap-4'}`}>\n                    <div className={`bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                      <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-blue-600 dark:text-blue-400`}>{botStats.totalNodes}</div>\n                      <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-blue-700 dark:text-blue-300`}>Всего узлов</div>\n                    </div>\n                    <div className={`bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                      <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-green-600 dark:text-green-400`}>{botStats.commandNodes}</div>\n                      <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-green-700 dark:text-green-300`}>Команд</div>\n                    </div>\n                    <div className={`bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                      <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-purple-600 dark:text-purple-400`}>{botStats.totalButtons}</div>\n                      <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-purple-700 dark:text-purple-300`}>Кнопок</div>\n                    </div>\n                    <div className={`bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                      <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-amber-600 dark:text-amber-400`}>{botStats.keyboardNodes}</div>\n                      <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-amber-700 dark:text-amber-300`}>С клавиатурой</div>\n                    </div>\n                    <div className={`bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                      <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-indigo-600 dark:text-indigo-400`}>{botStats.commandsInMenu}</div>\n                      <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-indigo-700 dark:text-indigo-300`}>В меню</div>\n                    </div>\n                    <div className={`bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg ${isMobile ? 'p-4 flex items-center space-x-3' : 'p-3'}`}>\n                      <div className={`${isMobile ? 'text-2xl' : 'text-2xl'} font-bold text-red-600 dark:text-red-400`}>{botStats.adminOnlyCommands}</div>\n                      <div className={`${isMobile ? 'text-base font-medium' : 'text-sm'} text-red-700 dark:text-red-300`}>Только админ</div>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"validation\" className=\"space-y-4 mt-4\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center space-x-2\">\n                    {validationResult.isValid ? (\n                      <i className=\"fas fa-check-circle text-green-500\"></i>\n                    ) : (\n                      <i className=\"fas fa-exclamation-triangle text-red-500\"></i>\n                    )}\n                    <span>Проверка структуры бота</span>\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {validationResult.isValid ? (\n                    <div className=\"flex items-center space-x-2 text-green-600 dark:text-green-400 p-4 bg-green-50 dark:bg-green-950/30 rounded-lg border border-green-200 dark:border-green-800/40\">\n                      <i className=\"fas fa-check-circle\"></i>\n                      <span className=\"font-medium\">Структура бота корректна и готова к экспорту!</span>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-4\">\n                      <div className=\"flex items-center space-x-2 text-red-600 dark:text-red-400 p-3 bg-red-50 dark:bg-red-950/30 rounded-lg border border-red-200 dark:border-red-800/40\">\n                        <i className=\"fas fa-exclamation-triangle\"></i>\n                        <span className=\"font-medium\">Найдены ошибки в структуре бота:</span>\n                      </div>\n                      <div className=\"space-y-2\">\n                        {(validationResult.errors || []).map((error, index) => (\n                          <div key={index} className=\"flex items-start space-x-2 p-3 bg-red-50 dark:bg-red-950/20 rounded border-l-4 border-red-200 dark:border-red-800/60\">\n                            <i className=\"fas fa-times-circle text-red-500 dark:text-red-400 mt-0.5\"></i>\n                            <span className=\"text-sm text-red-700 dark:text-red-300\">{error}</span>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"files\" className=\"space-y-4 mt-4\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center space-x-2\">\n                    <i className=\"fas fa-file-archive text-blue-500\"></i>\n                    <span>Экспорт файлов проекта</span>\n                  </CardTitle>\n                  <CardDescription>Выберите формат для экспорта или загрузите все файлы</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className={`${isMobile ? 'flex flex-col space-y-4' : 'flex items-center justify-between'}`}>\n                    <div className={`${isMobile ? 'w-full' : 'flex items-center space-x-4'}`}>\n                      <Select value={selectedFormat} onValueChange={(value: ExportFormat) => setSelectedFormat(value)}>\n                        <SelectTrigger className={`${isMobile ? 'w-full h-12 text-base' : 'w-[200px]'}`} data-testid=\"select-format-files\">\n                          <SelectValue placeholder=\"Выберите формат\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"python\">Python код (.py)</SelectItem>\n                          <SelectItem value=\"json\">JSON данные (.json)</SelectItem>\n                          <SelectItem value=\"requirements\">Зависимости (.txt)</SelectItem>\n                          <SelectItem value=\"readme\">Документация (.md)</SelectItem>\n                          <SelectItem value=\"dockerfile\">Dockerfile</SelectItem>\n                          <SelectItem value=\"config\">Конфигурация (.yaml)</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    \n                    <div className={`flex ${isMobile ? 'w-full' : ''} space-x-2`}>\n                      <Button onClick={() => copyToClipboard()} variant=\"outline\" className={isMobile ? 'flex-1' : ''} data-testid=\"button-copy-files\">\n                        <i className=\"fas fa-copy mr-2\"></i>\n                        Копировать\n                      </Button>\n                      <Button onClick={() => downloadFile()} className={isMobile ? 'flex-1' : ''} data-testid=\"button-download-files\">\n                        <i className=\"fas fa-download mr-2\"></i>\n                        Скачать\n                      </Button>\n                    </div>\n                  </div>\n                  \n                  <div className=\"relative\">\n                    <div className={`${isMobile ? 'h-48' : 'h-[400px]'} overflow-auto rounded border border-slate-300 dark:border-slate-700`}>\n                      {selectedFormat === 'python' ? (\n                        <SyntaxHighlighter\n                          language=\"python\"\n                          style={theme === 'dark' ? vscDarkPlus : vs}\n                          showLineNumbers={true}\n                          wrapLines={true}\n                          customStyle={{\n                            margin: 0,\n                            fontSize: '12px',\n                            lineHeight: '1.5',\n                            background: 'transparent',\n                            height: '100%'\n                          }}\n                          data-testid=\"syntax-highlighter-export-python\"\n                        >\n                          {getCurrentContent()}\n                        </SyntaxHighlighter>\n                      ) : (\n                        <Textarea \n                          value={getCurrentContent()} \n                          readOnly \n                          className=\"w-full h-full font-mono text-xs bg-transparent border-0 resize-none focus:outline-none\"\n                          style={{\n                            lineHeight: '1.5',\n                            letterSpacing: '0.02em',\n                            tabSize: 4\n                          }}\n                          placeholder=\"Выберите формат для просмотра содержимого...\"\n                          data-testid=\"textarea-export-preview\"\n                        />\n                      )}\n                    </div>\n                  </div>\n                  \n                  <Separator />\n                  \n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"text-sm font-medium\">Загрузить все файлы проекта:</span>\n                    <Button onClick={downloadAllFiles} variant=\"default\" data-testid=\"button-download-all-files\">\n                      <i className=\"fas fa-archive mr-2\"></i>\n                      Скачать все\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            {/* Остальные табы будут добавлены в следующей части */}\n            <TabsContent value=\"export\" className=\"space-y-4 mt-4\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center space-x-2\">\n                    <i className=\"fas fa-download text-blue-500\"></i>\n                    <span>Быстрый экспорт</span>\n                  </CardTitle>\n                  <CardDescription>Быстрые действия для экспорта файлов</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <Button size=\"lg\" onClick={async () => { setSelectedFormat('python'); await downloadFile('python'); }} variant=\"outline\" className=\"h-20 flex-col space-y-1\" data-testid=\"button-download-python\">\n                      <i className=\"fas fa-code text-2xl text-blue-500\"></i>\n                      <span className=\"font-medium\">Скачать Python код</span>\n                    </Button>\n                    \n                    <Button size=\"lg\" onClick={async () => { setSelectedFormat('json'); await downloadFile('json'); }} variant=\"outline\" className=\"h-20 flex-col space-y-1\" data-testid=\"button-download-json\">\n                      <i className=\"fas fa-database text-2xl text-green-500\"></i>\n                      <span className=\"font-medium\">Скачать JSON данные</span>\n                    </Button>\n                    \n                    <Button size=\"lg\" onClick={downloadAllFiles} className=\"h-20 flex-col space-y-1 md:col-span-2\" data-testid=\"button-download-all\">\n                      <i className=\"fas fa-archive text-2xl\"></i>\n                      <span className=\"font-medium\">Скачать все файлы</span>\n                    </Button>\n                  </div>\n                  \n                  <Separator />\n                  \n                  <div className=\"space-y-3\">\n                    <h4 className=\"font-semibold\">Отдельные файлы:</h4>\n                    <div className=\"grid grid-cols-2 md:grid-cols-3 gap-3\">\n                      <Button size=\"sm\" variant=\"ghost\" onClick={() => downloadFile('requirements')} className=\"h-auto p-4 flex-col space-y-2 border border-muted\" data-testid=\"button-download-requirements\">\n                        <i className=\"fas fa-list text-xl text-orange-500\"></i>\n                        <span className=\"font-medium text-sm\">Зависимости</span>\n                        <span className=\"text-xs text-muted-foreground\">.txt</span>\n                      </Button>\n                      <Button size=\"sm\" variant=\"ghost\" onClick={() => downloadFile('readme')} className=\"h-auto p-4 flex-col space-y-2 border border-muted\" data-testid=\"button-download-readme\">\n                        <i className=\"fas fa-file-alt text-xl text-purple-500\"></i>\n                        <span className=\"font-medium text-sm\">Документация</span>\n                        <span className=\"text-xs text-muted-foreground\">.md</span>\n                      </Button>\n                      <Button size=\"sm\" variant=\"ghost\" onClick={() => downloadFile('dockerfile')} className=\"h-auto p-4 flex-col space-y-2 border border-muted\" data-testid=\"button-download-dockerfile\">\n                        <i className=\"fab fa-docker text-xl text-cyan-500\"></i>\n                        <span className=\"font-medium text-sm\">Dockerfile</span>\n                      </Button>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"setup\" className=\"space-y-4 mt-4\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>Настройка и развертывание</CardTitle>\n                  <CardDescription>Пошаговая инструкция по установке и запуску бота</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  {botFatherCommands && (\n                    <div className=\"bg-blue-50 dark:bg-blue-950/30 p-4 rounded-lg border border-blue-200 dark:border-blue-800/40\">\n                      <h5 className=\"font-medium text-blue-800 dark:text-blue-200 mb-2\">Команды для @BotFather:</h5>\n                      <div className=\"space-y-2\">\n                        <Textarea \n                          value={botFatherCommands} \n                          readOnly \n                          className=\"font-mono text-sm h-32 bg-background\"\n                          data-testid=\"textarea-botfather-commands\"\n                        />\n                        <Button onClick={() => copyToClipboard(botFatherCommands)} variant=\"outline\" size=\"sm\" data-testid=\"button-copy-botfather\">\n                          <i className=\"fas fa-copy mr-2\"></i>\n                          Копировать команды\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n\n                  <div className=\"space-y-3\">\n                    <h4 className=\"font-medium\">Инструкция по запуску:</h4>\n                    <ol className=\"list-decimal list-inside space-y-2 text-sm\">\n                      <li>Скачайте все файлы проекта</li>\n                      <li>Установите Python 3.9 или выше</li>\n                      <li>Установите зависимости: <code className=\"bg-muted px-2 py-1 rounded\">pip install -r requirements.txt</code></li>\n                      <li>Замените BOT_TOKEN на ваш токен от @BotFather</li>\n                      <li>Запустите бота: <code className=\"bg-muted px-2 py-1 rounded\">python имя_файла.py</code></li>\n                    </ol>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":33202},"client/src/components/editor/code-panel.tsx":{"content":"import { useState, useEffect, useMemo, useRef } from 'react';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\nimport { BotData, BotGroup } from '@shared/schema';\nimport { useQuery } from '@tanstack/react-query';\nimport { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';\nimport { vscDarkPlus, vs } from 'react-syntax-highlighter/dist/esm/styles/prism';\nimport { Loader2 } from 'lucide-react';\n\nconst loadBotGenerator = () => import('@/lib/bot-generator');\n\ninterface CodePanelProps {\n  botData: BotData;\n  projectName: string;\n  projectId: number;\n  selectedNodeId?: string | null;\n}\n\ntype CodeFormat = 'python' | 'json' | 'requirements' | 'readme' | 'dockerfile';\n\nexport function CodePanel({ botData, projectName, projectId, selectedNodeId }: CodePanelProps) {\n  const [selectedFormat, setSelectedFormat] = useState<CodeFormat>('python');\n  const [codeContent, setCodeContent] = useState<Record<CodeFormat, string>>({\n    python: '',\n    json: '',\n    requirements: '',\n    readme: '',\n    dockerfile: ''\n  });\n  const [isLoading, setIsLoading] = useState(false);\n  const [theme, setTheme] = useState<'light' | 'dark'>('light');\n  const { toast } = useToast();\n\n  const { data: groups = [] } = useQuery<BotGroup[]>({\n    queryKey: ['/api/groups'],\n  });\n\n  // Отслеживаем предыдущие значения для обнаружения реальных изменений  \n  const prevDataRef = useRef({ \n    botDataStr: JSON.stringify(botData), \n    projectName,\n    groupsStr: JSON.stringify(groups)\n  });\n  \n  // Отслеживаем, какие форматы уже загружены\n  const loadedFormatsRef = useRef(new Set<CodeFormat>());\n\n  // Определяем тему из DOM\n  useEffect(() => {\n    const checkTheme = () => {\n      const isDark = document.documentElement.classList.contains('dark');\n      setTheme(isDark ? 'dark' : 'light');\n    };\n    \n    checkTheme();\n    \n    const observer = new MutationObserver(checkTheme);\n    observer.observe(document.documentElement, {\n      attributes: true,\n      attributeFilter: ['class']\n    });\n    \n    return () => observer.disconnect();\n  }, []);\n\n  // Объединенная логика: сброс кеша при изменении данных + загрузка контента\n  useEffect(() => {\n    // Проверяем, изменились ли данные (сравниваем по значению, а не по ссылке)\n    const prev = prevDataRef.current;\n    const currentBotDataStr = JSON.stringify(botData);\n    const currentGroupsStr = JSON.stringify(groups);\n    const dataChanged = prev.botDataStr !== currentBotDataStr || \n                       prev.projectName !== projectName || \n                       prev.groupsStr !== currentGroupsStr;\n    \n    if (dataChanged) {\n      console.log('🔄 CodePanel: Данные изменились, сбрасываем весь кеш');\n      setCodeContent({\n        python: '',\n        json: '',\n        requirements: '',\n        readme: '',\n        dockerfile: ''\n      });\n      loadedFormatsRef.current.clear(); // Очищаем отслеживание загруженных форматов\n      prevDataRef.current = { \n        botDataStr: currentBotDataStr, \n        projectName, \n        groupsStr: currentGroupsStr \n      };\n    }\n    \n    if (!botData) {\n      console.warn('⚠️ CodePanel: Нет данных бота');\n      return;\n    }\n    \n    // Проверяем, был ли уже загружен этот формат (используем ref для проверки без ререндера)\n    if (loadedFormatsRef.current.has(selectedFormat)) {\n      console.log('✅ CodePanel: Контент уже загружен для', selectedFormat, '- пропускаем');\n      return;\n    }\n    \n    // Генерируем контент\n    async function loadContent() {\n      console.log('🔄 CodePanel: Генерация контента для', selectedFormat);\n      setIsLoading(true);\n      \n      try {\n        const content = await generateContent(selectedFormat);\n        \n        console.log('✅ CodePanel: Контент загружен для', selectedFormat);\n        setCodeContent(prev => ({ ...prev, [selectedFormat]: content }));\n        loadedFormatsRef.current.add(selectedFormat); // Отмечаем как загруженный\n      } catch (error) {\n        console.error('❌ CodePanel: Ошибка загрузки:', error);\n        toast({\n          title: \"Ошибка генерации\",\n          description: \"Не удалось сгенерировать код.\",\n          variant: \"destructive\",\n        });\n        setCodeContent(prev => ({ \n          ...prev, \n          [selectedFormat]: `# Ошибка генерации\\n# ${error instanceof Error ? error.message : 'Неизвестная ошибка'}` \n        }));\n      } finally {\n        setIsLoading(false);\n      }\n    }\n    \n    loadContent();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selectedFormat, botData, projectName, groups, toast]);\n\n  const highlightedLines = new Set<number>();\n\n  const getCurrentContent = () => {\n    if (isLoading) {\n      return 'Генерация кода...';\n    }\n    return codeContent[selectedFormat] || 'Выберите формат для просмотра кода...';\n  };\n\n  // Вспомогательная функция для генерации контента (используется в useEffect и downloadFile)\n  const generateContent = async (format: CodeFormat): Promise<string> => {\n    const botGenerator = await loadBotGenerator();\n    \n    switch (format) {\n      case 'python':\n        const validation = botGenerator.validateBotStructure(botData);\n        if (!validation?.isValid) {\n          return '# Ошибка валидации структуры бота';\n        }\n        return botGenerator.generatePythonCode(botData, projectName, groups || []);\n      case 'json':\n        return JSON.stringify(botData, null, 2);\n      case 'requirements':\n        return botGenerator.generateRequirementsTxt();\n      case 'readme':\n        return botGenerator.generateReadme(botData, projectName);\n      case 'dockerfile':\n        return botGenerator.generateDockerfile();\n      default:\n        return '';\n    }\n  };\n\n  const copyToClipboard = () => {\n    const text = getCurrentContent();\n    navigator.clipboard.writeText(text);\n    toast({\n      title: \"Скопировано!\",\n      description: \"Код скопирован в буфер обмена\",\n    });\n  };\n\n  const downloadFile = async (format: CodeFormat) => {\n    let content = codeContent[format];\n    // Если контента нет, генерируем его\n    if (!content) {\n      try {\n        content = await generateContent(format);\n        // Сохраняем в кеш и отмечаем как загруженный\n        setCodeContent(prev => ({ ...prev, [format]: content }));\n        loadedFormatsRef.current.add(format);\n      } catch (error) {\n        console.error('❌ downloadFile: Ошибка генерации:', error);\n        toast({\n          title: \"Ошибка генерации\",\n          description: \"Не удалось сгенерировать файл для скачивания.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n    }\n    if (!content) return;\n\n    const fileExtensions: Record<CodeFormat, string> = {\n      python: '.py',\n      json: '.json',\n      requirements: '.txt',\n      readme: '.md',\n      dockerfile: ''\n    };\n\n    const fileNames: Record<CodeFormat, string> = {\n      python: 'bot',\n      json: 'bot_data',\n      requirements: 'requirements',\n      readme: 'README',\n      dockerfile: 'Dockerfile'\n    };\n\n    const blob = new Blob([content as string], { type: 'text/plain' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = fileNames[format] + fileExtensions[format];\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n\n    toast({\n      title: \"Файл скачан\",\n      description: `Файл ${link.download} успешно загружен`,\n    });\n  };\n\n  return (\n    <aside className=\"w-full h-full bg-background border-l border-border flex flex-col\">\n      <div className=\"p-4 border-b border-border\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <div className=\"flex items-center\">\n            <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-purple-100 to-blue-100 dark:from-purple-900/30 dark:to-blue-900/30 flex items-center justify-center mr-3\">\n              <i className=\"fas fa-code text-purple-600 dark:text-purple-400 text-sm\"></i>\n            </div>\n            <h2 className=\"text-sm font-semibold text-foreground\">Код проекта</h2>\n          </div>\n        </div>\n        <p className=\"text-xs text-muted-foreground mb-3\">Предварительный просмотр сгенерированного кода</p>\n        \n        <Select value={selectedFormat} onValueChange={(value) => setSelectedFormat(value as CodeFormat)}>\n          <SelectTrigger className=\"w-full\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"python\">\n              <div className=\"flex items-center\">\n                <i className=\"fab fa-python mr-2 text-blue-500\"></i>\n                Python код\n              </div>\n            </SelectItem>\n            <SelectItem value=\"json\">\n              <div className=\"flex items-center\">\n                <i className=\"fas fa-database mr-2 text-green-500\"></i>\n                JSON данные\n              </div>\n            </SelectItem>\n            <SelectItem value=\"requirements\">\n              <div className=\"flex items-center\">\n                <i className=\"fas fa-list mr-2 text-orange-500\"></i>\n                Requirements.txt\n              </div>\n            </SelectItem>\n            <SelectItem value=\"readme\">\n              <div className=\"flex items-center\">\n                <i className=\"fas fa-file-alt mr-2 text-purple-500\"></i>\n                README.md\n              </div>\n            </SelectItem>\n            <SelectItem value=\"dockerfile\">\n              <div className=\"flex items-center\">\n                <i className=\"fab fa-docker mr-2 text-cyan-500\"></i>\n                Dockerfile\n              </div>\n            </SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"flex-1 overflow-hidden p-4\">\n        <div className=\"h-full flex flex-col\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <span className=\"text-xs font-medium text-muted-foreground\">\n              {selectedFormat === 'python' ? 'Python' : \n               selectedFormat === 'json' ? 'JSON' :\n               selectedFormat === 'requirements' ? 'Requirements' :\n               selectedFormat === 'readme' ? 'README' : 'Dockerfile'}\n              {selectedNodeId && selectedFormat === 'python' && highlightedLines.size > 0 && (\n                <span className=\"ml-2 text-blue-600 dark:text-blue-400\">\n                  (выделен узел: {selectedNodeId})\n                </span>\n              )}\n            </span>\n            <div className=\"flex gap-2\">\n              <Button\n                onClick={copyToClipboard}\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"h-7 text-xs\"\n                data-testid=\"button-copy-code\"\n              >\n                <i className=\"fas fa-copy mr-1\"></i>\n                Копировать\n              </Button>\n              <Button\n                onClick={() => downloadFile(selectedFormat)}\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"h-7 text-xs\"\n                data-testid=\"button-download-code\"\n              >\n                <i className=\"fas fa-download mr-1\"></i>\n                Скачать\n              </Button>\n            </div>\n          </div>\n          \n          <div \n            className=\"flex-1 overflow-auto rounded border border-slate-300 dark:border-slate-700\"\n          >\n            {isLoading ? (\n              <div className=\"flex items-center justify-center h-full\">\n                <div className=\"flex flex-col items-center gap-3\">\n                  <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n                  <p className=\"text-sm text-muted-foreground\">Генерация кода...</p>\n                </div>\n              </div>\n            ) : selectedFormat === 'python' ? (\n              <SyntaxHighlighter\n                language=\"python\"\n                style={theme === 'dark' ? vscDarkPlus : vs}\n                showLineNumbers={true}\n                wrapLines={true}\n                lineProps={(lineNumber) => {\n                  const isHighlighted = highlightedLines.has(lineNumber);\n                  return {\n                    style: {\n                      backgroundColor: isHighlighted \n                        ? (theme === 'dark' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(59, 130, 246, 0.15)')\n                        : 'transparent',\n                      display: 'block',\n                      width: '100%',\n                      transition: 'background-color 0.3s ease'\n                    }\n                  };\n                }}\n                customStyle={{\n                  margin: 0,\n                  fontSize: '12px',\n                  lineHeight: '1.5',\n                  background: 'transparent'\n                }}\n                data-testid=\"syntax-highlighter-python\"\n              >\n                {getCurrentContent()}\n              </SyntaxHighlighter>\n            ) : (\n              <Textarea\n                value={getCurrentContent()}\n                readOnly\n                className=\"w-full h-full font-mono text-xs bg-transparent border-0 resize-none focus:outline-none\"\n                style={{\n                  lineHeight: '1.5',\n                  letterSpacing: '0.02em',\n                  tabSize: 4\n                }}\n                placeholder=\"Выберите формат для просмотра кода...\"\n                data-testid=\"textarea-code-preview\"\n              />\n            )}\n          </div>\n        </div>\n      </div>\n    </aside>\n  );\n}\n","size_bytes":14709},"server/telegram-media.ts":{"content":"import https from 'https';\nimport http from 'http';\nimport { createWriteStream, existsSync, mkdirSync } from 'fs';\nimport { join, normalize, relative, isAbsolute } from 'path';\nimport { pipeline } from 'stream/promises';\n\ninterface DownloadedPhoto {\n  filePath: string;\n  fileSize: number;\n  mimeType: string;\n  fileName: string;\n}\n\n/**\n * Скачивает фото из Telegram через Bot API\n * @param botToken - Токен бота\n * @param fileId - file_id фото из Telegram\n * @param projectId - ID проекта для организации файлов\n * @returns Информация о скачанном файле\n */\nexport async function downloadTelegramPhoto(\n  botToken: string,\n  fileId: string,\n  projectId: number\n): Promise<DownloadedPhoto> {\n  try {\n    // Шаг 1: Получаем file_path через getFile API\n    const getFileUrl = `https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`;\n    \n    const fileInfo = await new Promise<any>((resolve, reject) => {\n      https.get(getFileUrl, (res) => {\n        let data = '';\n        res.on('data', (chunk) => data += chunk);\n        res.on('end', () => {\n          try {\n            const parsed = JSON.parse(data);\n            if (parsed.ok) {\n              resolve(parsed.result);\n            } else {\n              reject(new Error(`Telegram API error: ${parsed.description || 'Unknown error'}`));\n            }\n          } catch (err) {\n            reject(err);\n          }\n        });\n      }).on('error', reject);\n    });\n\n    const filePath = fileInfo.file_path;\n    const fileSize = fileInfo.file_size || 0;\n    \n    // Санитизировать fileId (оставить только безопасные символы)\n    const safeFileId = fileId.replace(/[^a-zA-Z0-9_-]/g, '').substring(0, 20);\n    \n    // Определяем MIME тип на основе расширения файла\n    const extension = filePath.split('.').pop()?.toLowerCase() || '';\n    \n    // Валидировать расширение (только безопасные форматы изображений)\n    const allowedExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp'];\n    if (!allowedExtensions.includes(extension)) {\n      throw new Error('Invalid file type');\n    }\n    \n    const mimeTypeMap: { [key: string]: string } = {\n      'jpg': 'image/jpeg',\n      'jpeg': 'image/jpeg',\n      'png': 'image/png',\n      'gif': 'image/gif',\n      'webp': 'image/webp',\n    };\n    const mimeType = mimeTypeMap[extension] || 'image/jpeg';\n\n    // Шаг 2: Создаем директорию для сохранения\n    const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n    const uploadDir = join(process.cwd(), 'uploads', String(projectId), date);\n    \n    if (!existsSync(uploadDir)) {\n      mkdirSync(uploadDir, { recursive: true });\n    }\n\n    // Шаг 3: Генерируем уникальное имя файла\n    const timestamp = Date.now();\n    const randomSuffix = Math.round(Math.random() * 1E9);\n    const fileName = `${timestamp}-${randomSuffix}-${safeFileId}.${extension}`;\n    const localFilePath = join(uploadDir, fileName);\n    \n    // Валидировать путь (защита от directory traversal)\n    const normalizedPath = normalize(localFilePath);\n    const rel = relative(uploadDir, normalizedPath);\n    if (rel.startsWith('..') || isAbsolute(rel)) {\n      throw new Error('Invalid file path - potential directory traversal');\n    }\n\n    // Шаг 4: Скачиваем файл\n    const downloadUrl = `https://api.telegram.org/file/bot${botToken}/${filePath}`;\n    \n    await new Promise<void>((resolve, reject) => {\n      https.get(downloadUrl, (res) => {\n        if (res.statusCode !== 200) {\n          reject(new Error(`Failed to download file: HTTP ${res.statusCode}`));\n          return;\n        }\n        \n        const fileStream = createWriteStream(localFilePath);\n        pipeline(res, fileStream)\n          .then(() => resolve())\n          .catch(reject);\n      }).on('error', reject);\n    });\n\n    // Возвращаем относительный путь от корня проекта\n    const relativeFilePath = join('uploads', String(projectId), date, fileName);\n\n    return {\n      filePath: relativeFilePath,\n      fileSize,\n      mimeType,\n      fileName,\n    };\n  } catch (error) {\n    console.error('Error downloading Telegram photo:', error);\n    throw new Error(`Failed to download photo: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\n/**\n * Скачивает видео из Telegram через Bot API\n * @param botToken - Токен бота\n * @param fileId - file_id видео из Telegram\n * @param projectId - ID проекта для организации файлов\n * @returns Информация о скачанном файле\n */\nexport async function downloadTelegramVideo(\n  botToken: string,\n  fileId: string,\n  projectId: number\n): Promise<DownloadedPhoto> {\n  try {\n    const getFileUrl = `https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`;\n    \n    const fileInfo = await new Promise<any>((resolve, reject) => {\n      https.get(getFileUrl, (res) => {\n        let data = '';\n        res.on('data', (chunk) => data += chunk);\n        res.on('end', () => {\n          try {\n            const parsed = JSON.parse(data);\n            if (parsed.ok) {\n              resolve(parsed.result);\n            } else {\n              reject(new Error(`Telegram API error: ${parsed.description || 'Unknown error'}`));\n            }\n          } catch (err) {\n            reject(err);\n          }\n        });\n      }).on('error', reject);\n    });\n\n    const filePath = fileInfo.file_path;\n    const fileSize = fileInfo.file_size || 0;\n    \n    // Санитизировать fileId (оставить только безопасные символы)\n    const safeFileId = fileId.replace(/[^a-zA-Z0-9_-]/g, '').substring(0, 20);\n    \n    const extension = filePath.split('.').pop()?.toLowerCase() || '';\n    \n    // Валидировать расширение (только безопасные форматы видео)\n    const allowedExtensions = ['mp4', 'webm', 'avi', 'mov'];\n    if (!allowedExtensions.includes(extension)) {\n      throw new Error('Invalid file type');\n    }\n    \n    const mimeTypeMap: { [key: string]: string } = {\n      'mp4': 'video/mp4',\n      'webm': 'video/webm',\n      'avi': 'video/avi',\n      'mov': 'video/quicktime',\n    };\n    const mimeType = mimeTypeMap[extension] || 'video/mp4';\n\n    const date = new Date().toISOString().split('T')[0];\n    const uploadDir = join(process.cwd(), 'uploads', String(projectId), date);\n    \n    if (!existsSync(uploadDir)) {\n      mkdirSync(uploadDir, { recursive: true });\n    }\n\n    const timestamp = Date.now();\n    const randomSuffix = Math.round(Math.random() * 1E9);\n    const fileName = `${timestamp}-${randomSuffix}-${safeFileId}.${extension}`;\n    const localFilePath = join(uploadDir, fileName);\n    \n    // Валидировать путь (защита от directory traversal)\n    const normalizedPath = normalize(localFilePath);\n    const rel = relative(uploadDir, normalizedPath);\n    if (rel.startsWith('..') || isAbsolute(rel)) {\n      throw new Error('Invalid file path - potential directory traversal');\n    }\n\n    const downloadUrl = `https://api.telegram.org/file/bot${botToken}/${filePath}`;\n    \n    await new Promise<void>((resolve, reject) => {\n      https.get(downloadUrl, (res) => {\n        if (res.statusCode !== 200) {\n          reject(new Error(`Failed to download file: HTTP ${res.statusCode}`));\n          return;\n        }\n        \n        const fileStream = createWriteStream(localFilePath);\n        pipeline(res, fileStream)\n          .then(() => resolve())\n          .catch(reject);\n      }).on('error', reject);\n    });\n\n    const relativeFilePath = join('uploads', String(projectId), date, fileName);\n\n    return {\n      filePath: relativeFilePath,\n      fileSize,\n      mimeType,\n      fileName,\n    };\n  } catch (error) {\n    console.error('Error downloading Telegram video:', error);\n    throw new Error(`Failed to download video: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\n/**\n * Скачивает аудио из Telegram через Bot API\n * @param botToken - Токен бота\n * @param fileId - file_id аудио из Telegram\n * @param projectId - ID проекта для организации файлов\n * @returns Информация о скачанном файле\n */\nexport async function downloadTelegramAudio(\n  botToken: string,\n  fileId: string,\n  projectId: number\n): Promise<DownloadedPhoto> {\n  try {\n    const getFileUrl = `https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`;\n    \n    const fileInfo = await new Promise<any>((resolve, reject) => {\n      https.get(getFileUrl, (res) => {\n        let data = '';\n        res.on('data', (chunk) => data += chunk);\n        res.on('end', () => {\n          try {\n            const parsed = JSON.parse(data);\n            if (parsed.ok) {\n              resolve(parsed.result);\n            } else {\n              reject(new Error(`Telegram API error: ${parsed.description || 'Unknown error'}`));\n            }\n          } catch (err) {\n            reject(err);\n          }\n        });\n      }).on('error', reject);\n    });\n\n    const filePath = fileInfo.file_path;\n    const fileSize = fileInfo.file_size || 0;\n    \n    // Санитизировать fileId (оставить только безопасные символы)\n    const safeFileId = fileId.replace(/[^a-zA-Z0-9_-]/g, '').substring(0, 20);\n    \n    const extension = filePath.split('.').pop()?.toLowerCase() || '';\n    \n    // Валидировать расширение (только безопасные форматы аудио)\n    const allowedExtensions = ['mp3', 'ogg', 'wav', 'aac'];\n    if (!allowedExtensions.includes(extension)) {\n      throw new Error('Invalid file type');\n    }\n    \n    const mimeTypeMap: { [key: string]: string } = {\n      'mp3': 'audio/mpeg',\n      'ogg': 'audio/ogg',\n      'wav': 'audio/wav',\n      'aac': 'audio/aac',\n    };\n    const mimeType = mimeTypeMap[extension] || 'audio/mpeg';\n\n    const date = new Date().toISOString().split('T')[0];\n    const uploadDir = join(process.cwd(), 'uploads', String(projectId), date);\n    \n    if (!existsSync(uploadDir)) {\n      mkdirSync(uploadDir, { recursive: true });\n    }\n\n    const timestamp = Date.now();\n    const randomSuffix = Math.round(Math.random() * 1E9);\n    const fileName = `${timestamp}-${randomSuffix}-${safeFileId}.${extension}`;\n    const localFilePath = join(uploadDir, fileName);\n    \n    // Валидировать путь (защита от directory traversal)\n    const normalizedPath = normalize(localFilePath);\n    const rel = relative(uploadDir, normalizedPath);\n    if (rel.startsWith('..') || isAbsolute(rel)) {\n      throw new Error('Invalid file path - potential directory traversal');\n    }\n\n    const downloadUrl = `https://api.telegram.org/file/bot${botToken}/${filePath}`;\n    \n    await new Promise<void>((resolve, reject) => {\n      https.get(downloadUrl, (res) => {\n        if (res.statusCode !== 200) {\n          reject(new Error(`Failed to download file: HTTP ${res.statusCode}`));\n          return;\n        }\n        \n        const fileStream = createWriteStream(localFilePath);\n        pipeline(res, fileStream)\n          .then(() => resolve())\n          .catch(reject);\n      }).on('error', reject);\n    });\n\n    const relativeFilePath = join('uploads', String(projectId), date, fileName);\n\n    return {\n      filePath: relativeFilePath,\n      fileSize,\n      mimeType,\n      fileName,\n    };\n  } catch (error) {\n    console.error('Error downloading Telegram audio:', error);\n    throw new Error(`Failed to download audio: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\n/**\n * Скачивает документ из Telegram через Bot API\n * @param botToken - Токен бота\n * @param fileId - file_id документа из Telegram\n * @param projectId - ID проекта для организации файлов\n * @param originalFileName - Оригинальное имя файла (опционально)\n * @returns Информация о скачанном файле\n */\nexport async function downloadTelegramDocument(\n  botToken: string,\n  fileId: string,\n  projectId: number,\n  originalFileName?: string\n): Promise<DownloadedPhoto> {\n  try {\n    const getFileUrl = `https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`;\n    \n    const fileInfo = await new Promise<any>((resolve, reject) => {\n      https.get(getFileUrl, (res) => {\n        let data = '';\n        res.on('data', (chunk) => data += chunk);\n        res.on('end', () => {\n          try {\n            const parsed = JSON.parse(data);\n            if (parsed.ok) {\n              resolve(parsed.result);\n            } else {\n              reject(new Error(`Telegram API error: ${parsed.description || 'Unknown error'}`));\n            }\n          } catch (err) {\n            reject(err);\n          }\n        });\n      }).on('error', reject);\n    });\n\n    const filePath = fileInfo.file_path;\n    const fileSize = fileInfo.file_size || 0;\n    \n    // Санитизировать fileId (оставить только безопасные символы)\n    const safeFileId = fileId.replace(/[^a-zA-Z0-9_-]/g, '').substring(0, 20);\n    \n    const extension = filePath.split('.').pop()?.toLowerCase() || '';\n    \n    // Валидировать расширение (только безопасные форматы документов)\n    const allowedExtensions = ['pdf', 'doc', 'docx', 'txt', 'zip', 'rar'];\n    if (!allowedExtensions.includes(extension)) {\n      throw new Error('Invalid file type');\n    }\n    \n    const mimeType = 'application/octet-stream'; // Общий тип для документов\n\n    const date = new Date().toISOString().split('T')[0];\n    const uploadDir = join(process.cwd(), 'uploads', String(projectId), date);\n    \n    if (!existsSync(uploadDir)) {\n      mkdirSync(uploadDir, { recursive: true });\n    }\n\n    const timestamp = Date.now();\n    const randomSuffix = Math.round(Math.random() * 1E9);\n    const fileName = originalFileName || `${timestamp}-${randomSuffix}-${safeFileId}.${extension}`;\n    const localFilePath = join(uploadDir, fileName);\n    \n    // Валидировать путь (защита от directory traversal)\n    const normalizedPath = normalize(localFilePath);\n    const rel = relative(uploadDir, normalizedPath);\n    if (rel.startsWith('..') || isAbsolute(rel)) {\n      throw new Error('Invalid file path - potential directory traversal');\n    }\n\n    const downloadUrl = `https://api.telegram.org/file/bot${botToken}/${filePath}`;\n    \n    await new Promise<void>((resolve, reject) => {\n      https.get(downloadUrl, (res) => {\n        if (res.statusCode !== 200) {\n          reject(new Error(`Failed to download file: HTTP ${res.statusCode}`));\n          return;\n        }\n        \n        const fileStream = createWriteStream(localFilePath);\n        pipeline(res, fileStream)\n          .then(() => resolve())\n          .catch(reject);\n      }).on('error', reject);\n    });\n\n    const relativeFilePath = join('uploads', String(projectId), date, fileName);\n\n    return {\n      filePath: relativeFilePath,\n      fileSize,\n      mimeType,\n      fileName,\n    };\n  } catch (error) {\n    console.error('Error downloading Telegram document:', error);\n    throw new Error(`Failed to download document: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n","size_bytes":15721}},"version":2}