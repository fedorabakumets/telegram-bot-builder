{"code":"\"\"\"\n–ú–æ–π –ø–µ—Ä–≤—ã–π –±–æ—Ç - Telegram Bot\n–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é TelegramBot Builder\n\"\"\"\n\nimport asyncio\nimport logging\nimport os\nfrom aiogram import Bot, Dispatcher, types, F\nfrom aiogram.filters import CommandStart, Command\nfrom aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, BotCommand, ReplyKeyboardRemove, URLInputFile, FSInputFile\nfrom aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder\nfrom aiogram.enums import ParseMode\nfrom typing import Optional\nimport asyncpg\nfrom datetime import datetime, timezone, timedelta\nimport json\n\n# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏\ndef get_moscow_time():\n    \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ\"\"\"\n    moscow_tz = timezone(timedelta(hours=3))  # UTC+3 –¥–ª—è –ú–æ—Å–∫–≤—ã\n    return datetime.now(moscow_tz).isoformat()\n\n# –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç–µ —É @BotFather)\nBOT_TOKEN = \"YOUR_BOT_TOKEN_HERE\"\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\nlogging.basicConfig(level=logging.INFO)\n\n# –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞\nbot = Bot(token=BOT_TOKEN)\ndp = Dispatcher()\n\n# –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π Telegram ID)\nADMIN_IDS = [123456789]  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\nDATABASE_URL = os.getenv(\"DATABASE_URL\")\n\n# –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö\ndb_pool = None\n\n# –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –¥–ª—è —Å–ª—É—á–∞–µ–≤ –±–µ–∑ –ë–î)\nuser_data = {}\n\n\n# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö\nasync def init_database():\n    \"\"\"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü\"\"\"\n    global db_pool\n    try:\n        db_pool = await asyncpg.create_pool(DATABASE_URL, min_size=1, max_size=10)\n        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç\n        async with db_pool.acquire() as conn:\n            await conn.execute(\"\"\"\n                CREATE TABLE IF NOT EXISTS bot_users (\n                    user_id BIGINT PRIMARY KEY,\n                    username TEXT,\n                    first_name TEXT,\n                    last_name TEXT,\n                    registered_at TIMESTAMP DEFAULT NOW(),\n                    last_interaction TIMESTAMP DEFAULT NOW(),\n                    interaction_count INTEGER DEFAULT 0,\n                    user_data JSONB DEFAULT '{}',\n                    is_active BOOLEAN DEFAULT TRUE\n                );\n            \"\"\")\n        logging.info(\"‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞\")\n    except Exception as e:\n        logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î: {e}. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.\")\n        db_pool = None\n\nasync def save_user_to_db(user_id: int, username: Optional[str] = None, first_name: Optional[str] = None, last_name: Optional[str] = None):\n    \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return False\n    try:\n        async with db_pool.acquire() as conn:\n            await conn.execute(\"\"\"\n                INSERT INTO bot_users (user_id, username, first_name, last_name)\n                VALUES ($1, $2, $3, $4)\n                ON CONFLICT (user_id) DO UPDATE SET\n                    username = EXCLUDED.username,\n                    first_name = EXCLUDED.first_name,\n                    last_name = EXCLUDED.last_name,\n                    last_interaction = NOW(),\n                    interaction_count = bot_users.interaction_count + 1\n            \"\"\", user_id, username, first_name, last_name)\n        return True\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î: {e}\")\n        return False\n\nasync def get_user_from_db(user_id: int):\n    \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return None\n    try:\n        async with db_pool.acquire() as conn:\n            row = await conn.fetchrow(\"SELECT * FROM bot_users WHERE user_id = $1\", user_id)\n            if row:\n                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Record –≤ —Å–ª–æ–≤–∞—Ä—å\n                row_dict = {key: row[key] for key in row.keys()}\n                # –ï—Å–ª–∏ –µ—Å—Ç—å user_data, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ\n                if \"user_data\" in row_dict and row_dict[\"user_data\"]:\n                    user_data = row_dict[\"user_data\"]\n                    if isinstance(user_data, str):\n                        try:\n                            import json\n                            return json.loads(user_data)\n                        except (json.JSONDecodeError, TypeError):\n                            return {}\n                    elif isinstance(user_data, dict):\n                        return user_data\n                    else:\n                        return {}\n                # –ï—Å–ª–∏ –Ω–µ—Ç user_data, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—É—é –∑–∞–ø–∏—Å—å\n                return row_dict\n        return None\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î: {e}\")\n        return None\n\nasync def update_user_data_in_db(user_id: int, data_key: str, data_value):\n    \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return False\n    try:\n        import json\n        async with db_pool.acquire() as conn:\n            # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å\n            await conn.execute(\"\"\"\n                INSERT INTO bot_users (user_id) \n                VALUES ($1) \n                ON CONFLICT (user_id) DO NOTHING\n            \"\"\", user_id)\n            \n            # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            update_data = {data_key: data_value}\n            await conn.execute(\"\"\"\n                UPDATE bot_users \n                SET user_data = COALESCE(user_data, '{}'::jsonb) || $2::jsonb,\n                    last_interaction = NOW()\n                WHERE user_id = $1\n            \"\"\", user_id, json.dumps(update_data))\n        return True\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}\")\n        return False\n\nasync def save_user_data_to_db(user_id: int, data_key: str, data_value):\n    \"\"\"–ê–ª–∏–∞—Å –¥–ª—è update_user_data_in_db –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏\"\"\"\n    return await update_user_data_in_db(user_id, data_key, data_value)\n\nasync def update_user_variable_in_db(user_id: int, variable_name: str, variable_value: str):\n    \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return False\n    try:\n        import json\n        async with db_pool.acquire() as conn:\n            # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å\n            await conn.execute(\"\"\"\n                INSERT INTO bot_users (user_id) \n                VALUES ($1) \n                ON CONFLICT (user_id) DO NOTHING\n            \"\"\", user_id)\n            \n            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            update_data = {variable_name: variable_value}\n            await conn.execute(\"\"\"\n                UPDATE bot_users \n                SET user_data = COALESCE(user_data, '{}'::jsonb) || $2::jsonb,\n                    last_interaction = NOW()\n                WHERE user_id = $1\n            \"\"\", user_id, json.dumps(update_data))\n        return True\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}\")\n        return False\n\n\n# –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\nasync def is_admin(user_id: int) -> bool:\n    return user_id in ADMIN_IDS\n\nasync def is_private_chat(message: types.Message) -> bool:\n    return message.chat.type == \"private\"\n\nasync def check_auth(user_id: int) -> bool:\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\n    if db_pool:\n        user = await get_user_from_db(user_id)\n        return user is not None\n    return user_id in user_data\n\ndef is_local_file(url: str) -> bool:\n    \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL –ª–æ–∫–∞–ª—å–Ω—ã–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–æ–º\"\"\"\n    return url.startswith(\"/uploads/\") or url.startswith(\"uploads/\")\n\ndef get_local_file_path(url: str) -> str:\n    \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–∑ URL\"\"\"\n    if url.startswith(\"/\"):\n        return url[1:]  # –£–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–π —Å–ª–µ—à\n    return url\n\ndef extract_coordinates_from_yandex(url: str) -> tuple:\n    \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç\"\"\"\n    import re\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ ll=longitude,latitude\n    match = re.search(r\"ll=([\\d.-]+),([\\d.-]+)\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ /longitude,latitude/\n    match = re.search(r\"/([\\d.-]+),([\\d.-]+)/\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    return None, None\n\ndef extract_coordinates_from_google(url: str) -> tuple:\n    \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏ Google Maps\"\"\"\n    import re\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ @latitude,longitude\n    match = re.search(r\"@([\\d.-]+),([\\d.-]+)\", url)\n    if match:\n        return float(match.group(1)), float(match.group(2))  # lat, lon\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ /latitude,longitude/\n    match = re.search(r\"/([\\d.-]+),([\\d.-]+)/\", url)\n    if match:\n        return float(match.group(1)), float(match.group(2))  # lat, lon\n    return None, None\n\ndef extract_coordinates_from_2gis(url: str) -> tuple:\n    \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏ 2–ì–ò–°\"\"\"\n    import re\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö 2–ì–ò–°\n    # –§–æ—Ä–º–∞—Ç: center/longitude,latitude\n    match = re.search(r\"center/([\\d.-]+),([\\d.-]+)\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    # –§–æ—Ä–º–∞—Ç: /longitude,latitude/\n    match = re.search(r\"/([\\d.-]+),([\\d.-]+)/\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    return None, None\n\ndef generate_map_urls(latitude: float, longitude: float, title: str = \"\") -> dict:\n    \"\"\"–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã\"\"\"\n    import urllib.parse\n    \n    encoded_title = urllib.parse.quote(title) if title else \"\"\n    \n    return {\n        \"yandex\": f\"https://yandex.ru/maps/?ll={longitude},{latitude}&z=15&l=map&pt={longitude},{latitude}\",\n        \"google\": f\"https://maps.google.com/?q={latitude},{longitude}\",\n        \"2gis\": f\"https://2gis.ru/geo/{longitude},{latitude}\",\n        \"openstreetmap\": f\"https://www.openstreetmap.org/?mlat={latitude}&mlon={longitude}&zoom=15\"\n    }\n\n\n@dp.message(CommandStart())\nasync def start_handler(message: types.Message):\n\n    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ\n    user_id = message.from_user.id\n    username = message.from_user.username\n    first_name = message.from_user.first_name\n    last_name = message.from_user.last_name\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    saved_to_db = await save_user_to_db(user_id, username, first_name, last_name)\n    \n    # –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\n    if not saved_to_db:\n        user_data[user_id] = {\n            \"username\": username,\n            \"first_name\": first_name,\n            \"last_name\": last_name,\n            \"registered_at\": message.date\n        }\n        logging.info(f\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\")\n    else:\n        logging.info(f\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\")\n\n    # –í–ê–ñ–ù–û: –í–°–ï–ì–î–ê –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∏–∑ –ë–î\n    # –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –∫–Ω–æ–ø–æ–∫ \"–ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\" –∏ \"–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\"\n    user_record = await get_user_from_db(user_id)\n    saved_interests = []\n    \n    if user_record and isinstance(user_record, dict):\n        user_data_field = user_record.get(\"user_data\", {})\n        if isinstance(user_data_field, str):\n            import json\n            try:\n                user_vars = json.loads(user_data_field)\n            except:\n                user_vars = {}\n        elif isinstance(user_data_field, dict):\n            user_vars = user_data_field\n        else:\n            user_vars = {}\n        \n        # –ò—â–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –≤ –ª—é–±–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π\n        for var_name, var_data in user_vars.items():\n            if \"–∏–Ω—Ç–µ—Ä–µ—Å\" in var_name.lower() or var_name == \"user_interests\":\n                if isinstance(var_data, str) and var_data:\n                    saved_interests = [interest.strip() for interest in var_data.split(\",\")]\n                    logging.info(f\"–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π {var_name}: {saved_interests}\")\n                    break\n    \n    # –í–°–ï–ì–î–ê –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    user_data[user_id][\"multi_select_start\"] = saved_interests.copy()\n    user_data[user_id][\"multi_select_node\"] = \"start\"\n    logging.info(f\"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å {len(saved_interests)} –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏\")\n    \n    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –≥–∞–ª–æ—á–∫–∞–º–∏\n    builder = InlineKeyboardBuilder()\n    \n    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤\n    def check_interest_match(button_text, saved_list):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ\"\"\"\n        if not saved_list:\n            return False\n        # –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –∏ –≥–∞–ª–æ—á–∫–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è\n        clean_button = button_text.replace(\"‚úÖ \", \"\").replace(\"‚¨ú \", \"\").strip()\n        for saved_interest in saved_list:\n            clean_saved = saved_interest.replace(\"‚úÖ \", \"\").replace(\"‚¨ú \", \"\").strip()\n            if clean_button == clean_saved or clean_button in clean_saved or clean_saved in clean_button:\n                return True\n        return False\n    \n    sport_selected = check_interest_match(\"‚öΩ –°–ø–æ—Ä—Ç\", saved_interests)\n    sport_text = \"‚úÖ ‚öΩ –°–ø–æ—Ä—Ç\" if sport_selected else \"‚öΩ –°–ø–æ—Ä—Ç\"\n    builder.add(InlineKeyboardButton(text=sport_text, callback_data=\"multi_select_start_sport\"))\n    \n    music_selected = check_interest_match(\"üéµ –ú—É–∑—ã–∫–∞\", saved_interests)\n    music_text = \"‚úÖ üéµ –ú—É–∑—ã–∫–∞\" if music_selected else \"üéµ –ú—É–∑—ã–∫–∞\"\n    builder.add(InlineKeyboardButton(text=music_text, callback_data=\"multi_select_start_music\"))\n    \n    books_selected = check_interest_match(\"üìö –ö–Ω–∏–≥–∏\", saved_interests)\n    books_text = \"‚úÖ üìö –ö–Ω–∏–≥–∏\" if books_selected else \"üìö –ö–Ω–∏–≥–∏\"\n    builder.add(InlineKeyboardButton(text=books_text, callback_data=\"multi_select_start_books\"))\n    \n    travel_selected = check_interest_match(\"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\", saved_interests)\n    travel_text = \"‚úÖ ‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\" if travel_selected else \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\"\n    builder.add(InlineKeyboardButton(text=travel_text, callback_data=\"multi_select_start_travel\"))\n    \n    tech_selected = check_interest_match(\"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\", saved_interests)\n    tech_text = \"‚úÖ üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\" if tech_selected else \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\"\n    builder.add(InlineKeyboardButton(text=tech_text, callback_data=\"multi_select_start_tech\"))\n    \n    cooking_selected = check_interest_match(\"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\", saved_interests)\n    cooking_text = \"‚úÖ üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\" if cooking_selected else \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\"\n    builder.add(InlineKeyboardButton(text=cooking_text, callback_data=\"multi_select_start_cooking\"))\n    \n    art_selected = check_interest_match(\"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\", saved_interests)\n    art_text = \"‚úÖ üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\" if art_selected else \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\"\n    builder.add(InlineKeyboardButton(text=art_text, callback_data=\"multi_select_start_art\"))\n    \n    games_selected = check_interest_match(\"üéÆ –ò–≥—Ä—ã\", saved_interests)\n    games_text = \"‚úÖ üéÆ –ò–≥—Ä—ã\" if games_selected else \"üéÆ –ò–≥—Ä—ã\"\n    builder.add(InlineKeyboardButton(text=games_text, callback_data=\"multi_select_start_games\"))\n    \n    builder.add(InlineKeyboardButton(text=\"–ì–æ—Ç–æ–≤–æ\", callback_data=\"multi_select_done_start\"))\n    builder.adjust(2)  # –ò—Å–ø–æ–ª—å–∑—É–µ–º 2 –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏\n    keyboard = builder.as_markup()\n    \n    text = \"\"\"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–∞–º –æ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ, —á—Ç–æ –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç:\"\"\"\n    await message.answer(text, reply_markup=keyboard)\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ inline –∫–Ω–æ–ø–æ–∫\n\n@dp.callback_query(lambda c: c.data == \"final_message\" or c.data.startswith(\"final_message_btn_\"))\nasync def handle_callback_final_message(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    callback_data = callback_query.data\n    \n    button_text = \"üëç –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    response_data = button_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    await update_user_data_in_db(user_id, button_text, response_data)\n    logging.info(f\"–ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {button_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–∑–ª–∞ final_message\n    text = \"\"\"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n\n–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤.\"\"\"\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_vars = await get_user_from_db(user_id)\n    if not user_vars:\n        user_vars = user_data.get(user_id, {})\n    \n    # get_user_from_db —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ user_data\n    if not isinstance(user_vars, dict):\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ë–µ–∑ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    keyboard = None\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞\n    if keyboard is None:\n        # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã\n        builder = InlineKeyboardBuilder()\n        logging.info(f\"–°–æ–∑–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ –∫–æ–º–∞–Ω–¥—ã: üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ -> cmd_start\")\n        builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"cmd_start\"))\n        builder.adjust(1)\n        keyboard = builder.as_markup()\n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n    try:\n        if keyboard is not None:\n            await callback_query.message.edit_text(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.edit_text(text)\n    except Exception:\n        if keyboard is not None:\n            await callback_query.message.answer(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.answer(text)\n\n@dp.callback_query(lambda c: c.data == \"cmd_start\")\nasync def handle_callback_cmd_start(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    button_text = \"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    response_data = button_text\n    await update_user_data_in_db(user_id, button_text, response_data)\n    logging.info(f\"–ö–æ–º–∞–Ω–¥–∞ /start –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ callback –∫–Ω–æ–ø–∫—É (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –í—ã–∑—ã–≤–∞–µ–º start_handler –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–µ—Ä–µ–∑ edit_text\n    # –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è\n    class FakeMessageEdit:\n        def __init__(self, callback_query):\n            self.from_user = callback_query.from_user\n            self.chat = callback_query.message.chat\n            self.date = callback_query.message.date\n            self.message_id = callback_query.message.message_id\n            self._callback_query = callback_query\n        \n        async def answer(self, text, parse_mode=None, reply_markup=None):\n            await self._callback_query.message.edit_text(text, parse_mode=parse_mode, reply_markup=reply_markup)\n        \n        async def edit_text(self, text, parse_mode=None, reply_markup=None):\n            await self._callback_query.message.edit_text(text, parse_mode=parse_mode, reply_markup=reply_markup)\n    \n    fake_edit_message = FakeMessageEdit(callback_query)\n    await start_handler(fake_edit_message)\n\n@dp.callback_query(lambda c: c.data == \"interests_result\" or c.data.startswith(\"interests_result_btn_\"))\nasync def handle_callback_interests_result(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    # Handle interests_result node\n    user_id = callback_query.from_user.id\n    text = \"\"\"üéØ –í–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã:\n\n{user_interests}\n\n–≤–∞—à–∏ –º–µ—Ç—Ä–æ: \n\n–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –¢–µ–ø–µ—Ä—å –º—ã —Å–º–æ–∂–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.\"\"\"\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_vars = await get_user_from_db(user_id)\n    if not user_vars:\n        user_vars = user_data.get(user_id, {})\n    \n    # get_user_from_db —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ user_data\n    if not isinstance(user_vars, dict):\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç—Ä–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    show_metro_keyboard = user_data.get(user_id, {}).get(\"show_metro_keyboard\", False)\n    saved_metro = user_data.get(user_id, {}).get(\"saved_metro_selection\", [])\n    logging.info(f\"üöá interests_result: show_metro_keyboard={show_metro_keyboard}, saved_metro={saved_metro}\")\n    \n    # –°–æ–∑–¥–∞–µ–º –º–µ—Ç—Ä–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\n    if show_metro_keyboard:\n        logging.info(\"üöá –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç—Ä–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ interests_result\")\n        builder = InlineKeyboardBuilder()\n        # –ö–Ω–æ–ø–∫–∞ –º–µ—Ç—Ä–æ: –ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\n        selected_metro = \"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\" in saved_metro\n        button_text = \"‚úÖ \" + \"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\" if selected_metro else \"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\"\n        builder.add(InlineKeyboardButton(text=button_text, callback_data=\"ms_a12dc5bu6_red_line\"))\n        # –ö–Ω–æ–ø–∫–∞ –º–µ—Ç—Ä–æ: –°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\n        selected_metro = \"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\" in saved_metro\n        button_text = \"‚úÖ \" + \"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\" if selected_metro else \"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\"\n        builder.add(InlineKeyboardButton(text=button_text, callback_data=\"ms_a12dc5bu6_blue_line\"))\n        # –ö–Ω–æ–ø–∫–∞ –º–µ—Ç—Ä–æ: –ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\n        selected_metro = \"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\" in saved_metro\n        button_text = \"‚úÖ \" + \"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\" if selected_metro else \"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\"\n        builder.add(InlineKeyboardButton(text=button_text, callback_data=\"ms_a12dc5bu6_green_line\"))\n        # –ö–Ω–æ–ø–∫–∞ –º–µ—Ç—Ä–æ: –û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\n        selected_metro = \"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\" in saved_metro\n        button_text = \"‚úÖ \" + \"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\" if selected_metro else \"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\"\n        builder.add(InlineKeyboardButton(text=button_text, callback_data=\"ms_a12dc5bu6_orange_line\"))\n        # –ö–Ω–æ–ø–∫–∞ –º–µ—Ç—Ä–æ: –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\n        selected_metro = \"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\" in saved_metro\n        button_text = \"‚úÖ \" + \"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\" if selected_metro else \"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\"\n        builder.add(InlineKeyboardButton(text=button_text, callback_data=\"ms_a12dc5bu6_purple_line\"))\n        # –ö–Ω–æ–ø–∫–∞ –º–µ—Ç—Ä–æ: –Ø –∏–∑ –õ–û üè°\n        selected_metro = \"–Ø –∏–∑ –õ–û üè°\" in saved_metro\n        button_text = \"‚úÖ \" + \"–Ø –∏–∑ –õ–û üè°\" if selected_metro else \"–Ø –∏–∑ –õ–û üè°\"\n        builder.add(InlineKeyboardButton(text=button_text, callback_data=\"ms_a12dc5bu6_lo_cities\"))\n        # –ö–Ω–æ–ø–∫–∞ –º–µ—Ç—Ä–æ: –Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\n        selected_metro = \"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\" in saved_metro\n        button_text = \"‚úÖ \" + \"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\" if selected_metro else \"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\"\n        builder.add(InlineKeyboardButton(text=button_text, callback_data=\"ms_a12dc5bu6_not_in_spb\"))\n        builder.add(InlineKeyboardButton(text=\"‚úÖ –ì–æ—Ç–æ–≤–æ\", callback_data=\"done_a12dc5bu6\"))\n        builder.adjust(2)  # 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥\n        metro_keyboard = builder.as_markup()\n        \n        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ interests_result\n        result_builder = InlineKeyboardBuilder()\n        result_builder.add(InlineKeyboardButton(text=\"üëç –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\", callback_data=\"final_message_btn_0\"))\n        result_builder.add(InlineKeyboardButton(text=\"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\", callback_data=\"cmd_start\"))\n        result_keyboard = result_builder.as_markup()\n        \n        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã\n        combined_keyboard = InlineKeyboardMarkup(inline_keyboard=metro_keyboard.inline_keyboard + result_keyboard.inline_keyboard)\n        await bot.send_message(user_id, text, reply_markup=combined_keyboard)\n    else:\n        # –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –º–µ—Ç—Ä–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"üëç –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\", callback_data=\"final_message_btn_0\"))\n        builder.add(InlineKeyboardButton(text=\"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\", callback_data=\"cmd_start\"))\n        keyboard = builder.as_markup()\n        await bot.send_message(user_id, text, reply_markup=keyboard)\n\n\n@dp.callback_query(lambda c: c.data == \"metro_selection_paste_1754804051442_a12dc5bu6\" or c.data.startswith(\"metro_selection_paste_1754804051442_a12dc5bu6_btn_\") or c.data == \"done_a12dc5bu6\")\nasync def handle_callback_metro_selection_paste_1754804051442_a12dc5bu6(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    callback_data = callback_query.data\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∫–Ω–æ–ø–∫–æ–π \"–ì–æ—Ç–æ–≤–æ\"\n    if callback_data == \"done_a12dc5bu6\":\n        logging.info(f\"üèÅ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ì–æ—Ç–æ–≤–æ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞: {callback_data}\")\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        selected_options = user_data.get(user_id, {}).get(\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\", [])\n        if selected_options:\n            selected_text = \", \".join(selected_options)\n            await update_user_data_in_db(user_id, \"metro_lines\", selected_text)\n            logging.info(f\"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é metro_lines: {selected_text}\")\n        \n        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n        if user_id in user_data:\n            user_data[user_id].pop(\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\", None)\n            user_data[user_id].pop(\"multi_select_node\", None)\n            user_data[user_id].pop(\"multi_select_type\", None)\n            user_data[user_id].pop(\"multi_select_variable\", None)\n        \n        # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É\n        next_node_id = \"interests_result\"\n        try:\n            await handle_callback_interests_result(callback_query)\n        except Exception as e:\n            logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n            await callback_query.message.edit_text(\"–ü–µ—Ä–µ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω\")\n        return\n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–∑–µ–ª metro_selection_paste_1754804051442_a12dc5bu6: metro_selection_paste_1754804051442_a12dc5bu6\n    text = \"\"\"–ù–∞ –∫–∞–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ —Ç—ã –æ–±—ã—á–Ω–æ –±—ã–≤–∞–µ—à—å? üöá\n\n–ú–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ç–æ–∫:\"\"\"\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_vars = await get_user_from_db(user_id)\n    if not user_vars:\n        user_vars = user_data.get(user_id, {})\n    \n    # get_user_from_db —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ user_data\n    if not isinstance(user_vars, dict):\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    \n    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–Ω–µ–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã\n    saved_selections = []\n    if user_vars:\n        for var_name, var_data in user_vars.items():\n            if var_name == \"metro_lines\":\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    selections_str = var_data[\"value\"]\n                elif isinstance(var_data, str):\n                    selections_str = var_data\n                else:\n                    continue\n                if selections_str and selections_str.strip():\n                    saved_selections = [sel.strip() for sel in selections_str.split(\",\") if sel.strip()]\n                    break\n    \n    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç\n    if \"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\" not in user_data[user_id]:\n        user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] = saved_selections.copy()\n    user_data[user_id][\"multi_select_node\"] = \"metro_selection_paste_1754804051442_a12dc5bu6\"\n    user_data[user_id][\"multi_select_type\"] = \"inline\"\n    user_data[user_id][\"multi_select_variable\"] = \"metro_lines\"\n    logging.info(f\"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å {len(saved_selections)} —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏\")\n    \n    # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n    builder = InlineKeyboardBuilder()\n    # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ 1: –ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\n    logging.info(f\"üîò –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É: –ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü• -> ms_a12dc5bu6_red_line\")\n    selected_mark = \"‚úÖ \" if \"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\", callback_data=\"ms_a12dc5bu6_red_line\"))\n    # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ 2: –°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\n    logging.info(f\"üîò –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É: –°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶ -> ms_a12dc5bu6_lue_line\")\n    selected_mark = \"‚úÖ \" if \"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\", callback_data=\"ms_a12dc5bu6_lue_line\"))\n    # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ 3: –ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\n    logging.info(f\"üîò –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É: –ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü© -> ms_a12dc5bu6_een_line\")\n    selected_mark = \"‚úÖ \" if \"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\", callback_data=\"ms_a12dc5bu6_een_line\"))\n    # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ 4: –û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\n    logging.info(f\"üîò –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É: –û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß -> ms_a12dc5bu6_nge_line\")\n    selected_mark = \"‚úÖ \" if \"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\", callback_data=\"ms_a12dc5bu6_nge_line\"))\n    # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ 5: –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\n    logging.info(f\"üîò –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É: –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™ -> ms_a12dc5bu6_ple_line\")\n    selected_mark = \"‚úÖ \" if \"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\", callback_data=\"ms_a12dc5bu6_ple_line\"))\n    # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ 6: –Ø –∏–∑ –õ–û üè°\n    logging.info(f\"üîò –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É: –Ø –∏–∑ –õ–û üè° -> ms_a12dc5bu6_o_cities\")\n    selected_mark = \"‚úÖ \" if \"–Ø –∏–∑ –õ–û üè°\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}–Ø –∏–∑ –õ–û üè°\", callback_data=\"ms_a12dc5bu6_o_cities\"))\n    # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ 7: –Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\n    logging.info(f\"üîò –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É: –Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç -> ms_a12dc5bu6_t_in_spb\")\n    selected_mark = \"‚úÖ \" if \"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\", callback_data=\"ms_a12dc5bu6_t_in_spb\"))\n    # –ö–Ω–æ–ø–∫–∞ \"–ì–æ—Ç–æ–≤–æ\" –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n    logging.info(f\"üîò –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –ì–æ—Ç–æ–≤–æ -> done_a12dc5bu6\")\n    builder.add(InlineKeyboardButton(text=\"–ì–æ—Ç–æ–≤–æ\", callback_data=\"done_a12dc5bu6\"))\n    builder.adjust(2)\n    keyboard = builder.as_markup()\n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n    try:\n        if keyboard:\n            await callback_query.message.edit_text(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.edit_text(text)\n    except Exception:\n        if keyboard:\n            await callback_query.message.answer(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.answer(text)\n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    user_id = callback_query.from_user.id\n    \n    # –ò—â–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ callback_data\n    button_display_text = \"–ö–Ω–æ–ø–∫–∞ metro_selection_paste_1754804051442_a12dc5bu6\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    \n    response_data = button_display_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    user_data[user_id][\"button_click\"] = button_display_text\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π\n    await update_user_data_in_db(user_id, \"button_click\", button_display_text)\n    logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è button_click —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: \" + str(button_display_text) + f\" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ\n    await callback_query.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...\")\n    \n    # –ü–ï–†–ï–ê–î–†–ï–°–ê–¶–ò–Ø: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n    next_node_id = \"metro_selection_paste_1754804051442_a12dc5bu6\"\n    try:\n        logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–Ω–æ–ø–∫–∏: {next_node_id}\")\n        if next_node_id == \"start\":\n            logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start\")\n        elif next_node_id == \"interests_result\":\n            nav_text = \"\"\"üéØ –í–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã:\n\n{user_interests}\n\n–≤–∞—à–∏ –º–µ—Ç—Ä–æ: \n\n–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –¢–µ–ø–µ—Ä—å –º—ã —Å–º–æ–∂–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.\"\"\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"final_message\":\n            nav_text = \"\"\"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n\n–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤.\"\"\"\n            await callback_query.message.edit_text(nav_text)\n        elif next_node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n            nav_text = \"\"\"–ù–∞ –∫–∞–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ —Ç—ã –æ–±—ã—á–Ω–æ –±—ã–≤–∞–µ—à—å? üöá\n\n–ú–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ç–æ–∫:\"\"\"\n            await callback_query.message.edit_text(nav_text)\n        else:\n            logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n    \n    return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏\n    \n    text = \"\"\"–ù–∞ –∫–∞–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ —Ç—ã –æ–±—ã—á–Ω–æ –±—ã–≤–∞–µ—à—å? üöá\n\n–ú–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ç–æ–∫:\"\"\"\n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_vars = await get_user_from_db(user_id)\n    if not user_vars:\n        user_vars = user_data.get(user_id, {})\n    \n    # get_user_from_db —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ user_data\n    if not isinstance(user_vars, dict):\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    builder = InlineKeyboardBuilder()\n    keyboard = builder.as_markup()\n    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ\n    try:\n        await callback_query.message.edit_text(text, reply_markup=keyboard)\n    except Exception as e:\n        logging.warning(f\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.\")\n        await callback_query.message.answer(text, reply_markup=keyboard)\n\n\n# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞\n@dp.message(F.text)\nasync def handle_user_input(message: types.Message):\n    user_id = message.from_user.id\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –≤–≤–æ–¥ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n    if user_id in user_data and \"waiting_for_conditional_input\" in user_data[user_id]:\n        config = user_data[user_id][\"waiting_for_conditional_input\"]\n        user_text = message.text\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        condition_id = config.get(\"condition_id\", \"unknown\")\n        next_node_id = config.get(\"next_node_id\")\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        timestamp = get_moscow_time()\n        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é\n        input_variable = config.get(\"input_variable\", \"\")\n        if input_variable:\n            variable_name = input_variable\n        else:\n            variable_name = f\"conditional_response_{condition_id}\"\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n        user_data[user_id][variable_name] = user_text\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        saved_to_db = await update_user_data_in_db(user_id, variable_name, user_text)\n        if saved_to_db:\n            logging.info(f\"‚úÖ –£—Å–ª–æ–≤–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î: {variable_name} = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        else:\n            logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n        \n        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ\n        await message.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...\")\n        \n        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è\n        del user_data[user_id][\"waiting_for_conditional_input\"]\n        \n        logging.info(f\"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {variable_name} = {user_text}\")\n        \n        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω\n        if next_node_id:\n            try:\n                logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {next_node_id}\")\n                \n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π\n                if next_node_id == \"profile_command\":\n                    logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ–º–∞–Ω–¥–µ /profile\")\n                    await profile_handler(message)\n                else:\n                    # –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π callback –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫ –æ–±—ã—á–Ω–æ–º—É —É–∑–ª—É\n                    import types as aiogram_types\n                    fake_callback = aiogram_types.SimpleNamespace(\n                        id=\"conditional_nav\",\n                        from_user=message.from_user,\n                        chat_instance=\"\",\n                        data=next_node_id,\n                        message=message,\n                        answer=lambda text=\"\", show_alert=False: asyncio.sleep(0)\n                    )\n                    \n                    if next_node_id == \"start\":\n                        await handle_callback_start(fake_callback)\n                    elif next_node_id == \"interests_result\":\n                        await handle_callback_interests_result(fake_callback)\n                    elif next_node_id == \"final_message\":\n                        await handle_callback_final_message(fake_callback)\n                    elif next_node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n                        await handle_callback_metro_selection_paste_1754804051442_a12dc5bu6(fake_callback)\n                    else:\n                        logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n            except Exception as e:\n                logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n        \n        return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –∫–Ω–æ–ø–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    if user_id in user_data and \"button_response_config\" in user_data[user_id]:\n        config = user_data[user_id][\"button_response_config\"]\n        user_text = message.text\n        \n        # –ò—â–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å—Ä–µ–¥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø—Ü–∏–π\n        selected_option = None\n        for option in config.get(\"options\", []):\n            if option[\"text\"] == user_text:\n                selected_option = option\n                break\n        \n        if selected_option:\n            selected_value = selected_option[\"value\"]\n            selected_text = selected_option[\"text\"]\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            variable_name = config.get(\"variable\", \"button_response\")\n            timestamp = get_moscow_time()\n            node_id = config.get(\"node_id\", \"unknown\")\n            \n            # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç\n            response_data = {\n                \"value\": selected_value,\n                \"text\": selected_text,\n                \"type\": \"button_choice\",\n                \"timestamp\": timestamp,\n                \"nodeId\": node_id,\n                \"variable\": variable_name\n            }\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][variable_name] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n            if config.get(\"save_to_database\"):\n                saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\n                if saved_to_db:\n                    logging.info(f\"‚úÖ –ö–Ω–æ–ø–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î: {variable_name} = {selected_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n                else:\n                    logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ\n            success_message = config.get(\"success_message\", \"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤—ã–±–æ—Ä!\")\n            await message.answer(f\"{success_message}\\n\\n‚úÖ –í–∞—à –≤—ã–±–æ—Ä: {selected_text}\", reply_markup=ReplyKeyboardRemove())\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n            del user_data[user_id][\"button_response_config\"]\n            \n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –∫–Ω–æ–ø–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É: {variable_name} = {selected_text}\")\n            \n            # –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ–π—Å—Ç–≤–∏—è –∫–Ω–æ–ø–∫–∏\n            option_action = selected_option.get(\"action\", \"goto\")\n            option_target = selected_option.get(\"target\", \"\")\n            option_url = selected_option.get(\"url\", \"\")\n            \n            if option_action == \"url\" and option_url:\n                # –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Å—ã–ª–∫–∏\n                url = option_url\n                keyboard = InlineKeyboardMarkup(inline_keyboard=[\n                    [InlineKeyboardButton(text=\"üîó –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É\", url=url)]\n                ])\n                await message.answer(\"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É:\", reply_markup=keyboard)\n            elif option_action == \"command\" and option_target:\n                # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã\n                command = option_target\n                # –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã\n                import types as aiogram_types\n                fake_message = aiogram_types.SimpleNamespace(\n                    from_user=message.from_user,\n                    chat=message.chat,\n                    text=command,\n                    message_id=message.message_id\n                )\n                \n                if command == \"/start\":\n                    try:\n                        await start_handler(fake_message)\n                    except Exception as e:\n                        logging.error(f\"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã /start: {e}\")\n                else:\n                    logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {command}\")\n            elif option_action == \"goto\" and option_target:\n                # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É\n                target_node_id = option_target\n                try:\n                    # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞\n                    if target_node_id == \"start\":\n                        await handle_callback_start(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"interests_result\":\n                        await handle_callback_interests_result(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"final_message\":\n                        await handle_callback_final_message(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n                        await handle_callback_metro_selection_paste_1754804051442_a12dc5bu6(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    else:\n                        logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ü–µ–ª–µ–≤–æ–π —É–∑–µ–ª: {target_node_id}\")\n                except Exception as e:\n                    logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —É–∑–ª—É {target_node_id}: {e}\")\n            else:\n                # Fallback –∫ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–µ next_node_id –µ—Å–ª–∏ –Ω–µ—Ç action\n                next_node_id = config.get(\"next_node_id\")\n                if next_node_id:\n                    try:\n                        # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É–∑–ª–∞\n                        if next_node_id == \"start\":\n                            await handle_callback_start(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"interests_result\":\n                            await handle_callback_interests_result(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"final_message\":\n                            await handle_callback_final_message(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n                            await handle_callback_metro_selection_paste_1754804051442_a12dc5bu6(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        else:\n                            logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n                    except Exception as e:\n                        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n            return\n        else:\n            # –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã\n            available_options = [option[\"text\"] for option in config.get(\"options\", [])]\n            options_text = \"\\n\".join([f\"‚Ä¢ {opt}\" for opt in available_options])\n            await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:\\n\\n{options_text}\")\n            return\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)\n    has_waiting_state = user_id in user_data and \"waiting_for_input\" in user_data[user_id]\n    logging.info(f\"DEBUG: –ü–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç {message.text}, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è: {has_waiting_state}\")\n    if user_id in user_data and \"waiting_for_input\" in user_data[user_id]:\n        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥ —á–µ—Ä–µ–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É\n        waiting_config = user_data[user_id][\"waiting_for_input\"]\n        \n        # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ –µ—â–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n        # –∏ —á—Ç–æ –≤–≤–æ–¥ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —É–∑–ª–∞\n        if not waiting_config:\n            return  # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –ø—É—Å—Ç–æ–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤–≤–æ–¥ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —É–∑–ª–∞\n        current_node_id = waiting_config.get(\"node_id\") if isinstance(waiting_config, dict) else waiting_config\n        processed_inputs = user_data[user_id].get(\"processed_inputs\", set())\n        if current_node_id in processed_inputs:\n            logging.info(f\"–í–≤–æ–¥ –¥–ª—è —É–∑–ª–∞ {current_node_id} —É–∂–µ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º\")\n            return  # –í–≤–æ–¥ –¥–ª—è —ç—Ç–æ–≥–æ —É–∑–ª–∞ —É–∂–µ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω\n        \n        # –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ inline –∫–Ω–æ–ø–∫–æ–π, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º\n        variable_name_preview = waiting_config.get(\"variable\") if isinstance(waiting_config, dict) else user_data[user_id].get(\"input_variable\", \"user_response\")\n        if variable_name_preview in user_data[user_id] and user_data[user_id][variable_name_preview]:\n            logging.info(f\"–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è {variable_name_preview} —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥\")\n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –¥–∞–ª—å—à–µ\n            del user_data[user_id][\"waiting_for_input\"]\n            return\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ - –Ω–æ–≤—ã–π (—Å–ª–æ–≤–∞—Ä—å) –∏–ª–∏ —Å—Ç–∞—Ä—ã–π (—Å—Ç—Ä–æ–∫–∞)\n        if isinstance(waiting_config, dict):\n            # –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç - –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è\n            waiting_node_id = waiting_config.get(\"node_id\")\n            input_type = waiting_config.get(\"type\", \"text\")\n            variable_name = waiting_config.get(\"variable\", \"user_response\")\n            save_to_database = waiting_config.get(\"save_to_database\", False)\n            min_length = waiting_config.get(\"min_length\", 0)\n            max_length = waiting_config.get(\"max_length\", 0)\n            next_node_id = waiting_config.get(\"next_node_id\")\n        else:\n            # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - waiting_config —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å node_id\n            waiting_node_id = waiting_config\n            input_type = user_data[user_id].get(\"input_type\", \"text\")\n            variable_name = user_data[user_id].get(\"input_variable\", \"user_response\")\n            save_to_database = user_data[user_id].get(\"save_to_database\", False)\n            min_length = 0\n            max_length = 0\n            next_node_id = user_data[user_id].get(\"input_target_node_id\")\n        \n        user_text = message.text\n        \n        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n        if isinstance(waiting_config, dict):\n            # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã\n            if min_length > 0 and len(user_text) < min_length:\n                retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (–º–∏–Ω–∏–º—É–º {min_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n                return\n            \n            if max_length > 0 and len(user_text) > max_length:\n                retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º {max_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n                return\n            \n            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –≤–≤–æ–¥–∞\n            if input_type == \"email\":\n                import re\n                email_pattern = r\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$\"\n                if not re.match(email_pattern, user_text):\n                    retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                    await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. {retry_message}\")\n                    return\n            elif input_type == \"number\":\n                try:\n                    float(user_text)\n                except ValueError:\n                    retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                    await message.answer(f\"‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ. {retry_message}\")\n                    return\n            elif input_type == \"phone\":\n                import re\n                phone_pattern = r\"^[+]?[0-9\\s\\-\\(\\)]{10,}$\"\n                if not re.match(phone_pattern, user_text):\n                    retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                    await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. {retry_message}\")\n                    return\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n            timestamp = get_moscow_time()\n            response_data = user_text\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][variable_name] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n            if save_to_database:\n                saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\n                if saved_to_db:\n                    logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: {variable_name} = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n                else:\n                    logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            # –ò–°–ü–†–ê–í–õ–ï–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n            success_message = waiting_config.get(\"success_message\", \"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n            logging.info(f\"DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º: {success_message}\")\n            await message.answer(success_message)\n            logging.info(f\"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: {success_message}\")\n            \n            # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä, —á—Ç–æ –≤–≤–æ–¥ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è —ç—Ç–æ–≥–æ —É–∑–ª–∞\n            if \"processed_inputs\" not in user_data[user_id]:\n                user_data[user_id][\"processed_inputs\"] = set()\n            user_data[user_id][\"processed_inputs\"].add(waiting_node_id)\n            \n            logging.info(f\"‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ\")\n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: {variable_name} = {user_text}\")\n            \n            # –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n            if next_node_id:\n                try:\n                    logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {next_node_id}\")\n                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∫ —É–∑–ª–∞–º\n                    if next_node_id == \"start\":\n                        logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start —Ç–∏–ø–∞ start\")\n                    elif next_node_id == \"interests_result\":\n                        text = \"\"\"üéØ –í–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã:\n\n{user_interests}\n\n–≤–∞—à–∏ –º–µ—Ç—Ä–æ: \n\n–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –¢–µ–ø–µ—Ä—å –º—ã —Å–º–æ–∂–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.\"\"\"\n                        # –ó–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ\n                        # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n                        user_vars = await get_user_from_db(user_id)\n                        if not user_vars:\n                            user_vars = user_data.get(user_id, {})\n                        \n                        # get_user_from_db —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ user_data\n                        if not isinstance(user_vars, dict):\n                            user_vars = {}\n                        \n                        # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n                        import re\n                        def replace_variables_in_text(text_content, variables_dict):\n                            if not text_content or not variables_dict:\n                                return text_content\n                            \n                            for var_name, var_data in variables_dict.items():\n                                placeholder = \"{\" + var_name + \"}\"\n                                if placeholder in text_content:\n                                    if isinstance(var_data, dict) and \"value\" in var_data:\n                                        var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                                    elif var_data is not None:\n                                        var_value = str(var_data)\n                                    else:\n                                        var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                                    text_content = text_content.replace(placeholder, var_value)\n                            return text_content\n                        \n                        text = replace_variables_in_text(text, user_vars)\n                        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n                        builder = InlineKeyboardBuilder()\n                        builder.add(InlineKeyboardButton(text=\"üëç –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\", callback_data=\"final_message\"))\n                        logging.info(f\"–°–æ–∑–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ –∫–æ–º–∞–Ω–¥—ã: ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä -> cmd_start\")\n                        builder.add(InlineKeyboardButton(text=\"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\", callback_data=\"cmd_start\"))\n                        builder.adjust(1)\n                        keyboard = builder.as_markup()\n                        await message.answer(text, reply_markup=keyboard)\n                        # –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ —Å—Ç–∞—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–µ\n                        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞\n                        if \"waiting_for_input\" in user_data[user_id]:\n                            del user_data[user_id][\"waiting_for_input\"]\n                        \n                        logging.info(\"‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ\")\n                    elif next_node_id == \"final_message\":\n                        text = \"\"\"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n\n–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤.\"\"\"\n                        # –ó–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ\n                        # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n                        user_vars = await get_user_from_db(user_id)\n                        if not user_vars:\n                            user_vars = user_data.get(user_id, {})\n                        \n                        # get_user_from_db —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ user_data\n                        if not isinstance(user_vars, dict):\n                            user_vars = {}\n                        \n                        # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n                        import re\n                        def replace_variables_in_text(text_content, variables_dict):\n                            if not text_content or not variables_dict:\n                                return text_content\n                            \n                            for var_name, var_data in variables_dict.items():\n                                placeholder = \"{\" + var_name + \"}\"\n                                if placeholder in text_content:\n                                    if isinstance(var_data, dict) and \"value\" in var_data:\n                                        var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                                    elif var_data is not None:\n                                        var_value = str(var_data)\n                                    else:\n                                        var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                                    text_content = text_content.replace(placeholder, var_value)\n                            return text_content\n                        \n                        text = replace_variables_in_text(text, user_vars)\n                        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n                        builder = InlineKeyboardBuilder()\n                        logging.info(f\"–°–æ–∑–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ –∫–æ–º–∞–Ω–¥—ã: üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ -> cmd_start\")\n                        builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"cmd_start\"))\n                        builder.adjust(1)\n                        keyboard = builder.as_markup()\n                        await message.answer(text, reply_markup=keyboard)\n                        # –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ —Å—Ç–∞—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–µ\n                        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞\n                        if \"waiting_for_input\" in user_data[user_id]:\n                            del user_data[user_id][\"waiting_for_input\"]\n                        \n                        logging.info(\"‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ\")\n                    elif next_node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n                        text = \"\"\"–ù–∞ –∫–∞–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ —Ç—ã –æ–±—ã—á–Ω–æ –±—ã–≤–∞–µ—à—å? üöá\n\n–ú–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ç–æ–∫:\"\"\"\n                        # –ó–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ\n                        # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n                        user_vars = await get_user_from_db(user_id)\n                        if not user_vars:\n                            user_vars = user_data.get(user_id, {})\n                        \n                        # get_user_from_db —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ user_data\n                        if not isinstance(user_vars, dict):\n                            user_vars = {}\n                        \n                        # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n                        import re\n                        def replace_variables_in_text(text_content, variables_dict):\n                            if not text_content or not variables_dict:\n                                return text_content\n                            \n                            for var_name, var_data in variables_dict.items():\n                                placeholder = \"{\" + var_name + \"}\"\n                                if placeholder in text_content:\n                                    if isinstance(var_data, dict) and \"value\" in var_data:\n                                        var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                                    elif var_data is not None:\n                                        var_value = str(var_data)\n                                    else:\n                                        var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                                    text_content = text_content.replace(placeholder, var_value)\n                            return text_content\n                        \n                        text = replace_variables_in_text(text, user_vars)\n                        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n                        builder = InlineKeyboardBuilder()\n                        builder.adjust(2)\n                        keyboard = builder.as_markup()\n                        await message.answer(text, reply_markup=keyboard)\n                        # –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ —Å—Ç–∞—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–µ\n                        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞\n                        if \"waiting_for_input\" in user_data[user_id]:\n                            del user_data[user_id][\"waiting_for_input\"]\n                        \n                        logging.info(\"‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ\")\n                    else:\n                        logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n                except Exception as e:\n                    logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n            \n            return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n        \n        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)\n        # –ù–∞—Ö–æ–¥–∏–º —É–∑–µ–ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫\n        logging.info(f\"DEBUG old format: checking inputNodes: \")\n        \n        # –ï—Å–ª–∏ —É–∑–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω\n        logging.warning(f\"–£–∑–µ–ª –¥–ª—è —Å–±–æ—Ä–∞ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: {waiting_node_id}\")\n        del user_data[user_id][\"waiting_for_input\"]\n        return\n    \n    # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫\n    if user_id in user_data and user_data[user_id].get(\"input_collection_enabled\"):\n        input_node_id = user_data[user_id].get(\"input_node_id\")\n        input_variable = user_data[user_id].get(\"input_variable\", \"button_response\")\n        user_text = message.text\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—é–±–æ–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç\n        timestamp = get_moscow_time()\n        \n        response_data = user_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n        user_data[user_id][f\"{input_variable}_additional\"] = response_data\n        \n        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        await message.answer(\"‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω!\")\n        \n        logging.info(f\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥: {input_variable}_additional = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        return\n    \n    # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n    return\n    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞\n    min_length = input_config.get(\"min_length\", 0)\n    max_length = input_config.get(\"max_length\", 0)\n    \n    if min_length > 0 and len(user_text) < min_length:\n        retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n        await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (–º–∏–Ω–∏–º—É–º {min_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n        return\n    \n    if max_length > 0 and len(user_text) > max_length:\n        retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n        await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º {max_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n        return\n    \n    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –≤–≤–æ–¥–∞\n    input_type = input_config.get(\"type\", \"text\")\n    \n    if input_type == \"email\":\n        import re\n        email_pattern = r\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$\"\n        if not re.match(email_pattern, user_text):\n            retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n            await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. {retry_message}\")\n            return\n    \n    elif input_type == \"number\":\n        try:\n            float(user_text)\n        except ValueError:\n            retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n            await message.answer(f\"‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ. {retry_message}\")\n            return\n    \n    elif input_type == \"phone\":\n        import re\n        phone_pattern = r\"^[+]?[0-9\\s\\-\\(\\)]{10,}$\"\n        if not re.match(phone_pattern, user_text):\n            retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n            await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. {retry_message}\")\n            return\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Å—Ç—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º\n    variable_name = input_config.get(\"variable\", \"user_response\")\n    timestamp = get_moscow_time()\n    node_id = input_config.get(\"node_id\", \"unknown\")\n    \n    # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞\n    response_data = user_text\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    user_data[user_id][variable_name] = response_data\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n    if input_config.get(\"save_to_database\"):\n        saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\n        if saved_to_db:\n            logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: {variable_name} = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        else:\n            logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n    \n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ\n    success_message = input_config.get(\"success_message\", \"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n    await message.answer(success_message)\n    \n    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n    del user_data[user_id][\"waiting_for_input\"]\n    \n    logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: {variable_name} = {user_text}\")\n    \n    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–≤–æ–¥–∞\n    next_node_id = input_config.get(\"next_node_id\")\n    logging.info(f\"üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é: next_node_id = {next_node_id}\")\n    if next_node_id:\n        try:\n            logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {next_node_id}\")\n            \n            # –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏\n            fake_message = type(\"FakeMessage\", (), {})()\n            fake_message.from_user = message.from_user\n            fake_message.answer = message.answer\n            fake_message.delete = lambda: None\n            \n            # –ù–∞—Ö–æ–¥–∏–º —É–∑–µ–ª –ø–æ ID –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ\n            if next_node_id == \"start\":\n                logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start —Ç–∏–ø–∞ start\")\n            elif next_node_id == \"interests_result\":\n                text = \"\"\"üéØ –í–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã:\n\n{user_interests}\n\n–≤–∞—à–∏ –º–µ—Ç—Ä–æ: \n\n–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –¢–µ–ø–µ—Ä—å –º—ã —Å–º–æ–∂–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.\"\"\"\n                # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n                if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n                    parse_mode = conditional_parse_mode\n                else:\n                    parse_mode = None\n                builder = InlineKeyboardBuilder()\n                builder.add(InlineKeyboardButton(text=\"üëç –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\", callback_data=\"final_message\"))\n                logging.info(f\"–°–æ–∑–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ –∫–æ–º–∞–Ω–¥—ã: ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä -> cmd_start\")\n                builder.add(InlineKeyboardButton(text=\"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\", callback_data=\"cmd_start\"))\n                builder.adjust(1)\n                keyboard = builder.as_markup()\n                await message.answer(text, reply_markup=keyboard, parse_mode=parse_mode)\n            elif next_node_id == \"final_message\":\n                text = \"\"\"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n\n–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤.\"\"\"\n                # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n                if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n                    parse_mode = conditional_parse_mode\n                else:\n                    parse_mode = None\n                builder = InlineKeyboardBuilder()\n                logging.info(f\"–°–æ–∑–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ –∫–æ–º–∞–Ω–¥—ã: üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ -> cmd_start\")\n                builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"cmd_start\"))\n                builder.adjust(1)\n                keyboard = builder.as_markup()\n                await message.answer(text, reply_markup=keyboard, parse_mode=parse_mode)\n            elif next_node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n                text = \"\"\"–ù–∞ –∫–∞–∫–æ–π —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ —Ç—ã –æ–±—ã—á–Ω–æ –±—ã–≤–∞–µ—à—å? üöá\n\n–ú–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ç–æ–∫:\"\"\"\n                # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n                if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n                    parse_mode = conditional_parse_mode\n                else:\n                    parse_mode = None\n                # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n                if user_id not in user_data:\n                    user_data[user_id] = {}\n                \n                # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–Ω–µ–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã\n                saved_selections = []\n                if user_vars:\n                    for var_name, var_data in user_vars.items():\n                        if var_name == \"metro_lines\":\n                            if isinstance(var_data, dict) and \"value\" in var_data:\n                                selections_str = var_data[\"value\"]\n                            elif isinstance(var_data, str):\n                                selections_str = var_data\n                            else:\n                                continue\n                            if selections_str and selections_str.strip():\n                                saved_selections = [sel.strip() for sel in selections_str.split(\",\") if sel.strip()]\n                                break\n                \n                # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç\n                if \"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] = saved_selections.copy()\n                user_data[user_id][\"multi_select_node\"] = \"metro_selection_paste_1754804051442_a12dc5bu6\"\n                user_data[user_id][\"multi_select_type\"] = \"inline\"\n                user_data[user_id][\"multi_select_variable\"] = \"metro_lines\"\n                logging.info(f\"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å {len(saved_selections)} —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏\")\n                \n                builder = InlineKeyboardBuilder()\n                # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Å –≥–∞–ª–æ—á–∫–∞–º–∏: –ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\n                logging.info(f\"üîß –ü–†–û–í–ï–†–Ø–ï–ú –ì–ê–õ–û–ß–ö–£: –∏—â–µ–º '–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•' –≤ —Å–ø–∏—Å–∫–µ: {user_data[user_id]['multi_select_metro_selection_paste_1754804051442_a12dc5bu6']}\")\n                selected_mark = \"‚úÖ \" if \"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n                logging.info(f\"üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –ì–ê–õ–û–ß–ö–ò –¥–ª—è '–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•': selected_mark='{selected_mark}'\")\n                final_text = f\"{selected_mark}–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\"\n                logging.info(f\"üì± –°–û–ó–î–ê–ï–ú –ö–ù–û–ü–ö–£: text='{final_text}', callback_data='ms_a12dc5bu6_red_line'\")\n                builder.add(InlineKeyboardButton(text=final_text, callback_data=\"ms_a12dc5bu6_red_line\"))\n                # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Å –≥–∞–ª–æ—á–∫–∞–º–∏: –°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\n                logging.info(f\"üîß –ü–†–û–í–ï–†–Ø–ï–ú –ì–ê–õ–û–ß–ö–£: –∏—â–µ–º '–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶' –≤ —Å–ø–∏—Å–∫–µ: {user_data[user_id]['multi_select_metro_selection_paste_1754804051442_a12dc5bu6']}\")\n                selected_mark = \"‚úÖ \" if \"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n                logging.info(f\"üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –ì–ê–õ–û–ß–ö–ò –¥–ª—è '–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶': selected_mark='{selected_mark}'\")\n                final_text = f\"{selected_mark}–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\"\n                logging.info(f\"üì± –°–û–ó–î–ê–ï–ú –ö–ù–û–ü–ö–£: text='{final_text}', callback_data='ms_a12dc5bu6_lue_line'\")\n                builder.add(InlineKeyboardButton(text=final_text, callback_data=\"ms_a12dc5bu6_lue_line\"))\n                # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Å –≥–∞–ª–æ—á–∫–∞–º–∏: –ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\n                logging.info(f\"üîß –ü–†–û–í–ï–†–Ø–ï–ú –ì–ê–õ–û–ß–ö–£: –∏—â–µ–º '–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©' –≤ —Å–ø–∏—Å–∫–µ: {user_data[user_id]['multi_select_metro_selection_paste_1754804051442_a12dc5bu6']}\")\n                selected_mark = \"‚úÖ \" if \"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n                logging.info(f\"üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –ì–ê–õ–û–ß–ö–ò –¥–ª—è '–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©': selected_mark='{selected_mark}'\")\n                final_text = f\"{selected_mark}–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\"\n                logging.info(f\"üì± –°–û–ó–î–ê–ï–ú –ö–ù–û–ü–ö–£: text='{final_text}', callback_data='ms_a12dc5bu6_een_line'\")\n                builder.add(InlineKeyboardButton(text=final_text, callback_data=\"ms_a12dc5bu6_een_line\"))\n                # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Å –≥–∞–ª–æ—á–∫–∞–º–∏: –û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\n                logging.info(f\"üîß –ü–†–û–í–ï–†–Ø–ï–ú –ì–ê–õ–û–ß–ö–£: –∏—â–µ–º '–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß' –≤ —Å–ø–∏—Å–∫–µ: {user_data[user_id]['multi_select_metro_selection_paste_1754804051442_a12dc5bu6']}\")\n                selected_mark = \"‚úÖ \" if \"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n                logging.info(f\"üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –ì–ê–õ–û–ß–ö–ò –¥–ª—è '–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß': selected_mark='{selected_mark}'\")\n                final_text = f\"{selected_mark}–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\"\n                logging.info(f\"üì± –°–û–ó–î–ê–ï–ú –ö–ù–û–ü–ö–£: text='{final_text}', callback_data='ms_a12dc5bu6_nge_line'\")\n                builder.add(InlineKeyboardButton(text=final_text, callback_data=\"ms_a12dc5bu6_nge_line\"))\n                # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Å –≥–∞–ª–æ—á–∫–∞–º–∏: –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\n                logging.info(f\"üîß –ü–†–û–í–ï–†–Ø–ï–ú –ì–ê–õ–û–ß–ö–£: –∏—â–µ–º '–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™' –≤ —Å–ø–∏—Å–∫–µ: {user_data[user_id]['multi_select_metro_selection_paste_1754804051442_a12dc5bu6']}\")\n                selected_mark = \"‚úÖ \" if \"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n                logging.info(f\"üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –ì–ê–õ–û–ß–ö–ò –¥–ª—è '–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™': selected_mark='{selected_mark}'\")\n                final_text = f\"{selected_mark}–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\"\n                logging.info(f\"üì± –°–û–ó–î–ê–ï–ú –ö–ù–û–ü–ö–£: text='{final_text}', callback_data='ms_a12dc5bu6_ple_line'\")\n                builder.add(InlineKeyboardButton(text=final_text, callback_data=\"ms_a12dc5bu6_ple_line\"))\n                # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Å –≥–∞–ª–æ—á–∫–∞–º–∏: –Ø –∏–∑ –õ–û üè°\n                logging.info(f\"üîß –ü–†–û–í–ï–†–Ø–ï–ú –ì–ê–õ–û–ß–ö–£: –∏—â–µ–º '–Ø –∏–∑ –õ–û üè°' –≤ —Å–ø–∏—Å–∫–µ: {user_data[user_id]['multi_select_metro_selection_paste_1754804051442_a12dc5bu6']}\")\n                selected_mark = \"‚úÖ \" if \"–Ø –∏–∑ –õ–û üè°\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n                logging.info(f\"üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –ì–ê–õ–û–ß–ö–ò –¥–ª—è '–Ø –∏–∑ –õ–û üè°': selected_mark='{selected_mark}'\")\n                final_text = f\"{selected_mark}–Ø –∏–∑ –õ–û üè°\"\n                logging.info(f\"üì± –°–û–ó–î–ê–ï–ú –ö–ù–û–ü–ö–£: text='{final_text}', callback_data='ms_a12dc5bu6_o_cities'\")\n                builder.add(InlineKeyboardButton(text=final_text, callback_data=\"ms_a12dc5bu6_o_cities\"))\n                # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Å –≥–∞–ª–æ—á–∫–∞–º–∏: –Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\n                logging.info(f\"üîß –ü–†–û–í–ï–†–Ø–ï–ú –ì–ê–õ–û–ß–ö–£: –∏—â–µ–º '–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç' –≤ —Å–ø–∏—Å–∫–µ: {user_data[user_id]['multi_select_metro_selection_paste_1754804051442_a12dc5bu6']}\")\n                selected_mark = \"‚úÖ \" if \"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\" in user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] else \"\"\n                logging.info(f\"üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –ì–ê–õ–û–ß–ö–ò –¥–ª—è '–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç': selected_mark='{selected_mark}'\")\n                final_text = f\"{selected_mark}–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\"\n                logging.info(f\"üì± –°–û–ó–î–ê–ï–ú –ö–ù–û–ü–ö–£: text='{final_text}', callback_data='ms_a12dc5bu6_t_in_spb'\")\n                builder.add(InlineKeyboardButton(text=final_text, callback_data=\"ms_a12dc5bu6_t_in_spb\"))\n                # –ö–Ω–æ–ø–∫–∞ \"–ì–æ—Ç–æ–≤–æ\" –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n                logging.info(f\"üîò –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –ì–æ—Ç–æ–≤–æ -> done_a12dc5bu6\")\n                builder.add(InlineKeyboardButton(text=\"–ì–æ—Ç–æ–≤–æ\", callback_data=\"done_a12dc5bu6\"))\n                builder.adjust(2)\n                keyboard = builder.as_markup()\n                await message.answer(text, reply_markup=keyboard, parse_mode=parse_mode)\n            else:\n                logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n        except Exception as e:\n            logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É—Å–ª–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫\n@dp.callback_query(lambda c: c.data.startswith(\"conditional_\"))\nasync def handle_conditional_button(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    \n    # –ü–∞—Ä—Å–∏–º callback_data: conditional_variableName_value\n    callback_parts = callback_query.data.split(\"_\", 2)\n    if len(callback_parts) >= 3:\n        variable_name = callback_parts[1]\n        variable_value = callback_parts[2]\n        \n        user_id = callback_query.from_user.id\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        await update_user_data_in_db(user_id, variable_name, variable_value)\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n        if user_id not in user_data:\n            user_data[user_id] = {}\n        user_data[user_id][variable_name] = variable_value\n        \n        logging.info(f\"–£—Å–ª–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞: {variable_name} = {variable_value} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        \n        # –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å\n        await callback_query.answer(f\"‚úÖ {variable_name} –æ–±–Ω–æ–≤–ª–µ–Ω–æ\")\n        \n        # –°–æ–∑–¥–∞–µ–º –∏–º–∏—Ç–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Ñ–∏–ª—å\n        class FakeMessage:\n            def __init__(self, callback_query):\n                self.from_user = callback_query.from_user\n                self.chat = callback_query.message.chat\n                self.date = callback_query.message.date\n                self.message_id = callback_query.message.message_id\n            \n            async def answer(self, text, parse_mode=None, reply_markup=None):\n                if reply_markup:\n                    await bot.send_message(self.chat.id, text, parse_mode=parse_mode, reply_markup=reply_markup)\n                else:\n                    await bot.send_message(self.chat.id, text, parse_mode=parse_mode)\n            \n            async def edit_text(self, text, parse_mode=None, reply_markup=None):\n                try:\n                    await bot.edit_message_text(text, self.chat.id, self.message_id, parse_mode=parse_mode, reply_markup=reply_markup)\n                except Exception:\n                    await self.answer(text, parse_mode, reply_markup)\n        \n        fake_message = FakeMessage(callback_query)\n        \n        # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Ñ–∏–ª—è\n        try:\n            await profile_handler(fake_message)\n        except Exception as e:\n            logging.error(f\"–û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ profile_handler: {e}\")\n            await callback_query.message.answer(f\"‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ {variable_name} –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞: {variable_value}\")\n    else:\n        logging.warning(f\"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —É—Å–ª–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏: {callback_query.data}\")\n        await callback_query.answer(\"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏\", show_alert=True)\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–æ–º–∞–Ω–¥\n# –ù–∞–π–¥–µ–Ω–æ 1 –∫–Ω–æ–ø–æ–∫ –∫–æ–º–∞–Ω–¥: cmd_start\n\n@dp.callback_query(lambda c: c.data == \"cmd_start\")\nasync def handle_cmd_start(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    logging.info(f\"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –∫–æ–º–∞–Ω–¥—ã: cmd_start -> /start (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback_query.from_user.id})\")\n    # –°–∏–º—É–ª–∏—Ä—É–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /start\n    \n    # –°–æ–∑–¥–∞–µ–º fake message object –¥–ª—è –∫–æ–º–∞–Ω–¥—ã\n    from types import SimpleNamespace\n    fake_message = SimpleNamespace()\n    fake_message.from_user = callback_query.from_user\n    fake_message.chat = callback_query.message.chat\n    fake_message.date = callback_query.message.date\n    fake_message.answer = callback_query.message.answer\n    fake_message.edit_text = callback_query.message.edit_text\n    \n    # –í—ã–∑—ã–≤–∞–µ–º start handler —á–µ—Ä–µ–∑ edit_text\n    # –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è\n    class FakeMessageEdit:\n        def __init__(self, callback_query):\n            self.from_user = callback_query.from_user\n            self.chat = callback_query.message.chat\n            self.date = callback_query.message.date\n            self.message_id = callback_query.message.message_id\n            self._callback_query = callback_query\n        \n        async def answer(self, text, parse_mode=None, reply_markup=None):\n            await self._callback_query.message.edit_text(text, parse_mode=parse_mode, reply_markup=reply_markup)\n        \n        async def edit_text(self, text, parse_mode=None, reply_markup=None):\n            await self._callback_query.message.edit_text(text, parse_mode=parse_mode, reply_markup=reply_markup)\n    \n    fake_edit_message = FakeMessageEdit(callback_query)\n    await start_handler(fake_edit_message)\n    logging.info(f\"–ö–æ–º–∞–Ω–¥–∞ /start –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ callback –∫–Ω–æ–ø–∫—É (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback_query.from_user.id})\")\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Ñ–∏–ª—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π variableLabel\n@dp.message(Command(\"profile\"))\nasync def profile_handler(message: types.Message):\n    user_id = message.from_user.id\n    \n    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    if not user_vars:\n        await message.answer(\"üë§ –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\\n\\n–ü–æ—Ö–æ–∂–µ, –≤—ã –µ—â–µ –Ω–µ –ø—Ä–æ—à–ª–∏ –æ–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ /start —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.\")\n        return\n    \n    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π variableLabel\n    profile_text = \"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\\n\\n\"\n    \n    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\n    for var_name, var_data in user_vars.items():\n        if isinstance(var_data, dict) and \"value\" in var_data:\n            value = var_data[\"value\"]\n        else:\n            value = var_data\n        profile_text += f\"{var_name}: {value}\\n\"\n    \n    await message.answer(profile_text)\n    logging.info(f\"–ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}\")\n\n\n\n# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞\nasync def main():\n    global db_pool\n    try:\n        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        await init_database()\n        print(\"ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!\")\n        await dp.start_polling(bot)\n    except KeyboardInterrupt:\n        print(\"üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...\")\n    except Exception as e:\n        logging.error(f\"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}\")\n    finally:\n        # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\n        if db_pool:\n            await db_pool.close()\n            print(\"üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–æ\")\n        \n        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –±–æ—Ç–∞\n        await bot.session.close()\n        print(\"üîå –°–µ—Å—Å–∏—è –±–æ—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∞\")\n        print(\"‚úÖ –ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É\")\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n@dp.callback_query(lambda c: c.data.startswith(\"ms_\") or c.data.startswith(\"multi_select_\"))\nasync def handle_multi_select_callback(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    callback_data = callback_query.data\n    \n    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ \"–ì–æ—Ç–æ–≤–æ\"\n    if callback_data.startswith(\"done_\"):\n        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)\n        logging.info(f\"üèÅ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ì–æ—Ç–æ–≤–æ: {callback_data}\")\n        short_node_id = callback_data.replace(\"done_\", \"\")\n        # –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–Ω—ã–π node_id –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–º—É —Å—É—Ñ—Ñ–∏–∫—Å—É\n        node_id = None\n        if short_node_id == \"start\":\n            node_id = \"start\"\n            logging.info(f\"‚úÖ –ù–∞–π–¥–µ–Ω —É–∑–µ–ª: start\")\n        if short_node_id == \"a12dc5bu6\":\n            node_id = \"metro_selection_paste_1754804051442_a12dc5bu6\"\n            logging.info(f\"‚úÖ –ù–∞–π–¥–µ–Ω —É–∑–µ–ª: metro_selection_paste_1754804051442_a12dc5bu6\")\n    elif callback_data.startswith(\"multi_select_done_\"):\n        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)\n        node_id = callback_data.replace(\"multi_select_done_\", \"\")\n        selected_options = user_data.get(user_id, {}).get(f\"multi_select_{node_id}\", [])\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        if selected_options:\n            selected_text = \", \".join(selected_options)\n            if node_id == \"start\":\n                await save_user_data_to_db(user_id, \"user_interests\", selected_text)\n            if node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n                await save_user_data_to_db(user_id, \"metro_lines\", selected_text)\n            # –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ —É–∑–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω\n            if not any(node_id == node for node in [\"start\", \"metro_selection_paste_1754804051442_a12dc5bu6\"]):\n                await save_user_data_to_db(user_id, f\"multi_select_{node_id}\", selected_text)\n        \n        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n        if user_id in user_data:\n            user_data[user_id].pop(f\"multi_select_{node_id}\", None)\n            user_data[user_id].pop(\"multi_select_node\", None)\n        \n        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω\n        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª –¥–ª—è –∫–∞–∂–¥–æ–≥–æ node_id\n        if node_id == \"start\":\n            # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É metro_selection_paste_1754804051442_a12dc5bu6\n            logging.info(f\"üîÑ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —É–∑–ª—É metro_selection_paste_1754804051442_a12dc5bu6 (—Ç–∏–ø: message)\")\n            await handle_callback_metro_selection_paste_1754804051442_a12dc5bu6(callback_query)\n        if node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n            # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É interests_result\n            logging.info(f\"üîÑ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —É–∑–ª—É interests_result (—Ç–∏–ø: message)\")\n            await handle_callback_interests_result(callback_query)\n        return\n    \n    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–∏\n    logging.info(f\"üì± –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º callback_data: {callback_data}\")\n    \n    # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∏ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç ms_ –∏ —Å—Ç–∞—Ä—ã–π multi_select_\n    if callback_data.startswith(\"ms_\"):\n        # –ù–æ–≤—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç: ms_shortNodeId_shortTarget\n        parts = callback_data.split(\"_\")\n        if len(parts) >= 3:\n            short_node_id = parts[1]\n            button_id = \"_\".join(parts[2:])\n            # –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–Ω—ã–π node_id –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–º—É —Å—É—Ñ—Ñ–∏–∫—Å—É\n            node_id = None\n            logging.info(f\"üîç –ò—â–µ–º —É–∑–µ–ª –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–º—É ID: {short_node_id}\")\n            if short_node_id == \"start\":\n                node_id = \"start\"\n                logging.info(f\"‚úÖ –ù–∞–π–¥–µ–Ω —É–∑–µ–ª: {node_id}\")\n            if short_node_id == \"a12dc5bu6\":\n                node_id = \"metro_selection_paste_1754804051442_a12dc5bu6\"\n                logging.info(f\"‚úÖ –ù–∞–π–¥–µ–Ω —É–∑–µ–ª: {node_id}\")\n    elif callback_data.startswith(\"multi_select_\"):\n        # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏\n        parts = callback_data.split(\"_\")\n        if len(parts) >= 3:\n            node_id = parts[2]\n            button_id = \"_\".join(parts[3:]) if len(parts) > 3 else parts[2]\n    else:\n        logging.warning(f\"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data: {callback_data}\")\n        return\n    \n    if not node_id:\n        logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ node_id –¥–ª—è callback_data: {callback_data}\")\n        return\n    \n    logging.info(f\"üì± –û–ø—Ä–µ–¥–µ–ª–∏–ª–∏ node_id: {node_id}, button_id: {button_id}\")\n    \n    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏–∑ –ë–î\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    \n    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–Ω–µ–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n    if f\"multi_select_{node_id}\" not in user_data[user_id]:\n        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã\n        user_vars = await get_user_from_db(user_id)\n        saved_selections = []\n        \n        if user_vars:\n            # –ò—â–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏\n            for var_name, var_data in user_vars.items():\n                if \"–∏–Ω—Ç–µ—Ä–µ—Å\" in var_name.lower() or var_name == \"interests\" or var_name.startswith(\"multi_select_\"):\n                    if isinstance(var_data, dict) and \"value\" in var_data:\n                        saved_str = var_data[\"value\"]\n                    elif isinstance(var_data, str):\n                        saved_str = var_data\n                    else:\n                        saved_str = str(var_data) if var_data else \"\"\n                    \n                    if saved_str:\n                        saved_selections = [item.strip() for item in saved_str.split(\",\")]\n                        break\n        \n        user_data[user_id][f\"multi_select_{node_id}\"] = saved_selections\n    \n    # –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ button_id\n    button_text = None\n    if node_id == \"start\":\n        if button_id == \"sport\":\n            button_text = \"‚öΩ –°–ø–æ—Ä—Ç\"\n        if button_id == \"music\":\n            button_text = \"üéµ –ú—É–∑—ã–∫–∞\"\n        if button_id == \"books\":\n            button_text = \"üìö –ö–Ω–∏–≥–∏\"\n        if button_id == \"travel\":\n            button_text = \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\"\n        if button_id == \"tech\":\n            button_text = \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\"\n        if button_id == \"cooking\":\n            button_text = \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\"\n        if button_id == \"art\":\n            button_text = \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\"\n        if button_id == \"games\":\n            button_text = \"üéÆ –ò–≥—Ä—ã\"\n    if node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n        if button_id == \"red_line\":\n            button_text = \"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\"\n        if button_id == \"blue_line\":\n            button_text = \"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\"\n        if button_id == \"green_line\":\n            button_text = \"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\"\n        if button_id == \"orange_line\":\n            button_text = \"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\"\n        if button_id == \"purple_line\":\n            button_text = \"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\"\n        if button_id == \"lo_cities\":\n            button_text = \"–Ø –∏–∑ –õ–û üè°\"\n        if button_id == \"not_in_spb\":\n            button_text = \"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\"\n    \n    if button_text:\n        logging.info(f\"üîò –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É: {button_text}\")\n        selected_list = user_data[user_id][f\"multi_select_{node_id}\"]\n        if button_text in selected_list:\n            # –£–±–∏—Ä–∞–µ–º –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö\n            selected_list.remove(button_text)\n            logging.info(f\"‚ûñ –£–±—Ä–∞–ª–∏ –≤—ã–±–æ—Ä: {button_text}\")\n        else:\n            # –î–æ–±–∞–≤–ª—è–µ–º –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º\n            selected_list.append(button_text)\n            logging.info(f\"‚ûï –î–æ–±–∞–≤–∏–ª–∏ –≤—ã–±–æ—Ä: {button_text}\")\n        \n        logging.info(f\"üìã –¢–µ–∫—É—â–∏–µ –≤—ã–±–æ—Ä—ã: {selected_list}\")\n        \n        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≥–∞–ª–æ—á–∫–∞–º–∏\n        builder = InlineKeyboardBuilder()\n        if node_id == \"start\":\n            selected_mark = \"‚úÖ \" if \"‚öΩ –°–ø–æ—Ä—Ç\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}‚öΩ –°–ø–æ—Ä—Ç\", callback_data=\"multi_select_start_sport\"))\n            selected_mark = \"‚úÖ \" if \"üéµ –ú—É–∑—ã–∫–∞\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}üéµ –ú—É–∑—ã–∫–∞\", callback_data=\"multi_select_start_music\"))\n            selected_mark = \"‚úÖ \" if \"üìö –ö–Ω–∏–≥–∏\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}üìö –ö–Ω–∏–≥–∏\", callback_data=\"multi_select_start_books\"))\n            selected_mark = \"‚úÖ \" if \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\", callback_data=\"multi_select_start_travel\"))\n            selected_mark = \"‚úÖ \" if \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\", callback_data=\"multi_select_start_tech\"))\n            selected_mark = \"‚úÖ \" if \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\", callback_data=\"multi_select_start_cooking\"))\n            selected_mark = \"‚úÖ \" if \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\", callback_data=\"multi_select_start_art\"))\n            selected_mark = \"‚úÖ \" if \"üéÆ –ò–≥—Ä—ã\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}üéÆ –ò–≥—Ä—ã\", callback_data=\"multi_select_start_games\"))\n            builder.add(InlineKeyboardButton(text=\"–ì–æ—Ç–æ–≤–æ\", callback_data=\"multi_select_done_start\"))\n            builder.adjust(2, 2, 2, 2, 1)\n        if node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n            selected_mark = \"‚úÖ \" if \"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\", callback_data=\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6_red_line\"))\n            selected_mark = \"‚úÖ \" if \"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\", callback_data=\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6_lue_line\"))\n            selected_mark = \"‚úÖ \" if \"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\", callback_data=\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6_een_line\"))\n            selected_mark = \"‚úÖ \" if \"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\", callback_data=\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6_nge_line\"))\n            selected_mark = \"‚úÖ \" if \"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\", callback_data=\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6_ple_line\"))\n            selected_mark = \"‚úÖ \" if \"–Ø –∏–∑ –õ–û üè°\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}–Ø –∏–∑ –õ–û üè°\", callback_data=\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6_o_cities\"))\n            selected_mark = \"‚úÖ \" if \"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\" in selected_list else \"\"\n            builder.add(InlineKeyboardButton(text=f\"{selected_mark}–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\", callback_data=\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6_t_in_spb\"))\n            builder.add(InlineKeyboardButton(text=\"–ì–æ—Ç–æ–≤–æ\", callback_data=\"multi_select_done_metro_selection_paste_1754804051442_a12dc5bu6\"))\n            builder.adjust(2, 2, 2, 2, 1)\n        \n        keyboard = builder.as_markup()\n        await callback_query.message.edit_reply_markup(reply_markup=keyboard)\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n@dp.callback_query(lambda callback_query: callback_query.data and callback_query.data.startswith(\"multi_select_done_\"))\nasync def handle_multi_select_done(callback_query: types.CallbackQuery):\n    logging.info(f\"üèÅ –û–ë–†–ê–ë–û–¢–ß–ò–ö –ì–û–¢–û–í–û –ê–ö–¢–ò–í–ò–†–û–í–ê–ù! callback_data: {callback_query.data}\")\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    callback_data = callback_query.data\n    \n    logging.info(f\"üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞: {callback_data}\")\n    logging.info(f\"üîç –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ID: {callback_query.message.message_id}\")\n    logging.info(f\"üîç –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: {callback_query.message.text}\")\n    logging.info(f\"üîç –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –ï—Å—Ç—å –ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞: {bool(callback_query.message.reply_markup)}\")\n    \n    # –ò–∑–≤–ª–µ–∫–∞–µ–º node_id –∏–∑ callback_data\n    node_id = callback_data.replace(\"multi_select_done_\", \"\")\n    logging.info(f\"üéØ Node ID –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {node_id}\")\n    \n    if node_id == \"start\":\n        logging.info(f\"üîç –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–ª—è —É–∑–ª–∞ start\")\n        logging.info(f\"üîç –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: continueButtonTarget = metro_selection_paste_1754804051442_a12dc5bu6\")\n        # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è —É–∑–ª–∞ start\n        selected_options = user_data.get(user_id, {}).get(\"multi_select_start\", [])\n        logging.info(f\"üìã –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –í—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è start: {selected_options}\")\n        \n        if selected_options:\n            selected_text = \", \".join(selected_options)\n            await save_user_data_to_db(user_id, \"user_interests\", selected_text)\n            logging.info(f\"üíæ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –≤ –ë–î: user_interests = {selected_text}\")\n        else:\n            logging.info(f\"‚ö†Ô∏è –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\")\n        \n        # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: metro_selection_paste_1754804051442_a12dc5bu6\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —É–∑–ª—É {continueButtonTarget}\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –¢–∏–ø —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞: message\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: allowMultipleSelection: true\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –ï—Å—Ç—å –ª–∏ –∫–Ω–æ–ø–∫–∏: 7\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: keyboardType: inline\")\n        # –£–∑–µ–ª metro_selection_paste_1754804051442_a12dc5bu6 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n        logging.info(f\"üîß –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è —É–∑–ª–∞ metro_selection_paste_1754804051442_a12dc5bu6\")\n        if user_id not in user_data:\n            user_data[user_id] = {}\n        user_data[user_id][\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\"] = []\n        user_data[user_id][\"multi_select_node\"] = \"metro_selection_paste_1754804051442_a12dc5bu6\"\n        user_data[user_id][\"multi_select_type\"] = \"inline\"\n        logging.info(f\"üîß –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —É–∑–ª–∞ metro_selection_paste_1754804051442_a12dc5bu6\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –í—ã–∑—ã–≤–∞–µ–º handle_callback_{safeFunctionName}\")\n        await handle_callback_metro_selection_paste_1754804051442_a12dc5bu6(callback_query)\n        return\n    \n    if node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n        logging.info(f\"üîç –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–ª—è —É–∑–ª–∞ metro_selection_paste_1754804051442_a12dc5bu6\")\n        logging.info(f\"üîç –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: continueButtonTarget = interests_result\")\n        # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è —É–∑–ª–∞ metro_selection_paste_1754804051442_a12dc5bu6\n        selected_options = user_data.get(user_id, {}).get(\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\", [])\n        logging.info(f\"üìã –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –í—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è metro_selection_paste_1754804051442_a12dc5bu6: {selected_options}\")\n        \n        if selected_options:\n            selected_text = \", \".join(selected_options)\n            await save_user_data_to_db(user_id, \"metro_lines\", selected_text)\n            logging.info(f\"üíæ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –≤ –ë–î: metro_lines = {selected_text}\")\n        else:\n            logging.info(f\"‚ö†Ô∏è –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\")\n        \n        # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: interests_result\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —É–∑–ª—É {continueButtonTarget}\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –¢–∏–ø —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞: message\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: allowMultipleSelection: false\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –ï—Å—Ç—å –ª–∏ –∫–Ω–æ–ø–∫–∏: 2\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: keyboardType: inline\")\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –í—ã–∑—ã–≤–∞–µ–º handle_callback_{safeFunctionName}\")\n        # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è interests_result - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –∫ interests_result - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ\")\n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ—Ç—Ä–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É–∑–ª–∞\n        metro_state = user_data.get(user_id, {}).get(\"multi_select_metro_selection_paste_1754804051442_a12dc5bu6\", [])\n        if user_id not in user_data:\n            user_data[user_id] = {}\n        user_data[user_id][\"saved_metro_selection\"] = metro_state\n        user_data[user_id][\"show_metro_keyboard\"] = True\n        logging.info(f\"üöÄ –ì–ï–ù–ï–†–ê–¢–û–† DEBUG: –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –º–µ—Ç—Ä–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {metro_state}\")\n        await handle_callback_interests_result(callback_query)\n        return\n    \n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è reply –∫–Ω–æ–ø–æ–∫ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n@dp.message()\nasync def handle_multi_select_reply(message: types.Message):\n    user_id = message.from_user.id\n    user_input = message.text\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ reply\n    if user_id in user_data and \"multi_select_node\" in user_data[user_id] and user_data[user_id].get(\"multi_select_type\") == \"reply\":\n        node_id = user_data[user_id][\"multi_select_node\"]\n        \n        if node_id == \"start\" and user_input == \"–ì–æ—Ç–æ–≤–æ\":\n            # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¥–ª—è —É–∑–ª–∞ start\n            selected_options = user_data.get(user_id, {}).get(\"multi_select_{node_id}\", [])\n            if selected_options:\n                selected_text = \", \".join(selected_options)\n                await save_user_data_to_db(user_id, \"user_interests\", selected_text)\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n            user_data[user_id].pop(\"multi_select_{node_id}\", None)\n            user_data[user_id].pop(\"multi_select_node\", None)\n            user_data[user_id].pop(\"multi_select_type\", None)\n            \n            # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É\n            await handle_callback_metro_selection_paste_1754804051442_a12dc5bu6(types.CallbackQuery(id=\"multi_select\", from_user=message.from_user, chat_instance=\"\", data=\"metro_selection_paste_1754804051442_a12dc5bu6\", message=message))\n            return\n        \n        if node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\" and user_input == \"–ì–æ—Ç–æ–≤–æ\":\n            # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¥–ª—è —É–∑–ª–∞ metro_selection_paste_1754804051442_a12dc5bu6\n            selected_options = user_data.get(user_id, {}).get(\"multi_select_{node_id}\", [])\n            if selected_options:\n                selected_text = \", \".join(selected_options)\n                await save_user_data_to_db(user_id, \"metro_lines\", selected_text)\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n            user_data[user_id].pop(\"multi_select_{node_id}\", None)\n            user_data[user_id].pop(\"multi_select_node\", None)\n            user_data[user_id].pop(\"multi_select_type\", None)\n            \n            # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É\n            await handle_callback_interests_result(types.CallbackQuery(id=\"multi_select\", from_user=message.from_user, chat_instance=\"\", data=\"interests_result\", message=message))\n            return\n        \n        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–∏\n        if node_id == \"start\":\n            if user_input == \"‚öΩ –°–ø–æ—Ä—Ç\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"‚öΩ –°–ø–æ—Ä—Ç\" in selected_list:\n                    selected_list.remove(\"‚öΩ –°–ø–æ—Ä—Ç\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: ‚öΩ –°–ø–æ—Ä—Ç\")\n                else:\n                    selected_list.append(\"‚öΩ –°–ø–æ—Ä—Ç\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: ‚öΩ –°–ø–æ—Ä—Ç\")\n                return\n            \n            if user_input == \"üéµ –ú—É–∑—ã–∫–∞\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üéµ –ú—É–∑—ã–∫–∞\" in selected_list:\n                    selected_list.remove(\"üéµ –ú—É–∑—ã–∫–∞\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üéµ –ú—É–∑—ã–∫–∞\")\n                else:\n                    selected_list.append(\"üéµ –ú—É–∑—ã–∫–∞\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üéµ –ú—É–∑—ã–∫–∞\")\n                return\n            \n            if user_input == \"üìö –ö–Ω–∏–≥–∏\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üìö –ö–Ω–∏–≥–∏\" in selected_list:\n                    selected_list.remove(\"üìö –ö–Ω–∏–≥–∏\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üìö –ö–Ω–∏–≥–∏\")\n                else:\n                    selected_list.append(\"üìö –ö–Ω–∏–≥–∏\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üìö –ö–Ω–∏–≥–∏\")\n                return\n            \n            if user_input == \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\" in selected_list:\n                    selected_list.remove(\"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: ‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\")\n                else:\n                    selected_list.append(\"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: ‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\")\n                return\n            \n            if user_input == \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\" in selected_list:\n                    selected_list.remove(\"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\")\n                else:\n                    selected_list.append(\"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\")\n                return\n            \n            if user_input == \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\" in selected_list:\n                    selected_list.remove(\"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\")\n                else:\n                    selected_list.append(\"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\")\n                return\n            \n            if user_input == \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\" in selected_list:\n                    selected_list.remove(\"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\")\n                else:\n                    selected_list.append(\"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\")\n                return\n            \n            if user_input == \"üéÆ –ò–≥—Ä—ã\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üéÆ –ò–≥—Ä—ã\" in selected_list:\n                    selected_list.remove(\"üéÆ –ò–≥—Ä—ã\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üéÆ –ò–≥—Ä—ã\")\n                else:\n                    selected_list.append(\"üéÆ –ò–≥—Ä—ã\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üéÆ –ò–≥—Ä—ã\")\n                return\n            \n        if node_id == \"metro_selection_paste_1754804051442_a12dc5bu6\":\n            if user_input == \"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\" in selected_list:\n                    selected_list.remove(\"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: –ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\")\n                else:\n                    selected_list.append(\"–ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: –ö—Ä–∞—Å–Ω–∞—è –≤–µ—Ç–∫–∞ üü•\")\n                return\n            \n            if user_input == \"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\" in selected_list:\n                    selected_list.remove(\"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: –°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\")\n                else:\n                    selected_list.append(\"–°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: –°–∏–Ω—è—è –≤–µ—Ç–∫–∞ üü¶\")\n                return\n            \n            if user_input == \"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\" in selected_list:\n                    selected_list.remove(\"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: –ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\")\n                else:\n                    selected_list.append(\"–ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: –ó–µ–ª—ë–Ω–∞—è –≤–µ—Ç–∫–∞ üü©\")\n                return\n            \n            if user_input == \"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\" in selected_list:\n                    selected_list.remove(\"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: –û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\")\n                else:\n                    selected_list.append(\"–û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: –û—Ä–∞–Ω–∂–µ–≤–∞—è –≤–µ—Ç–∫–∞ üüß\")\n                return\n            \n            if user_input == \"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\" in selected_list:\n                    selected_list.remove(\"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\")\n                else:\n                    selected_list.append(\"–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–µ—Ç–∫–∞ üü™\")\n                return\n            \n            if user_input == \"–Ø –∏–∑ –õ–û üè°\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"–Ø –∏–∑ –õ–û üè°\" in selected_list:\n                    selected_list.remove(\"–Ø –∏–∑ –õ–û üè°\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: –Ø –∏–∑ –õ–û üè°\")\n                else:\n                    selected_list.append(\"–Ø –∏–∑ –õ–û üè°\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: –Ø –∏–∑ –õ–û üè°\")\n                return\n            \n            if user_input == \"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\" in selected_list:\n                    selected_list.remove(\"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: –Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\")\n                else:\n                    selected_list.append(\"–Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: –Ø –Ω–µ –≤ –ü–∏—Ç–µ—Ä–µ üåç\")\n                return\n            \n    \n    # –ï—Å–ª–∏ –Ω–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä, –ø–µ—Ä–µ–¥–∞–µ–º –¥–∞–ª—å—à–µ –ø–æ —Ü–µ–ø–æ—á–∫–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤\n    pass\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n"}