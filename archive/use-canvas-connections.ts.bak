/**
 * @fileoverview Хук для управления соединениями между узлами холста
 * 
 * Содержит логику создания, завершения и авто-создания соединений
 * в компоненте визуального редактора ботов.
 */

import { useCallback, useState } from 'react';
import { nanoid } from 'nanoid';
import { Connection } from '@/types/bot';

/**
 * Свойства хука для управления соединениями
 */
interface UseCanvasConnectionsProps {
  /** Колбэк при добавлении соединения */
  onConnectionAdd?: (connection: Connection) => void;
  /** Колбэк для логирования действий в историю */
  onActionLog?: (type: 'connect', description: string) => void;
  /** Установщик состояния видимости подсказок */
  setShowSuggestions?: (show: boolean) => void;
}

/**
 * Хук для управления соединениями между узлами
 * 
 * @param props - Свойства хука
 * @returns Объект с функциями управления соединениями
 */
export function useCanvasConnections({
  onConnectionAdd,
  onActionLog,
  setShowSuggestions
}: UseCanvasConnectionsProps) {
  /**
   * Состояние начала соединения (узел и ручка)
   */
  const [connectionStart, setConnectionStart] = useState<{
    nodeId: string;
    handle: 'source' | 'target';
  } | null>(null);

  /**
   * Обработчик начала создания соединения
   * 
   * @param nodeId - Идентификатор узла
   * @param handle - Тип ручки ('source' или 'target')
   */
  const handleConnectionStart = useCallback((nodeId: string, handle: 'source' | 'target') => {
    if (connectionStart) {
      // Если уже есть начало соединения, пытаемся завершить его
      if (connectionStart.nodeId !== nodeId) {
        const sourceId = connectionStart.handle === 'source' ? connectionStart.nodeId : nodeId;
        const targetId = connectionStart.handle === 'source' ? nodeId : connectionStart.nodeId;

        try {
          const newConnection: Connection = {
            id: nanoid(),
            source: sourceId,
            target: targetId,
            isInterSheet: false,
            isAutoGenerated: false,
          };

          onActionLog?.('connect', 'Создано соединение между узлами');
          onConnectionAdd?.(newConnection);
        } catch (error) {
          console.error('Ошибка при создании соединения:', error);
        }
      }
      setConnectionStart(null);
    } else {
      // Начинаем новое соединение
      setConnectionStart({ nodeId, handle });
    }
  }, [connectionStart, onConnectionAdd, onActionLog]);

  /**
   * Создание предложенного соединения
   * 
   * @param source - Идентификатор источника
   * @param target - Идентификатор цели
   */
  const handleCreateSuggestedConnection = useCallback((source: string, target: string) => {
    const newConnection: Connection = {
      id: nanoid(),
      source,
      target,
      isInterSheet: false,
      isAutoGenerated: false,
    };
    onActionLog?.('connect', 'Создано предложенное соединение');
    onConnectionAdd?.(newConnection);
    setShowSuggestions?.(false);
  }, [onConnectionAdd, onActionLog, setShowSuggestions]);

  return {
    connectionStart,
    setConnectionStart,
    handleConnectionStart,
    handleCreateSuggestedConnection
  };
}
