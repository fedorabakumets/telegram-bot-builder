/**
 * @fileoverview –ú–æ–¥—É–ª—å –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤
 *
 * –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö
 * —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–æ–≤, –≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏
 * –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
 *
 * @module graceful-shutdown
 */

/**
 * –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–æ–≤
 * @external botProcesses
 * @see {@link ./routes}
 */
import { botProcesses } from "./routes";

/**
 * –ú–æ–¥—É–ª—å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –¥–∞–Ω–Ω—ã—Ö
 * @external storage
 * @see {@link ./storage}
 */
import { storage } from "./storage";

/**
 * –ú–æ–¥—É–ª—å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
 * @external child_process
 */
import { execSync } from "node:child_process";

/**
 * –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–æ–≤
 *
 * –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
 * 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–æ–≤ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
 * 2. –£–±–∏–≤–∞–µ—Ç –≤—Å–µ Python-–ø—Ä–æ—Ü–µ—Å—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –±–æ—Ç–∞–º–∏ (–≤–∫–ª—é—á–∞—è –∑–∞–≤–∏—Å—à–∏–µ)
 * 3. –û—á–∏—â–∞–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–æ–≤
 * 4. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
 *
 * @async
 * @function shutdownAllBots
 * @returns {Promise<void>} –ü—Ä–æ–º–∏—Å, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
 *
 * @description
 * –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏:
 * - –ü–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ botProcesses
 * - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∂–¥–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É —Å–∏–≥–Ω–∞–ª SIGTERM –¥–ª—è –º—è–≥–∫–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
 * - –ñ–¥–µ—Ç 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
 * - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª SIGKILL –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
 * - –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –≤—Å–µ—Ö Python-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö 'bot_' –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
 * - –û—á–∏—â–∞–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é botProcesses
 * - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –±–æ—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω
 *
 * @example
 * ```typescript
 * import { shutdownAllBots } from './graceful-shutdown';
 *
 * // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–µ—Ä–≤–µ—Ä–∞
 * await shutdownAllBots();
 * console.log('–í—Å–µ –±–æ—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ã');
 * ```
 *
 * @throws {Error} –ú–æ–∂–µ—Ç –≤—ã–±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫—É –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
 *
 * @author Telegram Bot Builder
 * @since 1.0.0
 */
export async function shutdownAllBots(): Promise<void> {
  console.log('üõë –ù–∞—á–∏–Ω–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö –±–æ—Ç–æ–≤...');

  /**
   * –≠—Ç–∞–ø 1: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–æ–≤ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
   *
   * –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ botProcesses –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º —Å–∏–≥–Ω–∞–ª—ã
   * –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: —Å–Ω–∞—á–∞–ª–∞ SIGTERM (–º—è–≥–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞), –∑–∞—Ç–µ–º
   * —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã SIGKILL (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞), –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω.
   */
  for (const [key, process] of botProcesses.entries()) {
    try {
      console.log(`–£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ —Å –∫–ª—é—á–æ–º: ${key}, PID: ${process.pid}`);

      // –ú—è–≥–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
      process.kill('SIGTERM');

      // –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      await new Promise(resolve => setTimeout(resolve, 2000));

      // –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Å–µ –µ—â–µ –∂–∏–≤, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º
      try {
        process.kill('SIGKILL');
      } catch (e) {
        // –ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω
      }
    } catch (error) {
      console.log(`–ü—Ä–æ—Ü–µ—Å—Å ${key} —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:`, error);
    }
  }

  /**
   * –≠—Ç–∞–ø 2: –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –≤—Å–µ—Ö Python-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –±–æ—Ç–∞–º–∏
   *
   * –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Python,
   * –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å –±–æ—Ç–∞–º–∏ (–∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ —Å–æ–¥–µ—Ä–∂–∞—Ç 'bot_').
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–∞–µ—Ç—Å—è –¥–ª—è Windows –∏ Unix-–ø–æ–¥–æ–±–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.
   */
  try {
    if (process.platform === 'win32') {
      // –í Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–∞–Ω–¥—É tasklist –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
      try {
        const tasklistOutput = execSync(`tasklist /FI "IMAGENAME eq python.exe" /FO CSV 2>nul`, { encoding: 'utf8' }).trim();

        if (tasklistOutput && tasklistOutput.includes('bot_')) {
          const lines = tasklistOutput.split('\n').filter(line => line.trim() && line.includes('bot_'));

          for (const line of lines) {
            // –í—ã–≤–æ–¥ tasklist –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV: "Image Name","PID",...
            const match = line.match(/"([^"]*)","(\d+)"/);
            if (match) {
              const imageName = match[1];
              const pid = parseInt(match[2]);

              if (imageName && imageName.includes('bot_') && pid && !isNaN(pid)) {
                try {
                  console.log(`–£–±–∏–≤–∞–µ–º Python-–ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ ${imageName} —Å PID: ${pid}`);
                  execSync(`taskkill /PID ${pid} /F`, { encoding: 'utf8' });
                } catch (killError) {
                  console.log(`–ü—Ä–æ—Ü–µ—Å—Å ${pid} —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`);
                }
              }
            }
          }
        }
      } catch (tasklistError) {
        console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ tasklist:', tasklistError);
      }
    } else {
      // –í Unix-–ø–æ–¥–æ–±–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–∞–Ω–¥—É ps –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
      try {
        const psOutput = execSync(`ps aux | grep python | grep bot_ | grep -v grep`, { encoding: 'utf8' }).trim();

        if (psOutput) {
          const lines = psOutput.split('\n').filter(line => line.trim());
          for (const line of lines) {
            const parts = line.trim().split(/\s+/);
            const pid = parseInt(parts[1]);

            if (pid && !isNaN(pid)) {
              try {
                console.log(`–£–±–∏–≤–∞–µ–º Python-–ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ —Å PID: ${pid}`);
                execSync(`kill -9 ${pid}`, { encoding: 'utf8' });
              } catch (killError) {
                console.log(`–ü—Ä–æ—Ü–µ—Å—Å ${pid} —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`);
              }
            }
          }
        }
      } catch (psError) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å ps –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–æ–≤:', psError);
      }
    }
  } catch (error) {
    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–ª–∏ —É–±–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–æ–≤:', error);
  }

  /**
   * –≠—Ç–∞–ø 3: –û—á–∏—Å—Ç–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–æ–≤
   *
   * –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ botProcesses, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–∞–º—è—Ç—å
   * –∏ –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–ø—ã—Ç–æ–∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.
   */
  botProcesses.clear();

  /**
   * –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –±–æ—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ø—É–ª–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
   *
   * –ï—Å–ª–∏ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
   * –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–æ–≤ –Ω–∞ 'stopped'. –ï—Å–ª–∏ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   * —É–∂–µ –∑–∞–∫—Ä—ã—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —ç—Ç–∞–ø.
   */
  if (globalThis.__dbPoolActive !== false) {
    try {
      const allInstances = await storage.getAllBotInstances();
      for (const instance of allInstances) {
        if (instance.status === 'running') {
          await storage.updateBotInstance(instance.id, {
            status: 'stopped',
            stoppedAt: new Date(),
            errorMessage: '–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
          });
        }
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–æ–≤:', error);
    }
  } else {
    console.log('‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–æ–≤ - –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∑–∞–∫—Ä—ã—Ç');
  }

  console.log('‚úÖ –í—Å–µ –±–æ—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ã');
}