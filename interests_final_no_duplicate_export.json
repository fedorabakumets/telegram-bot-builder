{"code":"\"\"\"\n–ú–æ–π –ø–µ—Ä–≤—ã–π –±–æ—Ç - Telegram Bot\n–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é TelegramBot Builder\n\"\"\"\n\nimport asyncio\nimport logging\nimport os\nfrom aiogram import Bot, Dispatcher, types, F\nfrom aiogram.filters import CommandStart, Command\nfrom aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, BotCommand, ReplyKeyboardRemove, URLInputFile, FSInputFile\nfrom aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder\nfrom aiogram.enums import ParseMode\nfrom typing import Optional\nimport asyncpg\nfrom datetime import datetime, timezone, timedelta\nimport json\n\n# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏\ndef get_moscow_time():\n    \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ\"\"\"\n    moscow_tz = timezone(timedelta(hours=3))  # UTC+3 –¥–ª—è –ú–æ—Å–∫–≤—ã\n    return datetime.now(moscow_tz).isoformat()\n\n# –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç–µ —É @BotFather)\nBOT_TOKEN = \"YOUR_BOT_TOKEN_HERE\"\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\nlogging.basicConfig(level=logging.INFO)\n\n# –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞\nbot = Bot(token=BOT_TOKEN)\ndp = Dispatcher()\n\n# –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π Telegram ID)\nADMIN_IDS = [123456789]  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\nDATABASE_URL = os.getenv(\"DATABASE_URL\")\n\n# –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö\ndb_pool = None\n\n# –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –¥–ª—è —Å–ª—É—á–∞–µ–≤ –±–µ–∑ –ë–î)\nuser_data = {}\n\n\n# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö\nasync def init_database():\n    \"\"\"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü\"\"\"\n    global db_pool\n    try:\n        db_pool = await asyncpg.create_pool(DATABASE_URL, min_size=1, max_size=10)\n        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç\n        async with db_pool.acquire() as conn:\n            await conn.execute(\"\"\"\n                CREATE TABLE IF NOT EXISTS bot_users (\n                    user_id BIGINT PRIMARY KEY,\n                    username TEXT,\n                    first_name TEXT,\n                    last_name TEXT,\n                    registered_at TIMESTAMP DEFAULT NOW(),\n                    last_interaction TIMESTAMP DEFAULT NOW(),\n                    interaction_count INTEGER DEFAULT 0,\n                    user_data JSONB DEFAULT '{}',\n                    is_active BOOLEAN DEFAULT TRUE\n                );\n            \"\"\")\n        logging.info(\"‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞\")\n    except Exception as e:\n        logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î: {e}. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.\")\n        db_pool = None\n\nasync def save_user_to_db(user_id: int, username: Optional[str] = None, first_name: Optional[str] = None, last_name: Optional[str] = None):\n    \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return False\n    try:\n        async with db_pool.acquire() as conn:\n            await conn.execute(\"\"\"\n                INSERT INTO bot_users (user_id, username, first_name, last_name)\n                VALUES ($1, $2, $3, $4)\n                ON CONFLICT (user_id) DO UPDATE SET\n                    username = EXCLUDED.username,\n                    first_name = EXCLUDED.first_name,\n                    last_name = EXCLUDED.last_name,\n                    last_interaction = NOW(),\n                    interaction_count = bot_users.interaction_count + 1\n            \"\"\", user_id, username, first_name, last_name)\n        return True\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î: {e}\")\n        return False\n\nasync def get_user_from_db(user_id: int):\n    \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return None\n    try:\n        async with db_pool.acquire() as conn:\n            row = await conn.fetchrow(\"SELECT * FROM bot_users WHERE user_id = $1\", user_id)\n            if row:\n                return dict(row)\n        return None\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î: {e}\")\n        return None\n\nasync def update_user_data_in_db(user_id: int, data_key: str, data_value):\n    \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return False\n    try:\n        import json\n        async with db_pool.acquire() as conn:\n            # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å\n            await conn.execute(\"\"\"\n                INSERT INTO bot_users (user_id) \n                VALUES ($1) \n                ON CONFLICT (user_id) DO NOTHING\n            \"\"\", user_id)\n            \n            # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            update_data = {data_key: data_value}\n            await conn.execute(\"\"\"\n                UPDATE bot_users \n                SET user_data = COALESCE(user_data, '{}'::jsonb) || $2::jsonb,\n                    last_interaction = NOW()\n                WHERE user_id = $1\n            \"\"\", user_id, json.dumps(update_data))\n        return True\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}\")\n        return False\n\nasync def save_user_data_to_db(user_id: int, data_key: str, data_value):\n    \"\"\"–ê–ª–∏–∞—Å –¥–ª—è update_user_data_in_db –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏\"\"\"\n    return await update_user_data_in_db(user_id, data_key, data_value)\n\nasync def update_user_variable_in_db(user_id: int, variable_name: str, variable_value: str):\n    \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\"\"\"\n    if not db_pool:\n        return False\n    try:\n        import json\n        async with db_pool.acquire() as conn:\n            # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å\n            await conn.execute(\"\"\"\n                INSERT INTO bot_users (user_id) \n                VALUES ($1) \n                ON CONFLICT (user_id) DO NOTHING\n            \"\"\", user_id)\n            \n            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            update_data = {variable_name: variable_value}\n            await conn.execute(\"\"\"\n                UPDATE bot_users \n                SET user_data = COALESCE(user_data, '{}'::jsonb) || $2::jsonb,\n                    last_interaction = NOW()\n                WHERE user_id = $1\n            \"\"\", user_id, json.dumps(update_data))\n        return True\n    except Exception as e:\n        logging.error(f\"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}\")\n        return False\n\n\n# –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\nasync def is_admin(user_id: int) -> bool:\n    return user_id in ADMIN_IDS\n\nasync def is_private_chat(message: types.Message) -> bool:\n    return message.chat.type == \"private\"\n\nasync def check_auth(user_id: int) -> bool:\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\n    if db_pool:\n        user = await get_user_from_db(user_id)\n        return user is not None\n    return user_id in user_data\n\ndef is_local_file(url: str) -> bool:\n    \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL –ª–æ–∫–∞–ª—å–Ω—ã–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–æ–º\"\"\"\n    return url.startswith(\"/uploads/\") or url.startswith(\"uploads/\")\n\ndef get_local_file_path(url: str) -> str:\n    \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–∑ URL\"\"\"\n    if url.startswith(\"/\"):\n        return url[1:]  # –£–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–π —Å–ª–µ—à\n    return url\n\ndef extract_coordinates_from_yandex(url: str) -> tuple:\n    \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç\"\"\"\n    import re\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ ll=longitude,latitude\n    match = re.search(r\"ll=([\\d.-]+),([\\d.-]+)\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ /longitude,latitude/\n    match = re.search(r\"/([\\d.-]+),([\\d.-]+)/\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    return None, None\n\ndef extract_coordinates_from_google(url: str) -> tuple:\n    \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏ Google Maps\"\"\"\n    import re\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ @latitude,longitude\n    match = re.search(r\"@([\\d.-]+),([\\d.-]+)\", url)\n    if match:\n        return float(match.group(1)), float(match.group(2))  # lat, lon\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ /latitude,longitude/\n    match = re.search(r\"/([\\d.-]+),([\\d.-]+)/\", url)\n    if match:\n        return float(match.group(1)), float(match.group(2))  # lat, lon\n    return None, None\n\ndef extract_coordinates_from_2gis(url: str) -> tuple:\n    \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏ 2–ì–ò–°\"\"\"\n    import re\n    # –ò—â–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö 2–ì–ò–°\n    # –§–æ—Ä–º–∞—Ç: center/longitude,latitude\n    match = re.search(r\"center/([\\d.-]+),([\\d.-]+)\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    # –§–æ—Ä–º–∞—Ç: /longitude,latitude/\n    match = re.search(r\"/([\\d.-]+),([\\d.-]+)/\", url)\n    if match:\n        return float(match.group(2)), float(match.group(1))  # lat, lon\n    return None, None\n\ndef generate_map_urls(latitude: float, longitude: float, title: str = \"\") -> dict:\n    \"\"\"–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã\"\"\"\n    import urllib.parse\n    \n    encoded_title = urllib.parse.quote(title) if title else \"\"\n    \n    return {\n        \"yandex\": f\"https://yandex.ru/maps/?ll={longitude},{latitude}&z=15&l=map&pt={longitude},{latitude}\",\n        \"google\": f\"https://maps.google.com/?q={latitude},{longitude}\",\n        \"2gis\": f\"https://2gis.ru/geo/{longitude},{latitude}\",\n        \"openstreetmap\": f\"https://www.openstreetmap.org/?mlat={latitude}&mlon={longitude}&zoom=15\"\n    }\n\n\n@dp.message(CommandStart())\nasync def start_handler(message: types.Message):\n\n    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ\n    user_id = message.from_user.id\n    username = message.from_user.username\n    first_name = message.from_user.first_name\n    last_name = message.from_user.last_name\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    saved_to_db = await save_user_to_db(user_id, username, first_name, last_name)\n    \n    # –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\n    if not saved_to_db:\n        user_data[user_id] = {\n            \"username\": username,\n            \"first_name\": first_name,\n            \"last_name\": last_name,\n            \"registered_at\": message.date\n        }\n        logging.info(f\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\")\n    else:\n        logging.info(f\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\")\n\n    text = \"\"\"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–∞–º –æ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ, —á—Ç–æ –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç:\"\"\"\n    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)\n    if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n        current_parse_mode = conditional_parse_mode\n    else:\n        current_parse_mode = None\n    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã\n    use_conditional_keyboard = False\n    conditional_keyboard = None\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    if use_conditional_keyboard:\n        await message.answer(text, reply_markup=conditional_keyboard, parse_mode=current_parse_mode if current_parse_mode else None)\n    else:\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"‚öΩ –°–ø–æ—Ä—Ç\", callback_data=f\"multi_select_start_btn-sport\"))\n        builder.add(InlineKeyboardButton(text=\"üéµ –ú—É–∑—ã–∫–∞\", callback_data=f\"multi_select_start_btn-music\"))\n        builder.add(InlineKeyboardButton(text=\"üìö –ö–Ω–∏–≥–∏\", callback_data=f\"multi_select_start_btn-books\"))\n        builder.add(InlineKeyboardButton(text=\"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\", callback_data=f\"multi_select_start_btn-travel\"))\n        builder.add(InlineKeyboardButton(text=\"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\", callback_data=f\"multi_select_start_btn-tech\"))\n        builder.add(InlineKeyboardButton(text=\"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\", callback_data=f\"multi_select_start_btn-cooking\"))\n        builder.add(InlineKeyboardButton(text=\"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\", callback_data=f\"multi_select_start_btn-art\"))\n        builder.add(InlineKeyboardButton(text=\"üéÆ –ò–≥—Ä—ã\", callback_data=f\"multi_select_start_btn-games\"))\n        builder.add(InlineKeyboardButton(text=\"–ì–æ—Ç–æ–≤–æ\", callback_data=f\"multi_select_done_start\"))\n        builder.adjust(2)\n        keyboard = builder.as_markup()\n        await message.answer(text, reply_markup=keyboard, parse_mode=current_parse_mode if current_parse_mode else None)\n        \n        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n        user_data[message.from_user.id] = user_data.get(message.from_user.id, {})\n        user_data[message.from_user.id][\"multi_select_start\"] = []\n        user_data[message.from_user.id][\"multi_select_node\"] = \"start\"\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ inline –∫–Ω–æ–ø–æ–∫\n\n@dp.callback_query(lambda c: c.data == \"final_message\" or c.data.startswith(\"final_message_btn_\"))\nasync def handle_callback_final_message(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    button_text = \"üëç –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    response_data = button_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    await update_user_data_in_db(user_id, button_text, response_data)\n    logging.info(f\"–ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {button_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–∑–ª–∞ final_message\n    text = \"\"\"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤.\"\"\"\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ë–µ–∑ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    keyboard = None\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞\n    if keyboard is None:\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞\n        builder = InlineKeyboardBuilder()\n        builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"start_btn_0\"))\n        keyboard = builder.as_markup()\n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n    try:\n        if keyboard is not None:\n            await callback_query.message.edit_text(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.edit_text(text)\n    except Exception:\n        if keyboard is not None:\n            await callback_query.message.answer(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.answer(text)\n\n@dp.callback_query(lambda c: c.data == \"start\" or c.data.startswith(\"start_btn_\"))\nasync def handle_callback_start(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    button_text = \"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    response_data = button_text\n    await update_user_data_in_db(user_id, button_text, response_data)\n    logging.info(f\"–ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {button_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤\n    text = \"\"\"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\\n\\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–∞–º –æ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ, —á—Ç–æ –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç:\"\"\"\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–Ω–µ–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n    if user_id not in user_data:\n        user_data[user_id] = {}\n    \n    # –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n    saved_interests = []\n    if user_vars and \"user_interests\" in user_vars:\n        interests_value = user_vars[\"user_interests\"]\n        if isinstance(interests_value, dict) and \"value\" in interests_value:\n            interests_str = interests_value[\"value\"]\n        elif isinstance(interests_value, str):\n            interests_str = interests_value\n        else:\n            interests_str = str(interests_value) if interests_value else \"\"\n        \n        if interests_str:\n            saved_interests = [interest.strip() for interest in interests_str.split(\",\")]\n    \n    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏\n    user_data[user_id][\"multi_select_start\"] = saved_interests.copy()\n    user_data[user_id][\"multi_select_node\"] = \"start\"\n    \n    # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –∏ –≥–∞–ª–æ—á–∫–∞–º–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö\n    builder = InlineKeyboardBuilder()\n    selected_mark = \"‚úÖ \" if \"‚öΩ –°–ø–æ—Ä—Ç\" in saved_interests else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}‚öΩ –°–ø–æ—Ä—Ç\", callback_data=\"multi_select_start_btn-sport\"))\n    selected_mark = \"‚úÖ \" if \"üéµ –ú—É–∑—ã–∫–∞\" in saved_interests else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}üéµ –ú—É–∑—ã–∫–∞\", callback_data=\"multi_select_start_btn-music\"))\n    selected_mark = \"‚úÖ \" if \"üìö –ö–Ω–∏–≥–∏\" in saved_interests else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}üìö –ö–Ω–∏–≥–∏\", callback_data=\"multi_select_start_btn-books\"))\n    selected_mark = \"‚úÖ \" if \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\" in saved_interests else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\", callback_data=\"multi_select_start_btn-travel\"))\n    selected_mark = \"‚úÖ \" if \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\" in saved_interests else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\", callback_data=\"multi_select_start_btn-tech\"))\n    selected_mark = \"‚úÖ \" if \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\" in saved_interests else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\", callback_data=\"multi_select_start_btn-cooking\"))\n    selected_mark = \"‚úÖ \" if \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\" in saved_interests else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\", callback_data=\"multi_select_start_btn-art\"))\n    selected_mark = \"‚úÖ \" if \"üéÆ –ò–≥—Ä—ã\" in saved_interests else \"\"\n    builder.add(InlineKeyboardButton(text=f\"{selected_mark}üéÆ –ò–≥—Ä—ã\", callback_data=\"multi_select_start_btn-games\"))\n    builder.add(InlineKeyboardButton(text=\"–ì–æ—Ç–æ–≤–æ\", callback_data=\"multi_select_done_start\"))\n    builder.adjust(2)  # –†–∞–∑–º–µ—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ 2 –∫–æ–ª–æ–Ω–∫–∏\n    keyboard = builder.as_markup()\n    \n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤\n    try:\n        await callback_query.message.edit_text(text, reply_markup=keyboard)\n    except Exception:\n        await callback_query.message.answer(text, reply_markup=keyboard)\n    return\n    \n    user_id = callback_query.from_user.id\n    button_text = \"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    response_data = button_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    await update_user_data_in_db(user_id, button_text, response_data)\n    logging.info(f\"–ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {button_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–∑–µ–ª start: start\n    text = \"\"\"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–∞–º –æ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ, —á—Ç–æ –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç:\"\"\"\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ë–µ–∑ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    keyboard = None\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞\n    if keyboard is None:\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è start —É–∑–ª–∞\n        builder = InlineKeyboardBuilder()\n        keyboard = builder.as_markup()\n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ start —É–∑–ª–∞\n    try:\n        if keyboard is not None:\n            await callback_query.message.edit_text(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.edit_text(text)\n    except Exception:\n        if keyboard is not None:\n            await callback_query.message.answer(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.answer(text)\n\n@dp.callback_query(lambda c: c.data == \"start\" or c.data.startswith(\"start_btn_\"))\nasync def handle_callback_start(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    button_text = \"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\"\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n    timestamp = get_moscow_time()\n    response_data = button_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    await update_user_data_in_db(user_id, button_text, response_data)\n    logging.info(f\"–ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {button_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–∑–µ–ª start: start\n    text = \"\"\"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–∞–º –æ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ, —á—Ç–æ –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç:\"\"\"\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    \n    # –ë–µ–∑ —É—Å–ª–æ–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    keyboard = None\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É—Å–ª–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞\n    if keyboard is None:\n        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è start —É–∑–ª–∞\n        builder = InlineKeyboardBuilder()\n        keyboard = builder.as_markup()\n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ start —É–∑–ª–∞\n    try:\n        if keyboard is not None:\n            await callback_query.message.edit_text(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.edit_text(text)\n    except Exception:\n        if keyboard is not None:\n            await callback_query.message.answer(text, reply_markup=keyboard)\n        else:\n            await callback_query.message.answer(text)\n\n@dp.callback_query(lambda c: c.data == \"interests_result\" or c.data.startswith(\"interests_result_btn_\"))\nasync def handle_callback_interests_result(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    # Handle interests_result node\n    user_id = callback_query.from_user.id\n    text = \"\"\"üéØ –í–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã:\n\n{user_interests}\n\n–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –¢–µ–ø–µ—Ä—å –º—ã —Å–º–æ–∂–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.\"\"\"\n    \n    # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—Å—Ç\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º user_data\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    # –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ\n    import re\n    def replace_variables_in_text(text_content, variables_dict):\n        if not text_content or not variables_dict:\n            return text_content\n        \n        for var_name, var_data in variables_dict.items():\n            placeholder = \"{\" + var_name + \"}\"\n            if placeholder in text_content:\n                if isinstance(var_data, dict) and \"value\" in var_data:\n                    var_value = str(var_data[\"value\"]) if var_data[\"value\"] is not None else var_name\n                elif var_data is not None:\n                    var_value = str(var_data)\n                else:\n                    var_value = var_name  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç\n                text_content = text_content.replace(placeholder, var_value)\n        return text_content\n    \n    text = replace_variables_in_text(text, user_vars)\n    # Create inline keyboard\n    builder = InlineKeyboardBuilder()\n    builder.add(InlineKeyboardButton(text=\"üëç –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\", callback_data=\"final_message_btn_0\"))\n    builder.add(InlineKeyboardButton(text=\"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\", callback_data=\"start_btn_1\"))\n    keyboard = builder.as_markup()\n    await bot.send_message(user_id, text, reply_markup=keyboard)\n\n\n\n# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞\n@dp.message(F.text)\nasync def handle_user_input(message: types.Message):\n    user_id = message.from_user.id\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –≤–≤–æ–¥ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n    if user_id in user_data and \"waiting_for_conditional_input\" in user_data[user_id]:\n        config = user_data[user_id][\"waiting_for_conditional_input\"]\n        user_text = message.text\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        condition_id = config.get(\"condition_id\", \"unknown\")\n        next_node_id = config.get(\"next_node_id\")\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        timestamp = get_moscow_time()\n        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é\n        input_variable = config.get(\"input_variable\", \"\")\n        if input_variable:\n            variable_name = input_variable\n        else:\n            variable_name = f\"conditional_response_{condition_id}\"\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n        user_data[user_id][variable_name] = user_text\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        saved_to_db = await update_user_data_in_db(user_id, variable_name, user_text)\n        if saved_to_db:\n            logging.info(f\"‚úÖ –£—Å–ª–æ–≤–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î: {variable_name} = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        else:\n            logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n        \n        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ\n        await message.answer(\"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...\")\n        \n        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è\n        del user_data[user_id][\"waiting_for_conditional_input\"]\n        \n        logging.info(f\"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {variable_name} = {user_text}\")\n        \n        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω\n        if next_node_id:\n            try:\n                logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {next_node_id}\")\n                \n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π\n                if next_node_id == \"profile_command\":\n                    logging.info(\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ–º–∞–Ω–¥–µ /profile\")\n                    await profile_handler(message)\n                else:\n                    # –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π callback –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫ –æ–±—ã—á–Ω–æ–º—É —É–∑–ª—É\n                    import types as aiogram_types\n                    fake_callback = aiogram_types.SimpleNamespace(\n                        id=\"conditional_nav\",\n                        from_user=message.from_user,\n                        chat_instance=\"\",\n                        data=next_node_id,\n                        message=message,\n                        answer=lambda text=\"\", show_alert=False: asyncio.sleep(0)\n                    )\n                    \n                    if next_node_id == \"start\":\n                        await handle_callback_start(fake_callback)\n                    elif next_node_id == \"interests_result\":\n                        await handle_callback_interests_result(fake_callback)\n                    elif next_node_id == \"final_message\":\n                        await handle_callback_final_message(fake_callback)\n                    else:\n                        logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n            except Exception as e:\n                logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n        \n        return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –∫–Ω–æ–ø–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n    if user_id in user_data and \"button_response_config\" in user_data[user_id]:\n        config = user_data[user_id][\"button_response_config\"]\n        user_text = message.text\n        \n        # –ò—â–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å—Ä–µ–¥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø—Ü–∏–π\n        selected_option = None\n        for option in config.get(\"options\", []):\n            if option[\"text\"] == user_text:\n                selected_option = option\n                break\n        \n        if selected_option:\n            selected_value = selected_option[\"value\"]\n            selected_text = selected_option[\"text\"]\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            variable_name = config.get(\"variable\", \"button_response\")\n            timestamp = get_moscow_time()\n            node_id = config.get(\"node_id\", \"unknown\")\n            \n            # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç\n            response_data = {\n                \"value\": selected_value,\n                \"text\": selected_text,\n                \"type\": \"button_choice\",\n                \"timestamp\": timestamp,\n                \"nodeId\": node_id,\n                \"variable\": variable_name\n            }\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][variable_name] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n            if config.get(\"save_to_database\"):\n                saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\n                if saved_to_db:\n                    logging.info(f\"‚úÖ –ö–Ω–æ–ø–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î: {variable_name} = {selected_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n                else:\n                    logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ\n            success_message = config.get(\"success_message\", \"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤—ã–±–æ—Ä!\")\n            await message.answer(f\"{success_message}\\n\\n‚úÖ –í–∞—à –≤—ã–±–æ—Ä: {selected_text}\", reply_markup=ReplyKeyboardRemove())\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n            del user_data[user_id][\"button_response_config\"]\n            \n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –∫–Ω–æ–ø–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É: {variable_name} = {selected_text}\")\n            \n            # –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ–π—Å—Ç–≤–∏—è –∫–Ω–æ–ø–∫–∏\n            option_action = selected_option.get(\"action\", \"goto\")\n            option_target = selected_option.get(\"target\", \"\")\n            option_url = selected_option.get(\"url\", \"\")\n            \n            if option_action == \"url\" and option_url:\n                # –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Å—ã–ª–∫–∏\n                url = option_url\n                keyboard = InlineKeyboardMarkup(inline_keyboard=[\n                    [InlineKeyboardButton(text=\"üîó –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É\", url=url)]\n                ])\n                await message.answer(\"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É:\", reply_markup=keyboard)\n            elif option_action == \"command\" and option_target:\n                # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã\n                command = option_target\n                # –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã\n                import types as aiogram_types\n                fake_message = aiogram_types.SimpleNamespace(\n                    from_user=message.from_user,\n                    chat=message.chat,\n                    text=command,\n                    message_id=message.message_id\n                )\n                \n                if command == \"/start\":\n                    try:\n                        await start_handler(fake_message)\n                    except Exception as e:\n                        logging.error(f\"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã /start: {e}\")\n                else:\n                    logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {command}\")\n            elif option_action == \"goto\" and option_target:\n                # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É\n                target_node_id = option_target\n                try:\n                    # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞\n                    if target_node_id == \"start\":\n                        await handle_callback_start(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"interests_result\":\n                        await handle_callback_interests_result(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    elif target_node_id == \"final_message\":\n                        await handle_callback_final_message(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=target_node_id, message=message))\n                    else:\n                        logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ü–µ–ª–µ–≤–æ–π —É–∑–µ–ª: {target_node_id}\")\n                except Exception as e:\n                    logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —É–∑–ª—É {target_node_id}: {e}\")\n            else:\n                # Fallback –∫ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–µ next_node_id –µ—Å–ª–∏ –Ω–µ—Ç action\n                next_node_id = config.get(\"next_node_id\")\n                if next_node_id:\n                    try:\n                        # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É–∑–ª–∞\n                        if next_node_id == \"start\":\n                            await handle_callback_start(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"interests_result\":\n                            await handle_callback_interests_result(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        elif next_node_id == \"final_message\":\n                            await handle_callback_final_message(types.CallbackQuery(id=\"reply_nav\", from_user=message.from_user, chat_instance=\"\", data=next_node_id, message=message))\n                        else:\n                            logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n                    except Exception as e:\n                        logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n            return\n        else:\n            # –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã\n            available_options = [option[\"text\"] for option in config.get(\"options\", [])]\n            options_text = \"\\n\".join([f\"‚Ä¢ {opt}\" for opt in available_options])\n            await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:\\n\\n{options_text}\")\n            return\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)\n    if user_id in user_data and \"waiting_for_input\" in user_data[user_id]:\n        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥ —á–µ—Ä–µ–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É\n        waiting_config = user_data[user_id][\"waiting_for_input\"]\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ - –Ω–æ–≤—ã–π (—Å–ª–æ–≤–∞—Ä—å) –∏–ª–∏ —Å—Ç–∞—Ä—ã–π (—Å—Ç—Ä–æ–∫–∞)\n        if isinstance(waiting_config, dict):\n            # –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç - –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è\n            waiting_node_id = waiting_config.get(\"node_id\")\n            input_type = waiting_config.get(\"type\", \"text\")\n            variable_name = waiting_config.get(\"variable\", \"user_response\")\n            save_to_database = waiting_config.get(\"save_to_database\", False)\n            min_length = waiting_config.get(\"min_length\", 0)\n            max_length = waiting_config.get(\"max_length\", 0)\n            next_node_id = waiting_config.get(\"next_node_id\")\n        else:\n            # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - waiting_config —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å node_id\n            waiting_node_id = waiting_config\n            input_type = user_data[user_id].get(\"input_type\", \"text\")\n            variable_name = user_data[user_id].get(\"input_variable\", \"user_response\")\n            save_to_database = user_data[user_id].get(\"save_to_database\", False)\n            min_length = 0\n            max_length = 0\n            next_node_id = user_data[user_id].get(\"input_target_node_id\")\n        \n        user_text = message.text\n        \n        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n        if isinstance(waiting_config, dict):\n            # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã\n            if min_length > 0 and len(user_text) < min_length:\n                retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (–º–∏–Ω–∏–º—É–º {min_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n                return\n            \n            if max_length > 0 and len(user_text) > max_length:\n                retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º {max_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n                return\n            \n            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –≤–≤–æ–¥–∞\n            if input_type == \"email\":\n                import re\n                email_pattern = r\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$\"\n                if not re.match(email_pattern, user_text):\n                    retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                    await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. {retry_message}\")\n                    return\n            elif input_type == \"number\":\n                try:\n                    float(user_text)\n                except ValueError:\n                    retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                    await message.answer(f\"‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ. {retry_message}\")\n                    return\n            elif input_type == \"phone\":\n                import re\n                phone_pattern = r\"^[+]?[0-9\\s\\-\\(\\)]{10,}$\"\n                if not re.match(phone_pattern, user_text):\n                    retry_message = waiting_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n                    await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. {retry_message}\")\n                    return\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n            timestamp = get_moscow_time()\n            response_data = user_text\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n            user_data[user_id][variable_name] = response_data\n            \n            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n            if save_to_database:\n                saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\n                if saved_to_db:\n                    logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: {variable_name} = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n                else:\n                    logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n            \n            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ\n            success_message = waiting_config.get(\"success_message\", \"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n            await message.answer(success_message)\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n            del user_data[user_id][\"waiting_for_input\"]\n            \n            logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: {variable_name} = {user_text}\")\n            \n            # –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n            if next_node_id:\n                try:\n                    logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {next_node_id}\")\n                    if next_node_id == \"start\":\n                        logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start —Ç–∏–ø–∞ start\")\n                    elif next_node_id == \"interests_result\":\n                        text = \"\"\"üéØ –í–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã:\n\n{user_interests}\n\n–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –¢–µ–ø–µ—Ä—å –º—ã —Å–º–æ–∂–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.\"\"\"\n                        await message.answer(text)\n                    elif next_node_id == \"final_message\":\n                        text = \"\"\"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤.\"\"\"\n                        await message.answer(text)\n                    else:\n                        logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n                except Exception as e:\n                    logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n            \n            return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n        \n        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)\n        # –ù–∞—Ö–æ–¥–∏–º —É–∑–µ–ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫\n        \n        # –ï—Å–ª–∏ —É–∑–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω\n        logging.warning(f\"–£–∑–µ–ª –¥–ª—è —Å–±–æ—Ä–∞ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: {waiting_node_id}\")\n        del user_data[user_id][\"waiting_for_input\"]\n        return\n    \n    # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫\n    if user_id in user_data and user_data[user_id].get(\"input_collection_enabled\"):\n        input_node_id = user_data[user_id].get(\"input_node_id\")\n        input_variable = user_data[user_id].get(\"input_variable\", \"button_response\")\n        user_text = message.text\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—é–±–æ–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç\n        timestamp = get_moscow_time()\n        \n        response_data = user_text  # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n        user_data[user_id][f\"{input_variable}_additional\"] = response_data\n        \n        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        await message.answer(\"‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω!\")\n        \n        logging.info(f\"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥: {input_variable}_additional = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        return\n    \n    # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n    return\n    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞\n    min_length = input_config.get(\"min_length\", 0)\n    max_length = input_config.get(\"max_length\", 0)\n    \n    if min_length > 0 and len(user_text) < min_length:\n        retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n        await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (–º–∏–Ω–∏–º—É–º {min_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n        return\n    \n    if max_length > 0 and len(user_text) > max_length:\n        retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n        await message.answer(f\"‚ùå –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º {max_length} —Å–∏–º–≤–æ–ª–æ–≤). {retry_message}\")\n        return\n    \n    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –≤–≤–æ–¥–∞\n    input_type = input_config.get(\"type\", \"text\")\n    \n    if input_type == \"email\":\n        import re\n        email_pattern = r\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$\"\n        if not re.match(email_pattern, user_text):\n            retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n            await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. {retry_message}\")\n            return\n    \n    elif input_type == \"number\":\n        try:\n            float(user_text)\n        except ValueError:\n            retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n            await message.answer(f\"‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ. {retry_message}\")\n            return\n    \n    elif input_type == \"phone\":\n        import re\n        phone_pattern = r\"^[+]?[0-9\\s\\-\\(\\)]{10,}$\"\n        if not re.match(phone_pattern, user_text):\n            retry_message = input_config.get(\"retry_message\", \"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\")\n            await message.answer(f\"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. {retry_message}\")\n            return\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Å—Ç—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º\n    variable_name = input_config.get(\"variable\", \"user_response\")\n    timestamp = get_moscow_time()\n    node_id = input_config.get(\"node_id\", \"unknown\")\n    \n    # –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞\n    response_data = user_text\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    user_data[user_id][variable_name] = response_data\n    \n    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ\n    if input_config.get(\"save_to_database\"):\n        saved_to_db = await update_user_data_in_db(user_id, variable_name, response_data)\n        if saved_to_db:\n            logging.info(f\"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î: {variable_name} = {user_text} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        else:\n            logging.warning(f\"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ\")\n    \n    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ\n    success_message = input_config.get(\"success_message\", \"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç!\")\n    await message.answer(success_message)\n    \n    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞\n    del user_data[user_id][\"waiting_for_input\"]\n    \n    logging.info(f\"–ü–æ–ª—É—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥: {variable_name} = {user_text}\")\n    \n    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–≤–æ–¥–∞\n    next_node_id = input_config.get(\"next_node_id\")\n    logging.info(f\"üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é: next_node_id = {next_node_id}\")\n    if next_node_id:\n        try:\n            logging.info(f\"üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É: {next_node_id}\")\n            \n            # –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏\n            fake_message = type(\"FakeMessage\", (), {})()\n            fake_message.from_user = message.from_user\n            fake_message.answer = message.answer\n            fake_message.delete = lambda: None\n            \n            # –ù–∞—Ö–æ–¥–∏–º —É–∑–µ–ª –ø–æ ID –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ\n            if next_node_id == \"start\":\n                logging.info(f\"–ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É start —Ç–∏–ø–∞ start\")\n            elif next_node_id == \"interests_result\":\n                text = \"\"\"üéØ –í–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã:\n\n{user_interests}\n\n–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –¢–µ–ø–µ—Ä—å –º—ã —Å–º–æ–∂–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.\"\"\"\n                # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n                if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n                    parse_mode = conditional_parse_mode\n                else:\n                    parse_mode = None\n                builder = InlineKeyboardBuilder()\n                # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–æ–∫\n                def calculate_keyboard_width(buttons_data):\n                    max_text_length = max([len(btn_text) for btn_text in buttons_data] + [0])\n                    if max_text_length <= 6:  # –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∫—Å—Ç—ã\n                        return 3  # 3 –∫–æ–ª–æ–Ω–∫–∏\n                    elif max_text_length <= 12:  # –°—Ä–µ–¥–Ω–∏–µ —Ç–µ–∫—Å—Ç—ã\n                        return 2  # 2 –∫–æ–ª–æ–Ω–∫–∏\n                    else:  # –î–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã\n                        return 1  # 1 –∫–æ–ª–æ–Ω–∫–∞\n                \n                button_texts = [\"üëç –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\", \"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\"]\n                keyboard_width = calculate_keyboard_width(button_texts)\n                \n                builder.add(InlineKeyboardButton(text=\"üëç –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\", callback_data=\"final_message\"))\n                builder.add(InlineKeyboardButton(text=\"‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä\", callback_data=\"start\"))\n                builder.adjust(keyboard_width)  # –£–º–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫\n                keyboard = builder.as_markup()\n                await message.answer(text, reply_markup=keyboard, parse_mode=parse_mode)\n            elif next_node_id == \"final_message\":\n                text = \"\"\"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤.\"\"\"\n                # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode —É—Å–ª–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n                if \"conditional_parse_mode\" in locals() and conditional_parse_mode is not None:\n                    parse_mode = conditional_parse_mode\n                else:\n                    parse_mode = None\n                builder = InlineKeyboardBuilder()\n                # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–æ–∫\n                def calculate_keyboard_width(buttons_data):\n                    max_text_length = max([len(btn_text) for btn_text in buttons_data] + [0])\n                    if max_text_length <= 6:  # –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∫—Å—Ç—ã\n                        return 3  # 3 –∫–æ–ª–æ–Ω–∫–∏\n                    elif max_text_length <= 12:  # –°—Ä–µ–¥–Ω–∏–µ —Ç–µ–∫—Å—Ç—ã\n                        return 2  # 2 –∫–æ–ª–æ–Ω–∫–∏\n                    else:  # –î–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã\n                        return 1  # 1 –∫–æ–ª–æ–Ω–∫–∞\n                \n                button_texts = [\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\"]\n                keyboard_width = calculate_keyboard_width(button_texts)\n                \n                builder.add(InlineKeyboardButton(text=\"üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\", callback_data=\"start\"))\n                builder.adjust(keyboard_width)  # –£–º–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫\n                keyboard = builder.as_markup()\n                await message.answer(text, reply_markup=keyboard, parse_mode=parse_mode)\n            else:\n                logging.warning(f\"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª: {next_node_id}\")\n        except Exception as e:\n            logging.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É {next_node_id}: {e}\")\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É—Å–ª–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫\n@dp.callback_query(lambda c: c.data.startswith(\"conditional_\"))\nasync def handle_conditional_button(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    \n    # –ü–∞—Ä—Å–∏–º callback_data: conditional_variableName_value\n    callback_parts = callback_query.data.split(\"_\", 2)\n    if len(callback_parts) >= 3:\n        variable_name = callback_parts[1]\n        variable_value = callback_parts[2]\n        \n        user_id = callback_query.from_user.id\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        await update_user_data_in_db(user_id, variable_name, variable_value)\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n        if user_id not in user_data:\n            user_data[user_id] = {}\n        user_data[user_id][variable_name] = variable_value\n        \n        logging.info(f\"–£—Å–ª–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞: {variable_name} = {variable_value} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id})\")\n        \n        # –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å\n        await callback_query.answer(f\"‚úÖ {variable_name} –æ–±–Ω–æ–≤–ª–µ–Ω–æ\")\n        \n        # –°–æ–∑–¥–∞–µ–º –∏–º–∏—Ç–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Ñ–∏–ª—å\n        class FakeMessage:\n            def __init__(self, callback_query):\n                self.from_user = callback_query.from_user\n                self.chat = callback_query.message.chat\n                self.date = callback_query.message.date\n                self.message_id = callback_query.message.message_id\n            \n            async def answer(self, text, parse_mode=None, reply_markup=None):\n                if reply_markup:\n                    await bot.send_message(self.chat.id, text, parse_mode=parse_mode, reply_markup=reply_markup)\n                else:\n                    await bot.send_message(self.chat.id, text, parse_mode=parse_mode)\n            \n            async def edit_text(self, text, parse_mode=None, reply_markup=None):\n                try:\n                    await bot.edit_message_text(text, self.chat.id, self.message_id, parse_mode=parse_mode, reply_markup=reply_markup)\n                except Exception:\n                    await self.answer(text, parse_mode, reply_markup)\n        \n        fake_message = FakeMessage(callback_query)\n        \n        # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Ñ–∏–ª—è\n        try:\n            await profile_handler(fake_message)\n        except Exception as e:\n            logging.error(f\"–û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ profile_handler: {e}\")\n            await callback_query.message.answer(f\"‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ {variable_name} –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞: {variable_value}\")\n    else:\n        logging.warning(f\"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —É—Å–ª–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏: {callback_query.data}\")\n        await callback_query.answer(\"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏\", show_alert=True)\n\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Ñ–∏–ª—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π variableLabel\n@dp.message(Command(\"profile\"))\nasync def profile_handler(message: types.Message):\n    user_id = message.from_user.id\n    \n    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\n    user_record = await get_user_from_db(user_id)\n    if not user_record:\n        user_record = user_data.get(user_id, {})\n    \n    # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ\n    if isinstance(user_record, dict):\n        if \"user_data\" in user_record:\n            if isinstance(user_record[\"user_data\"], str):\n                try:\n                    import json\n                    user_vars = json.loads(user_record[\"user_data\"])\n                except (json.JSONDecodeError, TypeError):\n                    user_vars = {}\n            elif isinstance(user_record[\"user_data\"], dict):\n                user_vars = user_record[\"user_data\"]\n            else:\n                user_vars = {}\n        else:\n            user_vars = user_record\n    else:\n        user_vars = {}\n    \n    if not user_vars:\n        await message.answer(\"üë§ –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\\n\\n–ü–æ—Ö–æ–∂–µ, –≤—ã –µ—â–µ –Ω–µ –ø—Ä–æ—à–ª–∏ –æ–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ /start —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.\")\n        return\n    \n    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π variableLabel\n    profile_text = \"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\\n\\n\"\n    \n    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\n    for var_name, var_data in user_vars.items():\n        if isinstance(var_data, dict) and \"value\" in var_data:\n            value = var_data[\"value\"]\n        else:\n            value = var_data\n        profile_text += f\"{var_name}: {value}\\n\"\n    \n    await message.answer(profile_text)\n    logging.info(f\"–ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}\")\n\n\n\n# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞\nasync def main():\n    global db_pool\n    try:\n        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        await init_database()\n        print(\"ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!\")\n        await dp.start_polling(bot)\n    except KeyboardInterrupt:\n        print(\"üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...\")\n    except Exception as e:\n        logging.error(f\"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}\")\n    finally:\n        # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\n        if db_pool:\n            await db_pool.close()\n            print(\"üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–æ\")\n        \n        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –±–æ—Ç–∞\n        await bot.session.close()\n        print(\"üîå –°–µ—Å—Å–∏—è –±–æ—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∞\")\n        print(\"‚úÖ –ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É\")\n\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n@dp.callback_query(lambda c: c.data.startswith(\"multi_select_\"))\nasync def handle_multi_select_callback(callback_query: types.CallbackQuery):\n    await callback_query.answer()\n    user_id = callback_query.from_user.id\n    callback_data = callback_query.data\n    \n    if callback_data.startswith(\"multi_select_done_\"):\n        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n        node_id = callback_data.replace(\"multi_select_done_\", \"\")\n        selected_options = user_data.get(user_id, {}).get(f\"multi_select_{node_id}\", [])\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n        if selected_options:\n            selected_text = \", \".join(selected_options)\n            if node_id == \"start\":\n                await save_user_data_to_db(user_id, \"user_interests\", selected_text)\n            # –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ —É–∑–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω\n            if not any(node_id == node for node in [\"start\"]):\n                await save_user_data_to_db(user_id, f\"multi_select_{node_id}\", selected_text)\n        \n        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n        if user_id in user_data:\n            user_data[user_id].pop(f\"multi_select_{node_id}\", None)\n            user_data[user_id].pop(\"multi_select_node\", None)\n        \n        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω\n        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª –¥–ª—è –∫–∞–∂–¥–æ–≥–æ node_id\n        if node_id == \"start\":\n            # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —É–∑–ª—É interests_result\n            await handle_callback_interests_result(callback_query)\n        return\n    \n    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–∏\n    parts = callback_data.split(\"_\")\n    if len(parts) >= 4:\n        node_id = parts[2]\n        button_id = \"_\".join(parts[3:])\n        \n        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π\n        if user_id not in user_data:\n            user_data[user_id] = {}\n        if f\"multi_select_{node_id}\" not in user_data[user_id]:\n            user_data[user_id][f\"multi_select_{node_id}\"] = []\n        \n        # –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ button_id\n        button_text = None\n        if node_id == \"start\":\n            if button_id == \"btn-sport\":\n                button_text = \"‚öΩ –°–ø–æ—Ä—Ç\"\n            if button_id == \"btn-music\":\n                button_text = \"üéµ –ú—É–∑—ã–∫–∞\"\n            if button_id == \"btn-books\":\n                button_text = \"üìö –ö–Ω–∏–≥–∏\"\n            if button_id == \"btn-travel\":\n                button_text = \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\"\n            if button_id == \"btn-tech\":\n                button_text = \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\"\n            if button_id == \"btn-cooking\":\n                button_text = \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\"\n            if button_id == \"btn-art\":\n                button_text = \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\"\n            if button_id == \"btn-games\":\n                button_text = \"üéÆ –ò–≥—Ä—ã\"\n        \n        if button_text:\n            selected_list = user_data[user_id][f\"multi_select_{node_id}\"]\n            if button_text in selected_list:\n                # –£–±–∏—Ä–∞–µ–º –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö\n                selected_list.remove(button_text)\n            else:\n                # –î–æ–±–∞–≤–ª—è–µ–º –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º\n                selected_list.append(button_text)\n            \n            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≥–∞–ª–æ—á–∫–∞–º–∏\n            builder = InlineKeyboardBuilder()\n            if node_id == \"start\":\n                # –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤\n                keyboard_width = 2  # –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n                \n                # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Å —É–º–Ω—ã–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º\n                selected_mark = \"‚úÖ \" if \"‚öΩ –°–ø–æ—Ä—Ç\" in selected_list else \"\"\n                builder.add(InlineKeyboardButton(text=f\"{selected_mark}‚öΩ –°–ø–æ—Ä—Ç\", callback_data=f\"multi_select_{node_id}_btn-sport\"))\n                selected_mark = \"‚úÖ \" if \"üéµ –ú—É–∑—ã–∫–∞\" in selected_list else \"\"\n                builder.add(InlineKeyboardButton(text=f\"{selected_mark}üéµ –ú—É–∑—ã–∫–∞\", callback_data=f\"multi_select_{node_id}_btn-music\"))\n                selected_mark = \"‚úÖ \" if \"üìö –ö–Ω–∏–≥–∏\" in selected_list else \"\"\n                builder.add(InlineKeyboardButton(text=f\"{selected_mark}üìö –ö–Ω–∏–≥–∏\", callback_data=f\"multi_select_{node_id}_btn-books\"))\n                selected_mark = \"‚úÖ \" if \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\" in selected_list else \"\"\n                builder.add(InlineKeyboardButton(text=f\"{selected_mark}‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\", callback_data=f\"multi_select_{node_id}_btn-travel\"))\n                selected_mark = \"‚úÖ \" if \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\" in selected_list else \"\"\n                builder.add(InlineKeyboardButton(text=f\"{selected_mark}üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\", callback_data=f\"multi_select_{node_id}_btn-tech\"))\n                selected_mark = \"‚úÖ \" if \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\" in selected_list else \"\"\n                builder.add(InlineKeyboardButton(text=f\"{selected_mark}üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\", callback_data=f\"multi_select_{node_id}_btn-cooking\"))\n                selected_mark = \"‚úÖ \" if \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\" in selected_list else \"\"\n                builder.add(InlineKeyboardButton(text=f\"{selected_mark}üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\", callback_data=f\"multi_select_{node_id}_btn-art\"))\n                selected_mark = \"‚úÖ \" if \"üéÆ –ò–≥—Ä—ã\" in selected_list else \"\"\n                builder.add(InlineKeyboardButton(text=f\"{selected_mark}üéÆ –ò–≥—Ä—ã\", callback_data=f\"multi_select_{node_id}_btn-games\"))\n                builder.add(InlineKeyboardButton(text=\"–ì–æ—Ç–æ–≤–æ\", callback_data=f\"multi_select_done_start\"))\n                builder.adjust(keyboard_width)\n            \n            keyboard = builder.as_markup()\n            await callback_query.message.edit_reply_markup(reply_markup=keyboard)\n\n# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è reply –∫–Ω–æ–ø–æ–∫ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞\n@dp.message()\nasync def handle_multi_select_reply(message: types.Message):\n    user_id = message.from_user.id\n    user_input = message.text\n    \n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ reply\n    if user_id in user_data and \"multi_select_node\" in user_data[user_id] and user_data[user_id].get(\"multi_select_type\") == \"reply\":\n        node_id = user_data[user_id][\"multi_select_node\"]\n        \n        if node_id == \"start\" and user_input == \"–ì–æ—Ç–æ–≤–æ\":\n            # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¥–ª—è —É–∑–ª–∞ start\n            selected_options = user_data.get(user_id, {}).get(\"multi_select_{node_id}\", [])\n            if selected_options:\n                selected_text = \", \".join(selected_options)\n                await save_user_data_to_db(user_id, \"user_interests\", selected_text)\n            \n            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n            user_data[user_id].pop(\"multi_select_{node_id}\", None)\n            user_data[user_id].pop(\"multi_select_node\", None)\n            user_data[user_id].pop(\"multi_select_type\", None)\n            \n            # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É\n            await handle_callback_interests_result(types.CallbackQuery(id=\"multi_select\", from_user=message.from_user, chat_instance=\"\", data=\"interests_result\", message=message))\n            return\n        \n        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–∏\n        if node_id == \"start\":\n            if user_input == \"‚öΩ –°–ø–æ—Ä—Ç\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"‚öΩ –°–ø–æ—Ä—Ç\" in selected_list:\n                    selected_list.remove(\"‚öΩ –°–ø–æ—Ä—Ç\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: ‚öΩ –°–ø–æ—Ä—Ç\")\n                else:\n                    selected_list.append(\"‚öΩ –°–ø–æ—Ä—Ç\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: ‚öΩ –°–ø–æ—Ä—Ç\")\n                return\n            \n            if user_input == \"üéµ –ú—É–∑—ã–∫–∞\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üéµ –ú—É–∑—ã–∫–∞\" in selected_list:\n                    selected_list.remove(\"üéµ –ú—É–∑—ã–∫–∞\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üéµ –ú—É–∑—ã–∫–∞\")\n                else:\n                    selected_list.append(\"üéµ –ú—É–∑—ã–∫–∞\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üéµ –ú—É–∑—ã–∫–∞\")\n                return\n            \n            if user_input == \"üìö –ö–Ω–∏–≥–∏\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üìö –ö–Ω–∏–≥–∏\" in selected_list:\n                    selected_list.remove(\"üìö –ö–Ω–∏–≥–∏\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üìö –ö–Ω–∏–≥–∏\")\n                else:\n                    selected_list.append(\"üìö –ö–Ω–∏–≥–∏\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üìö –ö–Ω–∏–≥–∏\")\n                return\n            \n            if user_input == \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\" in selected_list:\n                    selected_list.remove(\"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: ‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\")\n                else:\n                    selected_list.append(\"‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: ‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è\")\n                return\n            \n            if user_input == \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\" in selected_list:\n                    selected_list.remove(\"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\")\n                else:\n                    selected_list.append(\"üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\")\n                return\n            \n            if user_input == \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\" in selected_list:\n                    selected_list.remove(\"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\")\n                else:\n                    selected_list.append(\"üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üç≥ –ö—É–ª–∏–Ω–∞—Ä–∏—è\")\n                return\n            \n            if user_input == \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\" in selected_list:\n                    selected_list.remove(\"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\")\n                else:\n                    selected_list.append(\"üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ\")\n                return\n            \n            if user_input == \"üéÆ –ò–≥—Ä—ã\":\n                if \"multi_select_{node_id}\" not in user_data[user_id]:\n                    user_data[user_id][\"multi_select_{node_id}\"] = []\n                \n                selected_list = user_data[user_id][\"multi_select_{node_id}\"]\n                if \"üéÆ –ò–≥—Ä—ã\" in selected_list:\n                    selected_list.remove(\"üéÆ –ò–≥—Ä—ã\")\n                    await message.answer(\"‚ùå –£–±—Ä–∞–Ω–æ: üéÆ –ò–≥—Ä—ã\")\n                else:\n                    selected_list.append(\"üéÆ –ò–≥—Ä—ã\")\n                    await message.answer(\"‚úÖ –í—ã–±—Ä–∞–Ω–æ: üéÆ –ò–≥—Ä—ã\")\n                return\n            \n    \n    # –ï—Å–ª–∏ –Ω–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä, –ø–µ—Ä–µ–¥–∞–µ–º –¥–∞–ª—å—à–µ –ø–æ —Ü–µ–ø–æ—á–∫–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤\n    pass\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n"}